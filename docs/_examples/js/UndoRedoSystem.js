/*! For license information please see bundle.js.LICENSE.txt */
!function(e){var t={};function i(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(a,s,function(t){return e[t]}.bind(null,s));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=43)}([function(e,t,i){"use strict";(function(e,a,s){function n(e,t){if(!n.watchedElementData){n.watchedElementData=[];const e=function(){n.watchedElementData.forEach((function(e){e.element.offsetWidth===e.offsetWidth&&e.element.offsetHeight===e.offsetHeight||(e.offsetWidth=e.element.offsetWidth,e.offsetHeight=e.element.offsetHeight,e.callback())}))};window.addEventListener("resize",e),new MutationObserver(e).observe(document.body,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}n.watchedElementData.push({element:e,offsetWidth:e.offsetWidth,offsetHeight:e.offsetHeight,callback:t})}i.d(t,"a",(function(){return A})),i.d(t,"b",(function(){return he})),i.d(t,"c",(function(){return Rt})),i.d(t,"d",(function(){return Z})),i.d(t,"e",(function(){return be})),i.d(t,"f",(function(){return Lt})),i.d(t,"g",(function(){return xt})),i.d(t,"h",(function(){return vt})),i.d(t,"i",(function(){return Tt})),i.d(t,"j",(function(){return Ce})),i.d(t,"k",(function(){return Jt})),i.d(t,"l",(function(){return kt})),i.d(t,"m",(function(){return ft})),i.d(t,"n",(function(){return Me})),i.d(t,"o",(function(){return oe})),i.d(t,"p",(function(){return ei})),i.d(t,"q",(function(){return H})),i.d(t,"r",(function(){return B})),i.d(t,"s",(function(){return Ct})),i.d(t,"t",(function(){return V})),i.d(t,"u",(function(){return I})),i.d(t,"v",(function(){return It})),i.d(t,"w",(function(){return M})),i.d(t,"x",(function(){return Ft})),i.d(t,"y",(function(){return r})),i.d(t,"z",(function(){return wt})),i.d(t,"A",(function(){return zt})),i.d(t,"B",(function(){return P})),i.d(t,"C",(function(){return p})),i.d(t,"D",(function(){return g})),i.d(t,"E",(function(){return R})),i.d(t,"F",(function(){return z}));const r=function(){const e=null!=(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Pixel/i)||navigator.userAgent.match(/Windows Phone/i)),t=function(){const e=navigator.userAgent;let t,i,a,s=navigator.appName,n=""+parseFloat(navigator.appVersion),r=parseInt(navigator.appVersion,10);return-1!=(i=e.indexOf("Opera"))?(s="Opera",n=e.substring(i+6),-1!=(i=e.indexOf("Version"))&&(n=e.substring(i+8))):-1!=(i=e.indexOf("MSIE"))?(s="Microsoft Internet Explorer",n=e.substring(i+5)):-1!=(i=e.indexOf("Edge"))?(s="Edge",n=e.substring(i+4)):-1!=(i=e.indexOf("Chrome"))?(s="Chrome",n=e.substring(i+7)):-1!=(i=e.indexOf("Safari"))?(s="Safari",n=e.substring(i+7),-1!=(i=e.indexOf("Version"))&&(n=e.substring(i+8))):-1!=(i=e.indexOf("Firefox"))?(s="Firefox",n=e.substring(i+8)):(t=e.lastIndexOf(" ")+1)<(i=e.lastIndexOf("/"))&&(s=e.substring(t,i),n=e.substring(i+1),s.toLowerCase()==s.toUpperCase()&&(s=navigator.appName)),-1!=(a=n.indexOf(";"))&&(n=n.substring(0,a)),-1!=(a=n.indexOf(" "))&&(n=n.substring(0,a)),r=parseInt(""+n,10),isNaN(r)&&(n=""+parseFloat(navigator.appVersion),r=parseInt(navigator.appVersion,10)),{browserName:s,fullVersion:n,majorVersion:r,appName:navigator.appName,userAgent:navigator.userAgent}}(),i=function(){let e,t;try{e=document.createElement("canvas").getContext("webgl")}catch(e){}if(!e)return;try{t=document.createElement("canvas").getContext("webgl2")}catch(e){}const i=e.getExtension("WEBGL_debug_renderer_info"),a=e.getParameter(i.UNMASKED_VENDOR_WEBGL),s=e.getParameter(i.UNMASKED_RENDERER_WEBGL),n=e.getParameter(e.MAX_TEXTURE_SIZE);let r;return s.match(/NVIDIA/i)?r="NVidia":s.match(/AMD/i)||s.match(/Radeon/i)?r="AMD":s.match(/Intel/i)?r="Intel":s.match(/Mali/i)?r="ARM":s.match(/Adreno/i)?r="Adreno":console.warn("Unable to determine GPU vendor:",s),{vendor:a,renderer:s,gpuVendor:r,maxTextureSize:n,supportsWebGL2:null!=t}}();let a="Low";if(i)if(e)a="Low";else{const e=i.renderer.replace(/[()]/g,"").split(" ");if("NVidia"==i.gpuVendor){const t=e.indexOf("GTX");if(-1!=t){const i=e[t+1];a=i.endsWith("M")?parseInt(i.substring(0,i.length-2))>=900?"Medium":"Low":parseInt(i)>=1030?"High":"Medium"}else a=-1!=e.indexOf("TITAN")||-1!=e.indexOf("Quadro")?"High":"Low"}else if("AMD"==i.gpuVendor){const t=e.indexOf("Radeon");if(-1!=t){const i=e.indexOf("RX");if(-1!=i)if("Vega"==e[i+1])a="High";else{const t=e[i+1];let s;t.endsWith("X")?(s=parseInt(t.substring(0,t.length-2)),a="High"):s=parseInt(t),a=s>=480?"High":"Medium"}else a="Pro"==e[t+1]?parseInt(e[i+1])>=450?"Medium":"Low":"Sky"==e[t+1]&&parseInt(e[i+1])>=700?"Medium":"Low"}else a=-1!=e.indexOf("FirePro")||-1!=e.indexOf("Quadro")?"High":"Low"}else("Adreno"==i.gpuVendor||"Intel"==i.gpuVendor)&&(a="Low")}return{isMobileDevice:e,isIOSDevice:null!=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)),browserName:t.browserName,fullVersion:t.fullVersion,majorVersion:t.majorVersion,appName:t.appName,userAgent:t.userAgent,webGLSupported:null!=i,gpuDesc:i,deviceCategory:a}}();var l=Object.freeze({__proto__:null,SystemDesc:r});const o=Math.PI/180;Math.HALF_PI=.5*Math.PI,Math.TWO_PI=2*Math.PI;Math.radToDeg=function(e){return e/o},Math.degToRad=function(e){return e*o},Number.isNumeric=e=>!isNaN(parseFloat(e))&&isFinite(e),String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)};const d=function(e){let t,i,a,s=0;if(0===e.length)return s;for(t=0,a=e.length;t<a;t++)i=e.charCodeAt(t),s=(s<<5)-s+i,s|=0;return Math.abs(s)};function h(e,t=0,i=5){return JSON.stringify(e,(function(e,t){return t&&t.toFixed?Number(t.toFixed(i)):t}),t)}String.prototype.hash=function(){return d(this)},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.lpad=function(e,t){let i=this;for(;i.length<t;)i=e+i;return i},String.prototype.rpad=function(e,t){let i=this;for(;i.length<t;)i+=e;return i},Math.randomInt=function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e},Math.lerp=(e,t,i)=>e+i*(t-e),Math.clamp=function(e,t,i){return Math.min(Math.max(e,t),i)},Math.nearestPow2=function(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))},Math.nearestPow10=function(e){return Math.pow(10,Math.round(Math.log10(e)/Math.log10(10)))},Math.nextPow2=function(e){let t=0;for(;e>0;)t++,e>>=1;return 1<<t},Math.fract=function(e){return 0==e?0:e<0?e>-1?-e:-e%Math.floor(-e):e<1?e:e%Math.floor(e)},Math.remap=function(e,t,i,a,s){return a+(e-t)/(i-t)*(s-a)},Math.convertFloat32ArrayToUInt16Array=function(e){const t=new Uint16Array(e.length),i=new Int32Array(e.buffer),a=e=>{let t=e>>16&32768,i=e>>12&2047;const a=e>>23&255;return a<103?t:a>142?(t|=31744,t|=(255==a?0:1)&&8388607&e,t):a<113?(i|=2048,t|=(i>>114-a)+(i>>113-a&1),t):(t|=a-112<<10|i>>1,t+=1&i,t)};for(let s=0;s<e.length;s++)t[s]=a(i[s]);return t},Math.decode16BitFloatFrom2xUInt8=e=>{const t=e[0],i=(120&t)>>3;let a=0==i?0:2048;const s=a+((7&t)<<8)+e[1];return a=0==i?1:0,(128&t?1:-1)*s*Math.pow(2,i+a-16)},Math.encode16BitFloatInto2xUInt8=e=>{c||(c=new Uint8Array(2));const t=e>=0?128:0;e=Math.abs(e);let i,a=15,s=1024;for(let t=15;t>0;t--)e<s&&(s/=2,a--);i=0==a?e/s/2:(e-s)/s;const n=Math.round(2048*i),r=n/256,l=n-256*r;return c[0]=t+8*a+r,c[1]=l,e>=2048&&(c[0]=255),c},Math.encode16BitFloat=e=>{const t=new Float32Array(1);return t[0]=e,(e=>{let t=e>>16&32768,i=e>>12&2047;const a=e>>23&255;return a<103?t:a>142?(t|=31744,t|=(255==a?0:1)&&8388607&e,t):a<113?(i|=2048,t|=(i>>114-a)+(i>>113-a&1),t):(t|=a-112<<10|i>>1,t+=1&i,t)})(new Int32Array(t.buffer)[0])},Math.decode16BitFloat=e=>{const t=(32768&e)>>15,i=(31744&e)>>10,a=1023&e;return 0==i?(t?-1:1)*Math.pow(2,-14)*(a/Math.pow(2,10)):31==i?a?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+a/Math.pow(2,10))},Math.smoothStep=(e,t,i)=>{const a=Math.clamp((i-e)/(t-e),0,1);return a*a*(3-2*a)},Math.linStep=(e,t,i)=>Math.clamp((i-e)/(t-e),0,1);class m{isValid(){for(const e of this.__data)if(e==1/0||isNaN(e))return!1;return!0}static createFromFloat32Buffer(e,t){throw new Error("Not yet implemented for this type:"+this.constructor.name)}static numElements(){throw new Error("Not yet implemented for this type:"+this.constructor.name)}asArray(){return this.__data}toString(){return h(this.toJSON())}}const u=new class{constructor(){this.__types={},this.__names={},this.registerType("SInt32",5),this.registerType("UInt32",4),this.registerType("Float32",6)}registerType(e,t){this.__types[e]=t,t.name?this.__names[t.name]=e:this.__names[t]=e}getType(e){return this.__types[e]}getTypeName(e){if(this.__names[e])return this.__names[e];if(this.__names[e.name])return this.__names[e.name];throw e}};class p extends m{constructor(e=0,t=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,2)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(2),this.fromJSON(e)):(this.__data=new Float32Array(2),this.__data[0]=e,this.__data[1]=t)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}set(e,t){this.__data[0]=e,this.__data[1]=t}setFromOther(e){this.x=e.x,this.y=e.y}equal(e){return this.x==e.x&&this.y==e.y}notEquals(e){return this.x!=e.x&&this.y!=e.y}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}add(e){return new p(this.x+e.x,this.y+e.y)}addInPlace(e){this.x+=e.x,this.y+=e.y}subtract(e){return new p(this.x-e.x,this.y-e.y)}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return new p(this.x*e,this.y*e)}scaleInPlace(e){this.x*=e,this.y*=e}invert(){return new p(1/this.x,1/this.y)}invertInPlace(){return this.x=1/this.x,this.y=1/this.y,this}multiply(e){return new p(this.x*e.x,this.y*e.y)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y}lengthSquared(){const e=this.__data[0],t=this.__data[1];return e*e+t*t}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,i=this.__data[1]-e.y;return Math.sqrt(t*t+i*i)}normalize(){const e=this.__data[0],t=this.__data[1];let i=e*e+t*t;return i<Number.EPSILON?new p:(i=1/Math.sqrt(i),new p(e*i,t*i))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1];let i=e*e+t*t;i<Number.EPSILON||(i=1/Math.sqrt(i),this.set(e*i,t*i))}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}angleTo(e){const t=this.normalize().dot(e.normalize());return t>1?0:t<-1?Math.PI:Math.acos(t)}signedAngleTo(e){const t=this.angleTo(e);return this.cross(e)<0?-t:t}rotate(e){const t=Math.cos(e),i=Math.sin(e);return new p(this.x*t-this.y*i,this.x*i+this.y*t)}lerp(e,t){const i=this.x,a=this.y;return new p(i+t*(e.x-i),a+t*(e.y-a))}setRandomDir(e=1){const t=2*Math.random()*Math.PI;return this.__data[0]=Math.cos(t)*zScale,this.__data[1]=Math.sin(t)*zScale,this}setRandom(e=1){return this.__data[0]=Math.random()*e,this.__data[1]=Math.random()*e,this}clone(){return new p(this.__data[0],this.__data[1])}asArray(){return this.__data}static create(...e){return new p(...e)}static createFromFloat32Buffer(e,t=0){return new p(e,4*t)}static createFromFloat32Array(e){return new p(e)}static numElements(){return 2}toJSON(){return{x:this.x,y:this.y}}fromJSON(e){this.x=e.x,this.y=e.y}}u.registerType("Vec2",p);class g extends m{constructor(e=0,t=0,i=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,3)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(3),this.fromJSON(e)):(this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get xy(){return new p(this.__data[0],this.__data[1])}get yz(){return new p(this.__data[1],this.__data[2])}set(e,t,i){this.x=e,this.y=void 0!==t?t:e,this.z=void 0!==i?i:e}setDataArray(e){this.__data=e}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z}isNull(){return Math.abs(this.x)<Number.EPSILON&&Math.abs(this.y)<Number.EPSILON&&Math.abs(this.z)<Number.EPSILON}is111(){return Math.abs(1-this.x)<Number.EPSILON&&Math.abs(1-this.y)<Number.EPSILON&&Math.abs(1-this.z)<Number.EPSILON}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z}notEquals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}add(e){return new g(this.x+e.x,this.y+e.y,this.z+e.z)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z}subtract(e){return new g(this.x-e.x,this.y-e.y,this.z-e.z)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z}multiply(e){return new g(this.x*e.x,this.y*e.y,this.z*e.z)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z}divide(e){return new g(this.x/e.x,this.y/e.y,this.z/e.z)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z}scale(e){return new g(this.x*e,this.y*e,this.z*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e}negate(){return new g(-this.x,-this.y,-this.z)}inverse(){return new g(1/this.x,1/this.y,1/this.z)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2];return e*e+t*t+i*i}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,i=this.__data[1]-e.y,a=this.__data[2]-e.z;return Math.sqrt(t*t+i*i+a*a)}normalize(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];return e<Number.EPSILON?new g:(e=1/Math.sqrt(e),new g(this.__data[0]*e,this.__data[1]*e,this.__data[2]*e))}normalizeInPlace(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(e<Number.EPSILON)return;e=Math.sqrt(e);const t=1/e;return this.__data[0]*=t,this.__data[1]*=t,this.__data[2]*=t,e}resize(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const i=e/Math.sqrt(t);return new g(this.__data[0]*i,this.__data[1]*i,this.__data[2]*i)}resizeInPlace(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const i=e/Math.sqrt(t);this.__data[0]*=i,this.__data[1]*=i,this.__data[2]*=i}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const t=this.x,i=this.y,a=this.z,s=e.x,n=e.y,r=e.z;return new g(i*r-a*n,a*s-t*r,t*n-i*s)}angleTo(e){const t=this.dot(e);return t>1?0:Math.acos(t)}lerp(e,t){const i=this.x,a=this.y,s=this.z;return new g(i+t*(e.x-i),a+t*(e.y-a),s+t*(e.z-s))}abs(){return new g(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}setRandomDir(e=1){const t=2*Math.random()*Math.PI,i=2*Math.random()-1,a=Math.sqrt(1-i*i)*e;return this.__data[0]=Math.cos(t)*a,this.__data[1]=Math.sin(t)*a,this.__data[2]=i*e,this}setRandom(e=1){return this.__data[0]=(Math.random()-.5)*e,this.__data[1]=(Math.random()-.5)*e,this.__data[2]=(Math.random()-.5)*e,this}clone(){return new g(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new g(...e)}static createFromJSON(e){const t=new g;return t.fromJSON(e),t}static createFromFloat32Buffer(e,t=0){return new g(e,4*t)}static createFromFloat32Array(e){return new g(e)}static numElements(){return 3}toJSON(){return{x:this.x,y:this.y,z:this.z}}fromJSON(e){this.x=e.x,this.y=e.y,this.z=e.z}}u.registerType("Vec3",g);class _ extends m{constructor(e=0,t=0,i=0,a=0){if(super(),e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,4)}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(4),this.fromJSON(e)):(this.__data=new Float32Array(4),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a)}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get t(){return this.__data[3]}set t(e){this.__data[3]=e}get xyz(){return new g(this.__data[0],this.__data[1],this.__data[2])}set(e,t,i,a){this.x=e,this.y=t,this.z=i,this.t=a}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z,this.t=e.t}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.t==e.t}notEquals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.t!=e.t}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.t-e.t)<t}add(e){return new _(this.x+e.x,this.y+e.y,this.z+e.z,this.t+e.t)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.t+=e.t}subtract(e){return new _(this.x-e.x,this.y-e.y,this.z-e.z,this.t-e.t)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z,this.t-=e.t}multiply(e){return new _(this.x*e.x,this.y*e.y,this.z*e.z,this.t*e.t)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z,this.t*=e.t}divide(e){return new _(this.x/e.x,this.y/e.y,this.z/e.z,this.t/e.t)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z,this.t/=e.t}scale(e){return new _(this.x*e,this.y*e,this.z*e,this.t*e)}scaleInPlace(e){this.set(this.x*e,this.y*e,this.z*e,this.t*e)}length(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[2];return Math.sqrt(e*e+t*t+i*i+a*a)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];return e*e+t*t+i*i+a*a}normalize(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];let s=e*e+t*t+i*i+a*a;return s<Number.EPSILON?new _:(s=1/Math.sqrt(s),new _(e*s,t*s,i*s))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];let s=e*e+t*t+i*i+a*a;s<Number.EPSILON||(s=1/Math.sqrt(s),this.set(e*s,t*s,i*s,a*s))}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.t*b.t}cross(e){const t=this.x,i=this.y,a=this.z,s=this.t,n=e.x,r=e.y,l=e.z,o=e.t;return new _(i*l-a*r,a*o-s*l,s*n-t*o,t*r-i*n)}angleTo(e){const t=this.normalize(),i=e.normalize(),a=t.dot(i);return a>1?0:Math.acos(a)}lerp(e,t){const i=this.x,a=this.y,s=this.z;return at=this.t,new _(i+t*(e.x-i),a+t*(e.y-a),s+t*(e.z-s),at+t*(e.t-at))}random(e=1){const t=2*glMatrix.RANDOM()*Math.PI,i=2*glMatrix.RANDOM()-1,a=Math.sqrt(1-i*i)*e;return out[0]=Math.cos(t)*a,out[1]=Math.sin(t)*a,out[2]=i*e,out}clone(){return new _(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toVec3(){return new g(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new g(...e)}static createFromFloat32Buffer(e,t=0){return new _(e,4*t)}static numElements(){return 4}toJSON(){return{x:this.x,y:this.y,z:this.z,t:this.t}}}u.registerType("Vec4",_);class f extends m{constructor(e=0,t=0,i=0,a=255){if(super(),e instanceof Uint8Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Uint8Array(i,a,4)}else this.__data=new Uint8Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a)}get r(){return this.__data[0]}set r(e){this.__data[0]=e}get g(){return this.__data[1]}set g(e){this.__data[1]=e}get b(){return this.__data[2]}set b(e){this.__data[2]=e}get a(){return this.__data[3]}set a(e){this.__data[3]=e}set(e,t,i,a=255){this.r=e,this.g=t,this.b=i,this.a=a}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}setFromArray(e){this.r=e[0],this.g=e[1],this.b=e[2],this.a=4==e.length?e[3]:1}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.set(t.r,t.g,t.b):console.warn("Invalid hex code:"+e)}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e))}toHex(){function e(e){const t=e.toString(16);return 1==t.length?"0"+t:t}return"#"+e(this.r)+e(this.g)+e(this.b)}equal(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notequals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new f(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new f(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new f(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toLinear(e=2.2){return new f(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new f(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const i=this.r,a=this.g,s=this.b,n=this.a;return new f(i+t*(e.r-i),a+t*(e.g-a),s+t*(e.b-s),n+t*(e.a-n))}static random(e=0,t=!1){return e>0?new f(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new f(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new f(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new f(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return[this.__data[0],this.__data[1],this.__data[2]]}static create(...e){return new f(...e)}static createFromFloat32Buffer(e,t=0){return new f(e,4*t)}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}toCSSString(){return"rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}u.registerType("RGBA",f);class Z extends m{constructor(e=0,t=0,i=0,a=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,4)}else this.__data=new Float32Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a)}get r(){return this.__data[0]}set r(e){this.__data[0]=e}get g(){return this.__data[1]}set g(e){this.__data[1]=e}get b(){return this.__data[2]}set b(e){this.__data[2]=e}get a(){return this.__data[3]}set a(e){this.__data[3]=e}set(e,t,i,a=1){this.r=e,this.g=t,this.b=i,this.a=a}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}setFromScalarArray(e){this.r=e[0],this.g=e[1],this.b=e[2],this.a=4==e.length?e[3]:1}getAsRGBArray(){return[255*this.r,255*this.g,255*this.b]}getAsRGBDict(){return{r:255*this.r,g:255*this.g,b:255*this.b}}setFromRGB(e,t,i,a){this.r=e/255,this.g=t/255,this.b=i/255,this.a=a?a/255:1}setFromRGBArray(e){this.r=e[0]/255,this.g=e[1]/255,this.b=e[2]/255,this.a=4==e.length?e[3]/255:1}setFromRGBDict(e){this.r=e.r/255,this.g=e.g/255,this.b=e.b/255,this.a=4==e.a?e.a/255:1}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.setFromRGB(t.r,t.g,t.b):console.warn("Invalid hex code:"+e)}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e))}toHex(){function e(e){const t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t}return"#"+e(this.r)+e(this.g)+e(this.b)}equal(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notequals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new Z(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new Z(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new Z(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toLinear(e=2.2){return new Z(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new Z(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const i=this.r,a=this.g,s=this.b,n=this.a;return new Z(i+t*(e.r-i),a+t*(e.g-a),s+t*(e.b-s),n+t*(e.a-n))}static random(e=0,t=!1){return e>0?new Z(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new Z(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new Z(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new Z(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return[this.__data[0],this.__data[1],this.__data[2]]}static create(...e){return new Z(...e)}static createFromFloat32Buffer(e,t=0){return new Z(e,4*t)}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a}toCSSString(){return"rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}u.registerType("Color",Z);class G extends m{constructor(e=0,t=0,i=0,a=0){if(super(),isNaN(a))switch(a){case"XYZ":this.order=0;break;case"YZX":this.order=1;break;case"ZXY":this.order=2;break;case"XZY":this.order=3;break;case"ZYX":this.order=4;break;case"YXZ":this.order=5;break;default:throw new Error("Invalid Euler Angles Order:"+a)}else this.order=a;if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,4)}else this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=i}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}set(e,t,i){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i}}u.registerType("EulerAngles",G);class y extends m{constructor(e=1,t=0,i=0,a=0,s=1,n=0,r=0,l=0,o=1){if(super(),e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,9)}else this.__data=new Float32Array(9),this.set(e,t,i,a,s,n,r,l,o)}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e}get m10(){return this.__data[3]}set m10(e){this.__data[3]=e}get m11(){return this.__data[4]}set m11(e){this.__data[4]=e}get m12(){return this.__data[5]}set m12(e){this.__data[5]=e}get m20(){return this.__data[6]}set m20(e){this.__data[6]=e}get m21(){return this.__data[7]}set m21(e){this.__data[7]=e}get m22(){return this.__data[8]}set m22(e){this.__data[8]=e}get xAxis(){return g.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z)}get yAxis(){return g.createFromFloat32Buffer(this.__data.buffer,3)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z)}get zAxis(){return g.createFromFloat32Buffer(this.__data.buffer,6)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z)}set(e=1,t=0,i=0,a=0,s=1,n=0,r=0,l=0,o=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a,this.__data[4]=s,this.__data[5]=n,this.__data[6]=r,this.__data[7]=l,this.__data[8]=o}setIdentity(){this.set()}setFromMat(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m10,this.__data[4]=e.m11,this.__data[5]=e.m12,this.__data[6]=e.m20,this.__data[7]=e.m21,this.__data[8]=e.m22}setFromDirectionAndUpvector(e,t){const i=e,a=i.length();if(a<Number.EPSILON)return void this.setIdentity();i.scaleInPlace(1/a);const s=t.cross(i),n=s.length();n>Number.EPSILON&&s.scaleInPlace(1/n);const r=i.cross(s),l=r.length();l>Number.EPSILON&&r.scaleInPlace(1/l),this.set(s.x,s.y,s.z,r.x,r.y,r.z,i.x,i.y,i.z)}inverse(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3],s=this.__data[4],n=this.__data[5],r=this.__data[6],l=this.__data[7],o=this.__data[8],d=o*s-n*l,h=-o*a+n*r,c=l*a-s*r,m=e*d+t*h+i*c;return m?(m=1/m,new y(d*m,(-o*t+i*l)*m,(n*t-i*s)*m,h*m,(o*e-i*r)*m,(-n*e+i*a)*m,c*m,(-l*e+t*r)*m,(s*e-t*a)*m)):(console.warn("Unable to invert Mat3"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3],s=this.__data[4],n=this.__data[5],r=this.__data[6],l=this.__data[7],o=this.__data[8],d=o*s-n*l,h=-o*a+n*r,c=l*a-s*r,m=e*d+t*h+i*c;return m?(m=1/m,this.set(d*m,(-o*t+i*l)*m,(n*t-i*s)*m,h*m,(o*e-i*r)*m,(-n*e+i*a)*m,c*m,(-l*e+t*r)*m,(s*e-t*a)*m),!0):(console.warn("Unable to invert Mat3"),!1)}transpose(){return y(this.__data[0],this.__data[3],this.__data[6],this.__data[1],this.__data[4],this.__data[7],this.__data[2],this.__data[5],this.__data[8])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],i=this.__data[5];this.__data[1]=this.__data[3],this.__data[2]=this.__data[6],this.__data[3]=e,this.__data[5]=this.__data[7],this.__data[6]=t,this.__data[7]=i}transformVec3(e){return new g(this.__data[0]*e.x+this.__data[1]*e.y+this.__data[2]*e.z,this.__data[3]*e.x+this.__data[4]*e.y+this.__data[5]*e.z,this.__data[6]*e.x+this.__data[7]*e.y+this.__data[8]*e.z)}clone(){return new y(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9])}static create(...e){return new y(...e)}static createFromFloat32Buffer(e,t=0){return new y(e,4*t)}toJSON(){return this.__data}fromJSON(e){this.__data=new Float32Array(e)}toString(){return this.toJSON().toString()}}u.registerType("Mat3",y);class X extends m{constructor(e=1,t=0,i=0,a=0,s=0,n=1,r=0,l=0,o=0,d=0,h=1,c=0,m=0,u=0,b=0,p=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,16)}else this.__data=new Float32Array(16),this.set(e,t,i,a,s,n,r,l,o,d,h,c,m,u,b,p)}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e}get m03(){return this.__data[3]}set m03(e){this.__data[3]=e}get m10(){return this.__data[4]}set m10(e){this.__data[4]=e}get m11(){return this.__data[5]}set m11(e){this.__data[5]=e}get m12(){return this.__data[6]}set m12(e){this.__data[6]=e}get m13(){return this.__data[7]}set m13(e){this.__data[7]=e}get m20(){return this.__data[8]}set m20(e){this.__data[8]=e}get m21(){return this.__data[9]}set m21(e){this.__data[9]=e}get m22(){return this.__data[10]}set m22(e){this.__data[10]=e}get m23(){return this.__data[11]}set m23(e){this.__data[11]=e}get m30(){return this.__data[12]}set m30(e){this.__data[12]=e}get m31(){return this.__data[13]}set m31(e){this.__data[13]=e}get m32(){return this.__data[14]}set m32(e){this.__data[14]=e}get m33(){return this.__data[15]}set m33(e){this.__data[15]=e}get xAxis(){return g.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z)}get yAxis(){return g.createFromFloat32Buffer(this.__data.buffer,4)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z)}get zAxis(){return g.createFromFloat32Buffer(this.__data.buffer,8)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z)}get translation(){return g.createFromFloat32Buffer(this.__data.buffer,12)}set translation(e){this.translation.set(e.x,e.y,e.z)}set(e=1,t=0,i=0,a=0,s=0,n=1,r=0,l=0,o=0,d=0,h=1,c=0,m=0,u=0,b=0,p=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a,this.__data[4]=s,this.__data[5]=n,this.__data[6]=r,this.__data[7]=l,this.__data[8]=o,this.__data[9]=d,this.__data[10]=h,this.__data[11]=c,this.__data[12]=m,this.__data[13]=u,this.__data[14]=b,this.__data[15]=p}setIdentity(){this.set()}setDataArray(e){this.__data=e}setFromMat4(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m03,this.__data[4]=e.m10,this.__data[5]=e.m11,this.__data[6]=e.m12,this.__data[7]=e.m13,this.__data[8]=e.m20,this.__data[9]=e.m21,this.__data[10]=e.m22,this.__data[11]=e.m23,this.__data[12]=e.m30,this.__data[13]=e.m31,this.__data[14]=e.m32,this.__data[15]=e.m33}toMat3(e){return new y(this.__data[0],this.__data[1],this.__data[2],this.__data[4],this.__data[5],this.__data[6],this.__data[8],this.__data[9],this.__data[10])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],i=this.__data[3],a=this.__data[6],s=this.__data[7],n=this.__data[11];this.__data[1]=this.__data[4],this.__data[2]=this.__data[8],this.__data[3]=this.__data[12],this.__data[4]=e,this.__data[6]=this.__data[9],this.__data[7]=this.__data[13],this.__data[8]=t,this.__data[9]=a,this.__data[11]=this.__data[14],this.__data[12]=i,this.__data[13]=s,this.__data[14]=n}transpose(){return new X(this.__data[0],this.__data[4],this.__data[8],this.__data[12],this.__data[1],this.__data[5],this.__data[9],this.__data[13],this.__data[2],this.__data[6],this.__data[10],this.__data[14],this.__data[3],this.__data[7],this.__data[11],this.__data[15])}inverse(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3],s=this.__data[4],n=this.__data[5],r=this.__data[6],l=this.__data[7],o=this.__data[8],d=this.__data[9],h=this.__data[10],c=this.__data[11],m=this.__data[12],u=this.__data[13],b=this.__data[14],p=this.__data[15],g=e*n-t*s,_=e*r-i*s,f=e*l-a*s,Z=t*r-i*n,G=t*l-a*n,y=i*l-a*r,V=o*u-d*m,I=o*b-h*m,R=o*p-c*m,x=d*b-h*u,S=d*p-c*u,W=h*p-c*b;let L=g*W-_*S+f*x+Z*R-G*I+y*V;return L?(L=1/L,new X((n*W-r*S+l*x)*L,(i*S-t*W-a*x)*L,(u*y-b*G+p*Z)*L,(h*G-d*y-c*Z)*L,(r*R-s*W-l*I)*L,(e*W-i*R+a*I)*L,(b*f-m*y-p*_)*L,(o*y-h*f+c*_)*L,(s*S-n*R+l*V)*L,(t*R-e*S-a*V)*L,(m*G-u*f+p*g)*L,(d*f-o*G-c*g)*L,(n*I-s*x-r*V)*L,(e*x-t*I+i*V)*L,(u*_-m*Z-b*g)*L,(o*Z-d*_+h*g)*L)):(console.warn("Unable to invert Mat4"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3],s=this.__data[4],n=this.__data[5],r=this.__data[6],l=this.__data[7],o=this.__data[8],d=this.__data[9],h=this.__data[10],c=this.__data[11],m=this.__data[12],u=this.__data[13],b=this.__data[14],p=this.__data[15],g=e*n-t*s,_=e*r-i*s,f=e*l-a*s,Z=t*r-i*n,G=t*l-a*n,y=i*l-a*r,X=o*u-d*m,V=o*b-h*m,I=o*p-c*m,R=d*b-h*u,x=d*p-c*u,S=h*p-c*b;let W=g*S-_*x+f*R+Z*I-G*V+y*X;return W?(W=1/W,this.set((n*S-r*x+l*R)*W,(i*x-t*S-a*R)*W,(u*y-b*G+p*Z)*W,(h*G-d*y-c*Z)*W,(r*I-s*S-l*V)*W,(e*S-i*I+a*V)*W,(b*f-m*y-p*_)*W,(o*y-h*f+c*_)*W,(s*x-n*I+l*X)*W,(t*I-e*x-a*X)*W,(m*G-u*f+p*g)*W,(d*f-o*G-c*g)*W,(n*V-s*R-r*X)*W,(e*R-t*V+i*X)*W,(u*_-m*Z-b*g)*W,(o*Z-d*_+h*g)*W),!0):(console.warn("Unable to invert Mat4"),!1)}setInverse(e){const t=e.__data[0],i=e.__data[1],a=e.__data[2],s=e.__data[3],n=e.__data[4],r=e.__data[5],l=e.__data[6],o=e.__data[7],d=e.__data[8],h=e.__data[9],c=e.__data[10],m=e.__data[11],u=e.__data[12],b=e.__data[13],p=e.__data[14],g=e.__data[15],_=t*r-i*n,f=t*l-a*n,Z=t*o-s*n,G=i*l-a*r,y=i*o-s*r,X=a*o-s*l,V=d*b-h*u,I=d*p-c*u,R=d*g-m*u,x=h*p-c*b,S=h*g-m*b,W=c*g-m*p;let L=_*W-f*S+Z*x+G*R-y*I+X*V;if(!L)throw new Error("Unable to invert Mat4");L=1/L,this.set((r*W-l*S+o*x)*L,(a*S-i*W-s*x)*L,(b*X-p*y+g*G)*L,(c*y-h*X-m*G)*L,(l*R-n*W-o*I)*L,(t*W-a*R+s*I)*L,(p*Z-u*X-g*f)*L,(d*X-c*Z+m*f)*L,(n*S-r*R+o*V)*L,(i*R-t*S-s*V)*L,(u*y-b*Z+g*_)*L,(h*Z-d*y-m*_)*L,(r*I-n*x-l*V)*L,(t*x-i*I+a*V)*L,(b*f-u*G-p*_)*L,(d*G-h*f+c*_)*L)}multiply(e){const t=this.__data[0],i=this.__data[1],a=this.__data[2],s=this.__data[3],n=this.__data[4],r=this.__data[5],l=this.__data[6],o=this.__data[7],d=this.__data[8],h=this.__data[9],c=this.__data[10],m=this.__data[11],u=this.__data[12],b=this.__data[13],p=this.__data[14],g=this.__data[15],_=e.asArray();let f=_[0],Z=_[1],G=_[2],y=_[3];const V=new X;return V.m00=f*t+Z*n+G*d+y*u,V.m01=f*i+Z*r+G*h+y*b,V.m02=f*a+Z*l+G*c+y*p,V.m03=f*s+Z*o+G*m+y*g,f=_[4],Z=_[5],G=_[6],y=_[7],V.m10=f*t+Z*n+G*d+y*u,V.m11=f*i+Z*r+G*h+y*b,V.m12=f*a+Z*l+G*c+y*p,V.m13=f*s+Z*o+G*m+y*g,f=_[8],Z=_[9],G=_[10],y=_[11],V.m20=f*t+Z*n+G*d+y*u,V.m21=f*i+Z*r+G*h+y*b,V.m22=f*a+Z*l+G*c+y*p,V.m23=f*s+Z*o+G*m+y*g,f=_[12],Z=_[13],G=_[14],y=_[15],V.m30=f*t+Z*n+G*d+y*u,V.m31=f*i+Z*r+G*h+y*b,V.m32=f*a+Z*l+G*c+y*p,V.m33=f*s+Z*o+G*m+y*g,V}multiplyInPlace(e){const t=this.asArray(),i=t[0],a=t[1],s=t[2],n=t[3],r=t[4],l=t[5],o=t[6],d=t[7],h=t[8],c=t[9],m=t[10],u=t[11],b=t[12],p=t[13],g=t[14],_=t[15],f=e.asArray();let Z=f[0],G=f[1],y=f[2],X=f[3];return this.m00=Z*i+G*r+y*h+X*b,this.m01=Z*a+G*l+y*c+X*p,this.m02=Z*s+G*o+y*m+X*g,this.m03=Z*n+G*d+y*u+X*_,Z=f[4],G=f[5],y=f[6],X=f[7],this.m10=Z*i+G*r+y*h+X*b,this.m11=Z*a+G*l+y*c+X*p,this.m12=Z*s+G*o+y*m+X*g,this.m13=Z*n+G*d+y*u+X*_,Z=f[8],G=f[9],y=f[10],X=f[11],this.m20=Z*i+G*r+y*h+X*b,this.m21=Z*a+G*l+y*c+X*p,this.m22=Z*s+G*o+y*m+X*g,this.m23=Z*n+G*d+y*u+X*_,Z=f[12],G=f[13],y=f[14],X=f[15],this.m30=Z*i+G*r+y*h+X*b,this.m31=Z*a+G*l+y*c+X*p,this.m32=Z*s+G*o+y*m+X*g,this.m33=Z*n+G*d+y*u+X*_,this}postmultiplyInPlace(e){const t=e.asArray(),i=t[0],a=t[1],s=t[2],n=t[3],r=t[4],l=t[5],o=t[6],d=t[7],h=t[8],c=t[9],m=t[10],u=t[11],b=t[12],p=t[13],g=t[14],_=t[15],f=this.asArray();let Z=f[0],G=f[1],y=f[2],X=f[3];return this.m00=Z*i+G*r+y*h+X*b,this.m01=Z*a+G*l+y*c+X*p,this.m02=Z*s+G*o+y*m+X*g,this.m03=Z*n+G*d+y*u+X*_,Z=f[4],G=f[5],y=f[6],X=f[7],this.m10=Z*i+G*r+y*h+X*b,this.m11=Z*a+G*l+y*c+X*p,this.m12=Z*s+G*o+y*m+X*g,this.m13=Z*n+G*d+y*u+X*_,Z=f[8],G=f[9],y=f[10],X=f[11],this.m20=Z*i+G*r+y*h+X*b,this.m21=Z*a+G*l+y*c+X*p,this.m22=Z*s+G*o+y*m+X*g,this.m23=Z*n+G*d+y*u+X*_,Z=f[12],G=f[13],y=f[14],X=f[15],this.m30=Z*i+G*r+y*h+X*b,this.m31=Z*a+G*l+y*c+X*p,this.m32=Z*s+G*o+y*m+X*g,this.m33=Z*n+G*d+y*u+X*_,this}translateInPlace(e){const t=this.__data,i=e.x,a=e.y,s=e.z;return t[12]=t[0]*i+t[4]*a+t[8]*s+t[12],t[13]=t[1]*i+t[5]*a+t[9]*s+t[13],t[14]=t[2]*i+t[6]*a+t[10]*s+t[14],t[15]=t[3]*i+t[7]*a+t[11]*s+t[15],this}setLookAt(e,t,i){const a=e.subtract(t),s=a.length();if(s<Number.EPSILON)return void this.setIdentity();a.scaleInPlace(1/s);const n=i.cross(a),r=n.length();r>Number.EPSILON&&n.scaleInPlace(1/r);const l=a.cross(n),o=l.length();o>Number.EPSILON&&l.scaleInPlace(1/o),this.set(n.x,n.y,n.z,0,l.x,l.y,l.z,0,a.x,a.y,a.z,0,e.x,e.y,e.z,1)}setRotation(e,t){const i=e.length();if(Math.abs(i)<Number.EPSILON)return null;const a=e.x/i,s=e.y/i,n=e.z/i,r=Math.sin(t),l=Math.cos(t),o=1-l,d=this.__data;return d[0]=a*a*o+l,d[1]=s*a*o+n*r,d[2]=n*a*o-s*r,d[3]=0,d[4]=a*s*o-n*r,d[5]=s*s*o+l,d[6]=n*s*o+a*r,d[7]=0,d[8]=a*n*o+s*r,d[9]=s*n*o-a*r,d[10]=n*n*o+l,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}setXRotation(e){const t=Math.sin(e),i=Math.cos(e),a=this.__data;return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=i,a[6]=t,a[7]=0,a[8]=0,a[9]=-t,a[10]=i,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}setYRotation(e){const t=Math.sin(e),i=Math.cos(e),a=this.__data;return a[0]=i,a[1]=0,a[2]=-t,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=t,a[9]=0,a[10]=i,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}setZRotation(e){const t=Math.sin(e),i=Math.cos(e),a=this.__data;return a[0]=i,a[1]=t,a[2]=0,a[3]=0,a[4]=-t,a[5]=i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}transformVec4(e){const t=this.__data,i=e.x,a=e.y,s=e.z,n=e.t;return new Vec4(t[0]*i+t[4]*a+t[8]*s+t[12]*n,t[1]*i+t[5]*a+t[9]*s+t[13]*n,t[2]*i+t[6]*a+t[10]*s+t[14]*n,t[3]*i+t[7]*a+t[11]*s+t[15]*n)}transformVec3(e){const t=this.__data,i=e.x,a=e.y,s=e.z;return new g(t[0]*i+t[4]*a+t[8]*s+t[12],t[1]*i+t[5]*a+t[9]*s+t[13],t[2]*i+t[6]*a+t[10]*s+t[14])}rotateVec3(e){const t=this.__data,i=e.x,a=e.y,s=e.z;return new g(t[0]*i+t[4]*a+t[8]*s,t[1]*i+t[5]*a+t[9]*s,t[2]*i+t[6]*a+t[10]*s)}setPerspectiveMatrix(e,t,i,a){const s=Math.tan(.5*Math.PI-.5*e),n=1/(i-a);this.set(s/t,0,0,0,0,s,0,0,0,0,(i+a)*n,-1,0,0,i*a*n*2,0)}setOrthographicMatrix(e,t,i,a,s,n){const r=1/(e-t),l=1/(i-a),o=1/(s-n);this.set(-2*r,0,0,0,0,-2*l,0,0,0,0,2*o,0,(e+t)*r,(a+i)*l,(n+s)*o,1)}setScale(e,t,i){e instanceof g?this.set(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1):this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1)}setFromMat3x4Array(e){this.set(e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,e[9],e[10],e[11],1)}static createFromFloat32Buffer(e,t=0){return new X(e,4*t)}clone(){return new X(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9],this.__data[10],this.__data[11],this.__data[12],this.__data[13],this.__data[14],this.__data[15])}static create(...e){return new X(...e)}toJSON(){return this.__data}fromJSON(e){this.__data=new Float32Array(e)}}u.registerType("Mat4",X);class V extends m{constructor(e=0,t=0,i=0,a=1){if(super(),e instanceof ArrayBuffer){const i=e,a=t;this.__data=new Float32Array(i,a,4)}else if(this.__data=new Float32Array(4),"object"==typeof e){this.__data[0]=0,this.__data[1]=0,this.__data[2]=0,this.__data[3]=1;for(const t in e)Array.isArray(e[t])?this[t].call(this,...e[t]):this[t].call(this,e[t])}else this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a}get x(){return this.__data[0]}set x(e){this.__data[0]=e}get y(){return this.__data[1]}set y(e){this.__data[1]=e}get z(){return this.__data[2]}set z(e){this.__data[2]=e}get w(){return this.__data[3]}set w(e){this.__data[3]=e}set(e,t,i,a){this.__data[0]=e,this.__data[1]=t,this.__data[2]=i,this.__data[3]=a}setDataArray(e){this.__data=e}setFromOther(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w}setFromEulerAngles(e){const t=new g;switch(e.order){case 0:t.set(e.x,-e.y,e.z);break;case 1:t.set(e.y,-e.z,e.x);break;case 2:t.set(e.z,-e.x,e.y);break;case 3:t.set(e.x,e.z,e.y);break;case 4:t.set(e.z,e.y,e.x);break;case 5:t.set(e.y,e.x,e.z);break;default:throw new Error("sdrty")}const i=.5*t.x,a=.5*t.y,s=.5*t.z,n=Math.cos(i),r=Math.cos(a),l=Math.cos(s),o=Math.sin(i),d=Math.sin(a),h=Math.sin(s),c=n*l,m=n*h,u=o*l,b=o*h,p=r*u-d*m,_=r*b+d*c,f=r*m-d*u;switch(this.w=r*c+d*b,e.order){case 0:this.x=p,this.y=-_,this.z=f;break;case 1:this.x=f,this.y=p,this.z=-_;break;case 2:this.x=-_,this.y=f,this.z=p;break;case 3:this.x=p,this.y=f,this.z=_;break;case 4:this.x=f,this.y=_,this.z=p;break;case 5:this.x=_,this.y=p,this.z=f;break;default:throw new Error("sdrty")}}toEulerAngles(e){const t=new g;switch(e){case 0:t.set(this.z,this.x,this.y);break;case 1:t.set(this.x,this.y,this.z);break;case 2:t.set(this.y,this.z,this.x);break;case 3:t.set(this.y,-this.x,this.z);break;case 4:t.set(this.x,-this.z,this.y);break;case 5:t.set(this.z,-this.y,this.x);break;default:throw new Error("Invalid rotation order:"+e)}const i=new g,a=t.x*t.y+t.z*this.w;if(a>.49999)i.y=2*Math.atan2(t.x,this.w),i.z=.5*Math.PI,i.x=0;else if(a<-.49999)i.y=-2*Math.atan2(t.x,this.w),i.z=-.5*Math.PI,i.x=0;else{const e=t.x*t.x,s=t.y*t.y,n=t.z*t.z;i.y=Math.atan2(2*t.y*this.w-2*t.x*t.z,1-2*s-2*n),i.z=Math.asin(2*a),i.x=Math.atan2(2*t.x*this.w-2*t.y*t.z,1-2*e-2*n)}switch(e){case 0:return new G(i.y,i.z,i.x,e);case 1:return new G(i.x,i.y,i.z,e);case 2:return new G(i.z,i.x,i.y,e);case 3:return new G(-i.y,i.x,i.z,e);case 4:return new G(i.x,i.z,-i.y,e);case 5:return new G(i.z,-i.y,i.x,e)}}setFromAxisAndAngle(e,t){const i=t/2,a=e.normalize().scale(Math.sin(i));this.set(a.x,a.y,a.z,Math.cos(i))}setFromDirectionAndUpvector(e,t){const i=new y;i.setFromDirectionAndUpvector(e,t),this.setFromMat3(i)}setFrom2Vectors(e,t){e.normalize(),t.normalize();const i=e.cross(t),a=e.dot(t),s=Math.sqrt(2*(1+a));this.set(i.x/s,i.y/s,i.z/s,s/2),this.normalizeInPlace()}setFromMat3(e){const t=e.__data[0]+e.__data[4]+e.__data[8];let i;if(t>0)i=Math.sqrt(t+1),this.__data[3]=.5*i,i=.5/i,this.__data[0]=(e.__data[5]-e.__data[7])*i,this.__data[1]=(e.__data[6]-e.__data[2])*i,this.__data[2]=(e.__data[1]-e.__data[3])*i;else{let t=0;e.__data[4]>e.__data[0]&&(t=1),e.__data[8]>e.__data[3*t+t]&&(t=2);const a=(t+1)%3,s=(t+2)%3;i=Math.sqrt(e.__data[3*t+t]-e.__data[3*a+a]-e.__data[3*s+s]+1),this.__data[t]=.5*i,i=.5/i,this.__data[3]=(e.__data[3*a+s]-e.__data[3*s+a])*i,this.__data[a]=(e.__data[3*a+t]+e.__data[3*t+a])*i,this.__data[s]=(e.__data[3*s+t]+e.__data[3*t+s])*i}this.normalizeInPlace()}setFromMat4(e){const t=e.__data[0]+e.__data[5]+e.__data[10];let i;if(t>0)i=Math.sqrt(t+1),this.__data[3]=.5*i,i=.5/i,this.__data[0]=(e.__data[6]-e.__data[9])*i,this.__data[1]=(e.__data[8]-e.__data[2])*i,this.__data[2]=(e.__data[1]-e.__data[4])*i;else{let t=0;e.__data[5]>e.__data[0]&&(t=1),e.__data[10]>e.__data[4*t+t]&&(t=2);const a=(t+1)%3,s=(t+2)%3;i=Math.sqrt(e.__data[4*t+t]-e.__data[4*a+a]-e.__data[4*s+s]+1),this.__data[t]=.5*i,i=.5/i,this.__data[3]=(e.__data[4*a+s]-e.__data[4*s+a])*i,this.__data[a]=(e.__data[4*a+t]+e.__data[4*t+a])*i,this.__data[s]=(e.__data[4*s+t]+e.__data[4*t+s])*i}this.normalizeInPlace()}isIdentity(){return this.getAngle()<Number.EPSILON}getAngle(){return 2*Math.acos(this.w)}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.w==e.w}notequals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.w!=e.w}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}add(e){return new V(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w}subtract(e){return new V(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}scale(e){return new V(this.x*e,this.y*e,this.z*e,this.w*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e,this.w*=e}length(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];return Math.sqrt(e*e+t*t+i*i+a*a)}lengthSquared(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];return e*e+t*t+i*i+a*a}normalize(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];let s=e*e+t*t+i*i+a*a;return s<Number.EPSILON?new V:(s=1/Math.sqrt(s),new V(e*s,t*s,i*s))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],i=this.__data[2],a=this.__data[3];let s=e*e+t*t+i*i+a*a;s<Number.EPSILON||(s=1/Math.sqrt(s),this.set(e*s,t*s,i*s,a*s))}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}cross(e){const t=this.x,i=this.y,a=this.z,s=this.w,n=e.x,r=e.y,l=e.z,o=e.w;return new V(i*l-a*r,a*o-s*l,s*n-t*o,t*r-i*n)}conjugate(){return new V(-this.x,-this.y,-this.z,this.w)}inverse(){return this.conjugate()}alignWith(e){this.dot(e)<0&&this.set(-this.x,-this.y,-this.z,-this.w)}multiply(e){const t=this.__data[0],i=this.__data[1],a=this.__data[2],s=this.__data[3],n=e.__data[0],r=e.__data[1],l=e.__data[2],o=e.__data[3];return new V(t*o+s*n+i*l-a*r,i*o+s*r+a*n-t*l,a*o+s*l+t*r-i*n,s*o-t*n-i*r-a*l)}multiplyInPlace(e){const t=this.__data[0],i=this.__data[1],a=this.__data[2],s=this.__data[3],n=e.__data[0],r=e.__data[1],l=e.__data[2],o=e.__data[3];this.set(t*o+s*n+i*l-a*r,i*o+s*r+a*n-t*l,a*o+s*l+t*r-i*n,s*o-t*n-i*r-a*l)}rotateVec3(e){const t=new V(e.x,e.y,e.z,0),i=this.multiply(t).multiply(this.conjugate());return new g(i.x,i.y,i.z)}rotateX(e){e*=.5;const t=this.x,i=this.y,a=this.z,s=this.w,n=Math.sin(e),r=Math.cos(e);this.x=t*r+s*n,this.y=i*r+a*n,this.z=a*r-i*n,this.w=s*r-t*n}rotateY(e){e*=.5;const t=this.x,i=this.y,a=this.z,s=this.w,n=Math.sin(e),r=Math.cos(e);this.x=t*r-a*n,this.y=i*r+s*n,this.z=a*r+t*n,this.w=s*r-i*n}rotateZ(e){e*=.5;const t=this.x,i=this.y,a=this.z,s=this.w,n=Math.sin(e),r=Math.cos(e);this.x=t*r+i*n,this.y=i*r-t*n,this.z=a*r+s*n,this.w=s*r-a*n}toMat3(){const e=this.x,t=this.y,i=this.z,a=this.w,s=e+e,n=t+t,r=i+i,l=e*s,o=t*s,d=t*n,h=i*s,c=i*n,m=i*r,u=a*s,b=a*n,p=a*r,g=new y;return g.__data[0]=1-d-m,g.__data[3]=o-p,g.__data[6]=h+b,g.__data[1]=o+p,g.__data[4]=1-l-m,g.__data[7]=c-u,g.__data[2]=h-b,g.__data[5]=c+u,g.__data[8]=1-l-d,g}getXaxis(){const e=this.x*this.y,t=this.x*this.z,i=this.y*this.y,a=this.y*this.w,s=this.z*this.z,n=this.z*this.w;return new g(1-2*(s+i),2*(e+n),2*(t-a))}getYaxis(){const e=this.x*this.x,t=this.x*this.y,i=this.x*this.w,a=this.y*this.z,s=this.z*this.z,n=this.z*this.w;return new g(2*(t-n),1-2*(s+e),2*(a+i))}getZaxis(){const e=this.x*this.x,t=this.x*this.z,i=this.x*this.w,a=this.y*this.y,s=this.y*this.z,n=this.y*this.w;return new g,new g(2*(n+t),2*(s-i),1-2*(a+e))}mirror(e){switch(e){case 0:return new V(this.z,this.w,this.x,this.y);case 1:return new V(-this.w,this.z,this.y,-this.x);case 2:return new V(this.x,this.y,this.z,-this.w)}}toMat4(){const e=this.x,t=this.y,i=this.z,a=this.w,s=e+e,n=t+t,r=i+i,l=e*s,o=t*s,d=t*n,h=i*s,c=i*n,m=i*r,u=a*s,b=a*n,p=a*r,g=new X;return g.__data[0]=1-d-m,g.__data[4]=o-p,g.__data[8]=h+b,g.__data[1]=o+p,g.__data[5]=1-l-m,g.__data[9]=c-u,g.__data[2]=h-b,g.__data[6]=c+u,g.__data[10]=1-l-d,g}lerp(e,t){const i=new V(this.x+t*(e.x-this.x),this.y+t*(e.y-this.y),this.z+t*(e.z-this.z),this.w+t*(e.w-this.w));return i.normalizeInPlace(),i}static create(...e){return new V(...e)}static createFromFloat32Buffer(e,t=0){return new V(e,4*t)}static numElements(){return 4}clone(){return new V(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toJSON(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromJSON(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w,this.normalizeInPlace()}}u.registerType("Quat",V);class I{constructor(e,t){this.start=e instanceof g?e:new g,this.dir=t instanceof g?t:new g}closestPoint(e){const t=e.subtract(this.start).dot(this.dir);if(t<Number.EPSILON)return this.start;const i=t/this.dir.dot(this.dir);return this.start.add(this.dir.scale(i))}pointAtDist(e){return this.start.add(this.dir.scale(e))}intersectRayVector(e){const t=this.dir,i=e.dir,a=this.start.subtract(e.start),s=t.dot(t),n=t.dot(i),r=i.dot(i),l=t.dot(a),o=i.dot(a);if(0==s&&0==r)return this.start.distanceTo(e.start);if(0==s)return e.closestPoint(this.start);if(0==r)return this.closestPoint(e.start);const d=s*r-n*n;let h,c;return d<.001?(h=0,c=n>r?l/n:o/r):(h=(n*o-r*l)/d,c=(s*o-n*l)/d),[h,c]}intersectRayPlane(e){const t=this.start.subtract(e.start),i=e.dir.dot(this.dir),a=-e.dir.dot(t);if(Math.abs(i)<Number.PRECISION)return-1;const s=a/i;return s<-Number.PRECISION?-1:s}clone(){return new I(this.start.clone(),this.dir.clone())}static create(...e){return new I(...e)}toJSON(){return{start:this.start,dir:this.dir}}fromJSON(e){this.start.fromJSON(e.start),this.dir.fromJSON(e.dir)}toString(){return h(this.toJSON())}}u.registerType("Ray",I),new g(1,1,1);class R{constructor(e,t,i){if(e instanceof Float32Array)this.setFromFloat32Array(e);else{if(e instanceof g)this.tr=e;else{if(e instanceof V&&null==t&&null==i)return this.tr=new g,this.ori=e,void(this.sc=new g(1,1,1));this.tr=new g}this.ori=t instanceof V?t:new V,this.sc=i instanceof g?i:new g(1,1,1)}}set(e,t,i){this.tr=e,this.ori=t,i instanceof g&&(this.sc=i)}setFromOther(e){this.tr=e.tr,this.ori=e.ori,this.sc=e.sc}isIdentity(){return this.tr.isNull()&&this.ori.isIdentity()&&this.sc.is111()}setLookAt(e,t,i){const a=e.subtract(t);if(a.length()<Number.EPSILON)throw new Error("Invalid dir");this.ori.setFromDirectionAndUpvector(a,i),this.tr=e}multiply(e){let t=this.sc;return this.sc.x==this.sc.y&&this.sc.x==this.sc.z||(t=e.ori.rotateVec3(this.sc),Math.sign(t.x)!=Math.sign(this.sc.x)&&(t.x=-t.x),Math.sign(t.y)!=Math.sign(this.sc.y)&&(t.y=-t.y),Math.sign(t.z)!=Math.sign(this.sc.z)&&(t.z=-t.z)),new R(this.tr.add(this.ori.rotateVec3(t.multiply(e.tr))),this.ori.multiply(e.ori),t.multiply(e.sc))}inverse(){const e=new R;return e.ori=this.ori.inverse(),this.sc.x!=this.sc.y||this.sc.x!=this.sc.z?(e.sc=e.ori.rotateVec3(this.sc),Math.sign(e.sc.x)!=Math.sign(this.sc.x)&&(e.sc.x=-e.sc.x),Math.sign(e.sc.y)!=Math.sign(this.sc.y)&&(e.sc.y=-e.sc.y),Math.sign(e.sc.z)!=Math.sign(this.sc.z)&&(e.sc.z=-e.sc.z)):e.sc=this.sc.inverse(),e.tr=e.ori.rotateVec3(this.tr.negate().multiply(e.sc)),e}transformVec3(e){return this.tr.add(this.ori.rotateVec3(this.sc.multiply(e)))}toMat4(){const e=new X(this.sc.x,0,0,0,0,this.sc.y,0,0,0,0,this.sc.z,0,0,0,0,1),t=this.ori.toMat4(),i=new X;return i.translation=this.tr,i.multiply(t).multiply(e)}fromMat4(e){this.tr=e.translation,this.ori.setFromMat4(e)}setFromFloat32Array(e){if(7==e.length)return this.tr=new g(e.buffer,e.byteOffset),this.ori=new V(e.buffer,e.byteOffset+12),void(this.sc=new g(1,1,1));if(8!=e.length)return 10==e.length?(this.tr=new g(e.buffer,e.byteOffset),this.ori=new V(e.buffer,e.byteOffset+12),void(this.sc=new g(e.buffer,e.byteOffset+21))):void 0;{this.tr=new g(e.buffer,e.byteOffset),this.ori=new V(e.buffer,e.byteOffset+12);const t=e[7];this.sc=new g(t,t,t)}}clone(){return new R(this.tr.clone(),this.ori.clone(),this.sc.clone())}static create(...e){return new R(...e)}toJSON(){const e={tr:this.tr.toJSON(),ori:this.ori.toJSON()};return this.sc.is111()||(e.sc=this.sc.toJSON()),e}fromJSON(e){this.tr.fromJSON(e.tr),this.ori.fromJSON(e.ori),e.sc&&this.sc.fromJSON(e.sc)}toString(){return h(this.toJSON())}}u.registerType("Xfo",R);class x{constructor(e,t){this.p0=e instanceof p?e:new p(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof p?t:new p(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}set(e,t){this.p0=e,this.p1=t}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY}addPoint(e){(this.p0.x==Number.POSITIVE_INFINITY||e.x<this.p0.x)&&(this.p0.x=e.x),(this.p0.y==Number.POSITIVE_INFINITY||e.y<this.p0.y)&&(this.p0.y=e.y),(this.p1.y==Number.NEGATIVE_INFINITY||e.x>this.p1.x)&&(this.p1.x=e.x),(this.p1.y==Number.NEGATIVE_INFINITY||e.y>this.p1.y)&&(this.p1.y=e.y)}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}static create(...e){return new x(...e)}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}toString(){return h(this.toJSON())}}u.registerType("Box2",x);class S extends m{constructor(e,t=0){super(),this.pos=e instanceof g?e:new g,this.radius=t}clone(){return new Sphere(this.pos.clone(),this.radius)}intersectsBox(e){return e.intersectsSphere(this)}static create(...e){return new Sphere(...e)}toJSON(){return{pos:this.pos.toJSON(),radius:this.radius}}toString(){return h(this.toJSON())}}u.registerType("SphereType",S);class W{constructor(e,t){e instanceof Float32Array?this.setFromFloat32Array(e):(this.p0=e instanceof g?e:new g(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof g?t:new g(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))}get min(){return this.p0}get max(){return this.p1}set(e,t){this.p0=e,this.p1=t}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY,this.p0.z=Number.POSITIVE_INFINITY,this.p1.z=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY&&this.p0.z!=Number.POSITIVE_INFINITY&&this.p1.z!=Number.NEGATIVE_INFINITY}addPoint(e){e.x!=Number.POSITIVE_INFINITY&&e.x!=Number.NEGATIVE_INFINITY&&(e.x<this.p0.x&&(this.p0.x=e.x),e.x>this.p1.x&&(this.p1.x=e.x)),e.y!=Number.POSITIVE_INFINITY&&e.y!=Number.NEGATIVE_INFINITY&&(e.y<this.p0.y&&(this.p0.y=e.y),e.y>this.p1.y&&(this.p1.y=e.y)),e.z!=Number.POSITIVE_INFINITY&&e.z!=Number.NEGATIVE_INFINITY&&(e.z<this.p0.z&&(this.p0.z=e.z),e.z>this.p1.z&&(this.p1.z=e.z))}addBox3(e,t){t?(this.addPoint(t.transformVec3(e.p0)),this.addPoint(t.transformVec3(new g(e.p0.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new g(e.p0.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(new g(e.p1.x,e.p0.y,e.p0.z))),this.addPoint(t.transformVec3(new g(e.p0.x,e.p1.y,e.p1.z))),this.addPoint(t.transformVec3(new g(e.p1.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new g(e.p1.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(e.p1))):(this.addPoint(e.p0),this.addPoint(e.p1))}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}toMat4(){const e=this.p1.x-this.p0.x,t=this.p1.y-this.p0.y,i=this.p1.z-this.p0.z;return new X(e,0,0,0,0,t,0,0,0,0,i,0,this.p0.x,this.p0.y,this.p0.z,1)}getBoundingSphere(){return new S(this.center(),.5*this.diagonal().length())}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return closestPoint.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}clone(){return new W(this.p0.clone(),this.p1.clone())}static create(...e){return new W(...e)}static sizeInBytes(){return 24}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}fromJSON(e){this.p0.fromJSON(e.p0),this.p1.fromJSON(e.p1)}loadBin(e,t){this.p0.loadBin(e,t),this.p0.loadBin(e,t+12)}setFromFloat32Array(e){this.p0=new g(e.buffer,e.byteOffset),this.p1=new g(e.buffer,e.byteOffset+12)}toString(){return h(this.toJSON())}}u.registerType("Box3",W);class L extends m{constructor(e,t=0){super(),this.normal=e instanceof g?e:new g,this.w=t}set(e,t,i,a){this.normal.set(e,t,i),this.w=a}divideScalar(e){this.normal.scaleInPlace(1/e),this.w/=e}distanceToPoint(e){return e.dot(this.normal)+this.w}normalizeInPlace(){const e=1/this.normal.length();this.normal.scaleInPlace(e),this.w*=e}clone(){return new Plane(this.normal.clone(),this.w)}static create(...e){return new Plane(...e)}toJSON(){return{normal:this.normal.toJSON(),w:this.w}}toString(){return h(this.toJSON())}}u.registerType("PlaneType",L);class v{constructor(e,t,i,a,s,n){this.planes=[e||new L,t||new L,i||new L,a||new L,s||new L,n||new L]}setFromMatrix(e){const t=e,i=this.planes;i[0].set(t.m03-t.m00,t.m13-t.m10,t.m23-t.m20,t.m33-t.m30),i[1].set(t.m03+t.m00,t.m13+t.m10,t.m23+t.m20,t.m33+t.m30),i[2].set(t.m03+t.m01,t.m13+t.m11,t.m23+t.m21,t.m33+t.m31),i[3].set(t.m03-t.m01,t.m13-t.m11,t.m23-t.m21,t.m33-t.m31),i[4].set(t.m03-t.m02,t.m13-t.m12,t.m23-t.m22,t.m33-t.m32),i[5].set(t.m03+t.m02,t.m13+t.m12,t.m23+t.m22,t.m33+t.m32),i.forEach(e=>e.normalizeInPlace())}intersectsBox(e){const t=new g,i=this.planes,{min:a,max:s}=e;for(let e=0;e<6;e++){const n=i[e];if(t.x=n.normal.x>0?s.x:a.x,t.y=n.normal.y>0?s.y:a.y,t.z=n.normal.z>0?s.z:a.z,n.distanceToPoint(t)<0)return!1}return!0}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON(),p2:this.p2.toJSON(),p3:this.p3.toJSON(),p4:this.p4.toJSON(),p5:this.p5.toJSON()}}fromJSON(e){this.p0.fromJSON(e.p0),this.p1.fromJSON(e.p1),this.p2.fromJSON(e.p2),this.p3.fromJSON(e.p3),this.p4.fromJSON(e.p4),this.p5.fromJSON(e.p5)}toString(){return h(this.toJSON())}}u.registerType("Frustum",v);var T=Object.freeze({__proto__:null,UInt8:0,SInt8:1,SInt16:3,UInt16:2,SInt32:5,UInt32:4,Float32:6,hashStr:d,JSON_stringify_fixedPrecision:h,AttrValue:m,Vec2:p,Vec3:g,Vec4:_,RGBA:f,Color:Z,EulerAngles:G,Quat:V,Ray:I,Mat3:y,Mat4:X,Xfo:R,Box2:x,Box3:W,Frustum:v,PlaneType:L,SphereType:S,typeRegistry:u});class M{constructor(e=!1){this.__slots=[],this.__toggledSignal=e,this.__toggled=!1,this.__data=null,this.connect=this.connect.bind(this),this.disconnect=this.disconnect.bind(this),this.emit=this.emit.bind(this)}connect(e){if(null==e)throw new Error("a function callback must be passed to Signal.connect");if(-1!=this.__slots.indexOf(e))return void console.warn("fn '"+e.name+"' already connected to Signal.");const t=this.__slots.length;return this.__slots[t]=e,this.__toggledSignal&&this.__toggled&&(this.__data?e(...this.__data):e()),t}disconnect(e){if(null==e)throw new Error("a function callback must be passed to Signal.disconnect");const t=[];if(this.__slots.forEach((function(i,a){i===e&&t.push(a)})),0!=t.length)for(const e of t)this.__slots[e]=void 0;else console.warn("callback :"+e.name+" was not connected to this signal:"+this.__name)}disconnectId(e){if(!this.__slots[e])throw new Error("Invalid ID");this.__slots[e]=void 0}emit(...e){this.__toggledSignal&&(this.__toggled?console.warn("Toggled signals should only be fired once, or untoggled before re-firing.."):(this.__toggled=!0,this.__data=e));const t=this.__slots.length;for(let i=0;i<t;i++){const t=this.__slots[i];t&&t(...e)}}isToggled(){return this.__toggled}setToggled(e){this.__toggled=e,this.__data=void 0}getNumConnections(){return this.__slots.length}untoggle(){this.__toggled=!1,this.__data=void 0}}class C{constructor(e=0,t=0){this.root={x:0,y:0,w:e,h:t},this.resized=new M}fit(e){if(0==e.length)return;let t=!1;this.root.w<e[0].w&&(this.root.w=e[0].w,t=!0),this.root.h<e[0].h&&(this.root.h=e[0].h,t=!0),t&&this.resized.emit(this.root.w,this.root.h),e.forEach(e=>{e.fit=this.__addBlock(e)})}__addBlock(e){const t=this.findNode(this.root,e.w,e.h);return t?this.splitNode(t,e.w,e.h):this.growNode(e.w,e.h)}addBlock(e){let t=!1;this.root.w<e.w&&(this.root.w=e.w,t=!0),this.root.h<e.h&&(this.root.h=e.h,t=!0),t&&this.resized.emit(this.root.w,this.root.h);const i=this.findNode(this.root,e.w,e.h);return i?this.splitNode(i,e.w,e.h):this.growNode(e.w,e.h)}findNode(e,t,i){return e.used?this.findNode(e.right,t,i)||this.findNode(e.down,t,i):t<=e.w&&i<=e.h?e:null}splitNode(e,t,i){return e.used=!0,e.down={x:e.x,y:e.y+i,w:e.w,h:e.h-i},e.right={x:e.x+t,y:e.y,w:e.w-t,h:i},e}growNode(e,t){const i=e<=this.root.w,a=t<=this.root.h,s=a&&this.root.h>=this.root.w+e,n=i&&this.root.w>=this.root.h+t;return s?this.growRight(e,t):n?this.growDown(e,t):a?this.growRight(e,t):i?this.growDown(e,t):null}growRight(e,t){this.root={used:!0,x:0,y:0,w:this.root.w+e,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:e,h:this.root.h}};const i=this.findNode(this.root,e,t);let a;return i&&(a=this.splitNode(i,e,t)),this.resized.emit(this.root.w,this.root.h),a}growDown(e,t){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+t,down:{x:0,y:this.root.h,w:this.root.w,h:t},right:this.root};const i=this.findNode(this.root,e,t);let a;return i&&(a=this.splitNode(i,e,t)),this.resized.emit(this.root.w,this.root.h),a}}class F{constructor(e=0){this.__asyncCount=e,this.ready=new M(!0),this.incAsyncCount=function(e=1){this.__asyncCount+=e,this.ready.setToggled(!1)}.bind(this),this.decAsyncCount=function(){this.__asyncCount>0&&(this.__asyncCount--,0==this.__asyncCount&&this.__asyncsCompleted())}.bind(this),this.__asyncsCompleted=function(){this.ready.emit()}.bind(this)}get count(){return this.__asyncCount}}const w=e=>{if(window.TextDecoder)return new TextDecoder("utf-8").decode(e);{let t="";for(let i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t}};var N=Object.freeze({__proto__:null,GrowingPacker:C,Async:F,Signal:M,decodeText:w});let Y=0;class K{constructor(){if("RefCounted"==this.constructor.name)throw new Error("RefCounted should not be instantiated directly.");this.__id=++Y,this.__refs=[],this.destructing=new M,this.__destroyed=!1}getId(){return this.__id}numRefs(){return this.__refs.length}addRef(e){if(!e)throw new Error("Error in RefCounted.addRef: Must provide a referer");return this.__refs.push(e),!0}removeRef(e){if(!e)throw new Error("Error in RefCounted.removeRef: Must provide a referer");const t=this.__refs.indexOf(e);if(-1==t)throw new Error("Error in RefCounted.removeRef: referer not found in refs list.");this.__refs.splice(t,1),0==this.__refs.length&&this.destroy()}getRefer(e){return this.__refs[e]}getRefIndex(e){return this.__refs.indexOf(e)}isDestroyed(){return this.__destroyed}destroy(){this.__destroyed=!0,this.destructing.emit(this)}}const z=new class{constructor(){this.__registeredClasses={},this.__classNames={},this.__classList=[]}registerClass(e,t){this.__registeredClasses[e]={cls:t,callbacks:[]};const i=this.__classList.length;this.__classList.push(t),this.__classNames[i]=e}getClass(e){if(this.__registeredClasses[e])return this.__registeredClasses[e].cls}getClassName(e){const t=this.__classList.indexOf(e.constructor);return this.__classNames[t]?this.__classNames[t]:(console.warn("Class not registered:",e.constructor.name),e.constructor.name)}constructClass(e){const t=this.__registeredClasses[e];if(!t)return console.warn("Factory not registered:"+e),null;this.__constructing=!0;const i=Array.prototype.slice.call(arguments,1),a=new t.cls(...i);return this.__constructing=!1,a}},U={NORMAL:0,OPERATOR_GETVALUE:1},P={USER_SETVALUE:0,REMOTEUSER_SETVALUE:1,USER_SETVALUE_DONE:2,OPERATOR_SETVALUE:3,OPERATOR_DIRTIED:4,COMPUTED_VALUE:4,GENERATED_VALUE:4,DATA_LOAD:4},E={USER_EDITED:2,DISABLED:4};class J{constructor(e){this.__name=e,this.__cleanerFns=[],this.__boundOps=[],this.__state=0,this.__flags=0,this.valueChanged=new M,this.nameChanged=new M,this.getName=this.getName.bind(this),this.setName=this.setName.bind(this),this.getValue=this.getValue.bind(this),this.setValue=this.setValue.bind(this)}getName(){return this.__name}setName(e){if(e!=this.__name){const t=this.__name;this.__name=e,this.nameChanged.emit(this.__name,t)}}getOwner(){return this.ownerItem}addOwner(e){this.ownerItem=e}getPath(){const e=this.getOwner();if(e&&e.getName){if(e.getPath){const t=e.getPath().slice();return t.push(this.__name),t}return[e.getName(),this.__name]}return[this.__name]}setFlag(e){this.__flags|=e}clearFlag(e){this.__flags&=~e}testFlag(e){return 0!=(this.__flags&e)}getValue(){}setValue(e){}setEnabled(e){console.warn("Deprecated Method: This method will be removed soon."),e?this.setFlag(E.DISABLED):this.clearFlag(E.DISABLED)}isEnabled(){console.warn("Deprecated Method: This method will be removed soon."),this.testFlag(E.DISABLED)}bindOperator(e){this.__boundOps.push(e),this.__state=1,this.valueChanged.emit(P.OPERATOR_DIRTIED)}unbindOperator(e){const t=this.__boundOps.indexOf(e);if(-1==t)return!1;this.__boundOps.splice(t,1),this.__state=1,this.valueChanged.emit(P.OPERATOR_DIRTIED)}setDirty(e){return-1==this.__cleanerFns.indexOf(e)&&(this.__cleanerFns.push(e),this.__state=1,this.valueChanged.emit(P.OPERATOR_DIRTIED),!0)}setDirtyFromOp(){return 0==this.__state&&(this.__state=1,this.valueChanged.emit(P.OPERATOR_DIRTIED)),!0}isDirty(){return 1==this.__state}_clean(){this.__state=2;const e=this.__cleanerFns;this.__cleanerFns=[];for(const t of e){const e=t(this.__value);null!=e&&(this.__value=e)}for(const e of this.__boundOps)e.evaluate();this.__state=0}removeCleanerFn(e){const t=this.__cleanerFns.indexOf(e);if(-1==t)return 0;this.__cleanerFns.splice(t,1)}clone(e){console.error("TOOD: implment me")}destroy(){}}class H extends J{constructor(e,t,i){super(e),this.__value=t,this.__dataType=i||t.constructor.name}getDataType(){return this.__dataType}getValue(e=U.NORMAL){return 1==this.__state&&this._clean(),this.__value}setClean(e){this.__value=e}setValue(e,t=P.USER_SETVALUE){if(this.__cleanerFns.length>0&&(this.__cleanerFns=[]),null==e)throw"undefined was passed into the setvalue for param:"+this.getName();(e.fromJSON||this.__value!=e)&&(this.__value=e,t!=P.USER_SETVALUE&&t!=P.REMOTEUSER_SETVALUE||this.setFlag(E.USER_EDITED),t!=P.OPERATOR_SETVALUE&&this.valueChanged.emit(t))}setValueDone(){this.valueChanged.emit(P.USER_SETVALUE_DONE)}toJSON(e,t){return this.__value.toJSON?{value:this.__value.toJSON(e,t)}:{value:this.__value}}fromJSON(e,t,i){null!=e.value?(this.setFlag(E.USER_EDITED),e.value.type&&null==this.__value&&(this.__value=z.constructClass(e.value.type)),null!=this.__value&&this.__value.fromJSON?(this.__value.fromJSON(e.value,t),this.valueChanged.emit(P.DATA_LOAD)):this.setValue(e.value,P.DATA_LOAD)):console.warn("Invalid Parameter JSON")}readBinary(e,t){console.error("TODO")}clone(e){const t=this.__value;return t.clone&&(t=t.clone()),new H(this.__name,t,this.__dataType)}}let k=0;class B{constructor(){this.__id=++k,this.__params=[],this.__paramMapping={},this.__paramSignalIds={},this.parameterAdded=new M,this.parameterRemoved=new M,this.parameterValueChanged=new M}getId(){return this.__id}numParameters(){return this.__params.length}getParameters(){return this.__params}getParameterIndex(e){return this.__paramMapping[e]}getParameterByIndex(e){return this.__params[e]}hasParameter(e){return e in this.__paramMapping}getParameter(e){const t=this.__paramMapping[e];return-1==t?null:this.__params[t]}__parameterValueChanged(e,t){this.parameterValueChanged.emit(e,t)}addParameter(e){const t=e.getName();return null!=this.__paramMapping[t]&&(console.warn("Replacing Parameter:"+t),this.removeParameter(t)),this.__paramSignalIds[t]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params.push(e),this.__paramMapping[t]=this.__params.length-1,this.parameterAdded.emit(t),e}insertParameter(e,t){const i=e.getName();null!=this.__paramMapping[i]&&(console.warn("Replacing Parameter:"+i),this.removeParameter(i)),this.__paramSignalIds[i]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params.splice(t,0,e);const a={};for(let e=0;e<this.__params.length;e++)a[this.__params[e].getName()]=e;return this.__paramMapping=a,this.parameterAdded.emit(i),e}removeParameter(e){null==this.__paramMapping[e]&&console.throw("Unable to Remove Parameter:"+e);const t=this.__paramMapping[e];this.__params[this.__paramMapping[e]].valueChanged.disconnectId(this.__paramSignalIds[e]),this.__params.splice(t,1);const i={};for(let e=0;e<this.__params.length;e++)i[this.__params[e].getName()]=e;this.__paramMapping=i,this.parameterRemoved.emit(e)}replaceParameter(e){const t=e.getName(),i=this.__paramMapping[t];return this.__params[this.__paramMapping[t]].valueChanged.disconnectId(this.__paramSignalIds[t]),this.__paramSignalIds[t]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params[i]=e,e}toJSON(e,t){const i={};let a=0;for(const s of this.__params)if(s.testFlag(E.USER_EDITED))if(s.numRefs()>1&&0!=s.getRefIndex(this))i[s.getName()]={paramPath:e.makeRelative(s.getPath())},a++;else{const n=s.toJSON(e,t);n&&(i[s.getName()]=n,a++)}if(a>0)return{params:i}}fromJSON(e,t,i){if(e.params)for(const i in e.params){const a=e.params[i],s=this.getParameter(i);s?a.paramPath?t.resolvePath(a.paramPath,e=>{this.replaceParameter(e)},e=>{console.warn("Unable to resolve shared parameter:"+a.paramPath)}):s.fromJSON(a,t):console.warn("Param not found:"+i)}}readBinary(e,t){if(t.versions["zea-engine"].greaterOrEqualThan([0,0,3])){const i=e.loadUInt32();for(let a=0;a<i;a++){const i=e.loadStr(),a=e.loadStr();let s=this.getParameter(a);if(!s){if(s=z.constructClass(i,a),!s){console.error("Unable to construct prop:"+a+" of type:"+i);continue}this.addParameter(s)}s.readBinary(e,t)}}}toString(){return JSON.stringify(this.toJSON(),null,2)}copyFrom(e,t){let i=e.numParameters();for(;i--;){const t=e.getParameterByIndex(i),a=this.getParameter(t.getName());a?a.setValue(t.getValue(),P.OPERATOR_SETVALUE):this.addParameter(t.clone())}}destroy(){for(const e of this.__params)e.destroy();super.destroy()}}const D={USER_EDITED:2,IGNORE_BBOX:4,BIN_NODE:8,INVISIBLE:16};let O=0;class A extends B{constructor(e){super(),this.__name=e||"",this.__path=[this.__name],this.__ownerItem=void 0,this.__flags=0,this.__selectable=!0,this.__selected=!1,this.selectedChanged=new M,this.__metaData={},this.nameChanged=new M,O++}static getNumBaseItems(){return O}__parameterValueChanged(e,t){super.__parameterValueChanged(e,t),t!=P.USER_SETVALUE&&t!=P.REMOTEUSER_SETVALUE||this.setFlag(D.USER_EDITED)}getName(){return this.__name}setName(e,t=P.USER_SETVALUE){if(this.__name!=e){const i=this.__name;this.__name=e,this.__updatePath(),this.nameChanged.emit(e,i,t)}}__updatePath(){null==this.__ownerItem?this.__path=[this.__name]:(this.__path=this.__ownerItem.getPath().slice(),this.__path.push(this.__name))}getPath(){return this.__path}setFlag(e){this.__flags|=e}clearFlag(e){this.__flags&=~e}testFlag(e){return 0!=(this.__flags&e)}resolvePath(e,t){if(t==e.length)return this;if(">"==e[t]&&t==e.length-1)return this.getParameter(e[t+1]);const i=this.getParameter(e[t]);if(i)return i;throw new Error("Invalid path:"+e+" member not found")}getOwner(){return this.__ownerItem}setOwner(e){this.__ownerItem!==e&&(this.__ownerItem=e,this.__updatePath())}getSelectable(){return this.__selectable}setSelectable(e){return this.__selectable!=e&&(this.__selectable=e,!0)}isSelected(){return this.__selected}getSelected(){return this.__selected}setSelected(e){this.__selected=e,this.selectedChanged.emit(this.__selected)}getMetadata(e){return this.__metaData[e]}hasMetadata(e){return e in this.__metaData}setMetadata(e,t){this.__metaData[e]=t}deleteMetadata(e){delete this.__metaData[e]}toJSON(e,t){let i=super.toJSON(e,t);return!i&&this.testFlag(D.USER_EDITED)&&(i={}),i&&(i.name=this.__name,this.testFlag(D.BIN_NODE)||(i.type=z.getClassName(this))),i}fromJSON(e,t,i){e.name&&(this.__name=e.name),super.fromJSON(e,t,i),this.__flags|=D.USER_EDITED}readBinary(e,t){e.loadStr(),this.setName(e.loadStr()),super.readBinary(e,t)}clone(e){throw new Error(this.constructor.name+" does not implment its clone method")}copyFrom(e,t){super.copyFrom(e,t),this.setName(e.getName())}destroy(){super.destroy()}}const Q=function(e,t,i,a,s){const n=new XMLHttpRequest;n.responseType=t;try{n.addEventListener("timeout",(function(t){throw new Error("The request for "+e+" timed out.")})),n.addEventListener("error",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+n.readyState)})),n.addEventListener("abort",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+n.readyState)})),n.addEventListener("loadend",(function(e){200==n.status?i(n):a(n.statusText)})),n.open("GET",e,!0),n.send()}catch(e){a(e)}},q=function(e,t,i,a){Q(e,"text",e=>{t(e.responseText)},t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)})},$=function(e,t,i,a){Q(e,"arraybuffer",e=>{t(e.response)},t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)})},ee="[object process]"===Object.prototype.toString.call(void 0!==e?e:0),te=ee&&"function"==typeof a.require?a.require:null;function ie(e,t=null,i=!1){const a=ee?function(e,t){return s.from(e,"base64").toString(t?"utf16":"utf8")}(e,i):function(e,t){const i=atob(e);if(t){const e=new Uint8Array(i.length);return Array.prototype.forEach.call(e,(e,t,a)=>{a[t]=i.charCodeAt(t)}),String.fromCharCode.apply(null,new Uint16Array(e.buffer))}return i}(e,i),n=a.indexOf("\n",10)+1,r=a.substring(n)+(t?"//# sourceMappingURL="+t:"");if(te){const e=te("worker_threads").Worker;return function(t){return new e(r,Object.assign({},t,{eval:!0}))}}const l=new Blob([r],{type:"application/javascript"}),o=URL.createObjectURL(l);return function(e){return new Worker(o,e)}}var ae=ie("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpNb2R1bGU9e0VOVklST05NRU5UOiJXT1JLRVIifTtjb25zdCBlPXt9O3ZhciB0Oyh0PWUpLnVucGFja0JyaWRnZT1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7dmFyIHQ9e307ZnVuY3Rpb24gcihuKXtpZih0W25dKXJldHVybiB0W25dLmV4cG9ydHM7dmFyIG89dFtuXT17aTpuLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbbl0uY2FsbChvLmV4cG9ydHMsbyxvLmV4cG9ydHMsciksby5sPSEwLG8uZXhwb3J0c31yZXR1cm4gci5tPWUsci5jPXQsci5kPWZ1bmN0aW9uKGUsdCxuKXtyLm8oZSx0KXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7ZW51bWVyYWJsZTohMCxnZXQ6bn0pfSxyLnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sci50PWZ1bmN0aW9uKGUsdCl7aWYoMSZ0JiYoZT1yKGUpKSw4JnQpcmV0dXJuIGU7aWYoNCZ0JiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbj1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHIucihuKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobiwiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImdCYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgbyBpbiBlKXIuZChuLG8sZnVuY3Rpb24odCl7cmV0dXJuIGVbdF19LmJpbmQobnVsbCxvKSk7cmV0dXJuIG59LHIubj1mdW5jdGlvbihlKXt2YXIgdD1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gci5kKHQsImEiLHQpLHR9LHIubz1mdW5jdGlvbihlLHQpe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSx0KX0sci5wPSIiLHIoci5zPTIpfShbZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBvPXIoMSksaT17MDoiRVJBUl9TVUNDRVNTIiwxMDoiRVJBUl9FTkRfQVJDSElWRSIsMTE6IkVSQVJfTk9fTUVNT1JZIiwxMjoiRVJBUl9CQURfREFUQSIsMTM6IkVSQVJfQkFEX0FSQ0hJVkUiLDE0OiJFUkFSX1VOS05PV05fRk9STUFUIiwxNToiRVJBUl9FT1BFTiIsMTY6IkVSQVJfRUNSRUFURSIsMTc6IkVSQVJfRUNMT1NFIiwxODoiRVJBUl9FUkVBRCIsMTk6IkVSQVJfRVdSSVRFIiwyMDoiRVJBUl9TTUFMTF9CVUYiLDIxOiJFUkFSX1VOS05PV04iLDIyOiJFUkFSX01JU1NJTkdfUEFTU1dPUkQiLDIzOiJFUkFSX0VSRUZFUkVOQ0UiLDI0OiJFUkFSX0JBRF9QQVNTV09SRCJ9LGE9ezA6IlN1Y2Nlc3MiLDExOiJOb3QgZW5vdWdoIG1lbW9yeSIsMTI6IkFyY2hpdmUgaGVhZGVyIG9yIGRhdGEgYXJlIGRhbWFnZWQiLDEzOiJGaWxlIGlzIG5vdCBSQVIgYXJjaGl2ZSIsMTQ6IlVua25vd24gYXJjaGl2ZSBmb3JtYXQiLDE1OiJGaWxlIG9wZW4gZXJyb3IiLDE2OiJGaWxlIGNyZWF0ZSBlcnJvciIsMTc6IkZpbGUgY2xvc2UgZXJyb3IiLDE4OiJGaWxlIHJlYWQgZXJyb3IiLDE5OiJGaWxlIHdyaXRlIGVycm9yIiwyMDoiQnVmZmVyIGZvciBhcmNoaXZlIGNvbW1lbnQgaXMgdG9vIHNtYWxsLCBjb21tZW50IHRydW5jYXRlZCIsMjE6IlVua25vd24gZXJyb3IiLDIyOiJQYXNzd29yZCBmb3IgZW5jcnlwdGVkIGZpbGUgb3IgaGVhZGVyIGlzIG5vdCBzcGVjaWZpZWQiLDIzOiJDYW5ub3Qgb3BlbiBmaWxlIHNvdXJjZSBmb3IgcmVmZXJlbmNlIHJlY29yZCIsMjQ6Ildyb25nIHBhc3N3b3JkIGlzIHNwZWNpZmllZCJ9O2NsYXNzIHN7Y29uc3RydWN0b3IoZT0iIil7dGhpcy5fcGFzc3dvcmQ9ZSx0aGlzLl9hcmNoaXZlPW51bGx9Z2V0RmlsZUxpc3QoKXtsZXQgZSxbdCxyXT10aGlzLm9wZW5BcmMoITApO2lmKCJTVUNDRVNTIiE9PXQuc3RhdGUpZT1bdCxudWxsXTtlbHNle2xldCB0LG4sbz1bXTtmb3IoO1t0LG5dPXRoaXMucHJvY2Vzc05leHRGaWxlKCgpPT4hMCksIlNVQ0NFU1MiPT09dC5zdGF0ZTspby5wdXNoKG4uZmlsZUhlYWRlcik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVIZWFkZXJzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEFsbCgpe2xldCBlLFt0LHJdPXRoaXMub3BlbkFyYyghMSk7aWYoIlNVQ0NFU1MiIT09dC5zdGF0ZSllPVt0LG51bGxdO2Vsc2V7bGV0IHQsbixvPVtdO2Zvcig7W3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoKCk9PiExKSwiU1VDQ0VTUyI9PT10LnN0YXRlOylvLnB1c2gobik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEZpbGVzKGUsdCl7bGV0IHIsW24sb109dGhpcy5vcGVuQXJjKCExLHQpLGk9e307Zm9yKGxldCB0PTA7dDxlLmxlbmd0aDsrK3QpaVtlW3RdXT10O2lmKCJTVUNDRVNTIiE9PW4uc3RhdGUpcj1bbixudWxsXTtlbHNle2xldCB0LG4sYT1BcnJheShlLmxlbmd0aCkuZmlsbChudWxsKSxzPTA7Zm9yKDs7KXtsZXQgcj0hMSxvPW51bGw7aWYoW3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoZT0+ZSBpbiBpPyhvPWlbZV0sITEpOihyPSEwLCEwKSksIlNVQ0NFU1MiIT09dC5zdGF0ZSlicmVhaztpZighciYmKGFbb109biwrK3M9PT1lLmxlbmd0aCkpe3QucmVhc29uPSJFUkFSX0VORF9BUkNISVZFIjticmVha319cj0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpvLGZpbGVzOmF9XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLHJ9ZmlsZUNyZWF0ZWQoZSl7fWNsb3NlKGUpe3RoaXMuX2xhc3RGaWxlQ29udGVudD10aGlzLmNsb3NlRmlsZShlKX1vcGVuQXJjKGUsdCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmU9bmV3IG4uUmFyQXJjaGl2ZTtsZXQgcixpPXRoaXMuX2FyY2hpdmUub3Blbih0aGlzLl9maWxlUGF0aCx0fHx0aGlzLl9wYXNzd29yZCxlKTtyZXR1cm4gcj0wIT09aS5zdGF0ZS5lcnJDb2RlP1t0aGlzLmdldEZhaWxJbmZvKGkuc3RhdGUuZXJyQ29kZSxpLnN0YXRlLmVyclR5cGUpLG51bGxdOlt7c3RhdGU6IlNVQ0NFU1MifSx7Y29tbWVudDppLmNvbW1lbnQsZmxhZ3M6e3ZvbHVtZTowIT0oMSZpLmZsYWdzKSxsb2NrOjAhPSg0JmkuZmxhZ3MpLHNvbGlkOjAhPSg4JmkuZmxhZ3MpLGF1dGhJbmZvOjAhPSgzMiZpLmZsYWdzKSxyZWNvdmVyeVJlY29yZDowIT0oNjQmaS5mbGFncyksaGVhZGVyRW5jcnlwdGVkOjAhPSgxMjgmaS5mbGFncyl9fV0sby5FeHQuY3VycmVudD1udWxsLHJ9cHJvY2Vzc05leHRGaWxlKGUpe2xldCB0O28uRXh0LmN1cnJlbnQ9dGhpcztsZXQgcj10aGlzLl9hcmNoaXZlLmdldEZpbGVIZWFkZXIoKSxuPVt7c3RhdGU6IlNVQ0NFU1MifSxudWxsXTtpZigwPT09ci5zdGF0ZS5lcnJDb2RlKXtsZXQgdD1lKHIubmFtZSk7dGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGw7bGV0IG89dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSh0KTswPT09by5lcnJDb2RlfHx0fHwoblswXT10aGlzLmdldEZhaWxJbmZvKG8uZXJyQ29kZSxvLmVyclR5cGUpLDIyPT09by5lcnJDb2RlP289dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSghMCk6by5lcnJDb2RlPTApLDA9PT1vLmVyckNvZGU/blsxXT10aGlzLl9sYXN0RmlsZUNvbnRlbnQ6KHIuc3RhdGUuZXJyQ29kZT1vLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlPW8uZXJyVHlwZSksdGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGx9cmV0dXJuIHQ9MCE9PXIuc3RhdGUuZXJyQ29kZT9bdGhpcy5nZXRGYWlsSW5mbyhyLnN0YXRlLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlKSxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2ZpbGVIZWFkZXI6e25hbWU6ci5uYW1lLGZsYWdzOntlbmNyeXB0ZWQ6MCE9KDQmci5mbGFncyksc29saWQ6MCE9KDE2JnIuZmxhZ3MpLGRpcmVjdG9yeTowIT0oMzImci5mbGFncyl9LHBhY2tTaXplOnIucGFja1NpemUsdW5wU2l6ZTpyLnVucFNpemUsY3JjOnIuY3JjLHRpbWU6ZnVuY3Rpb24oZSl7Y29uc3QgdD1bNSw2LDUsNSw0LDddO2xldCByPVtdO2ZvcihsZXQgbiBvZiB0KXIucHVzaChlJigxPDxuKS0xKSxlPj49bjtsZXQgbj1lPT5lPDEwPyIwIitlOiIiK2U7cmV0dXJuYCR7MTk4MCsocj1yLnJldmVyc2UoKSlbMF19LSR7bihyWzFdKX0tJHtuKHJbMl0pfVQke24oclszXSl9OiR7bihyWzRdKX06JHtuKDIqcls1XSl9LjAwMGB9KHIudGltZSksdW5wVmVyOmAke01hdGguZmxvb3Ioci51bnBWZXIvMTApfS4ke3IudW5wVmVyJTEwfWAsbWV0aG9kOmZ1bmN0aW9uKGUpe3JldHVybns0ODoiU3RvcmluZyIsNDk6IkZhc3Rlc3QiLDUwOiJGYXN0Iiw1MToiTm9ybWFsIiw1MjoiR29vZCIsNTM6IkJlc3QifVtlXXx8IlVua25vd24ifShyLm1ldGhvZCl9LGV4dHJhY3Q6bn1dLG8uRXh0LmN1cnJlbnQ9bnVsbCx0fWNsb3NlQXJjKCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmUuZGVsZXRlKCksby5FeHQuY3VycmVudD1udWxsLHRoaXMuX2FyY2hpdmU9bnVsbH1nZXRGYWlsSW5mbyhlLHQpe3JldHVybntzdGF0ZToiRkFJTCIscmVhc29uOmlbZV0sbXNnOmFbZV19fX1zLl9jdXJyZW50PW51bGwsdC5FeHRyYWN0b3I9c30sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSx0LkV4dD17Y3VycmVudDpudWxsfX0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSxmdW5jdGlvbihlKXtmb3IodmFyIHIgaW4gZSl0Lmhhc093blByb3BlcnR5KHIpfHwodFtyXT1lW3JdKX0ocigzKSk7dmFyIG49cigxKTt0LkV4dD1uLkV4dH0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBuPXIoNCksbz1yKDYpO3QuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGE9ZnVuY3Rpb24oZSx0PSIiKXtyZXR1cm4gbmV3IG4uRGF0YUV4dHJhY3RvcihlLHQpfSx0LmNyZWF0ZUV4dHJhY3RvckZyb21GaWxlPWZ1bmN0aW9uKGUsdD0iIixyPSIiKXtyZXR1cm4gbmV3IG8uRmlsZUV4dHJhY3RvcihlLHQscil9fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cig1KSxpPXIoMCk7dC5EYXRhRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgaS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0KXtzdXBlcih0KSx0aGlzLmRhdGFGaWxlcz17fSx0aGlzLmRhdGFGaWxlTWFwPXt9LHRoaXMuY3VycmVudEZkPTE7bGV0IHI9e2ZpbGU6bmV3IG8uRGF0YUZpbGUobmV3IFVpbnQ4QXJyYXkoZSkpLGZkOnRoaXMuY3VycmVudEZkKyt9O3RoaXMuX2ZpbGVQYXRoPSJfZGVmYXVsdFVucmFySlNfLnJhciIsdGhpcy5kYXRhRmlsZXNbdGhpcy5fZmlsZVBhdGhdPXIsdGhpcy5kYXRhRmlsZU1hcFtyLmZkXT10aGlzLl9maWxlUGF0aH1vcGVuKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW2VdO3JldHVybiB0P3QuZmQ6MH1jcmVhdGUoZSl7bGV0IHQ9dGhpcy5jdXJyZW50RmQrKztyZXR1cm4gdGhpcy5kYXRhRmlsZXNbZV09e2ZpbGU6bmV3IG8uRGF0YUZpbGUsZmQ6dGhpcy5jdXJyZW50RmQrK30sdGhpcy5kYXRhRmlsZU1hcFt0XT1lLHR9Y2xvc2VGaWxlKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO2lmKCF0KXJldHVybiBudWxsO2xldCByPXQuZmlsZS5yZWFkQWxsKCk7cmV0dXJuIDEhPT1lPyhkZWxldGUgdGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV0sZGVsZXRlIHRoaXMuZGF0YUZpbGVNYXBbZV0pOnQuZmlsZS5zZWVrKDAsIlNFVCIpLHJ9cmVhZChlLHQscil7bGV0IG89dGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV07aWYoIW8pcmV0dXJuLTE7bGV0IGk9by5maWxlLnJlYWQocik7cmV0dXJuIG51bGw9PT1pPy0xOihuLkhFQVBVOC5zZXQoaSx0KSxpLmJ5dGVMZW5ndGgpfXdyaXRlKGUsdCxyKXtsZXQgbz10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4hIW8mJihvLmZpbGUud3JpdGUobi5IRUFQVTguc2xpY2UodCx0K3IpKSwhMCl9dGVsbChlKXtsZXQgdD10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4gdD90LmZpbGUudGVsbCgpOi0xfXNlZWsoZSx0LHIpe2xldCBuPXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO3JldHVybiEhbiYmbi5maWxlLnNlZWsodCxyKX19fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pLHQuRGF0YUZpbGU9Y2xhc3N7Y29uc3RydWN0b3IoZSl7dGhpcy5idWZmZXJzPVtdLHRoaXMucG9zPTAsdGhpcy5zaXplPTAsZSYmKHRoaXMuYnVmZmVycy5wdXNoKGUpLHRoaXMuc2l6ZT1lLmJ5dGVMZW5ndGgsdGhpcy5wb3M9MCl9cmVhZChlKXtpZih0aGlzLmZsYXR0ZW4oKSxlK3RoaXMucG9zPnRoaXMuc2l6ZSlyZXR1cm4gbnVsbDtsZXQgdD10aGlzLnBvcztyZXR1cm4gdGhpcy5wb3MrPWUsdGhpcy5idWZmZXJzWzBdLnNsaWNlKHQsdGhpcy5wb3MpfXJlYWRBbGwoKXtyZXR1cm4gdGhpcy5mbGF0dGVuKCksdGhpcy5idWZmZXJzWzBdfXdyaXRlKGUpe3JldHVybiB0aGlzLmJ1ZmZlcnMucHVzaChlKSx0aGlzLnNpemUrPWUuYnl0ZUxlbmd0aCx0aGlzLnBvcys9ZS5ieXRlTGVuZ3RoLCEwfXRlbGwoKXtyZXR1cm4gdGhpcy5wb3N9c2VlayhlLHQpe2xldCByPXRoaXMucG9zO3JldHVybiJTRVQiPT09dD9yPWU6IkNVUiI9PT10P3IrPWU6cj10aGlzLnNpemUtZSwhKHI8MHx8cj50aGlzLnNpemV8fCh0aGlzLnBvcz1yLDApKX1mbGF0dGVuKCl7aWYodGhpcy5idWZmZXJzLmxlbmd0aDw9MSlyZXR1cm47bGV0IGU9bmV3IFVpbnQ4QXJyYXkodGhpcy5zaXplKSx0PTA7Zm9yKGxldCByIG9mIHRoaXMuYnVmZmVycyllLnNldChyLHQpLHQrPXIuYnl0ZUxlbmd0aDt0aGlzLmJ1ZmZlcnM9W2VdfX19LGZ1bmN0aW9uKGUsdCxyKXsoZnVuY3Rpb24oZSl7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cigxMiksaT1yKDEzKSxhPXIoMCk7dC5GaWxlRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgYS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0LHIpe3N1cGVyKHIpLHRoaXMuX2ZpbGVQYXRoPWUsdGhpcy5maWxlTWFwPXt9LHRoaXMuX3RhcmdldD10fW9wZW4oZSl7bGV0IHQ9by5vcGVuU3luYyhlLCJyIik7cmV0dXJuIHRoaXMuZmlsZU1hcFt0XT17c2l6ZTpvLmZzdGF0U3luYyh0KS5zaXplLHBvczowLG5hbWU6ZX0sdH1jcmVhdGUoZSl7bGV0IHQ9aS5qb2luKHRoaXMuX3RhcmdldCxlKTtpLnBhcnNlKHQpLmRpci5zcGxpdCgiLyIpLnJlZHVjZSgoZSx0KT0+KGUrPXQrIi8iLG8uZXhpc3RzU3luYyhlKXx8by5ta2RpclN5bmMoZSksZSksIiIpO2xldCByPW8ub3BlblN5bmModCwidyIpO3JldHVybiB0aGlzLmZpbGVNYXBbcl09e3NpemU6MCxwb3M6MCxuYW1lOmV9LHJ9Y2xvc2VGaWxlKGUpe3JldHVybiBkZWxldGUgdGhpcy5maWxlTWFwW2VdLG8uY2xvc2VTeW5jKGUpLG51bGx9cmVhZCh0LHIsaSl7bGV0IGE9dGhpcy5maWxlTWFwW3RdLHM9bmV3IGUoaSksdT1vLnJlYWRTeW5jKHQscywwLGksYS5wb3MpO3JldHVybiBuLkhFQVBVOC5zZXQocyxyKSxhLnBvcys9dSx1fXdyaXRlKHQscixpKXtsZXQgYT10aGlzLmZpbGVNYXBbdF0scz1vLndyaXRlU3luYyh0LG5ldyBlKG4uSEVBUFU4LnN1YmFycmF5KHIscitpKSksMCxpKTtyZXR1cm4gYS5wb3MrPXMsYS5zaXplKz1zLHM9PT1pfXRlbGwoZSl7cmV0dXJuIHRoaXMuZmlsZU1hcFtlXS5wb3N9c2VlayhlLHQscil7bGV0IG49dGhpcy5maWxlTWFwW2VdLG89bi5wb3M7cmV0dXJuIlNFVCI9PT1yP289MDoiRU5EIj09PXImJihvPW4uc2l6ZSksISgobys9dCk8MHx8bz5uLnNpemV8fChuLnBvcz1vLDApKX19fSkuY2FsbCh0aGlzLHIoNykuQnVmZmVyKX0sZnVuY3Rpb24oZSx0LHIpeyhmdW5jdGlvbihlKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KdmFyIG49cig5KSxvPXIoMTApLGk9cigxMSk7ZnVuY3Rpb24gYSgpe3JldHVybiB1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/MjE0NzQ4MzY0NzoxMDczNzQxODIzfWZ1bmN0aW9uIHMoZSx0KXtpZihhKCk8dCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgiKTtyZXR1cm4gdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyhlPW5ldyBVaW50OEFycmF5KHQpKS5fX3Byb3RvX189dS5wcm90b3R5cGU6KG51bGw9PT1lJiYoZT1uZXcgdSh0KSksZS5sZW5ndGg9dCksZX1mdW5jdGlvbiB1KGUsdCxyKXtpZighKHUuVFlQRURfQVJSQVlfU1VQUE9SVHx8dGhpcyBpbnN0YW5jZW9mIHUpKXJldHVybiBuZXcgdShlLHQscik7aWYoIm51bWJlciI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQpdGhyb3cgbmV3IEVycm9yKCJJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZyIpO3JldHVybiBmKHRoaXMsZSl9cmV0dXJuIGModGhpcyxlLHQscil9ZnVuY3Rpb24gYyhlLHQscixuKXtpZigibnVtYmVyIj09dHlwZW9mIHQpdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpO3JldHVybiJ1bmRlZmluZWQiIT10eXBlb2YgQXJyYXlCdWZmZXImJnQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcj9mdW5jdGlvbihlLHQscixuKXtpZih0LmJ5dGVMZW5ndGgscjwwfHx0LmJ5dGVMZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ29mZnNldCcgaXMgb3V0IG9mIGJvdW5kcyIpO2lmKHQuYnl0ZUxlbmd0aDxyKyhufHwwKSl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ2xlbmd0aCcgaXMgb3V0IG9mIGJvdW5kcyIpO3JldHVybiB0PXZvaWQgMD09PXImJnZvaWQgMD09PW4/bmV3IFVpbnQ4QXJyYXkodCk6dm9pZCAwPT09bj9uZXcgVWludDhBcnJheSh0LHIpOm5ldyBVaW50OEFycmF5KHQscixuKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KGU9dCkuX19wcm90b19fPXUucHJvdG90eXBlOmU9ZChlLHQpLGV9KGUsdCxyLG4pOiJzdHJpbmciPT10eXBlb2YgdD9mdW5jdGlvbihlLHQscil7aWYoInN0cmluZyI9PXR5cGVvZiByJiYiIiE9PXJ8fChyPSJ1dGY4IiksIXUuaXNFbmNvZGluZyhyKSl0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKTt2YXIgbj0wfHAodCxyKSxvPShlPXMoZSxuKSkud3JpdGUodCxyKTtyZXR1cm4gbyE9PW4mJihlPWUuc2xpY2UoMCxvKSksZX0oZSx0LHIpOmZ1bmN0aW9uKGUsdCl7aWYodS5pc0J1ZmZlcih0KSl7dmFyIHI9MHxoKHQubGVuZ3RoKTtyZXR1cm4gMD09PShlPXMoZSxyKSkubGVuZ3RofHx0LmNvcHkoZSwwLDAsciksZX1pZih0KXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiZ0LmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyfHwibGVuZ3RoImluIHQpcmV0dXJuIm51bWJlciIhPXR5cGVvZiB0Lmxlbmd0aHx8ZnVuY3Rpb24oZSl7cmV0dXJuIGUhPWV9KHQubGVuZ3RoKT9zKGUsMCk6ZChlLHQpO2lmKCJCdWZmZXIiPT09dC50eXBlJiZpKHQuZGF0YSkpcmV0dXJuIGQoZSx0LmRhdGEpfXRocm93IG5ldyBUeXBlRXJyb3IoIkZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4iKX0oZSx0KX1mdW5jdGlvbiBsKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSl0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpO2lmKGU8MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJyl9ZnVuY3Rpb24gZihlLHQpe2lmKGwodCksZT1zKGUsdDwwPzA6MHxoKHQpKSwhdS5UWVBFRF9BUlJBWV9TVVBQT1JUKWZvcih2YXIgcj0wO3I8dDsrK3IpZVtyXT0wO3JldHVybiBlfWZ1bmN0aW9uIGQoZSx0KXt2YXIgcj10Lmxlbmd0aDwwPzA6MHxoKHQubGVuZ3RoKTtlPXMoZSxyKTtmb3IodmFyIG49MDtuPHI7bis9MSllW25dPTI1NSZ0W25dO3JldHVybiBlfWZ1bmN0aW9uIGgoZSl7aWYoZT49YSgpKXRocm93IG5ldyBSYW5nZUVycm9yKCJBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtIHNpemU6IDB4IithKCkudG9TdHJpbmcoMTYpKyIgYnl0ZXMiKTtyZXR1cm4gMHxlfWZ1bmN0aW9uIHAoZSx0KXtpZih1LmlzQnVmZmVyKGUpKXJldHVybiBlLmxlbmd0aDtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiYiZnVuY3Rpb24iPT10eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3JiYoQXJyYXlCdWZmZXIuaXNWaWV3KGUpfHxlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKXJldHVybiBlLmJ5dGVMZW5ndGg7InN0cmluZyIhPXR5cGVvZiBlJiYoZT0iIitlKTt2YXIgcj1lLmxlbmd0aDtpZigwPT09cilyZXR1cm4gMDtmb3IodmFyIG49ITE7Oylzd2l0Y2godCl7Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gcjtjYXNlInV0ZjgiOmNhc2UidXRmLTgiOmNhc2Ugdm9pZCAwOnJldHVybiBVKGUpLmxlbmd0aDtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIDIqcjtjYXNlImhleCI6cmV0dXJuIHI+Pj4xO2Nhc2UiYmFzZTY0IjpyZXR1cm4geihlKS5sZW5ndGg7ZGVmYXVsdDppZihuKXJldHVybiBVKGUpLmxlbmd0aDt0PSgiIit0KS50b0xvd2VyQ2FzZSgpLG49ITB9fWZ1bmN0aW9uIG0oZSx0LHIpe3ZhciBuPWVbdF07ZVt0XT1lW3JdLGVbcl09bn1mdW5jdGlvbiB5KGUsdCxyLG4sbyl7aWYoMD09PWUubGVuZ3RoKXJldHVybi0xO2lmKCJzdHJpbmciPT10eXBlb2Ygcj8obj1yLHI9MCk6cj4yMTQ3NDgzNjQ3P3I9MjE0NzQ4MzY0NzpyPC0yMTQ3NDgzNjQ4JiYocj0tMjE0NzQ4MzY0OCkscj0rcixpc05hTihyKSYmKHI9bz8wOmUubGVuZ3RoLTEpLHI8MCYmKHI9ZS5sZW5ndGgrcikscj49ZS5sZW5ndGgpe2lmKG8pcmV0dXJuLTE7cj1lLmxlbmd0aC0xfWVsc2UgaWYocjwwKXtpZighbylyZXR1cm4tMTtyPTB9aWYoInN0cmluZyI9PXR5cGVvZiB0JiYodD11LmZyb20odCxuKSksdS5pc0J1ZmZlcih0KSlyZXR1cm4gMD09PXQubGVuZ3RoPy0xOkUoZSx0LHIsbixvKTtpZigibnVtYmVyIj09dHlwZW9mIHQpcmV0dXJuIHQmPTI1NSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJiJmdW5jdGlvbiI9PXR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mP28/VWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGUsdCxyKTpVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGUsdCxyKTpFKGUsW3RdLHIsbixvKTt0aHJvdyBuZXcgVHlwZUVycm9yKCJ2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXIiKX1mdW5jdGlvbiBFKGUsdCxyLG4sbyl7dmFyIGksYT0xLHM9ZS5sZW5ndGgsdT10Lmxlbmd0aDtpZih2b2lkIDAhPT1uJiYoInVjczIiPT09KG49U3RyaW5nKG4pLnRvTG93ZXJDYXNlKCkpfHwidWNzLTIiPT09bnx8InV0ZjE2bGUiPT09bnx8InV0Zi0xNmxlIj09PW4pKXtpZihlLmxlbmd0aDwyfHx0Lmxlbmd0aDwyKXJldHVybi0xO2E9MixzLz0yLHUvPTIsci89Mn1mdW5jdGlvbiBjKGUsdCl7cmV0dXJuIDE9PT1hP2VbdF06ZS5yZWFkVUludDE2QkUodCphKX1pZihvKXt2YXIgbD0tMTtmb3IoaT1yO2k8cztpKyspaWYoYyhlLGkpPT09Yyh0LC0xPT09bD8wOmktbCkpe2lmKC0xPT09bCYmKGw9aSksaS1sKzE9PT11KXJldHVybiBsKmF9ZWxzZS0xIT09bCYmKGktPWktbCksbD0tMX1lbHNlIGZvcihyK3U+cyYmKHI9cy11KSxpPXI7aT49MDtpLS0pe2Zvcih2YXIgZj0hMCxkPTA7ZDx1O2QrKylpZihjKGUsaStkKSE9PWModCxkKSl7Zj0hMTticmVha31pZihmKXJldHVybiBpfXJldHVybi0xfWZ1bmN0aW9uIGcoZSx0LHIsbil7cj1OdW1iZXIocil8fDA7dmFyIG89ZS5sZW5ndGgtcjtuPyhuPU51bWJlcihuKSk+byYmKG49byk6bj1vO3ZhciBpPXQubGVuZ3RoO2lmKGklMiE9MCl0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGhleCBzdHJpbmciKTtuPmkvMiYmKG49aS8yKTtmb3IodmFyIGE9MDthPG47KythKXt2YXIgcz1wYXJzZUludCh0LnN1YnN0cigyKmEsMiksMTYpO2lmKGlzTmFOKHMpKXJldHVybiBhO2VbcithXT1zfXJldHVybiBhfWZ1bmN0aW9uIHYoZSx0LHIsbil7cmV0dXJuICQoVSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiB3KGUsdCxyLG4pe3JldHVybiAkKGZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPTA7cjxlLmxlbmd0aDsrK3IpdC5wdXNoKDI1NSZlLmNoYXJDb2RlQXQocikpO3JldHVybiB0fSh0KSxlLHIsbil9ZnVuY3Rpb24gXyhlLHQscixuKXtyZXR1cm4gdyhlLHQscixuKX1mdW5jdGlvbiBiKGUsdCxyLG4pe3JldHVybiAkKHoodCksZSxyLG4pfWZ1bmN0aW9uIEEoZSx0LHIsbil7cmV0dXJuICQoZnVuY3Rpb24oZSx0KXtmb3IodmFyIHIsbixvLGk9W10sYT0wO2E8ZS5sZW5ndGgmJiEoKHQtPTIpPDApOysrYSluPShyPWUuY2hhckNvZGVBdChhKSk+Pjgsbz1yJTI1NixpLnB1c2gobyksaS5wdXNoKG4pO3JldHVybiBpfSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiBUKGUsdCxyKXtyZXR1cm4gMD09PXQmJnI9PT1lLmxlbmd0aD9uLmZyb21CeXRlQXJyYXkoZSk6bi5mcm9tQnl0ZUFycmF5KGUuc2xpY2UodCxyKSl9ZnVuY3Rpb24gUyhlLHQscil7cj1NYXRoLm1pbihlLmxlbmd0aCxyKTtmb3IodmFyIG49W10sbz10O288cjspe3ZhciBpLGEscyx1LGM9ZVtvXSxsPW51bGwsZj1jPjIzOT80OmM+MjIzPzM6Yz4xOTE/MjoxO2lmKG8rZjw9cilzd2l0Y2goZil7Y2FzZSAxOmM8MTI4JiYobD1jKTticmVhaztjYXNlIDI6MTI4PT0oMTkyJihpPWVbbysxXSkpJiYodT0oMzEmYyk8PDZ8NjMmaSk+MTI3JiYobD11KTticmVhaztjYXNlIDM6aT1lW28rMV0sYT1lW28rMl0sMTI4PT0oMTkyJmkpJiYxMjg9PSgxOTImYSkmJih1PSgxNSZjKTw8MTJ8KDYzJmkpPDw2fDYzJmEpPjIwNDcmJih1PDU1Mjk2fHx1PjU3MzQzKSYmKGw9dSk7YnJlYWs7Y2FzZSA0Omk9ZVtvKzFdLGE9ZVtvKzJdLHM9ZVtvKzNdLDEyOD09KDE5MiZpKSYmMTI4PT0oMTkyJmEpJiYxMjg9PSgxOTImcykmJih1PSgxNSZjKTw8MTh8KDYzJmkpPDwxMnwoNjMmYSk8PDZ8NjMmcyk+NjU1MzUmJnU8MTExNDExMiYmKGw9dSl9bnVsbD09PWw/KGw9NjU1MzMsZj0xKTpsPjY1NTM1JiYobC09NjU1MzYsbi5wdXNoKGw+Pj4xMCYxMDIzfDU1Mjk2KSxsPTU2MzIwfDEwMjMmbCksbi5wdXNoKGwpLG8rPWZ9cmV0dXJuIGZ1bmN0aW9uKGUpe3ZhciB0PWUubGVuZ3RoO2lmKHQ8PWspcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLGUpO2Zvcih2YXIgcj0iIixuPTA7bjx0OylyKz1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxlLnNsaWNlKG4sbis9aykpO3JldHVybiByfShuKX10LkJ1ZmZlcj11LHQuU2xvd0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4rZSE9ZSYmKGU9MCksdS5hbGxvYygrZSl9LHQuSU5TUEVDVF9NQVhfQllURVM9NTAsdS5UWVBFRF9BUlJBWV9TVVBQT1JUPXZvaWQgMCE9PWUuVFlQRURfQVJSQVlfU1VQUE9SVD9lLlRZUEVEX0FSUkFZX1NVUFBPUlQ6ZnVuY3Rpb24oKXt0cnl7dmFyIGU9bmV3IFVpbnQ4QXJyYXkoMSk7cmV0dXJuIGUuX19wcm90b19fPXtfX3Byb3RvX186VWludDhBcnJheS5wcm90b3R5cGUsZm9vOmZ1bmN0aW9uKCl7cmV0dXJuIDQyfX0sNDI9PT1lLmZvbygpJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zdWJhcnJheSYmMD09PWUuc3ViYXJyYXkoMSwxKS5ieXRlTGVuZ3RofWNhdGNoKGUpe3JldHVybiExfX0oKSx0LmtNYXhMZW5ndGg9YSgpLHUucG9vbFNpemU9ODE5Mix1Ll9hdWdtZW50PWZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fXz11LnByb3RvdHlwZSxlfSx1LmZyb209ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBjKG51bGwsZSx0LHIpfSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJih1LnByb3RvdHlwZS5fX3Byb3RvX189VWludDhBcnJheS5wcm90b3R5cGUsdS5fX3Byb3RvX189VWludDhBcnJheSwidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmU3ltYm9sLnNwZWNpZXMmJnVbU3ltYm9sLnNwZWNpZXNdPT09dSYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHUsU3ltYm9sLnNwZWNpZXMse3ZhbHVlOm51bGwsY29uZmlndXJhYmxlOiEwfSkpLHUuYWxsb2M9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gbCh0KSx0PD0wP3MoZSx0KTp2b2lkIDAhPT1yPyJzdHJpbmciPT10eXBlb2Ygbj9zKGUsdCkuZmlsbChyLG4pOnMoZSx0KS5maWxsKHIpOnMoZSx0KX0obnVsbCxlLHQscil9LHUuYWxsb2NVbnNhZmU9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5hbGxvY1Vuc2FmZVNsb3c9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5pc0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4hKG51bGw9PWV8fCFlLl9pc0J1ZmZlcil9LHUuY29tcGFyZT1mdW5jdGlvbihlLHQpe2lmKCF1LmlzQnVmZmVyKGUpfHwhdS5pc0J1ZmZlcih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzIik7aWYoZT09PXQpcmV0dXJuIDA7Zm9yKHZhciByPWUubGVuZ3RoLG49dC5sZW5ndGgsbz0wLGk9TWF0aC5taW4ocixuKTtvPGk7KytvKWlmKGVbb10hPT10W29dKXtyPWVbb10sbj10W29dO2JyZWFrfXJldHVybiByPG4/LTE6bjxyPzE6MH0sdS5pc0VuY29kaW5nPWZ1bmN0aW9uKGUpe3N3aXRjaChTdHJpbmcoZSkudG9Mb3dlckNhc2UoKSl7Y2FzZSJoZXgiOmNhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpjYXNlImJhc2U2NCI6Y2FzZSJ1Y3MyIjpjYXNlInVjcy0yIjpjYXNlInV0ZjE2bGUiOmNhc2UidXRmLTE2bGUiOnJldHVybiEwO2RlZmF1bHQ6cmV0dXJuITF9fSx1LmNvbmNhdD1mdW5jdGlvbihlLHQpe2lmKCFpKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTtpZigwPT09ZS5sZW5ndGgpcmV0dXJuIHUuYWxsb2MoMCk7dmFyIHI7aWYodm9pZCAwPT09dClmb3IodD0wLHI9MDtyPGUubGVuZ3RoOysrcil0Kz1lW3JdLmxlbmd0aDt2YXIgbj11LmFsbG9jVW5zYWZlKHQpLG89MDtmb3Iocj0wO3I8ZS5sZW5ndGg7KytyKXt2YXIgYT1lW3JdO2lmKCF1LmlzQnVmZmVyKGEpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTthLmNvcHkobixvKSxvKz1hLmxlbmd0aH1yZXR1cm4gbn0sdS5ieXRlTGVuZ3RoPXAsdS5wcm90b3R5cGUuX2lzQnVmZmVyPSEwLHUucHJvdG90eXBlLnN3YXAxNj1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlMiE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9MiltKHRoaXMsdCx0KzEpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS5zd2FwMzI9ZnVuY3Rpb24oKXt2YXIgZT10aGlzLmxlbmd0aDtpZihlJTQhPTApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzIik7Zm9yKHZhciB0PTA7dDxlO3QrPTQpbSh0aGlzLHQsdCszKSxtKHRoaXMsdCsxLHQrMik7cmV0dXJuIHRoaXN9LHUucHJvdG90eXBlLnN3YXA2ND1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlOCE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9OCltKHRoaXMsdCx0KzcpLG0odGhpcyx0KzEsdCs2KSxtKHRoaXMsdCsyLHQrNSksbSh0aGlzLHQrMyx0KzQpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3ZhciBlPTB8dGhpcy5sZW5ndGg7cmV0dXJuIDA9PT1lPyIiOjA9PT1hcmd1bWVudHMubGVuZ3RoP1ModGhpcywwLGUpOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0hMTtpZigodm9pZCAwPT09dHx8dDwwKSYmKHQ9MCksdD50aGlzLmxlbmd0aClyZXR1cm4iIjtpZigodm9pZCAwPT09cnx8cj50aGlzLmxlbmd0aCkmJihyPXRoaXMubGVuZ3RoKSxyPD0wKXJldHVybiIiO2lmKChyPj4+PTApPD0odD4+Pj0wKSlyZXR1cm4iIjtmb3IoZXx8KGU9InV0ZjgiKTs7KXN3aXRjaChlKXtjYXNlImhleCI6cmV0dXJuIFIodGhpcyx0LHIpO2Nhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6cmV0dXJuIFModGhpcyx0LHIpO2Nhc2UiYXNjaWkiOnJldHVybiBQKHRoaXMsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBEKHRoaXMsdCxyKTtjYXNlImJhc2U2NCI6cmV0dXJuIFQodGhpcyx0LHIpO2Nhc2UidWNzMiI6Y2FzZSJ1Y3MtMiI6Y2FzZSJ1dGYxNmxlIjpjYXNlInV0Zi0xNmxlIjpyZXR1cm4gTyh0aGlzLHQscik7ZGVmYXVsdDppZihuKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrZSk7ZT0oZSsiIikudG9Mb3dlckNhc2UoKSxuPSEwfX0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSx1LnByb3RvdHlwZS5lcXVhbHM9ZnVuY3Rpb24oZSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciIpO3JldHVybiB0aGlzPT09ZXx8MD09PXUuY29tcGFyZSh0aGlzLGUpfSx1LnByb3RvdHlwZS5pbnNwZWN0PWZ1bmN0aW9uKCl7dmFyIGU9IiIscj10LklOU1BFQ1RfTUFYX0JZVEVTO3JldHVybiB0aGlzLmxlbmd0aD4wJiYoZT10aGlzLnRvU3RyaW5nKCJoZXgiLDAscikubWF0Y2goLy57Mn0vZykuam9pbigiICIpLHRoaXMubGVuZ3RoPnImJihlKz0iIC4uLiAiKSksIjxCdWZmZXIgIitlKyI+In0sdS5wcm90b3R5cGUuY29tcGFyZT1mdW5jdGlvbihlLHQscixuLG8pe2lmKCF1LmlzQnVmZmVyKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIiKTtpZih2b2lkIDA9PT10JiYodD0wKSx2b2lkIDA9PT1yJiYocj1lP2UubGVuZ3RoOjApLHZvaWQgMD09PW4mJihuPTApLHZvaWQgMD09PW8mJihvPXRoaXMubGVuZ3RoKSx0PDB8fHI+ZS5sZW5ndGh8fG48MHx8bz50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigib3V0IG9mIHJhbmdlIGluZGV4Iik7aWYobj49byYmdD49cilyZXR1cm4gMDtpZihuPj1vKXJldHVybi0xO2lmKHQ+PXIpcmV0dXJuIDE7aWYodGhpcz09PWUpcmV0dXJuIDA7Zm9yKHZhciBpPShvPj4+PTApLShuPj4+PTApLGE9KHI+Pj49MCktKHQ+Pj49MCkscz1NYXRoLm1pbihpLGEpLGM9dGhpcy5zbGljZShuLG8pLGw9ZS5zbGljZSh0LHIpLGY9MDtmPHM7KytmKWlmKGNbZl0hPT1sW2ZdKXtpPWNbZl0sYT1sW2ZdO2JyZWFrfXJldHVybiBpPGE/LTE6YTxpPzE6MH0sdS5wcm90b3R5cGUuaW5jbHVkZXM9ZnVuY3Rpb24oZSx0LHIpe3JldHVybi0xIT09dGhpcy5pbmRleE9mKGUsdCxyKX0sdS5wcm90b3R5cGUuaW5kZXhPZj1mdW5jdGlvbihlLHQscil7cmV0dXJuIHkodGhpcyxlLHQsciwhMCl9LHUucHJvdG90eXBlLmxhc3RJbmRleE9mPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4geSh0aGlzLGUsdCxyLCExKX0sdS5wcm90b3R5cGUud3JpdGU9ZnVuY3Rpb24oZSx0LHIsbil7aWYodm9pZCAwPT09dCluPSJ1dGY4IixyPXRoaXMubGVuZ3RoLHQ9MDtlbHNlIGlmKHZvaWQgMD09PXImJiJzdHJpbmciPT10eXBlb2YgdCluPXQscj10aGlzLmxlbmd0aCx0PTA7ZWxzZXtpZighaXNGaW5pdGUodCkpdGhyb3cgbmV3IEVycm9yKCJCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCIpO3R8PTAsaXNGaW5pdGUocik/KHJ8PTAsdm9pZCAwPT09biYmKG49InV0ZjgiKSk6KG49cixyPXZvaWQgMCl9dmFyIG89dGhpcy5sZW5ndGgtdDtpZigodm9pZCAwPT09cnx8cj5vKSYmKHI9byksZS5sZW5ndGg+MCYmKHI8MHx8dDwwKXx8dD50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMiKTtufHwobj0idXRmOCIpO2Zvcih2YXIgaT0hMTs7KXN3aXRjaChuKXtjYXNlImhleCI6cmV0dXJuIGcodGhpcyxlLHQscik7Y2FzZSJ1dGY4IjpjYXNlInV0Zi04IjpyZXR1cm4gdih0aGlzLGUsdCxyKTtjYXNlImFzY2lpIjpyZXR1cm4gdyh0aGlzLGUsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBfKHRoaXMsZSx0LHIpO2Nhc2UiYmFzZTY0IjpyZXR1cm4gYih0aGlzLGUsdCxyKTtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIEEodGhpcyxlLHQscik7ZGVmYXVsdDppZihpKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrbik7bj0oIiIrbikudG9Mb3dlckNhc2UoKSxpPSEwfX0sdS5wcm90b3R5cGUudG9KU09OPWZ1bmN0aW9uKCl7cmV0dXJue3R5cGU6IkJ1ZmZlciIsZGF0YTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnJ8fHRoaXMsMCl9fTt2YXIgaz00MDk2O2Z1bmN0aW9uIFAoZSx0LHIpe3ZhciBuPSIiO3I9TWF0aC5taW4oZS5sZW5ndGgscik7Zm9yKHZhciBvPXQ7bzxyOysrbyluKz1TdHJpbmcuZnJvbUNoYXJDb2RlKDEyNyZlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBEKGUsdCxyKXt2YXIgbj0iIjtyPU1hdGgubWluKGUubGVuZ3RoLHIpO2Zvcih2YXIgbz10O288cjsrK28pbis9U3RyaW5nLmZyb21DaGFyQ29kZShlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBSKGUsdCxyKXt2YXIgbj1lLmxlbmd0aDsoIXR8fHQ8MCkmJih0PTApLCghcnx8cjwwfHxyPm4pJiYocj1uKTtmb3IodmFyIG89IiIsaT10O2k8cjsrK2kpbys9aihlW2ldKTtyZXR1cm4gb31mdW5jdGlvbiBPKGUsdCxyKXtmb3IodmFyIG49ZS5zbGljZSh0LHIpLG89IiIsaT0wO2k8bi5sZW5ndGg7aSs9MilvKz1TdHJpbmcuZnJvbUNoYXJDb2RlKG5baV0rMjU2Km5baSsxXSk7cmV0dXJuIG99ZnVuY3Rpb24gQyhlLHQscil7aWYoZSUxIT0wfHxlPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIm9mZnNldCBpcyBub3QgdWludCIpO2lmKGUrdD5yKXRocm93IG5ldyBSYW5nZUVycm9yKCJUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoIil9ZnVuY3Rpb24gTihlLHQscixuLG8saSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpO2lmKHQ+b3x8dDxpKXRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKTtpZihyK24+ZS5sZW5ndGgpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEYoZSx0LHIsbil7dDwwJiYodD02NTUzNSt0KzEpO2Zvcih2YXIgbz0wLGk9TWF0aC5taW4oZS5sZW5ndGgtciwyKTtvPGk7KytvKWVbcitvXT0odCYyNTU8PDgqKG4/bzoxLW8pKT4+PjgqKG4/bzoxLW8pfWZ1bmN0aW9uIE0oZSx0LHIsbil7dDwwJiYodD00Mjk0OTY3Mjk1K3QrMSk7Zm9yKHZhciBvPTAsaT1NYXRoLm1pbihlLmxlbmd0aC1yLDQpO288aTsrK28pZVtyK29dPXQ+Pj44KihuP286My1vKSYyNTV9ZnVuY3Rpb24gSShlLHQscixuLG8saSl7aWYocituPmUubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJJbmRleCBvdXQgb2YgcmFuZ2UiKTtpZihyPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEIoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw0KSxvLndyaXRlKGUsdCxyLG4sMjMsNCkscis0fWZ1bmN0aW9uIEwoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw4KSxvLndyaXRlKGUsdCxyLG4sNTIsOCkscis4fXUucHJvdG90eXBlLnNsaWNlPWZ1bmN0aW9uKGUsdCl7dmFyIHIsbj10aGlzLmxlbmd0aDtpZigoZT1+fmUpPDA/KGUrPW4pPDAmJihlPTApOmU+biYmKGU9biksKHQ9dm9pZCAwPT09dD9uOn5+dCk8MD8odCs9bik8MCYmKHQ9MCk6dD5uJiYodD1uKSx0PGUmJih0PWUpLHUuVFlQRURfQVJSQVlfU1VQUE9SVCkocj10aGlzLnN1YmFycmF5KGUsdCkpLl9fcHJvdG9fXz11LnByb3RvdHlwZTtlbHNle3ZhciBvPXQtZTtyPW5ldyB1KG8sdm9pZCAwKTtmb3IodmFyIGk9MDtpPG87KytpKXJbaV09dGhpc1tpK2VdfXJldHVybiByfSx1LnByb3RvdHlwZS5yZWFkVUludExFPWZ1bmN0aW9uKGUsdCxyKXtlfD0wLHR8PTAscnx8QyhlLHQsdGhpcy5sZW5ndGgpO2Zvcih2YXIgbj10aGlzW2VdLG89MSxpPTA7KytpPHQmJihvKj0yNTYpOyluKz10aGlzW2UraV0qbztyZXR1cm4gbn0sdS5wcm90b3R5cGUucmVhZFVJbnRCRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlKy0tdF0sbz0xO3Q+MCYmKG8qPTI1Nik7KW4rPXRoaXNbZSstLXRdKm87cmV0dXJuIG59LHUucHJvdG90eXBlLnJlYWRVSW50OD1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsMSx0aGlzLmxlbmd0aCksdGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdfHRoaXNbZSsxXTw8OH0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdPDw4fHRoaXNbZSsxXX0sdS5wcm90b3R5cGUucmVhZFVJbnQzMkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw0LHRoaXMubGVuZ3RoKSwodGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNikrMTY3NzcyMTYqdGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkVUludDMyQkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLDE2Nzc3MjE2KnRoaXNbZV0rKHRoaXNbZSsxXTw8MTZ8dGhpc1tlKzJdPDw4fHRoaXNbZSszXSl9LHUucHJvdG90eXBlLnJlYWRJbnRMRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlXSxvPTEsaT0wOysraTx0JiYobyo9MjU2KTspbis9dGhpc1tlK2ldKm87cmV0dXJuIG4+PShvKj0xMjgpJiYobi09TWF0aC5wb3coMiw4KnQpKSxufSx1LnByb3RvdHlwZS5yZWFkSW50QkU9ZnVuY3Rpb24oZSx0LHIpe2V8PTAsdHw9MCxyfHxDKGUsdCx0aGlzLmxlbmd0aCk7Zm9yKHZhciBuPXQsbz0xLGk9dGhpc1tlKy0tbl07bj4wJiYobyo9MjU2KTspaSs9dGhpc1tlKy0tbl0qbztyZXR1cm4gaT49KG8qPTEyOCkmJihpLT1NYXRoLnBvdygyLDgqdCkpLGl9LHUucHJvdG90eXBlLnJlYWRJbnQ4PWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwxLHRoaXMubGVuZ3RoKSwxMjgmdGhpc1tlXT8tMSooMjU1LXRoaXNbZV0rMSk6dGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZEludDE2TEU9ZnVuY3Rpb24oZSx0KXt0fHxDKGUsMix0aGlzLmxlbmd0aCk7dmFyIHI9dGhpc1tlXXx0aGlzW2UrMV08PDg7cmV0dXJuIDMyNzY4JnI/NDI5NDkwMTc2MHxyOnJ9LHUucHJvdG90eXBlLnJlYWRJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7dHx8QyhlLDIsdGhpcy5sZW5ndGgpO3ZhciByPXRoaXNbZSsxXXx0aGlzW2VdPDw4O3JldHVybiAzMjc2OCZyPzQyOTQ5MDE3NjB8cjpyfSx1LnByb3RvdHlwZS5yZWFkSW50MzJMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNnx0aGlzW2UrM108PDI0fSx1LnByb3RvdHlwZS5yZWFkSW50MzJCRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXTw8MjR8dGhpc1tlKzFdPDwxNnx0aGlzW2UrMl08PDh8dGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkRmxvYXRMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCwyMyw0KX0sdS5wcm90b3R5cGUucmVhZEZsb2F0QkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLG8ucmVhZCh0aGlzLGUsITEsMjMsNCl9LHUucHJvdG90eXBlLnJlYWREb3VibGVMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsOCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCw1Miw4KX0sdS5wcm90b3R5cGUucmVhZERvdWJsZUJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw4LHRoaXMubGVuZ3RoKSxvLnJlYWQodGhpcyxlLCExLDUyLDgpfSx1LnByb3RvdHlwZS53cml0ZVVJbnRMRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89MSxpPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihvKj0yNTYpOyl0aGlzW3QraV09ZS9vJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZVVJbnRCRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89ci0xLGk9MTtmb3IodGhpc1t0K29dPTI1NSZlOy0tbz49MCYmKGkqPTI1Nik7KXRoaXNbdCtvXT1lL2kmMjU1O3JldHVybiB0K3J9LHUucHJvdG90eXBlLndyaXRlVUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDI1NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLHRoaXNbdF09MjU1JmUsdCsxfSx1LnByb3RvdHlwZS53cml0ZVVJbnQxNkxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsMiw2NTUzNSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlVUludDE2QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwyLDY1NTM1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+OCx0aGlzW3QrMV09MjU1JmUpOkYodGhpcyxlLHQsITEpLHQrMn0sdS5wcm90b3R5cGUud3JpdGVVSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsNDI5NDk2NzI5NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdCszXT1lPj4+MjQsdGhpc1t0KzJdPWU+Pj4xNix0aGlzW3QrMV09ZT4+PjgsdGhpc1t0XT0yNTUmZSk6TSh0aGlzLGUsdCwhMCksdCs0fSx1LnByb3RvdHlwZS53cml0ZVVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCw0Mjk0OTY3Mjk1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+MjQsdGhpc1t0KzFdPWU+Pj4xNix0aGlzW3QrMl09ZT4+PjgsdGhpc1t0KzNdPTI1NSZlKTpNKHRoaXMsZSx0LCExKSx0KzR9LHUucHJvdG90eXBlLndyaXRlSW50TEU9ZnVuY3Rpb24oZSx0LHIsbil7aWYoZT0rZSx0fD0wLCFuKXt2YXIgbz1NYXRoLnBvdygyLDgqci0xKTtOKHRoaXMsZSx0LHIsby0xLC1vKX12YXIgaT0wLGE9MSxzPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2ktMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludEJFPWZ1bmN0aW9uKGUsdCxyLG4pe2lmKGU9K2UsdHw9MCwhbil7dmFyIG89TWF0aC5wb3coMiw4KnItMSk7Tih0aGlzLGUsdCxyLG8tMSwtbyl9dmFyIGk9ci0xLGE9MSxzPTA7Zm9yKHRoaXNbdCtpXT0yNTUmZTstLWk+PTAmJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2krMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDEyNywtMTI4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLGU8MCYmKGU9MjU1K2UrMSksdGhpc1t0XT0yNTUmZSx0KzF9LHUucHJvdG90eXBlLndyaXRlSW50MTZMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MTZCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjgsdGhpc1t0KzFdPTI1NSZlKTpGKHRoaXMsZSx0LCExKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsMjE0NzQ4MzY0NywtMjE0NzQ4MzY0OCksdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyh0aGlzW3RdPTI1NSZlLHRoaXNbdCsxXT1lPj4+OCx0aGlzW3QrMl09ZT4+PjE2LHRoaXNbdCszXT1lPj4+MjQpOk0odGhpcyxlLHQsITApLHQrNH0sdS5wcm90b3R5cGUud3JpdGVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCwyMTQ3NDgzNjQ3LC0yMTQ3NDgzNjQ4KSxlPDAmJihlPTQyOTQ5NjcyOTUrZSsxKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjI0LHRoaXNbdCsxXT1lPj4+MTYsdGhpc1t0KzJdPWU+Pj44LHRoaXNbdCszXT0yNTUmZSk6TSh0aGlzLGUsdCwhMSksdCs0fSx1LnByb3RvdHlwZS53cml0ZUZsb2F0TEU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCEwLHIpfSx1LnByb3RvdHlwZS53cml0ZUZsb2F0QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCExLHIpfSx1LnByb3RvdHlwZS53cml0ZURvdWJsZUxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gTCh0aGlzLGUsdCwhMCxyKX0sdS5wcm90b3R5cGUud3JpdGVEb3VibGVCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIEwodGhpcyxlLHQsITEscil9LHUucHJvdG90eXBlLmNvcHk9ZnVuY3Rpb24oZSx0LHIsbil7aWYocnx8KHI9MCksbnx8MD09PW58fChuPXRoaXMubGVuZ3RoKSx0Pj1lLmxlbmd0aCYmKHQ9ZS5sZW5ndGgpLHR8fCh0PTApLG4+MCYmbjxyJiYobj1yKSxuPT09cilyZXR1cm4gMDtpZigwPT09ZS5sZW5ndGh8fDA9PT10aGlzLmxlbmd0aClyZXR1cm4gMDtpZih0PDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoInRhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMiKTtpZihyPDB8fHI+PXRoaXMubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzIik7aWYobjwwKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcyIpO24+dGhpcy5sZW5ndGgmJihuPXRoaXMubGVuZ3RoKSxlLmxlbmd0aC10PG4tciYmKG49ZS5sZW5ndGgtdCtyKTt2YXIgbyxpPW4tcjtpZih0aGlzPT09ZSYmcjx0JiZ0PG4pZm9yKG89aS0xO28+PTA7LS1vKWVbbyt0XT10aGlzW28rcl07ZWxzZSBpZihpPDFlM3x8IXUuVFlQRURfQVJSQVlfU1VQUE9SVClmb3Iobz0wO288aTsrK28pZVtvK3RdPXRoaXNbbytyXTtlbHNlIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKGUsdGhpcy5zdWJhcnJheShyLHIraSksdCk7cmV0dXJuIGl9LHUucHJvdG90eXBlLmZpbGw9ZnVuY3Rpb24oZSx0LHIsbil7aWYoInN0cmluZyI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQ/KG49dCx0PTAscj10aGlzLmxlbmd0aCk6InN0cmluZyI9PXR5cGVvZiByJiYobj1yLHI9dGhpcy5sZW5ndGgpLDE9PT1lLmxlbmd0aCl7dmFyIG89ZS5jaGFyQ29kZUF0KDApO288MjU2JiYoZT1vKX1pZih2b2lkIDAhPT1uJiYic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZyIpO2lmKCJzdHJpbmciPT10eXBlb2YgbiYmIXUuaXNFbmNvZGluZyhuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK24pfWVsc2UibnVtYmVyIj09dHlwZW9mIGUmJihlJj0yNTUpO2lmKHQ8MHx8dGhpcy5sZW5ndGg8dHx8dGhpcy5sZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiT3V0IG9mIHJhbmdlIGluZGV4Iik7aWYocjw9dClyZXR1cm4gdGhpczt2YXIgaTtpZih0Pj4+PTAscj12b2lkIDA9PT1yP3RoaXMubGVuZ3RoOnI+Pj4wLGV8fChlPTApLCJudW1iZXIiPT10eXBlb2YgZSlmb3IoaT10O2k8cjsrK2kpdGhpc1tpXT1lO2Vsc2V7dmFyIGE9dS5pc0J1ZmZlcihlKT9lOlUobmV3IHUoZSxuKS50b1N0cmluZygpKSxzPWEubGVuZ3RoO2ZvcihpPTA7aTxyLXQ7KytpKXRoaXNbaSt0XT1hW2klc119cmV0dXJuIHRoaXN9O3ZhciB4PS9bXitcLzAtOUEtWmEtei1fXS9nO2Z1bmN0aW9uIGooZSl7cmV0dXJuIGU8MTY/IjAiK2UudG9TdHJpbmcoMTYpOmUudG9TdHJpbmcoMTYpfWZ1bmN0aW9uIFUoZSx0KXt2YXIgcjt0PXR8fDEvMDtmb3IodmFyIG49ZS5sZW5ndGgsbz1udWxsLGk9W10sYT0wO2E8bjsrK2Epe2lmKChyPWUuY2hhckNvZGVBdChhKSk+NTUyOTUmJnI8NTczNDQpe2lmKCFvKXtpZihyPjU2MzE5KXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSk7Y29udGludWV9aWYoYSsxPT09bil7KHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2NvbnRpbnVlfW89cjtjb250aW51ZX1pZihyPDU2MzIwKXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSksbz1yO2NvbnRpbnVlfXI9NjU1MzYrKG8tNTUyOTY8PDEwfHItNTYzMjApfWVsc2UgbyYmKHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2lmKG89bnVsbCxyPDEyOCl7aWYoKHQtPTEpPDApYnJlYWs7aS5wdXNoKHIpfWVsc2UgaWYocjwyMDQ4KXtpZigodC09Mik8MClicmVhaztpLnB1c2gocj4+NnwxOTIsNjMmcnwxMjgpfWVsc2UgaWYocjw2NTUzNil7aWYoKHQtPTMpPDApYnJlYWs7aS5wdXNoKHI+PjEyfDIyNCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9ZWxzZXtpZighKHI8MTExNDExMikpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGNvZGUgcG9pbnQiKTtpZigodC09NCk8MClicmVhaztpLnB1c2gocj4+MTh8MjQwLHI+PjEyJjYzfDEyOCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9fXJldHVybiBpfWZ1bmN0aW9uIHooZSl7cmV0dXJuIG4udG9CeXRlQXJyYXkoZnVuY3Rpb24oZSl7aWYoKGU9ZnVuY3Rpb24oZSl7cmV0dXJuIGUudHJpbT9lLnRyaW0oKTplLnJlcGxhY2UoL15ccyt8XHMrJC9nLCIiKX0oZSkucmVwbGFjZSh4LCIiKSkubGVuZ3RoPDIpcmV0dXJuIiI7Zm9yKDtlLmxlbmd0aCU0IT0wOyllKz0iPSI7cmV0dXJuIGV9KGUpKX1mdW5jdGlvbiAkKGUsdCxyLG4pe2Zvcih2YXIgbz0wO288biYmIShvK3I+PXQubGVuZ3RofHxvPj1lLmxlbmd0aCk7KytvKXRbbytyXT1lW29dO3JldHVybiBvfX0pLmNhbGwodGhpcyxyKDgpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcjtyPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3I9cnx8RnVuY3Rpb24oInJldHVybiB0aGlzIikoKXx8KDAsZXZhbCkoInRoaXMiKX1jYXRjaChlKXsib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmKHI9d2luZG93KX1lLmV4cG9ydHM9cn0sZnVuY3Rpb24oZSx0LHIpe3QuYnl0ZUxlbmd0aD1mdW5jdGlvbihlKXt2YXIgdD1jKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIDMqKHIrbikvNC1ufSx0LnRvQnl0ZUFycmF5PWZ1bmN0aW9uKGUpe2Zvcih2YXIgdCxyPWMoZSksbj1yWzBdLGE9clsxXSxzPW5ldyBpKGZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gMyoodCtyKS80LXJ9KDAsbixhKSksdT0wLGw9YT4wP24tNDpuLGY9MDtmPGw7Zis9NCl0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MTh8b1tlLmNoYXJDb2RlQXQoZisxKV08PDEyfG9bZS5jaGFyQ29kZUF0KGYrMildPDw2fG9bZS5jaGFyQ29kZUF0KGYrMyldLHNbdSsrXT10Pj4xNiYyNTUsc1t1KytdPXQ+PjgmMjU1LHNbdSsrXT0yNTUmdDtyZXR1cm4gMj09PWEmJih0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MnxvW2UuY2hhckNvZGVBdChmKzEpXT4+NCxzW3UrK109MjU1JnQpLDE9PT1hJiYodD1vW2UuY2hhckNvZGVBdChmKV08PDEwfG9bZS5jaGFyQ29kZUF0KGYrMSldPDw0fG9bZS5jaGFyQ29kZUF0KGYrMildPj4yLHNbdSsrXT10Pj44JjI1NSxzW3UrK109MjU1JnQpLHN9LHQuZnJvbUJ5dGVBcnJheT1mdW5jdGlvbihlKXtmb3IodmFyIHQscj1lLmxlbmd0aCxvPXIlMyxpPVtdLGE9MCxzPXItbzthPHM7YSs9MTYzODMpaS5wdXNoKGYoZSxhLGErMTYzODM+cz9zOmErMTYzODMpKTtyZXR1cm4gMT09PW8/KHQ9ZVtyLTFdLGkucHVzaChuW3Q+PjJdK25bdDw8NCY2M10rIj09IikpOjI9PT1vJiYodD0oZVtyLTJdPDw4KStlW3ItMV0saS5wdXNoKG5bdD4+MTBdK25bdD4+NCY2M10rblt0PDwyJjYzXSsiPSIpKSxpLmpvaW4oIiIpfTtmb3IodmFyIG49W10sbz1bXSxpPSJ1bmRlZmluZWQiIT10eXBlb2YgVWludDhBcnJheT9VaW50OEFycmF5OkFycmF5LGE9IkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iLHM9MCx1PWEubGVuZ3RoO3M8dTsrK3MpbltzXT1hW3NdLG9bYS5jaGFyQ29kZUF0KHMpXT1zO2Z1bmN0aW9uIGMoZSl7dmFyIHQ9ZS5sZW5ndGg7aWYodCU0PjApdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0Iik7dmFyIHI9ZS5pbmRleE9mKCI9Iik7cmV0dXJuLTE9PT1yJiYocj10KSxbcixyPT09dD8wOjQtciU0XX1mdW5jdGlvbiBsKGUpe3JldHVybiBuW2U+PjE4JjYzXStuW2U+PjEyJjYzXStuW2U+PjYmNjNdK25bNjMmZV19ZnVuY3Rpb24gZihlLHQscil7Zm9yKHZhciBuLG89W10saT10O2k8cjtpKz0zKW49KGVbaV08PDE2JjE2NzExNjgwKSsoZVtpKzFdPDw4JjY1MjgwKSsoMjU1JmVbaSsyXSksby5wdXNoKGwobikpO3JldHVybiBvLmpvaW4oIiIpfW9bIi0iLmNoYXJDb2RlQXQoMCldPTYyLG9bIl8iLmNoYXJDb2RlQXQoMCldPTYzfSxmdW5jdGlvbihlLHQpe3QucmVhZD1mdW5jdGlvbihlLHQscixuLG8pe3ZhciBpLGEscz04Km8tbi0xLHU9KDE8PHMpLTEsYz11Pj4xLGw9LTcsZj1yP28tMTowLGQ9cj8tMToxLGg9ZVt0K2ZdO2ZvcihmKz1kLGk9aCYoMTw8LWwpLTEsaD4+PS1sLGwrPXM7bD4wO2k9MjU2KmkrZVt0K2ZdLGYrPWQsbC09OCk7Zm9yKGE9aSYoMTw8LWwpLTEsaT4+PS1sLGwrPW47bD4wO2E9MjU2KmErZVt0K2ZdLGYrPWQsbC09OCk7aWYoMD09PWkpaT0xLWM7ZWxzZXtpZihpPT09dSlyZXR1cm4gYT9OYU46MS8wKihoPy0xOjEpO2ErPU1hdGgucG93KDIsbiksaS09Y31yZXR1cm4oaD8tMToxKSphKk1hdGgucG93KDIsaS1uKX0sdC53cml0ZT1mdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGEscyx1LGM9OCppLW8tMSxsPSgxPDxjKS0xLGY9bD4+MSxkPTIzPT09bz9NYXRoLnBvdygyLC0yNCktTWF0aC5wb3coMiwtNzcpOjAsaD1uPzA6aS0xLHA9bj8xOi0xLG09dDwwfHwwPT09dCYmMS90PDA/MTowO2Zvcih0PU1hdGguYWJzKHQpLGlzTmFOKHQpfHx0PT09MS8wPyhzPWlzTmFOKHQpPzE6MCxhPWwpOihhPU1hdGguZmxvb3IoTWF0aC5sb2codCkvTWF0aC5MTjIpLHQqKHU9TWF0aC5wb3coMiwtYSkpPDEmJihhLS0sdSo9MiksKHQrPWErZj49MT9kL3U6ZCpNYXRoLnBvdygyLDEtZikpKnU+PTImJihhKyssdS89MiksYStmPj1sPyhzPTAsYT1sKTphK2Y+PTE/KHM9KHQqdS0xKSpNYXRoLnBvdygyLG8pLGErPWYpOihzPXQqTWF0aC5wb3coMixmLTEpKk1hdGgucG93KDIsbyksYT0wKSk7bz49ODtlW3IraF09MjU1JnMsaCs9cCxzLz0yNTYsby09OCk7Zm9yKGE9YTw8b3xzLGMrPW87Yz4wO2VbcitoXT0yNTUmYSxoKz1wLGEvPTI1NixjLT04KTtlW3IraC1wXXw9MTI4Km19fSxmdW5jdGlvbihlLHQpe3ZhciByPXt9LnRvU3RyaW5nO2UuZXhwb3J0cz1BcnJheS5pc0FycmF5fHxmdW5jdGlvbihlKXtyZXR1cm4iW29iamVjdCBBcnJheV0iPT1yLmNhbGwoZSl9fSxmdW5jdGlvbih0LHIpe3QuZXhwb3J0cz1lfSxmdW5jdGlvbihlLHQscil7KGZ1bmN0aW9uKGUpe2Z1bmN0aW9uIHIoZSx0KXtmb3IodmFyIHI9MCxuPWUubGVuZ3RoLTE7bj49MDtuLS0pe3ZhciBvPWVbbl07Ii4iPT09bz9lLnNwbGljZShuLDEpOiIuLiI9PT1vPyhlLnNwbGljZShuLDEpLHIrKyk6ciYmKGUuc3BsaWNlKG4sMSksci0tKX1pZih0KWZvcig7ci0tO3IpZS51bnNoaWZ0KCIuLiIpO3JldHVybiBlfXZhciBuPS9eKFwvP3wpKFtcc1xTXSo/KSgoPzpcLnsxLDJ9fFteXC9dKz98KShcLlteLlwvXSp8KSkoPzpbXC9dKikkLyxvPWZ1bmN0aW9uKGUpe3JldHVybiBuLmV4ZWMoZSkuc2xpY2UoMSl9O2Z1bmN0aW9uIGkoZSx0KXtpZihlLmZpbHRlcilyZXR1cm4gZS5maWx0ZXIodCk7Zm9yKHZhciByPVtdLG49MDtuPGUubGVuZ3RoO24rKyl0KGVbbl0sbixlKSYmci5wdXNoKGVbbl0pO3JldHVybiByfXQucmVzb2x2ZT1mdW5jdGlvbigpe2Zvcih2YXIgdD0iIixuPSExLG89YXJndW1lbnRzLmxlbmd0aC0xO28+PS0xJiYhbjtvLS0pe3ZhciBhPW8+PTA/YXJndW1lbnRzW29dOmUuY3dkKCk7aWYoInN0cmluZyIhPXR5cGVvZiBhKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLnJlc29sdmUgbXVzdCBiZSBzdHJpbmdzIik7YSYmKHQ9YSsiLyIrdCxuPSIvIj09PWEuY2hhckF0KDApKX1yZXR1cm4obj8iLyI6IiIpKyh0PXIoaSh0LnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8Ii4ifSx0Lm5vcm1hbGl6ZT1mdW5jdGlvbihlKXt2YXIgbj10LmlzQWJzb2x1dGUoZSksbz0iLyI9PT1hKGUsLTEpO3JldHVybihlPXIoaShlLnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8bnx8KGU9Ii4iKSxlJiZvJiYoZSs9Ii8iKSwobj8iLyI6IiIpK2V9LHQuaXNBYnNvbHV0ZT1mdW5jdGlvbihlKXtyZXR1cm4iLyI9PT1lLmNoYXJBdCgwKX0sdC5qb2luPWZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiB0Lm5vcm1hbGl6ZShpKGUsKGZ1bmN0aW9uKGUsdCl7aWYoInN0cmluZyIhPXR5cGVvZiBlKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLmpvaW4gbXVzdCBiZSBzdHJpbmdzIik7cmV0dXJuIGV9KSkuam9pbigiLyIpKX0sdC5yZWxhdGl2ZT1mdW5jdGlvbihlLHIpe2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9dC5yZXNvbHZlKGUpLnN1YnN0cigxKSxyPXQucmVzb2x2ZShyKS5zdWJzdHIoMSk7Zm9yKHZhciBvPW4oZS5zcGxpdCgiLyIpKSxpPW4oci5zcGxpdCgiLyIpKSxhPU1hdGgubWluKG8ubGVuZ3RoLGkubGVuZ3RoKSxzPWEsdT0wO3U8YTt1KyspaWYob1t1XSE9PWlbdV0pe3M9dTticmVha312YXIgYz1bXTtmb3IodT1zO3U8by5sZW5ndGg7dSsrKWMucHVzaCgiLi4iKTtyZXR1cm4oYz1jLmNvbmNhdChpLnNsaWNlKHMpKSkuam9pbigiLyIpfSx0LnNlcD0iLyIsdC5kZWxpbWl0ZXI9IjoiLHQuZGlybmFtZT1mdW5jdGlvbihlKXt2YXIgdD1vKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSx0LmJhc2VuYW1lPWZ1bmN0aW9uKGUsdCl7dmFyIHI9byhlKVsyXTtyZXR1cm4gdCYmci5zdWJzdHIoLTEqdC5sZW5ndGgpPT09dCYmKHI9ci5zdWJzdHIoMCxyLmxlbmd0aC10Lmxlbmd0aCkpLHJ9LHQuZXh0bmFtZT1mdW5jdGlvbihlKXtyZXR1cm4gbyhlKVszXX07dmFyIGE9ImIiPT09ImFiIi5zdWJzdHIoLTEpP2Z1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZS5zdWJzdHIodCxyKX06ZnVuY3Rpb24oZSx0LHIpe3JldHVybiB0PDAmJih0PWUubGVuZ3RoK3QpLGUuc3Vic3RyKHQscil9fSkuY2FsbCh0aGlzLHIoMTQpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcixuLG89ZS5leHBvcnRzPXt9O2Z1bmN0aW9uIGkoKXt0aHJvdyBuZXcgRXJyb3IoInNldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBhKCl7dGhyb3cgbmV3IEVycm9yKCJjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBzKGUpe2lmKHI9PT1zZXRUaW1lb3V0KXJldHVybiBzZXRUaW1lb3V0KGUsMCk7aWYoKHI9PT1pfHwhcikmJnNldFRpbWVvdXQpcmV0dXJuIHI9c2V0VGltZW91dCxzZXRUaW1lb3V0KGUsMCk7dHJ5e3JldHVybiByKGUsMCl9Y2F0Y2godCl7dHJ5e3JldHVybiByLmNhbGwobnVsbCxlLDApfWNhdGNoKHQpe3JldHVybiByLmNhbGwodGhpcyxlLDApfX19IWZ1bmN0aW9uKCl7dHJ5e3I9ImZ1bmN0aW9uIj09dHlwZW9mIHNldFRpbWVvdXQ/c2V0VGltZW91dDppfWNhdGNoKGUpe3I9aX10cnl7bj0iZnVuY3Rpb24iPT10eXBlb2YgY2xlYXJUaW1lb3V0P2NsZWFyVGltZW91dDphfWNhdGNoKGUpe249YX19KCk7dmFyIHUsYz1bXSxsPSExLGY9LTE7ZnVuY3Rpb24gZCgpe2wmJnUmJihsPSExLHUubGVuZ3RoP2M9dS5jb25jYXQoYyk6Zj0tMSxjLmxlbmd0aCYmaCgpKX1mdW5jdGlvbiBoKCl7aWYoIWwpe3ZhciBlPXMoZCk7bD0hMDtmb3IodmFyIHQ9Yy5sZW5ndGg7dDspe2Zvcih1PWMsYz1bXTsrK2Y8dDspdSYmdVtmXS5ydW4oKTtmPS0xLHQ9Yy5sZW5ndGh9dT1udWxsLGw9ITEsZnVuY3Rpb24oZSl7aWYobj09PWNsZWFyVGltZW91dClyZXR1cm4gY2xlYXJUaW1lb3V0KGUpO2lmKChuPT09YXx8IW4pJiZjbGVhclRpbWVvdXQpcmV0dXJuIG49Y2xlYXJUaW1lb3V0LGNsZWFyVGltZW91dChlKTt0cnl7bihlKX1jYXRjaCh0KXt0cnl7cmV0dXJuIG4uY2FsbChudWxsLGUpfWNhdGNoKHQpe3JldHVybiBuLmNhbGwodGhpcyxlKX19fShlKX19ZnVuY3Rpb24gcChlLHQpe3RoaXMuZnVuPWUsdGhpcy5hcnJheT10fWZ1bmN0aW9uIG0oKXt9by5uZXh0VGljaz1mdW5jdGlvbihlKXt2YXIgdD1uZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aC0xKTtpZihhcmd1bWVudHMubGVuZ3RoPjEpZm9yKHZhciByPTE7cjxhcmd1bWVudHMubGVuZ3RoO3IrKyl0W3ItMV09YXJndW1lbnRzW3JdO2MucHVzaChuZXcgcChlLHQpKSwxIT09Yy5sZW5ndGh8fGx8fHMoaCl9LHAucHJvdG90eXBlLnJ1bj1mdW5jdGlvbigpe3RoaXMuZnVuLmFwcGx5KG51bGwsdGhpcy5hcnJheSl9LG8udGl0bGU9ImJyb3dzZXIiLG8uYnJvd3Nlcj0hMCxvLmVudj17fSxvLmFyZ3Y9W10sby52ZXJzaW9uPSIiLG8udmVyc2lvbnM9e30sby5vbj1tLG8uYWRkTGlzdGVuZXI9bSxvLm9uY2U9bSxvLm9mZj1tLG8ucmVtb3ZlTGlzdGVuZXI9bSxvLnJlbW92ZUFsbExpc3RlbmVycz1tLG8uZW1pdD1tLG8ucHJlcGVuZExpc3RlbmVyPW0sby5wcmVwZW5kT25jZUxpc3RlbmVyPW0sby5saXN0ZW5lcnM9ZnVuY3Rpb24oZSl7cmV0dXJuW119LG8uYmluZGluZz1mdW5jdGlvbihlKXt0aHJvdyBuZXcgRXJyb3IoInByb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkIil9LG8uY3dkPWZ1bmN0aW9uKCl7cmV0dXJuIi8ifSxvLmNoZGlyPWZ1bmN0aW9uKGUpe3Rocm93IG5ldyBFcnJvcigicHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkIil9LG8udW1hc2s9ZnVuY3Rpb24oKXtyZXR1cm4gMH19XSl9KHQuZnMpO2NvbnN0IHI9ZS51bnBhY2tCcmlkZ2U7bGV0IG47dmFyIG89ZnVuY3Rpb24oZSl7Y29uc3QgdD17fTtjcmVkZW50aWFscz0ib21pdCI7dmFyIG4sbz12b2lkIDAhPT10P3Q6e30saT1yLkV4dCxhPXtvcGVuOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5vcGVuLmFwcGx5KGkuY3VycmVudCxhcmd1bWVudHMpfSxjbG9zZTpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuY2xvc2UuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHJlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gaS5jdXJyZW50LnJlYWQuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHdyaXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC53cml0ZS5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sdGVsbDpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQudGVsbC5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sc2VlazpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuc2Vlay5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sY3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5jcmVhdGUuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9fSxzPXt9O2ZvcihuIGluIG8pby5oYXNPd25Qcm9wZXJ0eShuKSYmKHNbbl09b1tuXSk7by5hcmd1bWVudHM9W10sby50aGlzUHJvZ3JhbT0iLi90aGlzLnByb2dyYW0iLG8ucXVpdD1mdW5jdGlvbihlLHQpe3Rocm93IHR9LG8ucHJlUnVuPVtdLG8ucG9zdFJ1bj1bXTt2YXIgdT0hMSxjPSExLGw9ITE7aWYoby5FTlZJUk9OTUVOVCl7aWYoIldFQiI9PT1vLkVOVklST05NRU5UKXU9ITA7ZWxzZSBpZigiV09SS0VSIj09PW8uRU5WSVJPTk1FTlQpYz0hMDtlbHNlIGlmKCJOT0RFIj09PW8uRU5WSVJPTk1FTlQpbD0hMDtlbHNlIGlmKCJTSEVMTCIhPT1vLkVOVklST05NRU5UKXRocm93IG5ldyBFcnJvcigiTW9kdWxlWydFTlZJUk9OTUVOVCddIHZhbHVlIGlzIG5vdCB2YWxpZC4gbXVzdCBiZSBvbmUgb2Y6IFdFQnxXT1JLRVJ8Tk9ERXxTSEVMTC4iKX1lbHNlIHU9Im9iamVjdCI9PXR5cGVvZiB3aW5kb3csYz0iZnVuY3Rpb24iPT10eXBlb2YgaW1wb3J0U2NyaXB0cyxsPSJvYmplY3QiPT10eXBlb2YgcHJvY2VzcyYmImZ1bmN0aW9uIj09dHlwZW9mIHJlcXVpcmUmJiF1JiYhYztmb3IobiBpbih1fHxjKSYmKG8ucmVhZD1mdW5jdGlvbihlKXt2YXIgdD1uZXcgWE1MSHR0cFJlcXVlc3Q7cmV0dXJuIHQub3BlbigiR0VUIixlLCExKSx0LnNlbmQobnVsbCksdC5yZXNwb25zZVRleHR9LGMmJihvLnJlYWRCaW5hcnk9ZnVuY3Rpb24oZSl7dmFyIHQ9bmV3IFhNTEh0dHBSZXF1ZXN0O3JldHVybiB0Lm9wZW4oIkdFVCIsZSwhMSksdC5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIix0LnNlbmQobnVsbCksbmV3IFVpbnQ4QXJyYXkodC5yZXNwb25zZSl9KSxvLnJlYWRBc3luYz1mdW5jdGlvbihlLHQscil7dmFyIG49bmV3IFhNTEh0dHBSZXF1ZXN0O24ub3BlbigiR0VUIixlLCEwKSxuLnJlc3BvbnNlVHlwZT0iYXJyYXlidWZmZXIiLG4ub25sb2FkPWZ1bmN0aW9uKCl7MjAwPT1uLnN0YXR1c3x8MD09bi5zdGF0dXMmJm4ucmVzcG9uc2U/dChuLnJlc3BvbnNlKTpyKCl9LG4ub25lcnJvcj1yLG4uc2VuZChudWxsKX0sby5zZXRXaW5kb3dUaXRsZT1mdW5jdGlvbihlKXtkb2N1bWVudC50aXRsZT1lfSksby5wcmludD0idW5kZWZpbmVkIiE9dHlwZW9mIGNvbnNvbGU/Y29uc29sZS5sb2cuYmluZChjb25zb2xlKToidW5kZWZpbmVkIiE9dHlwZW9mIHByaW50P3ByaW50Om51bGwsby5wcmludEVycj0idW5kZWZpbmVkIiE9dHlwZW9mIHByaW50RXJyP3ByaW50RXJyOiJ1bmRlZmluZWQiIT10eXBlb2YgY29uc29sZSYmY29uc29sZS53YXJuLmJpbmQoY29uc29sZSl8fG8ucHJpbnQsby5wcmludD1vLnByaW50LG8ucHJpbnRFcnI9by5wcmludEVycixzKXMuaGFzT3duUHJvcGVydHkobikmJihvW25dPXNbbl0pO3M9dm9pZCAwO2Z1bmN0aW9uIGYoZSl7eSgheCk7dmFyIHQ9TDtyZXR1cm4gTD1MK2UrMTUmLTE2LHR9ZnVuY3Rpb24gZChlKXt5KCQpO3ZhciB0PUZbJD4+Ml0scj10K2UrMTUmLTE2O2lmKChGWyQ+PjJdPXIscj49cSkmJiFIKCkpcmV0dXJuIEZbJD4+Ml09dCwwO3JldHVybiB0fWZ1bmN0aW9uIGgoZSx0KXtyZXR1cm4gdHx8KHQ9MTYpLGU9TWF0aC5jZWlsKGUvdCkqdH1mdW5jdGlvbiBwKGUpe3N3aXRjaChlKXtjYXNlImkxIjpjYXNlImk4IjpyZXR1cm4gMTtjYXNlImkxNiI6cmV0dXJuIDI7Y2FzZSJpMzIiOnJldHVybiA0O2Nhc2UiaTY0IjpyZXR1cm4gODtjYXNlImZsb2F0IjpyZXR1cm4gNDtjYXNlImRvdWJsZSI6cmV0dXJuIDg7ZGVmYXVsdDppZigiKiI9PT1lW2UubGVuZ3RoLTFdKXJldHVybiA0O2lmKCJpIj09PWVbMF0pe3ZhciB0PXBhcnNlSW50KGUuc3Vic3RyKDEpKTtyZXR1cm4geSh0JTg9PTApLHQvOH1yZXR1cm4gMH19bmV3IEFycmF5KDApO3ZhciBtPTA7ZnVuY3Rpb24geShlLHQpe2V8fHJyKCJBc3NlcnRpb24gZmFpbGVkOiAiK3QpfWZ1bmN0aW9uIEUoZSx0LHIsbil7c3dpdGNoKCIqIj09PShyPXJ8fCJpOCIpLmNoYXJBdChyLmxlbmd0aC0xKSYmKHI9ImkzMiIpLHIpe2Nhc2UiaTEiOmNhc2UiaTgiOlJbZT4+MF09dDticmVhaztjYXNlImkxNiI6Q1tlPj4xXT10O2JyZWFrO2Nhc2UiaTMyIjpGW2U+PjJdPXQ7YnJlYWs7Y2FzZSJpNjQiOnRlbXBJNjQ9W3Q+Pj4wLCh0ZW1wRG91YmxlPXQsK25lKHRlbXBEb3VibGUpPj0xP3RlbXBEb3VibGU+MD8oMHxhZSgraWUodGVtcERvdWJsZS80Mjk0OTY3Mjk2KSw0Mjk0OTY3Mjk1KSk+Pj4wOn5+K29lKCh0ZW1wRG91YmxlLSsofn50ZW1wRG91YmxlPj4+MCkpLzQyOTQ5NjcyOTYpPj4+MDowKV0sRltlPj4yXT10ZW1wSTY0WzBdLEZbZSs0Pj4yXT10ZW1wSTY0WzFdO2JyZWFrO2Nhc2UiZmxvYXQiOklbZT4+Ml09dDticmVhaztjYXNlImRvdWJsZSI6QltlPj4zXT10O2JyZWFrO2RlZmF1bHQ6cnIoImludmFsaWQgdHlwZSBmb3Igc2V0VmFsdWU6ICIrcil9fWZ1bmN0aW9uIGcoZSx0LHIsbil7dmFyIG8saTsibnVtYmVyIj09dHlwZW9mIGU/KG89ITAsaT1lKToobz0hMSxpPWUubGVuZ3RoKTt2YXIgYSxzPSJzdHJpbmciPT10eXBlb2YgdD90Om51bGw7aWYoYT00PT1yP246WyJmdW5jdGlvbiI9PXR5cGVvZiBKdD9KdDpmLFF0LGYsZF1bdm9pZCAwPT09cj8yOnJdKE1hdGgubWF4KGkscz8xOnQubGVuZ3RoKSksbyl7dmFyIHU7Zm9yKG49YSx5KDA9PSgzJmEpKSx1PWErKC00JmkpO248dTtuKz00KUZbbj4+Ml09MDtmb3IodT1hK2k7bjx1OylSW24rKz4+MF09MDtyZXR1cm4gYX1pZigiaTgiPT09cylyZXR1cm4gZS5zdWJhcnJheXx8ZS5zbGljZT9PLnNldChlLGEpOk8uc2V0KG5ldyBVaW50OEFycmF5KGUpLGEpLGE7Zm9yKHZhciBjLGwsaCxtPTA7bTxpOyl7dmFyIGc9ZVttXTswIT09KGM9c3x8dFttXSk/KCJpNjQiPT1jJiYoYz0iaTMyIiksRShhK20sZyxjKSxoIT09YyYmKGw9cChjKSxoPWMpLG0rPWwpOm0rK31yZXR1cm4gYX1mdW5jdGlvbiB2KGUsdCl7aWYoMD09PXR8fCFlKXJldHVybiIiO2Zvcih2YXIgcixuPTAsbz0wO258PXI9T1tlK28+PjBdLCgwIT1yfHx0KSYmKG8rKywhdHx8byE9dCk7KTt0fHwodD1vKTt2YXIgaT0iIjtpZihuPDEyOCl7Zm9yKHZhciBhO3Q+MDspYT1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxPLnN1YmFycmF5KGUsZStNYXRoLm1pbih0LDEwMjQpKSksaT1pP2krYTphLGUrPTEwMjQsdC09MTAyNDtyZXR1cm4gaX1yZXR1cm4gYihlKX12YXIgdz0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyP25ldyBUZXh0RGVjb2RlcigidXRmOCIpOnZvaWQgMDtmdW5jdGlvbiBfKGUsdCl7Zm9yKHZhciByPXQ7ZVtyXTspKytyO2lmKHItdD4xNiYmZS5zdWJhcnJheSYmdylyZXR1cm4gdy5kZWNvZGUoZS5zdWJhcnJheSh0LHIpKTtmb3IodmFyIG4sbyxpLGEscyx1PSIiOzspe2lmKCEobj1lW3QrK10pKXJldHVybiB1O2lmKDEyOCZuKWlmKG89NjMmZVt0KytdLDE5MiE9KDIyNCZuKSlpZihpPTYzJmVbdCsrXSwyMjQ9PSgyNDAmbik/bj0oMTUmbik8PDEyfG88PDZ8aTooYT02MyZlW3QrK10sMjQwPT0oMjQ4Jm4pP249KDcmbik8PDE4fG88PDEyfGk8PDZ8YToocz02MyZlW3QrK10sbj0yNDg9PSgyNTImbik/KDMmbik8PDI0fG88PDE4fGk8PDEyfGE8PDZ8czooMSZuKTw8MzB8bzw8MjR8aTw8MTh8YTw8MTJ8czw8Nnw2MyZlW3QrK10pKSxuPDY1NTM2KXUrPVN0cmluZy5mcm9tQ2hhckNvZGUobik7ZWxzZXt2YXIgYz1uLTY1NTM2O3UrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8Yz4+MTAsNTYzMjB8MTAyMyZjKX1lbHNlIHUrPVN0cmluZy5mcm9tQ2hhckNvZGUoKDMxJm4pPDw2fG8pO2Vsc2UgdSs9U3RyaW5nLmZyb21DaGFyQ29kZShuKX19ZnVuY3Rpb24gYihlKXtyZXR1cm4gXyhPLGUpfWZ1bmN0aW9uIEEoZSx0LHIsbil7aWYoIShuPjApKXJldHVybiAwO2Zvcih2YXIgbz1yLGk9cituLTEsYT0wO2E8ZS5sZW5ndGg7KythKXt2YXIgcz1lLmNoYXJDb2RlQXQoYSk7aWYocz49NTUyOTYmJnM8PTU3MzQzJiYocz02NTUzNisoKDEwMjMmcyk8PDEwKXwxMDIzJmUuY2hhckNvZGVBdCgrK2EpKSxzPD0xMjcpe2lmKHI+PWkpYnJlYWs7dFtyKytdPXN9ZWxzZSBpZihzPD0yMDQ3KXtpZihyKzE+PWkpYnJlYWs7dFtyKytdPTE5MnxzPj42LHRbcisrXT0xMjh8NjMmc31lbHNlIGlmKHM8PTY1NTM1KXtpZihyKzI+PWkpYnJlYWs7dFtyKytdPTIyNHxzPj4xMix0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9MjA5NzE1MSl7aWYociszPj1pKWJyZWFrO3RbcisrXT0yNDB8cz4+MTgsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9NjcxMDg4NjMpe2lmKHIrND49aSlicmVhazt0W3IrK109MjQ4fHM+PjI0LHRbcisrXT0xMjh8cz4+MTgmNjMsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2V7aWYocis1Pj1pKWJyZWFrO3RbcisrXT0yNTJ8cz4+MzAsdFtyKytdPTEyOHxzPj4yNCY2Myx0W3IrK109MTI4fHM+PjE4JjYzLHRbcisrXT0xMjh8cz4+MTImNjMsdFtyKytdPTEyOHxzPj42JjYzLHRbcisrXT0xMjh8NjMmc319cmV0dXJuIHRbcl09MCxyLW99ZnVuY3Rpb24gVChlLHQscil7cmV0dXJuIEEoZSxPLHQscil9ZnVuY3Rpb24gUyhlKXtmb3IodmFyIHQ9MCxyPTA7cjxlLmxlbmd0aDsrK3Ipe3ZhciBuPWUuY2hhckNvZGVBdChyKTtuPj01NTI5NiYmbjw9NTczNDMmJihuPTY1NTM2KygoMTAyMyZuKTw8MTApfDEwMjMmZS5jaGFyQ29kZUF0KCsrcikpLG48PTEyNz8rK3Q6dCs9bjw9MjA0Nz8yOm48PTY1NTM1PzM6bjw9MjA5NzE1MT80Om48PTY3MTA4ODYzPzU6Nn1yZXR1cm4gdH0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyJiZuZXcgVGV4dERlY29kZXIoInV0Zi0xNmxlIik7ZnVuY3Rpb24gayhlKXtmb3IodmFyIHQ9MCxyPSIiOzspe3ZhciBuPUZbZSs0KnQ+PjJdO2lmKDA9PW4pcmV0dXJuIHI7aWYoKyt0LG4+PTY1NTM2KXt2YXIgbz1uLTY1NTM2O3IrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8bz4+MTAsNTYzMjB8MTAyMyZvKX1lbHNlIHIrPVN0cmluZy5mcm9tQ2hhckNvZGUobil9fWZ1bmN0aW9uIFAoKXt2YXIgZT1mdW5jdGlvbigpe3ZhciBlPW5ldyBFcnJvcjtpZighZS5zdGFjayl7dHJ5e3Rocm93IG5ldyBFcnJvcigwKX1jYXRjaCh0KXtlPXR9aWYoIWUuc3RhY2spcmV0dXJuIihubyBzdGFjayB0cmFjZSBhdmFpbGFibGUpIn1yZXR1cm4gZS5zdGFjay50b1N0cmluZygpfSgpO3JldHVybiBvLmV4dHJhU3RhY2tUcmFjZSYmKGUrPSJcbiIrby5leHRyYVN0YWNrVHJhY2UoKSksZS5yZXBsYWNlKC9fX1pbXHdcZF9dKy9nLChmdW5jdGlvbihlKXtyZXR1cm4gZT09ZT9lOmUrIiBbIitlKyJdIn0pKX12YXIgRCxSLE8sQyxOLEYsTSxJLEIsTCx4LGosVSx6LCQ7ZnVuY3Rpb24gVyhlLHQpe3JldHVybiBlJXQ+MCYmKGUrPXQtZSV0KSxlfWZ1bmN0aW9uIFkoZSl7by5idWZmZXI9RD1lfWZ1bmN0aW9uIFYoKXtvLkhFQVA4PVI9bmV3IEludDhBcnJheShEKSxvLkhFQVAxNj1DPW5ldyBJbnQxNkFycmF5KEQpLG8uSEVBUDMyPUY9bmV3IEludDMyQXJyYXkoRCksby5IRUFQVTg9Tz1uZXcgVWludDhBcnJheShEKSxvLkhFQVBVMTY9Tj1uZXcgVWludDE2QXJyYXkoRCksby5IRUFQVTMyPU09bmV3IFVpbnQzMkFycmF5KEQpLG8uSEVBUEYzMj1JPW5ldyBGbG9hdDMyQXJyYXkoRCksby5IRUFQRjY0PUI9bmV3IEZsb2F0NjRBcnJheShEKX1mdW5jdGlvbiBIKCl7dmFyIGU9by51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYsdD0yMTQ3NDgzNjQ4LWU7aWYoRlskPj4yXT50KXJldHVybiExO3ZhciByPXE7Zm9yKHE9TWF0aC5tYXgocSwxNjc3NzIxNik7cTxGWyQ+PjJdOylxPXE8PTUzNjg3MDkxMj9XKDIqcSxlKTpNYXRoLm1pbihXKCgzKnErMjE0NzQ4MzY0OCkvNCxlKSx0KTt2YXIgbj1vLnJlYWxsb2NCdWZmZXIocSk7cmV0dXJuIG4mJm4uYnl0ZUxlbmd0aD09cT8oWShuKSxWKCksITApOihxPXIsITEpfUw9VT0kPTAseD0hMSxvLnJlYWxsb2NCdWZmZXJ8fChvLnJlYWxsb2NCdWZmZXI9ZnVuY3Rpb24oZSl7dmFyIHQ7dHJ5e2lmKEFycmF5QnVmZmVyLnRyYW5zZmVyKXQ9QXJyYXlCdWZmZXIudHJhbnNmZXIoRCxlKTtlbHNle3ZhciByPVI7dD1uZXcgQXJyYXlCdWZmZXIoZSksbmV3IEludDhBcnJheSh0KS5zZXQocil9fWNhdGNoKGUpe3JldHVybiExfXJldHVybiEhWHQodCkmJnR9KTt0cnl7RnVuY3Rpb24ucHJvdG90eXBlLmNhbGwuYmluZChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEFycmF5QnVmZmVyLnByb3RvdHlwZSwiYnl0ZUxlbmd0aCIpLmdldCkobmV3IEFycmF5QnVmZmVyKDQpKX1jYXRjaChlKXsoZnVuY3Rpb24oZSl7cmV0dXJuIGUuYnl0ZUxlbmd0aH0pfXZhciBHPW8uVE9UQUxfU1RBQ0t8fDUyNDI4ODAscT1vLlRPVEFMX01FTU9SWXx8MTY3NzcyMTY7aWYocTxHJiZvLnByaW50RXJyKCJUT1RBTF9NRU1PUlkgc2hvdWxkIGJlIGxhcmdlciB0aGFuIFRPVEFMX1NUQUNLLCB3YXMgIitxKyIhIChUT1RBTF9TVEFDSz0iK0crIikiKSxvLmJ1ZmZlcj9EPW8uYnVmZmVyOigib2JqZWN0Ij09dHlwZW9mIFdlYkFzc2VtYmx5JiYiZnVuY3Rpb24iPT10eXBlb2YgV2ViQXNzZW1ibHkuTWVtb3J5PyhvLndhc21NZW1vcnk9bmV3IFdlYkFzc2VtYmx5Lk1lbW9yeSh7aW5pdGlhbDpxLzY1NTM2fSksRD1vLndhc21NZW1vcnkuYnVmZmVyKTpEPW5ldyBBcnJheUJ1ZmZlcihxKSxvLmJ1ZmZlcj1EKSxWKCksRlswXT0xNjY4NTA5MDI5LENbMV09MjU0NTksMTE1IT09T1syXXx8OTkhPT1PWzNdKXRocm93IlJ1bnRpbWUgZXJyb3I6IGV4cGVjdGVkIHRoZSBzeXN0ZW0gdG8gYmUgbGl0dGxlLWVuZGlhbiEiO2Z1bmN0aW9uIFgoZSl7Zm9yKDtlLmxlbmd0aD4wOyl7dmFyIHQ9ZS5zaGlmdCgpO2lmKCJmdW5jdGlvbiIhPXR5cGVvZiB0KXt2YXIgcj10LmZ1bmM7Im51bWJlciI9PXR5cGVvZiByP3ZvaWQgMD09PXQuYXJnP28uZHluQ2FsbF92KHIpOm8uZHluQ2FsbF92aShyLHQuYXJnKTpyKHZvaWQgMD09PXQuYXJnP251bGw6dC5hcmcpfWVsc2UgdCgpfX12YXIgSz1bXSxKPVtdLFo9W10sUT1bXSxlZT1bXSx0ZT0hMTtmdW5jdGlvbiByZShlLHQscil7Zm9yKHZhciBuPTA7bjxlLmxlbmd0aDsrK24pUlt0Kys+PjBdPWUuY2hhckNvZGVBdChuKTtyfHwoUlt0Pj4wXT0wKX12YXIgbmU9TWF0aC5hYnMsb2U9TWF0aC5jZWlsLGllPU1hdGguZmxvb3IsYWU9TWF0aC5taW4sc2U9MCx1ZT1udWxsO2Z1bmN0aW9uIGNlKGUpe3NlKyssby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpfWZ1bmN0aW9uIGxlKGUpe2lmKHNlLS0sby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpLDA9PXNlJiZ1ZSl7dmFyIHQ9dWU7dWU9bnVsbCx0KCl9fW8ucHJlbG9hZGVkSW1hZ2VzPXt9LG8ucHJlbG9hZGVkQXVkaW9zPXt9O2Z1bmN0aW9uIGZlKGUpe3JldHVybiBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGg/ZS5zdGFydHNXaXRoKCJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIik6MD09PWUuaW5kZXhPZigiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpfSFmdW5jdGlvbigpe3ZhciB0PSJ1bnBhY2sud2FzdCIscj0idW5wYWNrLnRlbXAuYXNtLmpzIjsiZnVuY3Rpb24iPT10eXBlb2Ygby5sb2NhdGVGaWxlJiYoZmUodCl8fCh0PW8ubG9jYXRlRmlsZSh0KSksZmUoZSl8fChlPW8ubG9jYXRlRmlsZShlKSksZmUocil8fChyPW8ubG9jYXRlRmlsZShyKSkpO3ZhciBuPXtnbG9iYWw6bnVsbCxlbnY6bnVsbCxhc20yd2FzbTp7ImY2NC1yZW0iOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUldH0sZGVidWdnZXI6ZnVuY3Rpb24oKXt9fSxwYXJlbnQ6b30saT1udWxsO2Z1bmN0aW9uIGEoKXt0cnl7aWYoby53YXNtQmluYXJ5KXJldHVybiBuZXcgVWludDhBcnJheShvLndhc21CaW5hcnkpO2lmKG8ucmVhZEJpbmFyeSlyZXR1cm4gby5yZWFkQmluYXJ5KGUpO3Rocm93Im9uIHRoZSB3ZWIsIHdlIG5lZWQgdGhlIHdhc20gYmluYXJ5IHRvIGJlIHByZWxvYWRlZCBhbmQgc2V0IG9uIE1vZHVsZVsnd2FzbUJpbmFyeSddLiBlbWNjLnB5IHdpbGwgZG8gdGhhdCBmb3IgeW91IHdoZW4gZ2VuZXJhdGluZyBIVE1MIChidXQgbm90IEpTKSJ9Y2F0Y2goZSl7cnIoZSl9fWZ1bmN0aW9uIHModCxyLHMpe2lmKCJvYmplY3QiIT10eXBlb2YgV2ViQXNzZW1ibHkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKSwhMTtpZighKG8ud2FzbU1lbW9yeSBpbnN0YW5jZW9mIFdlYkFzc2VtYmx5Lk1lbW9yeSkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIE1lbW9yeSBpbiB1c2UiKSwhMTtmdW5jdGlvbiBsKGUsdCl7KGk9ZS5leHBvcnRzKS5tZW1vcnkmJmZ1bmN0aW9uKGUpe3ZhciB0PW8uYnVmZmVyO2UuYnl0ZUxlbmd0aDx0LmJ5dGVMZW5ndGgmJm8ucHJpbnRFcnIoInRoZSBuZXcgYnVmZmVyIGluIG1lcmdlTWVtb3J5IGlzIHNtYWxsZXIgdGhhbiB0aGUgcHJldmlvdXMgb25lLiBpbiBuYXRpdmUgd2FzbSwgd2Ugc2hvdWxkIGdyb3cgbWVtb3J5IGhlcmUiKTt2YXIgcj1uZXcgSW50OEFycmF5KHQpO25ldyBJbnQ4QXJyYXkoZSkuc2V0KHIpLFkoZSksVigpfShpLm1lbW9yeSksby5hc209aSxvLnVzaW5nV2FzbT0hMCxsZSgpfWlmKHIubWVtb3J5PW8ud2FzbU1lbW9yeSxuLmdsb2JhbD17TmFOOk5hTixJbmZpbml0eToxLzB9LG5bImdsb2JhbC5NYXRoIl09TWF0aCxuLmVudj1yLGNlKCksby5pbnN0YW50aWF0ZVdhc20pdHJ5e3JldHVybiBvLmluc3RhbnRpYXRlV2FzbShuLGwpfWNhdGNoKGUpe3JldHVybiBvLnByaW50RXJyKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiK2UpLCExfWZ1bmN0aW9uIGYoZSl7bChlLmluc3RhbmNlLGUubW9kdWxlKX1mdW5jdGlvbiBkKHQpeyhvLndhc21CaW5hcnl8fCF1JiYhY3x8ImZ1bmN0aW9uIiE9dHlwZW9mIGZldGNoP25ldyBQcm9taXNlKChmdW5jdGlvbihlLHQpe2UoYSgpKX0pKTpmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KS50aGVuKChmdW5jdGlvbih0KXtpZighdC5vayl0aHJvdyJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciK2UrIiciO3JldHVybiB0LmFycmF5QnVmZmVyKCl9KSkuY2F0Y2goKGZ1bmN0aW9uKCl7cmV0dXJuIGEoKX0pKSkudGhlbigoZnVuY3Rpb24oZSl7cmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGUsbil9KSkudGhlbih0KS5jYXRjaCgoZnVuY3Rpb24oZSl7by5wcmludEVycigiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIitlKSxycihlKX0pKX1yZXR1cm4gby53YXNtQmluYXJ5fHwiZnVuY3Rpb24iIT10eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmd8fGZlKGUpfHwiZnVuY3Rpb24iIT10eXBlb2YgZmV0Y2g/ZChmKTpXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KSxuKS50aGVuKGYpLmNhdGNoKChmdW5jdGlvbihlKXtvLnByaW50RXJyKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIitlKSxvLnByaW50RXJyKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpLGQoZil9KSkse319by5hc21QcmVsb2FkPW8uYXNtLG8ucmVhbGxvY0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7ZT1XKGUsby51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYpO3ZhciB0PW8uYnVmZmVyLmJ5dGVMZW5ndGg7aWYoby51c2luZ1dhc20pdHJ5e3JldHVybi0xIT09by53YXNtTWVtb3J5Lmdyb3coKGUtdCkvNjU1MzYpP28uYnVmZmVyPW8ud2FzbU1lbW9yeS5idWZmZXI6bnVsbH1jYXRjaChlKXtyZXR1cm4gbnVsbH19KGUpfSxvLmFzbT1mdW5jdGlvbihlLHQscil7aWYoISh0PXQpLnRhYmxlKXt2YXIgbj1vLndhc21UYWJsZVNpemU7dm9pZCAwPT09biYmKG49MTAyNCk7dmFyIGk9by53YXNtTWF4VGFibGVTaXplOyJvYmplY3QiPT10eXBlb2YgV2ViQXNzZW1ibHkmJiJmdW5jdGlvbiI9PXR5cGVvZiBXZWJBc3NlbWJseS5UYWJsZT90LnRhYmxlPXZvaWQgMCE9PWk/bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sbWF4aW11bTppLGVsZW1lbnQ6ImFueWZ1bmMifSk6bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sZWxlbWVudDoiYW55ZnVuYyJ9KTp0LnRhYmxlPW5ldyBBcnJheShuKSxvLndhc21UYWJsZT10LnRhYmxlfXZhciBhO3JldHVybiB0Lm1lbW9yeUJhc2V8fCh0Lm1lbW9yeUJhc2U9by5TVEFUSUNfQkFTRSksdC50YWJsZUJhc2V8fCh0LnRhYmxlQmFzZT0wKSwoYT1zKDAsdCkpfHxycigibm8gYmluYXJ5ZW4gbWV0aG9kIHN1Y2NlZWRlZC4gY29uc2lkZXIgZW5hYmxpbmcgbW9yZSBvcHRpb25zLCBsaWtlIGludGVycHJldGluZywgaWYgeW91IHdhbnQgdGhhdDogaHR0cHM6Ly9naXRodWIuY29tL2tyaXBrZW4vZW1zY3JpcHRlbi93aWtpL1dlYkFzc2VtYmx5I2JpbmFyeWVuLW1ldGhvZHMiKSxhfX0oKSxMPTY3OTg0LEoucHVzaCh7ZnVuYzpmdW5jdGlvbigpe0d0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe0h0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1Z0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1l0KCl9fSk7by5TVEFUSUNfQkFTRT0xMDI0LG8uU1RBVElDX0JVTVA9NjY5NjAsTCs9MTY7dmFyIGRlPXtsYXN0OjAsY2F1Z2h0OltdLGluZm9zOnt9LGRlQWRqdXN0OmZ1bmN0aW9uKGUpe2lmKCFlfHxkZS5pbmZvc1tlXSlyZXR1cm4gZTtmb3IodmFyIHQgaW4gZGUuaW5mb3Mpe3ZhciByPSt0O2lmKGRlLmluZm9zW3JdLmFkanVzdGVkPT09ZSlyZXR1cm4gcn1yZXR1cm4gZX0sYWRkUmVmOmZ1bmN0aW9uKGUpe2UmJmRlLmluZm9zW2VdLnJlZmNvdW50Kyt9LGRlY1JlZjpmdW5jdGlvbihlKXtpZihlKXt2YXIgdD1kZS5pbmZvc1tlXTt5KHQucmVmY291bnQ+MCksdC5yZWZjb3VudC0tLDAhPT10LnJlZmNvdW50fHx0LnJldGhyb3dufHwodC5kZXN0cnVjdG9yJiZvLmR5bkNhbGxfdmkodC5kZXN0cnVjdG9yLGUpLGRlbGV0ZSBkZS5pbmZvc1tlXSxoZShlKSl9fSxjbGVhclJlZjpmdW5jdGlvbihlKXtlJiYoZGUuaW5mb3NbZV0ucmVmY291bnQ9MCl9fTtmdW5jdGlvbiBoZShlKXt0cnl7cmV0dXJuIEt0KGUpfWNhdGNoKGUpe319ZnVuY3Rpb24gcGUoKXt2YXIgZT1kZS5sYXN0O2lmKCFlKXJldHVybiAwfChadCgwKSwwKTt2YXIgdD1kZS5pbmZvc1tlXSxyPXQudHlwZTtpZighcilyZXR1cm4gMHwoWnQoMCksZSk7dmFyIG49QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTtvLl9fX2N4YV9pc19wb2ludGVyX3R5cGUocik7cGUuYnVmZmVyfHwocGUuYnVmZmVyPUp0KDQpKSxGW3BlLmJ1ZmZlcj4+Ml09ZSxlPXBlLmJ1ZmZlcjtmb3IodmFyIGk9MDtpPG4ubGVuZ3RoO2krKylpZihuW2ldJiZvLl9fX2N4YV9jYW5fY2F0Y2gobltpXSxyLGUpKXJldHVybiBlPUZbZT4+Ml0sdC5hZGp1c3RlZD1lLDB8KFp0KG5baV0pLGUpO3JldHVybiBlPUZbZT4+Ml0sMHwoWnQociksZSl9dmFyIG1lPXtFUEVSTToxLEVOT0VOVDoyLEVTUkNIOjMsRUlOVFI6NCxFSU86NSxFTlhJTzo2LEUyQklHOjcsRU5PRVhFQzo4LEVCQURGOjksRUNISUxEOjEwLEVBR0FJTjoxMSxFV09VTERCTE9DSzoxMSxFTk9NRU06MTIsRUFDQ0VTOjEzLEVGQVVMVDoxNCxFTk9UQkxLOjE1LEVCVVNZOjE2LEVFWElTVDoxNyxFWERFVjoxOCxFTk9ERVY6MTksRU5PVERJUjoyMCxFSVNESVI6MjEsRUlOVkFMOjIyLEVORklMRToyMyxFTUZJTEU6MjQsRU5PVFRZOjI1LEVUWFRCU1k6MjYsRUZCSUc6MjcsRU5PU1BDOjI4LEVTUElQRToyOSxFUk9GUzozMCxFTUxJTks6MzEsRVBJUEU6MzIsRURPTTozMyxFUkFOR0U6MzQsRU5PTVNHOjQyLEVJRFJNOjQzLEVDSFJORzo0NCxFTDJOU1lOQzo0NSxFTDNITFQ6NDYsRUwzUlNUOjQ3LEVMTlJORzo0OCxFVU5BVENIOjQ5LEVOT0NTSTo1MCxFTDJITFQ6NTEsRURFQURMSzozNSxFTk9MQ0s6MzcsRUJBREU6NTIsRUJBRFI6NTMsRVhGVUxMOjU0LEVOT0FOTzo1NSxFQkFEUlFDOjU2LEVCQURTTFQ6NTcsRURFQURMT0NLOjM1LEVCRk9OVDo1OSxFTk9TVFI6NjAsRU5PREFUQTo2MSxFVElNRTo2MixFTk9TUjo2MyxFTk9ORVQ6NjQsRU5PUEtHOjY1LEVSRU1PVEU6NjYsRU5PTElOSzo2NyxFQURWOjY4LEVTUk1OVDo2OSxFQ09NTTo3MCxFUFJPVE86NzEsRU1VTFRJSE9QOjcyLEVET1RET1Q6NzMsRUJBRE1TRzo3NCxFTk9UVU5JUTo3NixFQkFERkQ6NzcsRVJFTUNIRzo3OCxFTElCQUNDOjc5LEVMSUJCQUQ6ODAsRUxJQlNDTjo4MSxFTElCTUFYOjgyLEVMSUJFWEVDOjgzLEVOT1NZUzozOCxFTk9URU1QVFk6MzksRU5BTUVUT09MT05HOjM2LEVMT09QOjQwLEVPUE5PVFNVUFA6OTUsRVBGTk9TVVBQT1JUOjk2LEVDT05OUkVTRVQ6MTA0LEVOT0JVRlM6MTA1LEVBRk5PU1VQUE9SVDo5NyxFUFJPVE9UWVBFOjkxLEVOT1RTT0NLOjg4LEVOT1BST1RPT1BUOjkyLEVTSFVURE9XTjoxMDgsRUNPTk5SRUZVU0VEOjExMSxFQUREUklOVVNFOjk4LEVDT05OQUJPUlRFRDoxMDMsRU5FVFVOUkVBQ0g6MTAxLEVORVRET1dOOjEwMCxFVElNRURPVVQ6MTEwLEVIT1NURE9XTjoxMTIsRUhPU1RVTlJFQUNIOjExMyxFSU5QUk9HUkVTUzoxMTUsRUFMUkVBRFk6MTE0LEVERVNUQUREUlJFUTo4OSxFTVNHU0laRTo5MCxFUFJPVE9OT1NVUFBPUlQ6OTMsRVNPQ0tUTk9TVVBQT1JUOjk0LEVBRERSTk9UQVZBSUw6OTksRU5FVFJFU0VUOjEwMixFSVNDT05OOjEwNixFTk9UQ09OTjoxMDcsRVRPT01BTllSRUZTOjEwOSxFVVNFUlM6ODcsRURRVU9UOjEyMixFU1RBTEU6MTE2LEVOT1RTVVA6OTUsRU5PTUVESVVNOjEyMyxFSUxTRVE6ODQsRU9WRVJGTE9XOjc1LEVDQU5DRUxFRDoxMjUsRU5PVFJFQ09WRVJBQkxFOjEzMSxFT1dORVJERUFEOjEzMCxFU1RSUElQRTo4Nn07ZnVuY3Rpb24geWUoZSl7cmV0dXJuIG8uX19fZXJybm9fbG9jYXRpb24mJihGW28uX19fZXJybm9fbG9jYXRpb24oKT4+Ml09ZSksZX12YXIgRWU9ezA6IlN1Y2Nlc3MiLDE6Ik5vdCBzdXBlci11c2VyIiwyOiJObyBzdWNoIGZpbGUgb3IgZGlyZWN0b3J5IiwzOiJObyBzdWNoIHByb2Nlc3MiLDQ6IkludGVycnVwdGVkIHN5c3RlbSBjYWxsIiw1OiJJL08gZXJyb3IiLDY6Ik5vIHN1Y2ggZGV2aWNlIG9yIGFkZHJlc3MiLDc6IkFyZyBsaXN0IHRvbyBsb25nIiw4OiJFeGVjIGZvcm1hdCBlcnJvciIsOToiQmFkIGZpbGUgbnVtYmVyIiwxMDoiTm8gY2hpbGRyZW4iLDExOiJObyBtb3JlIHByb2Nlc3NlcyIsMTI6Ik5vdCBlbm91Z2ggY29yZSIsMTM6IlBlcm1pc3Npb24gZGVuaWVkIiwxNDoiQmFkIGFkZHJlc3MiLDE1OiJCbG9jayBkZXZpY2UgcmVxdWlyZWQiLDE2OiJNb3VudCBkZXZpY2UgYnVzeSIsMTc6IkZpbGUgZXhpc3RzIiwxODoiQ3Jvc3MtZGV2aWNlIGxpbmsiLDE5OiJObyBzdWNoIGRldmljZSIsMjA6Ik5vdCBhIGRpcmVjdG9yeSIsMjE6IklzIGEgZGlyZWN0b3J5IiwyMjoiSW52YWxpZCBhcmd1bWVudCIsMjM6IlRvbyBtYW55IG9wZW4gZmlsZXMgaW4gc3lzdGVtIiwyNDoiVG9vIG1hbnkgb3BlbiBmaWxlcyIsMjU6Ik5vdCBhIHR5cGV3cml0ZXIiLDI2OiJUZXh0IGZpbGUgYnVzeSIsMjc6IkZpbGUgdG9vIGxhcmdlIiwyODoiTm8gc3BhY2UgbGVmdCBvbiBkZXZpY2UiLDI5OiJJbGxlZ2FsIHNlZWsiLDMwOiJSZWFkIG9ubHkgZmlsZSBzeXN0ZW0iLDMxOiJUb28gbWFueSBsaW5rcyIsMzI6IkJyb2tlbiBwaXBlIiwzMzoiTWF0aCBhcmcgb3V0IG9mIGRvbWFpbiBvZiBmdW5jIiwzNDoiTWF0aCByZXN1bHQgbm90IHJlcHJlc2VudGFibGUiLDM1OiJGaWxlIGxvY2tpbmcgZGVhZGxvY2sgZXJyb3IiLDM2OiJGaWxlIG9yIHBhdGggbmFtZSB0b28gbG9uZyIsMzc6Ik5vIHJlY29yZCBsb2NrcyBhdmFpbGFibGUiLDM4OiJGdW5jdGlvbiBub3QgaW1wbGVtZW50ZWQiLDM5OiJEaXJlY3Rvcnkgbm90IGVtcHR5Iiw0MDoiVG9vIG1hbnkgc3ltYm9saWMgbGlua3MiLDQyOiJObyBtZXNzYWdlIG9mIGRlc2lyZWQgdHlwZSIsNDM6IklkZW50aWZpZXIgcmVtb3ZlZCIsNDQ6IkNoYW5uZWwgbnVtYmVyIG91dCBvZiByYW5nZSIsNDU6IkxldmVsIDIgbm90IHN5bmNocm9uaXplZCIsNDY6IkxldmVsIDMgaGFsdGVkIiw0NzoiTGV2ZWwgMyByZXNldCIsNDg6IkxpbmsgbnVtYmVyIG91dCBvZiByYW5nZSIsNDk6IlByb3RvY29sIGRyaXZlciBub3QgYXR0YWNoZWQiLDUwOiJObyBDU0kgc3RydWN0dXJlIGF2YWlsYWJsZSIsNTE6IkxldmVsIDIgaGFsdGVkIiw1MjoiSW52YWxpZCBleGNoYW5nZSIsNTM6IkludmFsaWQgcmVxdWVzdCBkZXNjcmlwdG9yIiw1NDoiRXhjaGFuZ2UgZnVsbCIsNTU6Ik5vIGFub2RlIiw1NjoiSW52YWxpZCByZXF1ZXN0IGNvZGUiLDU3OiJJbnZhbGlkIHNsb3QiLDU5OiJCYWQgZm9udCBmaWxlIGZtdCIsNjA6IkRldmljZSBub3QgYSBzdHJlYW0iLDYxOiJObyBkYXRhIChmb3Igbm8gZGVsYXkgaW8pIiw2MjoiVGltZXIgZXhwaXJlZCIsNjM6Ik91dCBvZiBzdHJlYW1zIHJlc291cmNlcyIsNjQ6Ik1hY2hpbmUgaXMgbm90IG9uIHRoZSBuZXR3b3JrIiw2NToiUGFja2FnZSBub3QgaW5zdGFsbGVkIiw2NjoiVGhlIG9iamVjdCBpcyByZW1vdGUiLDY3OiJUaGUgbGluayBoYXMgYmVlbiBzZXZlcmVkIiw2ODoiQWR2ZXJ0aXNlIGVycm9yIiw2OToiU3Jtb3VudCBlcnJvciIsNzA6IkNvbW11bmljYXRpb24gZXJyb3Igb24gc2VuZCIsNzE6IlByb3RvY29sIGVycm9yIiw3MjoiTXVsdGlob3AgYXR0ZW1wdGVkIiw3MzoiQ3Jvc3MgbW91bnQgcG9pbnQgKG5vdCByZWFsbHkgZXJyb3IpIiw3NDoiVHJ5aW5nIHRvIHJlYWQgdW5yZWFkYWJsZSBtZXNzYWdlIiw3NToiVmFsdWUgdG9vIGxhcmdlIGZvciBkZWZpbmVkIGRhdGEgdHlwZSIsNzY6IkdpdmVuIGxvZy4gbmFtZSBub3QgdW5pcXVlIiw3NzoiZi5kLiBpbnZhbGlkIGZvciB0aGlzIG9wZXJhdGlvbiIsNzg6IlJlbW90ZSBhZGRyZXNzIGNoYW5nZWQiLDc5OiJDYW4gICBhY2Nlc3MgYSBuZWVkZWQgc2hhcmVkIGxpYiIsODA6IkFjY2Vzc2luZyBhIGNvcnJ1cHRlZCBzaGFyZWQgbGliIiw4MToiLmxpYiBzZWN0aW9uIGluIGEub3V0IGNvcnJ1cHRlZCIsODI6IkF0dGVtcHRpbmcgdG8gbGluayBpbiB0b28gbWFueSBsaWJzIiw4MzoiQXR0ZW1wdGluZyB0byBleGVjIGEgc2hhcmVkIGxpYnJhcnkiLDg0OiJJbGxlZ2FsIGJ5dGUgc2VxdWVuY2UiLDg2OiJTdHJlYW1zIHBpcGUgZXJyb3IiLDg3OiJUb28gbWFueSB1c2VycyIsODg6IlNvY2tldCBvcGVyYXRpb24gb24gbm9uLXNvY2tldCIsODk6IkRlc3RpbmF0aW9uIGFkZHJlc3MgcmVxdWlyZWQiLDkwOiJNZXNzYWdlIHRvbyBsb25nIiw5MToiUHJvdG9jb2wgd3JvbmcgdHlwZSBmb3Igc29ja2V0Iiw5MjoiUHJvdG9jb2wgbm90IGF2YWlsYWJsZSIsOTM6IlVua25vd24gcHJvdG9jb2wiLDk0OiJTb2NrZXQgdHlwZSBub3Qgc3VwcG9ydGVkIiw5NToiTm90IHN1cHBvcnRlZCIsOTY6IlByb3RvY29sIGZhbWlseSBub3Qgc3VwcG9ydGVkIiw5NzoiQWRkcmVzcyBmYW1pbHkgbm90IHN1cHBvcnRlZCBieSBwcm90b2NvbCBmYW1pbHkiLDk4OiJBZGRyZXNzIGFscmVhZHkgaW4gdXNlIiw5OToiQWRkcmVzcyBub3QgYXZhaWxhYmxlIiwxMDA6Ik5ldHdvcmsgaW50ZXJmYWNlIGlzIG5vdCBjb25maWd1cmVkIiwxMDE6Ik5ldHdvcmsgaXMgdW5yZWFjaGFibGUiLDEwMjoiQ29ubmVjdGlvbiByZXNldCBieSBuZXR3b3JrIiwxMDM6IkNvbm5lY3Rpb24gYWJvcnRlZCIsMTA0OiJDb25uZWN0aW9uIHJlc2V0IGJ5IHBlZXIiLDEwNToiTm8gYnVmZmVyIHNwYWNlIGF2YWlsYWJsZSIsMTA2OiJTb2NrZXQgaXMgYWxyZWFkeSBjb25uZWN0ZWQiLDEwNzoiU29ja2V0IGlzIG5vdCBjb25uZWN0ZWQiLDEwODoiQ2FuJ3Qgc2VuZCBhZnRlciBzb2NrZXQgc2h1dGRvd24iLDEwOToiVG9vIG1hbnkgcmVmZXJlbmNlcyIsMTEwOiJDb25uZWN0aW9uIHRpbWVkIG91dCIsMTExOiJDb25uZWN0aW9uIHJlZnVzZWQiLDExMjoiSG9zdCBpcyBkb3duIiwxMTM6Ikhvc3QgaXMgdW5yZWFjaGFibGUiLDExNDoiU29ja2V0IGFscmVhZHkgY29ubmVjdGVkIiwxMTU6IkNvbm5lY3Rpb24gYWxyZWFkeSBpbiBwcm9ncmVzcyIsMTE2OiJTdGFsZSBmaWxlIGhhbmRsZSIsMTIyOiJRdW90YSBleGNlZWRlZCIsMTIzOiJObyBtZWRpdW0gKGluIHRhcGUgZHJpdmUpIiwxMjU6Ik9wZXJhdGlvbiBjYW5jZWxlZCIsMTMwOiJQcmV2aW91cyBvd25lciBkaWVkIiwxMzE6IlN0YXRlIG5vdCByZWNvdmVyYWJsZSJ9LGdlPXtzcGxpdFBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuL14oXC8/fCkoW1xzXFNdKj8pKCg/OlwuezEsMn18W15cL10rP3wpKFwuW14uXC9dKnwpKSg/OltcL10qKSQvLmV4ZWMoZSkuc2xpY2UoMSl9LG5vcm1hbGl6ZUFycmF5OmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPTAsbj1lLmxlbmd0aC0xO24+PTA7bi0tKXt2YXIgbz1lW25dOyIuIj09PW8/ZS5zcGxpY2UobiwxKToiLi4iPT09bz8oZS5zcGxpY2UobiwxKSxyKyspOnImJihlLnNwbGljZShuLDEpLHItLSl9aWYodClmb3IoO3I7ci0tKWUudW5zaGlmdCgiLi4iKTtyZXR1cm4gZX0sbm9ybWFsaXplOmZ1bmN0aW9uKGUpe3ZhciB0PSIvIj09PWUuY2hhckF0KDApLHI9Ii8iPT09ZS5zdWJzdHIoLTEpO3JldHVybihlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8dHx8KGU9Ii4iKSxlJiZyJiYoZSs9Ii8iKSwodD8iLyI6IiIpK2V9LGRpcm5hbWU6ZnVuY3Rpb24oZSl7dmFyIHQ9Z2Uuc3BsaXRQYXRoKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSxiYXNlbmFtZTpmdW5jdGlvbihlKXtpZigiLyI9PT1lKXJldHVybiIvIjt2YXIgdD1lLmxhc3RJbmRleE9mKCIvIik7cmV0dXJuLTE9PT10P2U6ZS5zdWJzdHIodCsxKX0sZXh0bmFtZTpmdW5jdGlvbihlKXtyZXR1cm4gZ2Uuc3BsaXRQYXRoKGUpWzNdfSxqb2luOmZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiBnZS5ub3JtYWxpemUoZS5qb2luKCIvIikpfSxqb2luMjpmdW5jdGlvbihlLHQpe3JldHVybiBnZS5ub3JtYWxpemUoZSsiLyIrdCl9LHJlc29sdmU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9IiIsdD0hMSxyPWFyZ3VtZW50cy5sZW5ndGgtMTtyPj0tMSYmIXQ7ci0tKXt2YXIgbj1yPj0wP2FyZ3VtZW50c1tyXTpUZS5jd2QoKTtpZigic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnRzIHRvIHBhdGgucmVzb2x2ZSBtdXN0IGJlIHN0cmluZ3MiKTtpZighbilyZXR1cm4iIjtlPW4rIi8iK2UsdD0iLyI9PT1uLmNoYXJBdCgwKX1yZXR1cm4odD8iLyI6IiIpKyhlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8Ii4ifSxyZWxhdGl2ZTpmdW5jdGlvbihlLHQpe2Z1bmN0aW9uIHIoZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9Z2UucmVzb2x2ZShlKS5zdWJzdHIoMSksdD1nZS5yZXNvbHZlKHQpLnN1YnN0cigxKTtmb3IodmFyIG49cihlLnNwbGl0KCIvIikpLG89cih0LnNwbGl0KCIvIikpLGk9TWF0aC5taW4obi5sZW5ndGgsby5sZW5ndGgpLGE9aSxzPTA7czxpO3MrKylpZihuW3NdIT09b1tzXSl7YT1zO2JyZWFrfXZhciB1PVtdO2ZvcihzPWE7czxuLmxlbmd0aDtzKyspdS5wdXNoKCIuLiIpO3JldHVybih1PXUuY29uY2F0KG8uc2xpY2UoYSkpKS5qb2luKCIvIil9fSx2ZT17dHR5czpbXSxpbml0OmZ1bmN0aW9uKCl7fSxzaHV0ZG93bjpmdW5jdGlvbigpe30scmVnaXN0ZXI6ZnVuY3Rpb24oZSx0KXt2ZS50dHlzW2VdPXtpbnB1dDpbXSxvdXRwdXQ6W10sb3BzOnR9LFRlLnJlZ2lzdGVyRGV2aWNlKGUsdmUuc3RyZWFtX29wcyl9LHN0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9dmUudHR5c1tlLm5vZGUucmRldl07aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtlLnR0eT10LGUuc2Vla2FibGU9ITF9LGNsb3NlOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LGZsdXNoOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMuZ2V0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wLGE9MDthPG47YSsrKXt2YXIgczt0cnl7cz1lLnR0eS5vcHMuZ2V0X2NoYXIoZS50dHkpfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9aWYodm9pZCAwPT09cyYmMD09PWkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFHQUlOKTtpZihudWxsPT1zKWJyZWFrO2krKyx0W3IrYV09c31yZXR1cm4gaSYmKGUubm9kZS50aW1lc3RhbXA9RGF0ZS5ub3coKSksaX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMucHV0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wO2k8bjtpKyspdHJ5e2UudHR5Lm9wcy5wdXRfY2hhcihlLnR0eSx0W3IraV0pfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9cmV0dXJuIG4mJihlLm5vZGUudGltZXN0YW1wPURhdGUubm93KCkpLGl9fSxkZWZhdWx0X3R0eV9vcHM6e2dldF9jaGFyOmZ1bmN0aW9uKGUpe2lmKCFlLmlucHV0Lmxlbmd0aCl7dmFyIHQ9bnVsbDtpZihsKXt2YXIgcj1uZXcgQnVmZmVyKDI1Niksbj0wLG89IndpbjMyIiE9cHJvY2Vzcy5wbGF0Zm9ybSxpPXByb2Nlc3Muc3RkaW4uZmQ7aWYobyl7dmFyIGE9ITE7dHJ5e2k9ZnMub3BlblN5bmMoIi9kZXYvc3RkaW4iLCJyIiksYT0hMH1jYXRjaChlKXt9fXRyeXtuPWZzLnJlYWRTeW5jKGksciwwLDI1NixudWxsKX1jYXRjaChlKXtpZigtMT09ZS50b1N0cmluZygpLmluZGV4T2YoIkVPRiIpKXRocm93IGU7bj0wfWEmJmZzLmNsb3NlU3luYyhpKSx0PW4+MD9yLnNsaWNlKDAsbikudG9TdHJpbmcoInV0Zi04Iik6bnVsbH1lbHNlInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJiJmdW5jdGlvbiI9PXR5cGVvZiB3aW5kb3cucHJvbXB0P251bGwhPT0odD13aW5kb3cucHJvbXB0KCJJbnB1dDogIikpJiYodCs9IlxuIik6ImZ1bmN0aW9uIj09dHlwZW9mIHJlYWRsaW5lJiZudWxsIT09KHQ9cmVhZGxpbmUoKSkmJih0Kz0iXG4iKTtpZighdClyZXR1cm4gbnVsbDtlLmlucHV0PSR0KHQsITApfXJldHVybiBlLmlucHV0LnNoaWZ0KCl9LHB1dF9jaGFyOmZ1bmN0aW9uKGUsdCl7bnVsbD09PXR8fDEwPT09dD8oby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSk6MCE9dCYmZS5vdXRwdXQucHVzaCh0KX0sZmx1c2g6ZnVuY3Rpb24oZSl7ZS5vdXRwdXQmJmUub3V0cHV0Lmxlbmd0aD4wJiYoby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSl9fSxkZWZhdWx0X3R0eTFfb3BzOntwdXRfY2hhcjpmdW5jdGlvbihlLHQpe251bGw9PT10fHwxMD09PXQ/KG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pOjAhPXQmJmUub3V0cHV0LnB1c2godCl9LGZsdXNoOmZ1bmN0aW9uKGUpe2Uub3V0cHV0JiZlLm91dHB1dC5sZW5ndGg+MCYmKG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pfX19LHdlPXtvcHNfdGFibGU6bnVsbCxtb3VudDpmdW5jdGlvbihlKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShudWxsLCIvIiwxNjg5NSwwKX0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuKXtpZihUZS5pc0Jsa2RldihyKXx8VGUuaXNGSUZPKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTt3ZS5vcHNfdGFibGV8fCh3ZS5vcHNfdGFibGU9e2Rpcjp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixsb29rdXA6d2Uubm9kZV9vcHMubG9va3VwLG1rbm9kOndlLm5vZGVfb3BzLm1rbm9kLHJlbmFtZTp3ZS5ub2RlX29wcy5yZW5hbWUsdW5saW5rOndlLm5vZGVfb3BzLnVubGluayxybWRpcjp3ZS5ub2RlX29wcy5ybWRpcixyZWFkZGlyOndlLm5vZGVfb3BzLnJlYWRkaXIsc3ltbGluazp3ZS5ub2RlX29wcy5zeW1saW5rfSxzdHJlYW06e2xsc2Vlazp3ZS5zdHJlYW1fb3BzLmxsc2Vla319LGZpbGU6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTp7bGxzZWVrOndlLnN0cmVhbV9vcHMubGxzZWVrLHJlYWQ6d2Uuc3RyZWFtX29wcy5yZWFkLHdyaXRlOndlLnN0cmVhbV9vcHMud3JpdGUsYWxsb2NhdGU6d2Uuc3RyZWFtX29wcy5hbGxvY2F0ZSxtbWFwOndlLnN0cmVhbV9vcHMubW1hcCxtc3luYzp3ZS5zdHJlYW1fb3BzLm1zeW5jfX0sbGluazp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixyZWFkbGluazp3ZS5ub2RlX29wcy5yZWFkbGlua30sc3RyZWFtOnt9fSxjaHJkZXY6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTpUZS5jaHJkZXZfc3RyZWFtX29wc319KTt2YXIgbz1UZS5jcmVhdGVOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5pc0RpcihvLm1vZGUpPyhvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5kaXIubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmRpci5zdHJlYW0sby5jb250ZW50cz17fSk6VGUuaXNGaWxlKG8ubW9kZSk/KG8ubm9kZV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUuc3RyZWFtLG8udXNlZEJ5dGVzPTAsby5jb250ZW50cz1udWxsKTpUZS5pc0xpbmsoby5tb2RlKT8oby5ub2RlX29wcz13ZS5vcHNfdGFibGUubGluay5ub2RlLG8uc3RyZWFtX29wcz13ZS5vcHNfdGFibGUubGluay5zdHJlYW0pOlRlLmlzQ2hyZGV2KG8ubW9kZSkmJihvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5jaHJkZXYubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmNocmRldi5zdHJlYW0pLG8udGltZXN0YW1wPURhdGUubm93KCksZSYmKGUuY29udGVudHNbdF09byksb30sZ2V0RmlsZURhdGFBc1JlZ3VsYXJBcnJheTpmdW5jdGlvbihlKXtpZihlLmNvbnRlbnRzJiZlLmNvbnRlbnRzLnN1YmFycmF5KXtmb3IodmFyIHQ9W10scj0wO3I8ZS51c2VkQnl0ZXM7KytyKXQucHVzaChlLmNvbnRlbnRzW3JdKTtyZXR1cm4gdH1yZXR1cm4gZS5jb250ZW50c30sZ2V0RmlsZURhdGFBc1R5cGVkQXJyYXk6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuY29udGVudHM/ZS5jb250ZW50cy5zdWJhcnJheT9lLmNvbnRlbnRzLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpOm5ldyBVaW50OEFycmF5KGUuY29udGVudHMpOm5ldyBVaW50OEFycmF5fSxleHBhbmRGaWxlU3RvcmFnZTpmdW5jdGlvbihlLHQpe2lmKGUuY29udGVudHMmJmUuY29udGVudHMuc3ViYXJyYXkmJnQ+ZS5jb250ZW50cy5sZW5ndGgmJihlLmNvbnRlbnRzPXdlLmdldEZpbGVEYXRhQXNSZWd1bGFyQXJyYXkoZSksZS51c2VkQnl0ZXM9ZS5jb250ZW50cy5sZW5ndGgpLCFlLmNvbnRlbnRzfHxlLmNvbnRlbnRzLnN1YmFycmF5KXt2YXIgcj1lLmNvbnRlbnRzP2UuY29udGVudHMubGVuZ3RoOjA7aWYocj49dClyZXR1cm47dD1NYXRoLm1heCh0LHIqKHI8MTA0ODU3Nj8yOjEuMTI1KXwwKSwwIT1yJiYodD1NYXRoLm1heCh0LDI1NikpO3ZhciBuPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodCksdm9pZChlLnVzZWRCeXRlcz4wJiZlLmNvbnRlbnRzLnNldChuLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpLDApKX1mb3IoIWUuY29udGVudHMmJnQ+MCYmKGUuY29udGVudHM9W10pO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKX0scmVzaXplRmlsZVN0b3JhZ2U6ZnVuY3Rpb24oZSx0KXtpZihlLnVzZWRCeXRlcyE9dCl7aWYoMD09dClyZXR1cm4gZS5jb250ZW50cz1udWxsLHZvaWQoZS51c2VkQnl0ZXM9MCk7aWYoIWUuY29udGVudHN8fGUuY29udGVudHMuc3ViYXJyYXkpe3ZhciByPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkobmV3IEFycmF5QnVmZmVyKHQpKSxyJiZlLmNvbnRlbnRzLnNldChyLnN1YmFycmF5KDAsTWF0aC5taW4odCxlLnVzZWRCeXRlcykpKSx2b2lkKGUudXNlZEJ5dGVzPXQpfWlmKGUuY29udGVudHN8fChlLmNvbnRlbnRzPVtdKSxlLmNvbnRlbnRzLmxlbmd0aD50KWUuY29udGVudHMubGVuZ3RoPXQ7ZWxzZSBmb3IoO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKTtlLnVzZWRCeXRlcz10fX0sbm9kZV9vcHM6e2dldGF0dHI6ZnVuY3Rpb24oZSl7dmFyIHQ9e307cmV0dXJuIHQuZGV2PVRlLmlzQ2hyZGV2KGUubW9kZSk/ZS5pZDoxLHQuaW5vPWUuaWQsdC5tb2RlPWUubW9kZSx0Lm5saW5rPTEsdC51aWQ9MCx0LmdpZD0wLHQucmRldj1lLnJkZXYsVGUuaXNEaXIoZS5tb2RlKT90LnNpemU9NDA5NjpUZS5pc0ZpbGUoZS5tb2RlKT90LnNpemU9ZS51c2VkQnl0ZXM6VGUuaXNMaW5rKGUubW9kZSk/dC5zaXplPWUubGluay5sZW5ndGg6dC5zaXplPTAsdC5hdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5tdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5jdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5ibGtzaXplPTQwOTYsdC5ibG9ja3M9TWF0aC5jZWlsKHQuc2l6ZS90LmJsa3NpemUpLHR9LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKSx2b2lkIDAhPT10LnNpemUmJndlLnJlc2l6ZUZpbGVTdG9yYWdlKGUsdC5zaXplKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgVGUuZ2VuZXJpY0Vycm9yc1ttZS5FTk9FTlRdfSxta25vZDpmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShlLHQscixuKX0scmVuYW1lOmZ1bmN0aW9uKGUsdCxyKXtpZihUZS5pc0RpcihlLm1vZGUpKXt2YXIgbjt0cnl7bj1UZS5sb29rdXBOb2RlKHQscil9Y2F0Y2goZSl7fWlmKG4pZm9yKHZhciBvIGluIG4uY29udGVudHMpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PVEVNUFRZKX1kZWxldGUgZS5wYXJlbnQuY29udGVudHNbZS5uYW1lXSxlLm5hbWU9cix0LmNvbnRlbnRzW3JdPWUsZS5wYXJlbnQ9dH0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7ZGVsZXRlIGUuY29udGVudHNbdF19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwTm9kZShlLHQpO2Zvcih2YXIgbiBpbiByLmNvbnRlbnRzKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7ZGVsZXRlIGUuY29udGVudHNbdF19LHJlYWRkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9WyIuIiwiLi4iXTtmb3IodmFyIHIgaW4gZS5jb250ZW50cyllLmNvbnRlbnRzLmhhc093blByb3BlcnR5KHIpJiZ0LnB1c2gocik7cmV0dXJuIHR9LHN5bWxpbms6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPXdlLmNyZWF0ZU5vZGUoZSx0LDQxNDcxLDApO3JldHVybiBuLmxpbms9cixufSxyZWFkbGluazpmdW5jdGlvbihlKXtpZighVGUuaXNMaW5rKGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gZS5saW5rfX0sc3RyZWFtX29wczp7cmVhZDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWUubm9kZS5jb250ZW50cztpZihvPj1lLm5vZGUudXNlZEJ5dGVzKXJldHVybiAwO3ZhciBhPU1hdGgubWluKGUubm9kZS51c2VkQnl0ZXMtbyxuKTtpZih5KGE+PTApLGE+OCYmaS5zdWJhcnJheSl0LnNldChpLnN1YmFycmF5KG8sbythKSxyKTtlbHNlIGZvcih2YXIgcz0wO3M8YTtzKyspdFtyK3NdPWlbbytzXTtyZXR1cm4gYX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe2lmKCFuKXJldHVybiAwO3ZhciBhPWUubm9kZTtpZihhLnRpbWVzdGFtcD1EYXRlLm5vdygpLHQuc3ViYXJyYXkmJighYS5jb250ZW50c3x8YS5jb250ZW50cy5zdWJhcnJheSkpe2lmKGkpcmV0dXJuIGEuY29udGVudHM9dC5zdWJhcnJheShyLHIrbiksYS51c2VkQnl0ZXM9bixuO2lmKDA9PT1hLnVzZWRCeXRlcyYmMD09PW8pcmV0dXJuIGEuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodC5zdWJhcnJheShyLHIrbikpLGEudXNlZEJ5dGVzPW4sbjtpZihvK248PWEudXNlZEJ5dGVzKXJldHVybiBhLmNvbnRlbnRzLnNldCh0LnN1YmFycmF5KHIscituKSxvKSxufWlmKHdlLmV4cGFuZEZpbGVTdG9yYWdlKGEsbytuKSxhLmNvbnRlbnRzLnN1YmFycmF5JiZ0LnN1YmFycmF5KWEuY29udGVudHMuc2V0KHQuc3ViYXJyYXkocixyK24pLG8pO2Vsc2UgZm9yKHZhciBzPTA7czxuO3MrKylhLmNvbnRlbnRzW28rc109dFtyK3NdO3JldHVybiBhLnVzZWRCeXRlcz1NYXRoLm1heChhLnVzZWRCeXRlcyxvK24pLG59LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnVzZWRCeXRlcyksbjwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7cmV0dXJuIG59LGFsbG9jYXRlOmZ1bmN0aW9uKGUsdCxyKXt3ZS5leHBhbmRGaWxlU3RvcmFnZShlLm5vZGUsdCtyKSxlLm5vZGUudXNlZEJ5dGVzPU1hdGgubWF4KGUubm9kZS51c2VkQnl0ZXMsdCtyKX0sbW1hcDpmdW5jdGlvbihlLHQscixuLG8saSxhKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO3ZhciBzLHUsYz1lLm5vZGUuY29udGVudHM7aWYoMiZhfHxjLmJ1ZmZlciE9PXQmJmMuYnVmZmVyIT09dC5idWZmZXIpe2lmKChvPjB8fG8rbjxlLm5vZGUudXNlZEJ5dGVzKSYmKGM9Yy5zdWJhcnJheT9jLnN1YmFycmF5KG8sbytuKTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjLG8sbytuKSksdT0hMCwhKHM9SnQobikpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT01FTSk7dC5zZXQoYyxzKX1lbHNlIHU9ITEscz1jLmJ5dGVPZmZzZXQ7cmV0dXJue3B0cjpzLGFsbG9jYXRlZDp1fX0sbXN5bmM6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO2lmKDImbylyZXR1cm4gMDt3ZS5zdHJlYW1fb3BzLndyaXRlKGUsdCwwLG4sciwhMSk7cmV0dXJuIDB9fX0sX2U9e2Riczp7fSxpbmRleGVkREI6ZnVuY3Rpb24oKXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIGluZGV4ZWREQilyZXR1cm4gaW5kZXhlZERCO3ZhciBlPW51bGw7cmV0dXJuIm9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJihlPXdpbmRvdy5pbmRleGVkREJ8fHdpbmRvdy5tb3pJbmRleGVkREJ8fHdpbmRvdy53ZWJraXRJbmRleGVkREJ8fHdpbmRvdy5tc0luZGV4ZWREQikseShlLCJJREJGUyB1c2VkLCBidXQgaW5kZXhlZERCIG5vdCBzdXBwb3J0ZWQiKSxlfSxEQl9WRVJTSU9OOjIxLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsbW91bnQ6ZnVuY3Rpb24oZSl7cmV0dXJuIHdlLm1vdW50LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sc3luY2ZzOmZ1bmN0aW9uKGUsdCxyKXtfZS5nZXRMb2NhbFNldChlLChmdW5jdGlvbihuLG8pe2lmKG4pcmV0dXJuIHIobik7X2UuZ2V0UmVtb3RlU2V0KGUsKGZ1bmN0aW9uKGUsbil7aWYoZSlyZXR1cm4gcihlKTt2YXIgaT10P246byxhPXQ/bzpuO19lLnJlY29uY2lsZShpLGEscil9KSl9KSl9LGdldERCOmZ1bmN0aW9uKGUsdCl7dmFyIHIsbj1fZS5kYnNbZV07aWYobilyZXR1cm4gdChudWxsLG4pO3RyeXtyPV9lLmluZGV4ZWREQigpLm9wZW4oZSxfZS5EQl9WRVJTSU9OKX1jYXRjaChlKXtyZXR1cm4gdChlKX1pZighcilyZXR1cm4gdCgiVW5hYmxlIHRvIGNvbm5lY3QgdG8gSW5kZXhlZERCIik7ci5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oZSl7dmFyIHQscj1lLnRhcmdldC5yZXN1bHQsbj1lLnRhcmdldC50cmFuc2FjdGlvbjsodD1yLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoX2UuREJfU1RPUkVfTkFNRSk/bi5vYmplY3RTdG9yZShfZS5EQl9TVE9SRV9OQU1FKTpyLmNyZWF0ZU9iamVjdFN0b3JlKF9lLkRCX1NUT1JFX05BTUUpKS5pbmRleE5hbWVzLmNvbnRhaW5zKCJ0aW1lc3RhbXAiKXx8dC5jcmVhdGVJbmRleCgidGltZXN0YW1wIiwidGltZXN0YW1wIix7dW5pcXVlOiExfSl9LHIub25zdWNjZXNzPWZ1bmN0aW9uKCl7bj1yLnJlc3VsdCxfZS5kYnNbZV09bix0KG51bGwsbil9LHIub25lcnJvcj1mdW5jdGlvbihlKXt0KHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX19LGdldExvY2FsU2V0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9e307ZnVuY3Rpb24gbihlKXtyZXR1cm4iLiIhPT1lJiYiLi4iIT09ZX1mdW5jdGlvbiBvKGUpe3JldHVybiBmdW5jdGlvbih0KXtyZXR1cm4gZ2Uuam9pbjIoZSx0KX19Zm9yKHZhciBpPVRlLnJlYWRkaXIoZS5tb3VudHBvaW50KS5maWx0ZXIobikubWFwKG8oZS5tb3VudHBvaW50KSk7aS5sZW5ndGg7KXt2YXIgYSxzPWkucG9wKCk7dHJ5e2E9VGUuc3RhdChzKX1jYXRjaChlKXtyZXR1cm4gdChlKX1UZS5pc0RpcihhLm1vZGUpJiZpLnB1c2guYXBwbHkoaSxUZS5yZWFkZGlyKHMpLmZpbHRlcihuKS5tYXAobyhzKSkpLHJbc109e3RpbWVzdGFtcDphLm10aW1lfX1yZXR1cm4gdChudWxsLHt0eXBlOiJsb2NhbCIsZW50cmllczpyfSl9LGdldFJlbW90ZVNldDpmdW5jdGlvbihlLHQpe3ZhciByPXt9O19lLmdldERCKGUubW91bnRwb2ludCwoZnVuY3Rpb24oZSxuKXtpZihlKXJldHVybiB0KGUpO3RyeXt2YXIgbz1uLnRyYW5zYWN0aW9uKFtfZS5EQl9TVE9SRV9OQU1FXSwicmVhZG9ubHkiKTtvLm9uZXJyb3I9ZnVuY3Rpb24oZSl7dCh0aGlzLmVycm9yKSxlLnByZXZlbnREZWZhdWx0KCl9LG8ub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSkuaW5kZXgoInRpbWVzdGFtcCIpLm9wZW5LZXlDdXJzb3IoKS5vbnN1Y2Nlc3M9ZnVuY3Rpb24oZSl7dmFyIG89ZS50YXJnZXQucmVzdWx0O2lmKCFvKXJldHVybiB0KG51bGwse3R5cGU6InJlbW90ZSIsZGI6bixlbnRyaWVzOnJ9KTtyW28ucHJpbWFyeUtleV09e3RpbWVzdGFtcDpvLmtleX0sby5jb250aW51ZSgpfX1jYXRjaChlKXtyZXR1cm4gdChlKX19KSl9LGxvYWRMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dmFyIHIsbjt0cnl7bj1UZS5sb29rdXBQYXRoKGUpLm5vZGUscj1UZS5zdGF0KGUpfWNhdGNoKGUpe3JldHVybiB0KGUpfXJldHVybiBUZS5pc0RpcihyLm1vZGUpP3QobnVsbCx7dGltZXN0YW1wOnIubXRpbWUsbW9kZTpyLm1vZGV9KTpUZS5pc0ZpbGUoci5tb2RlKT8obi5jb250ZW50cz13ZS5nZXRGaWxlRGF0YUFzVHlwZWRBcnJheShuKSx0KG51bGwse3RpbWVzdGFtcDpyLm10aW1lLG1vZGU6ci5tb2RlLGNvbnRlbnRzOm4uY29udGVudHN9KSk6dChuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpfSxzdG9yZUxvY2FsRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3RyeXtpZihUZS5pc0Rpcih0Lm1vZGUpKVRlLm1rZGlyKGUsdC5tb2RlKTtlbHNle2lmKCFUZS5pc0ZpbGUodC5tb2RlKSlyZXR1cm4gcihuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpO1RlLndyaXRlRmlsZShlLHQuY29udGVudHMse2Nhbk93bjohMH0pfVRlLmNobW9kKGUsdC5tb2RlKSxUZS51dGltZShlLHQudGltZXN0YW1wLHQudGltZXN0YW1wKX1jYXRjaChlKXtyZXR1cm4gcihlKX1yKG51bGwpfSxyZW1vdmVMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dHJ5e1RlLmxvb2t1cFBhdGgoZSk7dmFyIHI9VGUuc3RhdChlKTtUZS5pc0RpcihyLm1vZGUpP1RlLnJtZGlyKGUpOlRlLmlzRmlsZShyLm1vZGUpJiZUZS51bmxpbmsoZSl9Y2F0Y2goZSl7cmV0dXJuIHQoZSl9dChudWxsKX0sbG9hZFJlbW90ZUVudHJ5OmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj1lLmdldCh0KTtuLm9uc3VjY2Vzcz1mdW5jdGlvbihlKXtyKG51bGwsZS50YXJnZXQucmVzdWx0KX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0sc3RvcmVSZW1vdGVFbnRyeTpmdW5jdGlvbihlLHQscixuKXt2YXIgbz1lLnB1dChyLHQpO28ub25zdWNjZXNzPWZ1bmN0aW9uKCl7bihudWxsKX0sby5vbmVycm9yPWZ1bmN0aW9uKGUpe24odGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVtb3ZlUmVtb3RlRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPWUuZGVsZXRlKHQpO24ub25zdWNjZXNzPWZ1bmN0aW9uKCl7cihudWxsKX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVjb25jaWxlOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0wLG89W107T2JqZWN0LmtleXMoZS5lbnRyaWVzKS5mb3JFYWNoKChmdW5jdGlvbihyKXt2YXIgaT1lLmVudHJpZXNbcl0sYT10LmVudHJpZXNbcl07KCFhfHxpLnRpbWVzdGFtcD5hLnRpbWVzdGFtcCkmJihvLnB1c2gociksbisrKX0pKTt2YXIgaT1bXTtpZihPYmplY3Qua2V5cyh0LmVudHJpZXMpLmZvckVhY2goKGZ1bmN0aW9uKHIpe3QuZW50cmllc1tyXTtlLmVudHJpZXNbcl18fChpLnB1c2gociksbisrKX0pKSwhbilyZXR1cm4gcihudWxsKTt2YXIgYT0wLHM9KCJyZW1vdGUiPT09ZS50eXBlP2UuZGI6dC5kYikudHJhbnNhY3Rpb24oW19lLkRCX1NUT1JFX05BTUVdLCJyZWFkd3JpdGUiKSx1PXMub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSk7ZnVuY3Rpb24gYyhlKXtyZXR1cm4gZT9jLmVycm9yZWQ/dm9pZCAwOihjLmVycm9yZWQ9ITAscihlKSk6KythPj1uP3IobnVsbCk6dm9pZCAwfXMub25lcnJvcj1mdW5jdGlvbihlKXtjKHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX0sby5zb3J0KCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5sb2FkUmVtb3RlRW50cnkodSxlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVMb2NhbEVudHJ5KGUscixjKX0pKTpfZS5sb2FkTG9jYWxFbnRyeShlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVSZW1vdGVFbnRyeSh1LGUscixjKX0pKX0pKSxpLnNvcnQoKS5yZXZlcnNlKCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5yZW1vdmVMb2NhbEVudHJ5KGUsYyk6X2UucmVtb3ZlUmVtb3RlRW50cnkodSxlLGMpfSkpfX0sYmU9e2lzV2luZG93czohMSxzdGF0aWNJbml0OmZ1bmN0aW9uKCl7YmUuaXNXaW5kb3dzPSEhcHJvY2Vzcy5wbGF0Zm9ybS5tYXRjaCgvXndpbi8pO3ZhciBlPXByb2Nlc3MuYmluZGluZygiY29uc3RhbnRzIik7ZS5mcyYmKGU9ZS5mcyksYmUuZmxhZ3NGb3JOb2RlTWFwPXsxMDI0OmUuT19BUFBFTkQsNjQ6ZS5PX0NSRUFULDEyODplLk9fRVhDTCwwOmUuT19SRE9OTFksMjplLk9fUkRXUiw0MDk2OmUuT19TWU5DLDUxMjplLk9fVFJVTkMsMTplLk9fV1JPTkxZfX0sYnVmZmVyRnJvbTpmdW5jdGlvbihlKXtyZXR1cm4gQnVmZmVyLmFsbG9jP0J1ZmZlci5mcm9tKGUpOm5ldyBCdWZmZXIoZSl9LG1vdW50OmZ1bmN0aW9uKGUpe3JldHVybiB5KGwpLGJlLmNyZWF0ZU5vZGUobnVsbCwiLyIsYmUuZ2V0TW9kZShlLm9wdHMucm9vdCksMCl9LGNyZWF0ZU5vZGU6ZnVuY3Rpb24oZSx0LHIsbil7aWYoIVRlLmlzRGlyKHIpJiYhVGUuaXNGaWxlKHIpJiYhVGUuaXNMaW5rKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG89VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIG8ubm9kZV9vcHM9YmUubm9kZV9vcHMsby5zdHJlYW1fb3BzPWJlLnN0cmVhbV9vcHMsb30sZ2V0TW9kZTpmdW5jdGlvbihlKXt2YXIgdDt0cnl7dD1mcy5sc3RhdFN5bmMoZSksYmUuaXNXaW5kb3dzJiYodC5tb2RlPXQubW9kZXwoMjkyJnQubW9kZSk+PjIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1yZXR1cm4gdC5tb2RlfSxyZWFsUGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ9W107ZS5wYXJlbnQhPT1lOyl0LnB1c2goZS5uYW1lKSxlPWUucGFyZW50O3JldHVybiB0LnB1c2goZS5tb3VudC5vcHRzLnJvb3QpLHQucmV2ZXJzZSgpLGdlLmpvaW4uYXBwbHkobnVsbCx0KX0sZmxhZ3NGb3JOb2RlOmZ1bmN0aW9uKGUpe2UmPS0yMDk3MTUzLGUmPS0yMDQ5LGUmPS0zMjc2OSxlJj0tNTI0Mjg5O3ZhciB0PTA7Zm9yKHZhciByIGluIGJlLmZsYWdzRm9yTm9kZU1hcCllJnImJih0fD1iZS5mbGFnc0Zvck5vZGVNYXBbcl0sZV49cik7aWYoZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiB0fSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXt2YXIgdCxyPWJlLnJlYWxQYXRoKGUpO3RyeXt0PWZzLmxzdGF0U3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIGJlLmlzV2luZG93cyYmIXQuYmxrc2l6ZSYmKHQuYmxrc2l6ZT00MDk2KSxiZS5pc1dpbmRvd3MmJiF0LmJsb2NrcyYmKHQuYmxvY2tzPSh0LnNpemUrdC5ibGtzaXplLTEpL3QuYmxrc2l6ZXwwKSx7ZGV2OnQuZGV2LGlubzp0Lmlubyxtb2RlOnQubW9kZSxubGluazp0Lm5saW5rLHVpZDp0LnVpZCxnaWQ6dC5naWQscmRldjp0LnJkZXYsc2l6ZTp0LnNpemUsYXRpbWU6dC5hdGltZSxtdGltZTp0Lm10aW1lLGN0aW1lOnQuY3RpbWUsYmxrc2l6ZTp0LmJsa3NpemUsYmxvY2tzOnQuYmxvY2tzfX0sc2V0YXR0cjpmdW5jdGlvbihlLHQpe3ZhciByPWJlLnJlYWxQYXRoKGUpO3RyeXtpZih2b2lkIDAhPT10Lm1vZGUmJihmcy5jaG1vZFN5bmMocix0Lm1vZGUpLGUubW9kZT10Lm1vZGUpLHZvaWQgMCE9PXQudGltZXN0YW1wKXt2YXIgbj1uZXcgRGF0ZSh0LnRpbWVzdGFtcCk7ZnMudXRpbWVzU3luYyhyLG4sbil9dm9pZCAwIT09dC5zaXplJiZmcy50cnVuY2F0ZVN5bmMocix0LnNpemUpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxvb2t1cDpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpLG49YmUuZ2V0TW9kZShyKTtyZXR1cm4gYmUuY3JlYXRlTm9kZShlLHQsbil9LG1rbm9kOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWJlLmNyZWF0ZU5vZGUoZSx0LHIsbiksaT1iZS5yZWFsUGF0aChvKTt0cnl7VGUuaXNEaXIoby5tb2RlKT9mcy5ta2RpclN5bmMoaSxvLm1vZGUpOmZzLndyaXRlRmlsZVN5bmMoaSwiIix7bW9kZTpvLm1vZGV9KX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIG99LHJlbmFtZTpmdW5jdGlvbihlLHQscil7dmFyIG49YmUucmVhbFBhdGgoZSksbz1nZS5qb2luMihiZS5yZWFsUGF0aCh0KSxyKTt0cnl7ZnMucmVuYW1lU3luYyhuLG8pfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHVubGluazpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpO3RyeXtmcy51bmxpbmtTeW5jKHIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnJtZGlyU3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUpO3RyeXtyZXR1cm4gZnMucmVhZGRpclN5bmModCl9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dmFyIG49Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnN5bWxpbmtTeW5jKHIsbil9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0scmVhZGxpbms6ZnVuY3Rpb24oZSl7dmFyIHQ9YmUucmVhbFBhdGgoZSk7dHJ5e3JldHVybiB0PWZzLnJlYWRsaW5rU3luYyh0KSx0PU5PREVKU19QQVRILnJlbGF0aXZlKE5PREVKU19QQVRILnJlc29sdmUoZS5tb3VudC5vcHRzLnJvb3QpLHQpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19fSxzdHJlYW1fb3BzOntvcGVuOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUubm9kZSk7dHJ5e1RlLmlzRmlsZShlLm5vZGUubW9kZSkmJihlLm5mZD1mcy5vcGVuU3luYyh0LGJlLmZsYWdzRm9yTm9kZShlLmZsYWdzKSkpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGNsb3NlOmZ1bmN0aW9uKGUpe3RyeXtUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiZlLm5mZCYmZnMuY2xvc2VTeW5jKGUubmZkKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoMD09PW4pcmV0dXJuIDA7dHJ5e3JldHVybiBmcy5yZWFkU3luYyhlLm5mZCxiZS5idWZmZXJGcm9tKHQuYnVmZmVyKSxyLG4sbyl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3RyeXtyZXR1cm4gZnMud3JpdGVTeW5jKGUubmZkLGJlLmJ1ZmZlckZyb20odC5idWZmZXIpLHIsbixvKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09ciluKz1lLnBvc2l0aW9uO2Vsc2UgaWYoMj09PXImJlRlLmlzRmlsZShlLm5vZGUubW9kZSkpdHJ5e24rPWZzLmZzdGF0U3luYyhlLm5mZCkuc2l6ZX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1pZihuPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gbn19fSxBZT17RElSX01PREU6MTY4OTUsRklMRV9NT0RFOjMzMjc5LHJlYWRlcjpudWxsLG1vdW50OmZ1bmN0aW9uKGUpe3koYyksQWUucmVhZGVyfHwoQWUucmVhZGVyPW5ldyBGaWxlUmVhZGVyU3luYyk7dmFyIHQ9QWUuY3JlYXRlTm9kZShudWxsLCIvIixBZS5ESVJfTU9ERSwwKSxyPXt9O2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciBuPWUuc3BsaXQoIi8iKSxvPXQsaT0wO2k8bi5sZW5ndGgtMTtpKyspe3ZhciBhPW4uc2xpY2UoMCxpKzEpLmpvaW4oIi8iKTtyW2FdfHwoclthXT1BZS5jcmVhdGVOb2RlKG8sbltpXSxBZS5ESVJfTU9ERSwwKSksbz1yW2FdfXJldHVybiBvfWZ1bmN0aW9uIG8oZSl7dmFyIHQ9ZS5zcGxpdCgiLyIpO3JldHVybiB0W3QubGVuZ3RoLTFdfXJldHVybiBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKGUub3B0cy5maWxlc3x8W10sKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLGUubGFzdE1vZGlmaWVkRGF0ZSl9KSksKGUub3B0cy5ibG9ic3x8W10pLmZvckVhY2goKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLmRhdGEpfSkpLChlLm9wdHMucGFja2FnZXN8fFtdKS5mb3JFYWNoKChmdW5jdGlvbihlKXtlLm1ldGFkYXRhLmZpbGVzLmZvckVhY2goKGZ1bmN0aW9uKHQpe3ZhciByPXQuZmlsZW5hbWUuc3Vic3RyKDEpO0FlLmNyZWF0ZU5vZGUobihyKSxvKHIpLEFlLkZJTEVfTU9ERSwwLGUuYmxvYi5zbGljZSh0LnN0YXJ0LHQuZW5kKSl9KSl9KSksdH0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIGEubW9kZT1yLGEubm9kZV9vcHM9QWUubm9kZV9vcHMsYS5zdHJlYW1fb3BzPUFlLnN0cmVhbV9vcHMsYS50aW1lc3RhbXA9KGl8fG5ldyBEYXRlKS5nZXRUaW1lKCkseShBZS5GSUxFX01PREUhPT1BZS5ESVJfTU9ERSkscj09PUFlLkZJTEVfTU9ERT8oYS5zaXplPW8uc2l6ZSxhLmNvbnRlbnRzPW8pOihhLnNpemU9NDA5NixhLmNvbnRlbnRzPXt9KSxlJiYoZS5jb250ZW50c1t0XT1hKSxhfSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXtyZXR1cm57ZGV2OjEsaW5vOnZvaWQgMCxtb2RlOmUubW9kZSxubGluazoxLHVpZDowLGdpZDowLHJkZXY6dm9pZCAwLHNpemU6ZS5zaXplLGF0aW1lOm5ldyBEYXRlKGUudGltZXN0YW1wKSxtdGltZTpuZXcgRGF0ZShlLnRpbWVzdGFtcCksY3RpbWU6bmV3IERhdGUoZS50aW1lc3RhbXApLGJsa3NpemU6NDA5NixibG9ja3M6TWF0aC5jZWlsKGUuc2l6ZS80MDk2KX19LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKX0sbWtub2Q6ZnVuY3Rpb24oZSx0LHIsbil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZW5hbWU6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxybWRpcjpmdW5jdGlvbihlLHQpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0scmVhZGRpcjpmdW5jdGlvbihlKXt2YXIgdD1bIi4iLCIuLiJdO2Zvcih2YXIgciBpbiBlLmNvbnRlbnRzKWUuY29udGVudHMuaGFzT3duUHJvcGVydHkocikmJnQucHVzaChyKTtyZXR1cm4gdH0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZWFkbGluazpmdW5jdGlvbihlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSl9fSxzdHJlYW1fb3BzOntyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYobz49ZS5ub2RlLnNpemUpcmV0dXJuIDA7dmFyIGk9ZS5ub2RlLmNvbnRlbnRzLnNsaWNlKG8sbytuKSxhPUFlLnJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihpKTtyZXR1cm4gdC5zZXQobmV3IFVpbnQ4QXJyYXkoYSksciksaS5zaXplfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnNpemUpLG48MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBufX19O0wrPTE2LEwrPTE2O3ZhciBUZT17cm9vdDpudWxsLG1vdW50czpbXSxkZXZpY2VzOnt9LHN0cmVhbXM6W10sbmV4dElub2RlOjEsbmFtZVRhYmxlOm51bGwsY3VycmVudFBhdGg6Ii8iLGluaXRpYWxpemVkOiExLGlnbm9yZVBlcm1pc3Npb25zOiEwLHRyYWNraW5nRGVsZWdhdGU6e30sdHJhY2tpbmc6e29wZW5GbGFnczp7UkVBRDoxLFdSSVRFOjJ9fSxFcnJub0Vycm9yOm51bGwsZ2VuZXJpY0Vycm9yczp7fSxmaWxlc3lzdGVtczpudWxsLHN5bmNGU1JlcXVlc3RzOjAsaGFuZGxlRlNFcnJvcjpmdW5jdGlvbihlKXtpZighKGUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yKSl0aHJvdyBlKyIgOiAiK1AoKTtyZXR1cm4geWUoZS5lcnJubyl9LGxvb2t1cFBhdGg6ZnVuY3Rpb24oZSx0KXtpZih0PXR8fHt9LCEoZT1nZS5yZXNvbHZlKFRlLmN3ZCgpLGUpKSlyZXR1cm57cGF0aDoiIixub2RlOm51bGx9O3ZhciByPXtmb2xsb3dfbW91bnQ6ITAscmVjdXJzZV9jb3VudDowfTtmb3IodmFyIG4gaW4gcil2b2lkIDA9PT10W25dJiYodFtuXT1yW25dKTtpZih0LnJlY3Vyc2VfY291bnQ+OCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCk7Zm9yKHZhciBvPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhMSksaT1UZS5yb290LGE9Ii8iLHM9MDtzPG8ubGVuZ3RoO3MrKyl7dmFyIHU9cz09PW8ubGVuZ3RoLTE7aWYodSYmdC5wYXJlbnQpYnJlYWs7aWYoaT1UZS5sb29rdXBOb2RlKGksb1tzXSksYT1nZS5qb2luMihhLG9bc10pLFRlLmlzTW91bnRwb2ludChpKSYmKCF1fHx1JiZ0LmZvbGxvd19tb3VudCkmJihpPWkubW91bnRlZC5yb290KSwhdXx8dC5mb2xsb3cpZm9yKHZhciBjPTA7VGUuaXNMaW5rKGkubW9kZSk7KXt2YXIgbD1UZS5yZWFkbGluayhhKTtpZihhPWdlLnJlc29sdmUoZ2UuZGlybmFtZShhKSxsKSxpPVRlLmxvb2t1cFBhdGgoYSx7cmVjdXJzZV9jb3VudDp0LnJlY3Vyc2VfY291bnR9KS5ub2RlLGMrKz40MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCl9fXJldHVybntwYXRoOmEsbm9kZTppfX0sZ2V0UGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ7Oyl7aWYoVGUuaXNSb290KGUpKXt2YXIgcj1lLm1vdW50Lm1vdW50cG9pbnQ7cmV0dXJuIHQ/Ii8iIT09cltyLmxlbmd0aC0xXT9yKyIvIit0OnIrdDpyfXQ9dD9lLm5hbWUrIi8iK3Q6ZS5uYW1lLGU9ZS5wYXJlbnR9fSxoYXNoTmFtZTpmdW5jdGlvbihlLHQpe2Zvcih2YXIgcj0wLG49MDtuPHQubGVuZ3RoO24rKylyPShyPDw1KS1yK3QuY2hhckNvZGVBdChuKXwwO3JldHVybihlK3I+Pj4wKSVUZS5uYW1lVGFibGUubGVuZ3RofSxoYXNoQWRkTm9kZTpmdW5jdGlvbihlKXt2YXIgdD1UZS5oYXNoTmFtZShlLnBhcmVudC5pZCxlLm5hbWUpO2UubmFtZV9uZXh0PVRlLm5hbWVUYWJsZVt0XSxUZS5uYW1lVGFibGVbdF09ZX0saGFzaFJlbW92ZU5vZGU6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuaGFzaE5hbWUoZS5wYXJlbnQuaWQsZS5uYW1lKTtpZihUZS5uYW1lVGFibGVbdF09PT1lKVRlLm5hbWVUYWJsZVt0XT1lLm5hbWVfbmV4dDtlbHNlIGZvcih2YXIgcj1UZS5uYW1lVGFibGVbdF07cjspe2lmKHIubmFtZV9uZXh0PT09ZSl7ci5uYW1lX25leHQ9ZS5uYW1lX25leHQ7YnJlYWt9cj1yLm5hbWVfbmV4dH19LGxvb2t1cE5vZGU6ZnVuY3Rpb24oZSx0KXt2YXIgcj1UZS5tYXlMb29rdXAoZSk7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyLGUpO2Zvcih2YXIgbj1UZS5oYXNoTmFtZShlLmlkLHQpLG89VGUubmFtZVRhYmxlW25dO287bz1vLm5hbWVfbmV4dCl7dmFyIGk9by5uYW1lO2lmKG8ucGFyZW50LmlkPT09ZS5pZCYmaT09PXQpcmV0dXJuIG99cmV0dXJuIFRlLmxvb2t1cChlLHQpfSxjcmVhdGVOb2RlOmZ1bmN0aW9uKGUsdCxyLG4pe2lmKCFUZS5GU05vZGUpe1RlLkZTTm9kZT1mdW5jdGlvbihlLHQscixuKXtlfHwoZT10aGlzKSx0aGlzLnBhcmVudD1lLHRoaXMubW91bnQ9ZS5tb3VudCx0aGlzLm1vdW50ZWQ9bnVsbCx0aGlzLmlkPVRlLm5leHRJbm9kZSsrLHRoaXMubmFtZT10LHRoaXMubW9kZT1yLHRoaXMubm9kZV9vcHM9e30sdGhpcy5zdHJlYW1fb3BzPXt9LHRoaXMucmRldj1ufSxUZS5GU05vZGUucHJvdG90eXBlPXt9O09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlLkZTTm9kZS5wcm90b3R5cGUse3JlYWQ6e2dldDpmdW5jdGlvbigpe3JldHVybiAzNjU9PSgzNjUmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0zNjU6dGhpcy5tb2RlJj0tMzY2fX0sd3JpdGU6e2dldDpmdW5jdGlvbigpe3JldHVybiAxNDY9PSgxNDYmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0xNDY6dGhpcy5tb2RlJj0tMTQ3fX0saXNGb2xkZXI6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0Rpcih0aGlzLm1vZGUpfX0saXNEZXZpY2U6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0NocmRldih0aGlzLm1vZGUpfX19KX12YXIgbz1uZXcgVGUuRlNOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5oYXNoQWRkTm9kZShvKSxvfSxkZXN0cm95Tm9kZTpmdW5jdGlvbihlKXtUZS5oYXNoUmVtb3ZlTm9kZShlKX0saXNSb290OmZ1bmN0aW9uKGUpe3JldHVybiBlPT09ZS5wYXJlbnR9LGlzTW91bnRwb2ludDpmdW5jdGlvbihlKXtyZXR1cm4hIWUubW91bnRlZH0saXNGaWxlOmZ1bmN0aW9uKGUpe3JldHVybiAzMjc2OD09KDYxNDQwJmUpfSxpc0RpcjpmdW5jdGlvbihlKXtyZXR1cm4gMTYzODQ9PSg2MTQ0MCZlKX0saXNMaW5rOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2MD09KDYxNDQwJmUpfSxpc0NocmRldjpmdW5jdGlvbihlKXtyZXR1cm4gODE5Mj09KDYxNDQwJmUpfSxpc0Jsa2RldjpmdW5jdGlvbihlKXtyZXR1cm4gMjQ1NzY9PSg2MTQ0MCZlKX0saXNGSUZPOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2PT0oNjE0NDAmZSl9LGlzU29ja2V0OmZ1bmN0aW9uKGUpe3JldHVybiA0OTE1Mj09KDQ5MTUyJmUpfSxmbGFnTW9kZXM6e3I6MCxyczoxMDUyNjcyLCJyKyI6Mix3OjU3Nyx3eDo3MDUseHc6NzA1LCJ3KyI6NTc4LCJ3eCsiOjcwNiwieHcrIjo3MDYsYToxMDg5LGF4OjEyMTcseGE6MTIxNywiYSsiOjEwOTAsImF4KyI6MTIxOCwieGErIjoxMjE4fSxtb2RlU3RyaW5nVG9GbGFnczpmdW5jdGlvbihlKXt2YXIgdD1UZS5mbGFnTW9kZXNbZV07aWYodm9pZCAwPT09dCl0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZmlsZSBvcGVuIG1vZGU6ICIrZSk7cmV0dXJuIHR9LGZsYWdzVG9QZXJtaXNzaW9uU3RyaW5nOmZ1bmN0aW9uKGUpe3ZhciB0PVsiciIsInciLCJydyJdWzMmZV07cmV0dXJuIDUxMiZlJiYodCs9InciKSx0fSxub2RlUGVybWlzc2lvbnM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gVGUuaWdub3JlUGVybWlzc2lvbnN8fCgtMT09PXQuaW5kZXhPZigiciIpfHwyOTImZS5tb2RlKSYmKC0xPT09dC5pbmRleE9mKCJ3Iil8fDE0NiZlLm1vZGUpJiYoLTE9PT10LmluZGV4T2YoIngiKXx8NzMmZS5tb2RlKT8wOm1lLkVBQ0NFU30sbWF5TG9va3VwOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ4Iik7cmV0dXJuIHR8fChlLm5vZGVfb3BzLmxvb2t1cD8wOm1lLkVBQ0NFUyl9LG1heUNyZWF0ZTpmdW5jdGlvbihlLHQpe3RyeXtUZS5sb29rdXBOb2RlKGUsdCk7cmV0dXJuIG1lLkVFWElTVH1jYXRjaChlKXt9cmV0dXJuIFRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ3eCIpfSxtYXlEZWxldGU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuO3RyeXtuPVRlLmxvb2t1cE5vZGUoZSx0KX1jYXRjaChlKXtyZXR1cm4gZS5lcnJub312YXIgbz1UZS5ub2RlUGVybWlzc2lvbnMoZSwid3giKTtpZihvKXJldHVybiBvO2lmKHIpe2lmKCFUZS5pc0RpcihuLm1vZGUpKXJldHVybiBtZS5FTk9URElSO2lmKFRlLmlzUm9vdChuKXx8VGUuZ2V0UGF0aChuKT09PVRlLmN3ZCgpKXJldHVybiBtZS5FQlVTWX1lbHNlIGlmKFRlLmlzRGlyKG4ubW9kZSkpcmV0dXJuIG1lLkVJU0RJUjtyZXR1cm4gMH0sbWF5T3BlbjpmdW5jdGlvbihlLHQpe3JldHVybiBlP1RlLmlzTGluayhlLm1vZGUpP21lLkVMT09QOlRlLmlzRGlyKGUubW9kZSkmJigiciIhPT1UZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KXx8NTEyJnQpP21lLkVJU0RJUjpUZS5ub2RlUGVybWlzc2lvbnMoZSxUZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KSk6bWUuRU5PRU5UfSxNQVhfT1BFTl9GRFM6NDA5NixuZXh0ZmQ6ZnVuY3Rpb24oZSx0KXtlPWV8fDAsdD10fHxUZS5NQVhfT1BFTl9GRFM7Zm9yKHZhciByPWU7cjw9dDtyKyspaWYoIVRlLnN0cmVhbXNbcl0pcmV0dXJuIHI7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU1GSUxFKX0sZ2V0U3RyZWFtOmZ1bmN0aW9uKGUpe3JldHVybiBUZS5zdHJlYW1zW2VdfSxjcmVhdGVTdHJlYW06ZnVuY3Rpb24oZSx0LHIpe1RlLkZTU3RyZWFtfHwoVGUuRlNTdHJlYW09ZnVuY3Rpb24oKXt9LFRlLkZTU3RyZWFtLnByb3RvdHlwZT17fSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyhUZS5GU1N0cmVhbS5wcm90b3R5cGUse29iamVjdDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubm9kZX0sc2V0OmZ1bmN0aW9uKGUpe3RoaXMubm9kZT1lfX0saXNSZWFkOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMSE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc1dyaXRlOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMCE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc0FwcGVuZDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIDEwMjQmdGhpcy5mbGFnc319fSkpO3ZhciBuPW5ldyBUZS5GU1N0cmVhbTtmb3IodmFyIG8gaW4gZSluW29dPWVbb107ZT1uO3ZhciBpPVRlLm5leHRmZCh0LHIpO3JldHVybiBlLmZkPWksVGUuc3RyZWFtc1tpXT1lLGV9LGNsb3NlU3RyZWFtOmZ1bmN0aW9uKGUpe1RlLnN0cmVhbXNbZV09bnVsbH0sY2hyZGV2X3N0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuZ2V0RGV2aWNlKGUubm9kZS5yZGV2KTtlLnN0cmVhbV9vcHM9dC5zdHJlYW1fb3BzLGUuc3RyZWFtX29wcy5vcGVuJiZlLnN0cmVhbV9vcHMub3BlbihlKX0sbGxzZWVrOmZ1bmN0aW9uKCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKX19LG1ham9yOmZ1bmN0aW9uKGUpe3JldHVybiBlPj44fSxtaW5vcjpmdW5jdGlvbihlKXtyZXR1cm4gMjU1JmV9LG1ha2VkZXY6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZTw8OHx0fSxyZWdpc3RlckRldmljZTpmdW5jdGlvbihlLHQpe1RlLmRldmljZXNbZV09e3N0cmVhbV9vcHM6dH19LGdldERldmljZTpmdW5jdGlvbihlKXtyZXR1cm4gVGUuZGV2aWNlc1tlXX0sZ2V0TW91bnRzOmZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPVtlXTtyLmxlbmd0aDspe3ZhciBuPXIucG9wKCk7dC5wdXNoKG4pLHIucHVzaC5hcHBseShyLG4ubW91bnRzKX1yZXR1cm4gdH0sc3luY2ZzOmZ1bmN0aW9uKGUsdCl7ImZ1bmN0aW9uIj09dHlwZW9mIGUmJih0PWUsZT0hMSksVGUuc3luY0ZTUmVxdWVzdHMrKyxUZS5zeW5jRlNSZXF1ZXN0cz4xJiZjb25zb2xlLmxvZygid2FybmluZzogIitUZS5zeW5jRlNSZXF1ZXN0cysiIEZTLnN5bmNmcyBvcGVyYXRpb25zIGluIGZsaWdodCBhdCBvbmNlLCBwcm9iYWJseSBqdXN0IGRvaW5nIGV4dHJhIHdvcmsiKTt2YXIgcj1UZS5nZXRNb3VudHMoVGUucm9vdC5tb3VudCksbj0wO2Z1bmN0aW9uIG8oZSl7cmV0dXJuIHkoVGUuc3luY0ZTUmVxdWVzdHM+MCksVGUuc3luY0ZTUmVxdWVzdHMtLSx0KGUpfWZ1bmN0aW9uIGkoZSl7aWYoZSlyZXR1cm4gaS5lcnJvcmVkP3ZvaWQgMDooaS5lcnJvcmVkPSEwLG8oZSkpOysrbj49ci5sZW5ndGgmJm8obnVsbCl9ci5mb3JFYWNoKChmdW5jdGlvbih0KXtpZighdC50eXBlLnN5bmNmcylyZXR1cm4gaShudWxsKTt0LnR5cGUuc3luY2ZzKHQsZSxpKX0pKX0sbW91bnQ6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG89Ii8iPT09cixpPSFyO2lmKG8mJlRlLnJvb3QpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFvJiYhaSl7dmFyIGE9VGUubG9va3VwUGF0aChyLHtmb2xsb3dfbW91bnQ6ITF9KTtpZihyPWEucGF0aCxuPWEubm9kZSxUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFUZS5pc0RpcihuLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpfXZhciBzPXt0eXBlOmUsb3B0czp0LG1vdW50cG9pbnQ6cixtb3VudHM6W119LHU9ZS5tb3VudChzKTtyZXR1cm4gdS5tb3VudD1zLHMucm9vdD11LG8/VGUucm9vdD11Om4mJihuLm1vdW50ZWQ9cyxuLm1vdW50JiZuLm1vdW50Lm1vdW50cy5wdXNoKHMpKSx1fSx1bm1vdW50OmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93X21vdW50OiExfSk7aWYoIVRlLmlzTW91bnRwb2ludCh0Lm5vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI9dC5ub2RlLG49ci5tb3VudGVkLG89VGUuZ2V0TW91bnRzKG4pO09iamVjdC5rZXlzKFRlLm5hbWVUYWJsZSkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7Zm9yKHZhciB0PVRlLm5hbWVUYWJsZVtlXTt0Oyl7dmFyIHI9dC5uYW1lX25leHQ7LTEhPT1vLmluZGV4T2YodC5tb3VudCkmJlRlLmRlc3Ryb3lOb2RlKHQpLHQ9cn19KSksci5tb3VudGVkPW51bGw7dmFyIGk9ci5tb3VudC5tb3VudHMuaW5kZXhPZihuKTt5KC0xIT09aSksci5tb3VudC5tb3VudHMuc3BsaWNlKGksMSl9LGxvb2t1cDpmdW5jdGlvbihlLHQpe3JldHVybiBlLm5vZGVfb3BzLmxvb2t1cChlLHQpfSxta25vZDpmdW5jdGlvbihlLHQscil7dmFyIG49VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG89Z2UuYmFzZW5hbWUoZSk7aWYoIW98fCIuIj09PW98fCIuLiI9PT1vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9VGUubWF5Q3JlYXRlKG4sbyk7aWYoaSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihpKTtpZighbi5ub2RlX29wcy5ta25vZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIG4ubm9kZV9vcHMubWtub2QobixvLHQscil9LGNyZWF0ZTpmdW5jdGlvbihlLHQpe3JldHVybiB0PXZvaWQgMCE9PXQ/dDo0MzgsdCY9NDA5NSx0fD0zMjc2OCxUZS5ta25vZChlLHQsMCl9LG1rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ9dm9pZCAwIT09dD90OjUxMSx0Jj0xMDIzLHR8PTE2Mzg0LFRlLm1rbm9kKGUsdCwwKX0sbWtkaXJUcmVlOmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPWUuc3BsaXQoIi8iKSxuPSIiLG89MDtvPHIubGVuZ3RoOysrbylpZihyW29dKXtuKz0iLyIrcltvXTt0cnl7VGUubWtkaXIobix0KX1jYXRjaChlKXtpZihlLmVycm5vIT1tZS5FRVhJU1QpdGhyb3cgZX19fSxta2RldjpmdW5jdGlvbihlLHQscil7cmV0dXJuIHZvaWQgMD09PXImJihyPXQsdD00MzgpLHR8PTgxOTIsVGUubWtub2QoZSx0LHIpfSxzeW1saW5rOmZ1bmN0aW9uKGUsdCl7aWYoIWdlLnJlc29sdmUoZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgcj1UZS5sb29rdXBQYXRoKHQse3BhcmVudDohMH0pLm5vZGU7aWYoIXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgbj1nZS5iYXNlbmFtZSh0KSxvPVRlLm1heUNyZWF0ZShyLG4pO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXIubm9kZV9vcHMuc3ltbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuc3ltbGluayhyLG4sZSl9LHJlbmFtZTpmdW5jdGlvbihlLHQpe3ZhciByLG4sbz1nZS5kaXJuYW1lKGUpLGk9Z2UuZGlybmFtZSh0KSxhPWdlLmJhc2VuYW1lKGUpLHM9Z2UuYmFzZW5hbWUodCk7dHJ5e3I9VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG49VGUubG9va3VwUGF0aCh0LHtwYXJlbnQ6ITB9KS5ub2RlfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKX1pZighcnx8IW4pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZihyLm1vdW50IT09bi5tb3VudCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FWERFVik7dmFyIHUsYz1UZS5sb29rdXBOb2RlKHIsYSksbD1nZS5yZWxhdGl2ZShlLGkpO2lmKCIuIiE9PWwuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7aWYoIi4iIT09KGw9Z2UucmVsYXRpdmUodCxvKSkuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7dHJ5e3U9VGUubG9va3VwTm9kZShuLHMpfWNhdGNoKGUpe31pZihjIT09dSl7dmFyIGY9VGUuaXNEaXIoYy5tb2RlKSxkPVRlLm1heURlbGV0ZShyLGEsZik7aWYoZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZihkPXU/VGUubWF5RGVsZXRlKG4scyxmKTpUZS5tYXlDcmVhdGUobixzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZighci5ub2RlX29wcy5yZW5hbWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO2lmKFRlLmlzTW91bnRwb2ludChjKXx8dSYmVGUuaXNNb3VudHBvaW50KHUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTtpZihuIT09ciYmKGQ9VGUubm9kZVBlcm1pc3Npb25zKHIsInciKSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IoZCk7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUud2lsbE1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxNb3ZlUGF0aChlLHQpfWNhdGNoKHIpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsTW92ZVBhdGgnXSgnIitlKyInLCAnIit0KyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrci5tZXNzYWdlKX1UZS5oYXNoUmVtb3ZlTm9kZShjKTt0cnl7ci5ub2RlX29wcy5yZW5hbWUoYyxuLHMpfWNhdGNoKGUpe3Rocm93IGV9ZmluYWxseXtUZS5oYXNoQWRkTm9kZShjKX10cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uTW92ZVBhdGgoZSx0KX1jYXRjaChyKXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25Nb3ZlUGF0aCddKCciK2UrIicsICciK3QrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIityLm1lc3NhZ2UpfX19LHJtZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSkubm9kZSxyPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwTm9kZSh0LHIpLG89VGUubWF5RGVsZXRlKHQsciwhMCk7aWYobyl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihvKTtpZighdC5ub2RlX29wcy5ybWRpcil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7aWYoVGUuaXNNb3VudHBvaW50KG4pKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTt0cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aCYmVGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnd2lsbERlbGV0ZVBhdGgnXSgnIitlKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrdC5tZXNzYWdlKX10Lm5vZGVfb3BzLnJtZGlyKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtpZighdC5ub2RlX29wcy5yZWFkZGlyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpO3JldHVybiB0Lm5vZGVfb3BzLnJlYWRkaXIodCl9LHVubGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUse3BhcmVudDohMH0pLm5vZGUscj1nZS5iYXNlbmFtZShlKSxuPVRlLmxvb2t1cE5vZGUodCxyKSxvPVRlLm1heURlbGV0ZSh0LHIsITEpO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXQubm9kZV9vcHMudW5saW5rKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO3RyeXtUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoKGUpfWNhdGNoKHQpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsRGVsZXRlUGF0aCddKCciK2UrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIit0Lm1lc3NhZ2UpfXQubm9kZV9vcHMudW5saW5rKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkbGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUpLm5vZGU7aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZighdC5ub2RlX29wcy5yZWFkbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBnZS5yZXNvbHZlKFRlLmdldFBhdGgodC5wYXJlbnQpLHQubm9kZV9vcHMucmVhZGxpbmsodCkpfSxzdGF0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KS5ub2RlO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIXIubm9kZV9vcHMuZ2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuZ2V0YXR0cihyKX0sbHN0YXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFRlLnN0YXQoZSwhMCl9LGNobW9kOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbjsic3RyaW5nIj09dHlwZW9mIGU/bj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohcn0pLm5vZGU6bj1lO2lmKCFuLm5vZGVfb3BzLnNldGF0dHIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO24ubm9kZV9vcHMuc2V0YXR0cihuLHttb2RlOjQwOTUmdHwtNDA5NiZuLm1vZGUsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sbGNobW9kOmZ1bmN0aW9uKGUsdCl7VGUuY2htb2QoZSx0LCEwKX0sZmNobW9kOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtUZS5jaG1vZChyLm5vZGUsdCl9LGNob3duOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvOyJzdHJpbmciPT10eXBlb2YgZT9vPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiFufSkubm9kZTpvPWU7aWYoIW8ubm9kZV9vcHMuc2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7by5ub2RlX29wcy5zZXRhdHRyKG8se3RpbWVzdGFtcDpEYXRlLm5vdygpfSl9LGxjaG93bjpmdW5jdGlvbihlLHQscil7VGUuY2hvd24oZSx0LHIsITApfSxmY2hvd246ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7VGUuY2hvd24obi5ub2RlLHQscil9LHRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7aWYodDwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI7InN0cmluZyI9PXR5cGVvZiBlP3I9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KS5ub2RlOnI9ZTtpZighci5ub2RlX29wcy5zZXRhdHRyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc0RpcihyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIVRlLmlzRmlsZShyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG49VGUubm9kZVBlcm1pc3Npb25zKHIsInciKTtpZihuKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4pO3Iubm9kZV9vcHMuc2V0YXR0cihyLHtzaXplOnQsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sZnRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigwPT0oMjA5NzE1NSZyLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO1RlLnRydW5jYXRlKHIubm9kZSx0KX0sdXRpbWU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtuLm5vZGVfb3BzLnNldGF0dHIobix7dGltZXN0YW1wOk1hdGgubWF4KHQscil9KX0sb3BlbjpmdW5jdGlvbihlLHQscixuLGkpe2lmKCIiPT09ZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO3ZhciBhO2lmKHI9dm9pZCAwPT09cj80Mzg6cixyPTY0Jih0PSJzdHJpbmciPT10eXBlb2YgdD9UZS5tb2RlU3RyaW5nVG9GbGFncyh0KTp0KT80MDk1JnJ8MzI3Njg6MCwib2JqZWN0Ij09dHlwZW9mIGUpYT1lO2Vsc2V7ZT1nZS5ub3JtYWxpemUoZSk7dHJ5e2E9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ISgxMzEwNzImdCl9KS5ub2RlfWNhdGNoKGUpe319dmFyIHM9ITE7aWYoNjQmdClpZihhKXtpZigxMjgmdCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FRVhJU1QpfWVsc2UgYT1UZS5ta25vZChlLHIsMCkscz0hMDtpZighYSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO2lmKFRlLmlzQ2hyZGV2KGEubW9kZSkmJih0Jj0tNTEzKSw2NTUzNiZ0JiYhVGUuaXNEaXIoYS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTtpZighcyl7dmFyIHU9VGUubWF5T3BlbihhLHQpO2lmKHUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IodSl9NTEyJnQmJlRlLnRydW5jYXRlKGEsMCksdCY9LTY0MTt2YXIgYz1UZS5jcmVhdGVTdHJlYW0oe25vZGU6YSxwYXRoOlRlLmdldFBhdGgoYSksZmxhZ3M6dCxzZWVrYWJsZTohMCxwb3NpdGlvbjowLHN0cmVhbV9vcHM6YS5zdHJlYW1fb3BzLHVuZ290dGVuOltdLGVycm9yOiExfSxuLGkpO2Muc3RyZWFtX29wcy5vcGVuJiZjLnN0cmVhbV9vcHMub3BlbihjKSwhby5sb2dSZWFkRmlsZXN8fDEmdHx8KFRlLnJlYWRGaWxlc3x8KFRlLnJlYWRGaWxlcz17fSksZSBpbiBUZS5yZWFkRmlsZXN8fChUZS5yZWFkRmlsZXNbZV09MSxvLnByaW50RXJyKCJyZWFkIGZpbGU6ICIrZSkpKTt0cnl7aWYoVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk9wZW5GaWxlKXt2YXIgbD0wOzEhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLlJFQUQpLDAhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLldSSVRFKSxUZS50cmFja2luZ0RlbGVnYXRlLm9uT3BlbkZpbGUoZSxsKX19Y2F0Y2godCl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uT3BlbkZpbGUnXSgnIitlKyInLCBmbGFncykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9cmV0dXJuIGN9LGNsb3NlOmZ1bmN0aW9uKGUpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtlLmdldGRlbnRzJiYoZS5nZXRkZW50cz1udWxsKTt0cnl7ZS5zdHJlYW1fb3BzLmNsb3NlJiZlLnN0cmVhbV9vcHMuY2xvc2UoZSl9Y2F0Y2goZSl7dGhyb3cgZX1maW5hbGx5e1RlLmNsb3NlU3RyZWFtKGUuZmQpfWUuZmQ9bnVsbH0saXNDbG9zZWQ6ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lLmZkfSxsbHNlZWs6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZighZS5zZWVrYWJsZXx8IWUuc3RyZWFtX29wcy5sbHNlZWspdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKTtyZXR1cm4gZS5wb3NpdGlvbj1lLnN0cmVhbV9vcHMubGxzZWVrKGUsdCxyKSxlLnVuZ290dGVuPVtdLGUucG9zaXRpb259LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZihuPDB8fG88MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigxPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoVGUuaXNEaXIoZS5ub2RlLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIWUuc3RyZWFtX29wcy5yZWFkKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9dm9pZCAwIT09bztpZihpKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBhPWUuc3RyZWFtX29wcy5yZWFkKGUsdCxyLG4sbyk7cmV0dXJuIGl8fChlLnBvc2l0aW9uKz1hKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8saSl7aWYobjwwfHxvPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZihUZS5pc0Nsb3NlZChlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoMD09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO2lmKFRlLmlzRGlyKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSVNESVIpO2lmKCFlLnN0cmVhbV9vcHMud3JpdGUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTsxMDI0JmUuZmxhZ3MmJlRlLmxsc2VlayhlLDAsMik7dmFyIGE9dm9pZCAwIT09bztpZihhKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBzPWUuc3RyZWFtX29wcy53cml0ZShlLHQscixuLG8saSk7YXx8KGUucG9zaXRpb24rPXMpO3RyeXtlLnBhdGgmJlRlLnRyYWNraW5nRGVsZWdhdGUub25Xcml0ZVRvRmlsZSYmVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbldyaXRlVG9GaWxlKGUucGF0aCl9Y2F0Y2goZSl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uV3JpdGVUb0ZpbGUnXSgnIitwYXRoKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrZS5tZXNzYWdlKX1yZXR1cm4gc30sYWxsb2NhdGU6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZih0PDB8fHI8PTApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZigwPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoIVRlLmlzRmlsZShlLm5vZGUubW9kZSkmJiFUZS5pc0RpcihlLm5vZGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtpZighZS5zdHJlYW1fb3BzLmFsbG9jYXRlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVPUE5PVFNVUFApO2Uuc3RyZWFtX29wcy5hbGxvY2F0ZShlLHQscil9LG1tYXA6ZnVuY3Rpb24oZSx0LHIsbixvLGksYSl7aWYoMT09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFDQ0VTKTtpZighZS5zdHJlYW1fb3BzLm1tYXApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtyZXR1cm4gZS5zdHJlYW1fb3BzLm1tYXAoZSx0LHIsbixvLGksYSl9LG1zeW5jOmZ1bmN0aW9uKGUsdCxyLG4sbyl7cmV0dXJuIGUmJmUuc3RyZWFtX29wcy5tc3luYz9lLnN0cmVhbV9vcHMubXN5bmMoZSx0LHIsbixvKTowfSxtdW5tYXA6ZnVuY3Rpb24oZSl7cmV0dXJuIDB9LGlvY3RsOmZ1bmN0aW9uKGUsdCxyKXtpZighZS5zdHJlYW1fb3BzLmlvY3RsKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RUWSk7cmV0dXJuIGUuc3RyZWFtX29wcy5pb2N0bChlLHQscil9LHJlYWRGaWxlOmZ1bmN0aW9uKGUsdCl7aWYoKHQ9dHx8e30pLmZsYWdzPXQuZmxhZ3N8fCJyIix0LmVuY29kaW5nPXQuZW5jb2Rpbmd8fCJiaW5hcnkiLCJ1dGY4IiE9PXQuZW5jb2RpbmcmJiJiaW5hcnkiIT09dC5lbmNvZGluZyl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5jb2RpbmcgdHlwZSAiJyt0LmVuY29kaW5nKyciJyk7dmFyIHIsbj1UZS5vcGVuKGUsdC5mbGFncyksbz1UZS5zdGF0KGUpLnNpemUsaT1uZXcgVWludDhBcnJheShvKTtyZXR1cm4gVGUucmVhZChuLGksMCxvLDApLCJ1dGY4Ij09PXQuZW5jb2Rpbmc/cj1fKGksMCk6ImJpbmFyeSI9PT10LmVuY29kaW5nJiYocj1pKSxUZS5jbG9zZShuKSxyfSx3cml0ZUZpbGU6ZnVuY3Rpb24oZSx0LHIpeyhyPXJ8fHt9KS5mbGFncz1yLmZsYWdzfHwidyI7dmFyIG49VGUub3BlbihlLHIuZmxhZ3Msci5tb2RlKTtpZigic3RyaW5nIj09dHlwZW9mIHQpe3ZhciBvPW5ldyBVaW50OEFycmF5KFModCkrMSksaT1BKHQsbywwLG8ubGVuZ3RoKTtUZS53cml0ZShuLG8sMCxpLHZvaWQgMCxyLmNhbk93bil9ZWxzZXtpZighQXJyYXlCdWZmZXIuaXNWaWV3KHQpKXRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgZGF0YSB0eXBlIik7VGUud3JpdGUobix0LDAsdC5ieXRlTGVuZ3RoLHZvaWQgMCxyLmNhbk93bil9VGUuY2xvc2Uobil9LGN3ZDpmdW5jdGlvbigpe3JldHVybiBUZS5jdXJyZW50UGF0aH0sY2hkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KTtpZihudWxsPT09dC5ub2RlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIVRlLmlzRGlyKHQubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTt2YXIgcj1UZS5ub2RlUGVybWlzc2lvbnModC5ub2RlLCJ4Iik7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyKTtUZS5jdXJyZW50UGF0aD10LnBhdGh9LGNyZWF0ZURlZmF1bHREaXJlY3RvcmllczpmdW5jdGlvbigpe1RlLm1rZGlyKCIvdG1wIiksVGUubWtkaXIoIi9ob21lIiksVGUubWtkaXIoIi9ob21lL3dlYl91c2VyIil9LGNyZWF0ZURlZmF1bHREZXZpY2VzOmZ1bmN0aW9uKCl7dmFyIGU7aWYoVGUubWtkaXIoIi9kZXYiKSxUZS5yZWdpc3RlckRldmljZShUZS5tYWtlZGV2KDEsMykse3JlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gMH0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtyZXR1cm4gbn19KSxUZS5ta2RldigiL2Rldi9udWxsIixUZS5tYWtlZGV2KDEsMykpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNSwwKSx2ZS5kZWZhdWx0X3R0eV9vcHMpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNiwwKSx2ZS5kZWZhdWx0X3R0eTFfb3BzKSxUZS5ta2RldigiL2Rldi90dHkiLFRlLm1ha2VkZXYoNSwwKSksVGUubWtkZXYoIi9kZXYvdHR5MSIsVGUubWFrZWRldig2LDApKSwidW5kZWZpbmVkIiE9dHlwZW9mIGNyeXB0byl7dmFyIHQ9bmV3IFVpbnQ4QXJyYXkoMSk7ZT1mdW5jdGlvbigpe3JldHVybiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKHQpLHRbMF19fWVsc2UgZT1sP2Z1bmN0aW9uKCl7cmV0dXJuIHJlcXVpcmUoImNyeXB0byIpLnJhbmRvbUJ5dGVzKDEpWzBdfTpmdW5jdGlvbigpe3JldHVybiAyNTYqTWF0aC5yYW5kb20oKXwwfTtUZS5jcmVhdGVEZXZpY2UoIi9kZXYiLCJyYW5kb20iLGUpLFRlLmNyZWF0ZURldmljZSgiL2RldiIsInVyYW5kb20iLGUpLFRlLm1rZGlyKCIvZGV2L3NobSIpLFRlLm1rZGlyKCIvZGV2L3NobS90bXAiKX0sY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzOmZ1bmN0aW9uKCl7VGUubWtkaXIoIi9wcm9jIiksVGUubWtkaXIoIi9wcm9jL3NlbGYiKSxUZS5ta2RpcigiL3Byb2Mvc2VsZi9mZCIpLFRlLm1vdW50KHttb3VudDpmdW5jdGlvbigpe3ZhciBlPVRlLmNyZWF0ZU5vZGUoIi9wcm9jL3NlbGYiLCJmZCIsMTY4OTUsNzMpO3JldHVybiBlLm5vZGVfb3BzPXtsb29rdXA6ZnVuY3Rpb24oZSx0KXt2YXIgcj0rdCxuPVRlLmdldFN0cmVhbShyKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7dmFyIG89e3BhcmVudDpudWxsLG1vdW50Onttb3VudHBvaW50OiJmYWtlIn0sbm9kZV9vcHM6e3JlYWRsaW5rOmZ1bmN0aW9uKCl7cmV0dXJuIG4ucGF0aH19fTtyZXR1cm4gby5wYXJlbnQ9byxvfX0sZX19LHt9LCIvcHJvYy9zZWxmL2ZkIil9LGNyZWF0ZVN0YW5kYXJkU3RyZWFtczpmdW5jdGlvbigpe28uc3RkaW4/VGUuY3JlYXRlRGV2aWNlKCIvZGV2Iiwic3RkaW4iLG8uc3RkaW4pOlRlLnN5bWxpbmsoIi9kZXYvdHR5IiwiL2Rldi9zdGRpbiIpLG8uc3Rkb3V0P1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZG91dCIsbnVsbCxvLnN0ZG91dCk6VGUuc3ltbGluaygiL2Rldi90dHkiLCIvZGV2L3N0ZG91dCIpLG8uc3RkZXJyP1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZGVyciIsbnVsbCxvLnN0ZGVycik6VGUuc3ltbGluaygiL2Rldi90dHkxIiwiL2Rldi9zdGRlcnIiKTt2YXIgZT1UZS5vcGVuKCIvZGV2L3N0ZGluIiwiciIpO3koMD09PWUuZmQsImludmFsaWQgaGFuZGxlIGZvciBzdGRpbiAoIitlLmZkKyIpIik7dmFyIHQ9VGUub3BlbigiL2Rldi9zdGRvdXQiLCJ3Iik7eSgxPT09dC5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZG91dCAoIit0LmZkKyIpIik7dmFyIHI9VGUub3BlbigiL2Rldi9zdGRlcnIiLCJ3Iik7eSgyPT09ci5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZGVyciAoIityLmZkKyIpIil9LGVuc3VyZUVycm5vRXJyb3I6ZnVuY3Rpb24oKXtUZS5FcnJub0Vycm9yfHwoVGUuRXJybm9FcnJvcj1mdW5jdGlvbihlLHQpe3RoaXMubm9kZT10LHRoaXMuc2V0RXJybm89ZnVuY3Rpb24oZSl7Zm9yKHZhciB0IGluIHRoaXMuZXJybm89ZSxtZSlpZihtZVt0XT09PWUpe3RoaXMuY29kZT10O2JyZWFrfX0sdGhpcy5zZXRFcnJubyhlKSx0aGlzLm1lc3NhZ2U9RWVbZV0sdGhpcy5zdGFjayYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsInN0YWNrIix7dmFsdWU6KG5ldyBFcnJvcikuc3RhY2ssd3JpdGFibGU6ITB9KX0sVGUuRXJybm9FcnJvci5wcm90b3R5cGU9bmV3IEVycm9yLFRlLkVycm5vRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yPVRlLkVycm5vRXJyb3IsW21lLkVOT0VOVF0uZm9yRWFjaCgoZnVuY3Rpb24oZSl7VGUuZ2VuZXJpY0Vycm9yc1tlXT1uZXcgVGUuRXJybm9FcnJvcihlKSxUZS5nZW5lcmljRXJyb3JzW2VdLnN0YWNrPSI8Z2VuZXJpYyBlcnJvciwgbm8gc3RhY2s+In0pKSl9LHN0YXRpY0luaXQ6ZnVuY3Rpb24oKXtUZS5lbnN1cmVFcnJub0Vycm9yKCksVGUubmFtZVRhYmxlPW5ldyBBcnJheSg0MDk2KSxUZS5tb3VudCh3ZSx7fSwiLyIpLFRlLmNyZWF0ZURlZmF1bHREaXJlY3RvcmllcygpLFRlLmNyZWF0ZURlZmF1bHREZXZpY2VzKCksVGUuY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzKCksVGUuZmlsZXN5c3RlbXM9e01FTUZTOndlLElEQkZTOl9lLE5PREVGUzpiZSxXT1JLRVJGUzpBZX19LGluaXQ6ZnVuY3Rpb24oZSx0LHIpe3koIVRlLmluaXQuaW5pdGlhbGl6ZWQsIkZTLmluaXQgd2FzIHByZXZpb3VzbHkgY2FsbGVkLiBJZiB5b3Ugd2FudCB0byBpbml0aWFsaXplIGxhdGVyIHdpdGggY3VzdG9tIHBhcmFtZXRlcnMsIHJlbW92ZSBhbnkgZWFybGllciBjYWxscyAobm90ZSB0aGF0IG9uZSBpcyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSBnZW5lcmF0ZWQgY29kZSkiKSxUZS5pbml0LmluaXRpYWxpemVkPSEwLFRlLmVuc3VyZUVycm5vRXJyb3IoKSxvLnN0ZGluPWV8fG8uc3RkaW4sby5zdGRvdXQ9dHx8by5zdGRvdXQsby5zdGRlcnI9cnx8by5zdGRlcnIsVGUuY3JlYXRlU3RhbmRhcmRTdHJlYW1zKCl9LHF1aXQ6ZnVuY3Rpb24oKXtUZS5pbml0LmluaXRpYWxpemVkPSExO3ZhciBlPW8uX2ZmbHVzaDtlJiZlKDApO2Zvcih2YXIgdD0wO3Q8VGUuc3RyZWFtcy5sZW5ndGg7dCsrKXt2YXIgcj1UZS5zdHJlYW1zW3RdO3ImJlRlLmNsb3NlKHIpfX0sZ2V0TW9kZTpmdW5jdGlvbihlLHQpe3ZhciByPTA7cmV0dXJuIGUmJihyfD0zNjUpLHQmJihyfD0xNDYpLHJ9LGpvaW5QYXRoOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbi5hcHBseShudWxsLGUpO3JldHVybiB0JiYiLyI9PXJbMF0mJihyPXIuc3Vic3RyKDEpKSxyfSxhYnNvbHV0ZVBhdGg6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZ2UucmVzb2x2ZSh0LGUpfSxzdGFuZGFyZGl6ZVBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuIGdlLm5vcm1hbGl6ZShlKX0sZmluZE9iamVjdDpmdW5jdGlvbihlLHQpe3ZhciByPVRlLmFuYWx5emVQYXRoKGUsdCk7cmV0dXJuIHIuZXhpc3RzP3Iub2JqZWN0Oih5ZShyLmVycm9yKSxudWxsKX0sYW5hbHl6ZVBhdGg6ZnVuY3Rpb24oZSx0KXt0cnl7ZT0obj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohdH0pKS5wYXRofWNhdGNoKGUpe312YXIgcj17aXNSb290OiExLGV4aXN0czohMSxlcnJvcjowLG5hbWU6bnVsbCxwYXRoOm51bGwsb2JqZWN0Om51bGwscGFyZW50RXhpc3RzOiExLHBhcmVudFBhdGg6bnVsbCxwYXJlbnRPYmplY3Q6bnVsbH07dHJ5e3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSk7ci5wYXJlbnRFeGlzdHM9ITAsci5wYXJlbnRQYXRoPW4ucGF0aCxyLnBhcmVudE9iamVjdD1uLm5vZGUsci5uYW1lPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KSxyLmV4aXN0cz0hMCxyLnBhdGg9bi5wYXRoLHIub2JqZWN0PW4ubm9kZSxyLm5hbWU9bi5ub2RlLm5hbWUsci5pc1Jvb3Q9Ii8iPT09bi5wYXRofWNhdGNoKGUpe3IuZXJyb3I9ZS5lcnJub31yZXR1cm4gcn0sY3JlYXRlRm9sZGVyOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKHIsbik7cmV0dXJuIFRlLm1rZGlyKG8saSl9LGNyZWF0ZVBhdGg6ZnVuY3Rpb24oZSx0LHIsbil7ZT0ic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpO2Zvcih2YXIgbz10LnNwbGl0KCIvIikucmV2ZXJzZSgpO28ubGVuZ3RoOyl7dmFyIGk9by5wb3AoKTtpZihpKXt2YXIgYT1nZS5qb2luMihlLGkpO3RyeXtUZS5ta2RpcihhKX1jYXRjaChlKXt9ZT1hfX1yZXR1cm4gYX0sY3JlYXRlRmlsZTpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksYT1UZS5nZXRNb2RlKG4sbyk7cmV0dXJuIFRlLmNyZWF0ZShpLGEpfSxjcmVhdGVEYXRhRmlsZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9dD9nZS5qb2luMigic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpLHQpOmUscz1UZS5nZXRNb2RlKG4sbyksdT1UZS5jcmVhdGUoYSxzKTtpZihyKXtpZigic3RyaW5nIj09dHlwZW9mIHIpe2Zvcih2YXIgYz1uZXcgQXJyYXkoci5sZW5ndGgpLGw9MCxmPXIubGVuZ3RoO2w8ZjsrK2wpY1tsXT1yLmNoYXJDb2RlQXQobCk7cj1jfVRlLmNobW9kKHUsMTQ2fHMpO3ZhciBkPVRlLm9wZW4odSwidyIpO1RlLndyaXRlKGQsciwwLHIubGVuZ3RoLDAsaSksVGUuY2xvc2UoZCksVGUuY2htb2QodSxzKX1yZXR1cm4gdX0sY3JlYXRlRGV2aWNlOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKCEhciwhIW4pO1RlLmNyZWF0ZURldmljZS5tYWpvcnx8KFRlLmNyZWF0ZURldmljZS5tYWpvcj02NCk7dmFyIGE9VGUubWFrZWRldihUZS5jcmVhdGVEZXZpY2UubWFqb3IrKywwKTtyZXR1cm4gVGUucmVnaXN0ZXJEZXZpY2UoYSx7b3BlbjpmdW5jdGlvbihlKXtlLnNlZWthYmxlPSExfSxjbG9zZTpmdW5jdGlvbihlKXtuJiZuLmJ1ZmZlciYmbi5idWZmZXIubGVuZ3RoJiZuKDEwKX0scmVhZDpmdW5jdGlvbihlLHQsbixvLGkpe2Zvcih2YXIgYT0wLHM9MDtzPG87cysrKXt2YXIgdTt0cnl7dT1yKCl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKX1pZih2b2lkIDA9PT11JiYwPT09YSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQUdBSU4pO2lmKG51bGw9PXUpYnJlYWs7YSsrLHRbbitzXT11fXJldHVybiBhJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixvLGkpe2Zvcih2YXIgYT0wO2E8bzthKyspdHJ5e24odFtyK2FdKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pfXJldHVybiBvJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfX0pLFRlLm1rZGV2KG8saSxhKX0sY3JlYXRlTGluazpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCk7cmV0dXJuIFRlLnN5bWxpbmsocixpKX0sZm9yY2VMb2FkRmlsZTpmdW5jdGlvbihlKXtpZihlLmlzRGV2aWNlfHxlLmlzRm9sZGVyfHxlLmxpbmt8fGUuY29udGVudHMpcmV0dXJuITA7dmFyIHQ9ITA7aWYoInVuZGVmaW5lZCIhPXR5cGVvZiBYTUxIdHRwUmVxdWVzdCl0aHJvdyBuZXcgRXJyb3IoIkxhenkgbG9hZGluZyBzaG91bGQgaGF2ZSBiZWVuIHBlcmZvcm1lZCAoY29udGVudHMgc2V0KSBpbiBjcmVhdGVMYXp5RmlsZSwgYnV0IGl0IHdhcyBub3QuIExhenkgbG9hZGluZyBvbmx5IHdvcmtzIGluIHdlYiB3b3JrZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2Mgb24gdGhlIG1haW4gdGhyZWFkLiIpO2lmKCFvLnJlYWQpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgbG9hZCB3aXRob3V0IHJlYWQoKSBvciBYTUxIdHRwUmVxdWVzdC4iKTt0cnl7ZS5jb250ZW50cz0kdChvLnJlYWQoZS51cmwpLCEwKSxlLnVzZWRCeXRlcz1lLmNvbnRlbnRzLmxlbmd0aH1jYXRjaChlKXt0PSExfXJldHVybiB0fHx5ZShtZS5FSU8pLHR9LGNyZWF0ZUxhenlGaWxlOmZ1bmN0aW9uKGUsdCxyLG4sbyl7ZnVuY3Rpb24gaSgpe3RoaXMubGVuZ3RoS25vd249ITEsdGhpcy5jaHVua3M9W119aWYoaS5wcm90b3R5cGUuZ2V0PWZ1bmN0aW9uKGUpe2lmKCEoZT50aGlzLmxlbmd0aC0xfHxlPDApKXt2YXIgdD1lJXRoaXMuY2h1bmtTaXplLHI9ZS90aGlzLmNodW5rU2l6ZXwwO3JldHVybiB0aGlzLmdldHRlcihyKVt0XX19LGkucHJvdG90eXBlLnNldERhdGFHZXR0ZXI9ZnVuY3Rpb24oZSl7dGhpcy5nZXR0ZXI9ZX0saS5wcm90b3R5cGUuY2FjaGVMZW5ndGg9ZnVuY3Rpb24oKXt2YXIgZT1uZXcgWE1MSHR0cFJlcXVlc3Q7aWYoZS5vcGVuKCJIRUFEIixyLCExKSxlLnNlbmQobnVsbCksIShlLnN0YXR1cz49MjAwJiZlLnN0YXR1czwzMDB8fDMwND09PWUuc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitlLnN0YXR1cyk7dmFyIHQsbj1OdW1iZXIoZS5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1sZW5ndGgiKSksbz0odD1lLmdldFJlc3BvbnNlSGVhZGVyKCJBY2NlcHQtUmFuZ2VzIikpJiYiYnl0ZXMiPT09dCxpPSh0PWUuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtRW5jb2RpbmciKSkmJiJnemlwIj09PXQsYT0xMDQ4NTc2O298fChhPW4pO3ZhciBzPXRoaXM7cy5zZXREYXRhR2V0dGVyKChmdW5jdGlvbihlKXt2YXIgdD1lKmEsbz0oZSsxKSphLTE7aWYobz1NYXRoLm1pbihvLG4tMSksdm9pZCAwPT09cy5jaHVua3NbZV0mJihzLmNodW5rc1tlXT1mdW5jdGlvbihlLHQpe2lmKGU+dCl0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgcmFuZ2UgKCIrZSsiLCAiK3QrIikgb3Igbm8gYnl0ZXMgcmVxdWVzdGVkISIpO2lmKHQ+bi0xKXRocm93IG5ldyBFcnJvcigib25seSAiK24rIiBieXRlcyBhdmFpbGFibGUhIHByb2dyYW1tZXIgZXJyb3IhIik7dmFyIG89bmV3IFhNTEh0dHBSZXF1ZXN0O2lmKG8ub3BlbigiR0VUIixyLCExKSxuIT09YSYmby5zZXRSZXF1ZXN0SGVhZGVyKCJSYW5nZSIsImJ5dGVzPSIrZSsiLSIrdCksInVuZGVmaW5lZCIhPXR5cGVvZiBVaW50OEFycmF5JiYoby5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIiksby5vdmVycmlkZU1pbWVUeXBlJiZvLm92ZXJyaWRlTWltZVR5cGUoInRleHQvcGxhaW47IGNoYXJzZXQ9eC11c2VyLWRlZmluZWQiKSxvLnNlbmQobnVsbCksIShvLnN0YXR1cz49MjAwJiZvLnN0YXR1czwzMDB8fDMwND09PW8uc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitvLnN0YXR1cyk7cmV0dXJuIHZvaWQgMCE9PW8ucmVzcG9uc2U/bmV3IFVpbnQ4QXJyYXkoby5yZXNwb25zZXx8W10pOiR0KG8ucmVzcG9uc2VUZXh0fHwiIiwhMCl9KHQsbykpLHZvaWQgMD09PXMuY2h1bmtzW2VdKXRocm93IG5ldyBFcnJvcigiZG9YSFIgZmFpbGVkISIpO3JldHVybiBzLmNodW5rc1tlXX0pKSwhaSYmbnx8KGE9bj0xLG49dGhpcy5nZXR0ZXIoMCkubGVuZ3RoLGE9bixjb25zb2xlLmxvZygiTGF6eUZpbGVzIG9uIGd6aXAgZm9yY2VzIGRvd25sb2FkIG9mIHRoZSB3aG9sZSBmaWxlIHdoZW4gbGVuZ3RoIGlzIGFjY2Vzc2VkIikpLHRoaXMuX2xlbmd0aD1uLHRoaXMuX2NodW5rU2l6ZT1hLHRoaXMubGVuZ3RoS25vd249ITB9LCJ1bmRlZmluZWQiIT10eXBlb2YgWE1MSHR0cFJlcXVlc3Qpe2lmKCFjKXRocm93IkNhbm5vdCBkbyBzeW5jaHJvbm91cyBiaW5hcnkgWEhScyBvdXRzaWRlIHdlYndvcmtlcnMgaW4gbW9kZXJuIGJyb3dzZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2MiO3ZhciBhPW5ldyBpO09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGEse2xlbmd0aDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubGVuZ3RoS25vd258fHRoaXMuY2FjaGVMZW5ndGgoKSx0aGlzLl9sZW5ndGh9fSxjaHVua1NpemU6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmxlbmd0aEtub3dufHx0aGlzLmNhY2hlTGVuZ3RoKCksdGhpcy5fY2h1bmtTaXplfX19KTt2YXIgcz17aXNEZXZpY2U6ITEsY29udGVudHM6YX19ZWxzZSBzPXtpc0RldmljZTohMSx1cmw6cn07dmFyIHU9VGUuY3JlYXRlRmlsZShlLHQscyxuLG8pO3MuY29udGVudHM/dS5jb250ZW50cz1zLmNvbnRlbnRzOnMudXJsJiYodS5jb250ZW50cz1udWxsLHUudXJsPXMudXJsKSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyh1LHt1c2VkQnl0ZXM6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmNvbnRlbnRzLmxlbmd0aH19fSk7dmFyIGw9e307cmV0dXJuIE9iamVjdC5rZXlzKHUuc3RyZWFtX29wcykuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9dS5zdHJlYW1fb3BzW2VdO2xbZV09ZnVuY3Rpb24oKXtpZighVGUuZm9yY2VMb2FkRmlsZSh1KSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pO3JldHVybiB0LmFwcGx5KG51bGwsYXJndW1lbnRzKX19KSksbC5yZWFkPWZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoIVRlLmZvcmNlTG9hZEZpbGUodSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKTt2YXIgaT1lLm5vZGUuY29udGVudHM7aWYobz49aS5sZW5ndGgpcmV0dXJuIDA7dmFyIGE9TWF0aC5taW4oaS5sZW5ndGgtbyxuKTtpZih5KGE+PTApLGkuc2xpY2UpZm9yKHZhciBzPTA7czxhO3MrKyl0W3Irc109aVtvK3NdO2Vsc2UgZm9yKHM9MDtzPGE7cysrKXRbcitzXT1pLmdldChvK3MpO3JldHVybiBhfSx1LnN0cmVhbV9vcHM9bCx1fSxjcmVhdGVQcmVsb2FkZWRGaWxlOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwpe0Jyb3dzZXIuaW5pdCgpO3ZhciBmPXQ/Z2UucmVzb2x2ZShnZS5qb2luMihlLHQpKTplO2Z1bmN0aW9uIGQocil7ZnVuY3Rpb24gZChyKXtsJiZsKCksdXx8VGUuY3JlYXRlRGF0YUZpbGUoZSx0LHIsbixpLGMpLGEmJmEoKSxsZSgpfXZhciBoPSExO28ucHJlbG9hZFBsdWdpbnMuZm9yRWFjaCgoZnVuY3Rpb24oZSl7aHx8ZS5jYW5IYW5kbGUoZikmJihlLmhhbmRsZShyLGYsZCwoZnVuY3Rpb24oKXtzJiZzKCksbGUoKX0pKSxoPSEwKX0pKSxofHxkKHIpfWNlKCksInN0cmluZyI9PXR5cGVvZiByP0Jyb3dzZXIuYXN5bmNMb2FkKHIsKGZ1bmN0aW9uKGUpe2QoZSl9KSxzKTpkKHIpfSxpbmRleGVkREI6ZnVuY3Rpb24oKXtyZXR1cm4gd2luZG93LmluZGV4ZWREQnx8d2luZG93Lm1vekluZGV4ZWREQnx8d2luZG93LndlYmtpdEluZGV4ZWREQnx8d2luZG93Lm1zSW5kZXhlZERCfSxEQl9OQU1FOmZ1bmN0aW9uKCl7cmV0dXJuIkVNX0ZTXyIrd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lfSxEQl9WRVJTSU9OOjIwLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsc2F2ZUZpbGVzVG9EQjpmdW5jdGlvbihlLHQscil7dD10fHxmdW5jdGlvbigpe30scj1yfHxmdW5jdGlvbigpe307dmFyIG49VGUuaW5kZXhlZERCKCk7dHJ5e3ZhciBvPW4ub3BlbihUZS5EQl9OQU1FKCksVGUuREJfVkVSU0lPTil9Y2F0Y2goZSl7cmV0dXJuIHIoZSl9by5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oKXtjb25zb2xlLmxvZygiY3JlYXRpbmcgZGIiKSxvLnJlc3VsdC5jcmVhdGVPYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKX0sby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdC50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWR3cml0ZSIpLGk9bi5vYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKSxhPTAscz0wLHU9ZS5sZW5ndGg7ZnVuY3Rpb24gYygpezA9PXM/dCgpOnIoKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe3ZhciB0PWkucHV0KFRlLmFuYWx5emVQYXRoKGUpLm9iamVjdC5jb250ZW50cyxlKTt0Lm9uc3VjY2Vzcz1mdW5jdGlvbigpeysrYStzPT11JiZjKCl9LHQub25lcnJvcj1mdW5jdGlvbigpe3MrKyxhK3M9PXUmJmMoKX19KSksbi5vbmVycm9yPXJ9LG8ub25lcnJvcj1yfSxsb2FkRmlsZXNGcm9tREI6ZnVuY3Rpb24oZSx0LHIpe3Q9dHx8ZnVuY3Rpb24oKXt9LHI9cnx8ZnVuY3Rpb24oKXt9O3ZhciBuPVRlLmluZGV4ZWREQigpO3RyeXt2YXIgbz1uLm9wZW4oVGUuREJfTkFNRSgpLFRlLkRCX1ZFUlNJT04pfWNhdGNoKGUpe3JldHVybiByKGUpfW8ub251cGdyYWRlbmVlZGVkPXIsby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdDt0cnl7dmFyIGk9bi50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWRvbmx5Iil9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgcihlKX12YXIgYT1pLm9iamVjdFN0b3JlKFRlLkRCX1NUT1JFX05BTUUpLHM9MCx1PTAsYz1lLmxlbmd0aDtmdW5jdGlvbiBsKCl7MD09dT90KCk6cigpfWUuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9YS5nZXQoZSk7dC5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXtUZS5hbmFseXplUGF0aChlKS5leGlzdHMmJlRlLnVubGluayhlKSxUZS5jcmVhdGVEYXRhRmlsZShnZS5kaXJuYW1lKGUpLGdlLmJhc2VuYW1lKGUpLHQucmVzdWx0LCEwLCEwLCEwKSwrK3MrdT09YyYmbCgpfSx0Lm9uZXJyb3I9ZnVuY3Rpb24oKXt1Kysscyt1PT1jJiZsKCl9fSkpLGkub25lcnJvcj1yfSxvLm9uZXJyb3I9cn19LFNlPXtERUZBVUxUX1BPTExNQVNLOjUsbWFwcGluZ3M6e30sdW1hc2s6NTExLGNhbGN1bGF0ZUF0OmZ1bmN0aW9uKGUsdCl7aWYoIi8iIT09dFswXSl7dmFyIHI7aWYoLTEwMD09PWUpcj1UZS5jd2QoKTtlbHNle3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cj1uLnBhdGh9dD1nZS5qb2luMihyLHQpfXJldHVybiB0fSxkb1N0YXQ6ZnVuY3Rpb24oZSx0LHIpe3RyeXt2YXIgbj1lKHQpfWNhdGNoKGUpe2lmKGUmJmUubm9kZSYmZ2Uubm9ybWFsaXplKHQpIT09Z2Uubm9ybWFsaXplKFRlLmdldFBhdGgoZS5ub2RlKSkpcmV0dXJuLW1lLkVOT1RESVI7dGhyb3cgZX1yZXR1cm4gRltyPj4yXT1uLmRldixGW3IrND4+Ml09MCxGW3IrOD4+Ml09bi5pbm8sRltyKzEyPj4yXT1uLm1vZGUsRltyKzE2Pj4yXT1uLm5saW5rLEZbcisyMD4+Ml09bi51aWQsRltyKzI0Pj4yXT1uLmdpZCxGW3IrMjg+PjJdPW4ucmRldixGW3IrMzI+PjJdPTAsRltyKzM2Pj4yXT1uLnNpemUsRltyKzQwPj4yXT00MDk2LEZbcis0ND4+Ml09bi5ibG9ja3MsRltyKzQ4Pj4yXT1uLmF0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNTI+PjJdPTAsRltyKzU2Pj4yXT1uLm10aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjA+PjJdPTAsRltyKzY0Pj4yXT1uLmN0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjg+PjJdPTAsRltyKzcyPj4yXT1uLmlubywwfSxkb01zeW5jOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPW5ldyBVaW50OEFycmF5KE8uc3ViYXJyYXkoZSxlK3IpKTtUZS5tc3luYyh0LG8sMCxyLG4pfSxkb01rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIi8iPT09KGU9Z2Uubm9ybWFsaXplKGUpKVtlLmxlbmd0aC0xXSYmKGU9ZS5zdWJzdHIoMCxlLmxlbmd0aC0xKSksVGUubWtkaXIoZSx0LDApLDB9LGRvTWtub2Q6ZnVuY3Rpb24oZSx0LHIpe3N3aXRjaCg2MTQ0MCZ0KXtjYXNlIDMyNzY4OmNhc2UgODE5MjpjYXNlIDI0NTc2OmNhc2UgNDA5NjpjYXNlIDQ5MTUyOmJyZWFrO2RlZmF1bHQ6cmV0dXJuLW1lLkVJTlZBTH1yZXR1cm4gVGUubWtub2QoZSx0LHIpLDB9LGRvUmVhZGxpbms6ZnVuY3Rpb24oZSx0LHIpe2lmKHI8PTApcmV0dXJuLW1lLkVJTlZBTDt2YXIgbj1UZS5yZWFkbGluayhlKSxvPU1hdGgubWluKHIsUyhuKSksaT1SW3Qrb107cmV0dXJuIFQobix0LHIrMSksUlt0K29dPWksb30sZG9BY2Nlc3M6ZnVuY3Rpb24oZSx0KXtpZigtOCZ0KXJldHVybi1tZS5FSU5WQUw7dmFyIHI7cj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohMH0pLm5vZGU7dmFyIG49IiI7cmV0dXJuIDQmdCYmKG4rPSJyIiksMiZ0JiYobis9InciKSwxJnQmJihuKz0ieCIpLG4mJlRlLm5vZGVQZXJtaXNzaW9ucyhyLG4pPy1tZS5FQUNDRVM6MH0sZG9EdXA6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShyKTtyZXR1cm4gbiYmVGUuY2xvc2UobiksVGUub3BlbihlLHQsMCxyLHIpLmZkfSxkb1JlYWR2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLnJlYWQoZSxSLGEscyxuKTtpZih1PDApcmV0dXJuLTE7aWYobys9dSx1PHMpYnJlYWt9cmV0dXJuIG99LGRvV3JpdGV2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLndyaXRlKGUsUixhLHMsbik7aWYodTwwKXJldHVybi0xO28rPXV9cmV0dXJuIG99LHZhcmFyZ3M6MCxnZXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFNlLnZhcmFyZ3MrPTQsRltTZS52YXJhcmdzLTQ+PjJdfSxnZXRTdHI6ZnVuY3Rpb24oKXtyZXR1cm4gdihTZS5nZXQoKSl9LGdldFN0cmVhbUZyb21GRDpmdW5jdGlvbigpe3ZhciBlPVRlLmdldFN0cmVhbShTZS5nZXQoKSk7aWYoIWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO3JldHVybiBlfSxnZXRTb2NrZXRGcm9tRkQ6ZnVuY3Rpb24oKXt2YXIgZT1TT0NLRlMuZ2V0U29ja2V0KFNlLmdldCgpKTtpZighZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cmV0dXJuIGV9LGdldFNvY2tldEFkZHJlc3M6ZnVuY3Rpb24oZSl7dmFyIHQ9U2UuZ2V0KCkscj1TZS5nZXQoKTtpZihlJiYwPT09dClyZXR1cm4gbnVsbDt2YXIgbj1fX3JlYWRfc29ja2FkZHIodCxyKTtpZihuLmVycm5vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4uZXJybm8pO3JldHVybiBuLmFkZHI9RE5TLmxvb2t1cF9hZGRyKG4uYWRkcil8fG4uYWRkcixufSxnZXQ2NDpmdW5jdGlvbigpe3ZhciBlPVNlLmdldCgpLHQ9U2UuZ2V0KCk7cmV0dXJuIHkoZT49MD8wPT09dDotMT09PXQpLGV9LGdldFplcm86ZnVuY3Rpb24oKXt5KDA9PT1TZS5nZXQoKSl9fTt2YXIga2U9NDI7dmFyIFBlPXt9O2Z1bmN0aW9uIERlKGUpe2Zvcig7ZS5sZW5ndGg7KXt2YXIgdD1lLnBvcCgpO2UucG9wKCkodCl9fWZ1bmN0aW9uIFJlKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShNW2U+PjJdKX12YXIgT2U9e30sQ2U9e30sTmU9e307ZnVuY3Rpb24gRmUoZSl7aWYodm9pZCAwPT09ZSlyZXR1cm4iX3Vua25vd24iO3ZhciB0PShlPWUucmVwbGFjZSgvW15hLXpBLVowLTlfXS9nLCIkIikpLmNoYXJDb2RlQXQoMCk7cmV0dXJuIHQ+PTQ4JiZ0PD01Nz8iXyIrZTplfWZ1bmN0aW9uIE1lKGUsdCl7cmV0dXJuIGU9RmUoZSksbmV3IEZ1bmN0aW9uKCJib2R5IiwicmV0dXJuIGZ1bmN0aW9uICIrZSsnKCkge1xuICAgICJ1c2Ugc3RyaWN0IjsgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn07XG4nKSh0KX1mdW5jdGlvbiBJZShlLHQpe3ZhciByPU1lKHQsKGZ1bmN0aW9uKGUpe3RoaXMubmFtZT10LHRoaXMubWVzc2FnZT1lO3ZhciByPW5ldyBFcnJvcihlKS5zdGFjazt2b2lkIDAhPT1yJiYodGhpcy5zdGFjaz10aGlzLnRvU3RyaW5nKCkrIlxuIityLnJlcGxhY2UoL15FcnJvcig6W15cbl0qKT9cbi8sIiIpKX0pKTtyZXR1cm4gci5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShlLnByb3RvdHlwZSksci5wcm90b3R5cGUuY29uc3RydWN0b3I9cixyLnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3JldHVybiB2b2lkIDA9PT10aGlzLm1lc3NhZ2U/dGhpcy5uYW1lOnRoaXMubmFtZSsiOiAiK3RoaXMubWVzc2FnZX0scn12YXIgQmU9dm9pZCAwO2Z1bmN0aW9uIExlKGUpe3Rocm93IG5ldyBCZShlKX1mdW5jdGlvbiB4ZShlLHQscil7ZnVuY3Rpb24gbih0KXt2YXIgbj1yKHQpO24ubGVuZ3RoIT09ZS5sZW5ndGgmJkxlKCJNaXNtYXRjaGVkIHR5cGUgY29udmVydGVyIGNvdW50Iik7Zm9yKHZhciBvPTA7bzxlLmxlbmd0aDsrK28pWWUoZVtvXSxuW29dKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe05lW2VdPXR9KSk7dmFyIG89bmV3IEFycmF5KHQubGVuZ3RoKSxpPVtdLGE9MDt0LmZvckVhY2goKGZ1bmN0aW9uKGUsdCl7Q2UuaGFzT3duUHJvcGVydHkoZSk/b1t0XT1DZVtlXTooaS5wdXNoKGUpLE9lLmhhc093blByb3BlcnR5KGUpfHwoT2VbZV09W10pLE9lW2VdLnB1c2goKGZ1bmN0aW9uKCl7b1t0XT1DZVtlXSwrK2E9PT1pLmxlbmd0aCYmbihvKX0pKSl9KSksMD09PWkubGVuZ3RoJiZuKG8pfWZ1bmN0aW9uIGplKGUpe3N3aXRjaChlKXtjYXNlIDE6cmV0dXJuIDA7Y2FzZSAyOnJldHVybiAxO2Nhc2UgNDpyZXR1cm4gMjtjYXNlIDg6cmV0dXJuIDM7ZGVmYXVsdDp0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIHR5cGUgc2l6ZTogIitlKX19dmFyIFVlPXZvaWQgMDtmdW5jdGlvbiB6ZShlKXtmb3IodmFyIHQ9IiIscj1lO09bcl07KXQrPVVlW09bcisrXV07cmV0dXJuIHR9dmFyICRlPXZvaWQgMDtmdW5jdGlvbiBXZShlKXt0aHJvdyBuZXcgJGUoZSl9ZnVuY3Rpb24gWWUoZSx0LHIpe2lmKHI9cnx8e30sISgiYXJnUGFja0FkdmFuY2UiaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigicmVnaXN0ZXJUeXBlIHJlZ2lzdGVyZWRJbnN0YW5jZSByZXF1aXJlcyBhcmdQYWNrQWR2YW5jZSIpO3ZhciBuPXQubmFtZTtpZihlfHxXZSgndHlwZSAiJytuKyciIG11c3QgaGF2ZSBhIHBvc2l0aXZlIGludGVnZXIgdHlwZWlkIHBvaW50ZXInKSxDZS5oYXNPd25Qcm9wZXJ0eShlKSl7aWYoci5pZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zKXJldHVybjtXZSgiQ2Fubm90IHJlZ2lzdGVyIHR5cGUgJyIrbisiJyB0d2ljZSIpfWlmKENlW2VdPXQsZGVsZXRlIE5lW2VdLE9lLmhhc093blByb3BlcnR5KGUpKXt2YXIgbz1PZVtlXTtkZWxldGUgT2VbZV0sby5mb3JFYWNoKChmdW5jdGlvbihlKXtlKCl9KSl9fWZ1bmN0aW9uIFZlKGUpe2lmKCEodGhpcyBpbnN0YW5jZW9mIGV0KSlyZXR1cm4hMTtpZighKGUgaW5zdGFuY2VvZiBldCkpcmV0dXJuITE7Zm9yKHZhciB0PXRoaXMuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Mscj10aGlzLiQkLnB0cixuPWUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Msbz1lLiQkLnB0cjt0LmJhc2VDbGFzczspcj10LnVwY2FzdChyKSx0PXQuYmFzZUNsYXNzO2Zvcig7bi5iYXNlQ2xhc3M7KW89bi51cGNhc3Qobyksbj1uLmJhc2VDbGFzcztyZXR1cm4gdD09PW4mJnI9PT1vfWZ1bmN0aW9uIEhlKGUpe1dlKGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MubmFtZSsiIGluc3RhbmNlIGFscmVhZHkgZGVsZXRlZCIpfWZ1bmN0aW9uIEdlKCl7aWYodGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpcmV0dXJuIHRoaXMuJCQuY291bnQudmFsdWUrPTEsdGhpczt2YXIgZSx0PU9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLHskJDp7dmFsdWU6KGU9dGhpcy4kJCx7Y291bnQ6ZS5jb3VudCxkZWxldGVTY2hlZHVsZWQ6ZS5kZWxldGVTY2hlZHVsZWQscHJlc2VydmVQb2ludGVyT25EZWxldGU6ZS5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSxwdHI6ZS5wdHIscHRyVHlwZTplLnB0clR5cGUsc21hcnRQdHI6ZS5zbWFydFB0cixzbWFydFB0clR5cGU6ZS5zbWFydFB0clR5cGV9KX19KTtyZXR1cm4gdC4kJC5jb3VudC52YWx1ZSs9MSx0LiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSx0fWZ1bmN0aW9uIHFlKCl7dmFyIGU7dGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkJiYhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSYmV2UoIk9iamVjdCBhbHJlYWR5IHNjaGVkdWxlZCBmb3IgZGVsZXRpb24iKSx0aGlzLiQkLmNvdW50LnZhbHVlLT0xLDA9PT10aGlzLiQkLmNvdW50LnZhbHVlJiYoKGU9dGhpcy4kJCkuc21hcnRQdHI/ZS5zbWFydFB0clR5cGUucmF3RGVzdHJ1Y3RvcihlLnNtYXJ0UHRyKTplLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzLnJhd0Rlc3RydWN0b3IoZS5wdHIpKSx0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlfHwodGhpcy4kJC5zbWFydFB0cj12b2lkIDAsdGhpcy4kJC5wdHI9dm9pZCAwKX1mdW5jdGlvbiBYZSgpe3JldHVybiF0aGlzLiQkLnB0cn12YXIgS2U9dm9pZCAwLEplPVtdO2Z1bmN0aW9uIFplKCl7Zm9yKDtKZS5sZW5ndGg7KXt2YXIgZT1KZS5wb3AoKTtlLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSxlLmRlbGV0ZSgpfX1mdW5jdGlvbiBRZSgpe3JldHVybiB0aGlzLiQkLnB0cnx8SGUodGhpcyksdGhpcy4kJC5kZWxldGVTY2hlZHVsZWQmJiF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlJiZXZSgiT2JqZWN0IGFscmVhZHkgc2NoZWR1bGVkIGZvciBkZWxldGlvbiIpLEplLnB1c2godGhpcyksMT09PUplLmxlbmd0aCYmS2UmJktlKFplKSx0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMCx0aGlzfWZ1bmN0aW9uIGV0KCl7fXZhciB0dD17fTtmdW5jdGlvbiBydChlLHQscil7aWYodm9pZCAwPT09ZVt0XS5vdmVybG9hZFRhYmxlKXt2YXIgbj1lW3RdO2VbdF09ZnVuY3Rpb24oKXtyZXR1cm4gZVt0XS5vdmVybG9hZFRhYmxlLmhhc093blByb3BlcnR5KGFyZ3VtZW50cy5sZW5ndGgpfHxXZSgiRnVuY3Rpb24gJyIrcisiJyBjYWxsZWQgd2l0aCBhbiBpbnZhbGlkIG51bWJlciBvZiBhcmd1bWVudHMgKCIrYXJndW1lbnRzLmxlbmd0aCsiKSAtIGV4cGVjdHMgb25lIG9mICgiK2VbdF0ub3ZlcmxvYWRUYWJsZSsiKSEiKSxlW3RdLm92ZXJsb2FkVGFibGVbYXJndW1lbnRzLmxlbmd0aF0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSxlW3RdLm92ZXJsb2FkVGFibGU9W10sZVt0XS5vdmVybG9hZFRhYmxlW24uYXJnQ291bnRdPW59fWZ1bmN0aW9uIG50KGUsdCxyLG4sbyxpLGEscyl7dGhpcy5uYW1lPWUsdGhpcy5jb25zdHJ1Y3Rvcj10LHRoaXMuaW5zdGFuY2VQcm90b3R5cGU9cix0aGlzLnJhd0Rlc3RydWN0b3I9bix0aGlzLmJhc2VDbGFzcz1vLHRoaXMuZ2V0QWN0dWFsVHlwZT1pLHRoaXMudXBjYXN0PWEsdGhpcy5kb3duY2FzdD1zLHRoaXMucHVyZVZpcnR1YWxGdW5jdGlvbnM9W119ZnVuY3Rpb24gb3QoZSx0LHIpe2Zvcig7dCE9PXI7KXQudXBjYXN0fHxXZSgiRXhwZWN0ZWQgbnVsbCBvciBpbnN0YW5jZSBvZiAiK3IubmFtZSsiLCBnb3QgYW4gaW5zdGFuY2Ugb2YgIit0Lm5hbWUpLGU9dC51cGNhc3QoZSksdD10LmJhc2VDbGFzcztyZXR1cm4gZX1mdW5jdGlvbiBpdChlLHQpe2lmKG51bGw9PT10KXJldHVybiB0aGlzLmlzUmVmZXJlbmNlJiZXZSgibnVsbCBpcyBub3QgYSB2YWxpZCAiK3RoaXMubmFtZSksMDt0LiQkfHxXZSgnQ2Fubm90IHBhc3MgIicrT3QodCkrJyIgYXMgYSAnK3RoaXMubmFtZSksdC4kJC5wdHJ8fFdlKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiK3RoaXMubmFtZSk7dmFyIHI9dC4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcztyZXR1cm4gb3QodC4kJC5wdHIscix0aGlzLnJlZ2lzdGVyZWRDbGFzcyl9ZnVuY3Rpb24gYXQoZSx0KXt2YXIgcjtpZihudWxsPT09dClyZXR1cm4gdGhpcy5pc1JlZmVyZW5jZSYmV2UoIm51bGwgaXMgbm90IGEgdmFsaWQgIit0aGlzLm5hbWUpLHRoaXMuaXNTbWFydFBvaW50ZXI/KHI9dGhpcy5yYXdDb25zdHJ1Y3RvcigpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpLHIpOjA7dC4kJHx8V2UoJ0Nhbm5vdCBwYXNzICInK090KHQpKyciIGFzIGEgJyt0aGlzLm5hbWUpLHQuJCQucHRyfHxXZSgiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIit0aGlzLm5hbWUpLCF0aGlzLmlzQ29uc3QmJnQuJCQucHRyVHlwZS5pc0NvbnN0JiZXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgbj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO2lmKHI9b3QodC4kJC5wdHIsbix0aGlzLnJlZ2lzdGVyZWRDbGFzcyksdGhpcy5pc1NtYXJ0UG9pbnRlcilzd2l0Y2godm9pZCAwPT09dC4kJC5zbWFydFB0ciYmV2UoIlBhc3NpbmcgcmF3IHBvaW50ZXIgdG8gc21hcnQgcG9pbnRlciBpcyBpbGxlZ2FsIiksdGhpcy5zaGFyaW5nUG9saWN5KXtjYXNlIDA6dC4kJC5zbWFydFB0clR5cGU9PT10aGlzP3I9dC4kJC5zbWFydFB0cjpXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTticmVhaztjYXNlIDE6cj10LiQkLnNtYXJ0UHRyO2JyZWFrO2Nhc2UgMjppZih0LiQkLnNtYXJ0UHRyVHlwZT09PXRoaXMpcj10LiQkLnNtYXJ0UHRyO2Vsc2V7dmFyIG89dC5jbG9uZSgpO3I9dGhpcy5yYXdTaGFyZShyLFJ0KChmdW5jdGlvbigpe28uZGVsZXRlKCl9KSkpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpfWJyZWFrO2RlZmF1bHQ6V2UoIlVuc3VwcG9ydGluZyBzaGFyaW5nIHBvbGljeSIpfXJldHVybiByfWZ1bmN0aW9uIHN0KGUsdCl7aWYobnVsbD09PXQpcmV0dXJuIHRoaXMuaXNSZWZlcmVuY2UmJldlKCJudWxsIGlzIG5vdCBhIHZhbGlkICIrdGhpcy5uYW1lKSwwO3QuJCR8fFdlKCdDYW5ub3QgcGFzcyAiJytPdCh0KSsnIiBhcyBhICcrdGhpcy5uYW1lKSx0LiQkLnB0cnx8V2UoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIrdGhpcy5uYW1lKSx0LiQkLnB0clR5cGUuaXNDb25zdCYmV2UoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIit0LiQkLnB0clR5cGUubmFtZSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgcj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO3JldHVybiBvdCh0LiQkLnB0cixyLHRoaXMucmVnaXN0ZXJlZENsYXNzKX1mdW5jdGlvbiB1dChlKXtyZXR1cm4gdGhpcy5yYXdHZXRQb2ludGVlJiYoZT10aGlzLnJhd0dldFBvaW50ZWUoZSkpLGV9ZnVuY3Rpb24gY3QoZSl7dGhpcy5yYXdEZXN0cnVjdG9yJiZ0aGlzLnJhd0Rlc3RydWN0b3IoZSl9ZnVuY3Rpb24gbHQoZSl7bnVsbCE9PWUmJmUuZGVsZXRlKCl9ZnVuY3Rpb24gZnQoKXtyZXR1cm4gT2JqZWN0LmtleXMocHQpLmxlbmd0aH1mdW5jdGlvbiBkdCgpe3ZhciBlPVtdO2Zvcih2YXIgdCBpbiBwdClwdC5oYXNPd25Qcm9wZXJ0eSh0KSYmZS5wdXNoKHB0W3RdKTtyZXR1cm4gZX1mdW5jdGlvbiBodChlKXtLZT1lLEplLmxlbmd0aCYmS2UmJktlKFplKX12YXIgcHQ9e307ZnVuY3Rpb24gbXQoZSx0KXtyZXR1cm4gdD1mdW5jdGlvbihlLHQpe2Zvcih2b2lkIDA9PT10JiZXZSgicHRyIHNob3VsZCBub3QgYmUgdW5kZWZpbmVkIik7ZS5iYXNlQ2xhc3M7KXQ9ZS51cGNhc3QodCksZT1lLmJhc2VDbGFzcztyZXR1cm4gdH0oZSx0KSxwdFt0XX1mdW5jdGlvbiB5dChlLHQpe3JldHVybiB0LnB0clR5cGUmJnQucHRyfHxMZSgibWFrZUNsYXNzSGFuZGxlIHJlcXVpcmVzIHB0ciBhbmQgcHRyVHlwZSIpLCEhdC5zbWFydFB0clR5cGUhPT0hIXQuc21hcnRQdHImJkxlKCJCb3RoIHNtYXJ0UHRyVHlwZSBhbmQgc21hcnRQdHIgbXVzdCBiZSBzcGVjaWZpZWQiKSx0LmNvdW50PXt2YWx1ZToxfSxPYmplY3QuY3JlYXRlKGUseyQkOnt2YWx1ZTp0fX0pfWZ1bmN0aW9uIEV0KGUpe3ZhciB0PXRoaXMuZ2V0UG9pbnRlZShlKTtpZighdClyZXR1cm4gdGhpcy5kZXN0cnVjdG9yKGUpLG51bGw7dmFyIHI9bXQodGhpcy5yZWdpc3RlcmVkQ2xhc3MsdCk7aWYodm9pZCAwIT09cil7aWYoMD09PXIuJCQuY291bnQudmFsdWUpcmV0dXJuIHIuJCQucHRyPXQsci4kJC5zbWFydFB0cj1lLHIuY2xvbmUoKTt2YXIgbj1yLmNsb25lKCk7cmV0dXJuIHRoaXMuZGVzdHJ1Y3RvcihlKSxufWZ1bmN0aW9uIG8oKXtyZXR1cm4gdGhpcy5pc1NtYXJ0UG9pbnRlcj95dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLnBvaW50ZWVUeXBlLHB0cjp0LHNtYXJ0UHRyVHlwZTp0aGlzLHNtYXJ0UHRyOmV9KTp5dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLHB0cjplfSl9dmFyIGksYT10aGlzLnJlZ2lzdGVyZWRDbGFzcy5nZXRBY3R1YWxUeXBlKHQpLHM9dHRbYV07aWYoIXMpcmV0dXJuIG8uY2FsbCh0aGlzKTtpPXRoaXMuaXNDb25zdD9zLmNvbnN0UG9pbnRlclR5cGU6cy5wb2ludGVyVHlwZTt2YXIgdT1mdW5jdGlvbiBlKHQscixuKXtpZihyPT09bilyZXR1cm4gdDtpZih2b2lkIDA9PT1uLmJhc2VDbGFzcylyZXR1cm4gbnVsbDt2YXIgbz1lKHQscixuLmJhc2VDbGFzcyk7cmV0dXJuIG51bGw9PT1vP251bGw6bi5kb3duY2FzdChvKX0odCx0aGlzLnJlZ2lzdGVyZWRDbGFzcyxpLnJlZ2lzdGVyZWRDbGFzcyk7cmV0dXJuIG51bGw9PT11P28uY2FsbCh0aGlzKTp0aGlzLmlzU21hcnRQb2ludGVyP3l0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnUsc21hcnRQdHJUeXBlOnRoaXMsc21hcnRQdHI6ZX0pOnl0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnV9KX1mdW5jdGlvbiBndChlLHQscixuLG8saSxhLHMsdSxjLGwpe3RoaXMubmFtZT1lLHRoaXMucmVnaXN0ZXJlZENsYXNzPXQsdGhpcy5pc1JlZmVyZW5jZT1yLHRoaXMuaXNDb25zdD1uLHRoaXMuaXNTbWFydFBvaW50ZXI9byx0aGlzLnBvaW50ZWVUeXBlPWksdGhpcy5zaGFyaW5nUG9saWN5PWEsdGhpcy5yYXdHZXRQb2ludGVlPXMsdGhpcy5yYXdDb25zdHJ1Y3Rvcj11LHRoaXMucmF3U2hhcmU9Yyx0aGlzLnJhd0Rlc3RydWN0b3I9bCxvfHx2b2lkIDAhPT10LmJhc2VDbGFzcz90aGlzLnRvV2lyZVR5cGU9YXQ6bj8odGhpcy50b1dpcmVUeXBlPWl0LHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uPW51bGwpOih0aGlzLnRvV2lyZVR5cGU9c3QsdGhpcy5kZXN0cnVjdG9yRnVuY3Rpb249bnVsbCl9ZnVuY3Rpb24gdnQoZSx0KXt2YXIgcjtpZihlPXplKGUpLHZvaWQgMCE9PW9bIkZVTkNUSU9OX1RBQkxFXyIrZV0pcj1vWyJGVU5DVElPTl9UQUJMRV8iK2VdW3RdO2Vsc2UgaWYoInVuZGVmaW5lZCIhPXR5cGVvZiBGVU5DVElPTl9UQUJMRSlyPUZVTkNUSU9OX1RBQkxFW3RdO2Vsc2V7dmFyIG49by5hc21bImR5bkNhbGxfIitlXTt2b2lkIDA9PT1uJiZ2b2lkIDA9PT0obj1vLmFzbVsiZHluQ2FsbF8iK2UucmVwbGFjZSgvZi9nLCJkIildKSYmV2UoIk5vIGR5bkNhbGwgaW52b2tlciBmb3Igc2lnbmF0dXJlOiAiK2UpLHI9ZnVuY3Rpb24ocil7Zm9yKHZhciBuPVtdLG89MTtvPGUubGVuZ3RoOysrbyluLnB1c2goImEiK28pO3ZhciBpPSJyZXR1cm4gZnVuY3Rpb24gIisoImR5bkNhbGxfIitlKyJfIit0KSsiKCIrbi5qb2luKCIsICIpKyIpIHtcbiI7cmV0dXJuIGkrPSIgICAgcmV0dXJuIGR5bkNhbGwocmF3RnVuY3Rpb24iKyhuLmxlbmd0aD8iLCAiOiIiKStuLmpvaW4oIiwgIikrIik7XG4iLGkrPSJ9O1xuIixuZXcgRnVuY3Rpb24oImR5bkNhbGwiLCJyYXdGdW5jdGlvbiIsaSkocix0KX0obil9cmV0dXJuImZ1bmN0aW9uIiE9dHlwZW9mIHImJldlKCJ1bmtub3duIGZ1bmN0aW9uIHBvaW50ZXIgd2l0aCBzaWduYXR1cmUgIitlKyI6ICIrdCkscn12YXIgd3Q9dm9pZCAwO2Z1bmN0aW9uIF90KGUpe3ZhciB0PXF0KGUpLHI9emUodCk7cmV0dXJuIEt0KHQpLHJ9ZnVuY3Rpb24gYnQoZSx0KXt2YXIgcj1bXSxuPXt9O3Rocm93IHQuZm9yRWFjaCgoZnVuY3Rpb24gZSh0KXtuW3RdfHxDZVt0XXx8KE5lW3RdP05lW3RdLmZvckVhY2goZSk6KHIucHVzaCh0KSxuW3RdPSEwKSl9KSksbmV3IHd0KGUrIjogIityLm1hcChfdCkuam9pbihbIiwgIl0pKX1mdW5jdGlvbiBBdChlLHQpe2Zvcih2YXIgcj1bXSxuPTA7bjxlO24rKylyLnB1c2goRlsodD4+Mikrbl0pO3JldHVybiByfWZ1bmN0aW9uIFR0KGUsdCxyLG4sbyl7dmFyIGk9dC5sZW5ndGg7aTwyJiZXZSgiYXJnVHlwZXMgYXJyYXkgc2l6ZSBtaXNtYXRjaCEgTXVzdCBhdCBsZWFzdCBnZXQgcmV0dXJuIHZhbHVlIGFuZCAndGhpcycgdHlwZXMhIik7Zm9yKHZhciBhPW51bGwhPT10WzFdJiZudWxsIT09cixzPSExLHU9MTt1PHQubGVuZ3RoOysrdSlpZihudWxsIT09dFt1XSYmdm9pZCAwPT09dFt1XS5kZXN0cnVjdG9yRnVuY3Rpb24pe3M9ITA7YnJlYWt9dmFyIGM9InZvaWQiIT09dFswXS5uYW1lLGw9IiIsZj0iIjtmb3IodT0wO3U8aS0yOysrdSlsKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSxmKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSsiV2lyZWQiO3ZhciBkPSJyZXR1cm4gZnVuY3Rpb24gIitGZShlKSsiKCIrbCsiKSB7XG5pZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gIisoaS0yKSsiKSB7XG50aHJvd0JpbmRpbmdFcnJvcignZnVuY3Rpb24gIitlKyIgY2FsbGVkIHdpdGggJyArIGFyZ3VtZW50cy5sZW5ndGggKyAnIGFyZ3VtZW50cywgZXhwZWN0ZWQgIisoaS0yKSsiIGFyZ3MhJyk7XG59XG4iO3MmJihkKz0idmFyIGRlc3RydWN0b3JzID0gW107XG4iKTt2YXIgaD1zPyJkZXN0cnVjdG9ycyI6Im51bGwiLHA9WyJ0aHJvd0JpbmRpbmdFcnJvciIsImludm9rZXIiLCJmbiIsInJ1bkRlc3RydWN0b3JzIiwicmV0VHlwZSIsImNsYXNzUGFyYW0iXSxtPVtXZSxuLG8sRGUsdFswXSx0WzFdXTthJiYoZCs9InZhciB0aGlzV2lyZWQgPSBjbGFzc1BhcmFtLnRvV2lyZVR5cGUoIitoKyIsIHRoaXMpO1xuIik7Zm9yKHU9MDt1PGktMjsrK3UpZCs9InZhciBhcmciK3UrIldpcmVkID0gYXJnVHlwZSIrdSsiLnRvV2lyZVR5cGUoIitoKyIsIGFyZyIrdSsiKTsgLy8gIit0W3UrMl0ubmFtZSsiXG4iLHAucHVzaCgiYXJnVHlwZSIrdSksbS5wdXNoKHRbdSsyXSk7aWYoYSYmKGY9InRoaXNXaXJlZCIrKGYubGVuZ3RoPjA/IiwgIjoiIikrZiksZCs9KGM/InZhciBydiA9ICI6IiIpKyJpbnZva2VyKGZuIisoZi5sZW5ndGg+MD8iLCAiOiIiKStmKyIpO1xuIixzKWQrPSJydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7XG4iO2Vsc2UgZm9yKHU9YT8xOjI7dTx0Lmxlbmd0aDsrK3Upe3ZhciB5PTE9PT11PyJ0aGlzV2lyZWQiOiJhcmciKyh1LTIpKyJXaXJlZCI7bnVsbCE9PXRbdV0uZGVzdHJ1Y3RvckZ1bmN0aW9uJiYoZCs9eSsiX2R0b3IoIit5KyIpOyAvLyAiK3RbdV0ubmFtZSsiXG4iLHAucHVzaCh5KyJfZHRvciIpLG0ucHVzaCh0W3VdLmRlc3RydWN0b3JGdW5jdGlvbikpfXJldHVybiBjJiYoZCs9InZhciByZXQgPSByZXRUeXBlLmZyb21XaXJlVHlwZShydik7XG5yZXR1cm4gcmV0O1xuIiksZCs9In1cbiIscC5wdXNoKGQpLGZ1bmN0aW9uKGUsdCl7aWYoIShlIGluc3RhbmNlb2YgRnVuY3Rpb24pKXRocm93IG5ldyBUeXBlRXJyb3IoIm5ld18gY2FsbGVkIHdpdGggY29uc3RydWN0b3IgdHlwZSAiK3R5cGVvZiBlKyIgd2hpY2ggaXMgbm90IGEgZnVuY3Rpb24iKTt2YXIgcj1NZShlLm5hbWV8fCJ1bmtub3duRnVuY3Rpb25OYW1lIiwoZnVuY3Rpb24oKXt9KSk7ci5wcm90b3R5cGU9ZS5wcm90b3R5cGU7dmFyIG49bmV3IHIsbz1lLmFwcGx5KG4sdCk7cmV0dXJuIG8gaW5zdGFuY2VvZiBPYmplY3Q/bzpufShGdW5jdGlvbixwKS5hcHBseShudWxsLG0pfXZhciBTdD1bXSxrdD1be30se3ZhbHVlOnZvaWQgMH0se3ZhbHVlOm51bGx9LHt2YWx1ZTohMH0se3ZhbHVlOiExfV07ZnVuY3Rpb24gUHQoKXtmb3IodmFyIGU9MCx0PTU7dDxrdC5sZW5ndGg7Kyt0KXZvaWQgMCE9PWt0W3RdJiYrK2U7cmV0dXJuIGV9ZnVuY3Rpb24gRHQoKXtmb3IodmFyIGU9NTtlPGt0Lmxlbmd0aDsrK2UpaWYodm9pZCAwIT09a3RbZV0pcmV0dXJuIGt0W2VdO3JldHVybiBudWxsfWZ1bmN0aW9uIFJ0KGUpe3N3aXRjaChlKXtjYXNlIHZvaWQgMDpyZXR1cm4gMTtjYXNlIG51bGw6cmV0dXJuIDI7Y2FzZSEwOnJldHVybiAzO2Nhc2UhMTpyZXR1cm4gNDtkZWZhdWx0OnZhciB0PVN0Lmxlbmd0aD9TdC5wb3AoKTprdC5sZW5ndGg7cmV0dXJuIGt0W3RdPXtyZWZjb3VudDoxLHZhbHVlOmV9LHR9fWZ1bmN0aW9uIE90KGUpe2lmKG51bGw9PT1lKXJldHVybiJudWxsIjt2YXIgdD10eXBlb2YgZTtyZXR1cm4ib2JqZWN0Ij09PXR8fCJhcnJheSI9PT10fHwiZnVuY3Rpb24iPT09dD9lLnRvU3RyaW5nKCk6IiIrZX1mdW5jdGlvbiBDdChlLHQpe3N3aXRjaCh0KXtjYXNlIDI6cmV0dXJuIGZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShJW2U+PjJdKX07Y2FzZSAzOnJldHVybiBmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5mcm9tV2lyZVR5cGUoQltlPj4zXSl9O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBmbG9hdCB0eXBlOiAiK2UpfX1mdW5jdGlvbiBOdChlLHQscil7c3dpdGNoKHQpe2Nhc2UgMDpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gUltlXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE9bZV19O2Nhc2UgMTpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gQ1tlPj4xXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE5bZT4+MV19O2Nhc2UgMjpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gRltlPj4yXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE1bZT4+Ml19O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIrZSl9fXZhciBGdD1MKz0xNjt2YXIgTXQ9e307dmFyIEl0PUwrPTE2O0wrPTQ4O2coJHQoIkdNVCIpLCJpOCIsMik7dmFyIEJ0PUwsTHQ9TCs9MTYseHQ9TCs9MTY7ZnVuY3Rpb24ganQoKXtpZighanQuY2FsbGVkKXtqdC5jYWxsZWQ9ITAsRlt4dD4+Ml09NjAqKG5ldyBEYXRlKS5nZXRUaW1lem9uZU9mZnNldCgpO3ZhciBlPW5ldyBEYXRlKDJlMywwLDEpLHQ9bmV3IERhdGUoMmUzLDYsMSk7RltMdD4+Ml09TnVtYmVyKGUuZ2V0VGltZXpvbmVPZmZzZXQoKSE9dC5nZXRUaW1lem9uZU9mZnNldCgpKTt2YXIgcj1hKGUpLG49YSh0KSxvPWcoJHQociksImk4IiwwKSxpPWcoJHQobiksImk4IiwwKTt0LmdldFRpbWV6b25lT2Zmc2V0KCk8ZS5nZXRUaW1lem9uZU9mZnNldCgpPyhGW0J0Pj4yXT1vLEZbQnQrND4+Ml09aSk6KEZbQnQ+PjJdPWksRltCdCs0Pj4yXT1vKX1mdW5jdGlvbiBhKGUpe3ZhciB0PWUudG9UaW1lU3RyaW5nKCkubWF0Y2goL1woKFtBLVphLXogXSspXCkkLyk7cmV0dXJuIHQ/dFsxXToiR01UIn19TCs9MTY7dmFyIFV0PXt9O3ZhciB6dD0xO2Z1bmN0aW9uICR0KGUsdCxyKXt2YXIgbj1yPjA/cjpTKGUpKzEsbz1uZXcgQXJyYXkobiksaT1BKGUsbywwLG8ubGVuZ3RoKTtyZXR1cm4gdCYmKG8ubGVuZ3RoPWkpLG99VGUuc3RhdGljSW5pdCgpLEoudW5zaGlmdCgoZnVuY3Rpb24oKXtvLm5vRlNJbml0fHxUZS5pbml0LmluaXRpYWxpemVkfHxUZS5pbml0KCl9KSksWi5wdXNoKChmdW5jdGlvbigpe1RlLmlnbm9yZVBlcm1pc3Npb25zPSExfSkpLFEucHVzaCgoZnVuY3Rpb24oKXtUZS5xdWl0KCl9KSksSi51bnNoaWZ0KChmdW5jdGlvbigpe3ZlLmluaXQoKX0pKSxRLnB1c2goKGZ1bmN0aW9uKCl7dmUuc2h1dGRvd24oKX0pKSxCZT1vLkludGVybmFsRXJyb3I9SWUoRXJyb3IsIkludGVybmFsRXJyb3IiKSxmdW5jdGlvbigpe2Zvcih2YXIgZT1uZXcgQXJyYXkoMjU2KSx0PTA7dDwyNTY7Kyt0KWVbdF09U3RyaW5nLmZyb21DaGFyQ29kZSh0KTtVZT1lfSgpLCRlPW8uQmluZGluZ0Vycm9yPUllKEVycm9yLCJCaW5kaW5nRXJyb3IiKSxldC5wcm90b3R5cGUuaXNBbGlhc09mPVZlLGV0LnByb3RvdHlwZS5jbG9uZT1HZSxldC5wcm90b3R5cGUuZGVsZXRlPXFlLGV0LnByb3RvdHlwZS5pc0RlbGV0ZWQ9WGUsZXQucHJvdG90eXBlLmRlbGV0ZUxhdGVyPVFlLGd0LnByb3RvdHlwZS5nZXRQb2ludGVlPXV0LGd0LnByb3RvdHlwZS5kZXN0cnVjdG9yPWN0LGd0LnByb3RvdHlwZS5hcmdQYWNrQWR2YW5jZT04LGd0LnByb3RvdHlwZS5yZWFkVmFsdWVGcm9tUG9pbnRlcj1SZSxndC5wcm90b3R5cGUuZGVsZXRlT2JqZWN0PWx0LGd0LnByb3RvdHlwZS5mcm9tV2lyZVR5cGU9RXQsby5nZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50PWZ0LG8uZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcz1kdCxvLmZsdXNoUGVuZGluZ0RlbGV0ZXM9WmUsby5zZXREZWxheUZ1bmN0aW9uPWh0LHd0PW8uVW5ib3VuZFR5cGVFcnJvcj1JZShFcnJvciwiVW5ib3VuZFR5cGVFcnJvciIpLG8uY291bnRfZW12YWxfaGFuZGxlcz1QdCxvLmdldF9maXJzdF9lbXZhbD1EdCxmdW5jdGlvbiBlKHQpe3ZhciByLG47ZS5jYWxsZWQ/KG49RltGdD4+Ml0scj1GW24+PjJdKTooZS5jYWxsZWQ9ITAsTXQuVVNFUj1NdC5MT0dOQU1FPSJ3ZWJfdXNlciIsTXQuUEFUSD0iLyIsTXQuUFdEPSIvIixNdC5IT01FPSIvaG9tZS93ZWJfdXNlciIsTXQuTEFORz0iQy5VVEYtOCIsTXQuXz1vLnRoaXNQcm9ncmFtLHI9ZigxMDI0KSxuPWYoMjU2KSxGW24+PjJdPXIsRltGdD4+Ml09bik7dmFyIGk9W10sYT0wO2Zvcih2YXIgcyBpbiB0KWlmKCJzdHJpbmciPT10eXBlb2YgdFtzXSl7dmFyIHU9cysiPSIrdFtzXTtpLnB1c2godSksYSs9dS5sZW5ndGh9aWYoYT4xMDI0KXRocm93IG5ldyBFcnJvcigiRW52aXJvbm1lbnQgc2l6ZSBleGNlZWRlZCBUT1RBTF9FTlZfU0laRSEiKTtmb3IodmFyIGM9MDtjPGkubGVuZ3RoO2MrKyl7cmUodT1pW2NdLHIpLEZbbis0KmM+PjJdPXIscis9dS5sZW5ndGgrMX1GW24rNCppLmxlbmd0aD4+Ml09MH0oTXQpLCQ9Zig0KSxqPVU9aChMKSx6PWgoaitHKSxGWyQ+PjJdPXoseD0hMCxvLndhc21UYWJsZVNpemU9MzE2LG8ud2FzbU1heFRhYmxlU2l6ZT0zMTYsby5hc21HbG9iYWxBcmc9e30sby5hc21MaWJyYXJ5QXJnPXthYm9ydDpycixlbmxhcmdlTWVtb3J5OkgsZ2V0VG90YWxNZW1vcnk6ZnVuY3Rpb24oKXtyZXR1cm4gcX0sYWJvcnRPbkNhbm5vdEdyb3dNZW1vcnk6ZnVuY3Rpb24oKXtycigiQ2Fubm90IGVubGFyZ2UgbWVtb3J5IGFycmF5cy4gRWl0aGVyICgxKSBjb21waWxlIHdpdGggIC1zIFRPVEFMX01FTU9SWT1YICB3aXRoIFggaGlnaGVyIHRoYW4gdGhlIGN1cnJlbnQgdmFsdWUgIitxKyIsICgyKSBjb21waWxlIHdpdGggIC1zIEFMTE9XX01FTU9SWV9HUk9XVEg9MSAgd2hpY2ggYWxsb3dzIGluY3JlYXNpbmcgdGhlIHNpemUgYXQgcnVudGltZSwgb3IgKDMpIGlmIHlvdSB3YW50IG1hbGxvYyB0byByZXR1cm4gTlVMTCAoMCkgaW5zdGVhZCBvZiB0aGlzIGFib3J0LCBjb21waWxlIHdpdGggIC1zIEFCT1JUSU5HX01BTExPQz0wICIpfSxpbnZva2VfaTpmdW5jdGlvbihlKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pKGUpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paTpmdW5jdGlvbihlLHQpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaTpmdW5jdGlvbihlLHQscil7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpKGUsdCxyKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaTpmdW5jdGlvbihlLHQscixuKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpKGUsdCxyLG4pfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaTpmdW5jdGlvbihlLHQscixuLGkpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaWlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpaWlpaWlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaWlqaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpamlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9pamo6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pamooZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfamk6ZnVuY3Rpb24oZSx0KXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9qaShlLHQpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92OmZ1bmN0aW9uKGUpe3RyeXtvLmR5bkNhbGxfdihlKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfdmk6ZnVuY3Rpb24oZSx0KXt0cnl7by5keW5DYWxsX3ZpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaTpmdW5jdGlvbihlLHQscil7dHJ5e28uZHluQ2FsbF92aWkoZSx0LHIpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpOmZ1bmN0aW9uKGUsdCxyLG4pe3RyeXtvLmR5bkNhbGxfdmlpaShlLHQscixuKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSl7dHJ5e28uZHluQ2FsbF92aWlpaWkoZSx0LHIsbixpLGEpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMpe3RyeXtvLmR5bkNhbGxfdmlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7by5keW5DYWxsX3ZpaWlpaWlpaWkoZSx0LHIsbixpLGEscyx1LGMsbCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwsZil7dHJ5e28uZHluQ2FsbF92aWlpaWlpaWlpaShlLHQscixuLGksYSxzLHUsYyxsLGYpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWo6ZnVuY3Rpb24oZSx0LHIsbil7dHJ5e28uZHluQ2FsbF92aWooZSx0LHIsbil9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3Zpamk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpamkoZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxfX19jeGFfYWxsb2NhdGVfZXhjZXB0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiBKdChlKX0sX19fY3hhX2JlZ2luX2NhdGNoOmZ1bmN0aW9uKGUpe3ZhciB0PWRlLmluZm9zW2VdO3JldHVybiB0JiYhdC5jYXVnaHQmJih0LmNhdWdodD0hMCksdCYmKHQucmV0aHJvd249ITEpLGRlLmNhdWdodC5wdXNoKGUpLGRlLmFkZFJlZihkZS5kZUFkanVzdChlKSksZX0sX19fY3hhX2VuZF9jYXRjaDpmdW5jdGlvbigpe28uc2V0VGhyZXcoMCk7dmFyIGU9ZGUuY2F1Z2h0LnBvcCgpO2UmJihkZS5kZWNSZWYoZGUuZGVBZGp1c3QoZSkpLGRlLmxhc3Q9MCl9LF9fX2N4YV9maW5kX21hdGNoaW5nX2NhdGNoXzI6ZnVuY3Rpb24oKXtyZXR1cm4gcGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfX19jeGFfZmluZF9tYXRjaGluZ19jYXRjaF8zOmZ1bmN0aW9uKCl7cmV0dXJuIHBlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX19fY3hhX2ZpbmRfbWF0Y2hpbmdfY2F0Y2hfNDpmdW5jdGlvbigpe3JldHVybiBwZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9fX2N4YV9mcmVlX2V4Y2VwdGlvbjpoZSxfX19jeGFfdGhyb3c6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IGRlLmluZm9zW2VdPXtwdHI6ZSxhZGp1c3RlZDplLHR5cGU6dCxkZXN0cnVjdG9yOnIscmVmY291bnQ6MCxjYXVnaHQ6ITEscmV0aHJvd246ITF9LGRlLmxhc3Q9ZSxlfSxfX19sb2NrOmZ1bmN0aW9uKCl7fSxfX19tYXBfZmlsZTpmdW5jdGlvbihlLHQpe3JldHVybiB5ZShtZS5FUEVSTSksLTF9LF9fX3Jlc3VtZUV4Y2VwdGlvbjpmdW5jdGlvbihlKXt0aHJvdyBkZS5sYXN0fHwoZGUubGFzdD1lKSxlfSxfX19zZXRFcnJObzp5ZSxfX19zeXNjYWxsMTQwOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKSxuPShTZS5nZXQoKSxTZS5nZXQoKSksbz1TZS5nZXQoKSxpPVNlLmdldCgpLGE9bjtyZXR1cm4gVGUubGxzZWVrKHIsYSxpKSxGW28+PjJdPXIucG9zaXRpb24sci5nZXRkZW50cyYmMD09PWEmJjA9PT1pJiYoci5nZXRkZW50cz1udWxsKSwwfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE0NTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0U3RyZWFtRnJvbUZEKCksbj1TZS5nZXQoKSxvPVNlLmdldCgpO3JldHVybiBTZS5kb1JlYWR2KHIsbixvKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxNDY6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cmVhbUZyb21GRCgpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gU2UuZG9Xcml0ZXYocixuLG8pfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE4MzpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKTtpZigwPT09bilyZXR1cm4tbWUuRUlOVkFMO3ZhciBvPVRlLmN3ZCgpO3JldHVybiBuPFMobykrMT8tbWUuRVJBTkdFOihUKG8scixuKSxyKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxOTg6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cigpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gVGUuY2hvd24ocixuLG8pLDB9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgMCE9PVRlJiZlIGluc3RhbmNlb2YgVGUuRXJybm9FcnJvcnx8cnIoZSksLWUuZXJybm99fSxfX19zeXNjYWxsMjA6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3JldHVybiBrZX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2OmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKTtyZXR1cm4gVGUuY2xvc2UociksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2MDpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS51bWFzaztyZXR1cm4gU2UudW1hc2s9cixufWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDgzOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHIoKSxuPVNlLmdldFN0cigpO3JldHVybiBUZS5zeW1saW5rKHIsbiksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw5MTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKSxvPVNlLm1hcHBpbmdzW3JdO2lmKCFvKXJldHVybiAwO2lmKG49PT1vLmxlbil7dmFyIGk9VGUuZ2V0U3RyZWFtKG8uZmQpO1NlLmRvTXN5bmMocixpLG4sby5mbGFncyksVGUubXVubWFwKGkpLFNlLm1hcHBpbmdzW3JdPW51bGwsby5hbGxvY2F0ZWQmJkt0KG8ubWFsbG9jKX1yZXR1cm4gMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3VubG9jazpmdW5jdGlvbigpe30sX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0OmZ1bmN0aW9uKGUpe3ZhciB0PVBlW2VdO2RlbGV0ZSBQZVtlXTt2YXIgcj10LnJhd0NvbnN0cnVjdG9yLG49dC5yYXdEZXN0cnVjdG9yLG89dC5maWVsZHM7eGUoW2VdLG8ubWFwKChmdW5jdGlvbihlKXtyZXR1cm4gZS5nZXR0ZXJSZXR1cm5UeXBlfSkpLmNvbmNhdChvLm1hcCgoZnVuY3Rpb24oZSl7cmV0dXJuIGUuc2V0dGVyQXJndW1lbnRUeXBlfSkpKSwoZnVuY3Rpb24oZSl7dmFyIGk9e307cmV0dXJuIG8uZm9yRWFjaCgoZnVuY3Rpb24odCxyKXt2YXIgbj10LmZpZWxkTmFtZSxhPWVbcl0scz10LmdldHRlcix1PXQuZ2V0dGVyQ29udGV4dCxjPWVbcitvLmxlbmd0aF0sbD10LnNldHRlcixmPXQuc2V0dGVyQ29udGV4dDtpW25dPXtyZWFkOmZ1bmN0aW9uKGUpe3JldHVybiBhLmZyb21XaXJlVHlwZShzKHUsZSkpfSx3cml0ZTpmdW5jdGlvbihlLHQpe3ZhciByPVtdO2woZixlLGMudG9XaXJlVHlwZShyLHQpKSxEZShyKX19fSkpLFt7bmFtZTp0Lm5hbWUsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKGUpe3ZhciB0PXt9O2Zvcih2YXIgciBpbiBpKXRbcl09aVtyXS5yZWFkKGUpO3JldHVybiBuKGUpLHR9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSx0KXtmb3IodmFyIG8gaW4gaSlpZighKG8gaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiTWlzc2luZyBmaWVsZCIpO3ZhciBhPXIoKTtmb3IobyBpbiBpKWlbb10ud3JpdGUoYSx0W29dKTtyZXR1cm4gbnVsbCE9PWUmJmUucHVzaChuLGEpLGF9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOm59XX0pKX0sX19lbWJpbmRfcmVnaXN0ZXJfYm9vbDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWplKHIpO1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7cmV0dXJuISFlfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ/bjpvfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOmZ1bmN0aW9uKGUpe3ZhciBuO2lmKDE9PT1yKW49UjtlbHNlIGlmKDI9PT1yKW49QztlbHNle2lmKDQhPT1yKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gYm9vbGVhbiB0eXBlIHNpemU6ICIrdCk7bj1GfXJldHVybiB0aGlzLmZyb21XaXJlVHlwZShuW2U+PmldKX0sZGVzdHJ1Y3RvckZ1bmN0aW9uOm51bGx9KX0sX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3M6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCxmLGQsaCl7Zj16ZShmKSxhPXZ0KGksYSksdSYmKHU9dnQocyx1KSksbCYmKGw9dnQoYyxsKSksaD12dChkLGgpO3ZhciBwPUZlKGYpOyFmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKT8oKHZvaWQgMD09PXJ8fHZvaWQgMCE9PW9bZV0ub3ZlcmxvYWRUYWJsZSYmdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlW3JdKSYmV2UoIkNhbm5vdCByZWdpc3RlciBwdWJsaWMgbmFtZSAnIitlKyInIHR3aWNlIikscnQobyxlLGUpLG8uaGFzT3duUHJvcGVydHkocikmJldlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgb3ZlcmxvYWRzIG9mIGEgZnVuY3Rpb24gd2l0aCB0aGUgc2FtZSBudW1iZXIgb2YgYXJndW1lbnRzICgiK3IrIikhIiksb1tlXS5vdmVybG9hZFRhYmxlW3JdPXQpOihvW2VdPXQsdm9pZCAwIT09ciYmKG9bZV0ubnVtQXJndW1lbnRzPXIpKX0ocCwoZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2YrIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsW25dKX0pKSx4ZShbZSx0LHJdLG4/W25dOltdLChmdW5jdGlvbih0KXt2YXIgcixpO3Q9dFswXSxpPW4/KHI9dC5yZWdpc3RlcmVkQ2xhc3MpLmluc3RhbmNlUHJvdG90eXBlOmV0LnByb3RvdHlwZTt2YXIgcz1NZShwLChmdW5jdGlvbigpe2lmKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSE9PWMpdGhyb3cgbmV3ICRlKCJVc2UgJ25ldycgdG8gY29uc3RydWN0ICIrZik7aWYodm9pZCAwPT09ZC5jb25zdHJ1Y3Rvcl9ib2R5KXRocm93IG5ldyAkZShmKyIgaGFzIG5vIGFjY2Vzc2libGUgY29uc3RydWN0b3IiKTt2YXIgZT1kLmNvbnN0cnVjdG9yX2JvZHlbYXJndW1lbnRzLmxlbmd0aF07aWYodm9pZCAwPT09ZSl0aHJvdyBuZXcgJGUoIlRyaWVkIHRvIGludm9rZSBjdG9yIG9mICIrZisiIHdpdGggaW52YWxpZCBudW1iZXIgb2YgcGFyYW1ldGVycyAoIithcmd1bWVudHMubGVuZ3RoKyIpIC0gZXhwZWN0ZWQgKCIrT2JqZWN0LmtleXMoZC5jb25zdHJ1Y3Rvcl9ib2R5KS50b1N0cmluZygpKyIpIHBhcmFtZXRlcnMgaW5zdGVhZCEiKTtyZXR1cm4gZS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9KSksYz1PYmplY3QuY3JlYXRlKGkse2NvbnN0cnVjdG9yOnt2YWx1ZTpzfX0pO3MucHJvdG90eXBlPWM7dmFyIGQ9bmV3IG50KGYscyxjLGgscixhLHUsbCksbT1uZXcgZ3QoZixkLCEwLCExLCExKSx5PW5ldyBndChmKyIqIixkLCExLCExLCExKSxFPW5ldyBndChmKyIgY29uc3QqIixkLCExLCEwLCExKTtyZXR1cm4gdHRbZV09e3BvaW50ZXJUeXBlOnksY29uc3RQb2ludGVyVHlwZTpFfSxmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKXx8TGUoIlJlcGxhY2luZyBub25leGlzdGFudCBwdWJsaWMgc3ltYm9sIiksdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlJiZ2b2lkIDAhPT1yP29bZV0ub3ZlcmxvYWRUYWJsZVtyXT10OihvW2VdPXQsb1tlXS5hcmdDb3VudD1yKX0ocCxzKSxbbSx5LEVdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvcjpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9QXQodCxyKTtvPXZ0KG4sbykseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgcj0iY29uc3RydWN0b3IgIisoZT1lWzBdKS5uYW1lO2lmKHZvaWQgMD09PWUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkmJihlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5PVtdKSx2b2lkIDAhPT1lLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV0pdGhyb3cgbmV3ICRlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgY29uc3RydWN0b3JzIHdpdGggaWRlbnRpY2FsIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiKyh0LTEpKyIpIGZvciBjbGFzcyAnIitlLm5hbWUrIichIE92ZXJsb2FkIHJlc29sdXRpb24gaXMgY3VycmVudGx5IG9ubHkgcGVyZm9ybWVkIHVzaW5nIHRoZSBwYXJhbWV0ZXIgY291bnQsIG5vdCBhY3R1YWwgdHlwZSBpbmZvISIpO3JldHVybiBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV09ZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2UubmFtZSsiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIixhKX0seGUoW10sYSwoZnVuY3Rpb24obil7cmV0dXJuIGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbdC0xXT1mdW5jdGlvbigpe2FyZ3VtZW50cy5sZW5ndGghPT10LTEmJldlKHIrIiBjYWxsZWQgd2l0aCAiK2FyZ3VtZW50cy5sZW5ndGgrIiBhcmd1bWVudHMsIGV4cGVjdGVkICIrKHQtMSkpO3ZhciBlPVtdLGE9bmV3IEFycmF5KHQpO2FbMF09aTtmb3IodmFyIHM9MTtzPHQ7KytzKWFbc109bltzXS50b1dpcmVUeXBlKGUsYXJndW1lbnRzW3MtMV0pO3ZhciB1PW8uYXBwbHkobnVsbCxhKTtyZXR1cm4gRGUoZSksblswXS5mcm9tV2lyZVR5cGUodSl9LFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19mdW5jdGlvbjpmdW5jdGlvbihlLHQscixuLG8saSxhLHMpe3ZhciB1PUF0KHIsbik7dD16ZSh0KSxpPXZ0KG8saSkseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgbj0oZT1lWzBdKS5uYW1lKyIuIit0O2Z1bmN0aW9uIG8oKXtidCgiQ2Fubm90IGNhbGwgIituKyIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLHUpfXMmJmUucmVnaXN0ZXJlZENsYXNzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zLnB1c2godCk7dmFyIGM9ZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsbD1jW3RdO3JldHVybiB2b2lkIDA9PT1sfHx2b2lkIDA9PT1sLm92ZXJsb2FkVGFibGUmJmwuY2xhc3NOYW1lIT09ZS5uYW1lJiZsLmFyZ0NvdW50PT09ci0yPyhvLmFyZ0NvdW50PXItMixvLmNsYXNzTmFtZT1lLm5hbWUsY1t0XT1vKToocnQoYyx0LG4pLGNbdF0ub3ZlcmxvYWRUYWJsZVtyLTJdPW8pLHhlKFtdLHUsKGZ1bmN0aW9uKG8pe3ZhciBzPVR0KG4sbyxlLGksYSk7cmV0dXJuIHZvaWQgMD09PWNbdF0ub3ZlcmxvYWRUYWJsZT8ocy5hcmdDb3VudD1yLTIsY1t0XT1zKTpjW3RdLm92ZXJsb2FkVGFibGVbci0yXT1zLFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9lbXZhbDpmdW5jdGlvbihlLHQpe1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7dmFyIHQ9a3RbZV0udmFsdWU7cmV0dXJuIGZ1bmN0aW9uKGUpe2U+NCYmMD09LS1rdFtlXS5yZWZjb3VudCYmKGt0W2VdPXZvaWQgMCxTdC5wdXNoKGUpKX0oZSksdH0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe3JldHVybiBSdCh0KX0sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpSZSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdDpmdW5jdGlvbihlLHQscil7dmFyIG49amUocik7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtyZXR1cm4gZX0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe2lmKCJudW1iZXIiIT10eXBlb2YgdCYmImJvb2xlYW4iIT10eXBlb2YgdCl0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCAiJytPdCh0KSsnIiB0byAnK3RoaXMubmFtZSk7cmV0dXJuIHR9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6Q3QodCxuKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9pbnRlZ2VyOmZ1bmN0aW9uKGUsdCxyLG4sbyl7dD16ZSh0KSwtMT09PW8mJihvPTQyOTQ5NjcyOTUpO3ZhciBpPWplKHIpLGE9ZnVuY3Rpb24oZSl7cmV0dXJuIGV9O2lmKDA9PT1uKXt2YXIgcz0zMi04KnI7YT1mdW5jdGlvbihlKXtyZXR1cm4gZTw8cz4+PnN9fXZhciB1PS0xIT10LmluZGV4T2YoInVuc2lnbmVkIik7WWUoZSx7bmFtZTp0LGZyb21XaXJlVHlwZTphLHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXtpZigibnVtYmVyIiE9dHlwZW9mIHImJiJib29sZWFuIiE9dHlwZW9mIHIpdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicrT3QocikrJyIgdG8gJyt0aGlzLm5hbWUpO2lmKHI8bnx8cj5vKXRocm93IG5ldyBUeXBlRXJyb3IoJ1Bhc3NpbmcgYSBudW1iZXIgIicrT3QocikrJyIgZnJvbSBKUyBzaWRlIHRvIEMvQysrIHNpZGUgdG8gYW4gYXJndW1lbnQgb2YgdHlwZSAiJyt0KyciLCB3aGljaCBpcyBvdXRzaWRlIHRoZSB2YWxpZCByYW5nZSBbJytuKyIsICIrbysiXSEiKTtyZXR1cm4gdT9yPj4+MDowfHJ9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6TnQodCxpLDAhPT1uKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9tZW1vcnlfdmlldzpmdW5jdGlvbihlLHQscil7dmFyIG49W0ludDhBcnJheSxVaW50OEFycmF5LEludDE2QXJyYXksVWludDE2QXJyYXksSW50MzJBcnJheSxVaW50MzJBcnJheSxGbG9hdDMyQXJyYXksRmxvYXQ2NEFycmF5XVt0XTtmdW5jdGlvbiBvKGUpe3ZhciB0PU0scj10W2U+Pj0yXSxvPXRbZSsxXTtyZXR1cm4gbmV3IG4odC5idWZmZXIsbyxyKX1ZZShlLHtuYW1lOnI9emUociksZnJvbVdpcmVUeXBlOm8sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpvfSx7aWdub3JlRHVwbGljYXRlUmVnaXN0cmF0aW9uczohMH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nOmZ1bmN0aW9uKGUsdCl7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtmb3IodmFyIHQ9TVtlPj4yXSxyPW5ldyBBcnJheSh0KSxuPTA7bjx0OysrbilyW25dPVN0cmluZy5mcm9tQ2hhckNvZGUoT1tlKzQrbl0pO3JldHVybiBLdChlKSxyLmpvaW4oIiIpfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gcihlLHQpe3JldHVybiBlW3RdfXZhciBuO3QgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciYmKHQ9bmV3IFVpbnQ4QXJyYXkodCkpLHQgaW5zdGFuY2VvZiBVaW50OEFycmF5fHx0IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQ4QXJyYXk/bj1yOiJzdHJpbmciPT10eXBlb2YgdD9uPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUuY2hhckNvZGVBdCh0KX06V2UoIkNhbm5vdCBwYXNzIG5vbi1zdHJpbmcgdG8gc3RkOjpzdHJpbmciKTt2YXIgbz10Lmxlbmd0aCxpPUp0KDQrbyk7TVtpPj4yXT1vO2Zvcih2YXIgYT0wO2E8bzsrK2Epe3ZhciBzPW4odCxhKTtzPjI1NSYmKEt0KGkpLFdlKCJTdHJpbmcgaGFzIFVURi0xNiBjb2RlIHVuaXRzIHRoYXQgZG8gbm90IGZpdCBpbiA4IGJpdHMiKSksT1tpKzQrYV09c31yZXR1cm4gbnVsbCE9PWUmJmUucHVzaChLdCxpKSxpfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOlJlLGRlc3RydWN0b3JGdW5jdGlvbjpmdW5jdGlvbihlKXtLdChlKX19KX0sX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmc6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG87cj16ZShyKSwyPT09dD8obj1mdW5jdGlvbigpe3JldHVybiBOfSxvPTEpOjQ9PT10JiYobj1mdW5jdGlvbigpe3JldHVybiBNfSxvPTIpLFllKGUse25hbWU6cixmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PW4oKSxyPU1bZT4+Ml0saT1uZXcgQXJyYXkociksYT1lKzQ+Pm8scz0wO3M8cjsrK3MpaVtzXT1TdHJpbmcuZnJvbUNoYXJDb2RlKHRbYStzXSk7cmV0dXJuIEt0KGUpLGkuam9pbigiIil9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXt2YXIgaT1uKCksYT1yLmxlbmd0aCxzPUp0KDQrYSp0KTtNW3M+PjJdPWE7Zm9yKHZhciB1PXMrND4+byxjPTA7YzxhOysrYylpW3UrY109ci5jaGFyQ29kZUF0KGMpO3JldHVybiBudWxsIT09ZSYmZS5wdXNoKEt0LHMpLHN9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOmZ1bmN0aW9uKGUpe0t0KGUpfX0pfSxfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3Q6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe1BlW2VdPXtuYW1lOnplKHQpLHJhd0NvbnN0cnVjdG9yOnZ0KHIsbikscmF3RGVzdHJ1Y3Rvcjp2dChvLGkpLGZpZWxkczpbXX19LF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdF9maWVsZDpmdW5jdGlvbihlLHQscixuLG8saSxhLHMsdSxjKXtQZVtlXS5maWVsZHMucHVzaCh7ZmllbGROYW1lOnplKHQpLGdldHRlclJldHVyblR5cGU6cixnZXR0ZXI6dnQobixvKSxnZXR0ZXJDb250ZXh0Omksc2V0dGVyQXJndW1lbnRUeXBlOmEsc2V0dGVyOnZ0KHMsdSksc2V0dGVyQ29udGV4dDpjfSl9LF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQ6ZnVuY3Rpb24oZSx0KXtZZShlLHtpc1ZvaWQ6ITAsbmFtZTp0PXplKHQpLGFyZ1BhY2tBZHZhbmNlOjAsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKCl7fSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7fX0pfSxfYWJvcnQ6ZnVuY3Rpb24oKXtvLmFib3J0KCl9LF9lbXNjcmlwdGVuX21lbWNweV9iaWc6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBPLnNldChPLnN1YmFycmF5KHQsdCtyKSxlKSxlfSxfZ2V0ZW52OmZ1bmN0aW9uIGUodCl7cmV0dXJuIDA9PT10PzA6KHQ9dih0KSxNdC5oYXNPd25Qcm9wZXJ0eSh0KT8oZS5yZXQmJkt0KGUucmV0KSxlLnJldD0ocj1NdFt0XSxuPVMocikrMSwobz1KdChuKSkmJkEocixSLG8sbiksbykpOjApO3ZhciByLG4sb30sX2dldGdybmFtOmZ1bmN0aW9uKCl7by5wcmludEVycigibWlzc2luZyBmdW5jdGlvbjogZ2V0Z3JuYW0iKSxycigtMSl9LF9nZXRwd25hbTpmdW5jdGlvbigpe3Rocm93ImdldHB3bmFtOiBUT0RPIn0sX2pzQ2xvc2U6ZnVuY3Rpb24oKXtyZXR1cm4gYS5jbG9zZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc0NyZWF0ZTpmdW5jdGlvbihlKXtyZXR1cm4gYS5jcmVhdGUuY2FsbChudWxsLGsoZSkpfSxfanNPcGVuOmZ1bmN0aW9uKGUpe3JldHVybiBhLm9wZW4uY2FsbChudWxsLGsoZSkpfSxfanNSZWFkOmZ1bmN0aW9uKCl7cmV0dXJuIGEucmVhZC5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc1NlZWs6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBhLnNlZWsuY2FsbChudWxsLGUsdCxiKHIpKX0sX2pzVGVsbDpmdW5jdGlvbigpe3JldHVybiBhLnRlbGwuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfanNXcml0ZTpmdW5jdGlvbigpe3JldHVybiBhLndyaXRlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX2xsdm1fZWhfdHlwZWlkX2ZvcjpmdW5jdGlvbihlKXtyZXR1cm4gZX0sX2xvY2FsdGltZTpmdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSx0KXtqdCgpO3ZhciByPW5ldyBEYXRlKDFlMypGW2U+PjJdKTtGW3Q+PjJdPXIuZ2V0U2Vjb25kcygpLEZbdCs0Pj4yXT1yLmdldE1pbnV0ZXMoKSxGW3QrOD4+Ml09ci5nZXRIb3VycygpLEZbdCsxMj4+Ml09ci5nZXREYXRlKCksRlt0KzE2Pj4yXT1yLmdldE1vbnRoKCksRlt0KzIwPj4yXT1yLmdldEZ1bGxZZWFyKCktMTkwMCxGW3QrMjQ+PjJdPXIuZ2V0RGF5KCk7dmFyIG49bmV3IERhdGUoci5nZXRGdWxsWWVhcigpLDAsMSksbz0oci5nZXRUaW1lKCktbi5nZXRUaW1lKCkpLzg2NGU1fDA7Rlt0KzI4Pj4yXT1vLEZbdCszNj4+Ml09LTYwKnIuZ2V0VGltZXpvbmVPZmZzZXQoKTt2YXIgaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9bi5nZXRUaW1lem9uZU9mZnNldCgpLHM9MHwoaSE9YSYmci5nZXRUaW1lem9uZU9mZnNldCgpPT1NYXRoLm1pbihhLGkpKTtGW3QrMzI+PjJdPXM7dmFyIHU9RltCdCsocz80OjApPj4yXTtyZXR1cm4gRlt0KzQwPj4yXT11LHR9KGUsSXQpfSxfbWt0aW1lOmZ1bmN0aW9uKGUpe2p0KCk7dmFyIHQ9bmV3IERhdGUoRltlKzIwPj4yXSsxOTAwLEZbZSsxNj4+Ml0sRltlKzEyPj4yXSxGW2UrOD4+Ml0sRltlKzQ+PjJdLEZbZT4+Ml0sMCkscj1GW2UrMzI+PjJdLG49dC5nZXRUaW1lem9uZU9mZnNldCgpLG89bmV3IERhdGUodC5nZXRGdWxsWWVhcigpLDAsMSksaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9by5nZXRUaW1lem9uZU9mZnNldCgpLHM9TWF0aC5taW4oYSxpKTtpZihyPDApRltlKzMyPj4yXT1OdW1iZXIoaSE9YSYmcz09bik7ZWxzZSBpZihyPjAhPShzPT1uKSl7dmFyIHU9TWF0aC5tYXgoYSxpKSxjPXI+MD9zOnU7dC5zZXRUaW1lKHQuZ2V0VGltZSgpKzZlNCooYy1uKSl9RltlKzI0Pj4yXT10LmdldERheSgpO3ZhciBsPSh0LmdldFRpbWUoKS1vLmdldFRpbWUoKSkvODY0ZTV8MDtyZXR1cm4gRltlKzI4Pj4yXT1sLHQuZ2V0VGltZSgpLzFlM3wwfSxfcHRocmVhZF9nZXRzcGVjaWZpYzpmdW5jdGlvbihlKXtyZXR1cm4gVXRbZV18fDB9LF9wdGhyZWFkX2tleV9jcmVhdGU6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gMD09ZT9tZS5FSU5WQUw6KEZbZT4+Ml09enQsVXRbenRdPTAsenQrKywwKX0sX3B0aHJlYWRfb25jZTpmdW5jdGlvbiBlKHQscil7ZS5zZWVufHwoZS5zZWVuPXt9KSx0IGluIGUuc2Vlbnx8KG8uZHluQ2FsbF92KHIpLGUuc2Vlblt0XT0xKX0sX3B0aHJlYWRfc2V0c3BlY2lmaWM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZSBpbiBVdD8oVXRbZV09dCwwKTptZS5FSU5WQUx9LF90aW1lOmZ1bmN0aW9uKGUpe3ZhciB0PURhdGUubm93KCkvMWUzfDA7cmV0dXJuIGUmJihGW2U+PjJdPXQpLHR9LERZTkFNSUNUT1BfUFRSOiQsU1RBQ0tUT1A6VX07dmFyIFd0PW8uYXNtKG8uYXNtR2xvYmFsQXJnLG8uYXNtTGlicmFyeUFyZyxEKTtvLmFzbT1XdDt2YXIgWXQ9by5fX0dMT0JBTF9fc3ViX0lfYmluZF9jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2JpbmRfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sVnQ9by5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcC5hcHBseShudWxsLGFyZ3VtZW50cyl9LEh0PW8uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHAuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxHdD1vLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0scXQ9KG8uX19fY3hhX2Nhbl9jYXRjaD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19jeGFfY2FuX2NhdGNoLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19jeGFfaXNfcG9pbnRlcl90eXBlPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2N4YV9pc19wb2ludGVyX3R5cGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLl9fX2Vycm5vX2xvY2F0aW9uPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2Vycm5vX2xvY2F0aW9uLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19nZXRUeXBlTmFtZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19nZXRUeXBlTmFtZS5hcHBseShudWxsLGFyZ3VtZW50cyl9KSxYdD1vLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sS3Q9by5fZnJlZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fZnJlZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LEp0PW8uX21hbGxvYz1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fbWFsbG9jLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sWnQ9by5zZXRUZW1wUmV0MD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5zZXRUZW1wUmV0MC5hcHBseShudWxsLGFyZ3VtZW50cyl9LFF0PShvLnNldFRocmV3PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnNldFRocmV3LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5zdGFja0FsbG9jPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnN0YWNrQWxsb2MuYXBwbHkobnVsbCxhcmd1bWVudHMpfSk7by5keW5DYWxsX2RpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2RpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9pPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlqaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF9paWlpaWlqaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfaWpqPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWpqLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2ppPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdj1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3YuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpZD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWQuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWo9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWouYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlqaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfTtmdW5jdGlvbiBlcihlKXt0aGlzLm5hbWU9IkV4aXRTdGF0dXMiLHRoaXMubWVzc2FnZT0iUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiK2UrIikiLHRoaXMuc3RhdHVzPWV9ZnVuY3Rpb24gdHIoZSl7ZnVuY3Rpb24gdCgpe28uY2FsbGVkUnVufHwoby5jYWxsZWRSdW49ITAsbXx8KHRlfHwodGU9ITAsWChKKSksWChaKSxvLm9uUnVudGltZUluaXRpYWxpemVkJiZvLm9uUnVudGltZUluaXRpYWxpemVkKCksZnVuY3Rpb24oKXtpZihvLnBvc3RSdW4pZm9yKCJmdW5jdGlvbiI9PXR5cGVvZiBvLnBvc3RSdW4mJihvLnBvc3RSdW49W28ucG9zdFJ1bl0pO28ucG9zdFJ1bi5sZW5ndGg7KWU9by5wb3N0UnVuLnNoaWZ0KCksZWUudW5zaGlmdChlKTt2YXIgZTtYKGVlKX0oKSkpfXNlPjB8fCghZnVuY3Rpb24oKXtpZihvLnByZVJ1bilmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlUnVuJiYoby5wcmVSdW49W28ucHJlUnVuXSk7by5wcmVSdW4ubGVuZ3RoOyllPW8ucHJlUnVuLnNoaWZ0KCksSy51bnNoaWZ0KGUpO3ZhciBlO1goSyl9KCksc2U+MHx8by5jYWxsZWRSdW58fChvLnNldFN0YXR1cz8oby5zZXRTdGF0dXMoIlJ1bm5pbmcuLi4iKSxzZXRUaW1lb3V0KChmdW5jdGlvbigpe3NldFRpbWVvdXQoKGZ1bmN0aW9uKCl7by5zZXRTdGF0dXMoIiIpfSksMSksdCgpfSksMSkpOnQoKSkpfWZ1bmN0aW9uIHJyKGUpe3Rocm93IG8ub25BYm9ydCYmby5vbkFib3J0KGUpLHZvaWQgMCE9PWU/KG8ucHJpbnQoZSksby5wcmludEVycihlKSxlPUpTT04uc3RyaW5naWZ5KGUpKTplPSIiLG09ITAsImFib3J0KCIrZSsiKS4gQnVpbGQgd2l0aCAtcyBBU1NFUlRJT05TPTEgZm9yIG1vcmUgaW5mby4ifWlmKG8uYXNtPVd0LGVyLnByb3RvdHlwZT1uZXcgRXJyb3IsZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yPWVyLHVlPWZ1bmN0aW9uIGUoKXtvLmNhbGxlZFJ1bnx8dHIoKSxvLmNhbGxlZFJ1bnx8KHVlPWUpfSxvLnJ1bj10cixvLmV4aXQ9ZnVuY3Rpb24oZSx0KXt0JiZvLm5vRXhpdFJ1bnRpbWUmJjA9PT1lfHwoby5ub0V4aXRSdW50aW1lfHwobT0hMCxVPXZvaWQgMCxYKFEpLG8ub25FeGl0JiZvLm9uRXhpdChlKSksbCYmcHJvY2Vzcy5leGl0KGUpLG8ucXVpdChlLG5ldyBlcihlKSkpfSxvLmFib3J0PXJyLG8ucHJlSW5pdClmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlSW5pdCYmKG8ucHJlSW5pdD1bby5wcmVJbml0XSk7by5wcmVJbml0Lmxlbmd0aD4wOylvLnByZUluaXQucG9wKCkoKTtyZXR1cm4gby5ub0V4aXRSdW50aW1lPSEwLHRyKCksdH07ZnVuY3Rpb24gaSh7cmVzb3VyY2VJZDplLHVybDp0fSl7cmV0dXJuIG5ldyBQcm9taXNlKChmdW5jdGlvbihlLG8pe2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpOyhmdW5jdGlvbihlKXtyZXR1cm4gZmV0Y2gobmV3IFJlcXVlc3QoZSkpLnRoZW4oZT0+e2lmKGUub2spcmV0dXJuIGUuYXJyYXlCdWZmZXIoKTt0aHJvdyBuZXcgRXJyb3IoIjQwNCBFcnJvcjogRmlsZSBub3QgZm91bmQuIil9KS50aGVuKGU9PnIuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGEoZSkpfSkodCkudGhlbih0PT57ZSh0LmV4dHJhY3RBbGwoKSl9LGU9PntvKGUpfSl9KSl9ZnVuY3Rpb24gYShlLHQpe2NvbnN0W3Isbl09dDtpZigiRkFJTCI9PXIuc3RhdGUpe2NvbnN0IHQ9e3R5cGU6IkVSUk9SIixyZWFzb246ci5yZWFzb24sbXNnOnIubXNnLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsdXJsOmUuZGF0YS51cmx9O3JldHVybiB2b2lkIHNlbGYucG9zdE1lc3NhZ2UodCl9Y29uc3Qgbz17dHlwZToiRklOSVNIRUQiLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsZW50cmllczp7fX0saT1bXTtpZihuJiZuLmZpbGVzKWZvcihjb25zdCBlIG9mIG4uZmlsZXMpby5lbnRyaWVzW2UuZmlsZUhlYWRlci5uYW1lXT1lLmV4dHJhY3RbMV0saS5wdXNoKGUuZXh0cmFjdFsxXS5idWZmZXIpO3NlbGYucG9zdE1lc3NhZ2UobyxpKX1vbm1lc3NhZ2U9ZnVuY3Rpb24oZSl7aWYoImluaXQiPT1lLmRhdGEudHlwZSluPW8oZS5kYXRhLndhc21VcmwpLG4ub25SdW50aW1lSW5pdGlhbGl6ZWQ9KCk9PnBvc3RNZXNzYWdlKHt0eXBlOiJXQVNNX0xPQURFRCJ9KTtlbHNlIGlmKCJmZXRjaCI9PWUuZGF0YS50eXBlKWkoZS5kYXRhKS50aGVuKHQ9PnthKGUsdCl9LHQ9Pntjb25zdCByPXt0eXBlOiJFUlJPUiIscmVzb3VyY2VJZDplLmRhdGEucmVzb3VyY2VJZCx1cmw6ZS5kYXRhLnVybH07c2VsZi5wb3N0TWVzc2FnZShyKX0pO2Vsc2UgaWYoInVucGFjayI9PWUuZGF0YS50eXBlKXtjb25zdHtidWZmZXI6dH09ZS5kYXRhO2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpO2NvbnN0IG89ci5jcmVhdGVFeHRyYWN0b3JGcm9tRGF0YSh0KS5leHRyYWN0QWxsKCk7YShlLG8pfX07Cgo=",null,!1);function se(e){return e&&"object"==typeof e&&!Array.isArray(e)}const ne=new class{constructor(){let e;this.loaded=new M,this.progressIncremented=new M,this.allResourcesLoaded=new M,this.fileUpdated=new M,this.__totalWork=0,this.__totalWorkByCategory={},this.__doneWork=0,this.__doneWorkByCategory={},this.__resourceRegisterCallbacks={},this.__callbacks={},this.__resources={},this.__resourcesTreeEntities={},this.__resourcesTree={children:{}},this.__workers=[],this.__nextWorker=0;const t=document.getElementsByTagName("script");for(let i=0;i<t.length;i++){const a=t[i];if(a.src.includes("zea-engine")){const t=a.src.split("/");t.pop(),t.pop(),e=t.join("/");break}}e||(e="https://unpkg.com/@zeainc/zea-engine@0.1.3"),this.wasmUrl=e+"/public-resources/unpack.wasm",this.addResourceURL("ZeaEngine/Vive.vla",e+"/public-resources/Vive.vla"),this.addResourceURL("ZeaEngine/Oculus.vla",e+"/public-resources/Oculus.vla")}getRootFolder(){return this.__resourcesTree}registerResourceCallback(e,t){this.__resourceRegisterCallbacks[e]=t;for(const i in this.__resources){const a=this.__resources[i];a.name.includes(e)&&t(a)}}__applyCallbacks(e){const t=e=>{for(const t in this.__resourceRegisterCallbacks)e.name.includes(t)&&this.__resourceRegisterCallbacks[t](e)};for(const i in e){const a=e[i];a.url&&t(a)}}__buildTree(e){const t=i=>{if(this.__resourcesTreeEntities[i])return;const a=e[i];a.id=i,"folder"!==a.type&&"dependency"!==a.type||(a.children={}),a.parent&&(this.__resourcesTreeEntities[a.parent]||t(a.parent)),(a.parent?this.__resourcesTreeEntities[a.parent]:this.__resourcesTree).children[a.name]=a,this.__resourcesTreeEntities[i]=a};for(const i in e)t(i)}setResources(e){this.__resources=Object.assign(this.__resources,e),this.__buildTree(e),this.__applyCallbacks(e)}addResourceURL(e,t){const i=e.split("/"),a=i.pop();if(!t){let a=window.location.href.split("#")[0];a=a.split("?")[0],(a.endsWith(".html")||a.endsWith(".html"))&&(a=a.substring(0,a.lastIndexOf("/"))+"/");const s=a;if("."==i[0])i.shift();else if(".."==i[0]){item=item.substring(3);const e=s.split("/");e.pop(),e.pop(),s=e.join("/")+"/"}t=s+e}let s;const n={};for(const e of i){const t=d(e);t in this.__resources||(this.__resources[t]={name:e,type:"folder",parent:s},n[t]=this.__resources[t]),s=t}const r=d(a),l={name:a,url:t,parent:s,id:r};this.__resources[r]=l,n[r]=l,this.__buildTree(n),this.__applyCallbacks(n)}updateFile(e){const t=!(e.id in this.__resources);if(this.__resources[e.id]=e,t){console.log("New file added");const t={};t[e.id]=e,this.__buildTree(t)}this.fileUpdated.emit(e.id)}freeData(e){}__getWorker(){return this.__nextWorker=(this.__nextWorker+1)%3,null==this.__workers[this.__nextWorker]&&(this.__workers[this.__nextWorker]=(()=>new Promise(e=>{const t=new ae;t.postMessage({type:"init",wasmUrl:this.wasmUrl}),t.onmessage=i=>{if("WASM_LOADED"===i.data.type)e(t);else if("FINISHED"===i.data.type)i.data,this.addWorkDone(i.data.resourceId,1),this.__onFinishedReceiveFileData(i.data);else if("ERROR"===i.data.type){const e=i.data,t=this.__resources[e.resourceId];console.error("Unable to load Resource:",t?t.name:e.resourceId," With url:",e.url)}}}))()),this.__workers[this.__nextWorker]}__terminateWorkers(){for(const e of this.__workers)e.terminate();this.__workers=[]}getFilepath(e){let t=this.__resources[e];const i=[t.name];for(;t.parent;)t=this.__resources[t.parent],i.splice(0,0,t.name);return i.join("/")}resourceAvailable(e){return e.indexOf(".")>0?(console.warn("Deprecation warning for resourceAvailable. Value should be a file id, not a path."),null!=this.resolveFilepath(e)):e in this.__resources}getFile(e){return this.__resources[e]}resolveFilePathToId(e){if(!e)return void console.warn("Invalid file path:",e);const t=this.resolveFilepath(e);return t?t.id:void 0}resolveFilepath(e){const t=e.split("/");"."!=t[0]&&""!=t[0]||t.shift();let i=this.__resourcesTree;for(const a of t){if(!(a in i.children))return console.warn("Unable to resolve key:"+a+" of path:"+e),null;i=i.children[a]}return i}resolveFile(e){return console.warn("Deprecation warning for resolveFile. Use resolveFilepath."),this.resolveFilepath(e)}resolveURL(e){console.warn("Deprecation warning for resolveURL. Use resolveFilepath.");const t=this.resolveFilepath(e);if(t)return t.url}addWork(e,t){this.__totalWork+=t,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100)}addWorkDone(e,t){if(this.__doneWork+=t,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100),this.__doneWork>this.__totalWork)throw new Error("Mismatch between work loaded and work done.");this.__doneWork==this.__totalWork&&this.allResourcesLoaded.emit()}loadResource(e,t,i=!0){const a=this.getFile(e);if(!a)throw new Error("Invalid resource Id:'"+e+"' not found in Resources:"+JSON.stringify(this.__resources,null,2));this.loadUrl(e,a.url,t,i)}loadURL(e,t,i,a=!0){return console.warn("Please call loadUrl instead,"),this.loadUrl(e,t,i,a)}loadUrl(e,t,i,a=!0){a&&this.addWork(e,3),e in this.__callbacks||(this.__callbacks[e]=[]),this.__callbacks[e].push(i),fetch(t).then(e=>function(e){if(!e.ok)throw new Error(`HTTP ${e.status} - ${e.statusText}`);return e}(e)&&e.arrayBuffer()).then(t=>{this.__getWorker().then(i=>{i.postMessage({type:"unpack",resourceId:e,buffer:t})})})}unpackBuffer(e,t,i,a=!0){return new Promise((s,n)=>{a&&this.addWork(e,3),e in this.__callbacks||(this.__callbacks[e]=[]),i&&this.__callbacks[e].push(i),this.__callbacks[e].push(e=>{s(e)}),this.__getWorker().then(i=>{i.postMessage({type:"unpack",resourceId:e,buffer:t},[t])})})}__onFinishedReceiveFileData(e){const t=e.resourceId;this.addWorkDone(t,1);const i=this.__callbacks[t];if(i){for(const t of i)t(e.entries);delete this.__callbacks[t]}this.loaded.emit(t),this.addWorkDone(t,1)}suspend(){this.__terminateWorkers()}traverse(e){const t=e=>{for(const t in e.children)i(e.children[t])},i=i=>{if(0==e(i))return!1;i.children&&t(i)};t(this.__resourcesTree)}};class re{constructor(e){if(e){const t=e.split("-"),i=t[0].split(".");this.major=parseInt(i[0]),this.minor=parseInt(i[1]),this.patch=parseInt(i[2]),2==t.length&&(this.branch=t[1])}else this.major=0,this.minor=0,this.patch=0}equals(e){return!(this.patch==e[2]&&this.minor==e[1]&&this.major==e[0])}lessThan(e){return!(this.major>=e[0]||this.minor>=e[1]||this.patch>=e[2])}greaterThan(e){return this.major>e[0]||this.minor>e[1]||this.patch>e[2]}greaterOrEqualThan(e){return!(this.major<e[0]||!(this.major>e[0])&&(this.minor<e[1]||!(this.minor>e[1])&&this.patch<e[2]))}}class le{constructor(e,t=0,i=!0){this.__data=e,this.__byteOffset=t,this.__dataView=new DataView(this.__data),this.__isMobileDevice=i,this.utf8decoder=new TextDecoder}get isMobileDevice(){return this.__isMobileDevice}get data(){return this.__data}get byteLength(){return this.__dataView.byteLength}get remainingByteLength(){return this.__dataView.byteLength-this.__byteOffset}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e}advance(e){this.__byteOffset+=e}loadUInt8(){const e=this.__dataView.getUint8(this.__byteOffset);return this.__byteOffset+=1,e}loadUInt16(){const e=this.__dataView.getUint16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32(){const e=this.__dataView.getUint32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadSInt32(){const e=this.__dataView.getInt32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadFloat16(){const e=this.loadUInt16();return Math.decode16BitFloat(e)}loadUFloat16(){const e=this.loadFloat16();return e<0?2048-e:e}loadFloat16From2xUInt8(){const e=this.__dataView.getFloat16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32From2xUFloat16(){return this.loadUFloat16()+4096*this.loadUFloat16()}loadSInt32From2xFloat16(){return this.loadFloat16()+2048*this.loadFloat16()}loadFloat32(){const e=this.__dataView.getFloat32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadUInt8Array(e,t=!1){null==e&&(e=this.loadUInt32());const i=new Uint8Array(this.__data,this.__byteOffset,e);return this.__byteOffset+=e,this.__byteOffset,i}loadUInt16Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint16Array;let i;if(this.readPadd(2),this.__isMobileDevice){i=new Uint16Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getUint16(this.__byteOffset,!0),this.__byteOffset+=2}else i=new Uint16Array(this.__data,this.__byteOffset,e),this.__byteOffset+=2*e;return i}loadUInt32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint32Array;let i;if(this.readPadd(4),this.__isMobileDevice){i=new Uint32Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getUint32(this.__byteOffset,!0),this.__byteOffset+=4}else i=new Uint32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return i}loadFloat32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Float32Array;let i;if(this.readPadd(4),this.__isMobileDevice){i=new Float32Array(e);for(let t=0;t<e;t++)i[t]=this.__dataView.getFloat32(this.__byteOffset,!0),this.__byteOffset+=4}else i=new Float32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return i}loadStr(){const e=this.loadUInt32(),t=new Uint8Array(this.__data,this.__byteOffset,e);return this.__byteOffset+=e,this.utf8decoder.decode(t)}loadStrArray(){const e=this.loadUInt32(),t=[];for(let i=0;i<e;i++)t[i]=this.loadStr();return t}loadSInt32Vec2(){const e=this.loadSInt32(),t=this.loadSInt32();return new p(e,t)}loadUInt32Vec2(){const e=this.loadUInt32(),t=this.loadUInt32();return new p(e,t)}loadFloat16Vec2(){const e=this.loadFloat16(),t=this.loadFloat16();return new p(e,t)}loadFloat32Vec2(){const e=this.loadFloat32(),t=this.loadFloat32();return new p(e,t)}loadFloat16Vec3(){const e=this.loadFloat16(),t=this.loadFloat16(),i=this.loadFloat16();return new g(e,t,i)}loadFloat32Vec3(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32();return new g(e,t,i)}loadFloat16Quat(){const e=this.loadFloat16(),t=this.loadFloat16(),i=this.loadFloat16(),a=this.loadFloat16();return new V(e,t,i,a)}loadFloat32Quat(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32(),a=this.loadFloat32();return new V(e,t,i,a)}loadRGBFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32();return new Z(e,t,i)}loadRGBAFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),i=this.loadFloat32(),a=this.loadFloat32();return new Z(e,t,i,a)}loadRGBUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),i=this.loadUInt8();return new Z(e/255,t/255,i/255)}loadRGBAUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),i=this.loadUInt8(),a=this.loadUInt8();return new Z(e/255,t/255,i/255,a/255)}loadBox2(){return new x(this.loadFloat32Vec2(),this.loadFloat32Vec2())}loadBox3(){return new W(this.loadFloat32Vec3(),this.loadFloat32Vec3())}readPadd(e){const t=this.__byteOffset%e;0!=t&&(this.__byteOffset+=e-t)}}class oe extends H{constructor(e,t=0,i,a){super(e,t,"Number"),i&&!Array.isArray(i)&&console.error("Range value must be an array of 2 numbers."),this.__range=i,this.__step=a}setValue(e,t){t==P.USER_SETVALUE&&(this.__range&&(e=Math.clamp(e,this.__range[0],this.__range[1])),this.__step&&(e=Math.round(e/this.__step)*this.__step)),super.setValue(e,t)}getValue(e){return super.getValue(e)}getRange(){return this.__range}setRange(e){return this.__range=e,this}getStep(){return this.__step}setStep(e){return this.__step=e,this}toJSON(e,t){const i=super.toJSON(e,t);return this.__range&&(i.range=this.__range),this.__step&&(i.step=this.__step),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.range&&(this.__range=e.range),e.step&&(this.__step=e.step)}readBinary(e,t){const i=e.loadFloat32();this.setValue(i,P.DATA_LOAD)}clone(e){const t=new oe(this.__name,this.__value);return t.__range=this.__range,t.__step=this.__step,t}}z.registerClass("NumberParameter",oe),z.registerClass("Property_SInt32",oe),z.registerClass("Property_UInt32",oe),z.registerClass("Property_Float32",oe);class de extends oe{constructor(e,t,i){super(e,t,[0,i.length],1),this.choices=i}getChoices(){return this.choices}setValue(e,t){"string"==typeof e?super.setValue(this.choices.indexOf(e),t):super.setValue(e,t)}}class he extends H{constructor(e,t){super(e,t,"Boolean")}clone(e){return new he(this.__name,this.__value)}}z.registerClass("BooleanParameter",he);class ce extends H{constructor(e,t,i){super(e,t||new p,"Vec2"),this.__range=i}getRange(){return this.__range}__setRange(e){this.__range=e,this.rangeChanged.emit()}clone(e){return new ce(this.__name,this.__value.clone())}}class me extends H{constructor(e,t,i){super(e,t||new g,"Vec3")}clone(e){return new me(this.__name,this.__value.clone())}}class ue extends H{constructor(e,t){super(e,t||new _,"Vec4")}clone(e){return new ue(this.__name,this.__value.clone())}}class be extends H{constructor(e,t){super(e,t||new Z,"Color")}readBinary(e,t){const i=e.loadRGBAFloat32Color();i.applyGamma(2.2),this.setValue(i,P.DATA_LOAD)}clone(e){return new be(this.__name,this.__value.clone())}}z.registerClass("ColorParameter",be);class pe extends H{constructor(e,t){super(e,t||new y,"Mat3")}clone(e){return new pe(this.__name,this.__value.clone())}}class ge extends H{constructor(e,t){super(e,t||new X,"Mat4")}clone(e){return new ge(this.__name,this.__value.clone())}}class _e extends H{constructor(e,t){super(e,t||new R,"Xfo")}clone(e){return new _e(this.__name,this.__value.clone())}}class fe extends H{constructor(e,t){super(e,t,"BaseImage"),this.valueParameterValueChanged=new M}toJSON(e,t){const i=super.toJSON(e,t);return this.__value&&(i.imageType=z.getClassName(this.__value)),i}fromJSON(e,t,i){return e.imageType&&(this.__value=z.constructClass(e.imageType)),super.fromJSON(e,t,i)}clone(e){return new fe(this.__name,this.__value)}}class Ze extends H{constructor(e,t=""){super(e,t,"String"),this.multiLine=!1}setMultiLine(e){this.multiLine=e}getMultiLine(){return this.multiLine}readBinary(e,t){const i=e.loadStr();this.setValue(i,P.DATA_LOAD)}clone(e){return new Ze(this.__name,this.__value)}}z.registerClass("StringParameter",Ze),z.registerClass("Property_String",Ze);class Ge extends Ze{constructor(e,t=""){super(e,t,"String"),this.lang="js"}setLanguage(e){this.lang=e}getLanguage(){return this.lang}clone(e){return new Ge(this.__name,this.__value)}}z.registerClass("CodeParameter",Ge);class ye extends H{constructor(e,t){super(e,"","FilePath"),this.fileUpdated=new M,t&&this.setSupportedExts(t)}setSupportedExts(e){this.__reextensions=new RegExp("\\.("+e+")$","i")}getFilepath(){return this.__file?ne.getFilepath(this.__file.id):""}setFilepath(e,t){const i=ne.resolveFilePathToId(e);i?this.setValue(i,t):console.warn("Resource unavailable:"+e)}getFilename(){if(this.__file)return this.__file.name}getExt(){const e=this.getFilename(),t=e.lastIndexOf(".");if(-1!=t)return e.substring(t).toLowerCase()}getStem(){const e=this.getFilename();if(e){const t=e.split(".");return 2==t.length?t[0]:e}}getFileFolder(){if(this.__file)return this.__file.parent?ne.getFile(this.__file.parent):ne.getRootFolder()}getFileFolderPath(){const e=this.getFilepath();if(e)return e.substring(0,e.lastIndexOf("/"))+"/"}getFile(){return this.__file}getFileDesc(){return this.__file}setUrl(e,t,i=P.USER_SETVALUE){const a=e.split("/");t||(t=a[a.length-1]),this.__value=t,this.__file={id:e,name:t,url:e},i!=P.USER_SETVALUE&&i!=P.REMOTEUSER_SETVALUE||(this.__flags|=E.USER_EDITED),this.valueChanged.emit(i)}getUrl(){return this.__file?this.__file.url:void 0}setDirty(e){throw new Error("Cannot drive a filepath param from an oporator")}setValue(e,t=P.USER_SETVALUE){if(null==e)throw new Error("Invalid value for setValue.");if(e.indexOf(".")>0)return console.warn("Deprecation warning for setValue. setValue should now only take a file id, not a path."),this.setFilepath(e,t);if(e==this.__value)return;const i=e;if(!ne.resourceAvailable(i))return void console.warn("Resource unavailable:"+i);const a=ne.getFile(i);if(this.__reextensions&&!this.__reextensions.test(a.name))return console.warn("Unsupported file type:"+a.name),!1;this.__value=e,this.__file=a,ne.fileUpdated.connect(e=>{e==this.__value&&(this.__file=ne.getFile(this.__value),this.fileUpdated.emit())}),t==P.USER_SETVALUE&&(this.__flags|=E.USER_EDITED),this.valueChanged.emit(t)}toJSON(e,t){if(0==(this.__flags&E.USER_EDITED))return;const i={};return this.__file&&(i.value=this.__file.id,i.filepath=ne.getFilepath(this.__file.id)),i}fromJSON(e,t,i){if(e.value){if(e.value.indexOf(".")>0)return void this.setFilepath(e.value,P.DATA_LOAD);if(ne.resourceAvailable(e.value))return this.setValue(e.value,P.DATA_LOAD),void(this.__flags|=E.USER_EDITED)}if(e.filepath){const t=ne.resolveFilePathToId(e.filepath);if(t)return void this.setValue(t,P.DATA_LOAD);console.warn("Resource unavailable:"+e.filepath)}}clone(e){const t=new ye(this.__name);return t.__file=this.__file,t}destroy(){super.destroy()}}class Xe extends H{constructor(e,t){super(e,[]),this.__dataType=t,this.elementAdded=new M,this.elementRemoved=new M}__filter(e){return!0}getCount(){return this.__value.length}getElement(e){return this.__value[e]}setElement(e,t){this.__value[e]=t,this.valueChanged.emit(P.USER_SETVALUE)}addElement(e){if(null==e)e=new this.__dataType;else if(!this.__filter(e))return;return this.__value.push(e),this.__flags|=E.USER_EDITED,this.elementAdded.emit(e,this.__value.length-1),this.valueChanged.emit(P.USER_SETVALUE),e}removeElement(e){const t=this.__value[e];this.__value.splice(e,1),this.__flags|=E.USER_EDITED,this.elementRemoved.emit(t,e),this.valueChanged.emit(P.USER_SETVALUE)}insertElement(e,t){this.__filter(t)&&(this.__value.splice(e,0,t),this.__flags|=E.USER_EDITED,this.elementAdded.emit(t,e),this.valueChanged.emit(P.USER_SETVALUE))}toJSON(e,t){if(0==(this.__flags&E.USER_EDITED))return;const i=[];for(const a of this.__value)"string"==typeof this.__dataType?i.push(a):i.push(a.toJSON(e,t));return{items:i}}fromJSON(e,t,i){if(null!=e.items){this.__flags|=E.USER_EDITED,this.__value=[];for(let i=0;i<e.items.length;i++){let a;"string"==typeof this.__dataType?a=e.items[i]:(a=new this.__dataType,a.fromJSON(e.items[i],t)),this.__value.push(a),this.elementAdded.emit(a,this.__value.length-1)}this.valueChanged.emit(P.DATA_LOAD)}else console.warn("Invalid Parameter JSON")}clone(e){const t=this.__value.slice(0),i=new Xe(this.__name,this.__dataType);return i.setValue(t),i}destroy(){for(let e=0;e<this.__value.length;e++)this.__value[e]instanceof H&&this.__value[e].destroy(),this.removeElement(e)}}class Ve extends H{constructor(e){super(e,{},"Struct"),this.__members=[]}_addMember(e){return this.__value[e.getName()]=e.getValue(),e.valueChanged.connect(()=>{this.__value[e.getName()]=e.getValue()}),this.__members.push(e),this.__flags|=E.USER_EDITED,this.valueChanged.emit(),e}getParameter(e){for(const t of this.__members)if(t.getName()==e)return t}getMember(e){return this.getParameter(e)}getMemberNames(){const e=[];for(let t=0;t<this.__members.length;t++){const i=this.__members[t];null!=i&&(e[t]=i.getName())}return e}toJSON(e,t){if(0==(this.__flags&E.USER_EDITED))return;const i=[];for(const a of this.__members)i.push(a.toJSON(e,t));return{members:i}}fromJSON(e,t,i){if(null!=e.members){this.__flags|=E.USER_EDITED;for(let i=0;i<e.members.length;i++)e.members[i]&&this.__members[i].fromJSON(e.members[i],t)}else console.warn("Invalid Parameter JSON")}destroy(){super.destroy();for(const e of this.__members)e.destroy()}}class Ie extends H{constructor(e,t){super(e,void 0,"TreeItem"),this.__filterFn=t,this.treeItemGlobalXfoChanged=new M}setOwner(e){this.__owner=e}getOwner(){return this.__owner}setFilterFn(){this.__filterFn=filterFn}getFilterFn(){return this.__filterFn}setValue(e,t=P.USER_SETVALUE){if(this.__filterFn&&!this.__filterFn(e))return!1;this.__value!==e&&(this.__value&&this.__value.globalXfoChanged.disconnect(this.treeItemGlobalXfoChanged.emit),this.__value=e,this.__value&&this.__value.globalXfoChanged.connect(this.treeItemGlobalXfoChanged.emit),t!=P.USER_SETVALUE&&t!=P.REMOTEUSER_SETVALUE||(this.__flags|=E.USER_EDITED),this.valueChanged.emit(t))}toJSON(e,t){if(0!=(this.__flags&E.USER_EDITED))return{value:e.makeRelative(this.__value.getPath())}}fromJSON(e,t,i){null!=e.value?(t.resolvePath(e.value,e=>{this.setValue(e)},()=>{console.warn("Unable to resolve tree item parameter value:"+pj.paramPath)}),this.__flags|=E.USER_EDITED):console.warn("Invalid Parameter JSON")}clone(e){return new Ie(this.__name,this.__filterFn)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit)}}class Re extends H{constructor(e,t){super(e,void 0,"BaseItem"),this.__items=new Set,this.__filterFn=t,this.itemAdded=new M,this.itemRemoved=new M}setFilterFn(e){this.__filterFn=e}getFilterFn(){return this.__filterFn}getItem(e){return Array.from(this.__items)[e]}addItem(e,t=!0){if(this.__filterFn&&!this.__filterFn(e))return console.warn("ItemSet __filterFn rejecting item:",e.getPath()),!1;this.__items.add(e);const i=Array.from(this.__items).indexOf(e);return this.itemAdded.emit(e,i),t&&this.valueChanged.emit(),i}addItems(e,t=!0){e.forEach(e=>this.addItem(e,!1)),t&&this.valueChanged.emit()}removeItem(e,t=!0){const i=Array.from(this.__items)[e];return this.__items.delete(i),this.itemRemoved.emit(i,e),t&&this.valueChanged.emit(),i}setItems(e,t=!0){for(let t=this.__items.length-1;t>=0;t--){const i=this.__items[t];e.has(i)||this.removeItem(i,!1)}for(const t of e)this.__items.has(t)||this.addItem(t,!1);t&&this.valueChanged.emit()}clearItems(e=!0){this.__items.clear(),e&&this.valueChanged.emit()}getNumItems(){return Array.from(this.__items).length}getValue(){return this.__items}toJSON(e,t){return{}}fromJSON(e,t,i){}clone(e){return new Re(this.__name,this.__filterFn)}}class xe extends H{constructor(e,t){super(e,void 0,t.getDataType()),this.setSourceParameter(t)}setSourceParameter(e){this.sourceParameter=e,this.sourceParameter.valueChanged.connect(this.__proxyValueChanged.bind(this))}__proxyValueChanged(e){this.valueChanged.emit(e)}getDataType(){return this.sourceParameter.getDataType()}setValue(e,t){}getValue(e){return this.sourceParameter.getValue(e)}toJSON(e,t){const i=super.toJSON(e,t);return this.sourceParameter&&(i.sourceParameter=this.sourceParameter.getPath()),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.sourceParameter&&t.resolvePath(e.sourceParameter,e=>{this.setSourceParameter(e)},t=>{console.warn("Error loading Proxy Param: '"+this.getName()+"'. Unable to connect to:"+e.sourceParameter)}),e.range&&(this.sourceParameter=e.range),e.step&&(this.__step=e.step)}clone(e,t){const i=new xe(this.__name,this.__value);return this.sourceParameter&&this.connectToClonedSourceParam(t),i}connectToClonedSourceParam(e){e.resolveClonedItem(this.sourceParameter,e=>{clonedParam.setSourceParameter(e)},e=>{console.warn("Error cloning Proxy Param: '"+this.getName()+"'. Unable to connect to:"+j.sourceParameter)})}}z.registerClass("ProxyParameter",xe);class Se extends H{constructor(e,t){super(e,void 0,"Geometry"),this.boundingBoxDirtied=new M,this.setValue(t)}setValue(e,t=P.USER_SETVALUE){this.__value!==e&&(this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit),this.__value=e,this.__value&&this.__value.boundingBoxDirtied.connect(this.boundingBoxDirtied.emit),t!=P.USER_SETVALUE&&t!=P.REMOTEUSER_SETVALUE||(this.__flags|=E.USER_EDITED),t!=P.OPERATOR_SETVALUE&&this.valueChanged.emit(t))}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){return super.fromJSON(e,t,i)}clone(e){return new Se(this.__name,this.__value)}destroy(){this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit)}}class We extends A{constructor(e){super(e),this.width=0,this.height=0,this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new he("AlphaFromLuminance",!1)),this.addParameter(new he("Invert",!1)),this.addParameter(new he("FlipY",!1)),this.updated=this.parameterValueChanged,this.loaded=new M(!0)}isLoaded(){return!0}getMapping(){return this.__mapping}setMapping(e){this.__mapping=e}isStream(){return!1}isStreamAtlas(){return this.__streamAtlas}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,flipY:this.getParameter("FlipY").getValue(),invert:this.getParameter("Invert").getValue(),alphaFromLuminance:this.getParameter("AlphaFromLuminance").getValue()}}}class Le extends oe{constructor(e,t,i){super(e,t,i),this.textureConnected=new M,this.textureDisconnected=new M}getImage(){return this.__image}setImage(e,t=0){const i=()=>{this.textureDisconnected.emit()};e?(null!=this.__image&&this.__image!==e&&i(),this.__image=e,this.textureConnected.emit(),this.valueChanged.emit(t)):null!=this.__image&&(i(),this.__image=void 0,this.textureDisconnected.emit())}setValue(e){e instanceof We?this.setImage(e):(null!=this.__image&&this.setImage(void 0),super.setValue(e))}readBinary(e,t){super.readBinary(e,t);const i=e.loadStr();""!=i&&(console.log("Load Texture"),this.setImage(t.materialLibrary.getImage(i)))}clone(e){return new Le(this.__name,this.__value.clone())}}z.registerClass("MaterialFloatParam",Le);class ve extends be{constructor(e,t){super(e,t),this.textureConnected=new M,this.textureDisconnected=new M,this.__imageUpdated=this.__imageUpdated.bind(this)}getImage(){return this.__image}__imageUpdated(){this.valueChanged.emit()}setImage(e,t=0){const i=()=>{this.__image.loaded.disconnect(this.__imageUpdated),this.__image.updated.disconnect(this.__imageUpdated),this.__image=null,this.textureDisconnected.emit()};e?(null!=this.__image&&this.__image!==e&&i(),this.__image=e,this.__image.updated.connect(this.__imageUpdated),this.textureConnected.emit(),this.valueChanged.emit(t)):null!=this.__image&&(i(),this.__image=void 0,this.textureDisconnected.emit())}setValue(e){e instanceof We?this.setImage(e):(null!=this.__image&&this.setImage(void 0),super.setValue(e))}readBinary(e,t){super.readBinary(e,t);const i=e.loadStr();""!=i&&this.setImage(t.materialLibrary.getImage(i))}clone(e){return new ve(this.__name,this.__value.clone())}}z.registerClass("MaterialColorParam",ve);const Te=(e,t,i,a)=>"boolean"==typeof t||!1===t||!0===t?new H(e,t,"Boolean"):"string"==typeof t?new H(e,t,"String"):Number.isNumeric(t)?a?new Le(e,t,i):new oe(e,t,i):t instanceof p?new ce(e,t):t instanceof g?new me(e,t):t instanceof Z?a?new ve(e,t):new be(e,t):new H(e,t);class Me extends A{constructor(e,t){super(e),this.shaderNameChanged=new M,this.visibleInGeomDataBuffer=!0,t&&this.setShaderName(t)}getShaderName(){return this.__shaderName}setShaderName(e){if(this.__shaderName==e)return;const t=z.getClass(e);if(!t)throw new Error("Error setting Shader. Shader not found:"+e);const i=t.getParamDeclarations(),a={};for(const e of i){let t=this.getParameter(e.name);t||(t=this.addParameter(Te(e.name,e.defaultValue,e.range,0!=e.texturable))),a[e.name]=!0}for(const e of this.__params)a[e.getName()]||this.removeParameter(e.getName());this.__shaderName=e,this.shaderNameChanged.emit(this.__shaderName)}removeAllTextures(){for(const e of this.__params)e.getImage&&e.getImage()&&e.setImage(void 0)}getParamTextures(){const e={};for(const t of this.__params)t.getImage&&t.getImage()&&(e[t.getName()]=t.getImage());return e}__makeParameterTexturable(e){makeParameterTexturable(e)}isTransparent(){const e=this.getParameter("Opacity");if(e&&(e.getValue()<.99||e.getImage()))return!0;const t=this.getParameter("BaseColor");return!(!t||!t.getImage()||"RGBA"!=t.getImage().format)}getShaderClass(){return z.getClass(this.getShaderName())}modifyParams(e,t){t&&this.setShaderName(t);for(const t in e){const i=this.getParameter(t);i&&(e[t]instanceof H?this.replaceParameter(e[t]):i.setValue(e[t]))}}toJSON(e,t=0){return super.toJSON(e,t)}fromJSON(e,t={},i=0){e.shader?(this.setShaderName(e.shader),super.fromJSON(e,t,i)):console.warn("Invalid Material JSON")}readBinary(e,t){let i=e.loadStr();if("StandardMaterial"==i&&(i="StandardSurfaceShader"),"TransparentMaterial"==i&&(i="TransparentSurfaceShader"),this.setShaderName(i),t.versions["zea-engine"].lessThan([0,0,3])){this.setName(e.loadStr());const i=e.loadUInt32();for(let s=0;s<i;s++){const i=(a=e.loadStr()).charAt(0).toUpperCase()+a.slice(1);let s;"MaterialColorParam"==e.loadStr()?(s=e.loadRGBAFloat32Color(),s.applyGamma(2.2)):s=e.loadFloat32();const n=e.loadStr();let r=this.getParameter(i);r?r.setValue(s):r=this.addParameter(Te(i,s)),""!=n&&r.setImage&&(t.materialLibrary.hasImage(n)?r.setImage(t.materialLibrary.getImage(n)):console.warn("Missing Texture:"+n))}}else super.readBinary(e,t);var a}clone(e){const t=new Me;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t),this.setShaderName(e.getShaderName());for(const t of e.getParameters()){const i=e.getParameter(t.getName());t.getImage||this.__makeParameterTexturable(i)}}destroy(){this.removeAllTextures(),super.destroy()}}class Ce extends We{constructor(e){super(),null==e&&(e=this.constructor.name),this.__name=e,this.format="RGBA",this.type="UNSIGNED_BYTE",this.__loaded=!1,this.width=1,this.height=1}isLoaded(){return this.__loaded}getName(){return this.__name}isStream(){return!1}setData(e,t,i){this.width=e,this.height=t,this.__data=i,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())}getParams(){const e=super.getParams();return e.data=this.__data,e}}function Fe(e){this.data=e,this.pos=0}function we(e){this.stream=new Fe(e),this.output={}}z.registerClass("DataImage2D",Ce),z.registerClass("DataImage",Ce),Fe.prototype.readByte=function(){return this.data[this.pos++]},Fe.prototype.peekByte=function(){return this.data[this.pos]},Fe.prototype.readBytes=function(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=this.readByte();return t},Fe.prototype.peekBytes=function(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=this.data[this.pos+i];return t},Fe.prototype.readString=function(e){for(var t="",i=0;i<e;i++)t+=String.fromCharCode(this.readByte());return t},Fe.prototype.readBitArray=function(){for(var e=[],t=this.readByte(),i=7;i>=0;i--)e.push(!!(t&1<<i));return e},Fe.prototype.readUnsigned=function(e){var t=this.readBytes(2);return e?(t[1]<<8)+t[0]:(t[0]<<8)+t[1]},we.prototype.parse=function(e){return this.parseParts(this.output,e),this.output},we.prototype.parseParts=function(e,t){for(var i=0;i<t.length;i++){var a=t[i];this.parsePart(e,a)}},we.prototype.parsePart=function(e,t){var i,a=t.label;if(!t.requires||t.requires(this.stream,this.output,e))if(t.loop){for(var s=[];t.loop(this.stream);){var n={};this.parseParts(n,t.parts),s.push(n)}e[a]=s}else t.parts?(i={},this.parseParts(i,t.parts),e[a]=i):t.parser?(i=t.parser(this.stream,this.output,e),t.skip||(e[a]=i)):t.bits&&(e[a]=this.parseBits(t.bits))},we.prototype.parseBits=function(e){var t={},i=this.stream.readBitArray();for(var a in e){var s=e[a];s.length?t[a]=i.slice(s.index,s.index+s.length).reduce((function(e,t){return 2*e+t}),0):t[a]=i[s.index]}return t};var Ne=function(e){return function(t){return t.readBytes(e)}},Ye=function(e){return function(t){return t.readString(e)}},Ke=function(e){return function(t){return t.readUnsigned(e)}},ze=function(e,t){return function(i,a,s){for(var n=t(i,a,s),r=new Array(n),l=0;l<n;l++)r[l]=i.readBytes(e);return r}},Ue={label:"blocks",parser:function(e){for(var t=[],i=e.readByte();0!==i;i=e.readByte())t=t.concat(e.readBytes(i));return t}},Pe={label:"gce",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&249===t[1]},parts:[{label:"codes",parser:Ne(2),skip:!0},{label:"byteSize",parser:function(e){return e.readByte()}},{label:"extras",bits:{future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}}},{label:"delay",parser:Ke(!0)},{label:"transparentColorIndex",parser:function(e){return e.readByte()}},{label:"terminator",parser:function(e){return e.readByte()},skip:!0}]},Ee={label:"image",requires:function(e){return 44===e.peekByte()},parts:[{label:"code",parser:function(e){return e.readByte()},skip:!0},{label:"descriptor",parts:[{label:"left",parser:Ke(!0)},{label:"top",parser:Ke(!0)},{label:"width",parser:Ke(!0)},{label:"height",parser:Ke(!0)},{label:"lct",bits:{exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}}}]},{label:"lct",requires:function(e,t,i){return i.descriptor.lct.exists},parser:ze(3,(function(e,t,i){return Math.pow(2,i.descriptor.lct.size+1)}))},{label:"data",parts:[{label:"minCodeSize",parser:function(e){return e.readByte()}},Ue]}]},Je={label:"text",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&1===t[1]},parts:[{label:"codes",parser:Ne(2),skip:!0},{label:"blockSize",parser:function(e){return e.readByte()}},{label:"preData",parser:function(e,t,i){return e.readBytes(i.text.blockSize)}},Ue]},He={label:"frames",parts:[Pe,{label:"application",requires:function(e,t,i){var a=e.peekBytes(2);return 33===a[0]&&255===a[1]},parts:[{label:"codes",parser:Ne(2),skip:!0},{label:"blockSize",parser:function(e){return e.readByte()}},{label:"id",parser:function(e,t,i){return e.readString(i.blockSize)}},Ue]},{label:"comment",requires:function(e,t,i){var a=e.peekBytes(2);return 33===a[0]&&254===a[1]},parts:[{label:"codes",parser:Ne(2),skip:!0},Ue]},Ee,Je],loop:function(e){var t=e.peekByte();return 33===t||44===t}},ke=[{label:"header",parts:[{label:"signature",parser:Ye(3)},{label:"version",parser:Ye(3)}]},{label:"lsd",parts:[{label:"width",parser:Ke(!0)},{label:"height",parser:Ke(!0)},{label:"gct",bits:{exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}}},{label:"backgroundColorIndex",parser:function(e){return e.readByte()}},{label:"pixelAspectRatio",parser:function(e){return e.readByte()}}]},{label:"gct",requires:function(e,t){return t.lsd.gct.exists},parser:ze(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},He];function Be(e){var t=new we(new Uint8Array(e));this.raw=t.parse(ke),this.raw.hasImages=!1;for(var i=0;i<this.raw.frames.length;i++)if(this.raw.frames[i].image){this.raw.hasImages=!0;break}}Be.prototype.decompressFrame=function(e,t){if(e>=this.raw.frames.length)return null;var i=this.raw.frames[e];if(i.image){var a=i.image.descriptor.width*i.image.descriptor.height,s=function(e,t,i){var a,s,n,r,l,o,d,h,c,m,u,b,p,g,_,f,Z=i,G=new Array(i),y=new Array(4096),X=new Array(4096),V=new Array(4097);for(l=1+(s=1<<(b=e)),a=s+2,d=-1,n=(1<<(r=b+1))-1,c=0;c<s;c++)y[c]=0,X[c]=c;for(u=h=p=g=f=_=0,m=0;m<Z;){if(0===g){if(h<r){u+=t[_]<<h,h+=8,_++;continue}if(c=u&n,u>>=r,h-=r,c>a||c==l)break;if(c==s){n=(1<<(r=b+1))-1,a=s+2,d=-1;continue}if(-1==d){V[g++]=X[c],d=c,p=c;continue}for(o=c,c==a&&(V[g++]=p,c=d);c>s;)V[g++]=X[c],c=y[c];p=255&X[c],V[g++]=p,a<4096&&(y[a]=d,X[a]=p,0==(++a&n)&&a<4096&&(r++,n+=a)),d=o}g--,G[f++]=V[g],m++}for(m=f;m<Z;m++)G[m]=0;return G}(i.image.data.minCodeSize,i.image.data.blocks,a);i.image.descriptor.lct.interlaced&&(s=function(e,t){for(var i=new Array(e.length),a=e.length/t,s=function(a,s){var n=e.slice(s*t,(s+1)*t);i.splice.apply(i,[a*t,t].concat(n))},n=[0,4,2,1],r=[8,8,4,2],l=0,o=0;o<4;o++)for(var d=n[o];d<a;d+=r[o])s(d,l),l++;return i}(s,i.image.descriptor.width));var n={pixels:s,dims:{top:i.image.descriptor.top,left:i.image.descriptor.left,width:i.image.descriptor.width,height:i.image.descriptor.height}};return i.image.descriptor.lct&&i.image.descriptor.lct.exists?n.colorTable=i.image.lct:n.colorTable=this.raw.gct,i.gce&&(n.delay=10*(i.gce.delay||10),n.disposalType=i.gce.extras.disposal,i.gce.extras.transparentColorGiven&&(n.transparentIndex=i.gce.transparentColorIndex)),t&&(n.patch=function(e){for(var t=e.pixels.length,i=new Uint8ClampedArray(4*t),a=0;a<t;a++){var s=4*a,n=e.pixels[a],r=e.colorTable[n];i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2],i[s+3]=n!==e.transparentIndex?255:0}return i}(n)),n}return null},Be.prototype.decompressFrames=function(e){for(var t=[],i=0;i<this.raw.frames.length;i++)this.raw.frames[i].image&&t.push(this.decompressFrame(i,e));return t};const De={},Oe={},Ae=-1!==navigator.userAgent.indexOf("Chrome");class Qe extends We{constructor(e,t="",i={}){t.constructor==Object&&(i=t),null!=e&&-1!=e.lastIndexOf(".")&&(console.warn("Deprecated signature. Please provide a name and filepath to the image constructor"),e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,i),this.__loaded=!1;const a=this.addParameter(new ye("FilePath"));a.valueChanged.connect(()=>{if(this.loaded.untoggle(),""==this.getName()){const e=a.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1))}const e=a.getFileDesc();e&&this.__loadData(e)}),t&&""!=t&&a.setFilepath(t)}static __imageDataLibrary(){return De}static registerLoader(e,t){Oe[e]=t}static constructLoader(e,t){for(const i of Oe)if(new RegExp("\\.("+i+")$","i").test(e.name)){const a=new Oe[i](t);if(a)return a.getParameter("FilePath").setValue(e.id),a}}__loadData(e){const t=this.getParameter("FilePath").getExt();if(".jpg"==t||".png"==t||".webp"==t)this.__loadLDRImage(e,t);else if(".mp4"==t||".ogg"==t)this.__loadLDRVideo(e);else if(".vlh"==t)this.__loadVLH(e);else if(".gif"==t)this.__loadGIF(e);else{if(".svg"!=t)throw new Error("Unsupported file type. Check the ext:"+e);console.warn("SVG Image not yet supported")}}__loadLDRImage(e,t){let i;".jpg"==t?this.format="RGB":".png"==t&&(this.format="RGBA"),this.type="UNSIGNED_BYTE";const a=()=>{this.getDOMElement=()=>i,this.width=i.width,this.height=i.height,this.__data=i,this.__loaded=!0,this.loaded.emit()};if(e.id in De)i=De[e.id],i.complete?a():i.addEventListener("load",a);else{ne.addWork(e.id,1);const t=this.addParameter(new oe("PreferredSize",-1));let s=e.url;if(e.assets&&Object.keys(e.assets).length>0){const i={maxSize:r.gpuDesc.maxTextureSize},a=t.getValue();-1==a?e.assets.reduce&&(i.prefSize=e.assets.reduce.w):i.prefSize=a;const n=function(e,t){if(t=t.filter(e=>null!==e),Ae){const e=t.filter(e=>"webp"===e.format);e.length>1&&(t=e)}else t=t.filter(e=>"webp"!==e.format);if(e.maxSize&&(t=t.filter(t=>t.w<=e.maxSize)),e.filter){const i=t.filter(t=>-1!==t.url.indexOf(e.filter));i.length>1&&(t=i)}if(e.prefSize&&(t=t.map(t=>Object.assign({score:Math.abs(e.prefSize-t.w)},t))).sort((e,t)=>e.score>t.score?1:e.score<t.score?-1:0),t.length>0)return t[0]}(i,Object.values(e.assets));n&&(console.log("Selected image:"+e.name+" format:"+n.format+" :"+n.w+"x"+n.h+" url:"+n.url),s=n.url)}else console.warn("Images not processed for this file:"+e.name);i=new Image,i.crossOrigin="anonymous",i.src=s,i.addEventListener("load",a),i.addEventListener("load",()=>{ne.addWorkDone(e.id,1)}),De[e.id]=i}}__removeVideoParams(){this.getParameterIndex("spatializeAudio")&&(this.removeParameter(this.getParameterIndex("Loop")),this.removeParameter(this.getParameterIndex("spatializeAudio")),this.removeParameter(this.getParameterIndex("Gain")),this.removeParameter(this.getParameterIndex("refDistance")),this.removeParameter(this.getParameterIndex("maxDistance")),this.removeParameter(this.getParameterIndex("rolloffFactor")),this.removeParameter(this.getParameterIndex("coneInnerAngle")),this.removeParameter(this.getParameterIndex("coneOuterAngle")),this.removeParameter(this.getParameterIndex("coneOuterGain")))}__loadLDRVideo(e){this.format="RGB",this.type="UNSIGNED_BYTE",ne.addWork(e.id,1);const t=this.addParameter(new he("Mute",!0)),i=this.addParameter(new he("Loop",!0)),a=document.createElement("video");a.style.display="none",a.preload="auto",a.crossOrigin="anonymous",this.getAudioSource=()=>a,document.body.appendChild(a),a.addEventListener("loadedmetadata",()=>{a.muted=t.getValue(),t.valueChanged.connect(()=>{a.muted=t.getValue()}),a.loop=i.getValue(),i.valueChanged.connect(()=>{a.loop=i.getValue()}),this.width=a.videoHeight,this.height=a.videoWidth,this.__data=a,this.__loaded=!0,ne.addWorkDone(e.id,1),this.loaded.emit(a),a.play().then(()=>{let e=0;const t=()=>{if(a.paused||a.ended)return;const i=Math.floor(29.97*a.currentTime);e!=i&&(this.updated.emit(),e=i),setTimeout(t,20)};t()},e=>{console.log("Autoplay was prevented.",e,e.message)})},!1),a.src=e.url}__loadVLH(e){this.type="FLOAT";let t=new Z(1,1,1,1);this.setHDRTint=e=>{t=e},this.getHDRTint=()=>t,ne.loadUrl(e.id,e.url,e=>{let t,i;for(const a in e)a.endsWith(".jpg")?t=e[a]:a.endsWith(".bin")&&(i=e[a]);const a=new Blob([t.buffer]),s=new Image;s.onload=()=>{this.width=s.width,this.height=s.height,this.__data={ldr:s,cdm:i},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())},s.src=URL.createObjectURL(a)})}__loadGIF(e){let t,i,a;this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.addParameter(new ue("StreamAtlasDesc",new _)),this.addParameter(new oe("StreamAtlasIndex",0)),this.getParameter("StreamAtlasIndex").setRange([0,1]),this.getFrameDelay=()=>20,this.play=()=>{a.then(()=>{t=!0,i&&i()})},this.stop=()=>{t=!1},e.id in De?a=De[e.id]:(a=new Promise((t,i)=>{if(ne.addWork(e.id,1),e.assets&&e.assets.atlas){const i=new Image;return i.crossOrigin="anonymous",i.src=e.assets.atlas.url,void i.addEventListener("load",()=>{t({width:e.assets.atlas.width,height:e.assets.atlas.height,atlasSize:e.assets.atlas.atlasSize,frameDelays:e.assets.atlas.frameDelays,frameRange:[0,e.assets.atlas.frameDelays.length],imageData:i}),ne.addWorkDone(e.id,1)})}$(e.url,i=>{console.warn("Unpacking Gif client side:"+e.name);const a=performance.now(),s=new Be(i).decompressFrames(!0),n=Math.sqrt(s.length),r=[n,n];Math.fract(n)>0&&(r[0]=Math.floor(r[0]+1),Math.fract(n)>.5?r[1]=Math.floor(r[1]+1):r[1]=Math.floor(r[1]));const l=s[0].dims.width,o=s[0].dims.height,d=document.createElement("canvas"),h=d.getContext("2d"),c=document.createElement("canvas"),m=c.getContext("2d");c.width=l,c.height=o;const u=document.createElement("canvas"),b=u.getContext("2d");let p;u.width=r[0]*l,u.height=r[1]*o;const g=[],_=(e,t)=>{const i=e.dims;g.push(e.delay/10),p&&i.width==p.width&&i.height==p.height||(d.width=i.width,d.height=i.height,p=h.createImageData(i.width,i.height)),p.data.set(e.patch),h.putImageData(p,0,0),2==e.disposalType&&m.clearRect(0,0,c.width,c.height),m.drawImage(d,i.left,i.top),b.drawImage(c,t%r[0]*l,Math.floor(t/r[0])*o)};for(let e=0;e<s.length;e++)_(s[e],e);ne.addWorkDone(e.id,1);const f=b.getImageData(0,0,u.width,u.height),Z=performance.now()-a;console.log(`Decode GIF '${e.name}' time:`+Z),t({width:u.width,height:u.height,atlasSize:r,frameRange:[0,s.length],frameDelays:g,imageData:f})},t=>{console.warn("Unable to Load URL:"+t+":"+e.url),i()})}),De[e.id]=a),a.then(e=>{this.width=e.width,this.height=e.height,this.getParameter("StreamAtlasDesc").setValue(new _(e.atlasSize[0],e.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(e.frameRange),this.__data=e.imageData,this.getFrameDelay=t=>10*e.frameDelays[t];const a=this.getParameter("StreamAtlasIndex"),s=a.getRange()[1];let n=0;i=()=>{a.setValue(n),t&&setTimeout(i,this.getFrameDelay(n)),n=(n+1)%s},t&&i(),this.__loaded=!0,this.loaded.emit()})}getFilepath(){return this.getParameter("FilePath").getValue()}isStream(){return!1}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data),e}toJSON(e,t){}fromJSON(e,t,i){}readBinary(e,t){this.setName(e.loadStr());let i=e.loadStr();if("string"==typeof i&&""!=i){if(t.lod>=0){const e=i.lastIndexOf(".");if(-1!=e){const a=i.substring(0,e)+t.lod+i.substring(e);ne.resolveFilepath(a)&&(i=a)}}this.getParameter("FilePath").setFilepath(i)}}}z.registerClass("FileImage2D",Qe),z.registerClass("FileImage",Qe);const je=-1!==navigator.userAgent.indexOf("Chrome");class qe extends Qe{constructor(e,t,i){super(e,t,i),this.type="UNSIGNED_BYTE",this.addParameter(new oe("PreferredSize",-1)),this.__crossOrigin="anonymous"}setCrossOrigin(e){this.__crossOrigin=e}__loadData(e){".png"==this.getParameter("FilePath").getExt()&&(this.format="RGBA");let t=e.url;if(e.assets&&Object.keys(e.assets).length>0){const i={maxSize:r.gpuDesc.maxTextureSize},a=this.getParameter("PreferredSize").getValue();-1==a?e.assets.reduce&&(i.prefSize=e.assets.reduce.w):i.prefSize=a;const s=function(e,t){if(t=t.filter(e=>null!==e),je){const e=t.filter(e=>"webp"===e.format);e.length>1&&(t=e)}else t=t.filter(e=>"webp"!==e.format);if(e.maxSize&&(t=t.filter(t=>t.w<=e.maxSize)),e.filter){const i=t.filter(t=>-1!==t.url.indexOf(e.filter));i.length>1&&(t=i)}if(e.prefSize&&(t=t.map(t=>Object.assign({score:Math.abs(e.prefSize-t.w)},t))).sort((e,t)=>e.score>t.score?1:e.score<t.score?-1:0),t.length>0)return t[0]}(i,Object.values(e.assets));s&&(console.log("Selected image:"+e.name+" format:"+s.format+" :"+s.w+"x"+s.h+" url:"+s.url),t=s.url)}else console.warn("Images not processed for this file:"+e.name);this.setImageURL(t,"RGB")}setImageURL(e,t="RGB"){if(!t){const i=e.lastIndexOf(".");-1!=i&&".png"==e.substring(i).toLowerCase()&&(t="RGBA")}let i;this.format=t,this.__loaded=!1;const a=()=>{this.getDOMElement=()=>i,this.width=i.width,this.height=i.height,this.__data=i,this.__loaded=!0,this.loaded.emit()},s=Qe.__imageDataLibrary();e in s?(i=s[e],i.complete?a():i.addEventListener("load",a)):(i=new Image,i.crossOrigin=this.__crossOrigin,i.src=e,i.addEventListener("load",a),s[e]=i)}}Qe.registerLoader("jpg|jpeg|png",qe),z.registerClass("LDRImage",qe);class $e extends Qe{constructor(e,t,i){super(e,t,i),this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new he("Mute",!1)),this.addParameter(new he("Loop",!0)),this.addParameter(new oe("Gain",2)).setRange([0,5]),this.addParameter(new he("SpatializeAudio",!0)),this.addParameter(new oe("refDistance",2)),this.addParameter(new oe("maxDistance",1e4)),this.addParameter(new oe("rolloffFactor",1)),this.addParameter(new oe("coneInnerAngle",360)),this.addParameter(new oe("coneOuterAngle",0)),this.addParameter(new oe("coneOuterGain",1))}__loadData(e){ne.addWork(e.id,1);const t=document.createElement("video");t.style.display="none",t.preload="auto",t.crossOrigin="anonymous",this.getAudioSource=()=>t,document.body.appendChild(t),t.addEventListener("loadedmetadata",()=>{const i=this.getParameter("Mute");t.muted=i.getValue(),i.valueChanged.connect(()=>{t.muted=i.getValue()});const a=this.getParameter("Loop");t.loop=a.getValue(),a.valueChanged.connect(()=>{t.loop=a.getValue()}),this.width=t.videoHeight,this.height=t.videoWidth,this.__data=t,this.__loaded=!0,ne.addWorkDone(e.id,1),this.loaded.emit(t);let s=0;const n=()=>{if(t.paused||t.ended)return;const e=Math.floor(29.97*t.currentTime);s!=e&&(this.updated.emit(),s=e),setTimeout(n,20)};n()},!1),t.src=e.url;const i=t.play();void 0!==i&&i.then(e=>{console.log("Autoplay started!")}).catch(()=>{console.log("Autoplay was prevented.")})}}Qe.registerLoader("mp4|ogg",$e),z.registerClass("LDRVideo",$e);class et extends Qe{constructor(e,t="",i={}){super(e,t,i),this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.getParameter("FilePath").setSupportedExts("gif"),this.addParameter(new ue("StreamAtlasDesc")),this.addParameter(new oe("StreamAtlasIndex",0));const a=this.getParameter("StreamAtlasIndex");let s;a.setRange([0,1]);let n=0;const r=e=>{a.setValue(n),s&&setTimeout(()=>r(e),this.getFrameDelay(n)),n=(n+1)%e};this.play=()=>{this.__resourcePromise.then(()=>{s=!0;const e=a.getRange()[1];r(e)})},this.stop=()=>{s=!1}}getFrameDelay(e){return 10*this.__unpackedData.frameDelays[e]}__loadData(e){const t=Qe.__imageDataLibrary();e.id in t?this.__resourcePromise=t[e.id]:(this.__resourcePromise=new Promise((t,i)=>{if(ne.addWork(e.id,1),e.assets&&e.assets.atlas){const i=new Image;return i.crossOrigin="anonymous",i.src=e.assets.atlas.url,void i.addEventListener("load",()=>{t({width:e.assets.atlas.width,height:e.assets.atlas.height,atlasSize:e.assets.atlas.atlasSize,frameDelays:e.assets.atlas.frameDelays,frameRange:[0,e.assets.atlas.frameDelays.length],imageData:i}),ne.addWorkDone(e.id,1)})}$(e.url,i=>{console.warn("Unpacking Gif client side:"+e.name);const a=performance.now(),s=new Be(i).decompressFrames(!0),n=Math.sqrt(s.length),r=[n,n];Math.fract(n)>0&&(r[0]=Math.floor(r[0]+1),Math.fract(n)>.5?r[1]=Math.floor(r[1]+1):r[1]=Math.floor(r[1]));const l=s[0].dims.width,o=s[0].dims.height,d=document.createElement("canvas"),h=d.getContext("2d"),c=document.createElement("canvas"),m=c.getContext("2d");c.width=l,c.height=o;const u=document.createElement("canvas"),b=u.getContext("2d");let p;u.width=r[0]*l,u.height=r[1]*o;const g=[],_=(e,t)=>{const i=e.dims;g.push(e.delay/10),p&&i.width==p.width&&i.height==p.height||(d.width=i.width,d.height=i.height,p=h.createImageData(i.width,i.height)),p.data.set(e.patch),h.putImageData(p,0,0),2==e.disposalType&&m.clearRect(0,0,c.width,c.height),m.drawImage(d,i.left,i.top),b.drawImage(c,t%r[0]*l,Math.floor(t/r[0])*o)};for(let e=0;e<s.length;e++)_(s[e],e);ne.addWorkDone(e.id,1);const f=b.getImageData(0,0,u.width,u.height),Z=performance.now()-a;console.log(`Decode GIF '${e.name}' time:`+Z),t({width:u.width,height:u.height,atlasSize:r,frameRange:[0,s.length],frameDelays:g,imageData:f})},t=>{console.warn("Unable to Load URL:"+t+":"+e.url),i()})}),t[e.id]=this.__resourcePromise),this.__resourcePromise.then(e=>{this.width=e.width,this.height=e.height,this.getParameter("StreamAtlasDesc").setValue(new _(e.atlasSize[0],e.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(e.frameRange),this.__unpackedData=e,this.__data=e.imageData,this.__loaded=!0,this.loaded.emit()})}}Qe.registerLoader("gif",et),z.registerClass("GIFImage",et);class tt extends We{constructor(e,t={}){let i;null!=e&&-1!=e.lastIndexOf(".")&&(i=e,e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,t),this.__loaded=!1,this.__exposure=1,this.__ambientLightFactor=0,this.__hdrtint=new Z(1,1,1,1),this.__stream="stream"in t&&t.stream,this.type="FLOAT";const a=this.addParameter(new ye("FilePath"));a.valueChanged.connect(()=>{if(this.loaded.untoggle(),""==this.getName()){const e=a.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1))}const e=a.getValue(),t=a.getFile();this.__loadVLH(e,t)}),i&&this.getParameter("FilePath").setFilepath(i)}getDOMElement(){return this.__domElement}getResourcePath(){return this.getParameter("FilePath").getValue()}__decodeData(e){const t=e.ldr,i=e.cdm,a=new Blob([t.buffer]),s=new Image;s.onload=()=>{this.width=s.width,this.height=s.height,this.__data={ldr:s,cdm:i},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())},s.src=URL.createObjectURL(a)}__loadVLH(e,t){this.type="FLOAT",ne.loadUrl(e,t.url,e=>{if(!e.ldr||!e.cdm)for(const t in e)t.endsWith(".jpg")?(e.ldr=e[t],delete e[t]):t.endsWith(".bin")&&(e.cdm=e[t],delete e[t]);this.__decodeData(e)})}isStream(){return!1}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data,e.exposure=this.__exposure),e}setHDRTint(e){this.__hdrtint=e}getHDRTint(){return this.__hdrtint}toJSON(e,t){}fromJSON(e,t,i){}readBinary(e,t){this.setName(e.loadStr());const i=e.loadStr();if("string"==typeof i&&""!=i){if(t.lod>=0){const e=i.lastIndexOf(".");if(-1!=e){const a=i.substring(0,e)+t.lod+i.substring(e);ne.resourceAvailable(a)&&(i=a)}}this.getParameter("FilePath").setValue(i)}}}z.registerClass("VLHImage",tt);const it=(e,t)=>t<e?0:1;function st(e){return e.dot(new p(1,1))}function nt(e){return new p(Math.abs(e.x),Math.abs(e.y))}function rt(e,t){return new p(Math.max(e.x,t),Math.max(e.y,t))}class lt extends tt{constructor(e,t={}){super(e,t),this.mapping=2}__decodeData(e){super.__decodeData(e);const t=e.samples;t&&(window.TextDecoder?this.__sampleSets=JSON.parse(new TextDecoder("utf-8").decode(t)):this.__sampleSets=JSON.parse(w(t)),this.__sampleSets.luminanceThumbnail&&(this.__thumbSize=Math.sqrt(this.__sampleSets.luminanceThumbnail.length)))}getSampleSets(){return this.__sampleSets}uvToDir(e){switch(this.mapping){case 1:return function(e,t){const i=Math.PI*(2*e-1),a=void 0*Math.PI;return new g(sin(a)*sin(i),-sin(a)*cos(i),cos(a))}(e);case 2:return function(e){const t=function(e){return new p(2*it(0,e.x)-1,2*it(0,e.y)-1)}(e=e.scale(2).subtract(new p(1,1))),i=st(nt(e)),a=i*Math.PI*.5;if(a<=0)return new g(0,0,1);if(Math.abs(a-Math.PI)<1e-6)return new g(0,0,-1);i>1&&(e=nt(p(e.y,e.x)).negate().add(new p(1,1)).multiply(t),i=st(nt(e)));const s=Math.abs(e.x)/i*Math.HALF_PI,n=Math.sin(s),r=Math.cos(s),l=Math.sin(a),o=Math.cos(a);return new g(n*t.x*l,r*t.y*l,o)}(e)}}dirToUv(e){switch(this.mapping){case 1:return function(e){const t=Math.acos(e.z),i=Math.atan2(e.x,-e.y);return new p((1+i/Math.PI)/2,t/Math.PI)}(e);case 2:return function(e){const t=function(e){return new g(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))}(e),i=function(e){return new g(2*it(0,e.x)-1,2*it(0,e.y)-1,2*it(0,e.z)-1)}(e),a=new p(t.x,t.y);let s=rt(a,1e-20);const n=Math.atan2(s.x,s.y)/Math.HALF_PI;s=rt(new p(t.z,a.length()),1e-20);const r=Math.atan2(s.y,s.x)/Math.HALF_PI;let l=new p(i.x*n,i.y*(1-n));if(l.scaleInPlace(r),e.z<0){const e=new p(l.y,l.x),t=new p(i.x,i.y);l=t.subtract(nt(e).multiply(t))}return l.scale(.5).add(new p(.5,.5))}(e)}}uvToLuminance(e){const t=Math.floor(e.y*this.__thumbSize)*this.__thumbSize+Math.floor(e.x*this.__thumbSize);return this.__sampleSets.luminanceThumbnail[t]}dirToLuminance(e){return this.uvToLuminance(this.dirToUv(e))}}z.registerClass("EnvMap",lt);const ot=new class{constructor(){this.__labelLibraries={},this.labelLibraryLoaded=new M;const e=function(){const e=window.navigator,t=["language","browserLanguage","systemLanguage","userLanguage"];let i,a;if(Array.isArray(e.languages))for(i=0;i<e.languages.length;i++)if(a=e.languages[i],a&&a.length)return a;for(i=0;i<t.length;i++)if(a=e[t[i]],a&&a.length)return a;return null}();e.startsWith("en")?this.__language="En":e.startsWith("es")?this.__language="Es":e.startsWith("fr")?this.__language="Fr":(e.startsWith("gb")||e.startsWith("de"))&&(this.__language="Gb"),this.__foundLabelLibraries={},ne.registerResourceCallback(".labels",e=>{const t=e.name.split(".")[0];this.__foundLabelLibraries[t]=e,q(e.url,e=>{this.__labelLibraries[t]=JSON.parse(e),this.labelLibraryLoaded.emit(t)})}),window.XLSX&&ne.registerResourceCallback(".xlsx",e=>{const t=e.name.split(".")[0];this.__foundLabelLibraries[t]=e,$(e.url,e=>{const i=new Uint8Array(e),a=XLSX.read(i,{type:"array"}),s={};a.SheetNames.forEach((function(e){XLSX.utils.sheet_to_row_object_array(a.Sheets[e]).forEach((function(e){const t=e.Identifier;delete e.Identifier,s[t]=e}))})),this.__labelLibraries[t]=s,this.labelLibraryLoaded.emit(t)})})}isLibraryFound(e){return e in this.__foundLabelLibraries}isLibraryLoaded(e){return e in this.__labelLibraries}getLabelText(e,t){const i=this.__labelLibraries[e];if(!i)throw new Error("LabelLibrary: '"+e+"' not found in LabelManager. Found: ["+Object.keys(this.__labelLibraries)+"]");const a=i[t];if(!a)throw new Error("Label: '"+t+"' not found in LabelLibrary: '"+e+"'. Found: ["+Object.keys(i)+"]");const s=a[this.__language];if(!s){if(a.En)return a.En;throw new Error("labelText: '"+language+"' not found in Label. Found: ["+Object.keys(a)+"]")}return s}setLabelText(e,t,i){let a=this.__labelLibraries[e];a||(a={},this.__labelLibraries[e]=a);let s=a[t];s||(s={},a[t]=s),s[this.__language]=i}setLanguage(e){this.__language=e}};class dt extends Ce{constructor(e,t){super(e),this.__canvasElem=document.createElement("canvas");const i=this.addParameter(new Ze("library"));this.addParameter(new Ze("text","")),this.addParameter(new be("fontColor",new Z(0,0,0))),this.addParameter(new oe("margin",11)),this.addParameter(new oe("borderWidth",2)),this.addParameter(new oe("borderRadius",11)),this.addParameter(new he("outline",!1)),this.addParameter(new he("outlineColor",new Z(0,0,0))),this.addParameter(new he("background",!0)),this.addParameter(new be("backgroundColor",new Z("#FBC02D"))),this.addParameter(new he("fillBackground",!0)),this.addParameter(new he("strokeBackgroundOutline",!0)),this.addParameter(new oe("fontSize",22)),this.addParameter(new Ze("font","Helvetica")),this.nameChanged.connect(()=>{this.loadLabelData()}),t&&i.setValue(t),this.__requestedRerender=!1,this.__needsRender=!1,this.labelRendered=new M,this.loadLabelData()}__parameterValueChanged(e,t){this.__requestedRerender||(this.__requestedRerender=!0,this.loadLabelData())}loadLabelData(){Promise.all([(()=>new Promise(e=>{const t=this.getParameter("library").getValue();if(""==t)return void e();if(!ot.isLibraryFound(t))return console.warn("Label Libary not found:",t),void e();const i=()=>{try{const e=this.getName(),i=ot.getLabelText(t,e);this.getParameter("text").setValue(i)}catch(e){console.warn(e)}e()};ot.isLibraryLoaded(t)?i():ot.labelLibraryLoaded.connect(e=>{e==t&&i()})}))(),(()=>new Promise(e=>{if(null!=document.fonts){const t=this.getParameter("font").getValue(),i=this.getParameter("fontSize").getValue();document.fonts.load(i+'px "'+t+'"').then(()=>{e()})}else e()}))()]).then(()=>{this.__requestedRerender=!1,this.__needsRender=!0,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())})}renderLabelToImage(){const e=this.__canvasElem.getContext("2d",{alpha:!0});let t=this.getParameter("text").getValue();""==t&&(t=this.getName());const i=this.getParameter("font").getValue(),a=this.getParameter("fontColor").getValue(),s=this.getParameter("fontSize").getValue(),n=this.getParameter("margin").getValue(),r=this.getParameter("borderWidth").getValue(),l=this.getParameter("borderRadius").getValue(),o=this.getParameter("outline").getValue(),d=this.getParameter("outlineColor").getValue(),h=this.getParameter("background").getValue(),c=this.getParameter("backgroundColor").getValue(),m=this.getParameter("fillBackground").getValue(),u=this.getParameter("strokeBackgroundOutline").getValue(),b=n+r,p=t.split("\n");e.font=s+'px "'+i+'"';let g=0;p.forEach(t=>{g=Math.max(e.measureText(t).width,g)});const _=s;this.width=Math.ceil(g+2*b),this.height=Math.ceil(_*p.length+2*b),e.canvas.width=this.width,e.canvas.height=this.height,this.__canvasElem.width=this.width,this.__canvasElem.height=this.height,e.fillStyle="rgba(0, 0, 0, 0.0)",e.fillRect(0,0,this.width,this.height),h&&(e.fillStyle=c.toHex(),e.strokeStyle=d.toHex(),function(e,t,i,a,s,n,r,l,o){if(void 0===l&&(l=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else{const e={tl:0,tr:0,br:0,bl:0};for(const t in e)n[t]=n[t]||e[t]}e.beginPath(),e.moveTo(t+n.tl,i),e.lineTo(t+a-n.tr,i),e.quadraticCurveTo(t+a,i,t+a,i+n.tr),e.lineTo(t+a,i+s-n.br),e.quadraticCurveTo(t+a,i+s,t+a-n.br,i+s),e.lineTo(t+n.bl,i+s),e.quadraticCurveTo(t,i+s,t,i+s-n.bl),e.lineTo(t,i+n.tl),e.quadraticCurveTo(t,i,t+n.tl,i),e.closePath(),r&&e.fill(),l&&(e.lineWidth=o,e.stroke())}(e,r,r,this.width-2*r,this.height-2*r,l,m,u,r)),e.font=s+'px "'+i+'"',e.textAlign="left",e.fillStyle=a.toHex(),e.textBaseline="hanging",p.forEach((t,i)=>{e.fillText(t,b,b+i*_)}),o&&(e.strokeStyle=d.toHex(),e.lineWidth=1.5,e.strokeText(t,b,b)),this.__data=e.getImageData(0,0,this.width,this.height),this.__needsRender=!1,this.labelRendered.emit({width:this.width,height:this.height,data:this.__data})}getParams(){return this.__needsRender&&this.renderLabelToImage(),super.getParams()}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){super.fromJSON(e,t,i),this.__getLabelText()}}z.registerClass("Label",dt);class ht extends We{constructor(){super(),this.__loaded=!1}connectWebcam(e,t,i=!1){const a={width:e,height:t,frameRate:{ideal:60,max:60}};a.facingMode=i?{exact:"environment"}:{facingMode:"user"};const s=document.createElement("video");s.style.display="none",s.preload="auto",s.crossOrigin="anonymous",document.body.appendChild(s),navigator.mediaDevices.getUserMedia({audio:!1,video:a}).then(e=>{s.srcObject=e,s.onloadedmetadata=e=>{s.play(),this.width=s.videoWidth,this.height=s.videoHeight,console.log("Webcam:["+this.width+", "+this.height+"]"),this.__data=s,this.__loaded=!0,this.loaded.emit(s);let t=0;const i=()=>{if(s.paused||s.ended)return;const e=Math.floor(60*s.currentTime);t!=e&&(this.updated.emit(),t=e),setTimeout(i,20)};i()}}).catch((function(e){}))}setVideoStream(e){this.__loaded=!1,this.width=e.videoWidth,this.height=e.videoHeight,this.start(),this.__data=e,this.__loaded=!0,this.loaded.emit(e)}stop(){clearInterval(this.__intervalId)}start(){this.__intervalId=setInterval(()=>{this.updated.emit()},20)}isLoaded(){return this.__loaded}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,data:this.__data,flipY:this.getParameter("FlipY").getValue()}}}z.registerClass("VideoStreamImage2D",ht);class ct{constructor(e="MaterialLibrary"){this.__name=e,this.lod=0,r.isMobileDevice&&(this.lod=1),this.loaded=new M,this.clear()}clear(){this.__images={},this.__materials={Default:new Me("Default","SimpleSurfaceShader")}}getPath(){return[this.__name]}getNumMaterials(){return Object.keys(this.__materials).length}getMaterials(){return Object.values(this.__materials)}getMaterialNames(){const e=[];for(const t in this.__materials)e.push(t);return e}hasMaterial(e){return e in this.__materials}addMaterial(e){e.setOwner(this),this.__materials[e.getName()]=e}getMaterial(e,t=!0){const i=this.__materials[e];if(!i&&t)throw new Error("Material:"+e+" not found in library:"+this.getMaterialNames());return i}hasImage(e){return e in this.__images}addImage(e){e.setOwner(this),this.__images[e.getName()]=e}getImage(e,t=!0){const i=this.__images[e];if(!i&&t)throw new Error("Image:"+e+" not found in library:"+this.getImageNames());return i}getImageNames(){const e=[];for(const t in this.__images)e.push(t);return e}load(e){const t=new XMLHttpRequest;t.open("GET",e,!0),t.ontimeout=()=>{throw new Error("The request for "+e+" timed out.")},t.onload=()=>{4===t.readyState&&(200===t.status?this.fromJSON(JSON.parse(t.responseText)):console.warn(t.statusText))},t.send(null)}toJSON(e={},t=0){return{numMaterials:this.geoms.length()}}fromJSON(e,t={},i=0){t.lod=this.lod;for(const t in e.textures)new Qe(t).fromJSON(e.textures[t]),this.__images[t]=texture;for(const t in e.materials){const i=new Me(t);i.fromJSON(e.materials[t]),this.addMaterial(i)}}readBinary(e,t={}){this.name=e.loadStr(),t.lod=this.lod,t.materialLibrary=this;const i=e.loadUInt32();for(let a=0;a<i;a++){const i=e.loadStr(),a=z.constructClass(i,void 0);a.readBinary(e,t),this.__images[a.getName()]=a}const a=e.loadUInt32();if(a>0){const i=e.loadUInt32Array(a);for(let s=0;s<a;s++){const a=new Me("");e.seek(i[s]),a.readBinary(e,t,this.__images),this.addMaterial(a)}}this.loaded.emit()}toString(){return JSON.stringify(this.toJSON(),null,2)}}const mt=new class{constructor(){this.__materialLibraries={},this.materialLibraryLoaded=new M,ne.registerResourceCallback(".matlib",e=>{q(e.url,t=>{const i=e.name.split(".")[0],a=JSON.parse(t),s=new ct(i);s.fromJSON(a),this.__materialLibraries[i]=s,this.materialLibraryLoaded.emit(s)})})}getMaterialLibraryNames(){const e=[];for(const t in this.__materialLibraries)e.push(t);return e}hasMaterialLibrary(e){return e in this.__materialLibraries}getMaterialLibrary(e){const t=this.__materialLibraries[e];return t||console.warn("MaterialLibrary:"+e+" not found in MaterialLibraryManager. Found: ["+this.getMaterialLibraryNames()+"]"),t}resolveMaterialFromPath(e){const t=this.getMaterialLibrary(e[0]);if(t)return t.getMaterial(e[1])}};class ut extends H{constructor(e,t){super(e,t,"Material"),this.valueParameterValueChanged=new M}setValue(e,t=P.USER_SETVALUE){this.__value!==e&&(this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit),this.__value=e,this.__value&&this.__value.parameterValueChanged.connect(this.valueParameterValueChanged.emit),t!=P.USER_SETVALUE&&t!=P.REMOTEUSER_SETVALUE||(this.__flags|=E.USER_EDITED),t!=P.OPERATOR_SETVALUE&&this.valueChanged.emit(t))}toJSON(e,t){if(0!=(this.__flags&E.USER_EDITED))return{value:this.__value.getPath()}}fromJSON(e,t,i){if(null==e.value)return void console.warn("Invalid Parameter JSON");const a=e.value,s=mt.resolveMaterialFromPath(a);s&&this.setValue(s),this.__flags|=E.USER_EDITED}clone(e){return new ut(this.__name,this.__value)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit)}}class bt{constructor(e,t,i){if(this.__dataType=e,this.normalized=!1,null!=e.numElements)this.__dimension=this.__dataType.numElements();else switch(e){case 6:case 4:case 5:this.__dimension=1;break;default:throw new Error("Invalid data type for attribute:"+e)}var a;this.__defaultElementValue=null!=i?i:Number.MAX_VALUE,(a=t)&&void 0!==a.byteLength?this.__data=t:(this.__data=new Float32Array(t*this.__dimension),this.initRange(0))}resize(e){const t=this.__data.length,i=e*this.__dimension,a=new Float32Array(i);for(let e=0;e<Math.min(this.__data.length,i);e++)a[e]=this.__data[e];this.__data.length<i&&(this.__data=a),this.initRange(t)}initRange(e){for(let t=e;t<this.__data.length;t++)this.__data[t]=this.__defaultElementValue}getCount(){return this.__data.length/this.__dimension}get length(){return this.__data.length/this.__dimension}get dataType(){return this.__dataType}get data(){return this.__data}set data(e){this.__data=e}get numElements(){return this.__dimension}getFloat32Value(e){return this.__data[e]}setFloat32Value(e,t){this.__data[e]=t}getValueRef(e){const t=this.__dimension;if(e>=this.__data.length/t)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);return this.__dataType.createFromFloat32Buffer(this.__data.buffer,e*t)}setValue(e,t){const i=this.__dimension;if(e>=this.__data.length/i)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);this.__dataType.createFromFloat32Buffer(this.__data.buffer,e*i).setFromOther(t)}toJSON(e,t){return{data:Array.from(this.__data),dataType:u.getTypeName(this.__dataType),defaultValue:this.__defaultElementValue,length:this.__data.length/this.__dimension}}fromJSON(e){this.__data=Float32Array.from(e.data)}toString(){return JSON.stringify(this.toJSON(),null,2)}}class pt extends B{constructor(){super(),this.__boundingBox=new W,this.__boundingBoxDirty=!0,this.__vertexAttributes=new Map,this.__metaData=new Map,this.addVertexAttribute("positions",g,0),this.boundingBoxDirtied=new M,this.geomDataChanged=new M,this.geomDataTopologyChanged=new M}setDebugName(e){this.__name=e}addVertexAttribute(e,t,i){let a;var s;return a=(s=i)&&void 0!==s.byteLength?new bt(t,i):new bt(t,null!=this.vertices?this.vertices.length:0,i),this.__vertexAttributes.set(e,a),a}hasVertexAttribute(e){return this.__vertexAttributes.has(e)}getVertexAttribute(e){return this.__vertexAttributes.get(e)}getVertexAttributes(e){const t={};for(const[e,i]of this.__vertexAttributes.entries())t[e]=i;return t}get vertices(){return this.__vertexAttributes.get("positions")}numVertices(){return this.vertices.length}getNumVertices(){return this.vertices.length}setNumVertices(e){this.__vertexAttributes.forEach(t=>t.resize(e))}getVertex(e){return g.createFromFloat32Buffer(this.vertices.data.buffer,3*e)}setVertex(e,t){return g.createFromFloat32Buffer(this.vertices.data.buffer,3*e).setFromOther(t)}moveVertices(e){const t=this.vertices;for(let i=0;i<t.length;i++)t.getValueRef(i).addInPlace(e);this.setBoundingBoxDirty()}transformVertices(e){const t=this.vertices;for(let i=0;i<t.length;i++){const a=t.getValueRef(i),s=e.transformVec3(a);a.set(s.x,s.y,s.z)}this.setBoundingBoxDirty()}get boundingBox(){return this.__boundingBoxDirty&&this.updateBoundingBox(),this.__boundingBox}setBoundingBoxDirty(){this.__boundingBoxDirty=!0,this.boundingBoxDirtied.emit()}updateBoundingBox(){const e=this.vertices,t=new W,i=e.length;for(let a=0;a<i;a++)t.addPoint(e.getValueRef(a));this.__boundingBox=t,this.__boundingBoxDirty=!1}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t)}deleteMetadata(e){this.__metaData.delete(e)}genBuffers(e){const t={};for(const[e,i]of this.__vertexAttributes)t[e]={values:i.data,count:i.size,dataType:i.dataType,normalized:i.normalized};return{numVertices:this.numVertices(),attrBuffers:t}}freeBuffers(){}loadBaseGeomBinary(e){this.name=e.loadStr();const t=e.loadUInt8();this.debugColor=e.loadRGBFloat32Color();const i=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(i);const a=this.vertices;let s,n;2&t&&(s=this.getVertexAttribute("normals"),s||(s=this.addVertexAttribute("normals",g,0))),4&t&&(n=this.getVertexAttribute("texCoords"),n||(n=this.addVertexAttribute("texCoords",p,0)));const r=(e,t,i,s)=>{for(let n=e[0];n<e[1];n++){const e=new g(s[3*n+0]/255,s[3*n+1]/255,s[3*n+2]/255);e.multiplyInPlace(i),e.addInPlace(t),a.setValue(n,e)}},l=(e,t,i,a)=>{i.isNull()&&i.set(1,1,1);for(let n=e[0];n<e[1];n++){const e=new g(a[3*n+0]/255,a[3*n+1]/255,a[3*n+2]/255);e.multiplyInPlace(i),e.addInPlace(t),e.normalizeInPlace(),s.setValue(n,e)}},o=(e,t,i,a)=>{for(let s=e[0];s<e[1];s++){const e=new p(a[2*s+0]/255,a[2*s+1]/255);e.multiplyInPlace(i),e.addInPlace(t),n.setValue(s,e)}},d=e.loadUInt32();if(1==d){{const t=this.__boundingBox,a=e.loadUInt8Array(3*i);r([0,i],t.p0,t.diagonal(),a)}if(s){const t=new W(e.loadFloat32Vec3(),e.loadFloat32Vec3()),a=e.loadUInt8Array(3*i);l([0,i],t.p0,t.diagonal(),a),s.loadSplitValues(e)}if(n){const t=new x(e.loadFloat32Vec2(),e.loadFloat32Vec2()),a=e.loadUInt8Array(2*i);o([0,i],t.p0,t.diagonal(),a),n.loadSplitValues(e)}}else{const t=[];let a=0;for(let i=0;i<d;i++){const i=e.loadUInt32(),r={range:[a,a+i],bbox:new W(e.loadFloat32Vec3(),e.loadFloat32Vec3())};s&&(r.normalsRange=new W(e.loadFloat32Vec3(),e.loadFloat32Vec3())),n&&(r.texCoordsRange=new x(e.loadFloat32Vec2(),e.loadFloat32Vec2())),t.push(r),a+=i}const h=e.loadUInt8Array(3*i);let c,m;s&&(c=e.loadUInt8Array(3*i)),n&&(m=e.loadUInt8Array(2*i));for(let e=0;e<d;e++){{const i=t[e].bbox;r(t[e].range,i.p0,i.diagonal(),h)}if(s){const i=t[e].normalsRange;l(t[e].range,i.p0,i.diagonal(),c)}if(n){const i=t[e].texCoordsRange;o(t[e].range,i.p0,i.diagonal(),m)}}s&&s.loadSplitValues(e),n&&n.loadSplitValues(e)}}toJSON(e,t){let i=super.toJSON(e,t);if(i||(i={}),i.type=z.getClassName(this),!(1024&t)){const a={};for(const[i,s]of this.__vertexAttributes.entries())a[i]=s.toJSON(e,t);i.vertexAttributes=a}return i}fromJSON(e,t,i){super.fromJSON(e,t,i);for(const t in e.vertexAttributes){let i=this.__vertexAttributes.get(t);const a=e.vertexAttributes[t];if(!i){const e=u.getType(a.dataType);i=new VertexAttribute(this,e,0,a.defaultScalarValue),this.__vertexAttributes.set(t,i)}i.fromJSON(a)}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class gt extends bt{constructor(e,t,i,a){super(t,i,a),this.__geom=e,this.__splits={},this.__splitValues=[]}getFaceVertexValueRef(e,t){const i=this.__geom.getFaceVertexIndex(e,t);return i in this.__splits&&e in this.__splits[i]?this.__splitValues[this.__splits[i][e]]:this.getValueRef(i)}setFaceVertexValue(e,t,i){const a=this.__geom.getFaceVertexIndex(e,t);this.setFaceVertexValue_ByVertexIndex(e,a,i)}setFaceVertexValue_ByVertexIndex(e,t,i){const a=this.getValueRef(t);if(a.isValid())if(a.approxEqual(i));else{if(t in this.__splits){const a=this.__splits[t];for(const t in a){const s=a[t];if(this.__splitValues[s].approxEqual(i))return void(a[e]=s)}if(e in this.__splits[t])return void this.__splitValues[this.__splits[t][e]].setFromOther(i)}else this.__splits[t]={};this.__splits[t][e]=this.__splitValues.length,this.__splitValues.push(i)}else a.setFromOther(i)}setSplitVertexValue(e,t,i){if(e in this.__splits||(this.__splits[e]={}),t in this.__splits[e]){if(this.__splitValues[this.__splits[e][t]].approxEqual(i))return;console.warn("Face Vertex Already Split with different value")}this.__splits[e][t]=this.__splitValues.length,this.__splitValues.push(i)}setSplitVertexValues(e,t,i){e in this.__splits||(this.__splits[e]={});const a=this.__splitValues.length;this.__splitValues.push(i);for(const i of t)this.__splits[e][i]=a}getSplits(){return this.__splits}getSplitCount(){let e=0;for(const t in this.__splits)e+=Object.keys(this.__splits[t]).length;return e}generateSplitValues(e,t){if(0==t)return this.__data;const i=this.length,a=this.length+t,s=this.__dataType.numElements?this.__dataType.numElements():1,n=new Float32Array(a*s);for(let e=0;e<this.__data.length;e++)n[e]=this.__data[e];for(const t in e){const a=e[t];for(const e in a){const r=i+a[e];if(t in this.__splits&&e in this.__splits[t]){const i=this.__splits[t][e];6==this.__dataType?n[r*s]=this.__splitValues[i]:this.__dataType.createFromFloat32Buffer(n.buffer,r*s).setFromOther(this.__splitValues[i])}else{const e=parseInt(t);for(let t=0;t<s;t++)e*s+t>this.__data.length&&console.log("Error remapping src:"+e*s+t),r*s+t>n.length&&console.log("Error remapping tgt:"+r*s+t),n[r*s+t]=this.__data[e*s+t]}}}return n}toJSON(e,t){const i=super.toJSON(e,t);return i.splits=this.__splits,i.splitValues=this.__splitValues,i}fromJSON(e,t,i){super.fromJSON(e,t,i),this.__splits=e.splits,this.__splitValues=[];for(const t of e.splitValues)this.__splitValues.push(this.__dataType.createFromJSON(t))}loadSplitValues(e){const t=e.loadUInt32Array();if(0==t.length)return;let i=0,a=0;for(;;){const e=t[i++],s=t[i++],n={};for(let e=0;e<s;e++){const e=t[i++],s=t[i++];n[e]=s,s>=a&&(a=s+1)}if(this.__splits[e]=n,i>=t.length)break}const s=this.__numFloat32Elements,n=e.loadFloat32Array(a*s);this.__splitValues=[];for(let e=0;e<a;e++){const t=this.__dataType.createFromFloat32Array(n.slice(e*s,e*s+s));this.__splitValues.push(t)}}}class _t extends pt{constructor(){super()}loadBin(e){this.name=e.loadStr();const t=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(t);const i=this.vertices;if(t<256){const a=this.__boundingBox.toMat4(),s=e.loadUInt8Array(3*t);for(let e=0;e<t;e++){const t=new Vec3(s[3*e+0]/255,s[3*e+1]/255,s[3*e+2]/255);i.setValue(e,a.transformVec3(t))}}else{const a=e.loadUInt32(),s=[];for(let t=0;t<a;t++){const t=e.loadUInt32Vec2(),i=e.loadFloat32Vec3(),a=e.loadFloat32Vec3();s.push({range:t,bbox:new Box3(i,a)})}const n=e.loadUInt8Array(3*t);for(let e=0;e<a;e++){const t=s[e].bbox.toMat4();for(let a=s[e].range.x;a<s[e].range.y;a++){const e=new Vec3(n[3*a+0]/255,n[3*a+1]/255,n[3*a+2]/255);i.setValue(a,t.transformVec3(e))}}}}readBinary(e,t){super.loadBaseGeomBinary(e),this.geomDataChanged.emit()}}class ft extends pt{constructor(){super(),this.__indices=new Uint32Array,this.__segmentAttributes=new Map,this.lineThickness=0}getIndices(){return this.__indices}getNumSegments(){return this.__indices.length/2}setNumSegments(e){const t=new Uint32Array(2*e);this.__indices=t}setSegment(e,t,i){if(e>=this.__indices.length/2)throw new Error("Invalid line index:"+e+". Num Segments:"+this.__indices.length/2);this.__indices[2*e+0]=t,this.__indices[2*e+1]=i}getSegmentVertexIndex(e,t){if(e<this.numLines)return this.__indices[2*e+t]}addSegmentAttribute(e,t,i){const a=new Attribute(t,null!=i?i:this.polygonCount);return this.__segmentAttributes.set(e,a),a}hasSegmentAttribute(e){return this.__segmentAttributes.has(e)}getSegmentAttribute(e){return this.__segmentAttributes.get(e)}genBuffers(){const e=super.genBuffers();let t;return e.numVertices<Math.pow(2,8)?(t=new Uint8Array(this.__indices.length),this.__indices.forEach((e,i)=>{t[i]=e})):e.numVertices<Math.pow(2,16)?(t=new Uint16Array(this.__indices.length),this.__indices.forEach((e,i)=>{t[i]=e})):t=this.__indices,e.indices=t,e}readBinary(e,t){super.loadBaseGeomBinary(e),this.setNumSegments(e.loadUInt32());const i=e.loadUInt8();1==i?this.__indices=e.loadUInt8Array():2==i?this.__indices=e.loadUInt16Array():4==i&&(this.__indices=e.loadUInt32Array()),this.geomDataChanged.emit()}toJSON(e,t){const i=super.toJSON(e,t);return 1024&t||(i.indices=Array.from(this.__indices)),i}fromJSON(e,t,i){super.fromJSON(e,t,i),this.__indices=Uint32Array.from(e.indices)}}class Zt extends pt{constructor(){super(),this.init()}init(){this.__faceCounts=[],this.__faceVertexCounts=new Uint8Array,this.__faceOffsets=new Uint32Array,this.__faceVertexIndices=new Uint32Array,this.__numPopulatedFaceVertexIndices=0,this.__faceAttributes=new Map,this.__edgeAttributes=new Map,this.__logTopologyWarnings=!1,this.edgeVerts=void 0,this.vertexEdges=void 0,this.numEdges=0,this.edgeFlags=new Uint32Array,this.edgeAngles=new Float32Array}getFaceVertexIndices(){return this.__faceVertexIndices}getFaceCounts(){return this.__faceCounts}clear(){this.__faceVertexIndices=void 0,this.__faceCounts=[],this.__numPopulatedFaceVertexIndices=0}setFaceCounts(e){if(this.__numPopulatedFaceVertexIndices)throw new Error("Cannot set face counts on a mesh that is already populated. Please call 'clear' before re-building the mesh.");this.__faceCounts=e;let t=0,i=0,a=3;for(const e of this.__faceCounts)t+=e,i+=e*a,a++;this.__faceVertexCounts=new Uint8Array(t),this.__faceOffsets=new Uint32Array(t),this.__faceVertexIndices=new Uint32Array(i);for(const e of this.__faceAttributes)e.resize(t)}setFaceVertexIndices(e){const t=Array.prototype.slice.call(arguments,1),i=this.__numPopulatedFaceVertexIndices;for(let e=0;e<t.length;e++)this.__faceVertexIndices[i+e]=t[e];this.__faceVertexCounts[e]=t.length-3,this.__faceOffsets[e]=i,this.__numPopulatedFaceVertexIndices+=t.length}getFaceVertexIndices(e){const t=[],i=this.__faceOffsets[e],a=this.__faceVertexCounts[e]+3;for(let e=0;e<a;e++)t.push(this.__faceVertexIndices[i+e]);return t}getFaceVertexIndex(e,t){const i=this.__faceOffsets[e];return this.__faceVertexIndices[i+t]}getNumFaces(){return this.__faceVertexCounts.length}addVertexAttribute(e,t,i){const a=new gt(this,t,null!=this.vertices?this.vertices.length:0,i);return this.__vertexAttributes.set(e,a),a}addFaceAttribute(e,t,i){const a=new bt(t,null!=i?i:this.getNumFaces());return this.__faceAttributes.set(e,a),a}hasFaceAttribute(e){return this.__faceAttributes.has(e)}getFaceAttribute(e){return this.__faceAttributes.get(e)}addEdgeAttribute(e,t,i){const a=new bt(t,null!=i?i:this.getNumEdges());return this.__edgeAttributes.set(e,a),a}hasEdgeAttribute(e){return this.__edgeAttributes.has(e)}getEdgeAttribute(e){return this.__edgeAttributes.get(e)}genTopologyInfo(){const e={};this.vertexEdges=[],this.edgeFaces=[],this.edgeVerts=[],this.faceEdges=[],this.numEdges=0;const t=(t,i)=>{let a=t,s=i;if(s<a){const e=a;a=s,s=e}const n=a+">"+s;if(n in e)return e[n];const r=this.vertices.getValueRef(a),l=this.vertices.getValueRef(s).subtract(r),o={edgeIndex:this.edgeFaces.length/2,edgeVec:l};return e[n]=o,this.edgeFaces.push(-1),this.edgeFaces.push(-1),this.edgeVerts.push(a),this.edgeVerts.push(s),this.numEdges++,o},i=(e,i,a)=>{const s=t(e,i).edgeIndex;if(i<e){const e=2*s+0;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 0 already set. Mesh is non-manifold."),this.edgeFaces[e]=a}else{const e=2*s+1;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 1 already set. Mesh is non-manifold."),this.edgeFaces[e]=a}a in this.faceEdges||(this.faceEdges[a]=[]),this.faceEdges[a].push(s),null==this.vertexEdges[e]&&(this.vertexEdges[e]=new Set),null==this.vertexEdges[i]&&(this.vertexEdges[i]=new Set),this.vertexEdges[e].add(s),this.vertexEdges[i].add(s)},a=this.getNumFaces();for(let e=0;e<a;e++){const t=this.getFaceVertexIndices(e);for(let a=0;a<t.length;a++)i(t[a],t[(a+1)%t.length],e)}}computeFaceNormals(){const e=this.vertices,t=this.addFaceAttribute("normals",g),i=this.getNumFaces();for(let a=0;a<i;a++){const i=this.getFaceVertexIndices(a),s=e.getValueRef(i[0]);let n=e.getValueRef(i[1]);const r=new g;for(let t=2;t<i.length;t++){const a=e.getValueRef(i[t]),l=n.subtract(s),o=a.subtract(s);r.addInPlace(l.cross(o).normalize()),n=a}r.lengthSquared(),Number.EPSILON,t.setValue(a,r.normalize())}}generateEdgeFlags(){null==this.vertexEdges&&this.genTopologyInfo(),this.hasFaceAttribute("normals")||this.computeFaceNormals();const e=this.vertices,t=this.getFaceAttribute("normals");this.edgeVecs=[],this.edgeAngles=new Float32Array(this.numEdges);for(let i=0;i<this.edgeFaces.length;i+=2){const a=this.edgeVerts[i],s=this.edgeVerts[i+1],n=e.getValueRef(s).subtract(e.getValueRef(a));n.normalizeInPlace(),this.edgeVecs.push(n);const r=this.edgeFaces[i],l=this.edgeFaces[i+1];if(-1==r||-1==l){this.edgeAngles[i/2]=2*Math.PI;continue}const o=t.getValueRef(r),d=t.getValueRef(l);this.edgeAngles[i/2]=o.angleTo(d)}}computeVertexNormals(e=1){this.generateEdgeFlags(),this.vertices;const t=this.getFaceAttribute("normals"),i=this.addVertexAttribute("normals",g),a=t.data.buffer,s=e=>new g(a,12*e),n=i.data,r=(e,t)=>{n[3*e+0]=t.x,n[3*e+1]=t.y,n[3*e+2]=t.z},l=(e,t)=>{let i,a;const s=this.faceEdges[e];for(const e of s)(this.edgeVerts[2*e]==t||this.edgeVerts[2*e+1]==t)&&(i?a=this.edgeVecs[e]:i=this.edgeVecs[e]);return[i,a]};for(let t=0;t<this.vertexEdges.length;t++){if(null==this.vertexEdges[t])continue;const a=this.vertexEdges[t],n=[],o=e=>{let t=!1;for(const i of n)if(t=-1!=i.indexOf(e),t)break;t||n.push([e])};for(const t of a){const i=this.edgeFaces[2*t],a=this.edgeFaces[2*t+1];if(-1!=i&&-1==a&&this.edgeAngles[t]<e){let e=-1,t=-1;for(let s=0;s<n.length;s++)-1==e&&-1!=n[s].indexOf(i)&&(e=s),-1==t&&-1!=n[s].indexOf(a)&&(t=s);-1==e&&-1==t?n.push([i,a]):-1!=e&&-1!=t?e!=t&&(n[e]=n[e].concat(n[t]),n.splice(t,1)):(-1==e&&n[t].push(i),-1==t&&n[e].push(a))}else-1!=i&&o(i),-1!=a&&o(a)}n.sort((e,t)=>e.length<t.length?1:e.length>t.length?-1:0);let d=!0;for(const e of n){const a=new g;for(const i of e){const e=l(i,t),n=e[0].angleTo(e[1]);a.addInPlace(s(i).scale(n))}a.normalizeInPlace(),d?(r(t,a),d=!1):i.setSplitVertexValues(t,e,a)}}return i}computeNumTriangles(){let e=3,t=0;for(const i of this.__faceCounts)t+=i*(e-2),e++;return t}generateTriangulatedIndices(e,t,i){const a=this.computeNumTriangles();let s;s=e<Math.pow(2,8)?new Uint8Array(3*a):e<Math.pow(2,16)?new Uint16Array(3*a):new Uint32Array(3*a);let n=0;const r=function(e,a){e in i&&a in i[e]&&(e=t+i[e][a]),s[n]=e,n++},l=this.getNumFaces();for(let e=0;e<l;e++){const t=this.getFaceVertexIndices(e);for(let i=0;i<t.length;i++)i>=3&&(r(t[0],e),r(t[i-1],e)),r(t[i],e)}return s}computeHardEdgesIndices(e=1){const t=[],i=e=>{t.push(this.edgeVerts[e]),t.push(this.edgeVerts[e+1])};for(let t=0;t<this.edgeFlags.length;t+=2)this.edgeAngles[t/2]>e&&i(t);return t}getWireframeIndices(){return indices}genBuffers(e){const t={};let i=0;for(const[,e]of this.__vertexAttributes){const a=e.getSplits();for(const e in a){e in t||(t[e]={});const s=a[e];for(const a in s){const s=parseInt(a);s in t[e]||(t[e][s]=i,i++)}}}const a=this.vertices.length,s=a+i;let n;e&&0==e.includeIndices||(n=this.generateTriangulatedIndices(s,a,t));const r={};for(const[e,a]of this.__vertexAttributes){let s;s=0==i?a.data:a.generateSplitValues(t,i);const n=a.numElements,l=s.length/n;r[e]={values:s,count:l,dimension:n,normalized:"normals"==e,dataType:a.dataType}}const l={numVertices:this.numVertices(),numRenderVerts:s,indices:n,attrBuffers:r};if(e&&e.includeVertexNeighbors){null==this.vertexEdges&&this.genTopologyInfo();let e=0;for(let t=0;t<this.vertexEdges.length;t++)this.vertexEdges[t]&&(e+=this.vertexEdges[t].size);const t=new Uint32Array(2*this.vertexEdges.length+e),i=e=>{for(let t=0;t<e.length;t++){const i=e[t];for(let a=0;a<t;a++){const s=e[a];if(-1!=i[0]&&i[0]==s[1]){t!=a+1&&(e.splice(t,1),e.splice(a+1,0,i));break}if(-1!=i[1]&&i[1]==s[0]){e.splice(t,1),e.splice(a,0,i);break}}}},a=e=>{if(!(-1!=e[0][0]&&-1!=e[e.length-1][1]||-1==e[0][0]&&-1==e[e.length-1][1]))throw new Error("If fan starts with -1, it must also end with -1");for(let t=0;t<e.length;t++){const i=e[t];if((-1==i[0]||-1==i[1])&&0!=t&&t!=e.length-1)throw new Error("-1 only allowed at the beginning and end of a fan.");if(-1!=i[0]){let a=t-1;if(a<0&&(a+=e.length),i[0]!=e[a][1])throw new Error("Faces are not sequential")}if(-1!=i[1]){const a=(t+1)%e.length;if(i[1]!=e[a][0])throw new Error("Faces are not sequential")}}};let s=2*this.vertexEdges.length;for(let e=0;e<this.vertexEdges.length;e++){if(null==this.vertexEdges[e])continue;const n=this.vertexEdges[e],r=[];for(const t of n){const i=this.edgeVerts[2*t],a=this.edgeVerts[2*t+1];let s,n=this.edgeFaces[2*t],l=this.edgeFaces[2*t+1];if(i==e)s=a;else{if(a!=e)throw new Error("Invalid topology");{s=i;const e=n;n=l,l=e}}r.push([n,l,s])}i(r),a(r);let l=0;(-1!=r[0][0]||-1!=r[r.length-1][1])&&(l+=1),t[2*e]=s,t[2*e+1]=n.size+(l<<8);for(const e of r)t[s]=e[2],s++}l.vertexNeighbors=t}return l}freeBuffers(){super.freeBuffers(),this.init()}readBinary(e,t){super.loadBaseGeomBinary(e),this.setFaceCounts(e.loadUInt32Array()),this.__faceVertexCounts=e.loadUInt8Array(this.__faceVertexCounts.length);const i=e.loadSInt32Vec2(),a=e.loadUInt8();let s;1==a?s=e.loadUInt8Array():2==a?s=e.loadUInt16Array():4==a&&(s=e.loadUInt32Array());const n=this.getNumFaces();let r=0,l=0;for(let e=0;e<n;e++){const t=this.__faceVertexCounts[e]+3;this.__faceOffsets[e]=r;for(let a=0;a<t;a++){const t=r+a,n=s[t]+i.x;if(0==e)this.__faceVertexIndices[t]=n;else{let i=this.__faceOffsets[e-1];i+=a<l?a:l-1,this.__faceVertexIndices[t]=this.__faceVertexIndices[i]+n}}r+=t,l=t}this.__numPopulatedFaceVertexIndices=r;const o=e.loadUInt32();if(o>0){const t=this.vertices,i=this.addVertexAttribute("lightmapCoords",p);for(let a=0;a<o;a++){const a=new R(e.loadFloat32Vec3(),e.loadFloat32Quat()),s=e.loadFloat32(),n=e.loadFloat32Vec2(),r=e.loadSInt32Vec2(),l=e.loadUInt8();let o;o=1==l?e.loadUInt8Array():2==l?e.loadUInt16Array():e.loadUInt32Array();let d=0;for(const e of o){let l=e+r.x;l+=d,d=l;const o=this.getFaceVertexIndices(l);for(const e of o){const r=t.getValueRef(e),o=a.transformVec3(r),d=new p(o.x,o.z);d.scaleInPlace(s),d.addInPlace(n),i.setFaceVertexValue_ByVertexIndex(l,e,d)}}}}this.hasVertexAttribute("normals")||this.computeVertexNormals(),this.geomDataChanged.emit()}toJSON(e,t){const i=super.toJSON(e,t);return 1024&t||(i.faceCounts=Array.from(this.__faceCounts),i.faceVertexIndices=Array.from(this.__faceVertexIndices)),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.faceCounts&&(this.__faceCounts=Uint32Array.from(e.faceCounts)),e.faceVertexIndices&&(this.__faceVertexIndices=Uint32Array.from(e.faceVertexIndices))}}class Gt extends K{constructor(e){if(super(),this.name=e.name,this.__buffers=e.geomBuffers,this.__buffers.attrBuffers)for(const e in this.__buffers.attrBuffers){const t=this.__buffers.attrBuffers[e],i=u.getType(t.dataType);t.dataType=i}this.boundingBox=new W,this.boundingBox.p0.__data=e.bbox.p0.__data,this.boundingBox.p1.__data=e.bbox.p1.__data,this.__metaData=new Map,this.boundingBoxDirtied=new M,this.geomDataChanged=new M,this.geomDataTopologyChanged=new M}genBuffers(){return this.__buffers}freeBuffers(){const e={attrBuffers:{}},t=[];if(this.__buffers.indices&&(t.push(this.__buffers.indices.buffer),e.indices=this.__buffers.indices,delete this.__buffers.indices),this.__buffers.attrBuffers){for(const i in this.__buffers.attrBuffers){const a=this.__buffers.attrBuffers[i];e.attrBuffers[i]=this.__buffers.attrBuffers[i],t.push(a.values.buffer),delete this.__buffers.attrBuffers[i]}delete this.__buffers.attrBuffers}}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t)}}class yt extends Gt{constructor(e){super(e)}}class Xt extends Gt{constructor(e){super(e)}}class Vt extends Gt{constructor(e){super(e)}}class It extends ft{constructor(e=1,t=1){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__x=this.addParameter(new oe("x",e)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new oe("y",t)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__rebuild()}get x(){return this.__x.getValue()}set x(e){this.__x.setValue(e)}get y(){return this.__y.getValue()}set y(e){this.__y.setValue(e)}setSize(e,t){this.__x.setValue(e,-1),this.__y.setValue(t,-1),this.__resize()}__rebuild(){this.setNumVertices(4),this.setNumSegments(4),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(e){const t=this.__x.getValue(),i=this.__y.getValue();this.getVertex(0).set(-.5*t,-.5*i,0),this.getVertex(1).set(.5*t,-.5*i,0),this.getVertex(2).set(.5*t,.5*i,0),this.getVertex(3).set(-.5*t,.5*i,0),this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit()}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e}}z.registerClass("Rect",It);class Rt extends ft{constructor(e=1,t=2*Math.PI,i=32){if(super(),isNaN(e)||isNaN(i))throw new Error("Invalid geom args");this.__radius=this.addParameter(new oe("Radius",e)),this.__angle=this.addParameter(new oe("Angle",t)),this.__numSegments=this.addParameter(new oe("NumSegments",i>=3?i:3,[3,200],1)),this.__radius.valueChanged.connect(this.__resize.bind(this)),this.__angle.valueChanged.connect(this.__rebuild.bind(this)),this.__numSegments.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild()}__rebuild(){const e=this.__numSegments.getValue();this.setNumVertices(e);const t=this.__angle.getValue()<2*Math.PI;t?this.setNumSegments(e-1):this.setNumSegments(e);for(let i=0;i<(t?e-1:e);i++)this.setSegment(i,i,(i+1)%e);this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(e){const t=this.__radius.getValue(),i=this.__numSegments.getValue(),a=this.__angle.getValue()/i;for(let e=0;e<i;e++)this.getVertex(e).set(Math.cos(a*e)*t,Math.sin(a*e)*t,0);this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit()}}z.registerClass("Circle",Rt);class xt extends ft{constructor(e=1){if(super(),isNaN(e))throw new Error("Invalid geom args");this.__sizeParam=this.addParameter(new oe("size",e)),this.__rebuild(),this.__sizeParam.valueChanged.connect(()=>{this.__resize()})}get size(){return this.__size}set size(e){this.__size=e,this.__resize()}__rebuild(){this.setNumVertices(6),this.setNumSegments(3),this.setSegment(0,0,1),this.setSegment(1,2,3),this.setSegment(2,4,5),this.__resize()}__resize(){const e=this.__sizeParam.getValue();this.getVertex(0).set(-.5*e,0,0),this.getVertex(1).set(.5*e,0,0),this.getVertex(2).set(0,.5*e,0),this.getVertex(3).set(0,-.5*e,0),this.getVertex(4).set(0,0,.5*e),this.getVertex(5).set(0,0,-.5*e),this.setBoundingBoxDirty()}}z.registerClass("Cross",xt);class St extends ft{constructor(e=1,t=1,i=1,a=!1){super(),this.__x=this.addParameter(new oe("x",e)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new oe("y",t)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__z=this.addParameter(new oe("z",i)),this.__z.valueChanged.connect(this.__resize.bind(this)),this.__baseZAtZero=this.addParameter(new oe("BaseZAtZero",a)),this.__baseZAtZero.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild()}__rebuild(){this.setNumVertices(8),this.setNumSegments(12),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.setSegment(4,4,5),this.setSegment(5,5,6),this.setSegment(6,6,7),this.setSegment(7,7,4),this.setSegment(8,0,4),this.setSegment(9,1,5),this.setSegment(10,2,6),this.setSegment(11,3,7),this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(e){const t=this.__x.getValue(),i=this.__y.getValue(),a=this.__z.getValue(),s=this.__baseZAtZero.getValue();let n=.5;s&&(n=1),this.getVertex(0).set(.5*t,-.5*i,n*a),this.getVertex(1).set(.5*t,.5*i,n*a),this.getVertex(2).set(-.5*t,.5*i,n*a),this.getVertex(3).set(-.5*t,-.5*i,n*a),n=-.5,s&&(n=0),this.getVertex(4).set(.5*t,-.5*i,n*a),this.getVertex(5).set(.5*t,.5*i,n*a),this.getVertex(6).set(-.5*t,.5*i,n*a),this.getVertex(7).set(-.5*t,-.5*i,n*a),this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit()}toJSON(){const e=super.toJSON();return e.size=this.__size,e}}z.registerClass("LinesCuboid",St);class Wt extends ft{constructor(e=1,t=1,i=10,a=10,s=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(a))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new oe("x",e)),this.__yParam=this.addParameter(new oe("y",t)),this.__xDivisionsParam=this.addParameter(new oe("xDivisions",i)),this.__yDivisionsParam=this.addParameter(new oe("yDivisions",a)),this.__skipCenterLinesParam=this.addParameter(new he("skipCenterLines",s)),this.__rebuild()}get sizeX(){return this.__x}set sizeX(e){this.__x=e,this.__resize()}get sizeY(){return this.__y}set sizeY(e){this.__y=e,this.__resize()}get divisionsX(){return this.__xDivisions}set divisionsX(e){this.__xDivisions=e,this.__rebuild()}get divisionsY(){return this.__yDivisions}set divisionsY(e){this.__yDivisions=e,this.__rebuild()}setSize(e,t){this.__x=e,this.__y=t,this.__resize()}__rebuild(){const e=this.__xDivisionsParam.getValue(),t=this.__yDivisionsParam.getValue(),i=this.__skipCenterLinesParam.getValue()&&e%2==0&&t%2==0;this.setNumVertices(2*(e+t+2-(i?1:0))),this.setNumSegments(e+t+2-(i?1:0));let a=0;for(let t=0;t<=e;t++){if(i&&t==e/2)continue;const s=2*a,n=2*a+1;this.setSegment(a,s,n),a++}for(let s=0;s<=t;s++){if(i&&s==e/2)continue;const t=2*a,n=2*a+1;this.setSegment(a,t,n),a++}this.__resize()}__resize(){const e=this.__xDivisionsParam.getValue(),t=this.__yDivisionsParam.getValue(),i=this.__xParam.getValue(),a=this.__yParam.getValue(),s=this.__skipCenterLinesParam.getValue()&&e%2==0&&t%2==0;let n=0;for(let t=0;t<=e;t++){if(s&&t==e/2)continue;const r=2*n,l=2*n+1,o=(t/e-.5)*i;this.getVertex(r).set(o,-.5*a,0),this.getVertex(l).set(o,.5*a,0),n++}for(let r=0;r<=t;r++){if(s&&r==e/2)continue;const l=2*n,o=2*n+1,d=(r/t-.5)*a;this.getVertex(l).set(-.5*i,d,0),this.getVertex(o).set(.5*i,d,0),n++}this.setBoundingBoxDirty()}toJSON(){const e=super.toJSON();return e.x=this.__x,e.z=this.__y,e.xDivisions=this.__xDivisions,e.yDivisions=this.__yDivisions,e}}z.registerClass("Grid",Wt);class Lt extends Zt{constructor(e=.5,t=1,i=32,a=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new oe("radius",e)),this.__heightParam=this.addParameter(new oe("height",t)),this.__detailParam=this.addParameter(new oe("detail",i>=3?i:3,[3,200],1)),this.__capParam=this.addParameter(new he("cap",a)),this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild();const s=()=>{this.__resize()},n=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(s),this.__heightParam.valueChanged.connect(s),this.__detailParam.valueChanged.connect(n),this.__capParam.valueChanged.connect(n)}get radius(){return this.__radiusParam.getValue()}set radius(e){this.__radiusParam.setValue(e),this.__resize()}get height(){return this.__heightParam.getValue()}set height(e){this.__heightParam.setValue(e),this.__resize()}get detail(){return this.__detailParam.getValue()}set detail(e){this.__detailParam.setValue(e),this.__rebuild()}get cap(){return this.__capParam.getValue()}set cap(e){this.__capParam.setValue(e),this.__rebuild()}__rebuild(){this.clear();const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),i=this.__heightParam.getValue(),a=this.__capParam.getValue();let s=e+1;a&&(s+=1),this.setNumVertices(s);const n=e,r=e+1;this.getVertex(n).set(0,0,i);for(let i=0;i<e;i++){const a=i/e*2*Math.PI;this.getVertex(i).set(t*Math.cos(a),t*Math.sin(a),0)}a&&this.getVertex(r).set(0,0,0),this.setFaceCounts([e+(a?e:0)]);for(let t=0;t<e;t++){const i=(t+1)%e;this.setFaceVertexIndices(t,i,t,n)}if(a)for(let t=0;t<e;t++){const i=(t+1)%e;this.setFaceVertexIndices(e+t,t,i,r)}const l=this.getVertexAttribute("normals");let o;const d=i;Math.abs(i)<1e-12&&(o=i<0?-1e-12:1e-12),o=t/d;let h=0;for(let t=0;t<e;t++){const i=(t+1)/e*2*Math.PI,a=t/e*2*Math.PI,s=.5*(i+a);l.setFaceVertexValue(h,0,new g(Math.cos(i),o,Math.sin(i)).normalize()),l.setFaceVertexValue(h,1,new g(Math.cos(a),o,Math.sin(a)).normalize()),l.setFaceVertexValue(h,2,new g(Math.cos(s),o,Math.sin(s)).normalize()),h++}if(a){const t=new g(0,-1,0);for(let i=0;i<e;i++)l.setFaceVertexValue(h,0,t),l.setFaceVertexValue(h,1,t),l.setFaceVertexValue(h,2,t),h++}const c=this.getVertexAttribute("texCoords");h=0;for(let t=0;t<e;t++)c.setFaceVertexValue(h,0,new p((t+1)/e,0)),c.setFaceVertexValue(h,1,new p(t/e,0)),c.setFaceVertexValue(h,2,new p((t+.5)/e,1));if(a)for(let t=0;t<e;t++)c.setFaceVertexValue(h,0,new p(t/e,0)),c.setFaceVertexValue(h,1,new p((t+1)/e,0)),c.setFaceVertexValue(h,2,new p((t+.5)/e,1)),h++;this.setBoundingBoxDirty()}__resize(){const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),i=this.__heightParam.getValue(),a=(this.__capParam.getValue(),e),s=e+1;this.getVertex(a).set(0,0,i);for(let i=0;i<e;i++){const a=i/e*2*Math.PI;this.getVertex(i).set(t*Math.cos(a),t*Math.sin(a),0)}this.__cap&&this.getVertex(s).set(0,0,0),this.setBoundingBoxDirty()}}z.registerClass("Cone",Lt);class vt extends Zt{constructor(e=1,t=1,i=1,a=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new oe("x",e)),this.__yParam=this.addParameter(new oe("y",t)),this.__zParam=this.addParameter(new oe("z",i)),this.__baseZAtZeroParam=this.addParameter(new he("baseZAtZero",a)),this.setFaceCounts([0,6]),this.setFaceVertexIndices(0,0,1,2,3),this.setFaceVertexIndices(1,7,6,5,4),this.setFaceVertexIndices(2,1,0,4,5),this.setFaceVertexIndices(3,3,2,6,7),this.setFaceVertexIndices(4,0,3,7,4),this.setFaceVertexIndices(5,2,1,5,6),this.setNumVertices(8),this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild();const s=()=>{this.__resize()};this.__xParam.valueChanged.connect(s),this.__yParam.valueChanged.connect(s),this.__zParam.valueChanged.connect(s),this.__baseZAtZeroParam.valueChanged.connect(s)}setSize(e,t,i){this.__xParam.setValue(e),this.__yParam.setValue(t),this.__zParam.setValue(i)}setBaseSize(e,t){this.__xParam.setValue(e),this.__yParam.setValue(t)}__rebuild(){const e=this.getVertexAttribute("normals");for(let t=0;t<6;t++){let i;switch(t){case 0:i=new g(0,0,1);break;case 1:i=new g(0,0,-1);break;case 2:i=new g(1,0,0);break;case 3:i=new g(-1,0,0);break;case 4:i=new g(0,1,0);break;case 5:i=new g(0,-1,0)}e.setFaceVertexValue(t,0,i),e.setFaceVertexValue(t,1,i),e.setFaceVertexValue(t,2,i),e.setFaceVertexValue(t,3,i)}const t=this.getVertexAttribute("texCoords");for(let e=0;e<6;e++)t.setFaceVertexValue(e,0,new p(0,0)),t.setFaceVertexValue(e,1,new p(1,0)),t.setFaceVertexValue(e,2,new p(1,1)),t.setFaceVertexValue(e,3,new p(0,1));this.__resize()}__resize(e){const t=this.__xParam.getValue(),i=this.__yParam.getValue(),a=this.__zParam.getValue(),s=this.__baseZAtZeroParam.getValue();let n=.5;s&&(n=1),this.getVertex(0).set(.5*t,-.5*i,n*a),this.getVertex(1).set(.5*t,.5*i,n*a),this.getVertex(2).set(-.5*t,.5*i,n*a),this.getVertex(3).set(-.5*t,-.5*i,n*a),n=-.5,s&&(n=0),this.getVertex(4).set(.5*t,-.5*i,n*a),this.getVertex(5).set(.5*t,.5*i,n*a),this.getVertex(6).set(-.5*t,.5*i,n*a),this.getVertex(7).set(-.5*t,-.5*i,n*a),this.setBoundingBoxDirty(),this.geomDataChanged.emit()}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.z=this.__z,e}}z.registerClass("Cuboid",vt);class Tt extends Zt{constructor(e=.5,t=1,i=32,a=2,s=!0,n=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(a))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new oe("radius",e)),this.__heightParam=this.addParameter(new oe("height",t)),this.__sidesParam=this.addParameter(new oe("sides",i>=3?i:3,[3,200],1)),this.__loopsParam=this.addParameter(new oe("loops",a>=2?a:2,[1,200],1)),this.__capsParam=this.addParameter(new he("caps",s)),this.__baseZAtZeroParam=this.addParameter(new he("baseZAtZero",n)),this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild();const r=()=>{this.__resize()},l=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(r),this.__heightParam.valueChanged.connect(r),this.__sidesParam.valueChanged.connect(l),this.__loopsParam.valueChanged.connect(l),this.__capsParam.valueChanged.connect(l),this.__baseZAtZeroParam.valueChanged.connect(r)}__rebuild(){this.clear(),this.__radiusParam.getValue();const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),i=(this.__heightParam.getValue(),this.__capsParam.getValue());this.__baseZAtZeroParam.getValue();let a=e*t;i&&(a+=2),this.setNumVertices(a),i?this.setFaceCounts([2*e,e]):this.setFaceCounts([0,e]);let s=0;for(let i=0;i<t-1;i++)for(let t=0;t<e;t++){const a=e*i+(t+1)%e,n=e*i+t,r=e*(i+1)+t,l=e*(i+1)+(t+1)%e;this.setFaceVertexIndices(s++,a,n,r,l)}if(i){for(let t=0;t<e;t++){const i=a-1,n=t,r=(t+1)%e;this.setFaceVertexIndices(s++,i,n,r)}for(let i=0;i<e;i++){const n=e*(t-1)+i,r=a-2,l=e*(t-1)+(i+1)%e;this.setFaceVertexIndices(s++,n,r,l)}}const n=this.getVertexAttribute("normals");s=0;for(let i=0;i<t-1;i++)for(let t=0;t<e;t++){let i=t/e*2*Math.PI;const a=new g(Math.sin(i),Math.cos(i),0);n.setFaceVertexValue(s,0,a),n.setFaceVertexValue(s,1,a),i=(t+1)/e*2*Math.PI;const r=new g(Math.sin(i),Math.cos(i),0);n.setFaceVertexValue(s,2,r),n.setFaceVertexValue(s,3,r),s++}if(i){const t=new g(0,0,-1);for(let i=0;i<e;i++)n.setFaceVertexValue(s,0,t),n.setFaceVertexValue(s,1,t),n.setFaceVertexValue(s,2,t),s++;t.set(0,0,1);for(let i=0;i<e;i++)n.setFaceVertexValue(s,0,t),n.setFaceVertexValue(s,1,t),n.setFaceVertexValue(s,2,t),s++}const r=this.getVertexAttribute("texCoords");s=0;for(let t=0;t<e;t++)r.setFaceVertexValue(s,0,new p((t+1)/e,0)),r.setFaceVertexValue(s,2,new p((t+1)/e,1)),r.setFaceVertexValue(s,1,new p(t/e,0)),r.setFaceVertexValue(s,3,new p(t/e,1)),s++;if(i){for(let t=0;t<e;t++)r.setFaceVertexValue(s,0,new p(t/e,0)),r.setFaceVertexValue(s,1,new p((t+1)/e,0)),r.setFaceVertexValue(s,2,new p((t+.5)/e,1)),s++;for(let t=0;t<e;t++)r.setFaceVertexValue(s,0,new p(t/e,0)),r.setFaceVertexValue(s,1,new p((t+1)/e,0)),r.setFaceVertexValue(s,2,new p((t+.5)/e,1)),s++}this.geomDataTopologyChanged.emit(),this.__resize()}__resize(){const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),i=this.__radiusParam.getValue(),a=this.__heightParam.getValue(),s=this.__capsParam.getValue(),n=this.__baseZAtZeroParam.getValue();let r=e*t;s&&(r+=2);let l=0,o=.5;n&&(o=0);for(let s=0;s<t;s++){const n=s/(t-1)*a-a*o;for(let t=0;t<e;t++){const a=t/e*2*Math.PI;this.getVertex(l).set(Math.sin(a)*i,Math.cos(a)*i,n),l++}}s&&(this.getVertex(r-1).set(0,0,a*(n?0:-.5)),this.getVertex(r-2).set(0,0,a*(n?1:.5))),this.setBoundingBoxDirty(),this.geomDataChanged.emit()}}z.registerClass("Cylinder",Tt);class Mt extends Zt{constructor(e=.5,t=32){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new oe("radius",e)),this.__sidesParam=this.addParameter(new oe("sides",t>=3?t:3,[3,200],1)),this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild()}get radius(){return this.__radius}set radius(e){this.__radius=e,this.__resize()}set sides(e){this.__sides=e>=3?e:3,this.__rebuild()}__rebuild(){const e=this.__sidesParam.getValue();this.setNumVertices(e+1),this.setFaceCounts([e]),this.getVertex(0).set(0,0,0);for(let t=0;t<e;t++){const i=t%e+1,a=(t+1)%e+1;this.setFaceVertexIndices(t,0,i,a)}const t=this.getVertexAttribute("normals"),i=new g(0,0,1);t.setValue(0,i);for(let a=0;a<e;a++)t.setValue(a+1,i);const a=this.getVertexAttribute("texCoords");a.getValueRef(0).set(.5,.5);for(let t=0;t<e;t++){const i=t/e*2*Math.PI;a.getValueRef(t+1).set(.5*Math.sin(i)+.5,.5*Math.cos(i)+.5)}this.setBoundingBoxDirty(),this.__resize()}__resize(){const e=this.__sidesParam.getValue(),t=this.__radiusParam.getValue();for(let i=0;i<e;i++){const a=i/e*2*Math.PI;this.getVertex(i+1).set(Math.sin(a)*t,Math.cos(a)*t,0)}this.setBoundingBoxDirty()}toJSON(){const e=super.toJSON();return e.radius=this.__radius,e}}z.registerClass("Disc",Mt);class Ct extends Zt{constructor(e=1,t=1,i=1,a=1,s=!0,n=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(a))throw new Error("Invalid geom args");this.__sizeXParam=this.addParameter(new oe("SizeX",e)),this.__sizeYParam=this.addParameter(new oe("SizeY",t)),this.__detailXParam=this.addParameter(new oe("DetailX",i)),this.__detailYParam=this.addParameter(new oe("DetailY",a)),s&&this.addVertexAttribute("normals",g),n&&this.addVertexAttribute("texCoords",p),this.__rebuild(),this.__sizeXParam.valueChanged.connect(this.__resize.bind(this)),this.__sizeYParam.valueChanged.connect(this.__resize.bind(this)),this.__detailXParam.valueChanged.connect(this.__rebuild.bind(this)),this.__detailYParam.valueChanged.connect(this.__rebuild.bind(this))}__rebuild(){const e=this.__detailXParam.getValue(),t=this.__detailYParam.getValue();this.setNumVertices((e+1)*(t+1)),this.setFaceCounts([0,e*t]);let i=0;for(let a=0;a<t;a++)for(let t=0;t<e;t++){const s=(e+1)*(a+1)+t,n=(e+1)*(a+1)+(t+1),r=(e+1)*a+(t+1),l=(e+1)*a+t;this.setFaceVertexIndices(i,s,n,r,l),i+=1}let a=0;const s=this.getVertexAttribute("normals");if(s)for(let i=0;i<=t;i++)for(let t=0;t<=e;t++)s.getValueRef(a).set(0,0,1),a++;a=0;const n=this.getVertexAttribute("texCoords");if(n)for(let i=0;i<=t;i++){const s=i/t;for(let t=0;t<=e;t++){const i=t/e;n.getValueRef(a).set(i,s),a++}}this.__resize(!1),this.geomDataTopologyChanged.emit()}__resize(e=!0){const t=this.__sizeXParam.getValue(),i=this.__sizeYParam.getValue(),a=this.__detailXParam.getValue(),s=this.__detailYParam.getValue();let n=0;for(let e=0;e<=s;e++){const r=(e/s-.5)*i;for(let e=0;e<=a;e++){const i=(e/a-.5)*t;this.getVertex(n).set(i,r,0),n++}}this.setBoundingBoxDirty(),e&&this.geomDataChanged.emit()}}class Ft extends Zt{constructor(e=1,t=12,i=12){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new oe("radius",e)),this.__sidesParam=this.addParameter(new oe("sides",t>=3?t:3,[3,200],1)),this.__loopsParam=this.addParameter(new oe("loops",i>=3?i:3,[3,200],1)),this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild();const a=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(()=>{this.__resize()}),this.__sidesParam.valueChanged.connect(a),this.__loopsParam.valueChanged.connect(a)}__rebuild(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue(),a=2+t*i,s=2*t,n=t*i;this.setNumVertices(a),this.setFaceCounts([s,n]);const r=this.getVertexAttribute("normals"),l=new g(0,0,1);let o=0;this.getVertex(o).set(0,0,e),r.getValueRef(o).set(0,0,1),o++;for(let a=0;a<i;a++){const s=(a+1)/(i+1)*Math.PI;for(let i=0;i<t;i++){const a=i/t*2*Math.PI;l.set(Math.sin(s)*Math.cos(a),Math.sin(s)*Math.sin(a),Math.cos(s)),this.getVertex(o).setFromOther(l.scale(e)),r.getValueRef(o).setFromOther(l),o++}}this.getVertex(o).set(0,0,-e),r.getValueRef(o).set(0,0,-1),o++;const d=this.getVertexAttribute("texCoords");let h=0;for(let e=0;e<t;e++){const a=0,s=(e+1)%t+1,n=e+1;this.setFaceVertexIndices(h,a,s,n);const r=new p(.5,0),l=new p(1-(e+1)/t,0),o=new p(1-e/t,1/(i+1));d.setFaceVertexValue(h,0,r),d.setFaceVertexValue(h,1,l),d.setFaceVertexValue(h,2,o),h++}for(let e=0;e<t;e++){const s=a-1,n=t*(i-1)+e+1,r=t*(i-1)+(e+1)%t+1;this.setFaceVertexIndices(h,s,n,r);const l=new p(1-e/t,i/(i+1)),o=new p(1-(e+1)/t,i/(i+1)),c=new p(.5,1);d.setFaceVertexValue(h,0,l),d.setFaceVertexValue(h,1,o),d.setFaceVertexValue(h,2,c),h++}for(let e=0;e<i-1;e++)for(let a=0;a<t;a++){const s=t*e+a+1,n=t*e+(a+1)%t+1,r=t*(e+1)+(a+1)%t+1,l=t*(e+1)+a+1;this.setFaceVertexIndices(h,s,n,r,l),d.setFaceVertexValue(h,0,new p(e/i,a/i)),d.setFaceVertexValue(h,1,new p(e/i,(a+1)/i)),d.setFaceVertexValue(h,2,new p((e+1)/i,(a+1)/i)),d.setFaceVertexValue(h,3,new p((e+1)/i,a/i)),h++}this.setBoundingBoxDirty(),this.geomDataTopologyChanged.emit()}__resize(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue();let a=0;const s=new g(0,0,1);this.getVertex(a).set(0,0,e),a++;for(let n=0;n<i;n++){const r=(n+1)/(i+1)*Math.PI;for(let i=0;i<t;i++){const n=i/t*2*Math.PI;s.set(Math.sin(r)*Math.cos(n),Math.sin(r)*Math.sin(n),Math.cos(r)),this.getVertex(a).setFromOther(s.scale(e)),a++}}this.getVertex(a).set(0,0,-e),a++,this.setBoundingBoxDirty(),this.geomDataChanged.emit()}}z.registerClass("Sphere",Ft);class wt extends Zt{constructor(e=.5,t=1,i=32){if(super(),isNaN(e)||isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__innerRadius=e,this.__outerRadius=t,this.__detail=i>=3?i:3,this.addVertexAttribute("texCoords",p),this.addVertexAttribute("normals",g),this.__rebuild()}get innerRadius(){return this.__innerRadius}set innerRadius(e){this.__innerRadius=e,this.__resize()}get outerRadius(){return this.__outerRadius}set outerRadius(e){this.__outerRadius=e,this.__resize()}get detail(){return this.__detail}set detail(e){this.__detail=e>=3?e:3,this.__rebuild()}__rebuild(){const e=this.__detail,t=2*this.__detail,i=e*t;this.setNumVertices(i),this.setFaceCounts([0,e*t]);const a=this.getVertexAttribute("normals");let s=0;for(let i=0;i<t;i++){const n=i/t*2*Math.PI,r=Math.cos(n),l=Math.sin(n);for(let t=0;t<e;t++){const i=t/e*2*Math.PI,n=Math.sin(i),o=Math.cos(i),d=this.__outerRadius+o*this.__innerRadius;this.getVertex(s).set(r*d,l*d,this.__innerRadius*n),a.getValueRef(s).set(r*o,l*o,n),s++}}const n=this.getVertexAttribute("texCoords");let r=0;for(let i=0;i<t;i++)for(let a=0;a<e;a++){const s=(i+1)%t,l=(a+1)%e,o=e*i+a,d=e*i+l,h=e*s+l,c=e*s+a;this.setFaceVertexIndices(r,o,d,h,c),n.setFaceVertexValue(r,0,new p(i/t,a/t)),n.setFaceVertexValue(r,1,new p(i/t,(a+1)/t)),n.setFaceVertexValue(r,2,new p((i+1)/t,(a+1)/t)),n.setFaceVertexValue(r,3,new p((i+1)/t,a/t)),r++}this.setBoundingBoxDirty()}__resize(){const e=this.__detail,t=2*this.__detail;for(let i=0;i<t;i++){const a=i/t*2*Math.PI,s=Math.cos(a),n=Math.sin(a);for(let t=0;t<e;t++){const i=t/e*2*Math.PI,a=Math.sin(i),r=Math.cos(i),l=this.__outerRadius+r*this.__innerRadius;this.getVertex(0).set(s*l,n*l,this.__innerRadius*a),index++}}this.setBoundingBoxDirty()}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.z=this.__z,e}}const Nt={SAVE_FLAG_SKIP_CHILDREN:1},Yt={LOAD_FLAG_LOADING_BIN_TREE_VALUES:16},Kt={CLONE_FLAG_INSTANCED_TREE:1};class zt extends A{constructor(e){super(e),this.__visibleCounter=1,this.__visible=!0,this.__highlightMapping={},this.__highlights=[],this.__childItems=[],this.__childItemsSignalIds=[],this.__childItemsMapping={},this.mouseDown=new M,this.mouseUp=new M,this.mouseMove=new M,this.mouseEnter=new M,this.mouseLeave=new M,this.__visibleParam=this.addParameter(new he("Visible",!0)),this.__localXfoParam=this.addParameter(new _e("LocalXfo",new R)),this.__globalXfoParam=this.addParameter(new _e("GlobalXfo",new R)),this.__boundingBoxParam=this.addParameter(new H("BoundingBox",new W)),this.parentChanged=this.ownerChanged,this.childAdded=new M,this.childRemoved=new M,this.highlightChanged=new M,this.visibilityChanged=new M,this.localXfoChanged=this.__localXfoParam.valueChanged,this.globalXfoChanged=this.__globalXfoParam.valueChanged,this.boundingChanged=this.__boundingBoxParam.valueChanged,this._cleanGlobalXfo=this._cleanGlobalXfo.bind(this),this._setGlobalXfoDirty=this._setGlobalXfoDirty.bind(this),this._setBoundingBoxDirty=this._setBoundingBoxDirty.bind(this),this._cleanBoundingBox=this._cleanBoundingBox.bind(this),this.__localXfoParam.valueChanged.connect(this._setGlobalXfoDirty);const t=e=>{const t=this.__globalXfoParam.getValue();return void 0!==this.__ownerItem?this.__ownerItem.getGlobalXfo().inverse().multiply(t):t};this.__globalXfoParam.valueChanged.connect(e=>{e!=P.OPERATOR_DIRTIED&&this.__localXfoParam.setDirty(t),this._setBoundingBoxDirty()}),this.__visibleParam.valueChanged.connect(e=>{this.__visibleCounter+=this.__visibleParam.getValue()?1:-1,this.__updateVisiblity()})}static get SaveFlags(){return Nt}static get LoadFlags(){return Yt}static get CloneFlags(){return Kt}static getSelectionOutlineColor(){return selectionOutlineColor}static setSelectionOutlineColor(e){selectionOutlineColor=e}static getBranchSelectionOutlineColor(){return branchSelectionOutlineColor}static setBranchSelectionOutlineColor(e){branchSelectionOutlineColor=e}_childFlagsChanged(e){0!=(e&E.USER_EDITED)&&this.setFlag(D.USER_EDITED)}setFlag(e){super.setFlag(e),this.__ownerItem&&this.__ownerItem._childFlagsChanged(e)}setOwner(e){if(this.__ownerItem){this.__ownerItem.globalXfoChanged.disconnect(this._setGlobalXfoDirty),this.__ownerItem.getVisible()||this.__visibleCounter++;const e=this.__ownerItem.getChildIndex(this);e>=0&&this.__ownerItem.__unbindChild(e,this)}super.setOwner(e),this._setGlobalXfoDirty(),this.__ownerItem&&(this.setSelectable(this.__ownerItem.getSelectable(),!0),this.__ownerItem.getVisible()||this.__visibleCounter--,this.__ownerItem.globalXfoChanged.connect(this._setGlobalXfoDirty)),this.__updateVisiblity()}__updatePath(){super.__updatePath();for(const e of this.__childItems)e&&e.__updatePath()}getParentItem(){return this.getOwner()}setParentItem(e){this.setOwner(e)}getLocalXfo(){return this.__localXfoParam.getValue()}setLocalXfo(e,t){this.__localXfoParam.setValue(e,t)}getGlobalXfo(e){return this.__globalXfoParam.getValue(e)}setGlobalXfo(e,t){const i=this.getOwner();if(i){const a=i.getGlobalXfo().inverse().multiply(e);this.__localXfoParam.setValue(a,t)}else this.__globalXfoParam.setValue(e,t)}_cleanGlobalXfo(e){const t=this.getParentItem(),i=this.__localXfoParam.getValue();return void 0!==t?t.getGlobalXfo().multiply(i):i}_setGlobalXfoDirty(){this.__globalXfoParam.setDirty(this._cleanGlobalXfo)}getVisible(){return this.__visibleCounter>0}setVisible(e){this.__visibleParam.setValue(e)}propagateVisiblity(e){this.__visibleCounter+=e,this.__updateVisiblity()}__updateVisiblity(){const e=this.__visibleCounter>0;if(e!=this.__visible){this.__visible=e;for(const e of this.__childItems)e instanceof zt&&e.propagateVisiblity(this.__visible?1:-1);return this.visibilityChanged.emit(e),!0}return!1}addHighlight(e,t,i=!1){if(e in this.__highlightMapping){const t=this.__highlights.indexOf(e);this.__highlights.splice(t,1)}this.__highlights.push(e),this.__highlightMapping[e]=t,this.highlightChanged.emit(),i&&this.__childItems.forEach(a=>{a instanceof zt&&a.addHighlight(e,t,i)})}removeHighlight(e,t=!1){if(e in this.__highlightMapping){const t=this.__highlights.indexOf(e);this.__highlights.splice(t,1),delete this.__highlightMapping[e],this.highlightChanged.emit()}t&&this.__childItems.forEach(i=>{i instanceof zt&&i.removeHighlight(e,t)})}getHighlight(){if(this.__highlights.length>0)return this.__highlightMapping[this.__highlights[this.__highlights.length-1]]}isHighlighted(){return this.__highlights.length>0}get boundingBox(){return console.warn("getter is deprectated. Please use 'getBoundingBox'"),this.getBoundingBox()}getBoundingBox(){return this.__boundingBoxParam.getValue()}_cleanBoundingBox(e){return e.reset(),this.__childItems.forEach(t=>{t instanceof zt&&t.getVisible()&&!t.testFlag(D.IGNORE_BBOX)&&e.addBox3(t.getBoundingBox())}),e}_childBBoxChanged(){this._setBoundingBoxDirty()}_setBoundingBoxDirty(){this.__boundingBoxParam&&this.__boundingBoxParam.setDirty(this._cleanBoundingBox)}getChildren(){return this.__childItems}numChildren(){return console.warn("Deprecated method. Please use getNumChildren"),this.__childItems.length}getNumChildren(){return this.__childItems.length}generateUniqueName(e){if(!(e in this.__childItemsMapping))return e;let t=1;e.length>4&&!Number.isNaN(parseInt(e.substring(e.length-4)))?t=parseInt(e.substr(e.length-4)):e.length>3&&!Number.isNaN(parseInt(e.substring(e.length-3)))?t=parseInt(e.substr(e.length-3)):e.length>2&&!Number.isNaN(parseInt(e.substring(e.length-2)))&&(t=parseInt(e.substr(e.length-2)));const i=[];for(const e of this.__childItems)e&&i.push(e.getName());let a=e;for(;;){let s=""+t;for(;s.length<2;)s="0"+s;if(a=e+s,-1==i.indexOf(a))break;t++}return a}__updateMapping(e){for(let t=e;t<this.__childItems.length;t++)this.__childItemsMapping[this.__childItems[t].getName()]=t}insertChild(e,t,i=!1,a=!0){if(e.getName()in this.__childItemsMapping){if(!a)throw new Error("Item '"+e.getName()+"' is already a child of :"+this.getPath());e.setName(this.generateUniqueName(e.getName()))}if(!(e instanceof A))throw new Error("Object is is not a tree item :"+e.constructor.name);const s={};let n;return s.nameChangedId=e.nameChanged.connect((e,t)=>{const i=this.__childItemsMapping[t];delete this.__childItemsMapping[t],this.__childItemsMapping[e]=i}),e instanceof zt&&(i&&(n=this.getGlobalXfo().inverse().multiply(e.getGlobalXfo())),s.bboxChangedId=e.boundingChanged.connect(()=>{this._setBoundingBoxDirty()}),s.visChangedId=e.visibilityChanged.connect(this._setBoundingBoxDirty)),this.__childItems.splice(t,0,e),this.__childItemsSignalIds.splice(t,0,s),this.__childItemsMapping[e.getName()]=t,this.__updateMapping(t),e.setOwner(this),e instanceof zt&&(i&&e.setLocalXfo(n),this._setBoundingBoxDirty()),e.testFlag(D.USER_EDITED)&&this.setFlag(D.USER_EDITED),this.childAdded.emit(e,t),e}addChild(e,t=!0,i=!0){const a=this.__childItems.length;return this.insertChild(e,a,t,i),a}getChild(e){return this.__childItems[e]}getChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.__childItems[t]:null}getChildNames(){const e=[];for(let t=0;t<this.__childItems.length;t++){const i=this.__childItems[t];null!=i&&(e[t]=i.getName())}return e}__unbindChild(e,t){const i=this.__childItemsSignalIds[e];t.nameChanged.disconnectId(i.nameChangedId),t instanceof zt&&(t.boundingChanged.disconnectId(i.bboxChangedId),t.visibilityChanged.disconnectId(i.visChangedId)),this.__childItems.splice(e,1),this.__childItemsSignalIds.splice(e,1),delete this.__childItemsMapping[t.getName()],this.__updateMapping(e),t instanceof zt&&this._setBoundingBoxDirty(),this.childRemoved.emit(t,e)}removeChild(e){const t=this.__childItems[e];t&&(this.__unbindChild(e,t),t.setOwner(void 0))}removeChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.removeChild(t):null}removeChildByHandle(e){console.warn("Deprecated method. Please use removeChild");const t=this.__childItems.indexOf(e);if(-1==t)throw new Error("Error in removeChildByHandle. Child not found:"+e.getName());this.removeChild(t)}removeAllChildren(){let e=this.__childItems.length;for(;e--;)this.removeChild(e);this._setBoundingBoxDirty()}getChildIndex(e){return this.__childItems.indexOf(e)}indexOfChild(e){return console.warn("Deprecated method. Please use getChildIndex"),this.getChildIndex(e)}resolvePath(e,t=0){if("string"==typeof e&&(e=e.split("/")),0==t)if("."==e[0]||e[0]==this.__name)t++;else if(".."==e[0])return this.__ownerItem.resolvePath(e,t+1);if(t==e.length)return this;const i=e[t],a=this.getChildByName(i);if(null==a){return this.getParameter(e[t])||null}return a.resolvePath(e,t+1)}traverse(e,t=!0){const i=(e,t)=>{const i=e.getChildren();for(const e of i)e&&a(e,t+1)},a=(t,a)=>{if(0==e(t,a))return!1;i(t,a)};t?a(this,1):i(this,0)}onMouseDown(e){this.mouseDown.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseDown(e)}onMouseUp(e){this.mouseUp.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseUp(e)}onMouseMove(e){this.mouseMove.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseMove(e)}onMouseEnter(e){this.mouseEnter.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseEnter(e)}onMouseLeave(e){this.mouseLeave.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseLeave(e)}onWheel(e){e.propagating&&this.__ownerItem&&this.__ownerItem.onWheel(e)}toJSON(e,t){if(!this.testFlag(D.USER_EDITED))return;const i=super.toJSON(e,t);if(!(t&Nt.SAVE_FLAG_SKIP_CHILDREN)){const a={};for(const i of this.__childItems)if(i){const s=i.toJSON(e,t);s&&(a[i.getName()]=s)}Object.keys(a).length>0&&(i?i.children=a:i={name:this.__name,children:a})}return i}fromJSON(e,t,i){if(super.fromJSON(e,t,i),t.numTreeItems++,this.setFlag(D.USER_EDITED),null!=e.children){const a=e.children;if(Array.isArray(a))for(const e of a){let a=this.getChildByName(e.name);a?a.fromJSON(e,t,i):e.type&&(a=z.constructClass(e.type),a&&(a.fromJSON(e,t,i),this.addChild(a,!1,!1)))}else for(const e in a){const s=a[e];let n=this.getChildByName(e);n?n.fromJSON(s,t,i):s.type&&(n=z.constructClass(s.type),n&&(n.fromJSON(s,t,i),this.addChild(n,!1,!1)))}}}readBinary(e,t){super.readBinary(e,t),t.numTreeItems++;const i=e.loadUInt8();if(4&i){const t=new R;t.tr=e.loadFloat32Vec3(),t.ori=e.loadFloat32Quat(),t.sc.set(e.loadFloat32()),this.__localXfoParam.setValue(t,P.DATA_LOAD)}8&i&&this.__boundingBoxParam.setValue(new W(e.loadFloat32Vec3(),e.loadFloat32Vec3()),P.DATA_LOAD);const a=e.loadUInt32();if(a>0){const i=e.loadUInt32Array(a);for(let s=0;s<a;s++){e.seek(i[s]);let a=e.loadStr();if(a.startsWith("N")&&a.endsWith("E")){const e=a.indexOf("podium");-1!=e&&(a=parseInt(a[e+7])?a.substring(e+8,a.length-1):a.substring(e+7,a.length-1)),-1!=a.indexOf("livenurbs")&&(a=a.substring(a.indexOf("CAD"),a.length-1))}const n=z.constructClass(a);if(n)e.seek(i[s]),n.readBinary(e,t),n.setFlag(D.BIN_NODE),this.addChild(n,!1,!1);else{const t=e.loadStr();console.warn("Unable to construct child:"+t+" of type:"+a)}}}}clone(e){const t=new zt;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t),e.getChildren().forEach(e=>{e&&this.addChild(e.clone(t),!1,!1)})}destroy(){this.removeAllChildren(),super.destroy()}}z.registerClass("TreeItem",zt);class Ut extends zt{constructor(e){super(e)}setSrcTree(e,t){if(this.__srcTree=e,0==this.__srcTree.getNumChildren()){const e=this.__srcTree.clone(t);e.setLocalXfo(new R,P.DATA_LOAD),this.addChild(e,!1)}else this.__srcTree.getChildren().forEach(e=>{const i=e.clone(t);this.addChild(i,!1)})}getSrcTree(){return this.__srcTree}readBinary(e,t={}){super.readBinary(e,t);const i=e.loadStrArray();t.resolvePath(i,e=>{this.setSrcTree(e,t)})}toJSON(e={},t=0){return super.toJSON(e,t)}fromJSON(e,t={},i=0,a){}}z.registerClass("InstanceItem",Ut);class Pt extends zt{constructor(e){super(e),this.__loaded=!1,this.audioSourceCreated=new M;const t=this.addParameter(new ye("FilePath"));let i,a;const s=()=>{i=window.ZeaAudioaudioCtx.createBufferSource(),i.buffer=a,i.loop=o.getValue(),i.muted=l.getValue(),i.start(0),this.audioSourceCreated.emit(i)};t.valueChanged.connect(()=>{const e=new XMLHttpRequest;e.open("GET",t.getURL(),!0),e.responseType="arraybuffer",e.onload=()=>{const t=e.response;window.ZeaAudioaudioCtx.decodeAudioData(t,e=>{a=e,this.__loaded=!0,this.loaded.emit(!0),n.getValue()&&s()},e=>{console.log("Error with decoding audio data"+e.err)})},e.send()});const n=this.addParameter(new he("Autoplay",!1)),r=this.addParameter(new oe("PlayState",0));r.valueChanged.connect(e=>{if(e!=P.CUSTOM)switch(r.getValue()){case 0:this.__loaded&&i&&(i.stop(0),i=void 0);break;case 1:this.__loaded&&s()}}),this.isPlaying=()=>0!=r.getValue(),this.play=()=>{r.setValue(1,P.CUSTOM)},this.stop=()=>{r.setValue(0,P.CUSTOM)},this.pause=()=>{r.setValue(0,P.CUSTOM)},this.getAudioSource=()=>i;const l=this.addParameter(new he("Mute",!1));this.addParameter(new oe("Gain",1)).setRange([0,5]);const o=this.addParameter(new he("Loop",!1));this.addParameter(new he("SpatializeAudio",!0)),this.addParameter(new oe("refDistance",2)),this.addParameter(new oe("maxDistance",1e4)),this.addParameter(new oe("rolloffFactor",1)),this.addParameter(new oe("coneInnerAngle",360)),this.addParameter(new oe("coneOuterAngle",0)),this.addParameter(new oe("coneOuterGain",1)),l.valueChanged.connect(()=>{i&&(i.muted=l.getValue())}),o.valueChanged.connect(()=>{i&&(i.loop=o.getValue())}),this.mute=e=>{l.setValue(e,P.CUSTOM)},this.loaded=new M(!0),this.loaded.setToggled(!1)}isLoaded(){return this.__loaded}setAudioStream(){this.__loaded=!0,this.loaded.emit(),this.audioSourceCreated.emit(audioSource)}}class Et extends zt{constructor(e){super(e),this.overlay=!1,this.__cutAway=!1,this.__cutAwayVector=!1,this.__cutAwayDist=!1,this.cutAwayChanged=new M,this.__layers=[]}setOverlay(e){this.overlay=e}isOverlay(){return this.overlay}addLayer(e){this.__layers.push(e)}getLayers(){return this.__layers}isCutawayEnabled(){return this.__cutAway}setCutawayEnabled(e){this.__cutAway=e,this.cutAwayChanged.emit()}getCutVector(){return this.__cutAwayVector}setCutVector(e){this.__cutAwayVector=e,this.cutAwayChanged.emit()}getCutDist(){return this.__cutAwayDist}setCutDist(e){this.__cutAwayDist=e,this.cutAwayChanged.emit()}readBinary(e,t){if(super.readBinary(e,t),t.versions["zea-engine"].greaterOrEqualThan([0,0,4])){const i=e.loadStr();let a=t.assetItem.getMaterialLibrary().getMaterial(i,!1);if(a||(a=new Me(i,"SimpleSurfaceShader"),a.getParameter("BaseColor").setValue(Z.random(.25),P.DATA_LOAD),t.assetItem.getMaterialLibrary().addMaterial(a)),this.setMaterial(a,P.DATA_LOAD),this.__layers=e.loadStrArray(),this.__layers.length>0)for(const e of this.__layers)t.addGeomToLayer(this,e)}}}class Jt extends Et{constructor(e,t,i){super(e),this.__geomParam=this.insertParameter(new Se("Geometry"),0),this.__geomParam.valueChanged.connect(this._setBoundingBoxDirty.bind(this)),this.__geomParam.boundingBoxDirtied.connect(this._setBoundingBoxDirty.bind(this)),this.__materialParam=this.insertParameter(new ut("Material"),1),this.__paramMapping.material=this.getParameterIndex(this.__materialParam),this.__lightmapCoordOffset=new p,this.__geomOffsetXfoParam=this.addParameter(new _e("GeomOffsetXfo")),this.__geomMatParam=this.addParameter(new ge("GeomMat")),this.__cleanGeomMat=this.__cleanGeomMat.bind(this),this.__globalXfoParam.valueChanged.connect(e=>{this.__geomMatParam.setDirty(this.__cleanGeomMat)}),this.__geomOffsetXfoParam.valueChanged.connect(e=>{this.__geomMatParam.setDirty(this.__cleanGeomMat)}),this.geomXfoChanged=this.__geomMatParam.valueChanged,this.materialAssigned=this.__materialParam.valueChanged,this.geomAssigned=this.__geomParam.valueChanged,t&&this.setGeometry(t,P.DATA_LOAD),i&&this.setMaterial(i,P.DATA_LOAD)}__cleanGeomMat(){const e=this.__globalXfoParam.getValue().toMat4(),t=this.__geomOffsetXfoParam.getValue().toMat4();return e.multiply(t)}getGeometry(){return this.__geomParam.getValue()}setGeometry(e,t){this.__geomParam.setValue(e,t)}getGeom(){return console.warn("getGeom is deprectated. Please use 'getGeometry'"),this.getGeometry()}setGeom(e){return console.warn("setGeom is deprectated. Please use 'setGeometry'"),this.setGeometry(e)}getMaterial(){return this.__materialParam.getValue()}setMaterial(e,t){this.__materialParam.setValue(e,t)}_cleanBoundingBox(e){e=super._cleanBoundingBox(e);const t=this.getGeometry();return t&&e.addBox3(t.boundingBox,this.getGeomMat4()),e}getGeomOffsetXfo(){return this.__geomOffsetXfoParam.getValue()}setGeomOffsetXfo(e){this.__geomOffsetXfoParam.setValue(e)}getGeomMat4(){return this.__geomMatParam.getValue()}getLightmapName(){return this.__lightmapName}getLightmapCoordsOffset(){return this.__lightmapCoordOffset}applyAssetLightmapSettings(e,t){this.__lightmap=e,this.__lightmapCoordOffset.addInPlace(t)}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t){super.fromJSON(e,t),t.numGeomItems++}readBinary(e,t){super.readBinary(e,t),t.numGeomItems++,this.__lightmapName=t.assetItem.getName();const i=e.loadUInt8(),a=e.loadUInt32(),s=t.assetItem.getGeometryLibrary(),n=s.getGeom(a);if(n)this.setGeometry(n,P.DATA_LOAD);else{this.geomIndex=a;const e=e=>{if(a>=e[0]&&a<e[1]){const e=s.getGeom(a);e?this.setGeometry(e,P.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),s.rangeLoaded.disconnectId(t)}},t=s.rangeLoaded.connect(e)}if(4&i&&this.__geomOffsetXfoParam.setValue(new R(e.loadFloat32Vec3(),e.loadFloat32Quat(),e.loadFloat32Vec3())),t.versions["zea-engine"].lessThan([0,0,4]))if(8&i){const i=t.assetItem.getMaterialLibrary(),a=e.loadStr();let s=i.getMaterial(a);s||(console.warn("Geom :'"+this.name+"' Material not found:"+a),s=i.getMaterial("Default")),this.setMaterial(s,P.DATA_LOAD)}else this.setMaterial(t.assetItem.getMaterialLibrary().getMaterial("Default"),P.DATA_LOAD);this.__lightmapCoordOffset=e.loadFloat32Vec2()}toString(){return JSON.stringify(this.toJSON(),null,2)}clone(e){const t=new Jt;return t.copyFrom(this,e),t}copyFrom(e,t){if(super.copyFrom(e,t),this.__lightmapCoordOffset=e.__lightmapCoordOffset,!e.getGeometry()&&-1!=e.geomIndex){const i=t.assetItem.getGeometryLibrary(),a=e.geomIndex,s=e=>{if(a>=e[0]&&a<e[1]){const e=i.getGeom(a);e?this.setGeometry(e,P.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),i.rangeLoaded.disconnectId(n)}},n=i.rangeLoaded.connect(s)}this.__geomMatParam.setDirty(this.__cleanGeomMat)}destroy(){super.destroy()}}z.registerClass("GeomItem",Jt);const Ht={manual:0,first:1,average:2,globalOri:3};class kt extends zt{constructor(e){super(e),this.setFlag(D.USER_EDITED),this.calculatingGroupXfo=!1,this.dirty=!1,this.invGroupXfo=void 0,this.__initialXfos=[],this.__signalIndices=[];let t=0;this.__itemsParam=this.insertParameter(new Re("Items",e=>e instanceof zt),t++),this.__itemsParam.itemAdded.connect((e,t)=>{this.__bindItem(e,t)}),this.__itemsParam.itemRemoved.connect((e,t)=>{this.__unbindItem(e,t)}),this.__itemsParam.valueChanged.connect(()=>{this.calcGroupXfo(),this._setBoundingBoxDirty()}),this.__initialXfoModeParam=this.insertParameter(new de("InitialXfoMode",Ht.average,["manual","first","average","global"]),t++),this.__initialXfoModeParam.valueChanged.connect(()=>{this.calcGroupXfo()}),this.__highlightedParam=this.insertParameter(new he("Highlighted",!1),t++),this.__highlightedParam.valueChanged.connect(()=>{this.__updateHighlight()}),this.__updateHighlight=this.__updateHighlight.bind(this),this.insertParameter(new be("HighlightColor",new Z(.5,.5,1)),t++).valueChanged.connect(this.__updateHighlight),this.insertParameter(new oe("HighlightFill",0,[0,1]),t++).valueChanged.connect(this.__updateHighlight),this.__materialParam=this.insertParameter(new ut("Material"),t++),this.__materialParam.valueChanged.connect(()=>{this.__updateMaterial()}),this.__updateCutaway=this.__updateCutaway.bind(this),this.insertParameter(new he("CutAwayEnabled",!1),t++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new me("CutVector",new g(1,0,0)),t++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new oe("CutDist",0),t++).valueChanged.connect(this.__updateCutaway),this.__globalXfoParam.valueChanged.connect(e=>{this.calculatingGroupXfo||this._propagateDirtyXfoToItems()})}static get INITIAL_XFO_MODES(){return Ht}__updateVisiblity(){if(super.__updateVisiblity()){const e=this.getVisible();return Array.from(this.__itemsParam.getValue()).forEach(t=>{t instanceof zt&&t.propagateVisiblity(e?1:-1)}),!0}return!1}__updateHighlight(){let e,t=!1;(this.getParameter("Highlighted").getValue()||this.isSelected())&&(t=!0,e=this.getParameter("HighlightColor").getValue(),e.a=this.getParameter("HighlightFill").getValue());const i="groupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach(a=>{a instanceof zt&&(t?a.addHighlight(i,e,!0):a.removeHighlight(i,!0))})}setSelected(e){super.setSelected(e),this.__updateHighlight()}_setGlobalXfoDirty(){super._setGlobalXfoDirty()}calcGroupXfo(){const e=Array.from(this.__itemsParam.getValue());if(0==e.length)return new R;this.calculatingGroupXfo=!0;const t=this.__initialXfoModeParam.getValue();let i;if(t==Ht.manual)return this.invGroupXfo=this.getGlobalXfo().inverse(),void(this.calculatingGroupXfo=!1);if(t==Ht.first)i=this.__initialXfos[0];else if(t==Ht.average){i=new R,i.ori.set(0,0,0,0);let t=0;e.forEach((e,a)=>{e instanceof zt&&(i.tr.addInPlace(this.__initialXfos[a].tr),i.ori.addInPlace(this.__initialXfos[a].ori),t++)}),i.tr.scaleInPlace(1/t),i.ori.normalizeInPlace()}else{if(t!=Ht.globalOri)throw new Error("Invalid mode.");{i=new R;let t=0;e.forEach((e,a)=>{e instanceof zt&&(i.tr.addInPlace(this.__initialXfos[a].tr),t++)}),i.tr.scaleInPlace(1/t)}}this.setGlobalXfo(i,P.GENERATED_VALUE);const a=this.getGlobalXfo();this.invGroupXfo=a.inverse(),this.calculatingGroupXfo=!1}_propagateDirtyXfoToItems(){if(this.calculatingGroupXfo)return;const e=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&e.length>0&&this.invGroupXfo&&!this.dirty){let t;this.dirty=!0,this.propagatingXfoToItems=!0;const i=(e,i)=>{const a=e.getParameter("GlobalXfo");a.setDirty(()=>{if(!t){const e=this.__globalXfoParam.getValue();t=e.multiply(this.invGroupXfo),this.dirty=!1}const e=t.multiply(i);a.setClean(e)})};e.forEach((e,t)=>{e instanceof zt&&i(e,this.__initialXfos[t])}),this.propagatingXfoToItems=!1}}__updateMaterial(){const e=this.getParameter("Material").getValue();Array.from(this.__itemsParam.getValue()).forEach(t=>{t.traverse(t=>{if(t instanceof zt&&t.hasParameter("Material")){const i=t.getParameter("Material");if(e){const t=i.getValue();t!=e&&(i.__backupMaterial=t,i.setValue(e,P.GENERATED_VALUE))}else i.__backupMaterial&&i.setValue(i.__backupMaterial,P.GENERATED_VALUE)}},!1)})}__updateCutaway(){const e=this.getParameter("CutAwayEnabled").getValue(),t=this.getParameter("CutVector").getValue(),i=this.getParameter("CutDist").getValue();Array.from(this.__itemsParam.getValue()).forEach(a=>{a.traverse(a=>{a instanceof Et&&(a.setCutawayEnabled(e),a.setCutVector(t),a.setCutDist(i))},!0)})}setPaths(e){this.clearItems(!1);const t=this.getOwner();if(null==t)return void console.warn("Group does not have an owner and so cannot resolve paths:",this.getName());const i=[];e.forEach(e=>{const a=t.resolvePath(e);a?i.push(a):console.warn("Path does not resolve to an Item:",e," group:",this.getName())}),this.setItems(i)}resolveItems(e){this.setPaths(e)}__bindItem(e,t){if(!(e instanceof zt))return;const i={};i.mouseDownIndex=e.mouseDown.connect(e=>{this.onMouseDown(e)}),i.mouseUpIndex=e.mouseUp.connect(e=>{this.onMouseUp(e)}),i.mouseMoveIndex=e.mouseMove.connect(e=>{this.onMouseMove(e)}),i.mouseEnterIndex=e.mouseEnter.connect(e=>{this.onMouseEnter(e)}),i.mouseLeaveIndex=e.mouseLeave.connect(e=>{this.onMouseLeave(e)});const a=this.getParameter("Material").getValue();if(a&&e.traverse(e=>{if(e instanceof zt&&e.hasParameter("Material")){const t=e.getParameter("Material");if(a){const e=t.getValue();e!=a&&(t.__backupMaterial=e,t.setValue(a,P.GENERATED_VALUE))}}},!0),e instanceof zt&&this.getParameter("Highlighted").getValue()){const t=this.getParameter("HighlightColor").getValue();t.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("groupItemHighlight"+this.getId(),t,!0)}const s=this.getParameter("CutAwayEnabled").getValue();if(s){const t=this.getParameter("CutVector").getValue(),i=this.getParameter("CutDist").getValue();e.traverse(e=>{e instanceof Et&&(e.setCutawayEnabled(s),e.setCutVector(t),e.setCutDist(i))},!0)}this.getVisible()||e.propagateVisiblity(-1);const n=()=>{const e=this.__initialXfoModeParam.getValue();e==Ht.first&&0==t?this.calcGroupXfo():e!=Ht.average&&e!=Ht.globalOri||this.calcGroupXfo()};i.globalXfoChangedIndex=e.globalXfoChanged.connect(i=>{this.propagatingXfoToItems||(this.__initialXfos[t]=e.getGlobalXfo(),n())}),this.__initialXfos[t]=e.getGlobalXfo(),i.bboxChangedIndex=e.boundingChanged.connect(this._setBoundingBoxDirty),this.__signalIndices[t]=i,n()}__unbindItem(e,t){if(!(e instanceof zt))return;e.removeHighlight("branchselected"+this.getId(),!0),this.getParameter("Highlighted").getValue()&&e.removeHighlight("groupItemHighlight"+this.getId(),!0),this.getVisible()||e.propagateVisiblity(1),e.traverse(e=>{e instanceof Et&&e.setCutawayEnabled(!1)},!0);const i=this.__signalIndices[t];e.mouseDown.disconnectId(i.mouseDownIndex),e.mouseUp.disconnectId(i.mouseUpIndex),e.mouseMove.disconnectId(i.mouseMoveIndex),e.mouseEnter.disconnectId(i.mouseEnterIndex),e.mouseLeave.disconnectId(i.mouseLeaveIndex),e.globalXfoChanged.disconnectId(i.globalXfoChangedIndex),e.boundingChanged.disconnectId(i.bboxChangedIndex),this.__signalIndices.splice(t,1),this.__initialXfos.splice(t,1)}addItem(e,t=!0){e?this.__itemsParam.addItem(e,t):console.warn("Error adding item to group. Item is null")}removeItem(e,t=!0){this.__itemsParam.removeItem(e,t)}clearItems(e=!0){const t=Array.from(this.__itemsParam.getValue());for(let e=t.length-1;e>=0;e--)this.__unbindItem(t[e],e);this.__signalIndices=[],this.__initialXfos=[],this.__itemsParam.clearItems(e)}getItems(){return this.__itemsParam.getValue()}setItems(e){this.clearItems(!1),this.__itemsParam.setItems(e)}_cleanBoundingBox(e){const t=super._cleanBoundingBox(e);return Array.from(this.__itemsParam.getValue()).forEach(e=>{e instanceof zt&&e.getVisible()&&!e.testFlag(D.IGNORE_BBOX)&&t.addBox3(e.getBoundingBox())}),t}onMouseDown(e){super.onMouseDown(e)}onMouseUp(e){super.onMouseUp(e)}onMouseMove(e){super.onMouseMove(e)}toJSON(e,t){const i=super.toJSON(e,t),a=Array.from(this.__itemsParam.getValue()),s=[];return a.forEach(t=>{const i=t.getPath();s.push(e?e.makeRelative(i):i)}),i.treeItems=s,i}fromJSON(e,t,i){if(super.fromJSON(e,t,i),this.setFlag(D.USER_EDITED),!e.treeItems)return void console.warn("Invalid Parameter JSON");let a=e.treeItems.length;const s=e=>{t.resolvePath(e,e=>{this.addItem(e),a--,0==a&&(this.calculatingGroupXfo=!0,this.calcGroupXfo(),this.calculatingGroupXfo=!1)},t=>{console.warn("Group: '"+this.getName()+"'. Unable to load item:"+e)})};for(const t of e.treeItems)s(t)}clone(e){const t=new kt;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t)}destroy(){super.destroy()}}z.registerClass("Group",kt);var Bt=ie("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpjb25zdCB0PU1hdGguUEkvMTgwO01hdGguSEFMRl9QST0uNSpNYXRoLlBJLE1hdGguVFdPX1BJPTIqTWF0aC5QSTtNYXRoLnJhZFRvRGVnPWZ1bmN0aW9uKGUpe3JldHVybiBlL3R9LE1hdGguZGVnVG9SYWQ9ZnVuY3Rpb24oZSl7cmV0dXJuIGUqdH0sTnVtYmVyLmlzTnVtZXJpYz10PT4haXNOYU4ocGFyc2VGbG9hdCh0KSkmJmlzRmluaXRlKHQpLFN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbD1mdW5jdGlvbih0LGUpe3JldHVybiB0aGlzLnJlcGxhY2UobmV3IFJlZ0V4cCh0LCJnIiksZSl9O2Z1bmN0aW9uIGUodCxlPTAscz01KXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodCwoZnVuY3Rpb24odCxlKXtyZXR1cm4gZSYmZS50b0ZpeGVkP051bWJlcihlLnRvRml4ZWQocykpOmV9KSxlKX1TdHJpbmcucHJvdG90eXBlLmhhc2g9ZnVuY3Rpb24oKXtyZXR1cm4gZnVuY3Rpb24odCl7bGV0IGUscyxhLGk9MDtpZigwPT09dC5sZW5ndGgpcmV0dXJuIGk7Zm9yKGU9MCxhPXQubGVuZ3RoO2U8YTtlKyspcz10LmNoYXJDb2RlQXQoZSksaT0oaTw8NSktaStzLGl8PTA7cmV0dXJuIE1hdGguYWJzKGkpfSh0aGlzKX0sU3RyaW5nLnByb3RvdHlwZS50cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csIiIpfSxTdHJpbmcucHJvdG90eXBlLmx0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sIiIpfSxTdHJpbmcucHJvdG90eXBlLnJ0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sIiIpfSxTdHJpbmcucHJvdG90eXBlLmxwYWQ9ZnVuY3Rpb24odCxlKXtsZXQgcz10aGlzO2Zvcig7cy5sZW5ndGg8ZTspcz10K3M7cmV0dXJuIHN9LFN0cmluZy5wcm90b3R5cGUucnBhZD1mdW5jdGlvbih0LGUpe2xldCBzPXRoaXM7Zm9yKDtzLmxlbmd0aDxlOylzKz10O3JldHVybiBzfSxNYXRoLnJhbmRvbUludD1mdW5jdGlvbih0LGUpe3JldHVybiB0PU1hdGguY2VpbCh0KSxlPU1hdGguZmxvb3IoZSksTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKihlLXQpKSt0fSxNYXRoLmxlcnA9KHQsZSxzKT0+dCtzKihlLXQpLE1hdGguY2xhbXA9ZnVuY3Rpb24odCxlLHMpe3JldHVybiBNYXRoLm1pbihNYXRoLm1heCh0LGUpLHMpfSxNYXRoLm5lYXJlc3RQb3cyPWZ1bmN0aW9uKHQpe3JldHVybiBNYXRoLnBvdygyLE1hdGgucm91bmQoTWF0aC5sb2codCkvTWF0aC5sb2coMikpKX0sTWF0aC5uZWFyZXN0UG93MTA9ZnVuY3Rpb24odCl7cmV0dXJuIE1hdGgucG93KDEwLE1hdGgucm91bmQoTWF0aC5sb2cxMCh0KS9NYXRoLmxvZzEwKDEwKSkpfSxNYXRoLm5leHRQb3cyPWZ1bmN0aW9uKHQpe2xldCBlPTA7Zm9yKDt0PjA7KWUrKyx0Pj49MTtyZXR1cm4gMTw8ZX0sTWF0aC5mcmFjdD1mdW5jdGlvbih0KXtyZXR1cm4gMD09dD8wOnQ8MD90Pi0xPy10Oi10JU1hdGguZmxvb3IoLXQpOnQ8MT90OnQlTWF0aC5mbG9vcih0KX0sTWF0aC5yZW1hcD1mdW5jdGlvbih0LGUscyxhLGkpe3JldHVybiBhKyh0LWUpLyhzLWUpKihpLWEpfSxNYXRoLmNvbnZlcnRGbG9hdDMyQXJyYXlUb1VJbnQxNkFycmF5PWZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IFVpbnQxNkFycmF5KHQubGVuZ3RoKSxzPW5ldyBJbnQzMkFycmF5KHQuYnVmZmVyKSxhPXQ9PntsZXQgZT10Pj4xNiYzMjc2OCxzPXQ+PjEyJjIwNDc7Y29uc3QgYT10Pj4yMyYyNTU7cmV0dXJuIGE8MTAzP2U6YT4xNDI/KGV8PTMxNzQ0LGV8PSgyNTU9PWE/MDoxKSYmODM4ODYwNyZ0LGUpOmE8MTEzPyhzfD0yMDQ4LGV8PShzPj4xMTQtYSkrKHM+PjExMy1hJjEpLGUpOihlfD1hLTExMjw8MTB8cz4+MSxlKz0xJnMsZSl9O2ZvcihsZXQgaT0wO2k8dC5sZW5ndGg7aSsrKWVbaV09YShzW2ldKTtyZXR1cm4gZX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0RnJvbTJ4VUludDg9dD0+e2NvbnN0IGU9dFswXSxzPSgxMjAmZSk+PjM7bGV0IGE9MD09cz8wOjIwNDg7Y29uc3QgaT1hKygoNyZlKTw8OCkrdFsxXTtyZXR1cm4gYT0wPT1zPzE6MCwoMTI4JmU/MTotMSkqaSpNYXRoLnBvdygyLHMrYS0xNil9LE1hdGguZW5jb2RlMTZCaXRGbG9hdEludG8yeFVJbnQ4PXQ9PntjfHwoYz1uZXcgVWludDhBcnJheSgyKSk7Y29uc3QgZT10Pj0wPzEyODowO3Q9TWF0aC5hYnModCk7bGV0IHMsYT0xNSxpPTEwMjQ7Zm9yKGxldCBlPTE1O2U+MDtlLS0pdDxpJiYoaS89MixhLS0pO3M9MD09YT90L2kvMjoodC1pKS9pO2NvbnN0IHI9TWF0aC5yb3VuZCgyMDQ4KnMpLG49ci8yNTYsaD1yLTI1NipuO3JldHVybiBjWzBdPWUrOCphK24sY1sxXT1oLHQ+PTIwNDgmJihjWzBdPTI1NSksY30sTWF0aC5lbmNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPW5ldyBGbG9hdDMyQXJyYXkoMSk7ZVswXT10O3JldHVybih0PT57bGV0IGU9dD4+MTYmMzI3Njgscz10Pj4xMiYyMDQ3O2NvbnN0IGE9dD4+MjMmMjU1O3JldHVybiBhPDEwMz9lOmE+MTQyPyhlfD0zMTc0NCxlfD0oMjU1PT1hPzA6MSkmJjgzODg2MDcmdCxlKTphPDExMz8oc3w9MjA0OCxlfD0ocz4+MTE0LWEpKyhzPj4xMTMtYSYxKSxlKTooZXw9YS0xMTI8PDEwfHM+PjEsZSs9MSZzLGUpfSkobmV3IEludDMyQXJyYXkoZS5idWZmZXIpWzBdKX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPSgzMjc2OCZ0KT4+MTUscz0oMzE3NDQmdCk+PjEwLGE9MTAyMyZ0O3JldHVybiAwPT1zPyhlPy0xOjEpKk1hdGgucG93KDIsLTE0KSooYS9NYXRoLnBvdygyLDEwKSk6MzE9PXM/YT9OYU46MS8wKihlPy0xOjEpOihlPy0xOjEpKk1hdGgucG93KDIscy0xNSkqKDErYS9NYXRoLnBvdygyLDEwKSl9LE1hdGguc21vb3RoU3RlcD0odCxlLHMpPT57Y29uc3QgYT1NYXRoLmNsYW1wKChzLXQpLyhlLXQpLDAsMSk7cmV0dXJuIGEqYSooMy0yKmEpfSxNYXRoLmxpblN0ZXA9KHQsZSxzKT0+TWF0aC5jbGFtcCgocy10KS8oZS10KSwwLDEpO2NsYXNzIHN7aXNWYWxpZCgpe2Zvcihjb25zdCB0IG9mIHRoaXMuX19kYXRhKWlmKHQ9PTEvMHx8aXNOYU4odCkpcmV0dXJuITE7cmV0dXJuITB9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZSl7dGhyb3cgbmV3IEVycm9yKCJOb3QgeWV0IGltcGxlbWVudGVkIGZvciB0aGlzIHR5cGU6Iit0aGlzLmNvbnN0cnVjdG9yLm5hbWUpfXN0YXRpYyBudW1FbGVtZW50cygpe3Rocm93IG5ldyBFcnJvcigiTm90IHlldCBpbXBsZW1lbnRlZCBmb3IgdGhpcyB0eXBlOiIrdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKX1hc0FycmF5KCl7cmV0dXJuIHRoaXMuX19kYXRhfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWNvbnN0IGE9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3R5cGVzPXt9LHRoaXMuX19uYW1lcz17fSx0aGlzLnJlZ2lzdGVyVHlwZSgiU0ludDMyIiw1KSx0aGlzLnJlZ2lzdGVyVHlwZSgiVUludDMyIiw0KSx0aGlzLnJlZ2lzdGVyVHlwZSgiRmxvYXQzMiIsNil9cmVnaXN0ZXJUeXBlKHQsZSl7dGhpcy5fX3R5cGVzW3RdPWUsZS5uYW1lP3RoaXMuX19uYW1lc1tlLm5hbWVdPXQ6dGhpcy5fX25hbWVzW2VdPXR9Z2V0VHlwZSh0KXtyZXR1cm4gdGhpcy5fX3R5cGVzW3RdfWdldFR5cGVOYW1lKHQpe2lmKHRoaXMuX19uYW1lc1t0XSlyZXR1cm4gdGhpcy5fX25hbWVzW3RdO2lmKHRoaXMuX19uYW1lc1t0Lm5hbWVdKXJldHVybiB0aGlzLl9fbmFtZXNbdC5uYW1lXTt0aHJvdyB0fX07Y2xhc3MgaSBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5fHx0IGluc3RhbmNlb2YgVWludDMyQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMil9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lKX1nZXQgeCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgeCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCB5KCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCB5KHQpe3RoaXMuX19kYXRhWzFdPXR9c2V0KHQsZSl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lfXNldEZyb21PdGhlcih0KXt0aGlzLng9dC54LHRoaXMueT10Lnl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueX1ub3RFcXVhbHModCl7cmV0dXJuIHRoaXMueCE9dC54JiZ0aGlzLnkhPXQueX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLngtdC54KTxlJiZNYXRoLmFicyh0aGlzLnktdC55KTxlfWFkZCh0KXtyZXR1cm4gbmV3IGkodGhpcy54K3QueCx0aGlzLnkrdC55KX1hZGRJblBsYWNlKHQpe3RoaXMueCs9dC54LHRoaXMueSs9dC55fXN1YnRyYWN0KHQpe3JldHVybiBuZXcgaSh0aGlzLngtdC54LHRoaXMueS10LnkpfXN1YnRyYWN0SW5QbGFjZSh0KXtyZXR1cm4gdGhpcy54LT10LngsdGhpcy55LT10LnksdGhpc31zY2FsZSh0KXtyZXR1cm4gbmV3IGkodGhpcy54KnQsdGhpcy55KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLngqPXQsdGhpcy55Kj10fWludmVydCgpe3JldHVybiBuZXcgaSgxL3RoaXMueCwxL3RoaXMueSl9aW52ZXJ0SW5QbGFjZSgpe3JldHVybiB0aGlzLng9MS90aGlzLngsdGhpcy55PTEvdGhpcy55LHRoaXN9bXVsdGlwbHkodCl7cmV0dXJuIG5ldyBpKHRoaXMueCp0LngsdGhpcy55KnQueSl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55fWxlbmd0aFNxdWFyZWQoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV07cmV0dXJuIHQqdCtlKmV9bGVuZ3RoKCl7cmV0dXJuIE1hdGguc3FydCh0aGlzLmxlbmd0aFNxdWFyZWQoKSl9ZGlzdGFuY2VUbyh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLXQueCxzPXRoaXMuX19kYXRhWzFdLXQueTtyZXR1cm4gTWF0aC5zcXJ0KGUqZStzKnMpfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXTtsZXQgcz10KnQrZSplO3JldHVybiBzPE51bWJlci5FUFNJTE9OP25ldyBpOihzPTEvTWF0aC5zcXJ0KHMpLG5ldyBpKHQqcyxlKnMpKX1ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdO2xldCBzPXQqdCtlKmU7czxOdW1iZXIuRVBTSUxPTnx8KHM9MS9NYXRoLnNxcnQocyksdGhpcy5zZXQodCpzLGUqcykpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55fWNyb3NzKHQpe3JldHVybiB0aGlzLngqdC55LXRoaXMueSp0Lnh9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMubm9ybWFsaXplKCkuZG90KHQubm9ybWFsaXplKCkpO3JldHVybiBlPjE/MDplPC0xP01hdGguUEk6TWF0aC5hY29zKGUpfXNpZ25lZEFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLmFuZ2xlVG8odCk7cmV0dXJuIHRoaXMuY3Jvc3ModCk8MD8tZTplfXJvdGF0ZSh0KXtjb25zdCBlPU1hdGguY29zKHQpLHM9TWF0aC5zaW4odCk7cmV0dXJuIG5ldyBpKHRoaXMueCplLXRoaXMueSpzLHRoaXMueCpzK3RoaXMueSplKX1sZXJwKHQsZSl7Y29uc3Qgcz10aGlzLngsYT10aGlzLnk7cmV0dXJuIG5ldyBpKHMrZSoodC54LXMpLGErZSoodC55LWEpKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJO3JldHVybiB0aGlzLl9fZGF0YVswXT1NYXRoLmNvcyhlKSp6U2NhbGUsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqelNjYWxlLHRoaXN9c2V0UmFuZG9tKHQ9MSl7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGgucmFuZG9tKCkqdCx0aGlzLl9fZGF0YVsxXT1NYXRoLnJhbmRvbSgpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgaSguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlPTApe3JldHVybiBuZXcgaSh0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQXJyYXkodCl7cmV0dXJuIG5ldyBpKHQpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiAyfXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueX19ZnJvbUpTT04odCl7dGhpcy54PXQueCx0aGlzLnk9dC55fX1hLnJlZ2lzdGVyVHlwZSgiVmVjMiIsaSk7Y2xhc3MgciBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTApe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheXx8dCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMyl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMpfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB4eSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9Z2V0IHl6KCl7cmV0dXJuIG5ldyBpKHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMpe3RoaXMueD10LHRoaXMueT12b2lkIDAhPT1lP2U6dCx0aGlzLno9dm9pZCAwIT09cz9zOnR9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56fWlzTnVsbCgpe3JldHVybiBNYXRoLmFicyh0aGlzLngpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnopPE51bWJlci5FUFNJTE9OfWlzMTExKCl7cmV0dXJuIE1hdGguYWJzKDEtdGhpcy54KTxOdW1iZXIuRVBTSUxPTiYmTWF0aC5hYnMoMS10aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicygxLXRoaXMueik8TnVtYmVyLkVQU0lMT059ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10Lnp9bm90RXF1YWxzKHQpe3JldHVybiB0aGlzLnghPXQueCYmdGhpcy55IT10LnkmJnRoaXMueiE9dC56fWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMueC10LngpPGUmJk1hdGguYWJzKHRoaXMueS10LnkpPGUmJk1hdGguYWJzKHRoaXMuei10LnopPGV9YWRkKHQpe3JldHVybiBuZXcgcih0aGlzLngrdC54LHRoaXMueSt0LnksdGhpcy56K3Queil9YWRkSW5QbGFjZSh0KXt0aGlzLngrPXQueCx0aGlzLnkrPXQueSx0aGlzLnorPXQuen1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IHIodGhpcy54LXQueCx0aGlzLnktdC55LHRoaXMuei10LnopfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQuen1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IHIodGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnopfW11bHRpcGx5SW5QbGFjZSh0KXt0aGlzLngqPXQueCx0aGlzLnkqPXQueSx0aGlzLnoqPXQuen1kaXZpZGUodCl7cmV0dXJuIG5ldyByKHRoaXMueC90LngsdGhpcy55L3QueSx0aGlzLnovdC56KX1kaXZpZGVJblBsYWNlKHQpe3RoaXMueC89dC54LHRoaXMueS89dC55LHRoaXMuei89dC56fXNjYWxlKHQpe3JldHVybiBuZXcgcih0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10fW5lZ2F0ZSgpe3JldHVybiBuZXcgcigtdGhpcy54LC10aGlzLnksLXRoaXMueil9aW52ZXJzZSgpe3JldHVybiBuZXcgcigxL3RoaXMueCwxL3RoaXMueSwxL3RoaXMueil9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdO3JldHVybiB0KnQrZSplK3Mqc31sZW5ndGgoKXtyZXR1cm4gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3F1YXJlZCgpKX1kaXN0YW5jZVRvKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0tdC54LHM9dGhpcy5fX2RhdGFbMV0tdC55LGE9dGhpcy5fX2RhdGFbMl0tdC56O3JldHVybiBNYXRoLnNxcnQoZSplK3MqcythKmEpfW5vcm1hbGl6ZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO3JldHVybiB0PE51bWJlci5FUFNJTE9OP25ldyByOih0PTEvTWF0aC5zcXJ0KHQpLG5ldyByKHRoaXMuX19kYXRhWzBdKnQsdGhpcy5fX2RhdGFbMV0qdCx0aGlzLl9fZGF0YVsyXSp0KSl9bm9ybWFsaXplSW5QbGFjZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKHQ8TnVtYmVyLkVQU0lMT04pcmV0dXJuO3Q9TWF0aC5zcXJ0KHQpO2NvbnN0IGU9MS90O3JldHVybiB0aGlzLl9fZGF0YVswXSo9ZSx0aGlzLl9fZGF0YVsxXSo9ZSx0aGlzLl9fZGF0YVsyXSo9ZSx0fXJlc2l6ZSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKGU8TnVtYmVyLkVQU0lMT04pcmV0dXJuO2NvbnN0IHM9dC9NYXRoLnNxcnQoZSk7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdKnMsdGhpcy5fX2RhdGFbMV0qcyx0aGlzLl9fZGF0YVsyXSpzKX1yZXNpemVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm47Y29uc3Qgcz10L01hdGguc3FydChlKTt0aGlzLl9fZGF0YVswXSo9cyx0aGlzLl9fZGF0YVsxXSo9cyx0aGlzLl9fZGF0YVsyXSo9c31kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56fWNyb3NzKHQpe2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dC54LG49dC55LGg9dC56O3JldHVybiBuZXcgcihzKmgtYSpuLGEqaS1lKmgsZSpuLXMqaSl9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMuZG90KHQpO3JldHVybiBlPjE/MDpNYXRoLmFjb3MoZSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBuZXcgcihzK2UqKHQueC1zKSxhK2UqKHQueS1hKSxpK2UqKHQuei1pKSl9YWJzKCl7cmV0dXJuIG5ldyByKE1hdGguYWJzKHRoaXMueCksTWF0aC5hYnModGhpcy55KSxNYXRoLmFicyh0aGlzLnopKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJLHM9MipNYXRoLnJhbmRvbSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGguY29zKGUpKmEsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqYSx0aGlzLl9fZGF0YVsyXT1zKnQsdGhpc31zZXRSYW5kb20odD0xKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMV09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMl09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgciguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUpTT04odCl7Y29uc3QgZT1uZXcgcjtyZXR1cm4gZS5mcm9tSlNPTih0KSxlfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyByKHQsNCplKX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJBcnJheSh0KXtyZXR1cm4gbmV3IHIodCl9c3RhdGljIG51bUVsZW1lbnRzKCl7cmV0dXJuIDN9dG9KU09OKCl7cmV0dXJue3g6dGhpcy54LHk6dGhpcy55LHo6dGhpcy56fX1mcm9tSlNPTih0KXt0aGlzLng9dC54LHRoaXMueT10LnksdGhpcy56PXQuen19YS5yZWdpc3RlclR5cGUoIlZlYzMiLHIpO2NsYXNzIG4gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YSl9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCB6KCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCB6KHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IHQoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IHQodCl7dGhpcy5fX2RhdGFbM109dH1nZXQgeHl6KCl7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMsYSl7dGhpcy54PXQsdGhpcy55PWUsdGhpcy56PXMsdGhpcy50PWF9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56LHRoaXMudD10LnR9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudD09dC50fW5vdEVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy50IT10LnR9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy50LXQudCk8ZX1hZGQodCl7cmV0dXJuIG5ldyBuKHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudCt0LnQpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy50Kz10LnR9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBuKHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudC10LnQpfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQueix0aGlzLnQtPXQudH1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnosdGhpcy50KnQudCl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55LHRoaXMueio9dC56LHRoaXMudCo9dC50fWRpdmlkZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54L3QueCx0aGlzLnkvdC55LHRoaXMuei90LnosdGhpcy50L3QudCl9ZGl2aWRlSW5QbGFjZSh0KXt0aGlzLngvPXQueCx0aGlzLnkvPXQueSx0aGlzLnovPXQueix0aGlzLnQvPXQudH1zY2FsZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQsdGhpcy55KnQsdGhpcy56KnQsdGhpcy50KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLnNldCh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLnQqdCl9bGVuZ3RoKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVsyXTtyZXR1cm4gTWF0aC5zcXJ0KHQqdCtlKmUrcypzK2EqYSl9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107cmV0dXJuIHQqdCtlKmUrcypzK2EqYX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtyZXR1cm4gaTxOdW1iZXIuRVBTSUxPTj9uZXcgbjooaT0xL01hdGguc3FydChpKSxuZXcgbih0KmksZSppLHMqaSkpfW5vcm1hbGl6ZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtpPE51bWJlci5FUFNJTE9OfHwoaT0xL01hdGguc3FydChpKSx0aGlzLnNldCh0KmksZSppLHMqaSxhKmkpKX1kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56K3RoaXMudCpiLnR9Y3Jvc3ModCl7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLnQscj10LngsaD10Lnksbz10LnosXz10LnQ7cmV0dXJuIG5ldyBuKHMqby1hKmgsYSpfLWkqbyxpKnItZSpfLGUqaC1zKnIpfWFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLm5vcm1hbGl6ZSgpLHM9dC5ub3JtYWxpemUoKSxhPWUuZG90KHMpO3JldHVybiBhPjE/MDpNYXRoLmFjb3MoYSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBhdD10aGlzLnQsbmV3IG4ocytlKih0LngtcyksYStlKih0LnktYSksaStlKih0LnotaSksYXQrZSoodC50LWF0KSl9cmFuZG9tKHQ9MSl7Y29uc3QgZT0yKmdsTWF0cml4LlJBTkRPTSgpKk1hdGguUEkscz0yKmdsTWF0cml4LlJBTkRPTSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIG91dFswXT1NYXRoLmNvcyhlKSphLG91dFsxXT1NYXRoLnNpbihlKSphLG91dFsyXT1zKnQsb3V0fWNsb25lKCl7cmV0dXJuIG5ldyBuKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b1ZlYzMoKXtyZXR1cm4gbmV3IHIodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHIoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IG4odCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueSx6OnRoaXMueix0OnRoaXMudH19fWEucmVnaXN0ZXJUeXBlKCJWZWM0IixuKTtjbGFzcyBoIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTAsZT0wLHM9MCxhPTI1NSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgVWludDhBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KHMsYSw0KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTI1NSl7dGhpcy5yPXQsdGhpcy5nPWUsdGhpcy5iPXMsdGhpcy5hPWF9c2V0RnJvbU90aGVyKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9c2V0RnJvbUFycmF5KHQpe3RoaXMucj10WzBdLHRoaXMuZz10WzFdLHRoaXMuYj10WzJdLHRoaXMuYT00PT10Lmxlbmd0aD90WzNdOjF9c2V0RnJvbUhleCh0KXtjb25zdCBlPWZ1bmN0aW9uKHQpe2NvbnN0IGU9L14jPyhbYS1mXGRdezJ9KShbYS1mXGRdezJ9KShbYS1mXGRdezJ9KSQvaS5leGVjKHQpO3JldHVybiBlP3tyOnBhcnNlSW50KGVbMV0sMTYpLGc6cGFyc2VJbnQoZVsyXSwxNiksYjpwYXJzZUludChlWzNdLDE2KX06bnVsbH0odCk7ZT90aGlzLnNldChlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9dC50b1N0cmluZygxNik7cmV0dXJuIDE9PWUubGVuZ3RoPyIwIitlOmV9cmV0dXJuIiMiK3QodGhpcy5yKSt0KHRoaXMuZykrdCh0aGlzLmIpfWVxdWFsKHQpe3JldHVybiB0aGlzLnI9PXQuciYmdGhpcy5nPT10LmcmJnRoaXMuYj09dC5iJiZ0aGlzLmE9PXQuYX1ub3RlcXVhbHModCl7cmV0dXJuIHRoaXMuciE9dC5yJiZ0aGlzLmchPXQuZyYmdGhpcy5iIT10LmImJnRoaXMuYSE9dC5hfWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMuci10LnIpPGUmJk1hdGguYWJzKHRoaXMuZy10LmcpPGUmJk1hdGguYWJzKHRoaXMuYi10LmIpPGUmJk1hdGguYWJzKHRoaXMuYS10LmEpPGV9YWRkKHQpe3JldHVybiBuZXcgaCh0aGlzLnIrdC5yLHRoaXMuZyt0LmcsdGhpcy5iK3QuYix0aGlzLmErdC5hKX1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IGgodGhpcy5yLXQucix0aGlzLmctdC5nLHRoaXMuYi10LmIsdGhpcy5hLXQuYSl9c2NhbGUodCl7cmV0dXJuIG5ldyBoKHRoaXMucip0LHRoaXMuZyp0LHRoaXMuYip0LHRoaXMuYSp0KX1zY2FsZUluUGxhY2UodCl7dGhpcy5yKj10LHRoaXMuZyo9dCx0aGlzLmIqPXQsdGhpcy5hKj10fWFwcGx5R2FtbWEodCl7dGhpcy5zZXQoTWF0aC5wb3codGhpcy5yLHQpLE1hdGgucG93KHRoaXMuZyx0KSxNYXRoLnBvdyh0aGlzLmIsdCksdGhpcy5hKX10b0xpbmVhcih0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9HYW1tYSh0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMuciwxL3QpLE1hdGgucG93KHRoaXMuZywxL3QpLE1hdGgucG93KHRoaXMuYiwxL3QpLHRoaXMuYSl9bHVtaW5hbmNlKCl7cmV0dXJuLjIxMjYqdGhpcy5yKy43MTUyKnRoaXMuZysuMDcyMip0aGlzLmJ9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy5yLGE9dGhpcy5nLGk9dGhpcy5iLHI9dGhpcy5hO3JldHVybiBuZXcgaChzK2UqKHQuci1zKSxhK2UqKHQuZy1hKSxpK2UqKHQuYi1pKSxyK2UqKHQuYS1yKSl9c3RhdGljIHJhbmRvbSh0PTAsZT0hMSl7cmV0dXJuIHQ+MD9uZXcgaCh0K01hdGgucmFuZG9tKCkqKDEtdCksdCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSxlP3QrTWF0aC5yYW5kb20oKSooMS10KToxKTp0PDA/bmV3IGgoTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLE1hdGgucmFuZG9tKCkqKDErdCksZT9NYXRoLnJhbmRvbSgpKigxK3QpOjEpOm5ldyBoKE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxNYXRoLnJhbmRvbSgpLGU/TWF0aC5yYW5kb20oKToxKX1jbG9uZSgpe3JldHVybiBuZXcgaCh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVszXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1hczNDb21wb25lbnRBcnJheSgpe3JldHVyblt0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXV19c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGgoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGgodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybntyOnRoaXMucixnOnRoaXMuZyxiOnRoaXMuYixhOnRoaXMuYX19ZnJvbUpTT04odCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX10b0NTU1N0cmluZygpe3JldHVybiJyZ2JhKCIrTWF0aC5yb3VuZCgyNTUqdGhpcy5yKSsiLCAiK01hdGgucm91bmQoMjU1KnRoaXMuZykrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmIpKyIsICIrdGhpcy5hKyIpIn19YS5yZWdpc3RlclR5cGUoIlJHQkEiLGgpO2NsYXNzIG8gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTEpe3RoaXMucj10LHRoaXMuZz1lLHRoaXMuYj1zLHRoaXMuYT1hfXNldEZyb21PdGhlcih0KXt0aGlzLnI9dC5yLHRoaXMuZz10LmcsdGhpcy5iPXQuYix0aGlzLmE9dC5hfXNldEZyb21TY2FsYXJBcnJheSh0KXt0aGlzLnI9dFswXSx0aGlzLmc9dFsxXSx0aGlzLmI9dFsyXSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXToxfWdldEFzUkdCQXJyYXkoKXtyZXR1cm5bMjU1KnRoaXMuciwyNTUqdGhpcy5nLDI1NSp0aGlzLmJdfWdldEFzUkdCRGljdCgpe3JldHVybntyOjI1NSp0aGlzLnIsZzoyNTUqdGhpcy5nLGI6MjU1KnRoaXMuYn19c2V0RnJvbVJHQih0LGUscyxhKXt0aGlzLnI9dC8yNTUsdGhpcy5nPWUvMjU1LHRoaXMuYj1zLzI1NSx0aGlzLmE9YT9hLzI1NToxfXNldEZyb21SR0JBcnJheSh0KXt0aGlzLnI9dFswXS8yNTUsdGhpcy5nPXRbMV0vMjU1LHRoaXMuYj10WzJdLzI1NSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXS8yNTU6MX1zZXRGcm9tUkdCRGljdCh0KXt0aGlzLnI9dC5yLzI1NSx0aGlzLmc9dC5nLzI1NSx0aGlzLmI9dC5iLzI1NSx0aGlzLmE9ND09dC5hP3QuYS8yNTU6MX1zZXRGcm9tSGV4KHQpe2NvbnN0IGU9ZnVuY3Rpb24odCl7Y29uc3QgZT0vXiM/KFthLWZcZF17Mn0pKFthLWZcZF17Mn0pKFthLWZcZF17Mn0pJC9pLmV4ZWModCk7cmV0dXJuIGU/e3I6cGFyc2VJbnQoZVsxXSwxNiksZzpwYXJzZUludChlWzJdLDE2KSxiOnBhcnNlSW50KGVbM10sMTYpfTpudWxsfSh0KTtlP3RoaXMuc2V0RnJvbVJHQihlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9TWF0aC5yb3VuZCgyNTUqdCkudG9TdHJpbmcoMTYpO3JldHVybiAxPT1lLmxlbmd0aD8iMCIrZTplfXJldHVybiIjIit0KHRoaXMucikrdCh0aGlzLmcpK3QodGhpcy5iKX1lcXVhbCh0KXtyZXR1cm4gdGhpcy5yPT10LnImJnRoaXMuZz09dC5nJiZ0aGlzLmI9PXQuYiYmdGhpcy5hPT10LmF9bm90ZXF1YWxzKHQpe3JldHVybiB0aGlzLnIhPXQuciYmdGhpcy5nIT10LmcmJnRoaXMuYiE9dC5iJiZ0aGlzLmEhPXQuYX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLnItdC5yKTxlJiZNYXRoLmFicyh0aGlzLmctdC5nKTxlJiZNYXRoLmFicyh0aGlzLmItdC5iKTxlJiZNYXRoLmFicyh0aGlzLmEtdC5hKTxlfWFkZCh0KXtyZXR1cm4gbmV3IG8odGhpcy5yK3Qucix0aGlzLmcrdC5nLHRoaXMuYit0LmIsdGhpcy5hK3QuYSl9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBvKHRoaXMuci10LnIsdGhpcy5nLXQuZyx0aGlzLmItdC5iLHRoaXMuYS10LmEpfXNjYWxlKHQpe3JldHVybiBuZXcgbyh0aGlzLnIqdCx0aGlzLmcqdCx0aGlzLmIqdCx0aGlzLmEqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMucio9dCx0aGlzLmcqPXQsdGhpcy5iKj10LHRoaXMuYSo9dH1hcHBseUdhbW1hKHQpe3RoaXMuc2V0KE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9MaW5lYXIodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsdCksTWF0aC5wb3codGhpcy5nLHQpLE1hdGgucG93KHRoaXMuYix0KSx0aGlzLmEpfXRvR2FtbWEodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsMS90KSxNYXRoLnBvdyh0aGlzLmcsMS90KSxNYXRoLnBvdyh0aGlzLmIsMS90KSx0aGlzLmEpfWx1bWluYW5jZSgpe3JldHVybi4yMTI2KnRoaXMucisuNzE1Mip0aGlzLmcrLjA3MjIqdGhpcy5ifWxlcnAodCxlKXtjb25zdCBzPXRoaXMucixhPXRoaXMuZyxpPXRoaXMuYixyPXRoaXMuYTtyZXR1cm4gbmV3IG8ocytlKih0LnItcyksYStlKih0LmctYSksaStlKih0LmItaSkscitlKih0LmEtcikpfXN0YXRpYyByYW5kb20odD0wLGU9ITEpe3JldHVybiB0PjA/bmV3IG8odCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSx0K01hdGgucmFuZG9tKCkqKDEtdCksZT90K01hdGgucmFuZG9tKCkqKDEtdCk6MSk6dDwwP25ldyBvKE1hdGgucmFuZG9tKCkqKDErdCksTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLGU/TWF0aC5yYW5kb20oKSooMSt0KToxKTpuZXcgbyhNYXRoLnJhbmRvbSgpLE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxlP01hdGgucmFuZG9tKCk6MSl9Y2xvbmUoKXtyZXR1cm4gbmV3IG8odGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9YXMzQ29tcG9uZW50QXJyYXkoKXtyZXR1cm5bdGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl1dfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBvKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBvKHQsNCplKX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gNH10b0pTT04oKXtyZXR1cm57cjp0aGlzLnIsZzp0aGlzLmcsYjp0aGlzLmIsYTp0aGlzLmF9fWZyb21KU09OKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9dG9DU1NTdHJpbmcoKXtyZXR1cm4icmdiYSgiK01hdGgucm91bmQoMjU1KnRoaXMucikrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmcpKyIsICIrTWF0aC5yb3VuZCgyNTUqdGhpcy5iKSsiLCAiK3RoaXMuYSsiKSJ9fWEucmVnaXN0ZXJUeXBlKCJDb2xvciIsbyk7Y2xhc3MgXyBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTAsYT0wKXtpZihzdXBlcigpLGlzTmFOKGEpKXN3aXRjaChhKXtjYXNlIlhZWiI6dGhpcy5vcmRlcj0wO2JyZWFrO2Nhc2UiWVpYIjp0aGlzLm9yZGVyPTE7YnJlYWs7Y2FzZSJaWFkiOnRoaXMub3JkZXI9MjticmVhaztjYXNlIlhaWSI6dGhpcy5vcmRlcj0zO2JyZWFrO2Nhc2UiWllYIjp0aGlzLm9yZGVyPTQ7YnJlYWs7Y2FzZSJZWFoiOnRoaXMub3JkZXI9NTticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiSW52YWxpZCBFdWxlciBBbmdsZXMgT3JkZXI6IithKX1lbHNlIHRoaXMub3JkZXI9YTtpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDMpLHRoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fXNldCh0LGUscyl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXN9fWEucmVnaXN0ZXJUeXBlKCJFdWxlckFuZ2xlcyIsXyk7Y2xhc3MgZCBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0xLGU9MCxzPTAsYT0wLGk9MSxyPTAsbj0wLGg9MCxvPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDkpfWVsc2UgdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg5KSx0aGlzLnNldCh0LGUscyxhLGkscixuLGgsbyl9Z2V0IG0wMCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgbTAwKHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IG0wMSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgbTAxKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IG0wMigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgbTAyKHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IG0xMCgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgbTEwKHQpe3RoaXMuX19kYXRhWzNdPXR9Z2V0IG0xMSgpe3JldHVybiB0aGlzLl9fZGF0YVs0XX1zZXQgbTExKHQpe3RoaXMuX19kYXRhWzRdPXR9Z2V0IG0xMigpe3JldHVybiB0aGlzLl9fZGF0YVs1XX1zZXQgbTEyKHQpe3RoaXMuX19kYXRhWzVdPXR9Z2V0IG0yMCgpe3JldHVybiB0aGlzLl9fZGF0YVs2XX1zZXQgbTIwKHQpe3RoaXMuX19kYXRhWzZdPXR9Z2V0IG0yMSgpe3JldHVybiB0aGlzLl9fZGF0YVs3XX1zZXQgbTIxKHQpe3RoaXMuX19kYXRhWzddPXR9Z2V0IG0yMigpe3JldHVybiB0aGlzLl9fZGF0YVs4XX1zZXQgbTIyKHQpe3RoaXMuX19kYXRhWzhdPXR9Z2V0IHhBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDApfXNldCB4QXhpcyh0KXt0aGlzLnhBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHlBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDMpfXNldCB5QXhpcyh0KXt0aGlzLnlBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHpBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDYpfXNldCB6QXhpcyh0KXt0aGlzLnpBeGlzLnNldCh0LngsdC55LHQueil9c2V0KHQ9MSxlPTAscz0wLGE9MCxpPTEscj0wLG49MCxoPTAsbz0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09b31zZXRJZGVudGl0eSgpe3RoaXMuc2V0KCl9c2V0RnJvbU1hdCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0xMCx0aGlzLl9fZGF0YVs0XT10Lm0xMSx0aGlzLl9fZGF0YVs1XT10Lm0xMix0aGlzLl9fZGF0YVs2XT10Lm0yMCx0aGlzLl9fZGF0YVs3XT10Lm0yMSx0aGlzLl9fZGF0YVs4XT10Lm0yMn1zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKXtjb25zdCBzPXQsYT1zLmxlbmd0aCgpO2lmKGE8TnVtYmVyLkVQU0lMT04pcmV0dXJuIHZvaWQgdGhpcy5zZXRJZGVudGl0eSgpO3Muc2NhbGVJblBsYWNlKDEvYSk7Y29uc3QgaT1lLmNyb3NzKHMpLHI9aS5sZW5ndGgoKTtyPk51bWJlci5FUFNJTE9OJiZpLnNjYWxlSW5QbGFjZSgxL3IpO2NvbnN0IG49cy5jcm9zcyhpKSxoPW4ubGVuZ3RoKCk7aD5OdW1iZXIuRVBTSUxPTiYmbi5zY2FsZUluUGxhY2UoMS9oKSx0aGlzLnNldChpLngsaS55LGkueixuLngsbi55LG4ueixzLngscy55LHMueil9aW52ZXJzZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89byppLXIqaCxsPS1vKmErcipuLGM9aCphLWkqbix1PXQqXytlKmwrcypjO3JldHVybiB1Pyh1PTEvdSxuZXcgZChfKnUsKC1vKmUrcypoKSp1LChyKmUtcyppKSp1LGwqdSwobyp0LXMqbikqdSwoLXIqdCtzKmEpKnUsYyp1LCgtaCp0K2UqbikqdSwoaSp0LWUqYSkqdSkpOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0MyIpLG51bGwpfWludmVydEluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdLGk9dGhpcy5fX2RhdGFbNF0scj10aGlzLl9fZGF0YVs1XSxuPXRoaXMuX19kYXRhWzZdLGg9dGhpcy5fX2RhdGFbN10sbz10aGlzLl9fZGF0YVs4XSxfPW8qaS1yKmgsZD0tbyphK3IqbixsPWgqYS1pKm4sYz10Kl8rZSpkK3MqbDtyZXR1cm4gYz8oYz0xL2MsdGhpcy5zZXQoXypjLCgtbyplK3MqaCkqYywociplLXMqaSkqYyxkKmMsKG8qdC1zKm4pKmMsKC1yKnQrcyphKSpjLGwqYywoLWgqdCtlKm4pKmMsKGkqdC1lKmEpKmMpLCEwKTooY29uc29sZS53YXJuKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDMiKSwhMSl9dHJhbnNwb3NlKCl7cmV0dXJuIGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbOF0pfXRyYW5zcG9zZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzFdLGU9dGhpcy5fX2RhdGFbMl0scz10aGlzLl9fZGF0YVs1XTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVszXT10LHRoaXMuX19kYXRhWzVdPXRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzZdPWUsdGhpcy5fX2RhdGFbN109c310cmFuc2Zvcm1WZWMzKHQpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSp0LngrdGhpcy5fX2RhdGFbMV0qdC55K3RoaXMuX19kYXRhWzJdKnQueix0aGlzLl9fZGF0YVszXSp0LngrdGhpcy5fX2RhdGFbNF0qdC55K3RoaXMuX19kYXRhWzVdKnQueix0aGlzLl9fZGF0YVs2XSp0LngrdGhpcy5fX2RhdGFbN10qdC55K3RoaXMuX19kYXRhWzhdKnQueil9Y2xvbmUoKXtyZXR1cm4gbmV3IGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbOF0sdGhpcy5fX2RhdGFbOV0pfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBkKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBkKHQsNCplKX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX10b1N0cmluZygpe3JldHVybiB0aGlzLnRvSlNPTigpLnRvU3RyaW5nKCl9fWEucmVnaXN0ZXJUeXBlKCJNYXQzIixkKTtjbGFzcyBsIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTEsZT0wLHM9MCxhPTAsaT0wLHI9MSxuPTAsaD0wLG89MCxfPTAsZD0xLGw9MCxjPTAsdT0wLGY9MCxtPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDE2KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMTYpLHRoaXMuc2V0KHQsZSxzLGEsaSxyLG4saCxvLF8sZCxsLGMsdSxmLG0pfWdldCBtMDAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IG0wMCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCBtMDEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IG0wMSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCBtMDIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IG0wMih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCBtMDMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IG0wMyh0KXt0aGlzLl9fZGF0YVszXT10fWdldCBtMTAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNF19c2V0IG0xMCh0KXt0aGlzLl9fZGF0YVs0XT10fWdldCBtMTEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNV19c2V0IG0xMSh0KXt0aGlzLl9fZGF0YVs1XT10fWdldCBtMTIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNl19c2V0IG0xMih0KXt0aGlzLl9fZGF0YVs2XT10fWdldCBtMTMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbN119c2V0IG0xMyh0KXt0aGlzLl9fZGF0YVs3XT10fWdldCBtMjAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOF19c2V0IG0yMCh0KXt0aGlzLl9fZGF0YVs4XT10fWdldCBtMjEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOV19c2V0IG0yMSh0KXt0aGlzLl9fZGF0YVs5XT10fWdldCBtMjIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTBdfXNldCBtMjIodCl7dGhpcy5fX2RhdGFbMTBdPXR9Z2V0IG0yMygpe3JldHVybiB0aGlzLl9fZGF0YVsxMV19c2V0IG0yMyh0KXt0aGlzLl9fZGF0YVsxMV09dH1nZXQgbTMwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzEyXX1zZXQgbTMwKHQpe3RoaXMuX19kYXRhWzEyXT10fWdldCBtMzEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTNdfXNldCBtMzEodCl7dGhpcy5fX2RhdGFbMTNdPXR9Z2V0IG0zMigpe3JldHVybiB0aGlzLl9fZGF0YVsxNF19c2V0IG0zMih0KXt0aGlzLl9fZGF0YVsxNF09dH1nZXQgbTMzKCl7cmV0dXJuIHRoaXMuX19kYXRhWzE1XX1zZXQgbTMzKHQpe3RoaXMuX19kYXRhWzE1XT10fWdldCB4QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwwKX1zZXQgeEF4aXModCl7dGhpcy54QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB5QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw0KX1zZXQgeUF4aXModCl7dGhpcy55QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB6QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw4KX1zZXQgekF4aXModCl7dGhpcy56QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB0cmFuc2xhdGlvbigpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwxMil9c2V0IHRyYW5zbGF0aW9uKHQpe3RoaXMudHJhbnNsYXRpb24uc2V0KHQueCx0LnksdC56KX1zZXQodD0xLGU9MCxzPTAsYT0wLGk9MCxyPTEsbj0wLGg9MCxvPTAsXz0wLGQ9MSxsPTAsYz0wLHU9MCxmPTAsbT0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09byx0aGlzLl9fZGF0YVs5XT1fLHRoaXMuX19kYXRhWzEwXT1kLHRoaXMuX19kYXRhWzExXT1sLHRoaXMuX19kYXRhWzEyXT1jLHRoaXMuX19kYXRhWzEzXT11LHRoaXMuX19kYXRhWzE0XT1mLHRoaXMuX19kYXRhWzE1XT1tfXNldElkZW50aXR5KCl7dGhpcy5zZXQoKX1zZXREYXRhQXJyYXkodCl7dGhpcy5fX2RhdGE9dH1zZXRGcm9tTWF0NCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0wMyx0aGlzLl9fZGF0YVs0XT10Lm0xMCx0aGlzLl9fZGF0YVs1XT10Lm0xMSx0aGlzLl9fZGF0YVs2XT10Lm0xMix0aGlzLl9fZGF0YVs3XT10Lm0xMyx0aGlzLl9fZGF0YVs4XT10Lm0yMCx0aGlzLl9fZGF0YVs5XT10Lm0yMSx0aGlzLl9fZGF0YVsxMF09dC5tMjIsdGhpcy5fX2RhdGFbMTFdPXQubTIzLHRoaXMuX19kYXRhWzEyXT10Lm0zMCx0aGlzLl9fZGF0YVsxM109dC5tMzEsdGhpcy5fX2RhdGFbMTRdPXQubTMyLHRoaXMuX19kYXRhWzE1XT10Lm0zM310b01hdDModCl7cmV0dXJuIG5ldyBkKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSl9dHJhbnNwb3NlSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMV0sZT10aGlzLl9fZGF0YVsyXSxzPXRoaXMuX19kYXRhWzNdLGE9dGhpcy5fX2RhdGFbNl0saT10aGlzLl9fZGF0YVs3XSxyPXRoaXMuX19kYXRhWzExXTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVszXT10aGlzLl9fZGF0YVsxMl0sdGhpcy5fX2RhdGFbNF09dCx0aGlzLl9fZGF0YVs2XT10aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVs3XT10aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbOF09ZSx0aGlzLl9fZGF0YVs5XT1hLHRoaXMuX19kYXRhWzExXT10aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTJdPXMsdGhpcy5fX2RhdGFbMTNdPWksdGhpcy5fX2RhdGFbMTRdPXJ9dHJhbnNwb3NlKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzEyXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMTBdLHRoaXMuX19kYXRhWzE0XSx0aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVs3XSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTVdKX1pbnZlcnNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXSxpPXRoaXMuX19kYXRhWzRdLHI9dGhpcy5fX2RhdGFbNV0sbj10aGlzLl9fZGF0YVs2XSxoPXRoaXMuX19kYXRhWzddLG89dGhpcy5fX2RhdGFbOF0sXz10aGlzLl9fZGF0YVs5XSxkPXRoaXMuX19kYXRhWzEwXSxjPXRoaXMuX19kYXRhWzExXSx1PXRoaXMuX19kYXRhWzEyXSxmPXRoaXMuX19kYXRhWzEzXSxtPXRoaXMuX19kYXRhWzE0XSxnPXRoaXMuX19kYXRhWzE1XSx5PXQqci1lKmkscD10Km4tcyppLGI9dCpoLWEqaSx4PWUqbi1zKnIsdz1lKmgtYSpyLEk9cypoLWEqbixOPW8qZi1fKnUsRj1vKm0tZCp1LHo9bypnLWMqdSxWPV8qbS1kKmYsTT1fKmctYypmLEE9ZCpnLWMqbTtsZXQgUz15KkEtcCpNK2IqVit4KnotdypGK0kqTjtyZXR1cm4gUz8oUz0xL1MsbmV3IGwoKHIqQS1uKk0raCpWKSpTLChzKk0tZSpBLWEqVikqUywoZipJLW0qdytnKngpKlMsKGQqdy1fKkktYyp4KSpTLChuKnotaSpBLWgqRikqUywodCpBLXMqeithKkYpKlMsKG0qYi11KkktZypwKSpTLChvKkktZCpiK2MqcCkqUywoaSpNLXIqeitoKk4pKlMsKGUqei10Kk0tYSpOKSpTLCh1KnctZipiK2cqeSkqUywoXypiLW8qdy1jKnkpKlMsKHIqRi1pKlYtbipOKSpTLCh0KlYtZSpGK3MqTikqUywoZipwLXUqeC1tKnkpKlMsKG8qeC1fKnArZCp5KSpTKSk6KGNvbnNvbGUud2FybigiVW5hYmxlIHRvIGludmVydCBNYXQ0IiksbnVsbCl9aW52ZXJ0SW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89dGhpcy5fX2RhdGFbOV0sZD10aGlzLl9fZGF0YVsxMF0sbD10aGlzLl9fZGF0YVsxMV0sYz10aGlzLl9fZGF0YVsxMl0sdT10aGlzLl9fZGF0YVsxM10sZj10aGlzLl9fZGF0YVsxNF0sbT10aGlzLl9fZGF0YVsxNV0sZz10KnItZSppLHk9dCpuLXMqaSxwPXQqaC1hKmksYj1lKm4tcypyLHg9ZSpoLWEqcix3PXMqaC1hKm4sST1vKnUtXypjLE49bypmLWQqYyxGPW8qbS1sKmMsej1fKmYtZCp1LFY9XyptLWwqdSxNPWQqbS1sKmY7bGV0IEE9ZypNLXkqVitwKnorYipGLXgqTit3Kkk7cmV0dXJuIEE/KEE9MS9BLHRoaXMuc2V0KChyKk0tbipWK2gqeikqQSwocypWLWUqTS1hKnopKkEsKHUqdy1mKngrbSpiKSpBLChkKngtXyp3LWwqYikqQSwobipGLWkqTS1oKk4pKkEsKHQqTS1zKkYrYSpOKSpBLChmKnAtYyp3LW0qeSkqQSwobyp3LWQqcCtsKnkpKkEsKGkqVi1yKkYraCpJKSpBLChlKkYtdCpWLWEqSSkqQSwoYyp4LXUqcCttKmcpKkEsKF8qcC1vKngtbCpnKSpBLChyKk4taSp6LW4qSSkqQSwodCp6LWUqTitzKkkpKkEsKHUqeS1jKmItZipnKSpBLChvKmItXyp5K2QqZykqQSksITApOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0NCIpLCExKX1zZXRJbnZlcnNlKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0scz10Ll9fZGF0YVsxXSxhPXQuX19kYXRhWzJdLGk9dC5fX2RhdGFbM10scj10Ll9fZGF0YVs0XSxuPXQuX19kYXRhWzVdLGg9dC5fX2RhdGFbNl0sbz10Ll9fZGF0YVs3XSxfPXQuX19kYXRhWzhdLGQ9dC5fX2RhdGFbOV0sbD10Ll9fZGF0YVsxMF0sYz10Ll9fZGF0YVsxMV0sdT10Ll9fZGF0YVsxMl0sZj10Ll9fZGF0YVsxM10sbT10Ll9fZGF0YVsxNF0sZz10Ll9fZGF0YVsxNV0seT1lKm4tcypyLHA9ZSpoLWEqcixiPWUqby1pKnIseD1zKmgtYSpuLHc9cypvLWkqbixJPWEqby1pKmgsTj1fKmYtZCp1LEY9XyptLWwqdSx6PV8qZy1jKnUsVj1kKm0tbCpmLE09ZCpnLWMqZixBPWwqZy1jKm07bGV0IFM9eSpBLXAqTStiKlYreCp6LXcqRitJKk47aWYoIVMpdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDQiKTtTPTEvUyx0aGlzLnNldCgobipBLWgqTStvKlYpKlMsKGEqTS1zKkEtaSpWKSpTLChmKkktbSp3K2cqeCkqUywobCp3LWQqSS1jKngpKlMsKGgqei1yKkEtbypGKSpTLChlKkEtYSp6K2kqRikqUywobSpiLXUqSS1nKnApKlMsKF8qSS1sKmIrYypwKSpTLChyKk0tbip6K28qTikqUywocyp6LWUqTS1pKk4pKlMsKHUqdy1mKmIrZyp5KSpTLChkKmItXyp3LWMqeSkqUywobipGLXIqVi1oKk4pKlMsKGUqVi1zKkYrYSpOKSpTLChmKnAtdSp4LW0qeSkqUywoXyp4LWQqcCtsKnkpKlMpfW11bHRpcGx5KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10aGlzLl9fZGF0YVs0XSxuPXRoaXMuX19kYXRhWzVdLGg9dGhpcy5fX2RhdGFbNl0sbz10aGlzLl9fZGF0YVs3XSxfPXRoaXMuX19kYXRhWzhdLGQ9dGhpcy5fX2RhdGFbOV0sYz10aGlzLl9fZGF0YVsxMF0sdT10aGlzLl9fZGF0YVsxMV0sZj10aGlzLl9fZGF0YVsxMl0sbT10aGlzLl9fZGF0YVsxM10sZz10aGlzLl9fZGF0YVsxNF0seT10aGlzLl9fZGF0YVsxNV0scD10LmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO2NvbnN0IE49bmV3IGw7cmV0dXJuIE4ubTAwPWIqZSt4KnIrdypfK0kqZixOLm0wMT1iKnMreCpuK3cqZCtJKm0sTi5tMDI9YiphK3gqaCt3KmMrSSpnLE4ubTAzPWIqaSt4Km8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sTi5tMTA9YiplK3gqcit3Kl8rSSpmLE4ubTExPWIqcyt4Km4rdypkK0kqbSxOLm0xMj1iKmEreCpoK3cqYytJKmcsTi5tMTM9YippK3gqbyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLE4ubTIwPWIqZSt4KnIrdypfK0kqZixOLm0yMT1iKnMreCpuK3cqZCtJKm0sTi5tMjI9YiphK3gqaCt3KmMrSSpnLE4ubTIzPWIqaSt4Km8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLE4ubTMwPWIqZSt4KnIrdypfK0kqZixOLm0zMT1iKnMreCpuK3cqZCtJKm0sTi5tMzI9YiphK3gqaCt3KmMrSSpnLE4ubTMzPWIqaSt4Km8rdyp1K0kqeSxOfW11bHRpcGx5SW5QbGFjZSh0KXtjb25zdCBlPXRoaXMuYXNBcnJheSgpLHM9ZVswXSxhPWVbMV0saT1lWzJdLHI9ZVszXSxuPWVbNF0saD1lWzVdLG89ZVs2XSxfPWVbN10sZD1lWzhdLGw9ZVs5XSxjPWVbMTBdLHU9ZVsxMV0sZj1lWzEyXSxtPWVbMTNdLGc9ZVsxNF0seT1lWzE1XSxwPXQuYXNBcnJheSgpO2xldCBiPXBbMF0seD1wWzFdLHc9cFsyXSxJPXBbM107cmV0dXJuIHRoaXMubTAwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0wMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMDI9YippK3gqbyt3KmMrSSpnLHRoaXMubTAzPWIqcit4Kl8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sdGhpcy5tMTA9YipzK3gqbit3KmQrSSpmLHRoaXMubTExPWIqYSt4KmgrdypsK0kqbSx0aGlzLm0xMj1iKmkreCpvK3cqYytJKmcsdGhpcy5tMTM9YipyK3gqXyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLHRoaXMubTIwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0yMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMjI9YippK3gqbyt3KmMrSSpnLHRoaXMubTIzPWIqcit4Kl8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLHRoaXMubTMwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0zMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMzI9YippK3gqbyt3KmMrSSpnLHRoaXMubTMzPWIqcit4Kl8rdyp1K0kqeSx0aGlzfXBvc3RtdWx0aXBseUluUGxhY2UodCl7Y29uc3QgZT10LmFzQXJyYXkoKSxzPWVbMF0sYT1lWzFdLGk9ZVsyXSxyPWVbM10sbj1lWzRdLGg9ZVs1XSxvPWVbNl0sXz1lWzddLGQ9ZVs4XSxsPWVbOV0sYz1lWzEwXSx1PWVbMTFdLGY9ZVsxMl0sbT1lWzEzXSxnPWVbMTRdLHk9ZVsxNV0scD10aGlzLmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO3JldHVybiB0aGlzLm0wMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMDE9YiphK3gqaCt3KmwrSSptLHRoaXMubTAyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0wMz1iKnIreCpfK3cqdStJKnksYj1wWzRdLHg9cFs1XSx3PXBbNl0sST1wWzddLHRoaXMubTEwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0xMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMTI9YippK3gqbyt3KmMrSSpnLHRoaXMubTEzPWIqcit4Kl8rdyp1K0kqeSxiPXBbOF0seD1wWzldLHc9cFsxMF0sST1wWzExXSx0aGlzLm0yMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMjE9YiphK3gqaCt3KmwrSSptLHRoaXMubTIyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0yMz1iKnIreCpfK3cqdStJKnksYj1wWzEyXSx4PXBbMTNdLHc9cFsxNF0sST1wWzE1XSx0aGlzLm0zMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMzE9YiphK3gqaCt3KmwrSSptLHRoaXMubTMyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0zMz1iKnIreCpfK3cqdStJKnksdGhpc310cmFuc2xhdGVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lno7cmV0dXJuIGVbMTJdPWVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdLGVbMTNdPWVbMV0qcytlWzVdKmErZVs5XSppK2VbMTNdLGVbMTRdPWVbMl0qcytlWzZdKmErZVsxMF0qaStlWzE0XSxlWzE1XT1lWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0sdGhpc31zZXRMb29rQXQodCxlLHMpe2NvbnN0IGE9dC5zdWJ0cmFjdChlKSxpPWEubGVuZ3RoKCk7aWYoaTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdm9pZCB0aGlzLnNldElkZW50aXR5KCk7YS5zY2FsZUluUGxhY2UoMS9pKTtjb25zdCByPXMuY3Jvc3MoYSksbj1yLmxlbmd0aCgpO24+TnVtYmVyLkVQU0lMT04mJnIuc2NhbGVJblBsYWNlKDEvbik7Y29uc3QgaD1hLmNyb3NzKHIpLG89aC5sZW5ndGgoKTtvPk51bWJlci5FUFNJTE9OJiZoLnNjYWxlSW5QbGFjZSgxL28pLHRoaXMuc2V0KHIueCxyLnksci56LDAsaC54LGgueSxoLnosMCxhLngsYS55LGEueiwwLHQueCx0LnksdC56LDEpfXNldFJvdGF0aW9uKHQsZSl7Y29uc3Qgcz10Lmxlbmd0aCgpO2lmKE1hdGguYWJzKHMpPE51bWJlci5FUFNJTE9OKXJldHVybiBudWxsO2NvbnN0IGE9dC54L3MsaT10LnkvcyxyPXQuei9zLG49TWF0aC5zaW4oZSksaD1NYXRoLmNvcyhlKSxvPTEtaCxfPXRoaXMuX19kYXRhO3JldHVybiBfWzBdPWEqYSpvK2gsX1sxXT1pKmEqbytyKm4sX1syXT1yKmEqby1pKm4sX1szXT0wLF9bNF09YSppKm8tcipuLF9bNV09aSppKm8raCxfWzZdPXIqaSpvK2EqbixfWzddPTAsX1s4XT1hKnIqbytpKm4sX1s5XT1pKnIqby1hKm4sX1sxMF09cipyKm8raCxfWzExXT0wLF9bMTJdPTAsX1sxM109MCxfWzE0XT0wLF9bMTVdPTEsdGhpc31zZXRYUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09MSxhWzFdPTAsYVsyXT0wLGFbM109MCxhWzRdPTAsYVs1XT1zLGFbNl09ZSxhWzddPTAsYVs4XT0wLGFbOV09LWUsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRZUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPTAsYVsyXT0tZSxhWzNdPTAsYVs0XT0wLGFbNV09MSxhWzZdPTAsYVs3XT0wLGFbOF09ZSxhWzldPTAsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRaUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPWUsYVsyXT0wLGFbM109MCxhWzRdPS1lLGFbNV09cyxhWzZdPTAsYVs3XT0wLGFbOF09MCxhWzldPTAsYVsxMF09MSxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc310cmFuc2Zvcm1WZWM0KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lnoscj10LnQ7cmV0dXJuIG5ldyBWZWM0KGVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdKnIsZVsxXSpzK2VbNV0qYStlWzldKmkrZVsxM10qcixlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0qcixlWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0qcil9dHJhbnNmb3JtVmVjMyh0KXtjb25zdCBlPXRoaXMuX19kYXRhLHM9dC54LGE9dC55LGk9dC56O3JldHVybiBuZXcgcihlWzBdKnMrZVs0XSphK2VbOF0qaStlWzEyXSxlWzFdKnMrZVs1XSphK2VbOV0qaStlWzEzXSxlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0pfXJvdGF0ZVZlYzModCl7Y29uc3QgZT10aGlzLl9fZGF0YSxzPXQueCxhPXQueSxpPXQuejtyZXR1cm4gbmV3IHIoZVswXSpzK2VbNF0qYStlWzhdKmksZVsxXSpzK2VbNV0qYStlWzldKmksZVsyXSpzK2VbNl0qYStlWzEwXSppKX1zZXRQZXJzcGVjdGl2ZU1hdHJpeCh0LGUscyxhKXtjb25zdCBpPU1hdGgudGFuKC41Kk1hdGguUEktLjUqdCkscj0xLyhzLWEpO3RoaXMuc2V0KGkvZSwwLDAsMCwwLGksMCwwLDAsMCwocythKSpyLC0xLDAsMCxzKmEqcioyLDApfXNldE9ydGhvZ3JhcGhpY01hdHJpeCh0LGUscyxhLGkscil7Y29uc3Qgbj0xLyh0LWUpLGg9MS8ocy1hKSxvPTEvKGktcik7dGhpcy5zZXQoLTIqbiwwLDAsMCwwLC0yKmgsMCwwLDAsMCwyKm8sMCwodCtlKSpuLChhK3MpKmgsKHIraSkqbywxKX1zZXRTY2FsZSh0LGUscyl7dCBpbnN0YW5jZW9mIHI/dGhpcy5zZXQodC54LDAsMCwwLDAsdC55LDAsMCwwLDAsdC56LDAsMCwwLDAsMSk6dGhpcy5zZXQodCwwLDAsMCwwLGUsMCwwLDAsMCxzLDAsMCwwLDAsMSl9c2V0RnJvbU1hdDN4NEFycmF5KHQpe3RoaXMuc2V0KHRbMF0sdFsxXSx0WzJdLDAsdFszXSx0WzRdLHRbNV0sMCx0WzZdLHRbN10sdFs4XSwwLHRbOV0sdFsxMF0sdFsxMV0sMSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGwodCw0KmUpfWNsb25lKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTJdLHRoaXMuX19kYXRhWzEzXSx0aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTVdKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgbCguLi50KX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX19YS5yZWdpc3RlclR5cGUoIk1hdDQiLGwpO2NsYXNzIHUgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBpZih0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJvYmplY3QiPT10eXBlb2YgdCl7dGhpcy5fX2RhdGFbMF09MCx0aGlzLl9fZGF0YVsxXT0wLHRoaXMuX19kYXRhWzJdPTAsdGhpcy5fX2RhdGFbM109MTtmb3IoY29uc3QgZSBpbiB0KUFycmF5LmlzQXJyYXkodFtlXSk/dGhpc1tlXS5jYWxsKHRoaXMsLi4udFtlXSk6dGhpc1tlXS5jYWxsKHRoaXMsdFtlXSl9ZWxzZSB0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB3KCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCB3KHQpe3RoaXMuX19kYXRhWzNdPXR9c2V0KHQsZSxzLGEpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWF9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQud31zZXRGcm9tRXVsZXJBbmdsZXModCl7Y29uc3QgZT1uZXcgcjtzd2l0Y2godC5vcmRlcil7Y2FzZSAwOmUuc2V0KHQueCwtdC55LHQueik7YnJlYWs7Y2FzZSAxOmUuc2V0KHQueSwtdC56LHQueCk7YnJlYWs7Y2FzZSAyOmUuc2V0KHQueiwtdC54LHQueSk7YnJlYWs7Y2FzZSAzOmUuc2V0KHQueCx0LnosdC55KTticmVhaztjYXNlIDQ6ZS5zZXQodC56LHQueSx0LngpO2JyZWFrO2Nhc2UgNTplLnNldCh0LnksdC54LHQueik7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoInNkcnR5Iil9Y29uc3Qgcz0uNSplLngsYT0uNSplLnksaT0uNSplLnosbj1NYXRoLmNvcyhzKSxoPU1hdGguY29zKGEpLG89TWF0aC5jb3MoaSksXz1NYXRoLnNpbihzKSxkPU1hdGguc2luKGEpLGw9TWF0aC5zaW4oaSksYz1uKm8sdT1uKmwsZj1fKm8sbT1fKmwsZz1oKmYtZCp1LHk9aCptK2QqYyxwPWgqdS1kKmY7c3dpdGNoKHRoaXMudz1oKmMrZCptLHQub3JkZXIpe2Nhc2UgMDp0aGlzLng9Zyx0aGlzLnk9LXksdGhpcy56PXA7YnJlYWs7Y2FzZSAxOnRoaXMueD1wLHRoaXMueT1nLHRoaXMuej0teTticmVhaztjYXNlIDI6dGhpcy54PS15LHRoaXMueT1wLHRoaXMuej1nO2JyZWFrO2Nhc2UgMzp0aGlzLng9Zyx0aGlzLnk9cCx0aGlzLno9eTticmVhaztjYXNlIDQ6dGhpcy54PXAsdGhpcy55PXksdGhpcy56PWc7YnJlYWs7Y2FzZSA1OnRoaXMueD15LHRoaXMueT1nLHRoaXMuej1wO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJzZHJ0eSIpfX10b0V1bGVyQW5nbGVzKHQpe2NvbnN0IGU9bmV3IHI7c3dpdGNoKHQpe2Nhc2UgMDplLnNldCh0aGlzLnosdGhpcy54LHRoaXMueSk7YnJlYWs7Y2FzZSAxOmUuc2V0KHRoaXMueCx0aGlzLnksdGhpcy56KTticmVhaztjYXNlIDI6ZS5zZXQodGhpcy55LHRoaXMueix0aGlzLngpO2JyZWFrO2Nhc2UgMzplLnNldCh0aGlzLnksLXRoaXMueCx0aGlzLnopO2JyZWFrO2Nhc2UgNDplLnNldCh0aGlzLngsLXRoaXMueix0aGlzLnkpO2JyZWFrO2Nhc2UgNTplLnNldCh0aGlzLnosLXRoaXMueSx0aGlzLngpO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdGF0aW9uIG9yZGVyOiIrdCl9Y29uc3Qgcz1uZXcgcixhPWUueCplLnkrZS56KnRoaXMudztpZihhPi40OTk5OSlzLnk9MipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0uNSpNYXRoLlBJLHMueD0wO2Vsc2UgaWYoYTwtLjQ5OTk5KXMueT0tMipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0tLjUqTWF0aC5QSSxzLng9MDtlbHNle2NvbnN0IHQ9ZS54KmUueCxpPWUueSplLnkscj1lLnoqZS56O3MueT1NYXRoLmF0YW4yKDIqZS55KnRoaXMudy0yKmUueCplLnosMS0yKmktMipyKSxzLno9TWF0aC5hc2luKDIqYSkscy54PU1hdGguYXRhbjIoMiplLngqdGhpcy53LTIqZS55KmUueiwxLTIqdC0yKnIpfXN3aXRjaCh0KXtjYXNlIDA6cmV0dXJuIG5ldyBfKHMueSxzLnoscy54LHQpO2Nhc2UgMTpyZXR1cm4gbmV3IF8ocy54LHMueSxzLnosdCk7Y2FzZSAyOnJldHVybiBuZXcgXyhzLnoscy54LHMueSx0KTtjYXNlIDM6cmV0dXJuIG5ldyBfKC1zLnkscy54LHMueix0KTtjYXNlIDQ6cmV0dXJuIG5ldyBfKHMueCxzLnosLXMueSx0KTtjYXNlIDU6cmV0dXJuIG5ldyBfKHMueiwtcy55LHMueCx0KX19c2V0RnJvbUF4aXNBbmRBbmdsZSh0LGUpe2NvbnN0IHM9ZS8yLGE9dC5ub3JtYWxpemUoKS5zY2FsZShNYXRoLnNpbihzKSk7dGhpcy5zZXQoYS54LGEueSxhLnosTWF0aC5jb3MocykpfXNldEZyb21EaXJlY3Rpb25BbmRVcHZlY3Rvcih0LGUpe2NvbnN0IHM9bmV3IGQ7cy5zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKSx0aGlzLnNldEZyb21NYXQzKHMpfXNldEZyb20yVmVjdG9ycyh0LGUpe3Qubm9ybWFsaXplKCksZS5ub3JtYWxpemUoKTtjb25zdCBzPXQuY3Jvc3MoZSksYT10LmRvdChlKSxpPU1hdGguc3FydCgyKigxK2EpKTt0aGlzLnNldChzLngvaSxzLnkvaSxzLnovaSxpLzIpLHRoaXMubm9ybWFsaXplSW5QbGFjZSgpfXNldEZyb21NYXQzKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0rdC5fX2RhdGFbNF0rdC5fX2RhdGFbOF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzVdLXQuX19kYXRhWzddKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs2XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbM10pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzRdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVs4XT50Ll9fZGF0YVszKmUrZV0mJihlPTIpO2NvbnN0IGE9KGUrMSklMyxpPShlKzIpJTM7cz1NYXRoLnNxcnQodC5fX2RhdGFbMyplK2VdLXQuX19kYXRhWzMqYSthXS10Ll9fZGF0YVszKmkraV0rMSksdGhpcy5fX2RhdGFbZV09LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbM109KHQuX19kYXRhWzMqYStpXS10Ll9fZGF0YVszKmkrYV0pKnMsdGhpcy5fX2RhdGFbYV09KHQuX19kYXRhWzMqYStlXSt0Ll9fZGF0YVszKmUrYV0pKnMsdGhpcy5fX2RhdGFbaV09KHQuX19kYXRhWzMqaStlXSt0Ll9fZGF0YVszKmUraV0pKnN9dGhpcy5ub3JtYWxpemVJblBsYWNlKCl9c2V0RnJvbU1hdDQodCl7Y29uc3QgZT10Ll9fZGF0YVswXSt0Ll9fZGF0YVs1XSt0Ll9fZGF0YVsxMF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzZdLXQuX19kYXRhWzldKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs4XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbNF0pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzVdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVsxMF0+dC5fX2RhdGFbNCplK2VdJiYoZT0yKTtjb25zdCBhPShlKzEpJTMsaT0oZSsyKSUzO3M9TWF0aC5zcXJ0KHQuX19kYXRhWzQqZStlXS10Ll9fZGF0YVs0KmErYV0tdC5fX2RhdGFbNCppK2ldKzEpLHRoaXMuX19kYXRhW2VdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzNdPSh0Ll9fZGF0YVs0KmEraV0tdC5fX2RhdGFbNCppK2FdKSpzLHRoaXMuX19kYXRhW2FdPSh0Ll9fZGF0YVs0KmErZV0rdC5fX2RhdGFbNCplK2FdKSpzLHRoaXMuX19kYXRhW2ldPSh0Ll9fZGF0YVs0KmkrZV0rdC5fX2RhdGFbNCplK2ldKSpzfXRoaXMubm9ybWFsaXplSW5QbGFjZSgpfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy5nZXRBbmdsZSgpPE51bWJlci5FUFNJTE9OfWdldEFuZ2xlKCl7cmV0dXJuIDIqTWF0aC5hY29zKHRoaXMudyl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudz09dC53fW5vdGVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy53IT10Lnd9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy53LXQudyk8ZX1hZGQodCl7cmV0dXJuIG5ldyB1KHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudyt0LncpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy53Kz10Lnd9c3VidHJhY3QodCl7cmV0dXJuIG5ldyB1KHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudy10LncpfXNjYWxlKHQpe3JldHVybiBuZXcgdSh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLncqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10LHRoaXMudyo9dH1sZW5ndGgoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO3JldHVybiBNYXRoLnNxcnQodCp0K2UqZStzKnMrYSphKX1sZW5ndGhTcXVhcmVkKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXTtyZXR1cm4gdCp0K2UqZStzKnMrYSphfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO3JldHVybiBpPE51bWJlci5FUFNJTE9OP25ldyB1OihpPTEvTWF0aC5zcXJ0KGkpLG5ldyB1KHQqaSxlKmkscyppKSl9bm9ybWFsaXplSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO2k8TnVtYmVyLkVQU0lMT058fChpPTEvTWF0aC5zcXJ0KGkpLHRoaXMuc2V0KHQqaSxlKmkscyppLGEqaSkpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55K3RoaXMueip0LnordGhpcy53KnQud31jcm9zcyh0KXtjb25zdCBlPXRoaXMueCxzPXRoaXMueSxhPXRoaXMueixpPXRoaXMudyxyPXQueCxuPXQueSxoPXQueixvPXQudztyZXR1cm4gbmV3IHUocypoLWEqbixhKm8taSpoLGkqci1lKm8sZSpuLXMqcil9Y29uanVnYXRlKCl7cmV0dXJuIG5ldyB1KC10aGlzLngsLXRoaXMueSwtdGhpcy56LHRoaXMudyl9aW52ZXJzZSgpe3JldHVybiB0aGlzLmNvbmp1Z2F0ZSgpfWFsaWduV2l0aCh0KXt0aGlzLmRvdCh0KTwwJiZ0aGlzLnNldCgtdGhpcy54LC10aGlzLnksLXRoaXMueiwtdGhpcy53KX1tdWx0aXBseSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLHM9dGhpcy5fX2RhdGFbMV0sYT10aGlzLl9fZGF0YVsyXSxpPXRoaXMuX19kYXRhWzNdLHI9dC5fX2RhdGFbMF0sbj10Ll9fZGF0YVsxXSxoPXQuX19kYXRhWzJdLG89dC5fX2RhdGFbM107cmV0dXJuIG5ldyB1KGUqbytpKnIrcypoLWEqbixzKm8raSpuK2Eqci1lKmgsYSpvK2kqaCtlKm4tcypyLGkqby1lKnItcypuLWEqaCl9bXVsdGlwbHlJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10Ll9fZGF0YVswXSxuPXQuX19kYXRhWzFdLGg9dC5fX2RhdGFbMl0sbz10Ll9fZGF0YVszXTt0aGlzLnNldChlKm8raSpyK3MqaC1hKm4scypvK2kqbithKnItZSpoLGEqbytpKmgrZSpuLXMqcixpKm8tZSpyLXMqbi1hKmgpfXJvdGF0ZVZlYzModCl7Y29uc3QgZT1uZXcgdSh0LngsdC55LHQueiwwKSxzPXRoaXMubXVsdGlwbHkoZSkubXVsdGlwbHkodGhpcy5jb25qdWdhdGUoKSk7cmV0dXJuIG5ldyByKHMueCxzLnkscy56KX1yb3RhdGVYKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK2kqcix0aGlzLnk9cypuK2Eqcix0aGlzLno9YSpuLXMqcix0aGlzLnc9aSpuLWUqcn1yb3RhdGVZKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuLWEqcix0aGlzLnk9cypuK2kqcix0aGlzLno9YSpuK2Uqcix0aGlzLnc9aSpuLXMqcn1yb3RhdGVaKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK3Mqcix0aGlzLnk9cypuLWUqcix0aGlzLno9YSpuK2kqcix0aGlzLnc9aSpuLWEqcn10b01hdDMoKXtjb25zdCB0PXRoaXMueCxlPXRoaXMueSxzPXRoaXMueixhPXRoaXMudyxpPXQrdCxyPWUrZSxuPXMrcyxoPXQqaSxvPWUqaSxfPWUqcixsPXMqaSxjPXMqcix1PXMqbixmPWEqaSxtPWEqcixnPWEqbix5PW5ldyBkO3JldHVybiB5Ll9fZGF0YVswXT0xLV8tdSx5Ll9fZGF0YVszXT1vLWcseS5fX2RhdGFbNl09bCttLHkuX19kYXRhWzFdPW8rZyx5Ll9fZGF0YVs0XT0xLWgtdSx5Ll9fZGF0YVs3XT1jLWYseS5fX2RhdGFbMl09bC1tLHkuX19kYXRhWzVdPWMrZix5Ll9fZGF0YVs4XT0xLWgtXyx5fWdldFhheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy55LGU9dGhpcy54KnRoaXMueixzPXRoaXMueSp0aGlzLnksYT10aGlzLnkqdGhpcy53LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDEtMiooaStzKSwyKih0K24pLDIqKGUtYSkpfWdldFlheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueSxzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy56LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDIqKGUtbiksMS0yKihpK3QpLDIqKGErcykpfWdldFpheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueixzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy55LGk9dGhpcy55KnRoaXMueixuPXRoaXMueSp0aGlzLnc7bmV3IHI7cmV0dXJuIG5ldyByKDIqKG4rZSksMiooaS1zKSwxLTIqKGErdCkpfW1pcnJvcih0KXtzd2l0Y2godCl7Y2FzZSAwOnJldHVybiBuZXcgdSh0aGlzLnosdGhpcy53LHRoaXMueCx0aGlzLnkpO2Nhc2UgMTpyZXR1cm4gbmV3IHUoLXRoaXMudyx0aGlzLnosdGhpcy55LC10aGlzLngpO2Nhc2UgMjpyZXR1cm4gbmV3IHUodGhpcy54LHRoaXMueSx0aGlzLnosLXRoaXMudyl9fXRvTWF0NCgpe2NvbnN0IHQ9dGhpcy54LGU9dGhpcy55LHM9dGhpcy56LGE9dGhpcy53LGk9dCt0LHI9ZStlLG49cytzLGg9dCppLG89ZSppLF89ZSpyLGQ9cyppLGM9cypyLHU9cypuLGY9YSppLG09YSpyLGc9YSpuLHk9bmV3IGw7cmV0dXJuIHkuX19kYXRhWzBdPTEtXy11LHkuX19kYXRhWzRdPW8tZyx5Ll9fZGF0YVs4XT1kK20seS5fX2RhdGFbMV09bytnLHkuX19kYXRhWzVdPTEtaC11LHkuX19kYXRhWzldPWMtZix5Ll9fZGF0YVsyXT1kLW0seS5fX2RhdGFbNl09YytmLHkuX19kYXRhWzEwXT0xLWgtXyx5fWxlcnAodCxlKXtjb25zdCBzPW5ldyB1KHRoaXMueCtlKih0LngtdGhpcy54KSx0aGlzLnkrZSoodC55LXRoaXMueSksdGhpcy56K2UqKHQuei10aGlzLnopLHRoaXMudytlKih0LnctdGhpcy53KSk7cmV0dXJuIHMubm9ybWFsaXplSW5QbGFjZSgpLHN9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHUoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IHUodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fWNsb25lKCl7cmV0dXJuIG5ldyB1KHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnksejp0aGlzLnosdzp0aGlzLnd9fWZyb21KU09OKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQudyx0aGlzLm5vcm1hbGl6ZUluUGxhY2UoKX19YS5yZWdpc3RlclR5cGUoIlF1YXQiLHUpO2NsYXNzIGZ7Y29uc3RydWN0b3IodCxlKXt0aGlzLnN0YXJ0PXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5kaXI9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcn1jbG9zZXN0UG9pbnQodCl7Y29uc3QgZT10LnN1YnRyYWN0KHRoaXMuc3RhcnQpLmRvdCh0aGlzLmRpcik7aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdGhpcy5zdGFydDtjb25zdCBzPWUvdGhpcy5kaXIuZG90KHRoaXMuZGlyKTtyZXR1cm4gdGhpcy5zdGFydC5hZGQodGhpcy5kaXIuc2NhbGUocykpfXBvaW50QXREaXN0KHQpe3JldHVybiB0aGlzLnN0YXJ0LmFkZCh0aGlzLmRpci5zY2FsZSh0KSl9aW50ZXJzZWN0UmF5VmVjdG9yKHQpe2NvbnN0IGU9dGhpcy5kaXIscz10LmRpcixhPXRoaXMuc3RhcnQuc3VidHJhY3QodC5zdGFydCksaT1lLmRvdChlKSxyPWUuZG90KHMpLG49cy5kb3QocyksaD1lLmRvdChhKSxvPXMuZG90KGEpO2lmKDA9PWkmJjA9PW4pcmV0dXJuIHRoaXMuc3RhcnQuZGlzdGFuY2VUbyh0LnN0YXJ0KTtpZigwPT1pKXJldHVybiB0LmNsb3Nlc3RQb2ludCh0aGlzLnN0YXJ0KTtpZigwPT1uKXJldHVybiB0aGlzLmNsb3Nlc3RQb2ludCh0LnN0YXJ0KTtjb25zdCBfPWkqbi1yKnI7bGV0IGQsbDtyZXR1cm4gXzwuMDAxPyhkPTAsbD1yPm4/aC9yOm8vbik6KGQ9KHIqby1uKmgpL18sbD0oaSpvLXIqaCkvXyksW2QsbF19aW50ZXJzZWN0UmF5UGxhbmUodCl7Y29uc3QgZT10aGlzLnN0YXJ0LnN1YnRyYWN0KHQuc3RhcnQpLHM9dC5kaXIuZG90KHRoaXMuZGlyKSxhPS10LmRpci5kb3QoZSk7aWYoTWF0aC5hYnMocyk8TnVtYmVyLlBSRUNJU0lPTilyZXR1cm4tMTtjb25zdCBpPWEvcztyZXR1cm4gaTwtTnVtYmVyLlBSRUNJU0lPTj8tMTppfWNsb25lKCl7cmV0dXJuIG5ldyBmKHRoaXMuc3RhcnQuY2xvbmUoKSx0aGlzLmRpci5jbG9uZSgpKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgZiguLi50KX10b0pTT04oKXtyZXR1cm57c3RhcnQ6dGhpcy5zdGFydCxkaXI6dGhpcy5kaXJ9fWZyb21KU09OKHQpe3RoaXMuc3RhcnQuZnJvbUpTT04odC5zdGFydCksdGhpcy5kaXIuZnJvbUpTT04odC5kaXIpfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWEucmVnaXN0ZXJUeXBlKCJSYXkiLGYpO25ldyByKDEsMSwxKTtjbGFzcyBte2NvbnN0cnVjdG9yKHQsZSxzKXtpZih0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuc2V0RnJvbUZsb2F0MzJBcnJheSh0KTtlbHNle2lmKHQgaW5zdGFuY2VvZiByKXRoaXMudHI9dDtlbHNle2lmKHQgaW5zdGFuY2VvZiB1JiZudWxsPT1lJiZudWxsPT1zKXJldHVybiB0aGlzLnRyPW5ldyByLHRoaXMub3JpPXQsdm9pZCh0aGlzLnNjPW5ldyByKDEsMSwxKSk7dGhpcy50cj1uZXcgcn10aGlzLm9yaT1lIGluc3RhbmNlb2YgdT9lOm5ldyB1LHRoaXMuc2M9cyBpbnN0YW5jZW9mIHI/czpuZXcgcigxLDEsMSl9fXNldCh0LGUscyl7dGhpcy50cj10LHRoaXMub3JpPWUscyBpbnN0YW5jZW9mIHImJih0aGlzLnNjPXMpfXNldEZyb21PdGhlcih0KXt0aGlzLnRyPXQudHIsdGhpcy5vcmk9dC5vcmksdGhpcy5zYz10LnNjfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy50ci5pc051bGwoKSYmdGhpcy5vcmkuaXNJZGVudGl0eSgpJiZ0aGlzLnNjLmlzMTExKCl9c2V0TG9va0F0KHQsZSxzKXtjb25zdCBhPXQuc3VidHJhY3QoZSk7aWYoYS5sZW5ndGgoKTxOdW1iZXIuRVBTSUxPTil0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGlyIik7dGhpcy5vcmkuc2V0RnJvbURpcmVjdGlvbkFuZFVwdmVjdG9yKGEscyksdGhpcy50cj10fW11bHRpcGx5KHQpe2xldCBlPXRoaXMuc2M7cmV0dXJuIHRoaXMuc2MueD09dGhpcy5zYy55JiZ0aGlzLnNjLng9PXRoaXMuc2Muenx8KGU9dC5vcmkucm90YXRlVmVjMyh0aGlzLnNjKSxNYXRoLnNpZ24oZS54KSE9TWF0aC5zaWduKHRoaXMuc2MueCkmJihlLng9LWUueCksTWF0aC5zaWduKGUueSkhPU1hdGguc2lnbih0aGlzLnNjLnkpJiYoZS55PS1lLnkpLE1hdGguc2lnbihlLnopIT1NYXRoLnNpZ24odGhpcy5zYy56KSYmKGUuej0tZS56KSksbmV3IG0odGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyhlLm11bHRpcGx5KHQudHIpKSksdGhpcy5vcmkubXVsdGlwbHkodC5vcmkpLGUubXVsdGlwbHkodC5zYykpfWludmVyc2UoKXtjb25zdCB0PW5ldyBtO3JldHVybiB0Lm9yaT10aGlzLm9yaS5pbnZlcnNlKCksdGhpcy5zYy54IT10aGlzLnNjLnl8fHRoaXMuc2MueCE9dGhpcy5zYy56Pyh0LnNjPXQub3JpLnJvdGF0ZVZlYzModGhpcy5zYyksTWF0aC5zaWduKHQuc2MueCkhPU1hdGguc2lnbih0aGlzLnNjLngpJiYodC5zYy54PS10LnNjLngpLE1hdGguc2lnbih0LnNjLnkpIT1NYXRoLnNpZ24odGhpcy5zYy55KSYmKHQuc2MueT0tdC5zYy55KSxNYXRoLnNpZ24odC5zYy56KSE9TWF0aC5zaWduKHRoaXMuc2MueikmJih0LnNjLno9LXQuc2MueikpOnQuc2M9dGhpcy5zYy5pbnZlcnNlKCksdC50cj10Lm9yaS5yb3RhdGVWZWMzKHRoaXMudHIubmVnYXRlKCkubXVsdGlwbHkodC5zYykpLHR9dHJhbnNmb3JtVmVjMyh0KXtyZXR1cm4gdGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyh0aGlzLnNjLm11bHRpcGx5KHQpKSl9dG9NYXQ0KCl7Y29uc3QgdD1uZXcgbCh0aGlzLnNjLngsMCwwLDAsMCx0aGlzLnNjLnksMCwwLDAsMCx0aGlzLnNjLnosMCwwLDAsMCwxKSxlPXRoaXMub3JpLnRvTWF0NCgpLHM9bmV3IGw7cmV0dXJuIHMudHJhbnNsYXRpb249dGhpcy50cixzLm11bHRpcGx5KGUpLm11bHRpcGx5KHQpfWZyb21NYXQ0KHQpe3RoaXMudHI9dC50cmFuc2xhdGlvbix0aGlzLm9yaS5zZXRGcm9tTWF0NCh0KX1zZXRGcm9tRmxvYXQzMkFycmF5KHQpe2lmKDc9PXQubGVuZ3RoKXJldHVybiB0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIoMSwxLDEpKTtpZig4IT10Lmxlbmd0aClyZXR1cm4gMTA9PXQubGVuZ3RoPyh0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzIxKSkpOnZvaWQgMDt7dGhpcy50cj1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMub3JpPW5ldyB1KHQuYnVmZmVyLHQuYnl0ZU9mZnNldCsxMik7Y29uc3QgZT10WzddO3RoaXMuc2M9bmV3IHIoZSxlLGUpfX1jbG9uZSgpe3JldHVybiBuZXcgbSh0aGlzLnRyLmNsb25lKCksdGhpcy5vcmkuY2xvbmUoKSx0aGlzLnNjLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBtKC4uLnQpfXRvSlNPTigpe2NvbnN0IHQ9e3RyOnRoaXMudHIudG9KU09OKCksb3JpOnRoaXMub3JpLnRvSlNPTigpfTtyZXR1cm4gdGhpcy5zYy5pczExMSgpfHwodC5zYz10aGlzLnNjLnRvSlNPTigpKSx0fWZyb21KU09OKHQpe3RoaXMudHIuZnJvbUpTT04odC50ciksdGhpcy5vcmkuZnJvbUpTT04odC5vcmkpLHQuc2MmJnRoaXMuc2MuZnJvbUpTT04odC5zYyl9dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlhmbyIsbSk7Y2xhc3MgZ3tjb25zdHJ1Y3Rvcih0LGUpe3RoaXMucDA9dCBpbnN0YW5jZW9mIGk/dDpuZXcgaShOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSx0aGlzLnAxPWUgaW5zdGFuY2VvZiBpP2U6bmV3IGkoTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSl9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9aXNWYWxpZCgpe3JldHVybiB0aGlzLnAwLnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueSE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnkhPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXsodGhpcy5wMC54PT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFl8fHQueDx0aGlzLnAwLngpJiYodGhpcy5wMC54PXQueCksKHRoaXMucDAueT09TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZfHx0Lnk8dGhpcy5wMC55KSYmKHRoaXMucDAueT10LnkpLCh0aGlzLnAxLnk9PU51bWJlci5ORUdBVElWRV9JTkZJTklUWXx8dC54PnRoaXMucDEueCkmJih0aGlzLnAxLng9dC54KSwodGhpcy5wMS55PT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl8fHQueT50aGlzLnAxLnkpJiYodGhpcy5wMS55PXQueSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGcoLi4udCl9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKX19dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIkJveDIiLGcpO2NsYXNzIHkgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQsZT0wKXtzdXBlcigpLHRoaXMucG9zPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5yYWRpdXM9ZX1jbG9uZSgpe3JldHVybiBuZXcgU3BoZXJlKHRoaXMucG9zLmNsb25lKCksdGhpcy5yYWRpdXMpfWludGVyc2VjdHNCb3godCl7cmV0dXJuIHQuaW50ZXJzZWN0c1NwaGVyZSh0aGlzKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgU3BoZXJlKC4uLnQpfXRvSlNPTigpe3JldHVybntwb3M6dGhpcy5wb3MudG9KU09OKCkscmFkaXVzOnRoaXMucmFkaXVzfX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiU3BoZXJlVHlwZSIseSk7Y2xhc3MgcHtjb25zdHJ1Y3Rvcih0LGUpe3QgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXk/dGhpcy5zZXRGcm9tRmxvYXQzMkFycmF5KHQpOih0aGlzLnAwPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIoTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpLHRoaXMucDE9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcihOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSkpfWdldCBtaW4oKXtyZXR1cm4gdGhpcy5wMH1nZXQgbWF4KCl7cmV0dXJuIHRoaXMucDF9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksdGhpcy5wMC56PU51bWJlci5QT1NJVElWRV9JTkZJTklUWSx0aGlzLnAxLno9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZfWlzVmFsaWQoKXtyZXR1cm4gdGhpcy5wMC54IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnRoaXMucDEueCE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiZ0aGlzLnAwLnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueiE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnohPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXt0LnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lng8dGhpcy5wMC54JiYodGhpcy5wMC54PXQueCksdC54PnRoaXMucDEueCYmKHRoaXMucDEueD10LngpKSx0LnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lnk8dGhpcy5wMC55JiYodGhpcy5wMC55PXQueSksdC55PnRoaXMucDEueSYmKHRoaXMucDEueT10LnkpKSx0LnohPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC56IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lno8dGhpcy5wMC56JiYodGhpcy5wMC56PXQueiksdC56PnRoaXMucDEueiYmKHRoaXMucDEuej10LnopKX1hZGRCb3gzKHQsZSl7ZT8odGhpcy5hZGRQb2ludChlLnRyYW5zZm9ybVZlYzModC5wMCkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKHQucDEpKSk6KHRoaXMuYWRkUG9pbnQodC5wMCksdGhpcy5hZGRQb2ludCh0LnAxKSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9dG9NYXQ0KCl7Y29uc3QgdD10aGlzLnAxLngtdGhpcy5wMC54LGU9dGhpcy5wMS55LXRoaXMucDAueSxzPXRoaXMucDEuei10aGlzLnAwLno7cmV0dXJuIG5ldyBsKHQsMCwwLDAsMCxlLDAsMCwwLDAscywwLHRoaXMucDAueCx0aGlzLnAwLnksdGhpcy5wMC56LDEpfWdldEJvdW5kaW5nU3BoZXJlKCl7cmV0dXJuIG5ldyB5KHRoaXMuY2VudGVyKCksLjUqdGhpcy5kaWFnb25hbCgpLmxlbmd0aCgpKX1pbnRlcnNlY3RzQm94KHQpe3JldHVybiEodC5tYXgueDx0aGlzLm1pbi54fHx0Lm1pbi54PnRoaXMubWF4Lnh8fHQubWF4Lnk8dGhpcy5taW4ueXx8dC5taW4ueT50aGlzLm1heC55fHx0Lm1heC56PHRoaXMubWluLnp8fHQubWluLno+dGhpcy5tYXgueil9aW50ZXJzZWN0c1NwaGVyZSh0KXtyZXR1cm4gY2xvc2VzdFBvaW50LmRpc3RhbmNlVG9TcXVhcmVkKHQuY2VudGVyKTw9dC5yYWRpdXMqdC5yYWRpdXN9aW50ZXJzZWN0c1BsYW5lKHQpe2xldCBlLHM7cmV0dXJuIHQubm9ybWFsLng+MD8oZT10Lm5vcm1hbC54KnRoaXMubWluLngscz10Lm5vcm1hbC54KnRoaXMubWF4LngpOihlPXQubm9ybWFsLngqdGhpcy5tYXgueCxzPXQubm9ybWFsLngqdGhpcy5taW4ueCksdC5ub3JtYWwueT4wPyhlKz10Lm5vcm1hbC55KnRoaXMubWluLnkscys9dC5ub3JtYWwueSp0aGlzLm1heC55KTooZSs9dC5ub3JtYWwueSp0aGlzLm1heC55LHMrPXQubm9ybWFsLnkqdGhpcy5taW4ueSksdC5ub3JtYWwuej4wPyhlKz10Lm5vcm1hbC56KnRoaXMubWluLnoscys9dC5ub3JtYWwueip0aGlzLm1heC56KTooZSs9dC5ub3JtYWwueip0aGlzLm1heC56LHMrPXQubm9ybWFsLnoqdGhpcy5taW4ueiksZTw9LXQuY29uc3RhbnQmJnM+PS10LmNvbnN0YW50fWNsb25lKCl7cmV0dXJuIG5ldyBwKHRoaXMucDAuY2xvbmUoKSx0aGlzLnAxLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBwKC4uLnQpfXN0YXRpYyBzaXplSW5CeXRlcygpe3JldHVybiAyNH10b0pTT04oKXtyZXR1cm57cDA6dGhpcy5wMC50b0pTT04oKSxwMTp0aGlzLnAxLnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSl9bG9hZEJpbih0LGUpe3RoaXMucDAubG9hZEJpbih0LGUpLHRoaXMucDAubG9hZEJpbih0LGUrMTIpfXNldEZyb21GbG9hdDMyQXJyYXkodCl7dGhpcy5wMD1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMucDE9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiQm94MyIscCk7Y2xhc3MgeCBleHRlbmRzIHN7Y29uc3RydWN0b3IodCxlPTApe3N1cGVyKCksdGhpcy5ub3JtYWw9dCBpbnN0YW5jZW9mIHI/dDpuZXcgcix0aGlzLnc9ZX1zZXQodCxlLHMsYSl7dGhpcy5ub3JtYWwuc2V0KHQsZSxzKSx0aGlzLnc9YX1kaXZpZGVTY2FsYXIodCl7dGhpcy5ub3JtYWwuc2NhbGVJblBsYWNlKDEvdCksdGhpcy53Lz10fWRpc3RhbmNlVG9Qb2ludCh0KXtyZXR1cm4gdC5kb3QodGhpcy5ub3JtYWwpK3RoaXMud31ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD0xL3RoaXMubm9ybWFsLmxlbmd0aCgpO3RoaXMubm9ybWFsLnNjYWxlSW5QbGFjZSh0KSx0aGlzLncqPXR9Y2xvbmUoKXtyZXR1cm4gbmV3IFBsYW5lKHRoaXMubm9ybWFsLmNsb25lKCksdGhpcy53KX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgUGxhbmUoLi4udCl9dG9KU09OKCl7cmV0dXJue25vcm1hbDp0aGlzLm5vcm1hbC50b0pTT04oKSx3OnRoaXMud319dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlBsYW5lVHlwZSIseCk7YS5yZWdpc3RlclR5cGUoIkZydXN0dW0iLGNsYXNze2NvbnN0cnVjdG9yKHQsZSxzLGEsaSxyKXt0aGlzLnBsYW5lcz1bdHx8bmV3IHgsZXx8bmV3IHgsc3x8bmV3IHgsYXx8bmV3IHgsaXx8bmV3IHgscnx8bmV3IHhdfXNldEZyb21NYXRyaXgodCl7Y29uc3QgZT10LHM9dGhpcy5wbGFuZXM7c1swXS5zZXQoZS5tMDMtZS5tMDAsZS5tMTMtZS5tMTAsZS5tMjMtZS5tMjAsZS5tMzMtZS5tMzApLHNbMV0uc2V0KGUubTAzK2UubTAwLGUubTEzK2UubTEwLGUubTIzK2UubTIwLGUubTMzK2UubTMwKSxzWzJdLnNldChlLm0wMytlLm0wMSxlLm0xMytlLm0xMSxlLm0yMytlLm0yMSxlLm0zMytlLm0zMSksc1szXS5zZXQoZS5tMDMtZS5tMDEsZS5tMTMtZS5tMTEsZS5tMjMtZS5tMjEsZS5tMzMtZS5tMzEpLHNbNF0uc2V0KGUubTAzLWUubTAyLGUubTEzLWUubTEyLGUubTIzLWUubTIyLGUubTMzLWUubTMyKSxzWzVdLnNldChlLm0wMytlLm0wMixlLm0xMytlLm0xMixlLm0yMytlLm0yMixlLm0zMytlLm0zMikscy5mb3JFYWNoKHQ9PnQubm9ybWFsaXplSW5QbGFjZSgpKX1pbnRlcnNlY3RzQm94KHQpe2NvbnN0IGU9bmV3IHIscz10aGlzLnBsYW5lcyx7bWluOmEsbWF4Oml9PXQ7Zm9yKGxldCB0PTA7dDw2O3QrKyl7Y29uc3Qgcj1zW3RdO2lmKGUueD1yLm5vcm1hbC54PjA/aS54OmEueCxlLnk9ci5ub3JtYWwueT4wP2kueTphLnksZS56PXIubm9ybWFsLno+MD9pLno6YS56LHIuZGlzdGFuY2VUb1BvaW50KGUpPDApcmV0dXJuITF9cmV0dXJuITB9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKSxwMjp0aGlzLnAyLnRvSlNPTigpLHAzOnRoaXMucDMudG9KU09OKCkscDQ6dGhpcy5wNC50b0pTT04oKSxwNTp0aGlzLnA1LnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSksdGhpcy5wMi5mcm9tSlNPTih0LnAyKSx0aGlzLnAzLmZyb21KU09OKHQucDMpLHRoaXMucDQuZnJvbUpTT04odC5wNCksdGhpcy5wNS5mcm9tSlNPTih0LnA1KX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX0pO2NsYXNzIHd7Y29uc3RydWN0b3IodD0hMSl7dGhpcy5fX3Nsb3RzPVtdLHRoaXMuX190b2dnbGVkU2lnbmFsPXQsdGhpcy5fX3RvZ2dsZWQ9ITEsdGhpcy5fX2RhdGE9bnVsbCx0aGlzLmNvbm5lY3Q9dGhpcy5jb25uZWN0LmJpbmQodGhpcyksdGhpcy5kaXNjb25uZWN0PXRoaXMuZGlzY29ubmVjdC5iaW5kKHRoaXMpLHRoaXMuZW1pdD10aGlzLmVtaXQuYmluZCh0aGlzKX1jb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5jb25uZWN0Iik7aWYoLTEhPXRoaXMuX19zbG90cy5pbmRleE9mKHQpKXJldHVybiB2b2lkIGNvbnNvbGUud2FybigiZm4gJyIrdC5uYW1lKyInIGFscmVhZHkgY29ubmVjdGVkIHRvIFNpZ25hbC4iKTtjb25zdCBlPXRoaXMuX19zbG90cy5sZW5ndGg7cmV0dXJuIHRoaXMuX19zbG90c1tlXT10LHRoaXMuX190b2dnbGVkU2lnbmFsJiZ0aGlzLl9fdG9nZ2xlZCYmKHRoaXMuX19kYXRhP3QoLi4udGhpcy5fX2RhdGEpOnQoKSksZX1kaXNjb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5kaXNjb25uZWN0Iik7Y29uc3QgZT1bXTtpZih0aGlzLl9fc2xvdHMuZm9yRWFjaCgoZnVuY3Rpb24ocyxhKXtzPT09dCYmZS5wdXNoKGEpfSkpLDAhPWUubGVuZ3RoKWZvcihjb25zdCB0IG9mIGUpdGhpcy5fX3Nsb3RzW3RdPXZvaWQgMDtlbHNlIGNvbnNvbGUud2FybigiY2FsbGJhY2sgOiIrdC5uYW1lKyIgd2FzIG5vdCBjb25uZWN0ZWQgdG8gdGhpcyBzaWduYWw6Iit0aGlzLl9fbmFtZSl9ZGlzY29ubmVjdElkKHQpe2lmKCF0aGlzLl9fc2xvdHNbdF0pdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIElEIik7dGhpcy5fX3Nsb3RzW3RdPXZvaWQgMH1lbWl0KC4uLnQpe3RoaXMuX190b2dnbGVkU2lnbmFsJiYodGhpcy5fX3RvZ2dsZWQ/Y29uc29sZS53YXJuKCJUb2dnbGVkIHNpZ25hbHMgc2hvdWxkIG9ubHkgYmUgZmlyZWQgb25jZSwgb3IgdW50b2dnbGVkIGJlZm9yZSByZS1maXJpbmcuLiIpOih0aGlzLl9fdG9nZ2xlZD0hMCx0aGlzLl9fZGF0YT10KSk7Y29uc3QgZT10aGlzLl9fc2xvdHMubGVuZ3RoO2ZvcihsZXQgcz0wO3M8ZTtzKyspe2NvbnN0IGU9dGhpcy5fX3Nsb3RzW3NdO2UmJmUoLi4udCl9fWlzVG9nZ2xlZCgpe3JldHVybiB0aGlzLl9fdG9nZ2xlZH1zZXRUb2dnbGVkKHQpe3RoaXMuX190b2dnbGVkPXQsdGhpcy5fX2RhdGE9dm9pZCAwfWdldE51bUNvbm5lY3Rpb25zKCl7cmV0dXJuIHRoaXMuX19zbG90cy5sZW5ndGh9dW50b2dnbGUoKXt0aGlzLl9fdG9nZ2xlZD0hMSx0aGlzLl9fZGF0YT12b2lkIDB9fWNvbnN0IEk9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzPXt9LHRoaXMuX19jbGFzc05hbWVzPXt9LHRoaXMuX19jbGFzc0xpc3Q9W119cmVnaXN0ZXJDbGFzcyh0LGUpe3RoaXMuX19yZWdpc3RlcmVkQ2xhc3Nlc1t0XT17Y2xzOmUsY2FsbGJhY2tzOltdfTtjb25zdCBzPXRoaXMuX19jbGFzc0xpc3QubGVuZ3RoO3RoaXMuX19jbGFzc0xpc3QucHVzaChlKSx0aGlzLl9fY2xhc3NOYW1lc1tzXT10fWdldENsYXNzKHQpe2lmKHRoaXMuX19yZWdpc3RlcmVkQ2xhc3Nlc1t0XSlyZXR1cm4gdGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdLmNsc31nZXRDbGFzc05hbWUodCl7Y29uc3QgZT10aGlzLl9fY2xhc3NMaXN0LmluZGV4T2YodC5jb25zdHJ1Y3Rvcik7cmV0dXJuIHRoaXMuX19jbGFzc05hbWVzW2VdP3RoaXMuX19jbGFzc05hbWVzW2VdOihjb25zb2xlLndhcm4oIkNsYXNzIG5vdCByZWdpc3RlcmVkOiIsdC5jb25zdHJ1Y3Rvci5uYW1lKSx0LmNvbnN0cnVjdG9yLm5hbWUpfWNvbnN0cnVjdENsYXNzKHQpe2NvbnN0IGU9dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdO2lmKCFlKXJldHVybiBjb25zb2xlLndhcm4oIkZhY3Rvcnkgbm90IHJlZ2lzdGVyZWQ6Iit0KSxudWxsO3RoaXMuX19jb25zdHJ1Y3Rpbmc9ITA7Y29uc3Qgcz1BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsMSksYT1uZXcgZS5jbHMoLi4ucyk7cmV0dXJuIHRoaXMuX19jb25zdHJ1Y3Rpbmc9ITEsYX19LE49MyxGPTI7bGV0IHo9MDtjbGFzcyBWe2NvbnN0cnVjdG9yKHQsZSxzKXtpZih0aGlzLl9fZGF0YVR5cGU9dCx0aGlzLm5vcm1hbGl6ZWQ9ITEsbnVsbCE9dC5udW1FbGVtZW50cyl0aGlzLl9fZGltZW5zaW9uPXRoaXMuX19kYXRhVHlwZS5udW1FbGVtZW50cygpO2Vsc2Ugc3dpdGNoKHQpe2Nhc2UgNjpjYXNlIDQ6Y2FzZSA1OnRoaXMuX19kaW1lbnNpb249MTticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiSW52YWxpZCBkYXRhIHR5cGUgZm9yIGF0dHJpYnV0ZToiK3QpfXZhciBhO3RoaXMuX19kZWZhdWx0RWxlbWVudFZhbHVlPW51bGwhPXM/czpOdW1iZXIuTUFYX1ZBTFVFLChhPWUpJiZ2b2lkIDAhPT1hLmJ5dGVMZW5ndGg/dGhpcy5fX2RhdGE9ZToodGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShlKnRoaXMuX19kaW1lbnNpb24pLHRoaXMuaW5pdFJhbmdlKDApKX1yZXNpemUodCl7Y29uc3QgZT10aGlzLl9fZGF0YS5sZW5ndGgscz10KnRoaXMuX19kaW1lbnNpb24sYT1uZXcgRmxvYXQzMkFycmF5KHMpO2ZvcihsZXQgdD0wO3Q8TWF0aC5taW4odGhpcy5fX2RhdGEubGVuZ3RoLHMpO3QrKylhW3RdPXRoaXMuX19kYXRhW3RdO3RoaXMuX19kYXRhLmxlbmd0aDxzJiYodGhpcy5fX2RhdGE9YSksdGhpcy5pbml0UmFuZ2UoZSl9aW5pdFJhbmdlKHQpe2ZvcihsZXQgZT10O2U8dGhpcy5fX2RhdGEubGVuZ3RoO2UrKyl0aGlzLl9fZGF0YVtlXT10aGlzLl9fZGVmYXVsdEVsZW1lbnRWYWx1ZX1nZXRDb3VudCgpe3JldHVybiB0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn1nZXQgbGVuZ3RoKCl7cmV0dXJuIHRoaXMuX19kYXRhLmxlbmd0aC90aGlzLl9fZGltZW5zaW9ufWdldCBkYXRhVHlwZSgpe3JldHVybiB0aGlzLl9fZGF0YVR5cGV9Z2V0IGRhdGEoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c2V0IGRhdGEodCl7dGhpcy5fX2RhdGE9dH1nZXQgbnVtRWxlbWVudHMoKXtyZXR1cm4gdGhpcy5fX2RpbWVuc2lvbn1nZXRGbG9hdDMyVmFsdWUodCl7cmV0dXJuIHRoaXMuX19kYXRhW3RdfXNldEZsb2F0MzJWYWx1ZSh0LGUpe3RoaXMuX19kYXRhW3RdPWV9Z2V0VmFsdWVSZWYodCl7Y29uc3QgZT10aGlzLl9fZGltZW5zaW9uO2lmKHQ+PXRoaXMuX19kYXRhLmxlbmd0aC9lKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCB2ZXJ0ZXggaW5kZXg6Iit0KyIuIE51bSBWZXJ0aWNlczoiK3RoaXMuX19kYXRhLmxlbmd0aC8zKTtyZXR1cm4gdGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlcix0KmUpfXNldFZhbHVlKHQsZSl7Y29uc3Qgcz10aGlzLl9fZGltZW5zaW9uO2lmKHQ+PXRoaXMuX19kYXRhLmxlbmd0aC9zKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCB2ZXJ0ZXggaW5kZXg6Iit0KyIuIE51bSBWZXJ0aWNlczoiK3RoaXMuX19kYXRhLmxlbmd0aC8zKTt0aGlzLl9fZGF0YVR5cGUuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLHQqcykuc2V0RnJvbU90aGVyKGUpfXRvSlNPTih0LGUpe3JldHVybntkYXRhOkFycmF5LmZyb20odGhpcy5fX2RhdGEpLGRhdGFUeXBlOmEuZ2V0VHlwZU5hbWUodGhpcy5fX2RhdGFUeXBlKSxkZWZhdWx0VmFsdWU6dGhpcy5fX2RlZmF1bHRFbGVtZW50VmFsdWUsbGVuZ3RoOnRoaXMuX19kYXRhLmxlbmd0aC90aGlzLl9fZGltZW5zaW9ufX1mcm9tSlNPTih0KXt0aGlzLl9fZGF0YT1GbG9hdDMyQXJyYXkuZnJvbSh0LmRhdGEpfXRvU3RyaW5nKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCksbnVsbCwyKX19Y2xhc3MgTSBleHRlbmRzIGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX2lkPSsreix0aGlzLl9fcGFyYW1zPVtdLHRoaXMuX19wYXJhbU1hcHBpbmc9e30sdGhpcy5fX3BhcmFtU2lnbmFsSWRzPXt9LHRoaXMucGFyYW1ldGVyQWRkZWQ9bmV3IHcsdGhpcy5wYXJhbWV0ZXJSZW1vdmVkPW5ldyB3LHRoaXMucGFyYW1ldGVyVmFsdWVDaGFuZ2VkPW5ldyB3fWdldElkKCl7cmV0dXJuIHRoaXMuX19pZH1udW1QYXJhbWV0ZXJzKCl7cmV0dXJuIHRoaXMuX19wYXJhbXMubGVuZ3RofWdldFBhcmFtZXRlcnMoKXtyZXR1cm4gdGhpcy5fX3BhcmFtc31nZXRQYXJhbWV0ZXJJbmRleCh0KXtyZXR1cm4gdGhpcy5fX3BhcmFtTWFwcGluZ1t0XX1nZXRQYXJhbWV0ZXJCeUluZGV4KHQpe3JldHVybiB0aGlzLl9fcGFyYW1zW3RdfWhhc1BhcmFtZXRlcih0KXtyZXR1cm4gdCBpbiB0aGlzLl9fcGFyYW1NYXBwaW5nfWdldFBhcmFtZXRlcih0KXtjb25zdCBlPXRoaXMuX19wYXJhbU1hcHBpbmdbdF07cmV0dXJuLTE9PWU/bnVsbDp0aGlzLl9fcGFyYW1zW2VdfV9fcGFyYW1ldGVyVmFsdWVDaGFuZ2VkKHQsZSl7dGhpcy5wYXJhbWV0ZXJWYWx1ZUNoYW5nZWQuZW1pdCh0LGUpfWFkZFBhcmFtZXRlcih0KXtjb25zdCBlPXQuZ2V0TmFtZSgpO3JldHVybiBudWxsIT10aGlzLl9fcGFyYW1NYXBwaW5nW2VdJiYoY29uc29sZS53YXJuKCJSZXBsYWNpbmcgUGFyYW1ldGVyOiIrZSksdGhpcy5yZW1vdmVQYXJhbWV0ZXIoZSkpLHRoaXMuX19wYXJhbVNpZ25hbElkc1tlXT10LnZhbHVlQ2hhbmdlZC5jb25uZWN0KGU9PnRoaXMuX19wYXJhbWV0ZXJWYWx1ZUNoYW5nZWQodCxlKSksdGhpcy5fX3BhcmFtcy5wdXNoKHQpLHRoaXMuX19wYXJhbU1hcHBpbmdbZV09dGhpcy5fX3BhcmFtcy5sZW5ndGgtMSx0aGlzLnBhcmFtZXRlckFkZGVkLmVtaXQoZSksdH1pbnNlcnRQYXJhbWV0ZXIodCxlKXtjb25zdCBzPXQuZ2V0TmFtZSgpO251bGwhPXRoaXMuX19wYXJhbU1hcHBpbmdbc10mJihjb25zb2xlLndhcm4oIlJlcGxhY2luZyBQYXJhbWV0ZXI6IitzKSx0aGlzLnJlbW92ZVBhcmFtZXRlcihzKSksdGhpcy5fX3BhcmFtU2lnbmFsSWRzW3NdPXQudmFsdWVDaGFuZ2VkLmNvbm5lY3QoZT0+dGhpcy5fX3BhcmFtZXRlclZhbHVlQ2hhbmdlZCh0LGUpKSx0aGlzLl9fcGFyYW1zLnNwbGljZShlLDAsdCk7Y29uc3QgYT17fTtmb3IobGV0IHQ9MDt0PHRoaXMuX19wYXJhbXMubGVuZ3RoO3QrKylhW3RoaXMuX19wYXJhbXNbdF0uZ2V0TmFtZSgpXT10O3JldHVybiB0aGlzLl9fcGFyYW1NYXBwaW5nPWEsdGhpcy5wYXJhbWV0ZXJBZGRlZC5lbWl0KHMpLHR9cmVtb3ZlUGFyYW1ldGVyKHQpe251bGw9PXRoaXMuX19wYXJhbU1hcHBpbmdbdF0mJmNvbnNvbGUudGhyb3coIlVuYWJsZSB0byBSZW1vdmUgUGFyYW1ldGVyOiIrdCk7Y29uc3QgZT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdO3RoaXMuX19wYXJhbXNbdGhpcy5fX3BhcmFtTWFwcGluZ1t0XV0udmFsdWVDaGFuZ2VkLmRpc2Nvbm5lY3RJZCh0aGlzLl9fcGFyYW1TaWduYWxJZHNbdF0pLHRoaXMuX19wYXJhbXMuc3BsaWNlKGUsMSk7Y29uc3Qgcz17fTtmb3IobGV0IHQ9MDt0PHRoaXMuX19wYXJhbXMubGVuZ3RoO3QrKylzW3RoaXMuX19wYXJhbXNbdF0uZ2V0TmFtZSgpXT10O3RoaXMuX19wYXJhbU1hcHBpbmc9cyx0aGlzLnBhcmFtZXRlclJlbW92ZWQuZW1pdCh0KX1yZXBsYWNlUGFyYW1ldGVyKHQpe2NvbnN0IGU9dC5nZXROYW1lKCkscz10aGlzLl9fcGFyYW1NYXBwaW5nW2VdO3JldHVybiB0aGlzLl9fcGFyYW1zW3RoaXMuX19wYXJhbU1hcHBpbmdbZV1dLnZhbHVlQ2hhbmdlZC5kaXNjb25uZWN0SWQodGhpcy5fX3BhcmFtU2lnbmFsSWRzW2VdKSx0aGlzLl9fcGFyYW1TaWduYWxJZHNbZV09dC52YWx1ZUNoYW5nZWQuY29ubmVjdChlPT50aGlzLl9fcGFyYW1ldGVyVmFsdWVDaGFuZ2VkKHQsZSkpLHRoaXMuX19wYXJhbXNbc109dCx0fXRvSlNPTih0LGUpe2NvbnN0IHM9e307bGV0IGE9MDtmb3IoY29uc3QgaSBvZiB0aGlzLl9fcGFyYW1zKWlmKGkudGVzdEZsYWcoRikpaWYoaS5udW1SZWZzKCk+MSYmMCE9aS5nZXRSZWZJbmRleCh0aGlzKSlzW2kuZ2V0TmFtZSgpXT17cGFyYW1QYXRoOnQubWFrZVJlbGF0aXZlKGkuZ2V0UGF0aCgpKX0sYSsrO2Vsc2V7Y29uc3Qgcj1pLnRvSlNPTih0LGUpO3ImJihzW2kuZ2V0TmFtZSgpXT1yLGErKyl9aWYoYT4wKXJldHVybntwYXJhbXM6c319ZnJvbUpTT04odCxlLHMpe2lmKHQucGFyYW1zKWZvcihjb25zdCBzIGluIHQucGFyYW1zKXtjb25zdCBhPXQucGFyYW1zW3NdLGk9dGhpcy5nZXRQYXJhbWV0ZXIocyk7aT9hLnBhcmFtUGF0aD9lLnJlc29sdmVQYXRoKGEucGFyYW1QYXRoLHQ9Pnt0aGlzLnJlcGxhY2VQYXJhbWV0ZXIodCl9LHQ9Pntjb25zb2xlLndhcm4oIlVuYWJsZSB0byByZXNvbHZlIHNoYXJlZCBwYXJhbWV0ZXI6IithLnBhcmFtUGF0aCl9KTppLmZyb21KU09OKGEsZSk6Y29uc29sZS53YXJuKCJQYXJhbSBub3QgZm91bmQ6IitzKX19cmVhZEJpbmFyeSh0LGUpe2lmKGUudmVyc2lvbnNbInplYS1lbmdpbmUiXS5ncmVhdGVyT3JFcXVhbFRoYW4oWzAsMCwzXSkpe2NvbnN0IHM9dC5sb2FkVUludDMyKCk7Zm9yKGxldCBhPTA7YTxzO2ErKyl7Y29uc3Qgcz10LmxvYWRTdHIoKSxhPXQubG9hZFN0cigpO2xldCBpPXRoaXMuZ2V0UGFyYW1ldGVyKGEpO2lmKCFpKXtpZihpPUkuY29uc3RydWN0Q2xhc3MocyxhKSwhaSl7Y29uc29sZS5lcnJvcigiVW5hYmxlIHRvIGNvbnN0cnVjdCBwcm9wOiIrYSsiIG9mIHR5cGU6IitzKTtjb250aW51ZX10aGlzLmFkZFBhcmFtZXRlcihpKX1pLnJlYWRCaW5hcnkodCxlKX19fXRvU3RyaW5nKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCksbnVsbCwyKX1jb3B5RnJvbSh0LGUpe2xldCBzPXQubnVtUGFyYW1ldGVycygpO2Zvcig7cy0tOyl7Y29uc3QgZT10LmdldFBhcmFtZXRlckJ5SW5kZXgocyksYT10aGlzLmdldFBhcmFtZXRlcihlLmdldE5hbWUoKSk7YT9hLnNldFZhbHVlKGUuZ2V0VmFsdWUoKSxOKTp0aGlzLmFkZFBhcmFtZXRlcihlLmNsb25lKCkpfX1kZXN0cm95KCl7Zm9yKGNvbnN0IHQgb2YgdGhpcy5fX3BhcmFtcyl0LmRlc3Ryb3koKTtzdXBlci5kZXN0cm95KCl9fXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5fX2JvdW5kaW5nQm94PW5ldyBwLHRoaXMuX19ib3VuZGluZ0JveERpcnR5PSEwLHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzPW5ldyBNYXAsdGhpcy5fX21ldGFEYXRhPW5ldyBNYXAsdGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoInBvc2l0aW9ucyIsciwwKSx0aGlzLmJvdW5kaW5nQm94RGlydGllZD1uZXcgdyx0aGlzLmdlb21EYXRhQ2hhbmdlZD1uZXcgdyx0aGlzLmdlb21EYXRhVG9wb2xvZ3lDaGFuZ2VkPW5ldyB3fXNldERlYnVnTmFtZSh0KXt0aGlzLl9fbmFtZT10fWFkZFZlcnRleEF0dHJpYnV0ZSh0LGUscyl7bGV0IGE7dmFyIGk7cmV0dXJuIGE9KGk9cykmJnZvaWQgMCE9PWkuYnl0ZUxlbmd0aD9uZXcgVihlLHMpOm5ldyBWKGUsbnVsbCE9dGhpcy52ZXJ0aWNlcz90aGlzLnZlcnRpY2VzLmxlbmd0aDowLHMpLHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzVmVydGV4QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5oYXModCl9Z2V0VmVydGV4QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5nZXQodCl9Z2V0VmVydGV4QXR0cmlidXRlcyh0KXtjb25zdCBlPXt9O2Zvcihjb25zdFt0LHNdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZW50cmllcygpKWVbdF09cztyZXR1cm4gZX1nZXQgdmVydGljZXMoKXtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KCJwb3NpdGlvbnMiKX1udW1WZXJ0aWNlcygpe3JldHVybiB0aGlzLnZlcnRpY2VzLmxlbmd0aH1nZXROdW1WZXJ0aWNlcygpe3JldHVybiB0aGlzLnZlcnRpY2VzLmxlbmd0aH1zZXROdW1WZXJ0aWNlcyh0KXt0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5mb3JFYWNoKGU9PmUucmVzaXplKHQpKX1nZXRWZXJ0ZXgodCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy52ZXJ0aWNlcy5kYXRhLmJ1ZmZlciwzKnQpfXNldFZlcnRleCh0LGUpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMudmVydGljZXMuZGF0YS5idWZmZXIsMyp0KS5zZXRGcm9tT3RoZXIoZSl9bW92ZVZlcnRpY2VzKHQpe2NvbnN0IGU9dGhpcy52ZXJ0aWNlcztmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKyllLmdldFZhbHVlUmVmKHMpLmFkZEluUGxhY2UodCk7dGhpcy5zZXRCb3VuZGluZ0JveERpcnR5KCl9dHJhbnNmb3JtVmVydGljZXModCl7Y29uc3QgZT10aGlzLnZlcnRpY2VzO2ZvcihsZXQgcz0wO3M8ZS5sZW5ndGg7cysrKXtjb25zdCBhPWUuZ2V0VmFsdWVSZWYocyksaT10LnRyYW5zZm9ybVZlYzMoYSk7YS5zZXQoaS54LGkueSxpLnopfXRoaXMuc2V0Qm91bmRpbmdCb3hEaXJ0eSgpfWdldCBib3VuZGluZ0JveCgpe3JldHVybiB0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eSYmdGhpcy51cGRhdGVCb3VuZGluZ0JveCgpLHRoaXMuX19ib3VuZGluZ0JveH1zZXRCb3VuZGluZ0JveERpcnR5KCl7dGhpcy5fX2JvdW5kaW5nQm94RGlydHk9ITAsdGhpcy5ib3VuZGluZ0JveERpcnRpZWQuZW1pdCgpfXVwZGF0ZUJvdW5kaW5nQm94KCl7Y29uc3QgdD10aGlzLnZlcnRpY2VzLGU9bmV3IHAscz10Lmxlbmd0aDtmb3IobGV0IGE9MDthPHM7YSsrKWUuYWRkUG9pbnQodC5nZXRWYWx1ZVJlZihhKSk7dGhpcy5fX2JvdW5kaW5nQm94PWUsdGhpcy5fX2JvdW5kaW5nQm94RGlydHk9ITF9Z2V0TWV0YWRhdGEodCl7cmV0dXJuIHRoaXMuX19tZXRhRGF0YS5nZXQodCl9aGFzTWV0YWRhdGEodCl7cmV0dXJuIHRoaXMuX19tZXRhRGF0YS5oYXModCl9c2V0TWV0YWRhdGEodCxlKXt0aGlzLl9fbWV0YURhdGEuc2V0KHQsZSl9ZGVsZXRlTWV0YWRhdGEodCl7dGhpcy5fX21ldGFEYXRhLmRlbGV0ZSh0KX1nZW5CdWZmZXJzKHQpe2NvbnN0IGU9e307Zm9yKGNvbnN0W3Qsc11vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcyllW3RdPXt2YWx1ZXM6cy5kYXRhLGNvdW50OnMuc2l6ZSxkYXRhVHlwZTpzLmRhdGFUeXBlLG5vcm1hbGl6ZWQ6cy5ub3JtYWxpemVkfTtyZXR1cm57bnVtVmVydGljZXM6dGhpcy5udW1WZXJ0aWNlcygpLGF0dHJCdWZmZXJzOmV9fWZyZWVCdWZmZXJzKCl7fWxvYWRCYXNlR2VvbUJpbmFyeSh0KXt0aGlzLm5hbWU9dC5sb2FkU3RyKCk7Y29uc3QgZT10LmxvYWRVSW50OCgpO3RoaXMuZGVidWdDb2xvcj10LmxvYWRSR0JGbG9hdDMyQ29sb3IoKTtjb25zdCBzPXQubG9hZFVJbnQzMigpO3RoaXMuX19ib3VuZGluZ0JveC5zZXQodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKSx0aGlzLnNldE51bVZlcnRpY2VzKHMpO2NvbnN0IGE9dGhpcy52ZXJ0aWNlcztsZXQgbixoOzImZSYmKG49dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiKSxufHwobj10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIsciwwKSkpLDQmZSYmKGg9dGhpcy5nZXRWZXJ0ZXhBdHRyaWJ1dGUoInRleENvb3JkcyIpLGh8fChoPXRoaXMuYWRkVmVydGV4QXR0cmlidXRlKCJ0ZXhDb29yZHMiLGksMCkpKTtjb25zdCBvPSh0LGUscyxpKT0+e2ZvcihsZXQgbj10WzBdO248dFsxXTtuKyspe2NvbnN0IHQ9bmV3IHIoaVszKm4rMF0vMjU1LGlbMypuKzFdLzI1NSxpWzMqbisyXS8yNTUpO3QubXVsdGlwbHlJblBsYWNlKHMpLHQuYWRkSW5QbGFjZShlKSxhLnNldFZhbHVlKG4sdCl9fSxfPSh0LGUscyxhKT0+e3MuaXNOdWxsKCkmJnMuc2V0KDEsMSwxKTtmb3IobGV0IGk9dFswXTtpPHRbMV07aSsrKXtjb25zdCB0PW5ldyByKGFbMyppKzBdLzI1NSxhWzMqaSsxXS8yNTUsYVszKmkrMl0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksdC5ub3JtYWxpemVJblBsYWNlKCksbi5zZXRWYWx1ZShpLHQpfX0sZD0odCxlLHMsYSk9Pntmb3IobGV0IHI9dFswXTtyPHRbMV07cisrKXtjb25zdCB0PW5ldyBpKGFbMipyKzBdLzI1NSxhWzIqcisxXS8yNTUpO3QubXVsdGlwbHlJblBsYWNlKHMpLHQuYWRkSW5QbGFjZShlKSxoLnNldFZhbHVlKHIsdCl9fSxsPXQubG9hZFVJbnQzMigpO2lmKDE9PWwpe3tjb25zdCBlPXRoaXMuX19ib3VuZGluZ0JveCxhPXQubG9hZFVJbnQ4QXJyYXkoMypzKTtvKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpfWlmKG4pe2NvbnN0IGU9bmV3IHAodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKSxhPXQubG9hZFVJbnQ4QXJyYXkoMypzKTtfKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpLG4ubG9hZFNwbGl0VmFsdWVzKHQpfWlmKGgpe2NvbnN0IGU9bmV3IGcodC5sb2FkRmxvYXQzMlZlYzIoKSx0LmxvYWRGbG9hdDMyVmVjMigpKSxhPXQubG9hZFVJbnQ4QXJyYXkoMipzKTtkKFswLHNdLGUucDAsZS5kaWFnb25hbCgpLGEpLGgubG9hZFNwbGl0VmFsdWVzKHQpfX1lbHNle2NvbnN0IGU9W107bGV0IGE9MDtmb3IobGV0IHM9MDtzPGw7cysrKXtjb25zdCBzPXQubG9hZFVJbnQzMigpLGk9e3JhbmdlOlthLGErc10sYmJveDpuZXcgcCh0LmxvYWRGbG9hdDMyVmVjMygpLHQubG9hZEZsb2F0MzJWZWMzKCkpfTtuJiYoaS5ub3JtYWxzUmFuZ2U9bmV3IHAodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKSksaCYmKGkudGV4Q29vcmRzUmFuZ2U9bmV3IGcodC5sb2FkRmxvYXQzMlZlYzIoKSx0LmxvYWRGbG9hdDMyVmVjMigpKSksZS5wdXNoKGkpLGErPXN9Y29uc3QgaT10LmxvYWRVSW50OEFycmF5KDMqcyk7bGV0IHIsYztuJiYocj10LmxvYWRVSW50OEFycmF5KDMqcykpLGgmJihjPXQubG9hZFVJbnQ4QXJyYXkoMipzKSk7Zm9yKGxldCB0PTA7dDxsO3QrKyl7e2NvbnN0IHM9ZVt0XS5iYm94O28oZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxpKX1pZihuKXtjb25zdCBzPWVbdF0ubm9ybWFsc1JhbmdlO18oZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxyKX1pZihoKXtjb25zdCBzPWVbdF0udGV4Q29vcmRzUmFuZ2U7ZChlW3RdLnJhbmdlLHMucDAscy5kaWFnb25hbCgpLGMpfX1uJiZuLmxvYWRTcGxpdFZhbHVlcyh0KSxoJiZoLmxvYWRTcGxpdFZhbHVlcyh0KX19dG9KU09OKHQsZSl7bGV0IHM9c3VwZXIudG9KU09OKHQsZSk7aWYoc3x8KHM9e30pLHMudHlwZT1JLmdldENsYXNzTmFtZSh0aGlzKSwhKDEwMjQmZSkpe2NvbnN0IGE9e307Zm9yKGNvbnN0W3MsaV1vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5lbnRyaWVzKCkpYVtzXT1pLnRvSlNPTih0LGUpO3MudmVydGV4QXR0cmlidXRlcz1hfXJldHVybiBzfWZyb21KU09OKHQsZSxzKXtzdXBlci5mcm9tSlNPTih0LGUscyk7Zm9yKGNvbnN0IGUgaW4gdC52ZXJ0ZXhBdHRyaWJ1dGVzKXtsZXQgcz10aGlzLl9fdmVydGV4QXR0cmlidXRlcy5nZXQoZSk7Y29uc3QgaT10LnZlcnRleEF0dHJpYnV0ZXNbZV07aWYoIXMpe2NvbnN0IHQ9YS5nZXRUeXBlKGkuZGF0YVR5cGUpO3M9bmV3IFZlcnRleEF0dHJpYnV0ZSh0aGlzLHQsMCxpLmRlZmF1bHRTY2FsYXJWYWx1ZSksdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuc2V0KGUscyl9cy5mcm9tSlNPTihpKX19dG9TdHJpbmcoKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy50b0pTT04oKSxudWxsLDIpfX1jbGFzcyBBIGV4dGVuZHMgTXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCl9bG9hZEJpbih0KXt0aGlzLm5hbWU9dC5sb2FkU3RyKCk7Y29uc3QgZT10LmxvYWRVSW50MzIoKTt0aGlzLl9fYm91bmRpbmdCb3guc2V0KHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksdGhpcy5zZXROdW1WZXJ0aWNlcyhlKTtjb25zdCBzPXRoaXMudmVydGljZXM7aWYoZTwyNTYpe2NvbnN0IGE9dGhpcy5fX2JvdW5kaW5nQm94LnRvTWF0NCgpLGk9dC5sb2FkVUludDhBcnJheSgzKmUpO2ZvcihsZXQgdD0wO3Q8ZTt0Kyspe2NvbnN0IGU9bmV3IFZlYzMoaVszKnQrMF0vMjU1LGlbMyp0KzFdLzI1NSxpWzMqdCsyXS8yNTUpO3Muc2V0VmFsdWUodCxhLnRyYW5zZm9ybVZlYzMoZSkpfX1lbHNle2NvbnN0IGE9dC5sb2FkVUludDMyKCksaT1bXTtmb3IobGV0IGU9MDtlPGE7ZSsrKXtjb25zdCBlPXQubG9hZFVJbnQzMlZlYzIoKSxzPXQubG9hZEZsb2F0MzJWZWMzKCksYT10LmxvYWRGbG9hdDMyVmVjMygpO2kucHVzaCh7cmFuZ2U6ZSxiYm94Om5ldyBCb3gzKHMsYSl9KX1jb25zdCByPXQubG9hZFVJbnQ4QXJyYXkoMyplKTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPWlbdF0uYmJveC50b01hdDQoKTtmb3IobGV0IGE9aVt0XS5yYW5nZS54O2E8aVt0XS5yYW5nZS55O2ErKyl7Y29uc3QgdD1uZXcgVmVjMyhyWzMqYSswXS8yNTUsclszKmErMV0vMjU1LHJbMyphKzJdLzI1NSk7cy5zZXRWYWx1ZShhLGUudHJhbnNmb3JtVmVjMyh0KSl9fX19cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLmdlb21EYXRhQ2hhbmdlZC5lbWl0KCl9fWNsYXNzIFMgZXh0ZW5kcyBNe2NvbnN0cnVjdG9yKCl7c3VwZXIoKSx0aGlzLl9faW5kaWNlcz1uZXcgVWludDMyQXJyYXksdGhpcy5fX3NlZ21lbnRBdHRyaWJ1dGVzPW5ldyBNYXAsdGhpcy5saW5lVGhpY2tuZXNzPTB9Z2V0SW5kaWNlcygpe3JldHVybiB0aGlzLl9faW5kaWNlc31nZXROdW1TZWdtZW50cygpe3JldHVybiB0aGlzLl9faW5kaWNlcy5sZW5ndGgvMn1zZXROdW1TZWdtZW50cyh0KXtjb25zdCBlPW5ldyBVaW50MzJBcnJheSgyKnQpO3RoaXMuX19pbmRpY2VzPWV9c2V0U2VnbWVudCh0LGUscyl7aWYodD49dGhpcy5fX2luZGljZXMubGVuZ3RoLzIpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGxpbmUgaW5kZXg6Iit0KyIuIE51bSBTZWdtZW50czoiK3RoaXMuX19pbmRpY2VzLmxlbmd0aC8yKTt0aGlzLl9faW5kaWNlc1syKnQrMF09ZSx0aGlzLl9faW5kaWNlc1syKnQrMV09c31nZXRTZWdtZW50VmVydGV4SW5kZXgodCxlKXtpZih0PHRoaXMubnVtTGluZXMpcmV0dXJuIHRoaXMuX19pbmRpY2VzWzIqdCtlXX1hZGRTZWdtZW50QXR0cmlidXRlKHQsZSxzKXtjb25zdCBhPW5ldyBBdHRyaWJ1dGUoZSxudWxsIT1zP3M6dGhpcy5wb2x5Z29uQ291bnQpO3JldHVybiB0aGlzLl9fc2VnbWVudEF0dHJpYnV0ZXMuc2V0KHQsYSksYX1oYXNTZWdtZW50QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fc2VnbWVudEF0dHJpYnV0ZXMuaGFzKHQpfWdldFNlZ21lbnRBdHRyaWJ1dGUodCl7cmV0dXJuIHRoaXMuX19zZWdtZW50QXR0cmlidXRlcy5nZXQodCl9Z2VuQnVmZmVycygpe2NvbnN0IHQ9c3VwZXIuZ2VuQnVmZmVycygpO2xldCBlO3JldHVybiB0Lm51bVZlcnRpY2VzPE1hdGgucG93KDIsOCk/KGU9bmV3IFVpbnQ4QXJyYXkodGhpcy5fX2luZGljZXMubGVuZ3RoKSx0aGlzLl9faW5kaWNlcy5mb3JFYWNoKCh0LHMpPT57ZVtzXT10fSkpOnQubnVtVmVydGljZXM8TWF0aC5wb3coMiwxNik/KGU9bmV3IFVpbnQxNkFycmF5KHRoaXMuX19pbmRpY2VzLmxlbmd0aCksdGhpcy5fX2luZGljZXMuZm9yRWFjaCgodCxzKT0+e2Vbc109dH0pKTplPXRoaXMuX19pbmRpY2VzLHQuaW5kaWNlcz1lLHR9cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLnNldE51bVNlZ21lbnRzKHQubG9hZFVJbnQzMigpKTtjb25zdCBzPXQubG9hZFVJbnQ4KCk7MT09cz90aGlzLl9faW5kaWNlcz10LmxvYWRVSW50OEFycmF5KCk6Mj09cz90aGlzLl9faW5kaWNlcz10LmxvYWRVSW50MTZBcnJheSgpOjQ9PXMmJih0aGlzLl9faW5kaWNlcz10LmxvYWRVSW50MzJBcnJheSgpKSx0aGlzLmdlb21EYXRhQ2hhbmdlZC5lbWl0KCl9dG9KU09OKHQsZSl7Y29uc3Qgcz1zdXBlci50b0pTT04odCxlKTtyZXR1cm4gMTAyNCZlfHwocy5pbmRpY2VzPUFycmF5LmZyb20odGhpcy5fX2luZGljZXMpKSxzfWZyb21KU09OKHQsZSxzKXtzdXBlci5mcm9tSlNPTih0LGUscyksdGhpcy5fX2luZGljZXM9VWludDMyQXJyYXkuZnJvbSh0LmluZGljZXMpfX1jbGFzcyBPIGV4dGVuZHMgVntjb25zdHJ1Y3Rvcih0LGUscyxhKXtzdXBlcihlLHMsYSksdGhpcy5fX2dlb209dCx0aGlzLl9fc3BsaXRzPXt9LHRoaXMuX19zcGxpdFZhbHVlcz1bXX1nZXRGYWNlVmVydGV4VmFsdWVSZWYodCxlKXtjb25zdCBzPXRoaXMuX19nZW9tLmdldEZhY2VWZXJ0ZXhJbmRleCh0LGUpO3JldHVybiBzIGluIHRoaXMuX19zcGxpdHMmJnQgaW4gdGhpcy5fX3NwbGl0c1tzXT90aGlzLl9fc3BsaXRWYWx1ZXNbdGhpcy5fX3NwbGl0c1tzXVt0XV06dGhpcy5nZXRWYWx1ZVJlZihzKX1zZXRGYWNlVmVydGV4VmFsdWUodCxlLHMpe2NvbnN0IGE9dGhpcy5fX2dlb20uZ2V0RmFjZVZlcnRleEluZGV4KHQsZSk7dGhpcy5zZXRGYWNlVmVydGV4VmFsdWVfQnlWZXJ0ZXhJbmRleCh0LGEscyl9c2V0RmFjZVZlcnRleFZhbHVlX0J5VmVydGV4SW5kZXgodCxlLHMpe2NvbnN0IGE9dGhpcy5nZXRWYWx1ZVJlZihlKTtpZihhLmlzVmFsaWQoKSlpZihhLmFwcHJveEVxdWFsKHMpKTtlbHNle2lmKGUgaW4gdGhpcy5fX3NwbGl0cyl7Y29uc3QgYT10aGlzLl9fc3BsaXRzW2VdO2Zvcihjb25zdCBlIGluIGEpe2NvbnN0IGk9YVtlXTtpZih0aGlzLl9fc3BsaXRWYWx1ZXNbaV0uYXBwcm94RXF1YWwocykpcmV0dXJuIHZvaWQoYVt0XT1pKX1pZih0IGluIHRoaXMuX19zcGxpdHNbZV0pe3JldHVybiB2b2lkIHRoaXMuX19zcGxpdFZhbHVlc1t0aGlzLl9fc3BsaXRzW2VdW3RdXS5zZXRGcm9tT3RoZXIocyl9fWVsc2UgdGhpcy5fX3NwbGl0c1tlXT17fTt0aGlzLl9fc3BsaXRzW2VdW3RdPXRoaXMuX19zcGxpdFZhbHVlcy5sZW5ndGgsdGhpcy5fX3NwbGl0VmFsdWVzLnB1c2gocyl9ZWxzZSBhLnNldEZyb21PdGhlcihzKX1zZXRTcGxpdFZlcnRleFZhbHVlKHQsZSxzKXtpZih0IGluIHRoaXMuX19zcGxpdHN8fCh0aGlzLl9fc3BsaXRzW3RdPXt9KSxlIGluIHRoaXMuX19zcGxpdHNbdF0pe2lmKHRoaXMuX19zcGxpdFZhbHVlc1t0aGlzLl9fc3BsaXRzW3RdW2VdXS5hcHByb3hFcXVhbChzKSlyZXR1cm47Y29uc29sZS53YXJuKCJGYWNlIFZlcnRleCBBbHJlYWR5IFNwbGl0IHdpdGggZGlmZmVyZW50IHZhbHVlIil9dGhpcy5fX3NwbGl0c1t0XVtlXT10aGlzLl9fc3BsaXRWYWx1ZXMubGVuZ3RoLHRoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHMpfXNldFNwbGl0VmVydGV4VmFsdWVzKHQsZSxzKXt0IGluIHRoaXMuX19zcGxpdHN8fCh0aGlzLl9fc3BsaXRzW3RdPXt9KTtjb25zdCBhPXRoaXMuX19zcGxpdFZhbHVlcy5sZW5ndGg7dGhpcy5fX3NwbGl0VmFsdWVzLnB1c2gocyk7Zm9yKGNvbnN0IHMgb2YgZSl0aGlzLl9fc3BsaXRzW3RdW3NdPWF9Z2V0U3BsaXRzKCl7cmV0dXJuIHRoaXMuX19zcGxpdHN9Z2V0U3BsaXRDb3VudCgpe2xldCB0PTA7Zm9yKGNvbnN0IGUgaW4gdGhpcy5fX3NwbGl0cyl0Kz1PYmplY3Qua2V5cyh0aGlzLl9fc3BsaXRzW2VdKS5sZW5ndGg7cmV0dXJuIHR9Z2VuZXJhdGVTcGxpdFZhbHVlcyh0LGUpe2lmKDA9PWUpcmV0dXJuIHRoaXMuX19kYXRhO2NvbnN0IHM9dGhpcy5sZW5ndGgsYT10aGlzLmxlbmd0aCtlLGk9dGhpcy5fX2RhdGFUeXBlLm51bUVsZW1lbnRzP3RoaXMuX19kYXRhVHlwZS5udW1FbGVtZW50cygpOjEscj1uZXcgRmxvYXQzMkFycmF5KGEqaSk7Zm9yKGxldCB0PTA7dDx0aGlzLl9fZGF0YS5sZW5ndGg7dCsrKXJbdF09dGhpcy5fX2RhdGFbdF07Zm9yKGNvbnN0IGUgaW4gdCl7Y29uc3QgYT10W2VdO2Zvcihjb25zdCB0IGluIGEpe2NvbnN0IG49cythW3RdO2lmKGUgaW4gdGhpcy5fX3NwbGl0cyYmdCBpbiB0aGlzLl9fc3BsaXRzW2VdKXtjb25zdCBzPXRoaXMuX19zcGxpdHNbZV1bdF07Nj09dGhpcy5fX2RhdGFUeXBlP3JbbippXT10aGlzLl9fc3BsaXRWYWx1ZXNbc106dGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHIuYnVmZmVyLG4qaSkuc2V0RnJvbU90aGVyKHRoaXMuX19zcGxpdFZhbHVlc1tzXSl9ZWxzZXtjb25zdCB0PXBhcnNlSW50KGUpO2ZvcihsZXQgZT0wO2U8aTtlKyspdCppK2U+dGhpcy5fX2RhdGEubGVuZ3RoJiZjb25zb2xlLmxvZygiRXJyb3IgcmVtYXBwaW5nIHNyYzoiK3QqaStlKSxuKmkrZT5yLmxlbmd0aCYmY29uc29sZS5sb2coIkVycm9yIHJlbWFwcGluZyB0Z3Q6IituKmkrZSkscltuKmkrZV09dGhpcy5fX2RhdGFbdCppK2VdfX19cmV0dXJuIHJ9dG9KU09OKHQsZSl7Y29uc3Qgcz1zdXBlci50b0pTT04odCxlKTtyZXR1cm4gcy5zcGxpdHM9dGhpcy5fX3NwbGl0cyxzLnNwbGl0VmFsdWVzPXRoaXMuX19zcGxpdFZhbHVlcyxzfWZyb21KU09OKHQsZSxzKXtzdXBlci5mcm9tSlNPTih0LGUscyksdGhpcy5fX3NwbGl0cz10LnNwbGl0cyx0aGlzLl9fc3BsaXRWYWx1ZXM9W107Zm9yKGNvbnN0IGUgb2YgdC5zcGxpdFZhbHVlcyl0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaCh0aGlzLl9fZGF0YVR5cGUuY3JlYXRlRnJvbUpTT04oZSkpfWxvYWRTcGxpdFZhbHVlcyh0KXtjb25zdCBlPXQubG9hZFVJbnQzMkFycmF5KCk7aWYoMD09ZS5sZW5ndGgpcmV0dXJuO2xldCBzPTAsYT0wO2Zvcig7Oyl7Y29uc3QgdD1lW3MrK10saT1lW3MrK10scj17fTtmb3IobGV0IHQ9MDt0PGk7dCsrKXtjb25zdCB0PWVbcysrXSxpPWVbcysrXTtyW3RdPWksaT49YSYmKGE9aSsxKX1pZih0aGlzLl9fc3BsaXRzW3RdPXIscz49ZS5sZW5ndGgpYnJlYWt9Y29uc3QgaT10aGlzLl9fbnVtRmxvYXQzMkVsZW1lbnRzLHI9dC5sb2FkRmxvYXQzMkFycmF5KGEqaSk7dGhpcy5fX3NwbGl0VmFsdWVzPVtdO2ZvcihsZXQgdD0wO3Q8YTt0Kyspe2NvbnN0IGU9dGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21GbG9hdDMyQXJyYXkoci5zbGljZSh0KmksdCppK2kpKTt0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaChlKX19fWNsYXNzIFAgZXh0ZW5kcyBNe2NvbnN0cnVjdG9yKCl7c3VwZXIoKSx0aGlzLmluaXQoKX1pbml0KCl7dGhpcy5fX2ZhY2VDb3VudHM9W10sdGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHM9bmV3IFVpbnQ4QXJyYXksdGhpcy5fX2ZhY2VPZmZzZXRzPW5ldyBVaW50MzJBcnJheSx0aGlzLl9fZmFjZVZlcnRleEluZGljZXM9bmV3IFVpbnQzMkFycmF5LHRoaXMuX19udW1Qb3B1bGF0ZWRGYWNlVmVydGV4SW5kaWNlcz0wLHRoaXMuX19mYWNlQXR0cmlidXRlcz1uZXcgTWFwLHRoaXMuX19lZGdlQXR0cmlidXRlcz1uZXcgTWFwLHRoaXMuX19sb2dUb3BvbG9neVdhcm5pbmdzPSExLHRoaXMuZWRnZVZlcnRzPXZvaWQgMCx0aGlzLnZlcnRleEVkZ2VzPXZvaWQgMCx0aGlzLm51bUVkZ2VzPTAsdGhpcy5lZGdlRmxhZ3M9bmV3IFVpbnQzMkFycmF5LHRoaXMuZWRnZUFuZ2xlcz1uZXcgRmxvYXQzMkFycmF5fWdldEZhY2VWZXJ0ZXhJbmRpY2VzKCl7cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc31nZXRGYWNlQ291bnRzKCl7cmV0dXJuIHRoaXMuX19mYWNlQ291bnRzfWNsZWFyKCl7dGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPXZvaWQgMCx0aGlzLl9fZmFjZUNvdW50cz1bXSx0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXM9MH1zZXRGYWNlQ291bnRzKHQpe2lmKHRoaXMuX19udW1Qb3B1bGF0ZWRGYWNlVmVydGV4SW5kaWNlcyl0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBzZXQgZmFjZSBjb3VudHMgb24gYSBtZXNoIHRoYXQgaXMgYWxyZWFkeSBwb3B1bGF0ZWQuIFBsZWFzZSBjYWxsICdjbGVhcicgYmVmb3JlIHJlLWJ1aWxkaW5nIHRoZSBtZXNoLiIpO3RoaXMuX19mYWNlQ291bnRzPXQ7bGV0IGU9MCxzPTAsYT0zO2Zvcihjb25zdCB0IG9mIHRoaXMuX19mYWNlQ291bnRzKWUrPXQscys9dCphLGErKzt0aGlzLl9fZmFjZVZlcnRleENvdW50cz1uZXcgVWludDhBcnJheShlKSx0aGlzLl9fZmFjZU9mZnNldHM9bmV3IFVpbnQzMkFycmF5KGUpLHRoaXMuX19mYWNlVmVydGV4SW5kaWNlcz1uZXcgVWludDMyQXJyYXkocyk7Zm9yKGNvbnN0IHQgb2YgdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzKXQucmVzaXplKGUpfXNldEZhY2VWZXJ0ZXhJbmRpY2VzKHQpe2NvbnN0IGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDEpLHM9dGhpcy5fX251bVBvcHVsYXRlZEZhY2VWZXJ0ZXhJbmRpY2VzO2ZvcihsZXQgdD0wO3Q8ZS5sZW5ndGg7dCsrKXRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzK3RdPWVbdF07dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHNbdF09ZS5sZW5ndGgtMyx0aGlzLl9fZmFjZU9mZnNldHNbdF09cyx0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXMrPWUubGVuZ3RofWdldEZhY2VWZXJ0ZXhJbmRpY2VzKHQpe2NvbnN0IGU9W10scz10aGlzLl9fZmFjZU9mZnNldHNbdF0sYT10aGlzLl9fZmFjZVZlcnRleENvdW50c1t0XSszO2ZvcihsZXQgdD0wO3Q8YTt0KyspZS5wdXNoKHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzK3RdKTtyZXR1cm4gZX1nZXRGYWNlVmVydGV4SW5kZXgodCxlKXtjb25zdCBzPXRoaXMuX19mYWNlT2Zmc2V0c1t0XTtyZXR1cm4gdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW3MrZV19Z2V0TnVtRmFjZXMoKXtyZXR1cm4gdGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHMubGVuZ3RofWFkZFZlcnRleEF0dHJpYnV0ZSh0LGUscyl7Y29uc3QgYT1uZXcgTyh0aGlzLGUsbnVsbCE9dGhpcy52ZXJ0aWNlcz90aGlzLnZlcnRpY2VzLmxlbmd0aDowLHMpO3JldHVybiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5zZXQodCxhKSxhfWFkZEZhY2VBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IFYoZSxudWxsIT1zP3M6dGhpcy5nZXROdW1GYWNlcygpKTtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzRmFjZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLmhhcyh0KX1nZXRGYWNlQXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fZmFjZUF0dHJpYnV0ZXMuZ2V0KHQpfWFkZEVkZ2VBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IFYoZSxudWxsIT1zP3M6dGhpcy5nZXROdW1FZGdlcygpKTtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzRWRnZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLmhhcyh0KX1nZXRFZGdlQXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fZWRnZUF0dHJpYnV0ZXMuZ2V0KHQpfWdlblRvcG9sb2d5SW5mbygpe2NvbnN0IHQ9e307dGhpcy52ZXJ0ZXhFZGdlcz1bXSx0aGlzLmVkZ2VGYWNlcz1bXSx0aGlzLmVkZ2VWZXJ0cz1bXSx0aGlzLmZhY2VFZGdlcz1bXSx0aGlzLm51bUVkZ2VzPTA7Y29uc3QgZT0oZSxzKT0+e2xldCBhPWUsaT1zO2lmKGk8YSl7Y29uc3QgdD1hO2E9aSxpPXR9Y29uc3Qgcj1hKyI+IitpO2lmKHIgaW4gdClyZXR1cm4gdFtyXTtjb25zdCBuPXRoaXMudmVydGljZXMuZ2V0VmFsdWVSZWYoYSksaD10aGlzLnZlcnRpY2VzLmdldFZhbHVlUmVmKGkpLnN1YnRyYWN0KG4pLG89e2VkZ2VJbmRleDp0aGlzLmVkZ2VGYWNlcy5sZW5ndGgvMixlZGdlVmVjOmh9O3JldHVybiB0W3JdPW8sdGhpcy5lZGdlRmFjZXMucHVzaCgtMSksdGhpcy5lZGdlRmFjZXMucHVzaCgtMSksdGhpcy5lZGdlVmVydHMucHVzaChhKSx0aGlzLmVkZ2VWZXJ0cy5wdXNoKGkpLHRoaXMubnVtRWRnZXMrKyxvfSxzPSh0LHMsYSk9Pntjb25zdCBpPWUodCxzKS5lZGdlSW5kZXg7aWYoczx0KXtjb25zdCB0PTIqaSswO3RoaXMuX19sb2dUb3BvbG9neVdhcm5pbmdzJiYtMSE9dGhpcy5lZGdlRmFjZXNbdF0mJmNvbnNvbGUud2FybigiRWRnZSBwb2x5IDAgYWxyZWFkeSBzZXQuIE1lc2ggaXMgbm9uLW1hbmlmb2xkLiIpLHRoaXMuZWRnZUZhY2VzW3RdPWF9ZWxzZXtjb25zdCB0PTIqaSsxO3RoaXMuX19sb2dUb3BvbG9neVdhcm5pbmdzJiYtMSE9dGhpcy5lZGdlRmFjZXNbdF0mJmNvbnNvbGUud2FybigiRWRnZSBwb2x5IDEgYWxyZWFkeSBzZXQuIE1lc2ggaXMgbm9uLW1hbmlmb2xkLiIpLHRoaXMuZWRnZUZhY2VzW3RdPWF9YSBpbiB0aGlzLmZhY2VFZGdlc3x8KHRoaXMuZmFjZUVkZ2VzW2FdPVtdKSx0aGlzLmZhY2VFZGdlc1thXS5wdXNoKGkpLG51bGw9PXRoaXMudmVydGV4RWRnZXNbdF0mJih0aGlzLnZlcnRleEVkZ2VzW3RdPW5ldyBTZXQpLG51bGw9PXRoaXMudmVydGV4RWRnZXNbc10mJih0aGlzLnZlcnRleEVkZ2VzW3NdPW5ldyBTZXQpLHRoaXMudmVydGV4RWRnZXNbdF0uYWRkKGkpLHRoaXMudmVydGV4RWRnZXNbc10uYWRkKGkpfSxhPXRoaXMuZ2V0TnVtRmFjZXMoKTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXModCk7Zm9yKGxldCBhPTA7YTxlLmxlbmd0aDthKyspe3MoZVthXSxlWyhhKzEpJWUubGVuZ3RoXSx0KX19fWNvbXB1dGVGYWNlTm9ybWFscygpe2NvbnN0IHQ9dGhpcy52ZXJ0aWNlcyxlPXRoaXMuYWRkRmFjZUF0dHJpYnV0ZSgibm9ybWFscyIscikscz10aGlzLmdldE51bUZhY2VzKCk7Zm9yKGxldCBhPTA7YTxzO2ErKyl7Y29uc3Qgcz10aGlzLmdldEZhY2VWZXJ0ZXhJbmRpY2VzKGEpLGk9dC5nZXRWYWx1ZVJlZihzWzBdKTtsZXQgbj10LmdldFZhbHVlUmVmKHNbMV0pO2NvbnN0IGg9bmV3IHI7Zm9yKGxldCBlPTI7ZTxzLmxlbmd0aDtlKyspe2NvbnN0IGE9dC5nZXRWYWx1ZVJlZihzW2VdKSxyPW4uc3VidHJhY3QoaSksbz1hLnN1YnRyYWN0KGkpO2guYWRkSW5QbGFjZShyLmNyb3NzKG8pLm5vcm1hbGl6ZSgpKSxuPWF9aC5sZW5ndGhTcXVhcmVkKCksTnVtYmVyLkVQU0lMT04sZS5zZXRWYWx1ZShhLGgubm9ybWFsaXplKCkpfX1nZW5lcmF0ZUVkZ2VGbGFncygpe251bGw9PXRoaXMudmVydGV4RWRnZXMmJnRoaXMuZ2VuVG9wb2xvZ3lJbmZvKCksdGhpcy5oYXNGYWNlQXR0cmlidXRlKCJub3JtYWxzIil8fHRoaXMuY29tcHV0ZUZhY2VOb3JtYWxzKCk7Y29uc3QgdD10aGlzLnZlcnRpY2VzLGU9dGhpcy5nZXRGYWNlQXR0cmlidXRlKCJub3JtYWxzIik7dGhpcy5lZGdlVmVjcz1bXSx0aGlzLmVkZ2VBbmdsZXM9bmV3IEZsb2F0MzJBcnJheSh0aGlzLm51bUVkZ2VzKTtmb3IobGV0IHM9MDtzPHRoaXMuZWRnZUZhY2VzLmxlbmd0aDtzKz0yKXtjb25zdCBhPXRoaXMuZWRnZVZlcnRzW3NdLGk9dGhpcy5lZGdlVmVydHNbcysxXSxyPXQuZ2V0VmFsdWVSZWYoaSkuc3VidHJhY3QodC5nZXRWYWx1ZVJlZihhKSk7ci5ub3JtYWxpemVJblBsYWNlKCksdGhpcy5lZGdlVmVjcy5wdXNoKHIpO2NvbnN0IG49dGhpcy5lZGdlRmFjZXNbc10saD10aGlzLmVkZ2VGYWNlc1tzKzFdO2lmKC0xPT1ufHwtMT09aCl7dGhpcy5lZGdlQW5nbGVzW3MvMl09MipNYXRoLlBJO2NvbnRpbnVlfWNvbnN0IG89ZS5nZXRWYWx1ZVJlZihuKSxfPWUuZ2V0VmFsdWVSZWYoaCk7dGhpcy5lZGdlQW5nbGVzW3MvMl09by5hbmdsZVRvKF8pfX1jb21wdXRlVmVydGV4Tm9ybWFscyh0PTEpe3RoaXMuZ2VuZXJhdGVFZGdlRmxhZ3MoKTt0aGlzLnZlcnRpY2VzO2NvbnN0IGU9dGhpcy5nZXRGYWNlQXR0cmlidXRlKCJub3JtYWxzIikscz10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIsciksYT1lLmRhdGEuYnVmZmVyLGk9cy5kYXRhLG49KHQsZSk9PntpWzMqdCswXT1lLngsaVszKnQrMV09ZS55LGlbMyp0KzJdPWUuen0saD0odCxlKT0+e2xldCBzLGE7Y29uc3QgaT10aGlzLmZhY2VFZGdlc1t0XTtmb3IoY29uc3QgdCBvZiBpKSh0aGlzLmVkZ2VWZXJ0c1syKnRdPT1lfHx0aGlzLmVkZ2VWZXJ0c1syKnQrMV09PWUpJiYocz9hPXRoaXMuZWRnZVZlY3NbdF06cz10aGlzLmVkZ2VWZWNzW3RdKTtyZXR1cm5bcyxhXX07Zm9yKGxldCBlPTA7ZTx0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDtlKyspe2lmKG51bGw9PXRoaXMudmVydGV4RWRnZXNbZV0pY29udGludWU7Y29uc3QgaT10aGlzLnZlcnRleEVkZ2VzW2VdLF89W10sZD10PT57bGV0IGU9ITE7Zm9yKGNvbnN0IHMgb2YgXylpZihlPS0xIT1zLmluZGV4T2YodCksZSlicmVhaztlfHxfLnB1c2goW3RdKX07Zm9yKGNvbnN0IGUgb2YgaSl7Y29uc3Qgcz10aGlzLmVkZ2VGYWNlc1syKmVdLGE9dGhpcy5lZGdlRmFjZXNbMiplKzFdO2lmKC0xIT1zJiYtMT09YSYmdGhpcy5lZGdlQW5nbGVzW2VdPHQpe2xldCB0PS0xLGU9LTE7Zm9yKGxldCBpPTA7aTxfLmxlbmd0aDtpKyspLTE9PXQmJi0xIT1fW2ldLmluZGV4T2YocykmJih0PWkpLC0xPT1lJiYtMSE9X1tpXS5pbmRleE9mKGEpJiYoZT1pKTstMT09dCYmLTE9PWU/Xy5wdXNoKFtzLGFdKTotMSE9dCYmLTEhPWU/dCE9ZSYmKF9bdF09X1t0XS5jb25jYXQoX1tlXSksXy5zcGxpY2UoZSwxKSk6KC0xPT10JiZfW2VdLnB1c2gocyksLTE9PWUmJl9bdF0ucHVzaChhKSl9ZWxzZS0xIT1zJiZkKHMpLC0xIT1hJiZkKGEpfV8uc29ydCgodCxlKT0+dC5sZW5ndGg8ZS5sZW5ndGg/MTp0Lmxlbmd0aD5lLmxlbmd0aD8tMTowKTtsZXQgbD0hMDtmb3IoY29uc3QgdCBvZiBfKXtjb25zdCBpPW5ldyByO2Zvcihjb25zdCBzIG9mIHQpe2NvbnN0IHQ9aChzLGUpLG49dFswXS5hbmdsZVRvKHRbMV0pO2kuYWRkSW5QbGFjZSgobz1zLG5ldyByKGEsMTIqbykpLnNjYWxlKG4pKX1pLm5vcm1hbGl6ZUluUGxhY2UoKSxsPyhuKGUsaSksbD0hMSk6cy5zZXRTcGxpdFZlcnRleFZhbHVlcyhlLHQsaSl9fXZhciBvO3JldHVybiBzfWNvbXB1dGVOdW1UcmlhbmdsZXMoKXtsZXQgdD0zLGU9MDtmb3IoY29uc3QgcyBvZiB0aGlzLl9fZmFjZUNvdW50cyllKz1zKih0LTIpLHQrKztyZXR1cm4gZX1nZW5lcmF0ZVRyaWFuZ3VsYXRlZEluZGljZXModCxlLHMpe2NvbnN0IGE9dGhpcy5jb21wdXRlTnVtVHJpYW5nbGVzKCk7bGV0IGk7aT10PE1hdGgucG93KDIsOCk/bmV3IFVpbnQ4QXJyYXkoMyphKTp0PE1hdGgucG93KDIsMTYpP25ldyBVaW50MTZBcnJheSgzKmEpOm5ldyBVaW50MzJBcnJheSgzKmEpO2xldCByPTA7Y29uc3Qgbj1mdW5jdGlvbih0LGEpe3QgaW4gcyYmYSBpbiBzW3RdJiYodD1lK3NbdF1bYV0pLGlbcl09dCxyKyt9LGg9dGhpcy5nZXROdW1GYWNlcygpO2ZvcihsZXQgdD0wO3Q8aDt0Kyspe2NvbnN0IGU9dGhpcy5nZXRGYWNlVmVydGV4SW5kaWNlcyh0KTtmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKylzPj0zJiYobihlWzBdLHQpLG4oZVtzLTFdLHQpKSxuKGVbc10sdCl9cmV0dXJuIGl9Y29tcHV0ZUhhcmRFZGdlc0luZGljZXModD0xKXtjb25zdCBlPVtdLHM9dD0+e2UucHVzaCh0aGlzLmVkZ2VWZXJ0c1t0XSksZS5wdXNoKHRoaXMuZWRnZVZlcnRzW3QrMV0pfTtmb3IobGV0IGU9MDtlPHRoaXMuZWRnZUZsYWdzLmxlbmd0aDtlKz0yKXRoaXMuZWRnZUFuZ2xlc1tlLzJdPnQmJnMoZSk7cmV0dXJuIGV9Z2V0V2lyZWZyYW1lSW5kaWNlcygpe3JldHVybiBpbmRpY2VzfWdlbkJ1ZmZlcnModCl7Y29uc3QgZT17fTtsZXQgcz0wO2Zvcihjb25zdFssdF1vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcyl7Y29uc3QgYT10LmdldFNwbGl0cygpO2Zvcihjb25zdCB0IGluIGEpe3QgaW4gZXx8KGVbdF09e30pO2NvbnN0IGk9YVt0XTtmb3IoY29uc3QgYSBpbiBpKXtjb25zdCBpPXBhcnNlSW50KGEpO2kgaW4gZVt0XXx8KGVbdF1baV09cyxzKyspfX19Y29uc3QgYT10aGlzLnZlcnRpY2VzLmxlbmd0aCxpPWErcztsZXQgcjt0JiYwPT10LmluY2x1ZGVJbmRpY2VzfHwocj10aGlzLmdlbmVyYXRlVHJpYW5ndWxhdGVkSW5kaWNlcyhpLGEsZSkpO2NvbnN0IG49e307Zm9yKGNvbnN0W3QsYV1vZiB0aGlzLl9fdmVydGV4QXR0cmlidXRlcyl7bGV0IGk7aT0wPT1zP2EuZGF0YTphLmdlbmVyYXRlU3BsaXRWYWx1ZXMoZSxzKTtjb25zdCByPWEubnVtRWxlbWVudHMsaD1pLmxlbmd0aC9yO25bdF09e3ZhbHVlczppLGNvdW50OmgsZGltZW5zaW9uOnIsbm9ybWFsaXplZDoibm9ybWFscyI9PXQsZGF0YVR5cGU6YS5kYXRhVHlwZX19Y29uc3QgaD17bnVtVmVydGljZXM6dGhpcy5udW1WZXJ0aWNlcygpLG51bVJlbmRlclZlcnRzOmksaW5kaWNlczpyLGF0dHJCdWZmZXJzOm59O2lmKHQmJnQuaW5jbHVkZVZlcnRleE5laWdoYm9ycyl7bnVsbD09dGhpcy52ZXJ0ZXhFZGdlcyYmdGhpcy5nZW5Ub3BvbG9neUluZm8oKTtsZXQgdD0wO2ZvcihsZXQgZT0wO2U8dGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7ZSsrKXRoaXMudmVydGV4RWRnZXNbZV0mJih0Kz10aGlzLnZlcnRleEVkZ2VzW2VdLnNpemUpO2NvbnN0IGU9bmV3IFVpbnQzMkFycmF5KDIqdGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGgrdCkscz10PT57Zm9yKGxldCBlPTA7ZTx0Lmxlbmd0aDtlKyspe2NvbnN0IHM9dFtlXTtmb3IobGV0IGE9MDthPGU7YSsrKXtjb25zdCBpPXRbYV07aWYoLTEhPXNbMF0mJnNbMF09PWlbMV0pe2UhPWErMSYmKHQuc3BsaWNlKGUsMSksdC5zcGxpY2UoYSsxLDAscykpO2JyZWFrfWlmKC0xIT1zWzFdJiZzWzFdPT1pWzBdKXt0LnNwbGljZShlLDEpLHQuc3BsaWNlKGEsMCxzKTticmVha319fX0sYT10PT57aWYoISgtMSE9dFswXVswXSYmLTEhPXRbdC5sZW5ndGgtMV1bMV18fC0xPT10WzBdWzBdJiYtMT09dFt0Lmxlbmd0aC0xXVsxXSkpdGhyb3cgbmV3IEVycm9yKCJJZiBmYW4gc3RhcnRzIHdpdGggLTEsIGl0IG11c3QgYWxzbyBlbmQgd2l0aCAtMSIpO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtjb25zdCBzPXRbZV07aWYoKC0xPT1zWzBdfHwtMT09c1sxXSkmJjAhPWUmJmUhPXQubGVuZ3RoLTEpdGhyb3cgbmV3IEVycm9yKCItMSBvbmx5IGFsbG93ZWQgYXQgdGhlIGJlZ2lubmluZyBhbmQgZW5kIG9mIGEgZmFuLiIpO2lmKC0xIT1zWzBdKXtsZXQgYT1lLTE7aWYoYTwwJiYoYSs9dC5sZW5ndGgpLHNbMF0hPXRbYV1bMV0pdGhyb3cgbmV3IEVycm9yKCJGYWNlcyBhcmUgbm90IHNlcXVlbnRpYWwiKX1pZigtMSE9c1sxXSl7Y29uc3QgYT0oZSsxKSV0Lmxlbmd0aDtpZihzWzFdIT10W2FdWzBdKXRocm93IG5ldyBFcnJvcigiRmFjZXMgYXJlIG5vdCBzZXF1ZW50aWFsIil9fX07bGV0IGk9Mip0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDtmb3IobGV0IHQ9MDt0PHRoaXMudmVydGV4RWRnZXMubGVuZ3RoO3QrKyl7aWYobnVsbD09dGhpcy52ZXJ0ZXhFZGdlc1t0XSljb250aW51ZTtjb25zdCByPXRoaXMudmVydGV4RWRnZXNbdF0sbj1bXTtmb3IoY29uc3QgZSBvZiByKXtjb25zdCBzPXRoaXMuZWRnZVZlcnRzWzIqZV0sYT10aGlzLmVkZ2VWZXJ0c1syKmUrMV07bGV0IGkscj10aGlzLmVkZ2VGYWNlc1syKmVdLGg9dGhpcy5lZGdlRmFjZXNbMiplKzFdO2lmKHM9PXQpaT1hO2Vsc2V7aWYoYSE9dCl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdG9wb2xvZ3kiKTt7aT1zO2NvbnN0IHQ9cjtyPWgsaD10fX1uLnB1c2goW3IsaCxpXSl9cyhuKSxhKG4pO2xldCBoPTA7KC0xIT1uWzBdWzBdfHwtMSE9bltuLmxlbmd0aC0xXVsxXSkmJihoKz0xKSxlWzIqdF09aSxlWzIqdCsxXT1yLnNpemUrKGg8PDgpO2Zvcihjb25zdCB0IG9mIG4pZVtpXT10WzJdLGkrK31oLnZlcnRleE5laWdoYm9ycz1lfXJldHVybiBofWZyZWVCdWZmZXJzKCl7c3VwZXIuZnJlZUJ1ZmZlcnMoKSx0aGlzLmluaXQoKX1yZWFkQmluYXJ5KHQsZSl7c3VwZXIubG9hZEJhc2VHZW9tQmluYXJ5KHQpLHRoaXMuc2V0RmFjZUNvdW50cyh0LmxvYWRVSW50MzJBcnJheSgpKSx0aGlzLl9fZmFjZVZlcnRleENvdW50cz10LmxvYWRVSW50OEFycmF5KHRoaXMuX19mYWNlVmVydGV4Q291bnRzLmxlbmd0aCk7Y29uc3Qgcz10LmxvYWRTSW50MzJWZWMyKCksYT10LmxvYWRVSW50OCgpO2xldCByOzE9PWE/cj10LmxvYWRVSW50OEFycmF5KCk6Mj09YT9yPXQubG9hZFVJbnQxNkFycmF5KCk6ND09YSYmKHI9dC5sb2FkVUludDMyQXJyYXkoKSk7Y29uc3Qgbj10aGlzLmdldE51bUZhY2VzKCk7bGV0IGg9MCxvPTA7Zm9yKGxldCB0PTA7dDxuO3QrKyl7Y29uc3QgZT10aGlzLl9fZmFjZVZlcnRleENvdW50c1t0XSszO3RoaXMuX19mYWNlT2Zmc2V0c1t0XT1oO2ZvcihsZXQgYT0wO2E8ZTthKyspe2NvbnN0IGU9aCthLGk9cltlXStzLng7aWYoMD09dCl0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbZV09aTtlbHNle2xldCBzPXRoaXMuX19mYWNlT2Zmc2V0c1t0LTFdO3MrPWE8bz9hOm8tMSx0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbZV09dGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW3NdK2l9fWgrPWUsbz1lfXRoaXMuX19udW1Qb3B1bGF0ZWRGYWNlVmVydGV4SW5kaWNlcz1oO2NvbnN0IF89dC5sb2FkVUludDMyKCk7aWYoXz4wKXtjb25zdCBlPXRoaXMudmVydGljZXMscz10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgibGlnaHRtYXBDb29yZHMiLGkpO2ZvcihsZXQgYT0wO2E8XzthKyspe2NvbnN0IGE9bmV3IG0odC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyUXVhdCgpKSxyPXQubG9hZEZsb2F0MzIoKSxuPXQubG9hZEZsb2F0MzJWZWMyKCksaD10LmxvYWRTSW50MzJWZWMyKCksbz10LmxvYWRVSW50OCgpO2xldCBfO189MT09bz90LmxvYWRVSW50OEFycmF5KCk6Mj09bz90LmxvYWRVSW50MTZBcnJheSgpOnQubG9hZFVJbnQzMkFycmF5KCk7bGV0IGQ9MDtmb3IoY29uc3QgdCBvZiBfKXtsZXQgbz10K2gueDtvKz1kLGQ9bztjb25zdCBfPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXMobyk7Zm9yKGNvbnN0IHQgb2YgXyl7Y29uc3QgaD1lLmdldFZhbHVlUmVmKHQpLF89YS50cmFuc2Zvcm1WZWMzKGgpLGQ9bmV3IGkoXy54LF8ueik7ZC5zY2FsZUluUGxhY2UociksZC5hZGRJblBsYWNlKG4pLHMuc2V0RmFjZVZlcnRleFZhbHVlX0J5VmVydGV4SW5kZXgobyx0LGQpfX19fXRoaXMuaGFzVmVydGV4QXR0cmlidXRlKCJub3JtYWxzIil8fHRoaXMuY29tcHV0ZVZlcnRleE5vcm1hbHMoKSx0aGlzLmdlb21EYXRhQ2hhbmdlZC5lbWl0KCl9dG9KU09OKHQsZSl7Y29uc3Qgcz1zdXBlci50b0pTT04odCxlKTtyZXR1cm4gMTAyNCZlfHwocy5mYWNlQ291bnRzPUFycmF5LmZyb20odGhpcy5fX2ZhY2VDb3VudHMpLHMuZmFjZVZlcnRleEluZGljZXM9QXJyYXkuZnJvbSh0aGlzLl9fZmFjZVZlcnRleEluZGljZXMpKSxzfWZyb21KU09OKHQsZSxzKXtzdXBlci5mcm9tSlNPTih0LGUscyksdC5mYWNlQ291bnRzJiYodGhpcy5fX2ZhY2VDb3VudHM9VWludDMyQXJyYXkuZnJvbSh0LmZhY2VDb3VudHMpKSx0LmZhY2VWZXJ0ZXhJbmRpY2VzJiYodGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPVVpbnQzMkFycmF5LmZyb20odC5mYWNlVmVydGV4SW5kaWNlcykpfX1jbGFzcyBFe2NvbnN0cnVjdG9yKHQsZT0wLHM9ITApe3RoaXMuX19kYXRhPXQsdGhpcy5fX2J5dGVPZmZzZXQ9ZSx0aGlzLl9fZGF0YVZpZXc9bmV3IERhdGFWaWV3KHRoaXMuX19kYXRhKSx0aGlzLl9faXNNb2JpbGVEZXZpY2U9cyx0aGlzLnV0ZjhkZWNvZGVyPW5ldyBUZXh0RGVjb2Rlcn1nZXQgaXNNb2JpbGVEZXZpY2UoKXtyZXR1cm4gdGhpcy5fX2lzTW9iaWxlRGV2aWNlfWdldCBkYXRhKCl7cmV0dXJuIHRoaXMuX19kYXRhfWdldCBieXRlTGVuZ3RoKCl7cmV0dXJuIHRoaXMuX19kYXRhVmlldy5ieXRlTGVuZ3RofWdldCByZW1haW5pbmdCeXRlTGVuZ3RoKCl7cmV0dXJuIHRoaXMuX19kYXRhVmlldy5ieXRlTGVuZ3RoLXRoaXMuX19ieXRlT2Zmc2V0fXBvcygpe3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldH1zZWVrKHQpe3RoaXMuX19ieXRlT2Zmc2V0PXR9YWR2YW5jZSh0KXt0aGlzLl9fYnl0ZU9mZnNldCs9dH1sb2FkVUludDgoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRVaW50OCh0aGlzLl9fYnl0ZU9mZnNldCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz0xLHR9bG9hZFVJbnQxNigpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQxNih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz0yLHR9bG9hZFVJbnQzMigpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz00LHR9bG9hZFNJbnQzMigpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldEludDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTQsdH1sb2FkRmxvYXQxNigpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDE2KCk7cmV0dXJuIE1hdGguZGVjb2RlMTZCaXRGbG9hdCh0KX1sb2FkVUZsb2F0MTYoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MTYoKTtyZXR1cm4gdDwwPzIwNDgtdDp0fWxvYWRGbG9hdDE2RnJvbTJ4VUludDgoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRGbG9hdDE2KHRoaXMuX19ieXRlT2Zmc2V0LCEwKTtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXQrPTIsdH1sb2FkVUludDMyRnJvbTJ4VUZsb2F0MTYoKXtyZXR1cm4gdGhpcy5sb2FkVUZsb2F0MTYoKSs0MDk2KnRoaXMubG9hZFVGbG9hdDE2KCl9bG9hZFNJbnQzMkZyb20yeEZsb2F0MTYoKXtyZXR1cm4gdGhpcy5sb2FkRmxvYXQxNigpKzIwNDgqdGhpcy5sb2FkRmxvYXQxNigpfWxvYWRGbG9hdDMyKCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0RmxvYXQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz00LHR9bG9hZFVJbnQ4QXJyYXkodCxlPSExKXtudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSk7Y29uc3Qgcz1uZXcgVWludDhBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KTt0aGlzLl9fYnl0ZU9mZnNldCs9dDt0aGlzLl9fYnl0ZU9mZnNldDtyZXR1cm4gc31sb2FkVUludDE2QXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IFVpbnQxNkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZGQoMiksdGhpcy5fX2lzTW9iaWxlRGV2aWNlKXtzPW5ldyBVaW50MTZBcnJheSh0KTtmb3IobGV0IGU9MDtlPHQ7ZSsrKXNbZV09dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQxNih0aGlzLl9fYnl0ZU9mZnNldCwhMCksdGhpcy5fX2J5dGVPZmZzZXQrPTJ9ZWxzZSBzPW5ldyBVaW50MTZBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KSx0aGlzLl9fYnl0ZU9mZnNldCs9Mip0O3JldHVybiBzfWxvYWRVSW50MzJBcnJheSh0LGU9ITEpe2lmKG51bGw9PXQmJih0PXRoaXMubG9hZFVJbnQzMigpKSwwPT10KXJldHVybiBuZXcgVWludDMyQXJyYXk7bGV0IHM7aWYodGhpcy5yZWFkUGFkZCg0KSx0aGlzLl9faXNNb2JpbGVEZXZpY2Upe3M9bmV3IFVpbnQzMkFycmF5KHQpO2ZvcihsZXQgZT0wO2U8dDtlKyspc1tlXT10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKSx0aGlzLl9fYnl0ZU9mZnNldCs9NH1lbHNlIHM9bmV3IFVpbnQzMkFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpLHRoaXMuX19ieXRlT2Zmc2V0Kz00KnQ7cmV0dXJuIHN9bG9hZEZsb2F0MzJBcnJheSh0LGU9ITEpe2lmKG51bGw9PXQmJih0PXRoaXMubG9hZFVJbnQzMigpKSwwPT10KXJldHVybiBuZXcgRmxvYXQzMkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZGQoNCksdGhpcy5fX2lzTW9iaWxlRGV2aWNlKXtzPW5ldyBGbG9hdDMyQXJyYXkodCk7Zm9yKGxldCBlPTA7ZTx0O2UrKylzW2VdPXRoaXMuX19kYXRhVmlldy5nZXRGbG9hdDMyKHRoaXMuX19ieXRlT2Zmc2V0LCEwKSx0aGlzLl9fYnl0ZU9mZnNldCs9NH1lbHNlIHM9bmV3IEZsb2F0MzJBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KSx0aGlzLl9fYnl0ZU9mZnNldCs9NCp0O3JldHVybiBzfWxvYWRTdHIoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQzMigpLGU9bmV3IFVpbnQ4QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz10LHRoaXMudXRmOGRlY29kZXIuZGVjb2RlKGUpfWxvYWRTdHJBcnJheSgpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDMyKCksZT1bXTtmb3IobGV0IHM9MDtzPHQ7cysrKWVbc109dGhpcy5sb2FkU3RyKCk7cmV0dXJuIGV9bG9hZFNJbnQzMlZlYzIoKXtjb25zdCB0PXRoaXMubG9hZFNJbnQzMigpLGU9dGhpcy5sb2FkU0ludDMyKCk7cmV0dXJuIG5ldyBpKHQsZSl9bG9hZFVJbnQzMlZlYzIoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQzMigpLGU9dGhpcy5sb2FkVUludDMyKCk7cmV0dXJuIG5ldyBpKHQsZSl9bG9hZEZsb2F0MTZWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDE2KCksZT10aGlzLmxvYWRGbG9hdDE2KCk7cmV0dXJuIG5ldyBpKHQsZSl9bG9hZEZsb2F0MzJWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyBpKHQsZSl9bG9hZEZsb2F0MTZWZWMzKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDE2KCksZT10aGlzLmxvYWRGbG9hdDE2KCkscz10aGlzLmxvYWRGbG9hdDE2KCk7cmV0dXJuIG5ldyByKHQsZSxzKX1sb2FkRmxvYXQzMlZlYzMoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKSxzPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IHIodCxlLHMpfWxvYWRGbG9hdDE2UXVhdCgpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpLGU9dGhpcy5sb2FkRmxvYXQxNigpLHM9dGhpcy5sb2FkRmxvYXQxNigpLGE9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiBuZXcgdSh0LGUscyxhKX1sb2FkRmxvYXQzMlF1YXQoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKSxzPXRoaXMubG9hZEZsb2F0MzIoKSxhPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IHUodCxlLHMsYSl9bG9hZFJHQkZsb2F0MzJDb2xvcigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpLHM9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgbyh0LGUscyl9bG9hZFJHQkFGbG9hdDMyQ29sb3IoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKSxzPXRoaXMubG9hZEZsb2F0MzIoKSxhPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IG8odCxlLHMsYSl9bG9hZFJHQlVJbnQ4Q29sb3IoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQ4KCksZT10aGlzLmxvYWRVSW50OCgpLHM9dGhpcy5sb2FkVUludDgoKTtyZXR1cm4gbmV3IG8odC8yNTUsZS8yNTUscy8yNTUpfWxvYWRSR0JBVUludDhDb2xvcigpe2NvbnN0IHQ9dGhpcy5sb2FkVUludDgoKSxlPXRoaXMubG9hZFVJbnQ4KCkscz10aGlzLmxvYWRVSW50OCgpLGE9dGhpcy5sb2FkVUludDgoKTtyZXR1cm4gbmV3IG8odC8yNTUsZS8yNTUscy8yNTUsYS8yNTUpfWxvYWRCb3gyKCl7cmV0dXJuIG5ldyBnKHRoaXMubG9hZEZsb2F0MzJWZWMyKCksdGhpcy5sb2FkRmxvYXQzMlZlYzIoKSl9bG9hZEJveDMoKXtyZXR1cm4gbmV3IHAodGhpcy5sb2FkRmxvYXQzMlZlYzMoKSx0aGlzLmxvYWRGbG9hdDMyVmVjMygpKX1yZWFkUGFkZCh0KXtjb25zdCBlPXRoaXMuX19ieXRlT2Zmc2V0JXQ7MCE9ZSYmKHRoaXMuX19ieXRlT2Zmc2V0Kz10LWUpfX1jbGFzcyB2e2NvbnN0cnVjdG9yKHQpe2lmKHQpe2NvbnN0IGU9dC5zcGxpdCgiLSIpLHM9ZVswXS5zcGxpdCgiLiIpO3RoaXMubWFqb3I9cGFyc2VJbnQoc1swXSksdGhpcy5taW5vcj1wYXJzZUludChzWzFdKSx0aGlzLnBhdGNoPXBhcnNlSW50KHNbMl0pLDI9PWUubGVuZ3RoJiYodGhpcy5icmFuY2g9ZVsxXSl9ZWxzZSB0aGlzLm1ham9yPTAsdGhpcy5taW5vcj0wLHRoaXMucGF0Y2g9MH1lcXVhbHModCl7cmV0dXJuISh0aGlzLnBhdGNoPT10WzJdJiZ0aGlzLm1pbm9yPT10WzFdJiZ0aGlzLm1ham9yPT10WzBdKX1sZXNzVGhhbih0KXtyZXR1cm4hKHRoaXMubWFqb3I+PXRbMF18fHRoaXMubWlub3I+PXRbMV18fHRoaXMucGF0Y2g+PXRbMl0pfWdyZWF0ZXJUaGFuKHQpe3JldHVybiB0aGlzLm1ham9yPnRbMF18fHRoaXMubWlub3I+dFsxXXx8dGhpcy5wYXRjaD50WzJdfWdyZWF0ZXJPckVxdWFsVGhhbih0KXtyZXR1cm4hKHRoaXMubWFqb3I8dFswXSkmJih0aGlzLm1ham9yPnRbMF18fCEodGhpcy5taW5vcjx0WzFdKSYmKHRoaXMubWlub3I+dFsxXXx8ISh0aGlzLnBhdGNoPHRbMl0pKSl9fXNlbGYub25tZXNzYWdlPWZ1bmN0aW9uKHQpeygodCxlKT0+e2ZvcihsZXQgZSBpbiB0LmNvbnRleHQudmVyc2lvbnMpe2NvbnN0IHM9dC5jb250ZXh0LnZlcnNpb25zW2VdLGE9bmV3IHY7YS5tYWpvcj1zLm1ham9yLGEubWlub3I9cy5taW5vcixhLnBhdGNoPXMucGF0Y2gsYS5icmFuY2g9cy5icmFuY2gsdC5jb250ZXh0LnZlcnNpb25zW2VdPWF9Y29uc3Qgcz1bXSxpPXQudG9jW3QuZ2VvbXNSYW5nZVswXV0scj1bXTtmb3IobGV0IGU9dC5nZW9tc1JhbmdlWzBdO2U8dC5nZW9tc1JhbmdlWzFdO2UrKyl7Y29uc3Qgbj1uZXcgRSh0LmJ1ZmZlclNsaWNlLHQudG9jW2VdLWksdC5pc01vYmlsZURldmljZSksaD1uLmxvYWRTdHIoKSxvPW4ucG9zKCk7bGV0IF87c3dpdGNoKGgpe2Nhc2UiUG9pbnRzIjpfPW5ldyBBO2JyZWFrO2Nhc2UiTGluZXMiOl89bmV3IFM7YnJlYWs7Y2FzZSJNZXNoIjpfPW5ldyBQO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBHZW9tIHR5cGU6IitoKX10cnl7bi5zZWVrKG8pLF8ucmVhZEJpbmFyeShuLHQuY29udGV4dCl9Y2F0Y2godCl7Y29uc29sZS53YXJuKCJFcnJvciBsb2FkaW5nOiIrXy5uYW1lKyJcbjoiK3QpLHMucHVzaCh7fSk7Y29udGludWV9Y29uc3QgZD1fLmdlbkJ1ZmZlcnModC5nZW5CdWZmZXJzT3B0cyk7ZC5pbmRpY2VzJiZyLnB1c2goZC5pbmRpY2VzLmJ1ZmZlcik7Zm9yKGNvbnN0IHQgaW4gZC5hdHRyQnVmZmVycyl7Y29uc3QgZT1kLmF0dHJCdWZmZXJzW3RdLHM9YS5nZXRUeXBlTmFtZShlLmRhdGFUeXBlKTtlLmRhdGFUeXBlPXMsci5wdXNoKGUudmFsdWVzLmJ1ZmZlcil9ZC52ZXJ0ZXhOZWlnaGJvcnMmJnIucHVzaChkLnZlcnRleE5laWdoYm9ycy5idWZmZXIpLHIucHVzaChfLmJvdW5kaW5nQm94LnAwLl9fZGF0YS5idWZmZXIpLHIucHVzaChfLmJvdW5kaW5nQm94LnAxLl9fZGF0YS5idWZmZXIpLHMucHVzaCh7bmFtZTpfLm5hbWUsdHlwZTpoLGdlb21CdWZmZXJzOmQsYmJveDpfLmJvdW5kaW5nQm94fSl9ZSh7a2V5OnQua2V5LGdlb21JbmRleE9mZnNldDp0Lmdlb21JbmRleE9mZnNldCxnZW9tc1JhbmdlOnQuZ2VvbXNSYW5nZSxnZW9tRGF0YXM6c30scil9KSh0LmRhdGEsKHQsZSk9PntzZWxmLnBvc3RNZXNzYWdlKHQsZSl9KX07Cgo=",null,!1);class Dt{constructor(){this.rangeLoaded=new M,this.streamFileParsed=new M,this.loaded=new M(!0),this.__streamInfos={},this.__genBuffersOpts={},this.__workers=[],this.__nextWorker=0;for(let e=0;e<3;e++)this.__workers.push(this.__constructWorker());this.clear()}clear(){this.__loaded=0,this.__numGeoms=0,this.geoms=[]}__constructWorker(){const e=new Bt;return e.onmessage=e=>{this.__recieveGeomDatas(e.data.key,e.data.geomDatas,e.data.geomIndexOffset,e.data.geomsRange)},e}__terminateWorkers(){for(const e of this.__workers)e.terminate();this.__workers=[]}setGenBufferOption(e,t){this.__genBuffersOpts[e]=t}setNumGeoms(e){this.__numGeoms=e}getGeom(e){return e>=this.geoms.length?null:this.geoms[e]}loadUrl(e){$(e,e=>{this.loadBin(e)},e=>{console.warn(e)})}readBinaryBuffer(e,t,i){const a=r.isMobileDevice,s=new le(t,0,a),n=s.loadUInt32(),l=s.loadUInt32();if(this.__streamInfos[e]={total:n,done:0},0==n)return this.streamFileParsed.emit(1),n;0==this.__numGeoms&&(this.__numGeoms=n);const o=s.loadUInt32Array(n);let d=window.navigator.hardwareConcurrency;d||(d=a?2:4);const h=Math.max(1,Math.floor(n/d+1));let c=0;for(;c<n;){const a=o[c];let r,d;c+h>=n?(d=[c,n],r=t.byteLength):(d=[c,c+h],r=o[d[1]]);const m=t.slice(a,r);c+=h,this.__workers[this.__nextWorker].postMessage({key:e,toc:o,geomIndexOffset:l,geomsRange:d,isMobileDevice:s.isMobileDevice,bufferSlice:m,genBuffersOpts:this.__genBuffersOpts,context:i},[m]),this.__nextWorker=(this.__nextWorker+1)%this.__workers.length}return n}__recieveGeomDatas(e,t,i,a){const s=i+a[0],n=[s,i+a[1]];for(let e=0;e<t.length;e++){const i=t[e];if(!i.type)continue;let a;switch(i.type){case"Points":a=new yt(i);break;case"Lines":a=new Xt(i);break;case"Mesh":case"Plane":case"Sphere":case"Cone":a=new Vt(i);break;default:throw new Error("Unsupported Geom type:"+className)}this.geoms[s+e]=a}this.rangeLoaded.emit(n);const r=n[1]-n[0],l=this.__streamInfos[e];l.done+=r,l.done==l.total&&this.streamFileParsed.emit(1),this.__loaded+=r,this.__loaded==this.__numGeoms&&(this.__terminateWorkers(),this.loaded.emit())}toJSON(){return{numGeoms:this.geoms.length()}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Ot extends zt{constructor(e){super(e),this.__geomLibrary=new Dt,this.__materials=new ct,this.loaded=new M(!0),this.loaded.setToggled(!0)}isLoaded(){return this.loaded.isToggled()}getEngineDataVersion(){return this.__engineDataVersion}getGeometryLibrary(){return this.__geomLibrary}getMaterialLibrary(){return this.__materials}getUnitsConversion(){return this.__unitsScale}readBinary(e,t={}){let i;t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,t.versions["zea-engine"]||(t.versions["zea-engine"]=new re(e.loadStr())),this.__engineDataVersion=t.versions["zea-engine"],console.log("Loading Engine File version:",t.versions["zea-engine"]);const a={};t.addGeomToLayer=(e,t)=>{if(!a[t]){i||(i=new zt("Layers"),this.addChild(i,!1));const e=new kt(t);e.propagateXfoToItems=!1,i.addChild(e,!1),a[t]=e}a[t].addItem(e)};const s=()=>{this.__units=e.loadStr();let t=1;switch(this.__units){case"Millimeters":t=.001;break;case"Centimeters":t=.01;break;case"Meters":t=1;break;case"Kilometers":t=1e3;break;case"Inches":t=.0254;break;case"Feet":t=.3048;break;case"Miles":t=1609.34}this.__unitsScale=t;const i=this.getLocalXfo().clone();i.sc.scaleInPlace(t),this.setLocalXfo(i)};t.versions["zea-engine"].greaterThan([0,0,6])&&s(),this.__materials.readBinary(e,t),super.readBinary(e,t),t.versions["zea-engine"].greaterOrEqualThan([0,0,5])&&t.versions["zea-engine"].lessThan([0,0,7])&&s()}toJSON(e={},t=0){return e.makeRelative=e=>{const t=this.getPath(),i=e.slice(0,t.length);for(let a=0;a<i.length-1;a++)if(i[a]!=t[a])return console.warn("Param Path is not relative to the asset. May not be able to be resolved at load time:"+e),e;const a=e.slice(t.length-1);return a[0]=".",a},e.assetItem=this,super.toJSON(e,t)}fromJSON(e,t={},i=0,a){t||(t={}),t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,null==t.version&&(t.version=0),t.assetItem=this;const s=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not spcecified");const i=this.resolvePath(e);i?t(i):s.push(()=>{const i=this.resolvePath(e);i?t(i):console.warn("Path unable to be resolved:"+e)})},t.addPLCB=e=>s.push(e),super.fromJSON(e,t,i);for(const e of s)e();a&&a()}}z.registerClass("AssetItem",Ot);class At extends zt{constructor(e,t){super(e);const i=this.addParameter(new fe("Image"));t&&i.setValue(t),this.addParameter(new oe("PixelsPerMeter",1e3)),this.addParameter(new oe("Alpha",1)),this.addParameter(new be("Color",new Z(1,1,1))),this.addParameter(new he("AlignedToCamera",!1))}}z.registerClass("BillboardItem",At);class Qt extends zt{constructor(e){null==e&&(e="Camera"),super(e),this.__isOrthographicParam=this.addParameter(new he("isOrthographic",!1)),this.__fovParam=this.addParameter(new oe("fov",1)),this.__nearParam=this.addParameter(new oe("near",.1)),this.__farParam=this.addParameter(new oe("far",1e3)),this.__focalDistanceParam=this.addParameter(new oe("focalDistance",5)),this.projectionParamChanged=new M,this.movementFinished=new M,this.__isOrthographicParam.valueChanged.connect(this.projectionParamChanged.emit),this.__fovParam.valueChanged.connect(this.projectionParamChanged.emit),this.__nearParam.valueChanged.connect(this.projectionParamChanged.emit),this.__farParam.valueChanged.connect(this.projectionParamChanged.emit),this.setPositionAndTarget(new g(3,3,1.75),new g(0,0,1),P.GENERATED_VALUE),this.setLensFocalLength("28mm",P.GENERATED_VALUE)}getNear(){return this.__nearParam.getValue()}setNear(e){this.__nearParam.setValue(e)}getFar(){return this.__farParam.getValue()}setFar(e){this.__farParam.setValue(e)}getFov(){return this.__fovParam.getValue()}setFov(e){this.__fovParam.setValue(e)}setLensFocalLength(e,t=P.USER_SETVALUE){const i={"10mm":100.4,"11mm":95,"12mm":90,"14mm":81.2,"15mm":77.3,"17mm":70.4,"18mm":67.4,"19mm":64.6,"20mm":61.9,"24mm":53.1,"28mm":46.4,"30mm":43.6,"35mm":37.8,"45mm":29.9,"50mm":27,"55mm":24.6,"60mm":22.6,"70mm":19.5,"75mm":18.2,"80mm":17.1,"85mm":16.1,"90mm":15.2,"100mm":13.7,"105mm":13,"120mm":11.4,"125mm":11,"135mm":10.2,"150mm":9.1,"170mm":8.1,"180mm":7.6,"210mm":6.5,"300mm":4.6,"400mm":3.4,"500mm":2.7,"600mm":2.3,"800mm":1.7};!e in i?console.warn("Camera lense focal length not suported:"+e):this.__fovParam.setValue(Math.degToRad(i[e]),t)}getFocalDistance(){return this.__focalDistanceParam.getValue()}setFocalDistance(e,t=P.USER_SETVALUE){e<1e-4&&console.error("Never set focal distance to zero"),this.__focalDistanceParam.setValue(e,t),this.__nearParam.setValue(.01*e,t),this.__farParam.setValue(200*e,t)}getIsOrthographic(){return this.__isOrthographicParam.getValue()}setIsOrthographic(e,t=P.USER_SETVALUE){this.__isOrthographicParam.setValue(e,t)}setPositionAndTarget(e,t,i=P.USER_SETVALUE){this.setFocalDistance(e.distanceTo(t),i);const a=new R;a.setLookAt(e,t,new g(0,0,1)),this.setGlobalXfo(a,i)}getTargetPostion(){const e=this.__focalDistanceParam.getValue(),t=this.getGlobalXfo(),i=t.ori.getZaxis();return i.scaleInPlace(-e),i.addInPlace(t.tr),i}frameView(e,t,i=P.USER_SETVALUE){const a=new W;for(const e of t)a.addBox3(e.getBoundingBox());if(!a.isValid())return void console.warn("Bounding box not valid.");const s=this.__focalDistanceParam.getValue(),n=this.__fovParam.getValue(),r=this.getGlobalXfo().clone(),l=r.ori.getZaxis(),o=l.scale(-s),d=r.tr.add(o),h=a.center().subtract(d);r.tr.addInPlace(h);const c=new W;c.addBox3(a,r.inverse()),c.center();const m=n*(e.getWidth()/e.getHeight()),u=c.p1,b=Math.abs(u.x)/Math.tan(.5*m)*1.2,p=Math.abs(u.y)/Math.tan(.5*n)*1.2,g=-.5*(c.p0.z-c.p1.z),_=Math.max(b,p)+g,f=_-s;r.tr.addInPlace(l.scale(f)),this.setFocalDistance(_,i),this.setGlobalXfo(r,i),this.movementFinished.emit()}updateProjectionMatrix(e,t){this.__isOrthographicParam.getValue();const i=this.__fovParam.getValue(),a=this.__nearParam.getValue(),s=this.__farParam.getValue();e.setPerspectiveMatrix(i,t,a,s)}}z.registerClass("Camera",Qt);class jt extends A{constructor(e){super(e),this.addParameter(new be("BackgroundColor",new Z("#808080"))),this.addParameter(new fe("EnvMap")),this.addParameter(new he("Display EnvMap",!1)),this.addParameter(new oe("EnvMapLOD",0))}}class qt extends Ot{constructor(e){super(e),this.loaded.setToggled(!1),this.lightmap=null,this.geomsLoaded=new M(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.__geomLibrary.loaded.connect(()=>{this.geomsLoaded.emit()}),this.__datafileParam=this.addParameter(new ye("DataFilePath")),this.__datafileParam.valueChanged.connect(()=>{const e=this.__datafileParam.getFileDesc();if(e){if(console.log(e),""==this.getName()){const e=this.__datafileParam.getStem();this.setName(e)}this.geomsLoaded.setToggled(!1),this.loadDataFile(()=>{this.loaded.isToggled()||this.loaded.emit()},()=>{})}}),this.addParameter(new be("LightmapTint",new Z(1,1,1,1)))}readBinary(e,t){if(-1!=t.version){const e=new re;e.patch=t.version,t.versions={"zea-mesh":e,"zea-engine":e},t.meshSdk="FBX"}else{const i=e.loadUInt8();if(e.seek(0),10!=i){const i=new re;i.patch=e.loadUInt32(),t.versions={"zea-mesh":i,"zea-engine":i},t.meshSdk="FBX"}else{const i=new re(e.loadStr());t.versions={"zea-mesh":i},t.meshSdk="FBX"}}this.meshfileversion=t.versions["zea-mesh"],this.meshSdk=t.meshSdk,console.log("Loading CAD File version:",t.versions["zea-mesh"]," exported using SDK:",t.meshSdk);const i=e.loadUInt32();return super.readBinary(e,t),t.versions["zea-engine"].lessThan([0,0,5])&&e.seek(e.byteLength-4),this.__geomLibrary.setNumGeoms(e.loadUInt32()),i}loadDataFile(e,t){const i=this.__datafileParam.getFileDesc();if(!i)return void console.warn("VLAAsset data file not found.");const a=this.__datafileParam.getFileFolderPath(),s=this.__datafileParam.getValue(),n=this.__datafileParam.getStem();let l=0;const o=new RegExp("\\.(vla)$","i").test(i.name),d=[],h=i=>{let a,n=-1;if(i.tree2)a=new le(i.tree2.buffer,0,r.isMobileDevice);else{const e=i.tree?i.tree:i[Object.keys(i)[0]];a=new le(e.buffer,0,r.isMobileDevice),n=0}l=this.readBinary(a,{assetItem:this,version:n}),o||l!=d.length&&console.error("The number of GeomFiles does not match the count given by the VLA file."),e(),0==l&&i.geoms0?(ne.addWork(s+"geoms",1),this.__geomLibrary.readBinaryBuffer(s,i.geoms0.buffer,{version:n}),t()):(ne.addWork(s+"geoms",4*l),c())},c=()=>{const e=[];for(let t=0;t<l;t++)if(o){const i=a+n+t+".vlageoms",s=ne.resolveFilepath(i);if(!s)throw new Error("VLA Geoms file not found:"+i);e.push(m(t,s.url))}else e.push(m(t,d[t].url));Promise.all(e).then(()=>{t&&t()})},m=(e,t)=>new Promise(i=>{ne.loadUrl(s+e,t,e=>{const t=e[Object.keys(e)[0]];this.__geomLibrary.readBinaryBuffer(s,t.buffer),i()},!1)});if(o)ne.loadResource(s,h);else if(i.metadata.ConvertFile){let e;i.metadata.ConvertFile.map(t=>{t.filename.endsWith(".vla")?e=t:t.filename.endsWith(".vlageoms")&&d.push(t)}),e?ne.loadUrl(s,e.url,h):console.warn("ConvertFile metadata contains no vla file.")}this.__geomLibrary.streamFileParsed.connect(e=>{ne.addWorkDone(s+"geoms",e)})}fromJSON(e,t,i){t||(t={}),t.assetItem=this;const a=()=>{super.fromJSON(e,t,i),i&&i()};if(e.params&&e.params.DataFilePath){this.__datafileLoaded=a;const i=e.params.DataFilePath;delete e.params.DataFilePath,this.__datafileParam.fromJSON(i,t)}else a()}}z.registerClass("VLAAsset",qt);const $t=new Z("#DCDCDC");class ei extends A{constructor(e){super(e),this.setFlag(D.USER_EDITED),this.__outputs=[],this.__evalOutput=this.__evalOutput.bind(this),this.postEval=new M}setDirty(){for(const e of this.__outputs)e.setDirtyFromOp()}__parameterValueChanged(e,t){this.setDirty()}addOutput(e){return this.__outputs.push(e),e.paramSet.connect(e=>{e.bindOperator(this)}),e}removeOutput(e){e.getParam()&&e.getParam().unbindOperator(this),this.__outputs.splice(this.__outputs.indexOf(e),1)}getNumOutputs(){return this.__outputs.length}getOutputByIndex(e){return this.__outputs[e]}getOutput(e){for(const t of this.__outputs)if(t.getName()==e)return t}__evalOutput(e){for(const e of this.__outputs)e.removeCleanerFn(this.__evalOutput);this.evaluate()}__opInputChanged(){this.setDirty()}evaluate(){throw new Error("Not yet implemented")}toJSON(e,t){const i=super.toJSON(e,t);i.type=z.getClassName(this);const a=[];for(const i of this.__outputs)a.push(i.toJSON(e,t));return i.outputs=a,i}fromJSON(e,t,i){if(super.fromJSON(e,t,i),e.outputs){for(let i=0;i<this.__outputs.length;i++)this.__outputs[i].fromJSON(e.outputs[i],t);t.addPLCB(()=>{this.__opInputChanged()})}}detach(){this.__outputs.forEach(e=>e.detach())}reattach(){this.__outputs.forEach(e=>e.reattach())}destroy(){super.destroy(),this.__outputs=[]}}class ti{constructor(e,t){this.__name=e,this.__filterFn=t,this._param=void 0,this.detached=!1,this.paramSet=new M}getName(){return this.__name}getFilterFn(){return this.__filterFn}isConnected(){return null!=this._param}getParam(){return this._param}setParam(e){this._param=e,this.paramSet.emit()}getValue(e=U.OPERATOR_GETVALUE){if(this._param)return this._param.getValue(e)}setValue(e,t=P.OPERATOR_SETVALUE){this._param&&this._param.setValue(e,t)}setClean(e){this._param&&this._param.setClean(e)}setDirty(e){this._param&&this._param.setDirty(e)}setDirtyFromOp(){this._param&&this._param.setDirtyFromOp()}removeCleanerFn(e){this._param&&this._param.removeCleanerFn(e)}toJSON(e,t){const i=this._param?this._param.getPath():"";return{type:z.getClassName(this),paramPath:e&&e.makeRelative?e.makeRelative(i):i}}fromJSON(e,t,i){e.paramPath&&t.resolvePath(e.paramPath,e=>{this.setParam(e)},t=>{console.warn("Operator Output: '"+this.getName()+"'. Unable to load item:"+e.paramPath)})}detach(){this.detached=!0}reattach(){this.detached=!1}}z.registerClass("OperatorOutput",ti);class ii extends ti{constructor(e){super(e,e=>"Xfo"==e.getDataType())}getInitialValue(){return this._initialParamValue}setParam(e){(()=>{if(this._initialParamValue=e.getValue(),this._initialParamValue.clone&&(this._initialParamValue=this._initialParamValue.clone()),null==this._initialParamValue)throw new Error("WTF?")})(),this._param=e,this.paramSet.emit(e)}}z.registerClass("XfoOperatorOutput",ii);class ai extends Ve{constructor(e){super(e),this.__stageParam=this._addMember(new oe("Stage",0)),this.__axisParam=this._addMember(new me("Axis",new g(1,0,0))),this.__movementParam=this._addMember(new ce("MovementTiming",new p(0,1),[new p(0,0),new p(1,1)])),this.__multiplierParam=this._addMember(new oe("Multiplier",1)),this.__output=new ii("Part")}getStage(e=P.USER_GETVALUE){return this.__stageParam.getValue(e)}setStage(e,t=P.USER_SETVALUE){this.__stageParam.setValue(e,t)}getOutput(){return this.__output}evaluate(e,t,i,a,s,n,r,l){if(!this.__output.isConnected())return;const o=this.__stageParam.getValue(),d=this.__movementParam.getValue();let h;if(s){let i=o/a;n&&(i-=.5),h=t*Math.linStep(d.x,d.y,Math.max(0,e-i))}else{let i=1-o/a;n&&(i-=.5),h=t*Math.linStep(d.x,d.y,e)*i}h+=i;let c=this.__axisParam.getValue();const m=this.__multiplierParam.getValue(),u=this.__output.getInitialValue();let b;r?(b=l.multiply(u),c=r.ori.rotateVec3(c),b.tr.addInPlace(c.scale(h*m))):(b=this.__output.getValue(),b.tr=u.tr.add(c.scale(h*m))),this.__output.setClean(b)}toJSON(e,t){const i=super.toJSON(e,t);return i&&(i.output=this.__output.toJSON(e,t)),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.output&&this.__output.fromJSON(e.output,t)}}class si extends ei{constructor(e){super(e),this.__stagesParam=this.addParameter(new oe("Stages",0)),this._explodeParam=this.addParameter(new oe("Explode",0,[0,1])),this._distParam=this.addParameter(new oe("Dist",1)),this._offsetParam=this.addParameter(new oe("Offset",0)),this._cascadeParam=this.addParameter(new he("Cascade",!1)),this._centeredParam=this.addParameter(new he("Centered",!1)),this.__parentItemParam=this.addParameter(new Ie("RelativeTo")),this.__parentItemParam.valueChanged.connect(()=>{const e=this.__parentItemParam.getValue();this.__invParentSpace=e?e.getGlobalXfo().inverse():void 0}),this.__parentItemParam.treeItemGlobalXfoChanged.connect(()=>{this.setDirty()}),this.__itemsParam=this.addParameter(new Xe("Parts",ai)),this.__itemsParam.elementAdded.connect((e,t)=>{if(t>0){const i=this.__itemsParam.getElement(t-1).getStage();e.setStage(i+1),this.__stagesParam.setClean(i+2)}else this.__stagesParam.setClean(1);this.addOutput(e.getOutput()),this.setDirty()}),this.__itemsParam.elementRemoved.connect((e,t)=>{this.removeOutput(e.getOutput())}),this.__localXfos=[],this.__parts=[],this.__stages=2}evaluate(){const e=this.__stagesParam.getValue(),t=this._explodeParam.getValue(),i=this._distParam.getValue(),a=this._offsetParam.getValue(),s=this._cascadeParam.getValue(),n=this._centeredParam.getValue(),r=this.__parentItemParam.getValue();let l,o;r&&(l=r.getGlobalXfo(),o=this.__invParentSpace.multiply(l));const d=this.__itemsParam.getValue();for(let r=0;r<d.length;r++)d[r].evaluate(t,i,a,e,s,n,l,o)}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){super.fromJSON(e,t,i)}destroy(){clearTimeout(this.__timeoutId),super.destroy()}}z.registerClass("ExplodePartsOperator",si);class ni extends Ve{constructor(e){super(e),this.__ratioParam=this._addMember(new oe("Ratio",1)),this.__offsetParam=this._addMember(new oe("Offset",0)),this.__axisParam=this._addMember(new me("Axis",new g(1,0,0))),this.__output=new ii("Gear")}getOutput(){return this.__output}getRatio(){return this.__ratioParam.getValue()}getOffset(){return this.__offsetParam.getValue()}getAxis(){return this.__axisParam.getValue()}toJSON(e,t){const i=super.toJSON(e,t);return i&&(i.output=this.__output.toJSON(e,t)),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.output&&this.__output.fromJSON(e.output,t)}}class ri extends ei{constructor(e){super(e),this.__revolutionsParam=this.addParameter(new oe("Revolutions",0));const t=this.addParameter(new oe("RPM",0));this.__timeoutId,t.valueChanged.connect(()=>{const e=t.getValue();if(Math.abs(e)>0){if(!this.__timeoutId){const e=()=>{const i=t.getValue(),a=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(a+i*(1/3e3)),this.__timeoutId=setTimeout(e,20)};e()}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0}),this.__gearsParam=this.addParameter(new Xe("Gears",ni)),this.__gearsParam.elementAdded.connect((e,t)=>{this.addOutput(e.getOutput())}),this.__gearsParam.elementRemoved.connect((e,t)=>{this.removeOutput(t)}),this.__gears=[]}evaluate(){const e=this.__revolutionsParam.getValue(),t=this.__gearsParam.getValue();t.length;for(const i of t){const t=i.getOutput(),a=t.getInitialValue();if(!a)return;const s=e*i.getRatio()+i.getOffset(),n=new V;n.setFromAxisAndAngle(i.getAxis(),s*Math.PI*2);const r=t.getValue();r.ori=n.multiply(a.ori),t.setClean(r)}}detach(){super.detach(),this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null)}reattach(){super.reattach(),this.getParameter("RPM").valueChanged.emit()}destroy(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null),super.destroy()}}z.registerClass("GearsOperator",ri);class li extends Ve{constructor(){super("Piston"),this.__pistonAngleParam=this._addMember(new oe("PistonAngle",0)),this.__camPhaseParam=this._addMember(new oe("CamPhase",0)),this.__camLengthParam=this._addMember(new oe("CamLength",3)),this.__rodLengthParam=this._addMember(new oe("RodLength",3)),this.__rodoutput=new ii("Rod"),this.__capoutput=new ii("Cap"),this.__pistonAngleParam.valueChanged.connect(this.init.bind(this)),this.__camPhaseParam.valueChanged.connect(this.init.bind(this)),this.__camLengthParam.valueChanged.connect(this.init.bind(this)),this.__rodLengthParam.valueChanged.connect(this.init.bind(this)),this.__bindXfos={}}getRodOutput(){return this.__rodoutput}getCapOutput(){return this.__capoutput}setCrankXfo(e){this.__baseCrankXfo=e,this.init()}init(){if(!this.__baseCrankXfo)return;const e=this.__camPhaseParam.getValue(),t=this.__camLengthParam.getValue(),i=this.__rodLengthParam.getValue(),a=this.__pistonAngleParam.getValue(),s=new g(Math.sin(Math.degToRad(a)),Math.cos(Math.degToRad(a)),0);this.__pistonAxis=this.__baseCrankXfo.ori.rotateVec3(s),this.__camVec=this.__baseCrankXfo.ori.rotateVec3(new g(Math.sin(2*e*Math.PI)*t,Math.cos(2*e*Math.PI)*t,0));const n=2*e*Math.PI,r=Math.sin(n)*t,l=Math.sqrt(i*i-r*r)+Math.cos(n)*t;this.__pistonOffset=l}evaluate(e,t,i){const a=this.__camPhaseParam.getValue(),s=this.__camLengthParam.getValue(),n=this.__rodLengthParam.getValue(),r=2*(a+i)*Math.PI,l=Math.sin(r)*s,o=Math.asin(l/n),d=Math.sqrt(n*n-l*l)+Math.cos(r)*s;if(this.__rodoutput.isConnected()){const i=this.__rodoutput.getInitialValue().clone(),a=this.__rodoutput.getValue(),s=a.tr.subtract(this.__baseCrankXfo.tr).dot(t),n=new V;n.setFromAxisAndAngle(t,-o),a.tr=this.__baseCrankXfo.tr.add(e.rotateVec3(this.__camVec)),a.tr.addInPlace(t.scale(s)),a.ori=n.multiply(i.ori),this.__rodoutput.setValue(a)}if(this.__capoutput.isConnected()){const e=this.__capoutput.getInitialValue().clone(),t=this.__capoutput.getValue();t.tr=e.tr.add(this.__pistonAxis.scale(d-this.__pistonOffset)),this.__capoutput.setValue(t)}}setOwner(e){this.__owner=e}getOwner(){return this.__owner}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){super.fromJSON(e,t,i)}clone(e){return new li(this.__name,this.__value)}}class oi extends ei{constructor(e){super(e),this.__revolutionsParam=this.addParameter(new oe("Revolutions",0,[0,1]));const t=this.addParameter(new oe("RPM",0));t.valueChanged.connect(()=>{let e=t.getValue();if(e>0){if(!this.__timeoutId){const i=()=>{e=t.getValue();const a=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(a+e*(1/3e3)),this.__timeoutId=setTimeout(i,20)};i()}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0}),this.__crankOutput=this.addOutput(new ii("Crank")),this.__crankOutput.paramSet.connect(this.init.bind(this)),this.__crankAxisParam=this.addParameter(new me("CrankAxis",new g(1,0,0))),this.__crankAxisParam.valueChanged.connect(()=>{this.__baseCrankXfo.ori.setFromDirectionAndUpvector(this.__crankAxisParam.getValue(),new g(0,0,1)),this.init()}),this.__pistonsParam=this.addParameter(new Xe("Pistons",li)),this.__pistonsParam.elementAdded.connect(e=>{e.setCrankXfo(this.__baseCrankXfo),this.addOutput(e.getRodOutput()),this.addOutput(e.getCapOutput())}),this.__pistonsParam.elementRemoved.connect(e=>{this.removeOutput(e.getRodOutput()),this.removeOutput(e.getCapOutput())}),this.__baseCrankXfo=new R,this.__pistons=[]}setOwner(e){super.setOwner(e)}getCrankOutput(){return this.__crankOutput}init(){const e=this.__pistonsParam.getValue();for(const t of e)t.setCrankXfo(this.__baseCrankXfo);this.__crankOutput.isConnected()&&(this.__crankOffset=this.__baseCrankXfo.inverse().multiply(this.__crankOutput.getInitialValue()))}evaluate(){const e=this.__revolutionsParam.getValue(U.OPERATOR_GETVALUE),t=this.__crankAxisParam.getValue(U.OPERATOR_GETVALUE),i=new V;if(i.setFromAxisAndAngle(t,e*Math.PI*2),this.__crankOutput.isConnected()){const e=this.__crankOutput.getValue();e.ori=i.multiply(this.__crankOutput.getInitialValue().ori),this.__crankOutput.setValue(e)}const a=this.__pistonsParam.getValue(),s=a.length;for(let n=0;n<s;n++)a[n].evaluate(i,t,e);this.postEval.emit(e)}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){super.fromJSON(e,t,i),e.crankOutput&&this.__crankOutput.fromJSON(e.crankOutput,t),this.init()}destroy(){clearTimeout(this.__timeoutId),super.destroy()}}z.registerClass("PistonOperator",oi);class di extends ei{constructor(e){super(e),this.__inputParam=this.addParameter(new oe("Input")),this.__routesParam=this.addParameter(new Xe("Routes",oe)),this.__routesParam.elementAdded.connect(e=>{e.setValue(1),this.addOutput(new ti("Output"))}),this.__routesParam.elementRemoved.connect((e,t)=>{this.removeOutput(this.getOutputByIndex(t))})}evaluate(){const e=this.__inputParam.getValue(U.OPERATOR_GETVALUE),t=this.__routesParam.getValue();let i=this.__outputs.length;for(;i--;)this.__outputs[i].setValue(e*t[i].getValue(U.OPERATOR_GETVALUE));this.postEval.emit(e)}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,i){super.fromJSON(e,t,i)}destroy(){super.destroy()}}z.registerClass("RouterOperator",di);class hi extends ei{constructor(e){super(e),this.addParameter(new oe("Weight",1)),this.addParameter(new de("Axis",0,["+X Axis","-X Axis","+Y Axis","-Y Axis","+Z Axis","-Z Axis"])),this.addParameter(new oe("Stretch",0)),this.addParameter(new oe("Initial Dist",1)),this.addParameter(new _e("Target")),this.addOutput(new ii("InputOutput"))}resetStretchRefDist(){const e=this.getParameter("Target").getValue(),t=this.getOutputByIndex(0).getValue(),i=e.tr.subtract(t.tr).length();this.getParameter("Initial Dist").setValue(i)}evaluate(){const e=this.getParameter("Weight").getValue(),t=this.getParameter("Target").getValue(),i=this.getParameter("Axis").getValue(),a=this.getOutputByIndex(0),s=a.getValue(),n=t.tr.subtract(s.tr),r=n.length();if(r<1e-6)return;let l;switch(n.scaleInPlace(1/r),i){case 0:l=s.ori.getXaxis();break;case 1:l=s.ori.getXaxis().negate();break;case 2:l=s.ori.getYaxis();break;case 3:l=s.ori.getYaxis().negate();break;case 4:l=s.ori.getZaxis();break;case 5:l=s.ori.getZaxis().negate()}let o=new V;o.setFrom2Vectors(l,n),o.alignWith(new V),e<1&&(o=(new V).lerp(o,e)),s.ori=o.multiply(s.ori);const d=this.getParameter("Stretch").getValue();if(d>0){const e=1+(r/this.getParameter("Initial Dist").getValue()-1)*d;switch(i){case 0:case 1:s.sc.x=e;break;case 2:case 3:s.sc.y=e;break;case 4:case 5:s.sc.z=e}}a.setClean(s)}}z.registerClass("AimOperator",hi);class ci extends B{constructor(e){null==e&&(e="Camera"),super(e),this.__defaultManipulationState="orbit",this.__manipulationState=this.__defaultManipulationState,this.__mouseDown=!1,this.__dragging=!1,this.__mouseDragDelta=new p,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new g,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new oe("orbitRate",r.isMobileDevice?-.3:1)),this.__dollySpeedParam=this.addParameter(new oe("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new oe("mouseWheelDollySpeed",5e-4)),this.movementFinished=new M}setDefaultManipulationMode(e){this.__defaultManipulationState=e}look(e,t){const{viewport:i}=e,a=i.getCamera(),s=a.getFocalDistance(),n=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const e=a.getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const r=this.__mouseDownCameraXfo.clone(),l=new V;l.rotateZ(t.x/i.getWidth()*Math.PI*n),r.ori=l.multiply(r.ori);const o=new V;o.rotateX(t.y/i.getHeight()*Math.PI*n),r.ori.multiplyInPlace(o),this.__keyboardMovement,a.setGlobalXfo(r)}orbit(e,t){const{viewport:i}=e,a=i.getCamera(),s=a.getFocalDistance(),n=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const e=a.getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t)}const r=this.__mouseDownCameraXfo.clone(),l=new V;l.rotateZ(t.x/i.getWidth()*2*Math.PI*-n),r.ori=l.multiply(r.ori);const o=new V;o.rotateX(t.y/i.getHeight()*Math.PI*-n),r.ori.multiplyInPlace(o),r.tr=this.__mouseDownCameraTarget.add(r.ori.getZaxis().scale(s)),this.__keyboardMovement,a.setGlobalXfo(r)}pan(e,t){const{viewport:i}=e,a=i.getCamera(),s=a.getFocalDistance(),n=a.getFov(),r=new g(1,0,0),l=new g(0,1,0),o=2*s*Math.tan(.5*n),d=o*(i.getWidth()/i.getHeight()),h=new R;h.tr=r.scale(-t.x/i.getWidth()*d),h.tr.addInPlace(l.scale(t.y/i.getHeight()*o)),a.setGlobalXfo(this.__mouseDownCameraXfo.multiply(h))}dolly(e,t){const{viewport:i}=e,a=i.getCamera(),s=t.x*this.__dollySpeedParam.getValue(),n=new R;n.tr.set(0,0,s),a.setGlobalXfo(this.__mouseDownCameraXfo.multiply(n))}panAndZoom(e,t,i){const{viewport:a}=e,s=a.getCamera(),n=s.getFocalDistance(),r=s.getFov(),l=new g(1,0,0),o=new g(0,1,0),d=2*n*Math.tan(.5*r),h=d*(a.getWidth()/a.getHeight()),c=new R;c.tr=l.scale(-t.x/a.getWidth()*h),c.tr.addInPlace(o.scale(t.y/a.getHeight()*d));const m=i*n;s.setFocalDistance(this.__mouseDownFocalDist+m),c.tr.z+=m,s.setGlobalXfo(this.__mouseDownCameraXfo.multiply(c))}initDrag(e){const{viewport:t}=e,i=t.getCamera(),a=i.getFocalDistance();this.__mouseDown=!0,this.__calculatingDragAction=!1,this.__mouseDownPos=e.mousePos,this.__mouseDownViewport=t,this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=i.getGlobalXfo().clone(),this.__mouseDownZaxis=this.__mouseDownCameraXfo.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-a);this.__mouseDownCameraTarget=i.getGlobalXfo().tr.add(s),this.__mouseDownFocalDist=a,this.__dragListenerId=i.getParameter("GlobalXfo").valueChanged.connect(this.__globalXfoChangedDuringDrag.bind(this))}__globalXfoChangedDuringDrag(e){this.__calculatingDragAction||(this.__mouseDownViewport.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.initDrag({viewport:this.__mouseDownViewport,mousePos:this.__mouseDownPos}))}endDrag(e){if(this.__dragListenerId){const{viewport:t}=e;t.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.__dragListenerId=null}this.__mouseDown=!1,this.__dragging=!1}aimFocus(e,t){const{viewport:i}=e,a=i.getCamera();this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let s=0;const n=()=>{const e=a.getGlobalXfo(),i=a.getFocalDistance(),r=t.subtract(e.tr),l=r.normalizeInPlace(),o=new V,d=new V;{const t=e.ori.getZaxis().clone();t.z=0;const i=r.negate();i.z=0,o.setFrom2Vectors(t,i)}{const t=e.ori.getZaxis().clone(),i=r.negate();t.x=i.x,t.y=i.y,t.normalizeInPlace(),t.cross(i).dot(e.ori.getXaxis())>0?d.rotateX(t.angleTo(i)):d.rotateX(-t.angleTo(i))}const h=e.clone();h.ori=o.multiply(h.ori),h.ori.multiplyInPlace(d);const c=Math.pow(s/20,2),m=e.clone();m.ori=e.ori.lerp(h.ori,c),a.setFocalDistance(i+(l-i)*c),a.setGlobalXfo(m),s++,s<=20?this.__focusIntervalId=setTimeout(n,20):(this.__focusIntervalId=void 0,this.movementFinished.emit())};n(),this.__manipulationState="focussing"}onMouseMove(e){}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera().getGlobalXfo().tr.add(e.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(e,t)}}onMouseDown(e){this.initDrag(e),2==e.button?this.__manipulationState="pan":e.ctrlKey&&e.altKey?this.__manipulationState="dolly":e.ctrlKey||2==e.button?this.__manipulationState="look":this.__manipulationState=this.__defaultManipulationState}onMouseMove(e){if(!this.__mouseDown)return;const t=e.mousePos;switch(this.__calculatingDragAction=!0,this.__keyboardMovement?this.__mouseDragDelta=t:this.__mouseDragDelta=t.subtract(this.__mouseDownPos),this.__manipulationState){case"orbit":this.orbit(e,this.__mouseDragDelta);break;case"look":this.look(e,this.__mouseDragDelta);break;case"pan":this.pan(e,this.__mouseDragDelta);break;case"dolly":this.dolly(e,this.__mouseDragDelta)}this.__dragging=!0,this.__calculatingDragAction=!1,e.stopPropagation()}onMouseUp(e){this.__dragging&&(this.movementFinished.emit(),e.stopPropagation()),this.endDrag(e)}onWheel(e){const{viewport:t}=e,i=t.getCamera(),a=this.__mouseWheelDollySpeedParam.getValue(),s=e.shiftKey?.1:.5,n=i.getGlobalXfo(),r=n.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let l=0;const o=()=>{const t=i.getFocalDistance(),d=e.deltaY*a*t*s;n.tr.addInPlace(r.scale(d)),"orbit"==this.__defaultManipulationState&&i.setFocalDistance(i.getFocalDistance()+d),i.setGlobalXfo(n),l++,l<10?this.__mouseWheelZoomIntervalId=setTimeout(o,10):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit())};o()}__integrateVelocityChange(e){const{viewport:t}=e,i=t.getCamera(),a=new R;a.tr=this.__velocity.normalize().scale(this.__maxVel),i.setGlobalXfo(i.getGlobalXfo().multiply(a))}onKeyPressed(e,t){return!1}onKeyDown(e,t){}onKeyUp(e,t){}__startTouch(e){this.__ongoingTouches[e.identifier]={identifier:e.identifier,pos:new p(e.pageX,e.pageY)}}__endTouch(e){delete this.__ongoingTouches[e.identifier]}onTouchStart(e){console.log("onTouchStart"),e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);1==Object.keys(this.__ongoingTouches).length&&(this.initDrag(e),this.__dragging=!0)}onTouchMove(e){e.preventDefault(),e.stopPropagation(),this.__calculatingDragAction=!0;const t=e.touches;if(1==t.length&&"panAndZoom"!=this.__manipMode){const i=t[0],a=new p(i.pageX,i.pageY),s=this.__ongoingTouches[i.identifier].pos.subtract(a);"look"==this.__defaultManipulationState?(s.scaleInPlace(6),this.look(e,s)):this.orbit(e,s)}else if(2==t.length){const i=t[0],a=this.__ongoingTouches[i.identifier],s=t[1],n=this.__ongoingTouches[s.identifier],r=new p(i.pageX,i.pageY),l=new p(s.pageX,s.pageY),o=n.pos.subtract(a.pos).length()-l.subtract(r).length(),d=r.subtract(a.pos),h=l.subtract(n.pos),c=d.add(h);c.scaleInPlace(.5),this.panAndZoom(e,c,.002*o),this.__manipMode="panAndZoom"}this.__calculatingDragAction=!1}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e)}onTouchCancel(e){e.preventDefault();const t=e.touches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e)}onDoubleTap(e){if(e.intersectionData){const{viewport:t}=e,i=t.getCamera().getGlobalXfo().tr.add(e.touchRay.dir.scale(e.intersectionData.dist));this.aimFocus(e,i)}e.preventDefault()}}var mi=Object.freeze({__proto__:null,RefCounted:K,ParameterOwner:B,ItemFlags:D,BaseItem:A,getFileFolder:function(e){return e.substring(0,e.lastIndexOf("/"))+"/"},loadTextfile:q,loadJSONfile:function(e,t,i,a){Q(e,"json",e=>{t(e.response,e)},t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)})},loadXMLfile:function(e,t,i,a){Q(e,"document",e=>{t(e.responseXML)},t=>{if(null==i)throw new Error("Unable to XHR File:"+e);i(t)})},loadBinfile:$,sgFactory:z,isObject:se,mergeDeep:function e(t,...i){if(!i.length)return t;const a=i.shift();if(se(t)&&se(a))for(const i in a)se(a[i])?(t[i]||Object.assign(t,{[i]:{}}),e(t[i],a[i])):Object.assign(t,{[i]:a[i]});return e(t,...i)},resourceLoader:ne,Version:re,BinReader:le,BinWriter:class{constructor(e=0){this.__data=new ArrayBuffer(e),this.__byteOffset=0,this.__reserved=e,this.__dataView=new DataView(this.__data)}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e}seekEnd(){this.__byteOffset=this.__reserved}getBuffer(){return this.__data.byteLength==this.__byteOffset?this.__data:new Uint8Array(this.__data).slice(0,this.__byteOffset).buffer}__grow(){const e=2*(this.__reserved>0?this.__reserved:1),t=new ArrayBuffer(e),i=new Uint8Array(t),a=new Uint8Array(this.__data);i.set(a),this.__data=t,this.__dataView=new DataView(this.__data),this.__reserved=e}__reserve(e){this.__byteOffset+e>this.__reserved&&this.__grow()}__offset(e){this.__byteOffset+=e,this.__byteOffset>this.__reserved&&this.__grow()}writeUInt8(e){this.__reserve(1),this.__dataView.setUint8(this.__byteOffset,e),this.__offset(1)}writeUInt16(e){this.__reserve(2),this.__dataView.setUint16(this.__byteOffset,e,!0),this.__offset(2)}writeUInt32(e){this.__reserve(4),this.__dataView.setUint32(this.__byteOffset,e,!0),this.__offset(4)}writeSInt32(e){this.__reserve(4),this.__dataView.setInt32(this.__byteOffset,e,!0),this.__offset(4)}writeFloat16(e){const t=Math.encode16BitFloat(e);this.writeUInt16(t)}writeFloat32(e){this.__reserve(4),this.__dataView.setFloat32(this.__byteOffset,e,!0),this.__offset(4)}writeUInt8Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt8(e[t])}writeUInt16Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(2*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt16(e[t])}writeUInt32Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeUInt32(e[t])}writeFloat32Array(e,t=!0){const i=e.size?e.size:e.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let t=0;t<i;t++)this.writeFloat32(e[t])}writeStr(e,t=!0){const i=value.length;this.__reserve(4*i+(t?4:0)),t&&this.writeUInt32(i);for(let e=0;e<i;e++)this.writeFloat32(value.charCodeAt(e))}writeSInt32Vec2(e){this.writeSInt32(e.x),this.writeSInt32(e.y)}writeUInt32Vec2(e){this.writeUInt32(e.x),this.writeUInt32(e.y)}writeFloat16Vec2(e){this.writeFloat16(e.x),this.writeFloat16(e.y)}writeFloat32Vec2(e){this.writeFloat32(e.x),this.writeFloat32(e.y)}writeFloat16Vec3(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z)}writeFloat32Vec3(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeFloat16Quat(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z),this.writeFloat16(e.w)}writeFloat32Quat(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z),this.writeFloat32(e.w)}writeRGBFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b)}writeRGBAFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b),this.writeFloat32(e.a)}writeRGBUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b)}writeRGBAUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b),this.writeUInt8(e.a)}writeBox2(e){this.writeFloat32Vec2(e.p0),this.writeFloat32Vec2(e.p1)}writeBox3(e){this.writeFloat32Vec3(e.p0),this.writeFloat32Vec3(e.p1)}writePadd(e){const t=e-this.__byteOffset;this.__reserve(t),this.__offset(t)}writeAlignment(e){const t=this.__byteOffset%e;0!=t&&(this.__reserve(e-t),this.__offset(e-t))}},ParamFlags:E,ValueGetMode:U,ValueSetMode:P,BaseParameter:J,Parameter:H,MultiChoiceParameter:de,BooleanParameter:he,NumberParameter:oe,Vec2Parameter:ce,Vec3Parameter:me,Vec4Parameter:ue,ColorParameter:be,Mat3Parameter:pe,Mat4Parameter:ge,XfoParameter:_e,ImageParameter:fe,StringParameter:Ze,CodeParameter:Ge,FilePathParameter:ye,ListParameter:Xe,StructParameter:Ve,TreeItemParameter:Ie,ItemSetParameter:Re,ProxyParameter:xe,GeometryParameter:Se,MaterialParameter:ut,MaterialFloatParam:Le,MaterialColorParam:ve,Attribute:bt,BaseGeom:pt,SAVE_FLAG_SKIP_GEOMDATA:1024,VertexAttribute:gt,Points:_t,Lines:ft,Mesh:Zt,PointsProxy:yt,LinesProxy:Xt,MeshProxy:Vt,PointGrid:class extends _t{constructor(e=1,t=1,i=1,a=1,s=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(i)||isNaN(a))throw new Error("Invalid geom args");this.__x=e,this.__y=t,this.__xDivisions=i,this.__yDivisions=a,s&&this.addVertexAttribute("texCoords",p),this.__rebuild()}get x(){return console.warn("getter is deprectated. Please use 'getX'"),this.getX()}set x(e){console.warn("getter is deprectated. Please use 'setX'"),this.setX(e)}get y(){return console.warn("getter is deprectated. Please use 'getY'"),this.getY()}set y(e){console.warn("getter is deprectated. Please use 'setY'"),this.setY(e)}getX(){return this.__x}setX(e){this.__x=e,this.__resize()}getY(){return this.__y}setY(e){this.__y=e,this.__resize()}setSize(e,t){this.__x=e,this.__y=t,this.__resize()}__rebuild(){this.setNumVertices(this.__xDivisions*this.__yDivisions);const e=this.getVertexAttribute("texCoords");if(e)for(let t=0;t<this.__yDivisions;t++){const i=t/(this.__yDivisions-1);for(let a=0;a<this.__xDivisions;a++){const s=a/(this.__xDivisions-1);e.getValueRef(t*this.__xDivisions+a).set(s,i)}}this.__resize()}__resize(){for(let e=0;e<this.__yDivisions;e++){const t=(e/(this.__yDivisions-1)-.5)*this.__y;for(let i=0;i<this.__xDivisions;i++){const a=(i/(this.__xDivisions-1)-.5)*this.__x;this.getVertex(e*this.__xDivisions+i).set(a,t,0)}}this.setBoundingBoxDirty()}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.xDivisions=this.__xDivisions,e.yDivisions=this.__yDivisions,e}},Rect:It,Circle:Rt,Cross:xt,LinesCuboid:St,Grid:Wt,Cone:Lt,Cuboid:vt,Cylinder:Tt,Disc:Mt,Plane:Ct,Sphere:Ft,Torus:wt,DataImage:Ce,FileImage:Qe,FileImage2D:class extends Qe{constructor(e,t={}){console.warn("FileImage2D is becoming deprecated in favor of simple FileImage"),super(e,t)}},LDRImage:qe,LDRVideo:$e,GIFImage:et,EnvMap:lt,Label:dt,VideoStreamImage2D:ht,labelManager:ot,SaveFlags:Nt,LoadFlags:Yt,CloneFlags:Kt,TreeItem:zt,InstanceItem:Ut,AudioItem:Pt,FileAudioItem:class extends Pt{constructor(e){}},BaseGeomItem:Et,GeomItem:Jt,AssetItem:Ot,BillboardItem:At,Camera:Qt,Group:kt,GeomLibrary:Dt,Material:Me,BaseImage:We,MaterialLibrary:ct,Scene:class{constructor(e){e&&ne.setResources(e),this.settings=new jt("Scene Settings"),this.root=new zt("root"),this.root.addChild(this.settings),this.__commonResources={}}getSettings(){return this.settings}getRoot(){return this.root}getResourceLoader(){return ne}setEnvMap(e){console.warn("Deprecated Function. Please access the Scene Settings object."),this.settings.getParameter("EnvMap").setValue(e)}addAsset(e){console.warn("Deprecated Function. Please access the Scene Root object."),this.root.addChild(e,!1)}setupGrid(e=5,t=50,i=$t){const a=new zt("Grid"),s=new Me("gridMaterial","LinesShader");s.getParameter("BaseColor").setValue(i);const n=new Wt(e,e,t,t,!0);a.addChild(new Jt("GridItem",n,s),!1);const r=new ft;r.setNumVertices(2),r.setNumSegments(1),r.setSegment(0,0,1),r.getVertex(0).set(-.5*e,0,0),r.getVertex(1).set(.5*e,0,0);const l=new Me("gridXAxisMaterial","LinesShader");l.getParameter("BaseColor").setValue(new Z(i.luminance(),0,0)),a.addChild(new Jt("xAxisLine",r,l),!1);const o=new Me("gridZAxisMaterial","LinesShader");o.getParameter("BaseColor").setValue(new Z(0,i.luminance(),0));const d=new R;d.ori.setFromAxisAndAngle(new g(0,0,1),.5*Math.PI);const h=new Jt("yAxisLine",r,o);return h.setGeomOffsetXfo(d),a.addChild(h,!1),a.setSelectable(!1,!0),a.setFlag(D.IGNORE_BBOX),a.clearFlag(D.USER_EDITED),a.setFlag(D.INVISIBLE),this.root.addChild(a,!1),a}loadCommonAssetResource(e){if(e in this.__commonResources)return this.__commonResources[e];const t=new qt;return t.getParameter("DataFilePath").setValue(e),this.__commonResources[e]=t,t}toJSON(e={},t=0){return e.makeRelative=e=>e,{root:this.root.toJSON(e,t)}}fromJSON(e,t={}){const i=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not spcecified");const a=this.root.resolvePath(e);a?t(a):i.push(()=>{const i=this.resolvePath(e);i?t(i):console.warn("Path unable to be resolved:"+e)})},t.addPLCB=e=>i.push(e),t.settings=this.settings,e.root&&this.root.fromJSON(e.root,t);for(const e of i)e()}},VLAAsset:qt,ObjAsset:class extends Ot{constructor(e){super(e),this.geomsLoaded=new M(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.addParameter(new he("splitObjects",!1)),this.addParameter(new he("splitGroupsIntoObjects",!1)),this.addParameter(new he("loadMtlFile",!0)),this.addParameter(new oe("unitsConversion",1)),this.addParameter(new Ze("defaultShader","")),this.objfileParam=this.addParameter(new ye("ObjFilePath")),this.objfileParam.valueChanged.connect(()=>{this.loaded.untoggle(),this.__loadObj(()=>{this.loaded.emit()},()=>{this.geomsLoaded.emit()})}),this.geomLibrary=new Dt,this.materials=new ct}getGeometryLibrary(){return this.geomLibrary}getMaterialLibrary(){return this.materials}__loadObj(e,t){const i=this.objfileParam.getStem(),a=e=>{const t=e.split("\n"),i=/\s+/;let a;const s=function(e){if(3==e.length)return new Z(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));throw new Error("Unable to parse a color from the following parts:"+e.join("_"))},n=e=>{const t=this.objfileParam.getFileFolder();return new FileImage(e[0],t+e[0])};for(let e=0;e<t.length;e++){let r=t[e].trim();if(r.startsWith("#"))continue;-1!=r.indexOf("#")&&(r=r.substring(0,r.indexOf("#")).trim());const l=r.split(i),o=l.shift(),d=l.join(" ");switch(o){case"newmtl":a=new Me(d),a.setShaderName("StandardSurfaceShader"),this.materials.addMaterial(a);break;case"Kd":a.getParameter("BaseColor").setValue(s(l));break;case"map_Kd":a.getParameter("BaseColor").setValue(n(l));break;case"Ks":const e=(parseFloat(l[0])+parseFloat(l[1])+parseFloat(l[2]))/3;a.roughness=1-e,a.getParameter("Roughness").setValue(1-e),a.getParameter("Reflectance").setValue(e);break;case"map_Ks":a.getParameter("Roughness").setValue(n(l)),a.getParameter("Reflectance").setValue(.2);break;case"d":const t=parseFloat(d);t<1&&(a.setShaderName("TransparentSurfaceShader"),a.getParameter("Opacity").setValue(t));break;case"map_d":a.getParameter("alpha").setValue(parseFloat(l));break;case"map_bump":a.getParameter("normal").setValue(n(l))}}},s=new F;s.incAsyncCount(),s.ready.connect(()=>{c()});const n=e=>new Promise(t=>{q(e.url,e=>{ne.addWorkDone(i,1),a(e),s.decAsyncCount(),ne.addWorkDone(i,1),t()})}),r=new Array,l=new Array,o=new Array,d={},h=async e=>{const t=e.split("\n"),a=/\s+/;let h=void 0,c=void 0;const m=e=>{let t=0;for(;e in d;)t++,e+=String(t);h={verticesRemapping:{},texCoordsRemapping:{},normalsRemapping:{},vertexIndices:[],texCoordIndices:[],normalIndices:[],numVertices:0,numTexCoords:0,numNormals:0,numTris:0,numQuads:0,material:c},d[e]=h};m(i);const u=this.getParameter("splitGroupsIntoObjects").getValue();for(let e=0;e<t.length;e++){let b=t[e].trim();if(b.startsWith("#"))continue;-1!=b.indexOf("#")&&(b=b.substring(0,b.indexOf("#")).trim());const p=b.split(a),g=p.shift(),_=p.join(" ");switch(g){case"":case"s":continue;case"mtllib":if(!this.getParameter("loadMtlFile").getValue())continue;s.incAsyncCount(),ne.addWork(i,2);const e=this.objfileParam.getFileFolderPath(),t=ne.resolveFilepath(e+_);t&&await n(t);break;case"o":m(_);break;case"usemtl":c=_,m(_+Object.keys(d).length);break;case"g":u&&m(p.join("_"));break;case"v":r.push(p.map(e=>parseFloat(e)));break;case"vt":o.push(p.map(e=>parseFloat(e)));break;case"vn":l.push(p.map(e=>parseFloat(e)));break;case"f":{const e=[],t=[],i=[];for(let a=0,s=p.length;a<s;a++){const s=p[a].split("/").map(e=>parseInt(e)-1),n=s[0];let r=h.verticesRemapping[n];if(null==r&&(r=h.numVertices,h.verticesRemapping[n]=r,h.numVertices++),e.push(r),s.length>1&&!isNaN(s[1])){const e=s[1];t.push(e)}if(s.length>2&&!isNaN(s[2])){const e=s[2];i.push(e)}}h.vertexIndices.push(e),i.length>0&&h.normalIndices.push(i),t.length>0&&h.texCoordIndices.push(t),3==e.length?h.numTris++:h.numQuads++;break}default:console.warn("Unhandled line:"+b)}}s.decAsyncCount()},c=()=>{for(const e in d)0!=d[e].numVertices&&m(e,d[e]);e(),t()},m=(e,t)=>{const i=t.numVertices,a=new Zt(e);a.setFaceCounts([t.numTris,t.numQuads]),a.setNumVertices(i);const s=a.getVertexAttribute("positions"),n=this.getParameter("unitsConversion").getValue();for(const e in t.verticesRemapping){const i=t.verticesRemapping[e];s.getValueRef(i).set(r[e][0]*n,r[e][1]*n,r[e][2]*n)}let d,h;t.normalIndices.length>0&&(d=a.addVertexAttribute("normals",g)),t.texCoordIndices.length>0&&(h=a.addVertexAttribute("texCoords",p));for(let e=0;e<t.vertexIndices.length;e++){const i=t.vertexIndices[e];if(a.setFaceVertexIndices(e,...i),d){const i=t.normalIndices[e];for(let t=0;t<i.length;t++){const a=new g(l[i[t]][0],l[i[t]][1],l[i[t]][2]);d.setFaceVertexValue(e,t,a)}}if(h&&t.texCoordIndices.length==t.vertexIndices.length){const i=t.texCoordIndices[e];for(let t=0;t<i.length;t++){const a=new p(o[i[t]][0],o[i[t]][1]);h.setFaceVertexValue(e,t,a)}}}const c=new Jt(e,a);c.selectable=!0;const m=a.boundingBox.center();if(a.moveVertices(m.negate()),c.setLocalXfo(new R(m)),null!=t.material&&this.materials.hasMaterial(t.material))c.setMaterial(this.materials.getMaterial(t.material));else{const t=this.getParameter("defaultShader").getValue(),i=new Me(e+"mat");i.setShaderName(""!=t?t:"StandardSurfaceShader");const a=i.getParameter("BaseColor");if(a)a.setValue(Z.random(.5));else{const e=i.getParameter("Color");e&&e.setValue(Z.random(.5))}const s=i.getParameter("Roughness");s&&s.setValue(.6);const n=i.getParameter("Reflectance");n&&n.setValue(.2),this.materials.addMaterial(i),c.setMaterial(i)}this.addChild(c,!1)};(()=>{const e=this.objfileParam.getFileDesc(),t=this.objfileParam.getStem();ne.addWork(t,2),q(e.url,e=>{ne.addWorkDone(t,1),h(e),ne.addWorkDone(t,1)})})()}},Operator:ei,OperatorOutput:ti,XfoOperatorOutput:ii,ExplodePartsOperator:si,GearsOperator:ri,PistonOperator:oi,RouterOperator:di,AimOperator:hi,CameraMouseAndKeyboard:ci});const ui=function(e,t){console.log(r);let i=null;if(null!=t.webglContextType)try{i=e.getContext(t.webglContextType,t),i.name=t.webglContextType}catch(e){}else["webgl2","webgl"].some(a=>{try{i=e.getContext(a,t),i.name=a}catch(e){}if(i)return!0});if(i)return i.sizeInBytes=function(e){switch(e){case this.BYTE:case this.UNSIGNED_BYTE:return 1;case this.SHORT:case this.UNSIGNED_SHORT:return 2;case this.INT:case this.UNSIGNED_INT:case this.FLOAT:return 4;default:throw new Error("unknown type")}},"webgl2"==i.name?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear"),i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear"),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float")):(i.__ext_float=i.getExtension("OES_texture_float"),i.__ext_float?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear")):console.warn("OES_texture_float is not available"),i.__ext_half_float=i.getExtension("OES_texture_half_float"),i.__ext_half_float&&(i.HALF_FLOAT=i.__ext_half_float.HALF_FLOAT_OES,i.floatTexturesSupported=!0,i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear")),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float"),i.__ext_std_derivatives=i.getExtension("OES_standard_derivatives"),i.__ext_Inst=i.getExtension("ANGLE_instanced_arrays"),i.__ext_Inst&&(i.vertexAttribDivisor=i.__ext_Inst.vertexAttribDivisorANGLE.bind(i.__ext_Inst),i.drawArraysInstanced=i.__ext_Inst.drawArraysInstancedANGLE.bind(i.__ext_Inst),i.drawElementsInstanced=i.__ext_Inst.drawElementsInstancedANGLE.bind(i.__ext_Inst)),i.__ext_VAO=i.getExtension("OES_vertex_array_object"),i.__ext_VAO&&(i.createVertexArray=i.__ext_VAO.createVertexArrayOES.bind(i.__ext_VAO),i.deleteVertexArray=i.__ext_VAO.deleteVertexArrayOES.bind(i.__ext_VAO),i.bindVertexArray=i.__ext_VAO.bindVertexArrayOES.bind(i.__ext_VAO)),i.__ext_element_index_uint=i.getExtension("OES_element_index_uint"),i.__ext_WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),i.__ext_WEBGL_depth_texture&&(i.UNSIGNED_INT_24_8=i.__ext_WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL),i.DRAW_FRAMEBUFFER=i.FRAMEBUFFER),i.__ext_frag_depth=i.getExtension("EXT_frag_depth"),i.setupInstancedQuad=function(){const e=new Float32Array([0,1,2,3]),t=new Uint16Array([0,1,2,2,1,3]);this.__quadVertexIdsBuffer=this.createBuffer(),this.bindBuffer(this.ARRAY_BUFFER,this.__quadVertexIdsBuffer),this.bufferData(this.ARRAY_BUFFER,e,this.STATIC_DRAW),this.__quadIndexBuffer=this.createBuffer(),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.__quadIndexBuffer),this.bufferData(this.ELEMENT_ARRAY_BUFFER,t,this.STATIC_DRAW),this.__quadattrbuffers={vertexIDs:{buffer:this.__quadVertexIdsBuffer,dataType:6,dimension:1,count:e.length,shared:!0}}},i.drawQuad=function(){this.drawElements(this.TRIANGLES,6,this.UNSIGNED_SHORT,0)},i.setupLineSegAttrBuffers=function(){const e=new Float32Array([0,1]),t=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.__linesegattrbuffers={vertexIDs:{buffer:t,dimension:1,count:e.length,shared:!0}}},i};class bi extends K{constructor(e,t){if(super(),this.__gl=e,this.ready=new M(!0),this.updated=new M,this.resized=new M,this.width=0,this.height=0,this.textureType=1,this.textureDesc=[0,0,0,0],this.__loaded=!1,this.__bound=!1,null!=t)if(t instanceof We){this.__texture=t,this.__texture.setMetadata("gltexture",this);const e=()=>{const e=this.__texture.getParams(),t=e.width,i=e.height,a=e.data;this.bufferData(a,t,i)};this.__texture.isLoaded()?(this.configure(this.__texture.getParams()),this.__texture.updated.connect(e)):this.__texture.loaded.connect(()=>{this.configure(this.__texture.getParams()),this.__texture.updated.connect(e)})}else this.configure(t)}isLoaded(){return this.__loaded}getTexture(){return this.__texture}getInternalFormat(){return this.__internalFormat}getType(){return this.__typeParam}getTypeID(){return this.__type}getFormat(){return this.__formatParam}getFormatID(){return this.__format}getFilter(){return this.__filterParam}getWrap(){return this.__wrapParam}getMipMapped(){return this.__mipMapped}configure(e,t=!0){if(!("type"in e&&"format"in e&&"width"in e&&"height"in e))throw new Error("Invalid texture params");const i=this.__gl,a=e.width,s=e.height,n=e.data,r=i.getParameter(i.MAX_TEXTURE_SIZE);if(a<=0||a>r||s<=0||s>r)throw new Error("gl-texture2d: Invalid texture size. width:"+a+" height:"+s+" maxSize:"+r);const l=e.format,o=e.type;let d="minFilter"in e?e.minFilter:"filter"in e?e.filter:"LINEAR",h="magFilter"in e?e.magFilter:"filter"in e?e.filter:"LINEAR";const c="wrap"in e?e.wrap:"CLAMP_TO_EDGE";if("FLOAT"==o)if(this.textureType=3,"webgl2"==i.name)"LINEAR"!=d||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST");else if(i.__ext_float)"LINEAR"!=d||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||i.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST");else{if(!i.__ext_half_float)throw new Error("OES_texture_half_float is not available");o="HALF_FLOAT","LINEAR"!=d||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST")}else if("HALF_FLOAT"==o)if("webgl2"==i.name);else{if(!i.supportUploadingHalfFloat&&null!=n)throw new Error("Safari does not support uploading HALF_FLOAT texture data.");if(!i.__ext_half_float)throw new Error("OES_texture_half_float is not available");if("LINEAR"!=d||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||i.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST"),"RGB"==l)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==o&&!i.__ext_sRGB)throw new Error("EXT_sRGB is not available");this.__formatParam=l,this.__typeParam=o,this.__minFilterParam=d,this.__magFilterParam=h,this.__wrapParam=c,this.__format=i[l],this.__internalFormat="internalFormat"in e?i[e.internalFormat]:this.__format,this.__type=i[o],"webgl2"==i.name&&("internalFormat"in e||(this.__type==i.FLOAT?this.__format==i.RED?this.__internalFormat=i.R32F:this.__format==i.RG?this.__internalFormat=i.RG32F:this.__format==i.RGB?this.__internalFormat=i.RGB32F:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA32F):this.__type==i.HALF_FLOAT?this.__format==i.RED?this.__internalFormat=i.R16F:this.__format==i.RG?this.__internalFormat=i.RG16F:this.__format==i.RGB?this.__internalFormat=i.RGB16F:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA16F):this.__type==i.UNSIGNED_BYTE&&(this.__format==i.RED&&(this.__internalFormat=i.R8),this.__format==i.RG&&(this.__internalFormat=i.RG8),this.__format==i.RGB?this.__internalFormat=i.RGB8:this.__format==i.RGBA&&(this.__internalFormat=i.RGBA8)))),this.__minFilter=i[d],this.__magFilter=i[h],this.__wrap=i[c],this.__flipY="flipY"in e&&e.flipY,this.__mipMapped="mipMapped"in e&&e.mipMapped,this.invert="invert"in e&&e.invert,this.alphaFromLuminance="alphaFromLuminance"in e&&e.alphaFromLuminance,this.textureDesc=[a,s,0,0],this.__gltex&&i.deleteTexture(this.__gltex),this.__gltex=i.createTexture(),this.__updateGLTexParams(),n?this.bufferData(n,a,s,!1,!1):this.resize(a,s,!1,!1),this.__loaded||(this.ready.emit(),this.__loaded=!0)}__updateGLTexParams(){const e=this.__gl;e.bindTexture(e.TEXTURE_2D,this.__gltex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.__minFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.__magFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this.__wrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this.__wrap)}bufferData(e,t=-1,i=-1,a=!0,s=!0){const n=this.__gl;if(a&&n.bindTexture(n.TEXTURE_2D,this.__gltex),null!=e){if(e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,this.__format,this.__type,e),this.width=e.width,this.height=e.height;else{-1==t&&(t=this.width),-1==i&&(i=this.height);const a=t*i;let s;switch(this.__format){case n.RED:case n.RED_INTEGER:case n.ALPHA:case n.LUMINANCE:case n.LUMINANCE_ALPHA:s=1;break;case n.RG:s=2;break;case n.RGB:s=3;break;case n.RGBA:s=4}e.length!=a*s&&console.warn("Invalid data for Image width:"+t+" height:"+i+" format:"+this.__formatParam+" type:"+this.__typeParam+" Data Length:"+e.length+" Expected:"+a*s),this.__type==n.HALF_FLOAT&&e instanceof Float32Array&&(e=Math.convertFloat32ArrayToUInt16Array(e)),"webgl2"==n.name?n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,e,0):n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,e),this.width=t,this.height=i}this.__mipMapped&&n.generateMipmap(n.TEXTURE_2D)}else n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,null),this.width=t,this.height=i;s&&this.updated.emit()}clear(){const e=this.__gl,t=this.width*this.height;let i,a;switch(this.__format){case e.RED:case e.RED_INTEGER:case e.ALPHA:case e.LUMINANCE:case e.LUMINANCE_ALPHA:i=1;break;case e.RG:i=2;break;case e.RGB:i=3;break;case e.RGBA:i=4;break;default:throw new Error("Invalid Format")}switch(this.__type){case e.UNSIGNED_BYTE:a=new UInt8Array(t*i);break;case e.HALF_FLOAT:a=new UInt16Array(t*i);break;case e.FLOAT:a=new Float32Array(t*i);break;default:throw new Error("Invalid Type")}"webgl2"==e.name?e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,a,0):e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,a)}resize(e,t,i=!1,a=!0){const s=this.__gl;if(this.width!=e||this.height!=t){const n=s.getParameter(s.MAX_TEXTURE_SIZE);if(e<0||e>n||t<0||t>n)throw new Error("gl-texture2d: Invalid texture size. width:"+e+" height:"+t+" maxSize:"+n);if(i){const i=s.createTexture();s.bindTexture(s.TEXTURE_2D,i),s.texImage2D(s.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);const a=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,a),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.__gltex,0),s.bindTexture(s.TEXTURE_2D,i),s.copyTexImage2D(s.TEXTURE_2D,0,this.__internalFormat,0,0,this.width,this.height,0),s.bindFramebuffer(s.FRAMEBUFFER,null),s.deleteFramebuffer(a),this.__gl.deleteTexture(this.__gltex),this.__gltex=i,this.__updateGLTexParams()}else s.bindTexture(s.TEXTURE_2D,this.__gltex),s.texImage2D(s.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);this.width=e,this.height=t,a&&this.resized.emit(e,t)}}populate(e,t,i,a=0,s=0,n=!0){const r=this.__gl;n&&r.bindTexture(r.TEXTURE_2D,this.__gltex),r.texSubImage2D(r.TEXTURE_2D,0,a,s,t,i,this.__format,this.__type,e)}getSize(){return[this.width,this.height]}get glTex(){return this.__gltex}getTexHdl(){return this.__gltex}bind(e,t){return console.warn("'bind' is deprecated. Please use 'bindToUniform'"),this.bindToUniform(e,t)}preBind(e,t){return{textureTypeUnif:t[e.name+"Type"],textureDescUnif:t[e.name+"Desc"]}}bindToUniform(e,t,i){if(!this.__loaded)return!1;if(!this.__gltex)throw new Error("Unable to bind non-initialized or deleted texture.");const a=e.boundTextures++,s=this.__gl.TEXTURE0+a,n=this.__gl;return n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,this.__gltex),n.uniform1i(t.location,a),i&&(i.textureTypeUnif&&n.uniform1i(i.textureTypeUnif.location,this.textureType),i.textureDescUnif&&this.__gl.uniform4fv(i.textureDescUnif.location,this.textureDesc)),!0}destroy(){super.destroy(),this.__texture&&this.__texture.setMetadata("gltexture",void 0),this.__gl.deleteTexture(this.__gltex),this.__gltex=void 0}}class pi{constructor(e,t,i,a){this.__gl=e,this.__shaderAttrs=t,this.__glattrbuffers=i,this.__indexBuffer=a}bind(e){const t=this.__gl;for(const e in this.__shaderAttrs){if("instancedIds"==e)continue;const i=this.__shaderAttrs[e],a=i.location;if(-1==a)continue;const s=this.__glattrbuffers[e];if(!s){t.disableVertexAttribArray(a);continue}let n,r,l;switch(s.dataType){case 0:n=1,r=4,l=t.UNSIGNED_BYTE;break;case 1:n=1,r=4,l=t.BYTE;break;case 2:n=1,r=4,l=t.UNSIGNED_SHORT;break;case 3:n=1,r=4,l=t.SHORT;break;case 4:n=1,r=4,l=t.UNSIGNED_INT;break;case 5:n=1,r=4,l=t.INT;break;case 6:n=1,r=4,l=t.FLOAT;break;case p:n=2,r=4,l=t.FLOAT;break;case g:n=3,r=4,l=t.FLOAT;break;case _:case Z:n=4,r=4,l=t.FLOAT;break;case f:n=4,r=1,l=t.UNSIGNED_BYTE;break;default:throw"Unhandled Type"}const o=n*r,d=null!=s.offset?s.offset*n*r:0,h=1==s.normalized,c=i.instanced;t.enableVertexAttribArray(a),t.bindBuffer(t.ARRAY_BUFFER,s.buffer),t.vertexAttribPointer(a,n,l,h,o,d),t.vertexAttribDivisor&&(1==c?t.vertexAttribDivisor(a,1):t.vertexAttribDivisor(a,0))}return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;for(const t in this.__shaderAttrs){const i=this.__shaderAttrs[t].location;-1!=i&&(e.disableVertexAttribArray(i),e.vertexAttribDivisor(i,0))}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}destroy(){}}class gi{constructor(e,t,i,a){this.__gl=e,this.__vao=e.createVertexArray(),e.bindVertexArray(this.__vao);for(const a in t){if("instancedIds"==a)continue;const s=t[a],n=s.location;if(-1==n)continue;const r=i[a];if(!r){e.disableVertexAttribArray(n);continue}let l,o,d;switch(r.dataType){case 0:l=1,o=4,d=e.UNSIGNED_BYTE;break;case 1:l=1,o=4,d=e.BYTE;break;case 2:l=1,o=4,d=e.UNSIGNED_SHORT;break;case 3:l=1,o=4,d=e.SHORT;break;case 4:l=1,o=4,d=e.UNSIGNED_INT;break;case 5:l=1,o=4,d=e.INT;break;case 6:l=1,o=4,d=e.FLOAT;break;case p:l=2,o=4,d=e.FLOAT;break;case g:l=3,o=4,d=e.FLOAT;break;case _:case Z:l=4,o=4,d=e.FLOAT;break;case f:l=4,o=1,d=e.UNSIGNED_BYTE;break;default:throw"Unhandled Type"}const h=l*o,c=null!=r.offset?r.offset*l*o:0,m=1==r.normalized,u=s.instanced;e.enableVertexAttribArray(n),e.bindBuffer(e.ARRAY_BUFFER,r.buffer),e.vertexAttribPointer(n,l,d,m,h,c),u?e.vertexAttribDivisor(n,1):e.vertexAttribDivisor(n,0)}this.__indexBuffer=a}bind(e){return this.__gl.bindVertexArray(this.__vao),this.__indexBuffer&&this.__gl.bindBuffer(this.__gl.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;for(const t in this.__shaderAttrs){const i=this.__shaderAttrs[t].location;-1!=i&&(e.disableVertexAttribArray(i),e.vertexAttribDivisor(i,0))}this.__gl.bindVertexArray(null),this.__indexBuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}destroy(){this.__gl.deleteVertexArray(this.__vao)}}function _i(e,t,i,a){return null==e.createVertexArray?new pi(e,t,i,a):new gi(e,t,i,a)}class fi extends K{constructor(e,t){super(),this.__gl=e,this.__geom=t,this.__glattrs={},this.__glattrbuffers={},this.__shaderBindings={},this.destructing=new M,this.updated=new M,this.__geom.geomDataChanged.connect(e=>{this.updateBuffers(e),this.updated.emit()}),this.__geom.geomDataTopologyChanged.connect(e=>{this.clearShaderBindings(),this.updateBuffers(e),this.updated.emit()})}getGeom(){return this.__geom}genBuffers(){}updateBuffers(e){}bind(e){if(this.__destroyed)throw new Error("Error binding a destroyed geom");let t=this.__shaderBindings[e.shaderkey];return t||(t=_i(this.__gl,e.attrs,this.__glattrbuffers,this.__indexBuffer),this.__shaderBindings[e.shaderkey]=t),t.bind(e),!0}unbind(e){const t=this.__shaderBindings[e.shaderkey];t&&t.unbind(e)}draw(){throw new Error("Not implemented. Implement this method in a derived class.")}drawInstanced(e){throw new Error("Not implemented. Implement this method in a derived class.")}bindAndDraw(e){this.bind(e),this.draw(e)}clearShaderBindings(){for(const e in this.__shaderBindings)this.__shaderBindings[e].destroy();this.__shaderBindings={}}destroy(){this.__geom.deleteMetadata("glgeom"),this.clearShaderBindings();const e=this.__gl;for(const t in this.__glattrbuffers){const i=this.__glattrbuffers[t];i.shared||e.deleteBuffer(i.buffer)}this.__glattrs={},this.__shaderBindings={},this.__destroyed=!0,this.destructing.emit(this)}}class Zi extends fi{constructor(e,t){super(e,t),this.genBuffers()}getNumTriangles(){return this.__numTriangles}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers(),i=t.indices;this.__numTriIndices=t.indices.length,i instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),i instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),i instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT),this.__numTriangles=i.length/3,this.__numRenderVerts=t.numRenderVerts,this.__indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t.indices,e.STATIC_DRAW);for(const i in t.attrBuffers){const a=t.attrBuffers[i],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,a.values,e.STATIC_DRAW),this.__glattrbuffers[i]={buffer:s,dataType:a.dataType,normalized:a.normalized},"textureCoords"==i&&(this.__glattrbuffers.texCoords=this.__glattrbuffers.textureCoords)}}updateBuffers(e){const t=this.__gl,i=this.__geom.genBuffers({includeIndices:!1});for(const e in i.attrBuffers){const a=i.attrBuffers[e],s=this.__glattrbuffers[e];t.bindBuffer(t.ARRAY_BUFFER,s.buffer),t.bufferData(t.ARRAY_BUFFER,a.values,t.STATIC_DRAW)}}getNumUnSplitVerts(){return this.__geom.vertices.length}getNumSplitVerts(){return this.__numRenderVerts}generateWireframesVAO(){if(!this.__vao)return!1;this.__geom.edgeVerts||this.__geom.genTopologyInfo(),this.__wireframesVao&&this.__ext.deleteVertexArrayOES(this.__wireframesVao),this.__wireframesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__wireframesVao);const e=this.__gl,t=e.createBuffer(),i=Uint32Array.from(this.__geom.edgeVerts);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW);const a=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numWireIndices=i.length,this.__ext.bindVertexArrayOES(null)}bindWireframeVAO(e){return null!=this.__wireframesVao&&(this.__ext.bindVertexArrayOES(this.__wireframesVao),!0)}unbindWireframeVAO(){this.__ext.bindVertexArrayOES(null)}drawWireframe(){this.__wireframesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numWireIndices,this.__gl.UNSIGNED_INT,0)}generateHardEdgesVAO(){if(!this.__vao)return!1;this.__geom.edgeVerts||this.__geom.generateHardEdgesFlags(),this.__hardEdgesVao&&this.__ext.deleteVertexArrayOES(this.__hardEdgesVao),this.__hardEdgesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__hardEdgesVao);const e=this.__gl,t=e.createBuffer(),i=Uint32Array.from(this.__geom.computeHardEdgesIndices());e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW);const a=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numEdgeIndices=i.length,this.__ext.bindVertexArrayOES(null)}bindHardEdgesVAO(e){return null!=this.__hardEdgesVao&&(this.__ext.bindVertexArrayOES(this.__hardEdgesVao),!0)}unbindHardEdgesVAO(){this.__ext.bindVertexArrayOES(null)}drawHardEdges(){this.__hardEdgesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numEdgeIndices,this.__gl.UNSIGNED_INT,0)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(){this.__gl.drawElements(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0)}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0,e)}destroy(){super.destroy(),this.__gl.deleteBuffer(this.__indexBuffer),this.__indexBuffer=void 0}}class Gi extends fi{constructor(e,t){super(e,t),this.genBuffers()}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers(),i=t.indices;if(this.fatLines=(this.__geom.lineThickness>0||t.attrBuffers.lineThickness)&&e.floatTexturesSupported,this.fatLines){e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__glattrbuffers.vertexIDs=e.__quadattrbuffers.vertexIDs,this.__drawCount=i.length/2;const t=this.__geom.getVertexAttributes(),a=t.positions,s=t.lineThickness,n=4,r=new Float32Array(a.length*n);for(let e=0;e<a.length;e++)g.createFromFloat32Buffer(r.buffer,4*e).setFromOther(a.getValueRef(e)),r[4*e+3]=s?s.getFloat32Value(e):this.__geom.lineThickness;this.__positionsTexture=new bi(e,{format:"RGBA",type:"FLOAT",width:a.length,height:1,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",data:r,mipMapped:!1});const l=new Float32Array(i.length);for(let e=0;e<i.length;e++){let t;t=e%2==0?e>0?i[e]==i[e-1]:i[e]==i[i.length-1]:e<i.length-1?i[e]==i[e+1]:i[e]==i[0],l[e]=(t?1:0)+2*i[e]}const o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,l,e.STATIC_DRAW),this.__glattrbuffers.segmentIndices={buffer:o,dimension:2}}else{this.__indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW);for(const i in t.attrBuffers){const a=t.attrBuffers[i],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,a.values,e.STATIC_DRAW),this.__glattrbuffers[i]={buffer:s,dataType:a.dataType,normalized:a.normalized}}this.__numSegIndices=i.length,this.__numVertices=t.numVertices}i instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),i instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),i instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT)}updateBuffers(e){const t=this.__gl,i=this.__geom.genBuffers(),a=i.indices;if(this.fatLines){this.__drawCount=a.length/2;const e=this.__geom.getVertexAttributes(),i=e.positions,s=e.lineThickness,n=4,r=new Float32Array(i.length*n);for(let e=0;e<i.length;e++)g.createFromFloat32Buffer(r.buffer,4*e).setFromOther(i.getValueRef(e)),r[4*e+3]=s?s.getFloat32Value(e):this.__geom.lineThickness;this.__positionsTexture.bufferData(r,i.length,1);const l=new Float32Array(a.length);for(let e=0;e<a.length;e++){let t;t=e%2==0?e>0&&a[e]==a[e-1]:e<a.length-1&&a[e]==a[e+1],l[e]=(t?1:0)+2*a[e]}t.bindBuffer(t.ARRAY_BUFFER,this.__glattrbuffers.segmentIndices.buffer),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW)}else{if(this.__geom.getVertexAttributes(),e&&e.indicesChanged){const e=this.__geom.getIndices();this.__numSegIndices!=e.length&&(t.deleteBuffer(this.__indexBuffer),this.__indexBuffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,t.STATIC_DRAW),this.__numSegIndices=e.length}const s=i.numVertices!=this.__numVertices;for(const e in i.attrBuffers){const a=i.attrBuffers[e],n=this.__glattrbuffers[e];s&&(t.deleteBuffer(n.buffer),n.buffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.bufferData(t.ARRAY_BUFFER,a.values,t.STATIC_DRAW)}this.__numVertices=i.numVertices,this.__numSegIndices=a.length}a instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),a instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),a instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT)}bind(e){if(this.fatLines&&"LineThickness"in e.unifs){const t=this.__gl;let i=this.__shaderBindings[e.shaderkey];i||(i=_i(t,e.attrs,this.__glattrbuffers,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=i),i.bind(e);{const i=e.unifs;i.positionsTexture&&(this.__positionsTexture.bindToUniform(e,i.positionsTexture),t.uniform1i(i.positionsTextureSize.location,this.__positionsTexture.width))}const a=e.unifs;return t.uniform1f(a.LineThickness.location,(this.__geom.lineThickness?this.__geom.lineThickness:1)*e.viewScale),!0}return super.bind(e)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(e){const t=this.__gl;this.fatLines?e.unifs.LineThickness&&t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__drawCount):t.drawElements(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0)}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0,e)}}class yi extends fi{constructor(e,t){super(e,t),this.genBuffers()}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers();for(const i in t.attrBuffers){const a=t.attrBuffers[i],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,a.values,e.STATIC_DRAW),this.__glattrbuffers[i]={buffer:s,dataType:a.dataType,normalized:a.normalized}}this.__numVerts=t.numVertices,this.__vboState=2}bind(e){if(e.unifs.PointSize){const t=this.__gl;let i=this.__shaderBindings[e.shaderkey];if(!i){t.__quadVertexIdsBuffer||t.setupInstancedQuad();const a=Object.assign(this.__glattrbuffers,t.__quadattrbuffers);i=_i(t,e.attrs,a,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=i}return i.bind(e),!0}return super.bind(e)}draw(e){const t=this.__gl;e.unifs.PointSize?t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__numVerts):t.drawArrays(t.POINTS,0,this.__numVerts)}drawInstanced(e){this.__gl.drawArraysInstanced(this.__gl.POINTS,0,this.__numVerts,e)}}const Xi={bool:Boolean,int:5,uint:4,float:6,ivec2:p,ivec3:g,ivec4:_,vec2:p,vec3:g,vec4:_,color:Z,mat3:y,mat4:X,sampler2D:We},Vi=new class{constructor(){this.__shaderModules={}}hasShaderModule(e){return e in this.__shaderModules}setShaderModule(e,t){return this.parseShader(e,t)}getShaderModule(e){return this.__shaderModules[e]}getShaderModuleNames(){const e=[];for(const t in this.__shaderModules)e.push(t);return e}parseShader(e,t){const i=e=>e.startsWith("..")?a.substring(0,a.lastIndexOf("/"))+e.substring(2):e.startsWith(".")?a+e.substring(1):e.startsWith("/")?e.substring(1):e,a=(d(e),e.substring(0,e.lastIndexOf("/"))),s=t.split("\n"),n={glsl:" //starting:"+e+"\n",lines:s,numLines:0,includeMetaData:[],uniforms:{},attributes:{}},r=/\s+/;for(let t=0;t<s.length;t++){let a=s[t],l=a.trim();if(l.startsWith("//")||l.startsWith("*"))n.glsl=n.glsl+a+"\n",n.numLines++;else if(-1!=l.indexOf("//")&&(l=l.slice(0,l.indexOf("//")).trim()),l.startsWith("<%")||l.startsWith("</%")){const l=function(e){const t=(e=(e=e.startsWith("</%")?e.slice(3):e.slice(2)).endsWith("/>")?e.slice(0,e.length-2):e.slice(0,e.length-1)).split(r),i={tag:t.shift(),attributes:{}};for(const e of t){const t=e.split("=");i.attributes[t[0]]=t[1].replace(/['"]+/g,"")}return i}(s[t].trim());switch(l.tag){case"include":{const a=i(l.attributes.file);if(!this.hasShaderModule(a))throw new Error("Error while parsing :"+e+" \nShader module not found:"+a+"\n in:"+this.getShaderModuleNames());const s=this.getShaderModule(a);d(l.attributes.file);let r=s.glsl;r=r.substring(r.indexOf("\n")+1),n.glsl=n.glsl+" //including:"+l.attributes.file+"\n";const o={};for(const e in l.attributes){if("file"==e)continue;const t=l.attributes[e];r=r.replaceAll(e,t),o[e]=t}n.glsl=n.glsl+r,n.includeMetaData.push({src:n.numLines,tgt:t,length:s.numLines,key:a}),n.glsl=n.glsl+" //continuing:"+e+"\n",n.numLines+=s.numLines+1;for(const e in s.attributes){let t=e;for(const e in o)t=t.replaceAll(e,o[e]);n.attributes[t]=s.attributes[e]}for(const e in s.uniforms){let t=e;for(const e in o)t=t.replaceAll(e,o[e]);n.uniforms[t]=s.uniforms[e]}break}default:console.warn("Error while parsing :"+e+" \nUnhandled line:"+a);continue}}else{const i=(t,i)=>{if(!(t[1]in Xi))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const s=t[2].slice(0,t[2].length-1);n.attributes[s]={type:Xi[t[1]],instanced:i},"color"==t[1]&&(t[1]="vec4",a=t.join(" "))};if(l.startsWith("struct")){let e="";if(-1!=l.indexOf("}"))e=l.substring(l.indexOf("{")+1,l.indexOf("}")-1);else for(t++;a+=s[t]+"\n",e+=a.trim(),t++,-1==e.indexOf("}"););const i=e.substring(e.indexOf("{")+1,e.indexOf("}")-1).split(";"),n=[];for(const e of i){if(0==e.length)continue;const t=e.trim().split(r);n.push({name:t[1],type:Xi[t[0]]})}const o=l.split(r);Xi[o[1]]=n}if(l.startsWith("attribute")&&i(l.split(r),!1),l.startsWith("instancedattribute")){const e=l.split(r);i(e,!0),e[0]="attribute",a=e.join(" ")}else if(l.startsWith("uniform")){const t=l.split(r);let i=1;4==t.length&&(i=2);const s=t[i];if(!(s in Xi))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const o=t[i+1].slice(0,t[i+1].length-1);n.uniforms[o]=Xi[s],"struct"==n.uniforms[o]&&console.log(t),"color"==t[1]&&(t[1]="vec4",a=t.join(" "))}n.glsl=n.glsl+a+"\n",n.numLines++}}return this.__shaderModules[e]=n,n}};let Ii=0;class Ri extends A{constructor(e){if(super(),!e)throw new Error("gl context must be passed to shader constructor");this.__gl=e,this.__shaderStages={VERTEX_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}},FRAGMENT_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}}},this.__shaderProgramHdls={},this.__gltextures={},this.updated=new M,this.__id=Ii++,this.invisibleToGeomBuffer=!1}static isTransparent(){return!1}static isOverlay(){return!1}__compileShaderStage(e,t,i,a){const s=this.__gl;if(a||(a=s.shaderopts),a){if(a.repl)for(const t in a.repl)e=e.replaceAll(t,a.repl[t]);a.defines&&(e=a.defines+e)}let n;"webgl2"==s.name&&(e=e.replaceAll("attribute","in"),n="#version 300 es\n",e="#version 300 es\n"+(e=(e="vertexShader"==i?e.replaceAll("varying","out"):e.replaceAll("varying","in")).replaceAll("texture2D","texture")));const r=s.createShader(t);if(s.shaderSource(r,e),s.compileShader(r),!s.getShaderParameter(r,s.COMPILE_STATUS)){console.log("Errors in :"+this.constructor.name);const t=s.getShaderInfoLog(r).split("\n"),a={};for(let e in t){if(t[e].startsWith("'")){t[e-1]=t[e-1]+t[e],delete t[e],e--;continue}const i=t[e].split(":");if(i.length>=2){const s=parseInt(i[2]);isNaN(s)||(a[s]?a[s].push(t[e]):a[s]=[t[e]])}}const n=[],l=e.split("\n");for(let e=0;e<l.length;e++)if(n.push((e+1+":").lpad(" ",3)+l[e]),e+1 in a){const t=a[e+1];for(const e of t)n.push(e),n.push("-".lpad("-",e.length))}throw new Error("An error occurred compiling the shader \n=================\n"+this.constructor.name+"."+i+": \n\n"+t.join("\n")+"\n"+n.join("\n"))}return r}__createProgram(e){const t=this.__gl;this.__shaderCompilationAttempted=!0;const i=t.createProgram(),a=this.__shaderStages.VERTEX_SHADER.glsl,s={};if(null!=a){const n=this.__compileShaderStage(a,t.VERTEX_SHADER,"vertexShader",e);if(!n)return!1;t.attachShader(i,n),s[t.VERTEX_SHADER]=n}const n=this.__shaderStages.FRAGMENT_SHADER.glsl;if(null!=n){const a=Object.assign({},t.shaderopts,e);a.frag&&(a.defines=a.frag.defines+a.defines);const r=this.__compileShaderStage(n,t.FRAGMENT_SHADER,"fragmentShader",a);if(!r)return!1;t.attachShader(i,r),s[t.FRAGMENT_SHADER]=r}if(t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=t.getProgramInfoLog(i);if(e.includes("D3D shader compilation failed")){const e=t.getExtension("WEBGL_debug_shaders");if(e){const i=e.getTranslatedShaderSource(s[t.VERTEX_SHADER]);console.log(i)}}throw console.log("vertexShaderGLSL:"+a),console.log("fragmentShaderGLSL:"+n),new Error("Unable to link the shader program:"+this.constructor.name+"\n==================\n"+e)}const r=this.__extractAttributeAndUniformLocations(i,e);return r.shaderProgramHdl=i,r}__extractAttributeAndUniformLocations(e,t){const i=this.__gl,a=this.getAttributes(),s={attrs:{},unifs:{}};for(const t in a){const n=i.getAttribLocation(e,t);if(null==n){console.warn("Shader attribute not found:"+t);continue}const r=a[t];s.attrs[t]={name:t,location:n,type:r.type,instanced:r.instanced}}const n=this.getUniforms();for(let a in n){const r=n[a];if(r instanceof Array)for(const t of r){const n=a+"."+t.name,r=i.getUniformLocation(e,n);null!=r&&(s.unifs[n]={name:n,location:r,type:t.type})}if(t&&t.repl)for(const e in t.repl)a=a.replace(e,t.repl[e]);const l=i.getUniformLocation(e,a);null!=l&&(s.unifs[a]={name:a,location:l,type:r})}return s}getAttributes(){const e={};for(const t in this.__shaderStages){const i=this.__shaderStages[t];for(const t in i.attributes)e[t]=i.attributes[t]}return e}getUniforms(){const e={};for(const t in this.__shaderStages){const i=this.__shaderStages[t];for(const t in i.uniforms)e[t]=i.uniforms[t]}return e}finalize(){}compileForTarget(e,t){const i=e?this.__id+e:this.__id;let a=this.__shaderProgramHdls[i];return a||!1!==a&&(a=this.__createProgram(t),a.shaderkey=i,this.__shaderProgramHdls[i]=a),a}compile(){this.compileForTarget()}bind(e,t){const i=this.__gl;if(e.glshader!=this){const a=this.compileForTarget(t,e.shaderopts);if(!1===a)return console.warn(this.constructor.name+" is not compiled for "+t),!1;const s=a.shaderProgramHdl;i.useProgram(s),e.glshader=this,e.shaderkey=a.shaderkey,e.unifs=a.unifs,e.attrs=a.attrs,e.boundTextures=0,e.boundLightmap=void 0,e.glgeom=void 0,e.bindRendererUnifs&&e.bindRendererUnifs(a.unifs)}return e.supportsInstancing=!0,!0}unbind(e){return!0}static getParamDeclarations(){return[]}static getGeomDataShaderName(){}static getSelectedShaderName(){}destroy(){const e=this.__gl;for(const t in this.__shaderProgramHdls){const i=this.__shaderProgramHdls[t];e.deleteProgram(i.shaderProgramHdl)}this.__shaderProgramHdls={}}}Vi.setShaderModule("utils/quadVertexFromID.glsl","\n\nattribute float vertexIDs;\n\nvec2 getQuadVertexPositionFromID(){\n    int vertexID = int(vertexIDs);\n    if(vertexID == 0)\n        return vec2(-0.5, -0.5);\n    else if(vertexID == 1)\n        return vec2(0.5, -0.5);\n    else if(vertexID == 2)\n        return vec2(-0.5, 0.5);\n    else if(vertexID == 3)\n        return vec2(0.5, 0.5);\n    return vec2(0,0);\n}\n"),Vi.setShaderModule("utils/unpackHDR.glsl","\n\nvec3 decodeHDR(const in vec3 ldrPixel, const in float cdmAlpha) {\n    float avg = (cdmAlpha * 16.0 - 8.0);\n    float scl = 1.0;\n    vec3 color;\n    color.x = (tan((ldrPixel.x-0.5)*1.5)/scl)+avg;\n    color.y = (tan((ldrPixel.y-0.5)*1.5)/scl)+avg;\n    color.z = (tan((ldrPixel.z-0.5)*1.5)/scl)+avg;\n\n    // convert from logarithmic curve to linear curve.\n    // subtract the epsilon that was added during encoding.\n    const float eps = 0.001;\n    color.x = pow(10.0, color.x) - eps;\n    color.y = pow(10.0, color.y) - eps;\n    color.z = pow(10.0, color.z) - eps;\n    return color;\n}\n\nvec3 decodeHDR(sampler2D ldrSampler, sampler2D cdmSampler, vec2 texCoord) {\n#ifdef ENABLE_ES3\n    float cdm = texture2D(cdmSampler, texCoord).r;\n#else\n    float cdm = texture2D(cdmSampler, texCoord).a;\n#endif\n    return decodeHDR(texture2D(ldrSampler, texCoord).rgb, cdm);\n}\n\n");class xi extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("UnpackHDRShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("UnpackHDRShader.fragmentShader",'\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D cdmSampler;\nuniform float exposure;\nuniform vec4 tint;\n\n<%include file="utils/unpackHDR.glsl"/>\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(decodeHDR(ldrSampler, cdmSampler, v_texCoord) * tint.rgb * exposure, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n')}}class Si{constructor(e,t,i=!1){!r.isIOSDevice||"FLOAT"!=t.getType()&&"HALF_FLOAT"!=t.getType()||console.error("IOS devices are unable to render to float textures."),this.__gl=e,this.__colorTexture=t,this.__createDepthTexture=i,this.__clearColor=[0,0,0,0],this.__depthTexture=void 0,this.setup=this.setup.bind(this),this.resize=this.resize.bind(this),this.__colorTexture&&this.__colorTexture.resized.connect(this.resize),this.setup()}setClearColor(e){this.__clearColor=e}getWidth(){return this.__colorTexture.width}getHeight(){return this.__colorTexture.height}getSize(){return[this.__colorTexture.width,this.__colorTexture.height]}getColorTexture(){return this.__colorTexture}getDepthTextureGL(){return this.__depthTexture}get width(){return this.__colorTexture.width}get height(){return this.__colorTexture.height}get size(){return[this.__colorTexture.width,this.__colorTexture.height]}get colorTexture(){return this.__colorTexture}setColorTexture(e){this.__colorTexture=e,gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.__colorTexture.glTex,0)}get depthTextureGL(){return this.__depthTexture}setup(){const e=this.__gl;if(this.__fbo=e.createFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo),this.__colorTexture&&("webgl2"==e.name?e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0)),this.__createDepthTexture)if("webgl2"==e.name||e.__ext_WEBGL_depth_texture)e.activeTexture(e.TEXTURE0),this.__depthTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.__depthTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),"webgl2"==e.name?(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0)):(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0));else{const t=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}this.__checkFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}resize(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0),this.__depthTexture&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.__depthTexture),"webgl2"==e.name?e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null):e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null)),this.__checkFramebuffer()}__checkFramebuffer(){const e=this.__gl;let t;if(t="webgl2"==e.name?e.checkFramebufferStatus(e.DRAW_FRAMEBUFFER):e.checkFramebufferStatus(e.FRAMEBUFFER),t!==e.FRAMEBUFFER_COMPLETE)switch(e.bindTexture(e.TEXTURE_2D,null),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null),console.warn("Error creating Fbo width:",this.width,", height:",this.height," Texture Type:",this.__colorTexture.getType()),t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}}bindForWriting(e){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.__fbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__fbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__fbo),t.viewport(0,0,this.width,this.height)}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo)}bind(e){this.bindForWriting(e)}unbind(e){this.unbindForWriting(e)}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo)}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}clear(){const e=this.__gl;e.colorMask(!0,!0,!0,!0),e.clearColor(...this.__clearColor),this.__createDepthTexture?e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT):e.clear(e.COLOR_BUFFER_BIT)}bindAndClear(e){this.bind(e),this.clear(e)}unbind(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}destroy(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(this.__fbo),this.__fbo=null,this.__colorTexture.resized.disconnect(this.resize)}}class Wi extends bi{constructor(e,t){super(e),this.__hdrImage=t,this.__hdrImage.setMetadata("gltexture",this),this.__hdrImage.updated.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams())}),this.__hdrImage.isLoaded()?this.__unpackHDRImage(this.__hdrImage.getParams()):this.__hdrImage.loaded.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams())})}__unpackHDRImage(e){const t=this.__gl,i=e.data.ldr,a=e.data.cdm;if(this.__fbo)this.__srcLDRTex.bufferData(i),this.__srcCDMTex.bufferData(a);else{this.configure({format:"RGBA",type:"FLOAT",width:i.width,height:i.height,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"}),this.__fbo=new Si(t,this),this.__fbo.setClearColor([0,0,0,0]),this.__srcLDRTex=new bi(t,{format:"RGB",type:"UNSIGNED_BYTE",width:i.width,height:i.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:i}),this.__srcCDMTex=new bi(t,{format:"webgl2"==t.name?"RED":"ALPHA",type:"UNSIGNED_BYTE",width:i.width,height:i.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:a}),this.__unpackHDRShader=new xi(t);const e=this.__unpackHDRShader.compileForTarget("GLHDRImage");this.__shaderBinding=_i(t,e.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}this.__fbo.bindAndClear();const s={};this.__unpackHDRShader.bind(s,"GLHDRImage"),this.__shaderBinding.bind(s);const n=s.unifs;this.__srcLDRTex.bindToUniform(s,n.ldrSampler),this.__srcCDMTex.bindToUniform(s,n.cdmSampler),t.uniform1f(n.exposure.location,1),t.uniform4fv(n.tint.location,this.__hdrImage.getHDRTint().asArray()),t.drawQuad(),this.__fbo.unbind(),this.updated.emit()}bindToUniform(e,t,i){return super.bindToUniform(e,t,i)}destroy(){super.destroy(),this.__fbo&&(this.__fbo.destroy(),this.__srcLDRTex.destroy(),this.__srcCDMTex.destroy()),this.__unpackHDRShader&&this.__unpackHDRShader.destroy(),this.__shaderBinding&&this.__shaderBinding.destroy(),this.__hdrImage.loaded.disconnectScope(this),this.__hdrImage.updated.disconnectScope(this)}}Vi.setShaderModule("GLSLUtils.glsl","\n\n\nint ftoi(float val){\n    return int(floor(val + 0.5));\n}\n\n#ifdef ENABLE_ES3\n\nint imod(int x, int y) {\n    return x % y;\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags |= flag;\n}\n\nvoid clearFlag(inout int flags, int flag) {\n    flags &= ~flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return (flags & flag) != 0;\n}\n\n// private function: Mangle me...\nivec2 _pixelIndexToUV(int index, int textureWidth){\n    return ivec2(index % textureWidth, index / textureWidth);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureWidth, int index) {\n    return texelFetch(texture, _pixelIndexToUV(index, textureWidth), 0);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    return texelFetch(texture, texCoord, 0);\n}\n\n#else\n\n// TODO: integrate: https://gist.github.com/mattatz/70b96f8c57d4ba1ad2cd\n\nint max(int a, int b) {\n    return a > b ? a : b;\n}\nint min(int a, int b) {\n    return a < b ? a : b;\n}\n\n\nfloat round(float val){\n    return floor(val + 0.4);\n}\n\nint imod(int x, int y) {\n    return x-y*(x/y);\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags += flag;\n}\nvoid clearFlag(inout int flags, int flag) {\n    flags -= flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return imod(flags / flag, 2) != 0;\n}\n\n// private function: Mangle me...\nvec2 _pixelIndexToUV(int index, int textureSize){\n    float flTexSize = float(textureSize);\n    float x = (float(imod(index, textureSize))+0.5)/flTexSize;\n    float y = (floor(float(index / textureSize))+0.5)/flTexSize;\n    return vec2(x, y);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureSize, int index) {\n    vec2 texCoord = _pixelIndexToUV(index, textureSize);\n    return texture2D(texture, texCoord);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    vec2 ftextureSize = vec2(textureSize);\n    return texture2D(texture, (vec2(texCoord) + 0.5) / ftextureSize);\n}\n\n\n#endif\n\nint uvToPixelIndex(vec2 uv, int textureSize){\n    return int(uv.x * float(textureSize)) + (int(floor(uv.y * float(textureSize))) * textureSize);\n}\n\n\n\n"),Vi.setShaderModule("utils/ImageStream.glsl","\n\n// Stream Desc looks like the following\n// x : atlas Width in images\n// y : atlas height in images\n// z : image Width\n// w : image Height\n\nvec2 calcFrameImageTexCoords(vec2 texCoord, int index, in vec4 streamDesc){\n\tfloat index_x = floor(mod(float(index), streamDesc.x));\n\tfloat index_y = floor(float(index) / streamDesc.x);\n    return vec2( \n    \t(index_x + texCoord.x) / streamDesc.x, \n    \t(index_y + texCoord.y) / streamDesc.y\n    \t);\n}\n\nvec4 sampleStreamFrame(vec2 texCoord, int index, in sampler2D streamImage, in vec4 streamDesc){\n    return texture2D(streamImage, calcFrameImageTexCoords(texCoord, index, streamDesc));\n}\n\n");class Li{constructor(e,t){this.__gl=e,this.__streamImage=t,this.ready=new M(!0),this.updated=new M,this.resized=new M,this.__descParam=this.__streamImage.getParameter("StreamAtlasDesc"),this.__indexParam=this.__streamImage.getParameter("StreamAtlasIndex"),this.__indexParam.valueChanged.connect(this.updated.emit);const i=()=>{const t=this.__streamImage.getParams();t.data.__atlasTexture||(t.data.__atlasTexture=new bi(e,t)),this.__atlasTexture=t.data.__atlasTexture,this.__atlasTexture.textureType=2,this.__atlasTexture.textureDesc=this.__descParam.getValue().asArray()};this.__streamImage.isLoaded()?i():this.__streamImage.loaded.connect(()=>{i()})}preBind(e,t){const i=this.__atlasTexture.preBind(e,t);return i.textureDescUnif=t[e.name+"Desc"],i.textureIndexUnif=t[e.name+"Index"],i}bindToUniform(e,t,i){return!!this.__atlasTexture.bindToUniform(e,t,i)&&(i&&i.textureIndexUnif&&this.__gl.uniform1i(i.textureIndexUnif.location,this.__indexParam.getValue()),!0)}}class vi{constructor(e,t,i,a){switch(this.__unif=a,a.type){case Boolean:this.uniformXX=e.uniform1i.bind(e);break;case 4:"webgl2"==e.name?this.uniformXX=e.uniform1ui.bind(e):this.uniformXX=e.uniform1i.bind(e);break;case 5:this.uniformXX=e.uniform1i.bind(e);break;case 6:this.uniformXX=e.uniform1f.bind(e)}this.__val=i.getValue(),i.valueChanged.connect(()=>{this.__val=i.getValue(),t.updated.emit()})}bind(e){this.uniformXX(this.__unif.location,this.__val)}unbind(){}destroy(){}}class Ti{constructor(e,t,i,a){switch(this.__unif=a,a.type){case p:this.uniformXX=e.uniform2fv.bind(e);break;case g:this.uniformXX=e.uniform3fv.bind(e);break;case _:this.uniformXX=e.uniform4fv.bind(e)}this.__vals=i.getValue().asArray(),i.valueChanged.connect(()=>{this.__vals=i.getValue().asArray(),t.updated.emit()})}bind(e){this.uniformXX(this.__unif.location,this.__vals)}unbind(){}destroy(){}}class Mi{constructor(e,t,i,a){switch(this.__unif=a,a.type){case Mat3:this.uniformMatrixXXX=e.uniformMatrix3fv.bind(e);break;case X:this.uniformMatrixXXX=e.uniformMatrix4fv.bind(e)}this.__vals=i.getValue().asArray(),i.valueChanged.connect(()=>{this.__val=i.getValue().asArray(),t.updated.emit()})}bind(e){this.uniformMatrixXXX(this.__unif.location,!1,this.__val)}unbind(){}destroy(){}}class Ci{constructor(e,t,i,a,s){this.__gl=e,this.__unif=a,this.__textureUnif=s[a.name+"Tex"],this.__textureTypeUnif=s[a.name+"TexType"],this.__vals=[0,0,0,0],this.bind=this.bindValue;const n=e=>{let i=e.getMetadata("gltexture");i||(i="FLOAT"===e.type?new Wi(this.__gl,e):e.isStreamAtlas()?new Li(this.__gl,e):new bi(this.__gl,e)),this.texBinding=i.preBind(this.__textureUnif,s),i.updated.connect(()=>{t.updated.emit()}),this.gltexture=i,this.gltexture.addRef(this),this.textureType=1,this.bind=this.bindTexture,t.updated.emit()};let r,l;const o=()=>{n(r)},d=e=>{e.isLoaded()?n(e):e.loaded.connect(o),r=e},h=()=>{r.getMetadata("gltexture").removeRef(this),this.texBinding=null,this.gltexture=null,this.textureType=null,this.bind=this.bindValue,l&&r.loaded.disconnectId(l),r=null,l=null,t.updated.emit()},c=()=>{const e=i.getValue(!1);if(this.__vals=e.asArray(),this.__textureUnif){let e;i.getImage&&(e=i.getImage()),e&&e!=r?d(e):!e&&r&&h()}t.updated.emit()};c(),i.textureConnected&&i.textureConnected.connect(()=>{d(i.getImage())}),i.valueChanged.connect(c),this.uniform1i=e.uniform1i.bind(e),this.uniform4fv=e.uniform4fv.bind(e)}bindValue(e){this.uniform4fv(this.__unif.location,this.__vals),this.__textureTypeUnif&&this.uniform1i(this.__textureTypeUnif.location,0)}bindTexture(e){this.gltexture.bindToUniform(e,this.__textureUnif,this.texBinding)}}const Fi={};class wi{constructor(e,t,i,a){this.__uniformBindings=[];const s=s=>{const n=s.getName(),r=i[n];if(null!=r)switch(r.type){case Boolean:case 4:case 5:case 6:this.__uniformBindings.push(new vi(e,t,s,r));break;case p:case g:case _:this.__uniformBindings.push(new Ti(e,t,s,r));break;case Z:this.__uniformBindings.push(new Ci(e,t,s,r,i));break;case X:this.__uniformBindings.push(new Mi(e,t,s,r));break;default:return void console.warn("Param :"+n+" has unhandled data type:"+r.type)}else if(a){const e=t.getMaterial().getShaderName();Fi[e]||(Fi[e]={}),Fi[e][n]||(console.warn("Material:"+t.getMaterial().getName(),"with Shader ",e,"Param has no unif",n),Fi[e][n]=!0)}},n=t.getMaterial().getParameters();for(const e of n)s(e)}bind(e){for(const t of this.__uniformBindings)t.bind(e);return!0}unbind(){for(const e of this.__uniformBindings)e.unbind(renderstate)}destroy(){for(const e of this.__uniformBindings)e.destroy(renderstate)}}class Ni{constructor(e,t,i){this.__gl=e,this.__material=t,this.__glshader=i,this.updated=new M,this.__shaderBindings={}}getMaterial(){return this.__material}getGLShader(){return this.__glshader}generateShaderBinding(){const e=this.__material.getParameters();for(const t of e)bindParam(gl,t)}bind(e,t){this.__boundTexturesBeforeMaterial=e.boundTextures;let i=this.__shaderBindings[e.shaderkey];if(!i){const a=this.__gl;i=new wi(a,this,e.unifs,t),this.__shaderBindings[e.shaderkey]=i}return i.bind(e)}unbind(e){e.boundTextures=this.__boundTexturesBeforeMaterial}}class Yi{constructor(e,t){this.resized=new M,this.updated=new M,this.__gl=e,this.textureTargets=[],this.depthTexture=null,t&&this.configure(t)}configure(e){const t=this.__gl,i=function(e,t){if(!t.width||!t.height)throw new Error("Invalid texture params");const i=e.getParameter(e.MAX_TEXTURE_SIZE);if(t.width<=0||t.width>i||t.height<=0||t.height>i)throw new Error("GLTextureParams: Invalid texture size. width:"+t.width+" height:"+t.height+" maxSize:"+i);const a={width:t.width,height:t.height},s=(i,s)=>{i in t?a[i]=isNaN(t[i])?e[t[i]]:t[i]:s&&(a[i]=s)};if(s("format"),s("internalFormat",a.format),s("type",e.UNSIGNED_BYTE),s("minFilter",e.LINEAR),s("magFilter",e.LINEAR),s("wrapS",e.CLAMP_TO_EDGE),s("wrapT",e.CLAMP_TO_EDGE),s("flipY",!1),s("mipMapped",!1),s("depthFormat"),s("depthType"),a.format==e.FLOAT)if("webgl2"==e.name)a.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),a.filter=e.NEAREST);else if(e.__ext_float)a.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),a.filter=e.NEAREST);else{if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");a.format=e.HALF_FLOAT,a.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),a.filter=e.NEAREST)}else if(a.format==e.HALF_FLOAT)if("webgl2"==e.name);else{if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");if(a.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),a.filter=e.NEAREST),a.channels==e.RGB)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==a.format&&!e.__ext_sRGB)throw new Error("EXT_sRGB is not available");return null!=a.format&&"webgl2"==e.name&&a.internalFormat==a.format&&(a.type==e.FLOAT?a.format==e.RED||a.format==e.RED?a.internalFormat=e.R32F:a.format==e.RG?a.internalFormat=e.RG32F:a.format==e.RGBA&&(a.internalFormat=e.RGBA32F):a.type==e.HALF_FLOAT?a.format==e.RED?a.internalFormat=e.R16F:a.format==e.RGB?a.internalFormat=e.RGB16F:a.format==e.RGBA&&(a.internalFormat=e.RGBA16F):a.type==e.UNSIGNED_BYTE&&(a.format==e.RED&&(a.internalFormat=e.R8),a.format==e.RGB?a.internalFormat=e.RGB8:a.format==e.RGBA&&(a.internalFormat=e.RGBA8))),null!=a.depthFormat&&("webgl2"==e.name?a.depthType==e.UNSIGNED_SHORT?a.depthInternalFormat=e.DEPTH_COMPONENT16:a.depthType==e.UNSIGNED_INT&&(a.depthInternalFormat=e.UNSIGNED_INT):a.depthInternalFormat=a.depthFormat),a}(t,e);this.textureTargets.forEach(e=>{t.deleteTexture(e)}),this.textureTargets=[],this.depthTexture&&(t.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&t.deleteFramebuffer(this.frameBuffer),this.type=i.type,this.format=i.format,this.internalFormat=i.internalFormat,this.filter=i.filter,this.wrap=i.wrap,this.flipY=i.flipY,this.width=i.width,this.height=i.height,this.clearColor=new Z(0,0,0,0),this.colorMask=[!0,!0,!0,!0],this.textureType=1,this.textureDesc=[this.width,this.height,0,0];const a=null!=e.numColorChannels?e.numColorChannels:null!=i.format?1:0;for(let e=0;e<a;e++){t.activeTexture(t.TEXTURE0+1);const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texImage2D(t.TEXTURE_2D,0,this.internalFormat,i.width,i.height,0,this.format,this.type,null),this.textureTargets.push(e)}if(i.depthFormat){if("webgl"==t.name&&!t.__ext_WEBGL_depth_texture)throw new Error("Depth textures not support on this device");t.activeTexture(t.TEXTURE0),this.depthTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.depthTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texImage2D(t.TEXTURE_2D,0,i.depthInternalFormat,i.width,i.height,0,i.depthFormat,i.depthType,null)}if(this.frameBuffer=t.createFramebuffer(),"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),this.textureTargets.length>0){if(this.textureTargets.length>1&&"webgl"==t.name&&!t.drawBuffers){t.__ext_draw_buffers=t.getExtension("WEBGL_draw_buffers"),t.drawBuffers=t.__ext_draw_buffers.drawBuffersWEBGL.bind(t.__ext_draw_buffers);for(let e=1;e<14;e++)t["COLOR_ATTACHMENT"+e]=t.__ext_draw_buffers["COLOR_ATTACHMENT"+e+"_WEBGL"];t.MAX_COLOR_ATTACHMENTS=t.__ext_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL,t.MAX_DRAW_BUFFERS=t.__ext_draw_buffers.MAX_DRAW_BUFFERS_WEBGL}const e=[];for(let i=0;i<this.textureTargets.length;i++)t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+i,t.TEXTURE_2D,this.textureTargets[i],0),e.push(t.COLOR_ATTACHMENT0+i);this.textureTargets.length>1&&t.drawBuffers(e)}this.depthTexture&&t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depthTexture,0);const s=t.checkFramebufferStatus(t.DRAW_FRAMEBUFFER);if(s!=t.FRAMEBUFFER_COMPLETE)switch(s){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}this.unbind()}bindForWriting(e,t=!1){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.frameBuffer);const i=this.__gl;"webgl2"==i.name?i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.frameBuffer):i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,this.width,this.height),t&&this.clear()}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo)}clear(e=!0){const t=this.__gl;t.colorMask(...this.colorMask),t.clearColor(...this.clearColor.asArray());let i=0;this.textureTargets.length>0&&(i|=t.COLOR_BUFFER_BIT),this.depthTexture&&(i|=t.DEPTH_BUFFER_BIT),t.clear(i)}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null)}bindColorTexture(e,t,i=0){const a=this.__gl,s=e.boundTextures++;return a.uniform1i(t.location,s),a.activeTexture(a.TEXTURE0+s),a.bindTexture(a.TEXTURE_2D,this.textureTargets[i]),!0}bindDepthTexture(e,t){const i=this.__gl,a=e.boundTextures++;return i.uniform1i(t.location,a),i.activeTexture(i.TEXTURE0+a),i.bindTexture(i.TEXTURE_2D,this.depthTexture),!0}unbind(){const e=this.__gl;e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)}resize(e,t,i=!1){}bindToUniform(e,t,i){const a=e.boundTextures++,s=this.__gl.TEXTURE0+a,n=this.__gl;return n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,this.textureTargets[0]),n.uniform1i(t.location,a),i&&(i.textureTypeUnif&&n.uniform1i(i.textureTypeUnif.location,this.textureType),i.textureDescUnif&&this.__gl.uniform4fv(i.textureDescUnif.location,this.textureDesc)),!0}destroy(){const e=this.__gl;this.textureTargets.forEach(t=>{e.deleteTexture(t)}),this.textureTargets=[],this.depthTexture&&(e.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&e.deleteFramebuffer(this.frameBuffer)}}const Ki=new Uint32Array(1);function zi(e){return Ki[0]=e,Ki[0]=(Ki[0]<<16|Ki[0]>>16)>>>0,Ki[0]=(1431655765&Ki[0])<<1|(2863311530&Ki[0])>>>1>>>0,Ki[0]=(858993459&Ki[0])<<2|(3435973836&Ki[0])>>>2>>>0,Ki[0]=(252645135&Ki[0])<<4|(4042322160&Ki[0])>>>4>>>0,Ki[0]=(16711935&Ki[0])<<8|(4278255360&Ki[0])>>>8>>>0,2.3283064365386963e-10*Ki[0]}function Ui(e,t){return[e/t,zi(e)]}Vi.setShaderModule("utils/imageAtlas.glsl","\n\n// Note: On mobile, I can't seem to pass around a stuct containing sampler2D.\n// I have to unpack the struct and pass its members. :(\n// struct ImageAtlas {\n//     sampler2D layout;\n//     sampler2D image;\n//     vec4 desc;\n// };\n\n\n\nvec4 getSubImageLayout(int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    return fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n}\n\nvec2 calcSubImageTexCoords(vec2 texCoord, int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    // The following line is a hack to fix artifacts in our PBR lighting\n    // We were seeing loads of lighting garbage on some sufaces that were orthogonal\n    // to the world. The UV coordinates would have been landing right on the edges\n    // of our subimages and were often sampling outside the image. This couuld\n    // have been because of filtering, or an error in the uv coords. \n    texCoord = clamp(texCoord, vec2(0.01, 0.01), vec2(0.99, 0.99));\n    vec2 subimageTexel = texCoord * layoutData.zw;\n    // subimageTexel = clamp(subimageTexel, vec2(0.0, 0.0), vec2(1.0, 1.0));\n    return subimageTexel + layoutData.xy;\n}\n\nvec4 sampleSubImage(vec2 texCoord, int index, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    vec2 atlasCoords = calcSubImageTexCoords(texCoord, index, atlasLayout, atlasDesc);\n    return texture2D(atlasImage, atlasCoords);\n}\n\n");class Pi extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("AtlasLayoutShader.vertexShader",'\n\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\nuniform vec2 srctextureDim;\nconst int border = 2;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * size * 2.0), 0.0, 1.0);\n\n  vec2 borderVec2 = vec2(float(border), float(border));\n  v_texCoord *= (srctextureDim + (borderVec2 * 2.0)) / srctextureDim;\n  v_texCoord -= borderVec2 / srctextureDim;\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("AtlasLayoutShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D srctexture;\nuniform vec2 srctextureDim;\nuniform bool alphaFromLuminance;\nuniform bool invert;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\nfloat luminanceFromRGB(vec3 rgb) {\n  return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n  vec2 pixelCoord = v_texCoord*srctextureDim;\n  vec2 uv = v_texCoord;\n\n  // Wrap X coords\n  if(pixelCoord.x < 0.0){\n    uv.x += 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n  else if(pixelCoord.x > srctextureDim.x){\n    uv.x -= 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n\n  // Wrap Y coords\n  if(pixelCoord.y < 0.0){\n    uv.y += 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n  else if(pixelCoord.y > srctextureDim.y){\n    uv.y -= 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n\n  vec4 texel = texture2D(srctexture, uv);\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  // TODO: check why we pre-multiply alphas here.\n  // fragColor = vec4(texel.rgb/texel.a, texel.a);\n\n  if(alphaFromLuminance) {\n    fragColor = vec4(texel.rgb, luminanceFromRGB(texel.rgb));\n  }\n  else {\n    fragColor = texel;\n  }\n  \n  if(invert) {\n    fragColor = vec4(1.0) - fragColor;\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n")}}class Ei extends Yi{constructor(e,t,i="RGBA",a="FLOAT"){super(e),this.__name=t,this.__formatParam=i,this.__typeParam=a,this.clearColor=new Z(0,0,0,0),this.__subImages=[],this.__layoutNeedsRegeneration=!1,this.__async=new F,this.loaded=this.__async.ready}isLoaded(){return 0==this.__async.count}getMainImage(){return this.super}addSubImage(e){if(e instanceof We){const t=new bi(this.__gl,e);e.isLoaded()||(this.__async.incAsyncCount(),e.loaded.connect(()=>{this.__async.decAsyncCount()})),e.setMetadata("ImageAtlas_gltex",t),t.addRef(this),e.updated.connect(()=>{this.__layoutNeedsRegeneration=!0,this.renderAtlas()}),this.__subImages.push(t)}else e.addRef(this),this.__subImages.push(e);return this.__layoutNeedsRegeneration=!0,this.__subImages.length-1}removeSubImage(e){let t;if(e instanceof We){const i=e.getMetadata("ImageAtlas_gltex");t=this.__subImages.indexOf(i),e.deleteMetadata("ImageAtlas_gltex")}else t=this.__subImages.indexOf(e);this.__subImages[t].removeRef(this),this.__subImages.splice(t,1),this.__layoutNeedsRegeneration=!0}getSubImage(e){return this.__subImages[e]}numSubImages(){return this.__layout?this.__layout.length:this.__subImages.length}generateAtlasLayout(){if(0==this.__subImages.length)return void(this.__layoutNeedsRegeneration=!1);const e=[];this.__subImages.forEach((t,i)=>{e.push({w:t.width+4,h:t.height+4,area:t.width*t.height,index:i})}),e.sort((e,t)=>e.area>t.area?-1:e.area<t.area?1:0);const t=new C;t.fit(e),this.__layout=[],e.forEach((e,t)=>{this.__subImages[e.index],e.fit?this.__layout[e.index]={pos:new p(e.fit.x+2,e.fit.y+2),size:new p(e.w,e.h)}:console.warn("Unable to fit image")});const i=t.root.w,a=t.root.h;this.configure({width:i,height:a,format:"FLOAT"==this.__typeParam&&"RGB"==this.__formatParam?"RGBA":this.__formatParam,type:this.__typeParam,filter:"LINEAR"});const s=this.__gl;if(s.__quadVertexIdsBuffer||s.setupInstancedQuad(),!s.__atlasLayoutShader){s.__atlasLayoutShader=new Pi(s);const e=s.__atlasLayoutShader.compileForTarget("GLImageAtlas");s.__atlasLayoutShaderBinding=_i(s,e.attrs,s.__quadattrbuffers,s.__quadIndexBuffer)}let n=Math.round(Math.sqrt(1*this.__layout.length)+.5);if(n=Math.nextPow2(n),n%1!=0&&(n+=1-n%1),s.floatTexturesSupported){const e=new Float32Array(n*n*4);for(let t=0;t<this.__layout.length;t++){const s=this.__layout[t];_.createFromFloat32Buffer(e.buffer,4*t).set(s.pos.x/i,s.pos.y/a,s.size.x/i,s.size.y/a)}this.__atlasLayoutTexture&&this.__atlasLayoutTexture.width==n&&this.__atlasLayoutTexture.height==n?this.__atlasLayoutTexture.bufferData(e,n,n):(this.__atlasLayoutTexture&&this.__atlasLayoutTexture.destroy(),this.__atlasLayoutTexture=new bi(s,{format:"RGBA",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1,width:n,height:n,data:e}))}else this.__layoutVec4s=[],this.__layout.forEach((e,t)=>{this.__layoutVec4s[t]=[e.pos.x/i,e.pos.y/a,e.size.x/i,e.size.y/a]});this.__layoutNeedsRegeneration=!1}getLayoutData(e){return this.__layoutVec4s[e]}renderAtlas(e=!1,t=0){if(0==this.__subImages.length)return;this.__layoutNeedsRegeneration&&this.generateAtlasLayout();const i=this.__gl,a={};this.bindForWriting(a,!0),i.__atlasLayoutShader.bind(a,"GLImageAtlas"),i.__atlasLayoutShaderBinding.bind(a);const s=new p(1/this.width,1/this.height),n=a.unifs;for(let e=t;e<this.__subImages.length;e++){const t=this.__subImages[e],r=this.__layout[e];t.bindToUniform(a,n.srctexture),i.uniform2fv(n.pos.location,r.pos.multiply(s).asArray()),i.uniform2fv(n.size.location,r.size.multiply(s).asArray()),i.uniform2f(n.srctextureDim.location,t.width,t.height),i.uniform1i(n.alphaFromLuminance.location,t.alphaFromLuminance),i.uniform1i(n.invert.location,t.invert),i.drawQuad(),a.boundTextures--}e&&this.cleanup(),this.unbind(a),this.updated.emit()}isReady(){return null!=this.__atlasLayoutTexture}bindToUniform(e,t){if(!this.__atlasLayoutTexture)return!1;super.bindToUniform(e,t);const i=e.unifs,a=i[t.name+"_layout"];a&&this.__atlasLayoutTexture.bindToUniform(e,a);const s=i[t.name+"_desc"];return s&&this.__gl.uniform4f(s.location,this.width,this.height,this.__atlasLayoutTexture.width,0),!0}cleanup(){for(const e of this.__subImages)e.removeRef(this);this.__subImages=[],this.destroy()}destroy(){this.cleanup(),super.destroy()}}class Ji extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("ConvolverShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("ConvolverShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\nuniform float roughness;\nvarying vec2 v_texCoord;\n\nuniform sampler2D hammersleyMap;\nvec2 Hammersley(int i, int N) {\n  vec4 rgba =  texture2D(hammersleyMap, vec2((float(i) + 0.5)/float(N)), 0.5);\n  return rgba.rg;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n  float a = 1.0 / (1.0 + n.z);\n  float b = -n.x * n.y * a;\n  vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n  vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n  return mat3(b1, b2, n);\n}\n\nvec3 ImportanceSampleGGX(vec2 Xi, float a) {\n  float phi = 2.0 * PI * Xi.x;\n  float cos_theta = sqrt((1.0 - Xi.y)/(1.0 + (a*a - 1.0) * Xi.y));\n  float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  // float phi = Xi.y * 2.0 * PI;\n  // float cos_theta = sqrt(1.0 - Xi.x);\n  // float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  vec3 H;\n  H.x = sin_theta * cos(phi);\n  H.y = sin_theta * sin(phi);\n  H.z = cos_theta;\n  return H;\n}\n\n// TODO: use tobias\'s code. The guy clearly knows what he\'s doing...\n// https://github.com/thefranke/dirtchamber/blob/master/shader/importance.hlsl\n// Compute a LOD level for filtered importance sampling.\n// From GPU Gems 3: GPU-Based Importance Sampling.\n\n\n#define M_PI       3.14159265358979323846   // pi\n#define M_HALF_PI  1.57079632679489661923   // pi/2\nfloat sqr(float val){ return val*val; }\nfloat saturate(float val) { return clamp(val, 0.0, 1.0); }\nvec3 saturate(vec3 val) { return clamp(val, 0.0, 1.0); }\n\n// Microfacet Models for Refraction through Rough Surfaces\n// Walter et al.\n// http://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html\n// aka Towbridge-Reitz\nfloat D_ggx(in float alpha, in float NoH)\n{\n  float a2 = alpha*alpha;\n  float cos2 = NoH*NoH;\n\n  return (1.0/M_PI) * sqr(alpha/(cos2 * (a2 - 1.0) + 1.0));\n\n  /*\n  // version from the paper, eq 33\n  float CosSquared = NoH*NoH;\n  float TanSquared = (1.0 - CosSquared)/CosSquared;\n  return (1.0/M_PI) * sqr(alpha/(CosSquared * (alpha*alpha + TanSquared)));\n  */\n}\nfloat compute_lod(in vec3 H, in float pdf, in int num_samples, in int ww, in int hh)\n{\n  return max(0.0, 0.5*log2(float(ww*hh)/float(num_samples)) - 0.5*log2(pdf));\n}\n\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec3 N = sphOctUvToDir(v_texCoord);\n\n  if(false){\n    vec2 uv = dirToSphOctUv(N);\n    // fragColor = vec4(uv.x, uv.y, 0.0, 1.0);\n    fragColor = sampleImagePyramid(uv, 0.5, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = sampleSubImage(uv, 0, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = texture2D(envMapPyramid, uv);\n  }\n  else{\n    const int numSamples = NUM_SAMPLES;\n    int w = int(floor(envMapPyramid_desc.x + 0.5));\n    int h = int(floor(envMapPyramid_desc.y + 0.5));\n\n    vec4 color = vec4(0.0,0.0,0.0,0.0);\n    float weight = 0.0;\n    mat3 vecSpace = matrixFromVector(N);\n    float a = roughness*roughness;\n    for(int i=0; i<numSamples; i++) {\n      vec2 Xi = Hammersley(i, numSamples);\n      vec3 H = ImportanceSampleGGX(Xi, a);\n      vec3 V = normalize(vecSpace * H);\n      float VdotN = dot(V, N);\n      float NoH = saturate( dot( N, H ) );\n      float VoH = saturate( dot( V, H ) );\n\n      vec2 uv = dirToSphOctUv(V);\n      // float pdf = D_ggx(a, NoH) * NoH / (4.0 * VoH);\n      // float lod = compute_lod(H, pdf, numSamples, w, h);\n\n      color += sampleImagePyramid(uv, a, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc) * VdotN;\n      weight += VdotN;\n    }\n    color /= float(weight);\n    fragColor = vec4(color.rgb, 1.0);\n  }\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n')}}Vi.setShaderModule("utils/imagePyramid.glsl",'\n\n<%include file="utils/imageAtlas.glsl"/>\n\nvec4 sampleImagePyramid(vec2 uv, float lod, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n  if (lod < 0.00001 || lod > 0.9999) {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(imageIndex);\n    return sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n  } else {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(floor(imageIndex));\n    int imageId1 = imageId0+1;\n    float blend = fract(imageIndex);\n    vec4 c0 = sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n    vec4 c1 = sampleSubImage(uv, imageId1, atlasLayout, atlasImage, atlasDesc);\n    return mix(c0, c1, blend);\n  } \n}\n\n\n');class Hi extends Ei{constructor(e,t,i,a=!0,s=16){super(e,t),this.__srcGLTex=i,this.__fbos=[],i.updated.connect(()=>{this.renderAtlas(a)}),this.__srcGLTex.isLoaded()?(this.generateAtlasLayout(s),this.renderAtlas(a)):this.__srcGLTex.updated.connect(()=>{this.generateAtlasLayout(s),this.renderAtlas(a)})}generateAtlasLayout(e){const t=this.__gl;this.size=this.__srcGLTex.height;const i=this.__srcGLTex.width/this.__srcGLTex.height;this.addSubImage(this.__srcGLTex);for(let a=Math.round(function(e){return Math.log2(e)}(this.size))-1;a>=0;--a){const s=Math.pow(2,a);if(s<e)break;const n=new bi(t,{format:this.__srcGLTex.getFormat(),type:this.__srcGLTex.getType(),width:s*i,height:s,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"});this.addSubImage(n),this.__fbos.push(new Si(t,n))}super.generateAtlasLayout()}renderAtlas(e=!0){const t=this.__gl,i={};t.screenQuad.bindShader(i);for(let e=0;e<this.__fbos.length;e++)this.__fbos[e].bindAndClear(),t.screenQuad.draw(i,this.getSubImage(e));super.renderAtlas(e)}destroy(){super.destroy();for(const e of this.__fbos)e.destroy()}}class ki extends Ei{constructor(e,t){super(e,t),this.__gl=e,e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__convolved=!1,this.__fbos=[]}generateHammersleySamples(e){const t=this.__gl;if(!t["Hammersley"+e]){const i=new Float32Array(3*e);for(let t=0;t<e;t++){const a=Ui(t,e),s=3*t;i[s+0]=a[0],i[s+1]=a[1]}t["Hammersley"+e]=new bi(t,{format:"RGB",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",width:e,height:1,data:i,mipMapped:!1})}return t["Hammersley"+e]}convolveProbe(e){const t=this.__gl,i=this.generateHammersleySamples(1024);if(!this.__convolved){this.__lodPyramid||(this.__lodPyramid=new Hi(t,"Probe Lods",e,!1),this.__lodPyramid.updated.connect(()=>{this.convolveProbe(e)})),this.addSubImage(e);let i=[e.width/2,e.height/2];const a=6;for(let e=0;e<a;e++){const e=new bi(t,{format:"RGBA",type:"FLOAT",filter:"LINEAR",wrap:"CLAMP_TO_EDGE",width:i[0],height:i[1]});this.addSubImage(e);const a=new Si(t,e);a.setClearColor([0,1,0,0]),this.__fbos.push(a),i=[i[0]/2,i[1]/2]}this.generateAtlasLayout(),this.__convolverShader=new Ji(t);const s=this.__convolverShader.compileForTarget("GLProbe",Object.assign({repl:{NUM_SAMPLES:1024}},t.shaderopts));this.__covolverShaderBinding=_i(t,s.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}const a={};this.__convolverShader.bind(a,"GLProbe"),this.__covolverShaderBinding.bind(a);const s=a.unifs;for(let e=0;e<this.__fbos.length;e++){if(this.__fbos[e].bindAndClear(),this.__lodPyramid.bindToUniform(a,s.envMapPyramid),"hammersleyMap"in s&&i.bindToUniform(a,s.hammersleyMap),"roughness"in s){const i=(e+1)/this.__fbos.length;t.uniform1f(s.roughness.location,i)}t.drawQuad()}this.__convolved=!0,this.renderAtlas(!1)}bindProbeToUniform(e,t){this.__convolved&&super.bindToUniform(e,t)}destroy(){super.destroy(),this.__convolverShader.destroy();for(const e of this.__fbos)e.destroy()}}Vi.setShaderModule("stack-gl/inverse.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\n#endif\n\n"),Vi.setShaderModule("stack-gl/transpose.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\n#endif\n\n"),Vi.setShaderModule("pragmatic-pbr/envmap-octahedral.glsl","\n\n#define sectorize(value) step(0.0, (value))*2.0-1.0\n#define sum(value) dot(clamp((value), 1.0, 1.0), (value))\n\n\nvec2 dirToSphOctUv(vec3 normal){\n    normal = normalize(normal);\n    vec3 aNorm = abs(normal);\n    vec3 sNorm = sectorize(normal);\n\n    vec2 dir = max(aNorm.xy, 1e-20);\n    float orient = atan(dir.x, dir.y)/HalfPI;\n\n    dir = max(vec2(aNorm.z, length(aNorm.xy)), 1e-20);\n    float pitch = atan(dir.y, dir.x)/HalfPI;\n\n    vec2 uv = vec2(sNorm.x*orient, sNorm.y*(1.0-orient))*pitch;\n\n    if(normal.z < 0.0){\n        uv = sNorm.xy - abs(uv.ts)*sNorm.xy;\n    }\n    return uv*0.5+0.5;\n}\n\n\nvec3 sphOctUvToDir(vec2 uv){\n    uv = uv*2.0-1.0;\n    vec2 suv = sectorize(uv);\n    float sabsuv =  sum(abs(uv));\n    float pitch = sabsuv*HalfPI;\n\n    if (pitch <= 0.0) {\n        return vec3(0.0, 0.0, 1.0);\n    }\n    if (abs(pitch - PI) < 0.000001) {\n        return vec3(0.0, 0.0, -1.0);\n    }\n    if(sabsuv > 1.0){\n        uv = (1.0-abs(uv.ts))*suv;\n    }\n\n    float orient = (abs(uv.s)/sabsuv)*HalfPI;\n    float sOrient = sin(orient);\n    float cOrient = cos(orient);\n    float sPitch = sin(pitch);\n    float cPitch = cos(pitch);\n\n    return vec3(\n        sOrient*suv.s*sPitch,\n        cOrient*suv.t*sPitch,\n        cPitch\n    );\n}\n\n"),Vi.setShaderModule("pragmatic-pbr/envmap-equirect.glsl","\n\n\nvec2 latLongUVsFromDir(vec3 dir) {\n  // Math function taken from...\n  // http://gl.ict.usc.edu/Data/HighResProbes/\n  // Note: Scaling from u=[0,2], v=[0,1] to u=[0,1], v=[0,1]\n  float phi = acos(dir.z);\n  float theta = atan(dir.x, dir.y);\n  return vec2((1.0 + theta / PI) / 2.0, phi / PI);\n}\n\n// Note: when u == 0.5 z = 1.0\nvec3 dirFromLatLongUVs(float u, float v) {\n    // http://gl.ict.usc.edu/Data/HighResProbes/\n    float theta = PI*((u * 2.0) - 1.0);\n    float phi = PI*v;\n    return vec3(sin(phi)*sin(theta), sin(phi)*cos(theta), cos(phi));\n}\n\nvec3 dirFromPolar(vec2 polar) {\n    float u = polar.x / (PI * 2.0);\n    float v = polar.y / PI;\n    return dirFromLatLongUVs(u, v);\n}\n\n"),Vi.setShaderModule("pragmatic-pbr/envmap-dualfisheye.glsl","\n\n\n\nvec2 dualfisheyeUVsFromDir(vec3 dir) {\n  vec2 result;\n  float angle = 0.465;\n    if(dir.x < 0.0) {\n        result = vec2(((dir.z * -angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    else {\n        result = vec2( 0.5 + ((dir.z * angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    return result;\n}\n\n\n");class Bi extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("EnvMapShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID() * 2.0;\n  v_texCoord = position * 0.5 + 0.5;\n\n  mat4 inverseProjection = inverse(projectionMatrix);\n  mat3 inverseModelview = transpose(mat3(viewMatrix));\n\n  // transform from the normalized device coordinates back to the view space\n  vec3 unprojected = (inverseProjection * vec4(position, 0, 1)).xyz;\n\n  // transfrom from the view space back to the world space\n  // and use it as a sampling vector\n  v_worldDir = inverseModelview * unprojected;\n\n  gl_Position = vec4(position, 0, 1);\n}\n\n')}}class Di extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec4 texel = texture2D(backgroundImage, v_texCoord);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class Oi extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("OctahedralEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\nuniform float focus;\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n// uniform ImageAtlas envMap;\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dirToSphOctUv(normalize(v_worldDir));\n  if(false){\n    // Use these lines to debug the src GL image.\n    vec4 texel = texture2D(envMapPyramid, uv);\n    fragColor = vec4(texel.rgb/texel.a, 1.0);\n  }\n  else{\n    fragColor = vec4(sampleImagePyramid(uv, focus, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb, 1.0);\n  }\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class Ai extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){return super.getParamDeclarations()}}class Qi extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("SterioLatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform int eye;// L = 0, R = 1;\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n  uv.y *= 0.5;\n  if(eye == 1){\n    uv.y += 0.5;\n  }\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class ji extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(dirFromLatLongUVs(v_texCoord.x, v_texCoord.y));\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  // fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class qi extends ki{constructor(e,t,i){super(e.gl,"EnvMap"),this.__renderer=e,this.__envMap=t,this.__backgroundFocus=0;const a=e.gl;a.__quadVertexIdsBuffer||a.setupInstancedQuad();let s=this.__envMap.getMetadata("gltexture");s||(s=new Wi(a,this.__envMap)),this.__srcGLTex=s,this.__envMapShader=new Oi(a);const n=this.__envMapShader.compileForTarget("GLEnvMap",i);this.__envMapShaderBinding=_i(a,n.attrs,a.__quadattrbuffers,a.__quadIndexBuffer),this.__envMap.isLoaded()?this.convolveProbe(s):this.__envMap.loaded.connect(()=>{this.convolveProbe(s),this.loaded.emit()})}getEnvMap(){return this.__envMap}getBackgroundFocus(){return this.__backgroundFocus}setBackgroundFocus(e){this.__backgroundFocus=e,this.__renderer.requestRedraw()}draw(e){if(this.__envMap.isLoaded()){const t=this.__gl;{this.__envMapShader.bind(e,"GLEnvMap");const i=e.unifs;this.bindProbeToUniform(e,i.envMapPyramid);{const e=i.focus;e&&t.uniform1f(e.location,this.__backgroundFocus)}{const a=i.exposure;a&&t.uniform1f(a.location,e.exposure)}this.__envMapShaderBinding.bind(e),t.depthMask(!1),e.bindViewports(i,()=>{t.drawQuad()})}}}bindToUniform(e,t,i){return this.__srcGLTex.bindToUniform(e,t,i)}destroy(){super.destroy(),this.__srcGLTex.loaded.disconnectScope(this),this.__srcGLTex.updated.disconnectScope(this),this.__srcGLTex.destroy()}}class $i extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("ScreenQuadShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * abs(size) * 2.0), 0.0, 1.0);\n    if(size.x < 0.0)\n        v_texCoord.x = 1.0 - v_texCoord.x;\n    if(size.y < 0.0)\n        v_texCoord.y = 1.0 - v_texCoord.y;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("ScreenQuadShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D image;\n\nvarying vec2 v_texCoord;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = texture2D(image, v_texCoord);\n    fragColor = vec4(fragColor.rgb/fragColor.a, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}}class ea{constructor(e,t){this.__gl=e,this.__pos=[0,0],this.__size=[1,1],this.flipY=!0,this.__glshader=new $i(e),e.__quadVertexIdsBuffer||e.setupInstancedQuad();const i=this.__glshader.compileForTarget("GLScreenQuad",t);this.__quadBinding=_i(e,i.attrs,e.__quadattrbuffers,e.__quadIndexBuffer),this.ready=!0}bind(e,t,i,a){const s=e.unifs;t.bindToUniform(e,e.unifs.image);const n=this.__gl;{const e=s.pos;e&&n.uniform2fv(e.location,i?i instanceof m?i.asArray():i:this.__pos)}{const e=s.size;e&&n.uniform2fv(e.location,a?a instanceof m?a.asArray():a:this.__size)}this.__quadBinding.bind(e)}bindShader(e){return this.__glshader.bind(e,"GLScreenQuad")}draw(e,t,i,a){this.bind(e,t,i,a),this.__gl.drawQuad()}destroy(){}}class ta extends B{constructor(e){super(),this.__renderer=e,this.__doubleClickTimeMSParam=this.addParameter(new oe("DoubleClickTimeMS",200)),this.__fbo=void 0,this.updated=new M,this.resized=new M,this.__renderer.sceneSet.connect(()=>{const t=e.getScene().settings.getParameter("BackgroundColor"),i=e=>{const i=t.getValue();let a=this.__renderer.gl;i instanceof We?"FLOAT"===i.type?(this.__backgroundTexture=i,this.__backgroundGLTexture=new Wi(a,i)):(this.__backgroundTexture=i,this.__backgroundGLTexture=new bi(a,i)):i instanceof Z?(this.__backgroundGLTexture&&(this.__backgroundGLTexture.destroy(),this.__backgroundGLTexture=void 0,this.__backgroundTexture=void 0),this.__backgroundColor=i):console.warn("Invalid background:"+i),this.updated.emit()};i(t.getValue()),t.valueChanged.connect(i)})}getRenderer(){return this.__renderer}getName(){return this.__name}getBl(){return this.__bl}setBl(e){this.__bl=e,this.resize(this.__canvasWidth,this.__canvasHeight)}getTr(){return this.__tr}setTr(e){this.__tr=e,this.resize(this.__canvasWidth,this.__canvasHeight)}getPosX(){return this.__x}getPosY(){return this.__y}getWidth(){return this.__width}getHeight(){return this.__height}getBackground(){return console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").getValue()}setBackground(e){console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").setValue(e),this.updated.emit()}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__width=e,this.__height=t,this.resized.emit()}onMouseDown(e){return!1}onMouseUp(e){return!1}onMouseMove(e){return!1}onMouseLeave(e){return!1}onKeyPressed(e,t){return!1}onKeyDown(e,t){return!1}onKeyUp(e,t){return!1}}class ia extends ta{constructor(e,t,i,a){super(e),this.__name=t,this.__projectionMatrix=new X,this.__frustumDim=new p,this.__bl=new p(0,0),this.__tr=new p(1,1),this.__exposure=0,this.__exposureRange=[-5,10],this.__tonemap=!0,this.__gamma=2.2,this.__prevDownTime=0,this.__geomDataBuffer=void 0,this.__geomDataBufferFbo=void 0,this.viewChanged=new M,this.capturedItem=null,this.keyDown=new M,this.keyPressed=new M,this.keyUp=new M,this.mouseDown=new M,this.mouseDoubleClicked=new M,this.mouseMove=new M,this.mouseUp=new M,this.mouseLeave=new M,this.mouseDownOnGeom=new M,this.mouseWheel=new M,this.touchStart=new M,this.touchMove=new M,this.touchEnd=new M,this.touchCancel=new M,this.doubleTapped=new M,this.setCamera(new Qt("Default")),this.setManipulator(new ci),this.resize(i,a)}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__x=e*this.__bl.x,this.__y=e*this.__bl.y,this.__width=e*this.__tr.x-e*this.__bl.x,this.__height=t*this.__tr.y-t*this.__bl.y,this.region=[this.__x,this.__y,this.__width,this.__height],this.__camera&&this.__updateProjectionMatrix(),this.__geomDataBufferFbo&&(this.__geomDataBuffer.resize(this.__width,this.__height),this.__geomDataBufferFbo.resize()),this.resized.emit()}getCamera(){return this.__camera}setCamera(e){this.__camera=e;const t=e.getParameter("GlobalXfo"),i=()=>{this.__cameraXfo=t.getValue(),this.__cameraMat=this.__cameraXfo.toMat4(),this.__viewMat=this.__cameraMat.inverse()};i(),t.valueChanged.connect(()=>{i(),this.invalidateGeomDataBuffer(),this.updated.emit(),this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.__cameraXfo,focalDistance:this.__camera.getFocalDistance()})}),this.__camera.projectionParamChanged.connect(()=>{this.__updateProjectionMatrix(),this.updated.emit()}),this.__updateProjectionMatrix()}getManipulator(){return this.__cameraManipulator}setManipulator(e){this.__cameraManipulator=e}__updateProjectionMatrix(){const e=this.__width/this.__height;this.__camera.updateProjectionMatrix(this.__projectionMatrix,e);const t=Math.tan(this.__camera.getFov()/2)*this.__camera.getNear()*2,i=t*e;this.__frustumDim.set(i,t)}getProjectionMatrix(){return this.__projectionMatrix}getViewMatrix(){return this.__viewMat}setActive(e){activeViewport=e?this:void 0}frameView(e){this.__camera.frameView(this,e)}calcRayFromScreenPos(e){const t=this.__canvasHeight*(1-this.__tr.y);let i=(e.x-this.__x)/this.__width,a=(e.y-t)/this.__height;i=2*i-1,a=2*a-1;const s=this.__cameraMat,n=this.__projectionMatrix.inverse();if(null==n)return null;let r,l;return this.__camera.getIsOrthographic()?(r=s.transformVec3(n.transformVec3(new g(i,-a,-1))),l=new g(0,0,-1)):(r=s.translation,l=n.transformVec3(new g(i,-a,-1))),l=s.rotateVec3(l).normalize(),new I(r,l)}createGeomDataFbo(e){const t=this.__renderer.gl;this.__floatGeomBuffer=e,this.__floatGeomBuffer?this.__geomDataBuffer=new bi(t,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}):this.__geomDataBuffer=new bi(t,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}),this.__geomDataBufferFbo=new Si(t,this.__geomDataBuffer,!0),this.__geomDataBufferFbo.setClearColor([0,0,0,0])}getGeomDataFbo(){return this.__geomDataBufferFbo}renderGeomDataFbo(){if(this.__geomDataBufferFbo){this.__geomDataBufferFbo.bindAndClear();const e={};this.__initRenderState(e),this.__renderer.drawSceneGeomData(e),this.__geomDataBufferInvalid=!1}}invalidateGeomDataBuffer(){this.__geomDataBufferInvalid=!0}getGeomDataAtPos(e,t){if(this.__geomDataBufferFbo){if(this.__geomDataBufferInvalid&&(this.renderGeomDataFbo(),this.__screenPos=null),e===this.__screenPos)return this.__intersectionData;this.__screenPos=e,this.__intersectionData=null;const i=this.__renderer.gl;let a,s;if(i.finish(),this.__geomDataBufferFbo.bindForReading(),i.floatGeomBuffer){if(s=new Float32Array(4),i.readPixels(e.x,this.__height-e.y,1,1,i.RGBA,i.FLOAT,s),0==s[3])return;a=63&Math.round(s[0])}else{if(s=new Uint8Array(4),i.readPixels(e.x,this.__height-e.y,1,1,i.RGBA,i.UNSIGNED_BYTE,s),i.bindFramebuffer(i.FRAMEBUFFER,null),0==s[0]&&0==s[1])return;a=0}this.__geomDataBufferFbo.unbind();const n=this.__renderer.getPass(a);if(!n)return void console.warn("Geom data buffer returns invalid pass id:",a);const r=n.getGeomItemAndDist(s);if(r){t||(t=this.calcRayFromScreenPos(e));const i=t.start.add(t.dir.scale(r.dist));this.__intersectionData={screenPos:e,mouseRay:t,intersectionPos:i,geomItem:r.geomItem,dist:r.dist,geomData:s}}return this.__intersectionData}}getGeomItemsInRect(e,t){if(this.__geomDataBufferFbo){const i=this.__renderer.gl;i.finish();const a=Math.round(this.__height-t.y),s=Math.round(e.x),n=Math.round(t.x-e.x),r=Math.round(t.y-e.y),l=n*r;let o;this.__geomDataBufferFbo.bindForReading(),i.floatGeomBuffer?(o=new Float32Array(4*l),i.readPixels(s,a,n,r,i.RGBA,i.FLOAT,o)):(o=new Uint8Array(4*l),i.readPixels(s,a,n,r,i.RGBA,i.UNSIGNED_BYTE,o)),i.bindFramebuffer(i.FRAMEBUFFER,null);const d=new Set;for(let e=0;e<l;e++){let t;const a=o.subarray(4*e,4*(e+1));t=i.floatGeomBuffer?Math.round(a[0]):0;const s=this.__renderer.getPass(t).getGeomItemAndDist(a);s&&d.add(s.geomItem)}return d}}__eventMousePos(e){return new p(e.rendererX-this.getPosX(),e.rendererY-this.getPosY())}__prepareEvent(e){if(e.viewport=this,e.propagating=!0,e.stopPropagation(),e.stopPropagation=()=>{e.propagating=!1},e.setCapture=e=>{this.capturedItem=e},e.getCapture=e=>this.capturedItem,e.releaseCapture=()=>{this.capturedItem=null,this.renderGeomDataFbo()},e instanceof MouseEvent){const t=this.__eventMousePos(e);e.mousePos=t,e.mouseRay=this.calcRayFromScreenPos(t);const i=this.getGeomDataAtPos(e.mousePos,e.mouseRay);null!=i&&(e.intersectionData=i)}}setCapture(e){this.capturedItem=e}getCapture(){return this.capturedItem}releaseCapture(){this.capturedItem=null,this.renderGeomDataFbo()}onMouseDown(e){if(this.__prepareEvent(e),this.capturedItem)return void this.capturedItem.onMouseDown(e);if(null!=e.intersectionData){if(e.intersectionData.geomItem.onMouseDown(e),!e.propagating||this.capturedItem)return;if(this.mouseDownOnGeom.emit(e),!e.propagating)return}const t=Date.now();if(t-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleClick(e),!e.propagating))return;this.mouseDoubleClicked.emit(e)}else{if(this.__prevDownTime=t,this.__cameraManipulator&&(this.__cameraManipulator.onMouseDown(e),!e.propagating))return;this.mouseDown.emit(e)}return!1}onMouseMove(e){if(this.__prepareEvent(e),this.capturedItem)this.capturedItem.onMouseMove(e);else{if(null!=e.intersectionData){if(e.intersectionData.geomItem!=this.mouseOverItem&&(this.mouseOverItem&&this.mouseOverItem.onMouseLeave(e),this.mouseOverItem=e.intersectionData.geomItem,this.mouseOverItem.onMouseEnter(e)),e.intersectionData.geomItem.onMouseMove(e),!e.propagating||this.capturedItem)return}else this.mouseOverItem&&(this.mouseOverItem.onMouseLeave(e),this.mouseOverItem=null);this.__cameraManipulator&&(this.__cameraManipulator.onMouseMove(e),!e.propagating)||this.mouseMove.emit(e)}}onMouseUp(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onMouseUp(e):(null==e.intersectionData||(e.intersectionData.geomItem.onMouseUp(e),e.propagating))&&(this.__cameraManipulator&&(this.__cameraManipulator.onMouseUp(e),!e.propagating)||this.mouseUp.emit(e))}onMouseLeave(e){this.__prepareEvent(e),this.mouseLeave.emit(e)}onKeyPressed(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyPressed(e,t)||this.keyPressed.emit(e,t)}onKeyDown(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyDown(e,t)||this.keyDown.emit(e,t)}onKeyUp(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyUp(e,t)||this.keyUp.emit(e,t)}onWheel(e){this.__prepareEvent(e),(null==e.intersectionData||(e.intersectionData.geomItem.onWheel(e),e.propagating))&&(this.__cameraManipulator?this.__cameraManipulator.onWheel(e):this.mouseWheel.emit(e))}__eventTouchPos(e){return new p(e.rendererX-this.getPosX(),e.rendererY-this.getPosY())}onTouchStart(e){if(this.__prepareEvent(e),1==e.touches.length){const t=e.touches[0],i=this.__eventTouchPos(t);e.touchPos=i,e.touchRay=this.calcRayFromScreenPos(i);const a=this.getGeomDataAtPos(i,e.touchRay);if(null!=a){if(e.intersectionData=a,a.geomItem.onMouseDown(e,a),!e.propagating)return;if(this.capturedItem)return;if(this.mouseDownOnGeom.emit(e),!e.propagating)return}const s=Date.now();if(s-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleTap(e),!e.propagating))return;return void this.doubleTapped.emit(e)}this.__prevDownTime=s}this.__cameraManipulator?this.__cameraManipulator.onTouchStart(e):this.touchStart.emit(e)}onTouchMove(e){if(this.__prepareEvent(e),this.capturedItem){e.touchPos=[],e.touchRay=[];for(let t=0;t<e.touches.length;t++){const i=e.touches[t],a=this.__eventTouchPos(i);e.touchPos[t]=a,e.touchRay[t]=this.calcRayFromScreenPos(a)}return e.mousePos=e.touchPos[0],e.mouseRay=e.touchRay[0],void this.capturedItem.onMouseMove(e)}this.__cameraManipulator?this.__cameraManipulator.onTouchMove(e):this.touchMove.emit(e)}onTouchEnd(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onMouseUp(e):this.__cameraManipulator?this.__cameraManipulator.onTouchEnd(e):this.touchEnd.emit(e)}onTouchCancel(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onTouchCancel(e):this.__cameraManipulator?this.__cameraManipulator.onTouchCancel(e):this.touchCancel.emit(e)}__initRenderState(e){e.viewXfo=this.__cameraXfo,e.viewScale=1,e.region=this.region,e.cameraMatrix=this.__cameraMat,e.viewports=[{region:this.region,viewMatrix:this.__viewMat,projectionMatrix:this.__projectionMatrix,viewportFrustumSize:this.__frustumDim,isOrthographic:this.__camera.getIsOrthographic(),fovY:this.__camera.getFov()}]}draw(){const e=this.__renderer.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(...this.region),this.__backgroundColor&&e.clearColor(...this.__backgroundColor.asArray()),e.colorMask(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t={};this.__initRenderState(t),this.__renderer.drawScene(t)}}class aa{constructor(e,t){this.__vrviewport=e,this.__treeItem=new zt("VRHead"),t.addChild(this.__treeItem),this.__mat4=new X,this.__localXfo=new R}update(e){this.__mat4.setDataArray(e.transform.matrix),this.__localXfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__localXfo)}getTreeItem(){return this.__treeItem}getXfo(){return this.__localXfo}}class sa{constructor(e,t,i){if(this.__vrviewport=e,this.__inputSource=t,this.__id=i,this.__isDaydramController=r.isMobileDevice,this.touchpadTouched=new M,this.buttonPressed=new M,this.buttonReleased=new M,this.__pressedButtons=[],this.__mat4=new X,this.__xfo=new R,this.__treeItem=new zt("VRController:"+t.handedness+i),!this.__isDaydramController){this.__tip=new zt("Tip");const t=new R;t.tr.set(0,-.05,-.13),this.__tip.setLocalXfo(t),this.__treeItem.addChild(this.__tip,!1),e.getTreeItem().addChild(this.__treeItem),this.__activeVolumeSize=.04,e.loadHMDResources().then(e=>{e.loaded.connect(()=>{let t;0==i?t=e.getChildByName("LeftController"):1==i&&(t=e.getChildByName("RightController")),t||(t=e.getChildByName("Controller"));const a=t.clone();a.setLocalXfo(new R(new g(0,-.035,-.085),new V({setFromAxisAndAngle:[new g(0,1,0),Math.PI]}),new g(.001,.001,.001))),this.__treeItem.addChild(a,!1)})})}}getHandedness(){return this.__inputSource.handedness}getId(){return this.__id}getTreeItem(){return this.__treeItem}getTipItem(){return this.__tip}getTipXfo(){return this.__tip.getGlobalXfo()}getTouchPadValue(){return this.__touchpadValue}isButtonPressed(){return this.__buttonPressed}getControllerStageLocalXfo(){return this.__xfo}getControllerTipStageLocalXfo(){return this.__xfo.multiply(this.__tip.getLocalXfo())}updatePose(e,t,i){const a=t.getPose(i.gripSpace,e);a&&a.transform&&(this.__mat4.setDataArray(a.transform.matrix),this.__xfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__xfo),this.__geomAtTip=void 0,this.__hitTested=!1)}getGeomItemAtTip(){if(this.__hitTested)return this.__intersectionData;this.__hitTested=!0;const e=this.__vrviewport.getRenderer(),t=this.__tip.getGlobalXfo(),i=this.__activeVolumeSize;return this.__intersectionData=e.raycastWithXfo(t,i,i),this.__intersectionData}}class na extends ta{constructor(e){super(e),this.getParameter("DoubleClickTimeMS").setValue(300),this.__projectionMatriciesUpdated=!1,this.__far=1024,this.__near=.1,this.__stageTreeItem=new zt("VRStage"),this.__stageTreeItem.setSelectable(!1),this.__stageTreeItem.setVisible(!1),this.__renderer.addTreeItem(this.__stageTreeItem),this.__vrhead=new aa(this.__renderer.gl,this.__stageTreeItem),this.__vrControllersMap={},this.__vrControllers=[];const t=new R;t.ori.setFromAxisAndAngle(new g(1,0,0),.5*Math.PI),this.setXfo(t),this.__leftViewMatrix=new X,this.__leftProjectionMatrix=new X,this.__rightViewMatrix=new X,this.__rightProjectionMatrix=new X,this.resized=new M,this.viewChanged=new M,this.presentingChanged=new M,this.controllerAdded=new M,this.controllerButtonDown=new M,this.controllerButtonUp=new M,this.controllerDoubleClicked=new M,this.controllerTouchpadTouched=new M}getVRDisplay(){return this.__vrDisplay}getAsset(){return this.__vrAsset}getTreeItem(){return this.__stageTreeItem}getVRHead(){return this.__vrhead}getXfo(){return this.__stageXfo}setXfo(e){this.__stageXfo=e,this.__stageTreeItem.setGlobalXfo(e),this.__stageMatrix=e.inverse().toMat4(),this.__stageScale=e.sc.x}getControllers(){return this.__vrControllers}canPresent(){return this.__canPresent}isPresenting(){return this.__session}__startSession(){const e=(t,i)=>{this.__session&&(this.__session.requestAnimationFrame(e),this.draw(i))};this.__session.requestAnimationFrame(e)}loadHMDResources(){const e=localStorage.getItem("hmd");return this.__hmd!=e&&(this.__hmdAssetPromise=void 0),this.__hmdAssetPromise||(this.__hmd=e,this.__hmdAssetPromise=new Promise((t,i)=>{this.__renderer.sceneSet.connect(a=>{const s=a.getResourceLoader();let n;switch(e){case"Vive":n="ZeaEngine/Vive.vla";break;case"Oculus":default:n="ZeaEngine/Oculus.vla"}const l=s.resolveFilePathToId(n);l&&!r.isMobileDevice?(this.__vrAsset=this.__renderer.getScene().loadCommonAssetResource(l),this.__vrAsset.loaded.connect(()=>{const e=this.__vrAsset.getMaterialLibrary(),i=e.getMaterialNames();for(const t of i){const i=e.getMaterial(t,!1);i&&(i.visibleInGeomDataBuffer=!1,i.setShaderName("SimpleSurfaceShader"))}t(this.__vrAsset)})):i()})})),this.__hmdAssetPromise}startPresenting(){return new Promise((e,t)=>{const i=this.__renderer.gl,a=()=>{navigator.xr.requestSession("immersive-vr",{requiredFeatures:["local-floor"],optionalFeatures:["bounded-floor"]}).then(a=>{let s;this.__renderer.__xrViewportPresenting=!0,r.isMobileDevice||(s=document.createElement("canvas"),s.style.position="relative",s.style.left="0px",s.style.top="0px",s.style.width="100%",s.style.height="100%",this.__renderer.getDiv().replaceChild(s,this.__renderer.getGLCanvas()),a.addEventListener("end",e=>{this.__renderer.getDiv().replaceChild(this.__renderer.getGLCanvas(),s)})),a.addEventListener("end",e=>{this.__stageTreeItem.setVisible(!1),this.__session=null,this.presentingChanged.emit(!1)}),a.addEventListener("selectstart",e=>{const t=this.__vrControllersMap[e.inputSource.handedness];if(t){const i=Date.now();console.log("controller:",e.inputSource.handedness," down",i-t.__prevDownTime),i-t.__prevDownTime<this.__doubleClickTimeMSParam.getValue()?this.controllerDoubleClicked.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this):(t.__prevDownTime=i,this.controllerButtonDown.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this))}}),a.addEventListener("selectend",e=>{const t=this.__vrControllersMap[e.inputSource.handedness];t&&(console.log("controller:",e.inputSource.handedness," up"),this.controllerButtonUp.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this))}),this.__session=a,a.updateRenderState({baseLayer:new XRWebGLLayer(a,i,{compositionDisabled:"inline"==a.mode}),outputContext:s?s.getContext("xrpresent"):null}),a.requestReferenceSpace(r.isMobileDevice?"local":"local-floor").catch(e=>(console.log("Falling back to identity reference space"),a.requestReferenceSpace("viewer").then(e=>e.getOffsetReferenceSpace(new XRRigidTransform({y:-1.6}))))).then(t=>{this.__refSpace=t,this.__stageTreeItem.setVisible(!0),this.presentingChanged.emit(!0),this.__startSession(),e()}).catch(e=>{console.warn(e.message),t("Unable to start XR Session:"+e.message)})}).catch(e=>{console.warn(e.message)})};r.isMobileDevice?a():this.loadHMDResources().then(a)})}stopPresenting(){this.__session&&this.__session.end()}togglePresenting(){this.__session?this.stopPresenting():this.startPresenting()}getHMDCanvasSize(){return this.__hmdCanvasSize}__createController(e,t){console.log("creating controller:",t.handedness);const i=new sa(this,t,e);return this.__vrControllersMap[t.handedness]=i,this.__vrControllers[e]=i,this.controllerAdded.emit(i),i}updateControllers(e){const t=this.__session.inputSources;for(let i=0;i<t.length;i++){const a=t[i];if(""==a.handedness||"none"==a.handedness)return;this.__vrControllers[i]||this.__createController(i,a),this.__vrControllers[i].updatePose(this.__refSpace,e,a)}}draw(e){const t=e.session.renderState.baseLayer,i=e.getViewerPose(this.__refSpace),a=i.views;if(!this.__projectionMatriciesUpdated){this.__projectionMatrices=[],this.__viewMatrices=[],this.__cameraMatrices=[],this.__region=[0,0,0,0];for(let e=0;e<a.length;e++){const i=a[e],s=new X;s.setDataArray(i.projectionMatrix),this.__projectionMatrices[e]=s,this.__viewMatrices[e]=new X,this.__cameraMatrices[e]=new X;const n=t.getViewport(i);this.__region[2]=Math.max(this.__region[2],n.x+n.width),this.__region[3]=Math.max(this.__region[3],n.y+n.height)}this.__renderer.resizeFbos(this.__region[2],this.__region[3]),this.__projectionMatriciesUpdated=!0}const s=this.__renderer.gl;s.bindFramebuffer(s.FRAMEBUFFER,t.framebuffer),this.__backgroundColor&&s.clearColor(...this.__backgroundColor.asArray()),s.colorMask(!0,!0,!0,!0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);const n={boundRendertarget:t.framebuffer,region:this.__region,viewports:[]};for(let e=0;e<a.length;e++){const i=a[e];this.__viewMatrices[e].setDataArray(i.transform.inverse.matrix),this.__viewMatrices[e].multiplyInPlace(this.__stageMatrix);const s=t.getViewport(i);n.viewports.push({viewMatrix:this.__viewMatrices[e],projectionMatrix:this.__projectionMatrices[e],region:[s.x,s.y,s.width,s.height]})}if(this.__vrhead.update(i),this.updateControllers(e),n.viewXfo=this.__vrhead.getTreeItem().getGlobalXfo(),n.viewScale=1/this.__stageScale,n.cameraMatrix=n.viewXfo.toMat4(),n.region=this.__region,this.__renderer.drawScene(n),this.capturedElement){const e={viewport:this};this.capturedElement.onMouseMove(e)}const r={interfaceType:"VR",hmd:this.__hmd,viewXfo:n.viewXfo,controllers:this.__vrControllers,vrviewport:this};this.viewChanged.emit(r,this)}setCapture(e){this.capturedElement=e}getCapture(){return this.capturedElement}releaseCapture(){this.capturedElement=null,this.renderGeomDataFbo()}}let ra=void 0,la=!1,oa=!1;const da={},ha={OPAQUE:1,TRANSPARENT:2,OVERLAY:4};class ca extends B{constructor(){super(),this.updated=new M,this.enabled=!0,this.__passIndex=0;const e=this.addParameter(new he("Enabled",!0));e.valueChanged.connect(t=>this.enabled=e.getValue())}__parameterValueChanged(e,t){super.__parameterValueChanged(e,t),this.__renderer&&this.__renderer.requestRedraw()}init(e,t){if(null==t)throw new Error("Missing constructor argument.");this.__gl=e.gl,this.__renderer=e,this.__passIndex=t}setPassIndex(e){this.__passIndex=e}startPresenting(){}stopPresenting(){}draw(e){}drawHighlightedGeoms(e){}drawGeomData(e){}getGeomItemAndDist(e){}}class ma extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("OutlinesShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    v_texCoord = positions.xy+0.5;\n    gl_Position = vec4(positions.xy*2.0, 0.0, 1.0);\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("OutlinesShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D highlightDataTexture;\nuniform vec2 highlightDataTextureSize;\n\nvarying vec2 v_texCoord;\n\n\nbool isFilledPixel(vec4 p) {\n    return p.r > 0.01 || p.g > 0.01 || p.b > 0.01;\n}\nvoid accumOutlinePixel(vec2 fragCoord, inout vec4 res) {\n    vec3 p = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize).rgb;\n    if(p.r > 0.01 || p.g > 0.01 || p.b > 0.01) {\n        res.r += p.r;\n        res.g += p.g;\n        res.b += p.b;\n        res.a += 1.0;\n    }\n}\nvec4 getOutlinePixelColor(vec2 fragCoord) {\n    vec4 M = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize);\n    \n    /// To display a fill instead of an outline.\n    // return M;\n\n    if( isFilledPixel(M) ) {\n        // Note: the filled pixel has an alpha value\n        // that determines how much fill is applied\n        // The outline is a solid color. \n        return M;\n    }\n    // Search surrounding pixels for selected geoms.\n    vec4 res;\n    accumOutlinePixel(fragCoord+vec2( 1, 1), res); // NW\n    accumOutlinePixel(fragCoord+vec2(-1, 1), res); // NE\n    accumOutlinePixel(fragCoord+vec2( 1,-1), res); // SW\n    accumOutlinePixel(fragCoord+vec2(-1,-1), res); // SE\n    accumOutlinePixel(fragCoord+vec2( 0, 2), res); // NN\n    accumOutlinePixel(fragCoord+vec2(-2, 0), res); // EE\n    accumOutlinePixel(fragCoord+vec2( 2, 0), res); // WW\n    accumOutlinePixel(fragCoord+vec2( 0,-2), res); // SS\n    accumOutlinePixel(fragCoord+vec2( 1, 2), res); // NNW\n    accumOutlinePixel(fragCoord+vec2(-1, 2), res); // NNE\n    accumOutlinePixel(fragCoord+vec2(-2, 1), res); // EEN\n    accumOutlinePixel(fragCoord+vec2(-2,-1), res); // EES\n    accumOutlinePixel(fragCoord+vec2( 2, 1), res); // WWN\n    accumOutlinePixel(fragCoord+vec2( 2,-1), res); // WWS\n    accumOutlinePixel(fragCoord+vec2( 1,-2), res); // SSW\n    accumOutlinePixel(fragCoord+vec2(-1,-2), res); // SSE\n\n    if(isFilledPixel(res))\n        return vec4(res.rgb / res.a, 1.0);\n    else\n        return vec4(0.0, 0.0, 0.0, 0.0);\n}\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    // fragColor = texture2D(highlightDataTexture, v_texCoord);;\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * highlightDataTextureSize; \n    /////////////////\n    // Selection Outlines\n    vec4 outlineColor = getOutlinePixelColor(fragCoord);\n    if(outlineColor.a > 0.0001){\n#ifndef ENABLE_ES3\n        gl_FragColor = outlineColor;\n#else\n        fragColor = outlineColor;\n#endif\n    }\n    else {\n        discard;\n    }\n}\n\n")}}const ua=ha.OPAQUE|ha.TRANSPARENT|ha.OVERLAY;class ba extends class{constructor(e,t={}){if(r.gpuDesc){this.__shaders={},this.__passes={},this.__passCallbacks=[],this.addTreeItem=this.addTreeItem.bind(this),this.removeTreeItem=this.removeTreeItem.bind(this),this.__viewports=[],this.__activeViewport=void 0,this.__continuousDrawing=!1,this.__redrawRequested=!1,this.__isMobile=r.isMobileDevice,this.__drawSuspensionLevel=1,this.__shaderDirectives={},this.__preproc={},this.__xrViewportPresenting=!1,this.renderGeomDataFbos=this.renderGeomDataFbos.bind(this),this.requestRedraw=this.requestRedraw.bind(this),this.resized=new M,this.keyPressed=new M,this.sceneSet=new M(!0),this.vrViewportSetup=new M(!0),this.sessionClientSetup=new M(!0),this.viewChanged=new M,this.redrawOccured=new M,this.setupWebGL(e,t.webglOptions?t.webglOptions:{}),this.bindEventHandlers();for(const e in da)for(const t of da[e])this.addPass(new t,e,!1);this.addViewport("main"),this.__supportXR=void 0===t.supportXR||t.supportXR,this.__xrViewport=void 0,this.__xrViewportPromise=new Promise((e,t)=>{if(this.__supportXR&&navigator.xr){const t=()=>{this.__gl.makeXRCompatible().then(()=>{this.__xrViewport=this.__setupXRViewport(),this.vrViewportSetup.emit(this.__xrViewport),e(this.__xrViewport)})};navigator.xr.supportsSessionMode?navigator.xr.supportsSessionMode("immersive-vr").then(t).catch(e=>{console.warn("Unable to setup XR:"+e)}):navigator.xr.isSessionSupported("immersive-vr").then(e=>{e&&t()}).catch(e=>{console.warn("Unable to setup XR:"+e)})}})}else console.warn("Unable to create renderer")}addShaderPreprocessorDirective(e,t){this.__shaderDirectives[e]=t?"#define "+e+" = "+t:"#define "+e;const i=[];for(const e in this.__shaderDirectives)i.push(this.__shaderDirectives[e]);this.__preproc.defines=i.join("\n")+"\n",this.__gl.shaderopts=this.__preproc}getShaderPreproc(){return this.__preproc}getWidth(){return this.__glcanvas.width}getHeight(){return this.__glcanvas.height}addViewport(e){const t=new ia(this,e,this.getWidth(),this.getHeight());return t.updated.connect(()=>{this.requestRedraw()}),t.createGeomDataFbo(this.__floatGeomBuffer),t.viewChanged.connect(e=>{this.__xrViewportPresenting||this.viewChanged.emit(e)}),this.__viewports.push(t),t}getViewport(e=0){return this.__viewports[e]}getViewportAtPos(e,t){for(const i of this.__viewports){const a=i.getPosX(),s=i.getPosY(),n=i.getWidth(),r=i.getHeight();if(e>=a&&t>=s&&e<=n+a&&t<=r+s)return i}}activateViewport(e){this.__activeViewport!=e&&(this.__activeViewport=e)}activateViewportAtPos(e,t){if(this.__xrViewportPresenting)return;const i=this.getViewportAtPos(e,t);i&&i!=this.__activeViewport&&this.activateViewport(i)}getActiveViewport(){return this.__xrViewportPresenting?this.__xrViewport:this.__activeViewport}suspendDrawing(){this.__drawSuspensionLevel++}resumeDrawing(){this.__drawSuspensionLevel--,0==this.__drawSuspensionLevel&&(this.__loadingImg&&this.__glcanvasDiv.removeChild(this.__loadingImg),this.renderGeomDataFbos(),this.requestRedraw())}renderGeomDataFbos(){1!=this.__renderGeomDataFbosRequested&&(this.__renderGeomDataFbosRequested=!0,window.requestAnimationFrame(()=>{for(const e of this.__viewports)e.renderGeomDataFbo();this.__renderGeomDataFbosRequested=!1}))}setupGrid(e,t,i,a){return console.warn("Deprecated Method. Please use scene.setupGrid"),this.__scene.setupGrid(e,i,t)}getScene(){return this.__scene}setScene(e){this.__scene=e,this.addTreeItem(this.__scene.getRoot()),this.__gizmoContext&&this.__gizmoContext.setSelectionManager(e.getSelectionManager()),this.sceneSet.emit(this.__scene)}addTreeItem(e){if(e instanceof zt){for(const t of this.__passCallbacks){const i={continueInSubTree:!0};if(t.itemAddedFn(e,i)){if(!i.continueInSubTree)return;break}}for(const t of e.getChildren())t&&this.addTreeItem(t);e.childAdded.connect(this.addTreeItem),e.childRemoved.connect(this.removeTreeItem),this.renderGeomDataFbos()}}removeTreeItem(e){if(e instanceof zt){e.childAdded.disconnect(this.addTreeItem),e.childRemoved.disconnect(this.removeTreeItem);for(const t of this.__passCallbacks){if(!t.itemRemovedFn)continue;const i={continueInSubTree:!0};if(t.itemRemovedFn(e,i)){if(!i.continueInSubTree)return;break}}for(const t of e.getChildren())t&&this.removeTreeItem(t);this.renderGeomDataFbos()}}get gl(){return this.__gl}getGL(){return this.__gl}resizeFbos(e,t){}__onResize(){if(!this.__xrViewportPresenting){const e=1;this.__glcanvas.width=this.__glcanvas.clientWidth*e,this.__glcanvas.height=this.__glcanvas.clientHeight*e;for(const e of this.__viewports)e.resize(this.__glcanvas.width,this.__glcanvas.height);this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.resized.emit(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw()}}getDiv(){return this.__glcanvasDiv}setupWebGL(e,t){this.__glcanvas=document.createElement("canvas"),this.__glcanvas.style.position=t.canvasPosition?t.canvasPosition:"absolute",this.__glcanvas.style.left="0px",this.__glcanvas.style.top="0px",this.__glcanvas.style.width="100%",this.__glcanvas.style.height="100%",this.__glcanvasDiv=e,this.__glcanvasDiv.appendChild(this.__glcanvas),n(this.__glcanvas,e=>{this.__onResize()}),this.__onResize(),t.preserveDrawingBuffer=!0,t.stencil=!!t.stencil&&t.stencil,t.alpha=!!t.alpha&&t.alpha,t.xrCompatible=!0,this.__gl=ui(this.__glcanvas,t),this.__gl||alert("Unable to create WebGL context. WebGL not supported."),this.__gl.renderer=this,"webgl2"==this.__gl.name&&this.addShaderPreprocessorDirective("ENABLE_ES3"),this.__gl.floatTexturesSupported&&this.addShaderPreprocessorDirective("ENABLE_FLOAT_TEXTURES"),this.__gl.screenQuad=new ea(this.__gl),this.__screenQuad=this.__gl.screenQuad,this.__floatGeomBuffer=this.__gl.floatTexturesSupported&&"Safari"!=r.browserName,this.__gl.floatGeomBuffer=this.__floatGeomBuffer}bindEventHandlers(){const e=()=>this.__glcanvas.width>0&&this.__glcanvas.height,t=e=>{const t=this.__glcanvas.getBoundingClientRect();e.rendererX=1*(e.clientX-t.left),e.rendererY=1*(e.clientY-t.top)};this.__glcanvas.addEventListener("mouseenter",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,la||(ra=this,t(e),ra.activateViewportAtPos(e.rendererX,e.rendererY),oa=!1)}),this.__glcanvas.addEventListener("mouseleave",t=>{if(ra==this&&e())if(t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,la)oa=!0;else{const e=ra.getActiveViewport();e&&(e.onMouseLeave(t),t.preventDefault()),ra=void 0}}),this.__glcanvas.addEventListener("mousedown",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,t(e),la=!0,ra=this,ra.activateViewportAtPos(e.rendererX,e.rendererY);const i=ra.getActiveViewport();return i&&i.onMouseDown(e),oa=!1,!1}),document.addEventListener("mouseup",i=>{if(ra!=this||!e())return;i.stopPropagation(),i.undoRedoManager=this.undoRedoManager,t(i),la=!1;const a=ra.getActiveViewport();if(a&&a.onMouseUp(i),oa){const e=ra.getActiveViewport();e&&(e.onMouseLeave(i),i.preventDefault()),ra=void 0}return!1}),document.addEventListener("mousemove",i=>{if(ra!=this||!e())return;i.preventDefault(),i.stopPropagation(),i.undoRedoManager=this.undoRedoManager,t(i),la||ra.activateViewportAtPos(i.rendererX,i.rendererY);const a=ra.getActiveViewport();return a&&a.onMouseMove(i),!1});const i=t=>{if(ra==this&&e())return ra&&(t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,window.addEventListener||t.preventDefault(),this.onWheel(t)),!1};window.addEventListener?window.addEventListener("wheel",i,{passive:!0}):window.onmousewheel=document.onmousewheel=i,window.oncontextmenu=function(){return!1},document.addEventListener("keypress",t=>{if(ra!=this||!e())return;const i=String.fromCharCode(t.keyCode).toLowerCase(),a=ra.getActiveViewport();a&&a.onKeyPressed(i,t)}),document.addEventListener("keydown",t=>{if(ra!=this||!e())return;const i=String.fromCharCode(t.keyCode).toLowerCase(),a=ra.getActiveViewport();a&&a.onKeyDown(i,t)}),document.addEventListener("keyup",t=>{if(ra!=this||!e())return;const i=String.fromCharCode(t.keyCode).toLowerCase(),a=ra.getActiveViewport();a&&a.onKeyUp(i,t)}),this.__glcanvas.addEventListener("touchstart",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let i=0;i<e.touches.length;i++)t(e.touches[i]);this.getViewport().onTouchStart(e)},!1),this.__glcanvas.addEventListener("touchmove",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let i=0;i<e.touches.length;i++)t(e.touches[i]);this.getViewport().onTouchMove(e)},!1),this.__glcanvas.addEventListener("touchend",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let i=0;i<e.touches.length;i++)t(e.touches[i]);this.getViewport().onTouchEnd(e)},!1),this.__glcanvas.addEventListener("touchcancel",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,this.getViewport().onTouchCancel(e)},!1)}setUndoRedoManager(e){this.undoRedoManager=e}getGLCanvas(){return this.__glcanvas}getScreenQuad(){return this.__screenQuad}onWheel(e){this.__viewports[0].onWheel(e)}frameAll(e=0){this.__viewports[e].frameView([this.__scene.getRoot()])}getOrCreateShader(e){let t=this.__shaders[e];return t||(t=z.constructClass(e,this.__gl),t||console.error("Shader not registered with the SGFactory:",e),this.__shaders[e]=t),t}addPass(e,t=0,i=!0){this.__passes[t]||(this.__passes[t]=[]);let a=0;for(const e in this.__passes){if(e==t)break;a+=this.__passes[e].length}if(a+=this.__passes[t].length,e.updated.connect(this.requestRedraw.bind(this)),e.init(this,a),this.__passes[t].push(e),i){let e=0;for(const t in this.__passes){const i=this.__passes[t];i.forEach((t,i)=>{t.setPassIndex(e+i)}),e+=i.length}}return this.requestRedraw(),a}registerPass(e,t){this.__passCallbacks.splice(0,0,{itemAddedFn:e,itemRemovedFn:t})}getPass(e){let t=0;for(const i in this.__passes){const a=this.__passes[i];if(e-t<a.length)return a[e-t];t+=a.length}}findPass(e){for(const t in this.__passes){const i=this.__passes[t];for(const t of i)if(t.constructor==e)return t}}getGizmoPass(){return this.__gizmoPass}supportsVR(){return console.warn("Deprecated Method. Please instead connect to the vrViewportSetup signal."),this.__supportXR&&null!=navigator.xr}__setupXRViewport(){const e=new na(this);return e.presentingChanged.connect(t=>{if(this.__xrViewportPresenting=t,t){for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.startPresenting()}e.viewChanged.connect(this.viewChanged.emit)}else{e.viewChanged.disconnect(this.viewChanged.emit);for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.stopPresenting()}this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.getViewport().getCamera().getGlobalXfo()}),this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw()}}),e}getVRViewport(){return this.__xrViewport}getXRViewport(){return this.__xrViewportPromise}isXRViewportPresenting(){return this.__xrViewportPresenting}isContinuouslyDrawing(){return this.__continuousDrawing}startContinuousDrawing(){if(this.isContinuouslyDrawing()||this.__xrViewportPresenting)return;const e=()=>{this.__continuousDrawing&&!this.__xrViewportPresenting&&window.requestAnimationFrame(e);for(const e of this.__viewports)e.draw()};this.__continuousDrawing=!0,window.requestAnimationFrame(e)}stopContinuousDrawing(){this.__continuousDrawing=!1}toggleContinuousDrawing(){this.__continuousDrawing?this.stopContinuousDrawing():this.startContinuousDrawing()}drawItemChanged(){for(const e of this.__viewports)e.invalidateGeomDataBuffer();this.requestRedraw()}requestRedraw(){return!(this.__redrawRequested||this.__continuousDrawing||this.__xrViewportPresenting)&&(window.requestAnimationFrame(()=>{this.__redrawRequested=!1;for(const e of this.__viewports)e.draw()}),this.__redrawRequested=!0,!0)}bindGLBaseRenderer(e){e.shaderopts=this.__preproc;const t=this.__gl;e.viewports&&1!=e.viewports.length?(e.bindRendererUnifs=i=>{const{cameraMatrix:a}=i;a&&t.uniformMatrix4fv(a.location,!1,e.cameraMatrix.asArray())},e.bindViewports=(i,a)=>{e.viewports.forEach((e,s)=>{t.viewport(...e.region);const{viewMatrix:n,projectionMatrix:r,eye:l}=i;n&&t.uniformMatrix4fv(n.location,!1,e.viewMatrix.asArray()),r&&t.uniformMatrix4fv(r.location,!1,e.projectionMatrix.asArray()),l&&t.uniform1i(l.location,s),a()})}):(e.bindRendererUnifs=i=>{const{cameraMatrix:a,viewMatrix:s,projectionMatrix:n,eye:r}=i;a&&t.uniformMatrix4fv(a.location,!1,e.cameraMatrix.asArray());const l=e.viewports[0];s&&t.uniformMatrix4fv(s.location,!1,l.viewMatrix.asArray()),n&&t.uniformMatrix4fv(n.location,!1,l.projectionMatrix.asArray()),r&&t.uniform1i(r.location,index)},e.bindViewports=(e,t)=>t())}drawScene(e){for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.enabled&&t.draw(e)}}drawHighlightedGeoms(e){this.bindGLBaseRenderer(e);for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.enabled&&t.drawHighlightedGeoms(e)}}drawSceneGeomData(e,t=255){this.bindGLBaseRenderer(e);for(const i in this.__passes){if(0==(Number.parseInt(i)&t))continue;const a=this.__passes[i];for(const t of a)t.enabled&&t.drawGeomData(e)}}static registerPass(e,t){da[t]||(da[t]=[]),da[t].push(e)}}{constructor(e,t={}){super(e,t,{antialias:!0,depth:!0}),this.__exposure=1,this.__tonemap=!0,this.__gamma=2.2,this.__glEnvMap=void 0,this.__glBackgroundMap=void 0,this.envMapAssigned=new M(!0),this.__glLightmaps={},this.__displayEnvironment=!0,this.__debugMode=0,this.__debugLightmaps=!1,this._planeDist=0,this.__cutPlaneNormal=new g(1,0,0);const i=this.__gl;this.__debugTextures=[void 0],this.addShaderPreprocessorDirective("ENABLE_INLINE_GAMMACORRECTION"),t.disableLightmaps||this.addShaderPreprocessorDirective("ENABLE_LIGHTMAPS"),t.disableTextures||this.addShaderPreprocessorDirective("ENABLE_TEXTURES"),r.isMobileDevice||t.disableSpecular||this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__outlineShader=new ma(i),this.quad=new Zi(i,new Ct(1,1)),this.createSelectedGeomsFbo(),this.createRayCastRenderTarget()}__bindEnvMap(e){if(e instanceof lt)this.__glEnvMap=e.getMetadata("gltexture"),this.__glEnvMap||("FLOAT"===e.type?(this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__glEnvMap=new qi(this,e,this.__preproc)):e.isStreamAtlas()?this.__glEnvMap=new GLImageStream(this.__gl,e):this.__glEnvMap=new bi(this.__gl,e)),this.__glEnvMap.loaded.connect(this.requestRedraw),this.__glEnvMap.updated.connect(this.requestRedraw),this.envMapAssigned.emit(this.__glEnvMap);else{const t=e;if(this.__glBackgroundMap=t.getMetadata("gltexture"),this.__glBackgroundMap||("FLOAT"===t.type?this.__glBackgroundMap=new Wi(gl,t):this.__glBackgroundMap=new bi(gl,t)),this.__glBackgroundMap.loaded.connect(this.requestRedraw),this.__glBackgroundMap.updated.connect(this.requestRedraw),!this.__backgroundMapShader){switch(gl.__quadVertexIdsBuffer||gl.setupInstancedQuad(),t.getMapping()){case"octahedral":this.__backgroundMapShader=new Oi(gl);break;case"latlong":this.__backgroundMapShader=new Ai(gl);break;case"steriolatlong":this.__backgroundMapShader=new Qi(gl);break;case"dualfisheye":this.__backgroundMapShader=new ji(gl);break;case"uv":default:this.__backgroundMapShader=new Di(gl)}const e=this.__backgroundMapShader.compileForTarget();this.__backgroundMapShaderBinding=_i(gl,e.attrs,gl.__quadattrbuffers,gl.__quadIndexBuffer)}}}getGLEnvMap(){return this.__glEnvMap}getEnvMapTex(){return console.warn("Deprecated Function"),this.__glEnvMap}setScene(e){const t=e.settings.getParameter("EnvMap");null!=t.getValue()&&this.__bindEnvMap(t.getValue()),t.valueChanged.connect(()=>{this.__bindEnvMap(t.getValue())});const i=e.settings.getParameter("Display EnvMap");this.__displayEnvironment=i.getValue(),i.valueChanged.connect(()=>{this.__displayEnvironment=i.getValue(),this.requestRedraw()}),super.setScene(e)}addTreeItem(e){if(super.addTreeItem(e),e instanceof qt){const t=(e,t)=>{let i=t.image.getMetadata("gltexture");i||(i=new Wi(this.__gl,t.image)),i.updated.connect(e=>{this.requestRedraw()}),this.__glLightmaps[e]={atlasSize:t.atlasSize,glimage:i}},i=e;i.loaded.connect(()=>{this.__glEnvMap&&i.getLightmap()&&t(i.getName(),i.getLightmap())})}}removeTreeItem(e){super.removeTreeItem(e)}addViewport(e){return super.addViewport(e)}onKeyPressed(e,t){switch(e){case"b":this.__displayEnvironment=!this.__displayEnvironment,this.requestRedraw();break;default:super.onKeyPressed(e,t)}}get exposure(){return this.__exposure}set exposure(e){this.__exposure=e,this.requestRedraw()}get gamma(){return this.__gamma}set gamma(e){this.__gamma=e,this.requestRedraw()}get displayEnvironment(){return this.__displayEnvironment}set displayEnvironment(e){this.__displayEnvironment=e,this.requestRedraw()}get planeDist(){return this._planeDist}set planeDist(e){this._planeDist=e,this.requestRedraw()}get cutPlaneNormal(){return this.__cutPlaneNormal}set cutPlaneNormal(e){this.__cutPlaneNormal=e,this.requestRedraw()}resizeFbos(e,t){super.resizeFbos(),this.__fbo&&this.__fbo.colorTexture.resize(e,t),this.__highlightedGeomsBufferFbo&&this.__highlightedGeomsBuffer.resize(e,t)}createSelectedGeomsFbo(){const e=this.__gl;this.__highlightedGeomsBuffer=new bi(e,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__glcanvas.width<=1?1:this.__glcanvas.width,height:this.__glcanvas.height<=1?1:this.__glcanvas.height}),this.__highlightedGeomsBufferFbo=new Si(e,this.__highlightedGeomsBuffer,!0),this.__highlightedGeomsBufferFbo.setClearColor([0,0,0,0])}getFbo(){return this.__fbo}createOffscreenFbo(e="RGB"){const t=this.__glcanvas.width,i=this.__glcanvas.height,a=this.__gl;this.__fwBuffer=new bi(a,{type:"FLOAT",format:e,filter:"NEAREST",width:t,height:i}),this.__fbo=new Si(a,this.__fwBuffer,!0),this.__fbo.setClearColor(this.__backgroundColor.asArray())}createRayCastRenderTarget(){const e=this.__gl;this.__rayCastRenderTarget=new Yi(e,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:3,height:3,numColorChannels:1}),this.__rayCastRenderTargetProjMatrix=new X,this.rayCastDist=0,this.rayCastArea=0}raycastWithRay(e,t,i=.01,a=ua){const s=new R;return s.setLookAt(e.start,e.start.add(e.dir)),this.raycast(s,e,t,i,a)}raycastWithXfo(e,t,i=.01,a=ua){const s=new I(e.tr,e.ori.getZaxis().negate());return this.raycast(e,s,t,i,a)}raycast(e,t,i,a=.01,s=ua){this.rayCastDist==i&&this.rayCastArea==a||(this.__rayCastRenderTargetProjMatrix.setOrthographicMatrix(-.5*a,.5*a,-.5*a,.5*a,0,i),this.rayCastDist=i,this.rayCastArea=a);const n=this.__gl,r={cameraMatrix:e.toMat4(),viewports:[{region:[0,0,3,3],viewMatrix:e.inverse().toMat4(),projectionMatrix:this.__rayCastRenderTargetProjMatrix,isOrthographic:!0}]};this.__rayCastRenderTarget.bindForWriting(r,!0),n.enable(n.CULL_FACE),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.depthMask(!0),this.drawSceneGeomData(r,s),n.finish(),this.__rayCastRenderTarget.unbindForWriting(),this.__rayCastRenderTarget.bindForReading();const l=new Float32Array(36);n.readPixels(0,0,3,3,n.RGBA,n.FLOAT,l),this.__rayCastRenderTarget.unbindForReading();const o=[4,3,5,1,7];let d;for(const e of o)if(0!=l[4*e+3]){d=l.subarray(4*e,4*e+4);break}if(!d)return;const h=63&Math.round(d[0]),c=this.getPass(h).getGeomItemAndDist(d);if(c){const e=t.start.add(t.dir.scale(c.dist));return{ray:t,intersectionPos:e,geomItem:c.geomItem,dist:c.dist,geomData:d}}}drawBackground(e){if(this.__glBackgroundMap){if(!this.__glBackgroundMap.isLoaded())return;const t=this.__gl;t.depthMask(!1),this.__backgroundMapShader.bind(e);const i=e.unifs;this.__glBackgroundMap.bindToUniform(e,i.backgroundImage),this.__backgroundMapShaderBinding.bind(e),t.drawQuad()}else this.__glEnvMap&&this.__glEnvMap.draw&&this.__glEnvMap.draw(e)}bindGLRenderer(e){super.bindGLBaseRenderer(e),e.envMap=this.__glEnvMap,e.exposure=this.__exposure,e.gamma=this.__gamma,e.lightmaps=this.__glLightmaps,e.boundLightmap=void 0;const t=this.__gl,i=e.bindRendererUnifs;e.bindRendererUnifs=a=>{if(i(a),this.__glEnvMap){const t=a.envMapPyramid;if(t&&this.__glEnvMap.bindProbeToUniform)this.__glEnvMap.bindProbeToUniform(e,t);else{const{envMapTex:t,envMapTexType:i}=a;t&&this.__glEnvMap.bindToUniform(e,t,{textureTypeUnif:i})}}{const e=a.exposure;e&&t.uniform1f(e.location,this.__exposure)}{const e=a.gamma;e&&t.uniform1f(e.location,this.__gamma)}}}drawScene(e){if(this.bindGLRenderer(e),this.__displayEnvironment&&this.drawBackground(e),super.drawScene(e),this.__highlightedGeomsBufferFbo){const t=this.__gl;this.__highlightedGeomsBufferFbo.bindForWriting(e),this.__highlightedGeomsBufferFbo.clear(),t.disable(t.BLEND),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),this.drawHighlightedGeoms(e),this.__highlightedGeomsBufferFbo.unbindForWriting(e),t.viewport(...e.region),this.__outlineShader.bind(e),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const i=e.unifs;this.__highlightedGeomsBuffer.bindToUniform(e,i.highlightDataTexture),t.uniform2f(i.highlightDataTextureSize.location,e.region[2],e.region[3]),this.quad.bindAndDraw(e),t.disable(t.BLEND)}this.redrawOccured.emit()}}Vi.setShaderModule("drawItemId.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nattribute float instancedIds;    // instanced attribute..\nuniform int instancedDraw;\nuniform int transformIndex;\n\nint getDrawItemId() {\n    if(instancedDraw == 0){\n       return transformIndex;\n    }\n    else{\n       return int(instancedIds);\n    }\n}\n\n\n#else\n\nuniform int transformIndex;\n\nint getDrawItemId() {\n    return transformIndex;\n}\n\n#endif\n\n"),Vi.setShaderModule("drawItemTexture.glsl",'\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nuniform sampler2D instancesTexture;\nuniform highp int instancesTextureSize;\n\n<%include file="GLSLUtils.glsl"/>\n\nconst int pixelsPerItem = 6;\n\nvec4 getInstanceData(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 0);\n}\n\n#else\n\nuniform vec4 drawItemData;\n\nvec4 getInstanceData(int id) {\n    return drawItemData;\n}\n\n#endif\n\n\n'),Vi.setShaderModule("modelMatrix.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n    // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n    vec4 col0 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 1);\n    vec4 col1 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 2);\n    vec4 col2 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 3);\n    mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n    return transpose(result);\n    // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n    return getMatrix(instancesTexture, instancesTextureSize, id);\n}\n\n#else\n\nuniform mat4 modelMatrix;\n\nmat4 getModelMatrix(int id) {\n    return modelMatrix;\n}\n\n#endif\n\n\n"),Vi.setShaderModule("materialparams.glsl","\n\n////////////////////////\n// Material Param Helpers.\n\nvec4 getColorParamValue(vec4 value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0){\n        return toLinear(value);\n    }\n    else if(texType == 1 || texType == 2){\n        // TODO: Use SRGB textures.\n        return toLinear(texture2D(tex, texCoord));\n    }\n    else if(texType == 3){\n        // Float HDR Texture\n        return texture2D(tex, texCoord);\n    }\n    else\n        return value;\n}\n\n\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\nfloat getLuminanceParamValue(float value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0)\n        return value;\n    else\n        return luminanceFromRGB(texture2D(tex, texCoord).rgb);\n}\n"),Vi.setShaderModule("debugColors.glsl","\n\nfloat modI(float a, float b) {\n    float m=a-floor((a+0.5)/b)*b;\n    return floor(m+0.5);\n}\n\nvec3 getDebugColor(float id) {\n#ifdef GLSL_ES3\n    const vec3 clusterColors[4] = vec3[4]( vec3(0.0, 0.25, 0.25), vec3(0.0, 0.85, 0.25), vec3(0.0, 0.25, 0.85), vec3(0.0, 0.85, 0.85) );\n#else\n    vec3 clusterColors[8];\n    clusterColors[0] = vec3(0.0, 0.15, 0.15);\n    clusterColors[1] = vec3(0.0, 0.85, 0.15);\n    clusterColors[2] = vec3(0.0, 0.15, 0.85);\n    clusterColors[3] = vec3(0.0, 0.85, 0.85);\n    clusterColors[4] = vec3(0.75, 0.15, 0.15);\n    clusterColors[5] = vec3(0.75, 0.85, 0.15);\n    clusterColors[6] = vec3(0.75, 0.15, 0.85);\n    clusterColors[7] = vec3(0.75, 0.85, 0.85);\n#endif\n\n    if(modI(id, 8.0) == 0.0)\n        return clusterColors[0];\n    else if(modI(id, 8.0) == 1.0)\n        return clusterColors[1];\n    else if(modI(id, 8.0) == 2.0)\n        return clusterColors[2];\n    else if(modI(id, 8.0) == 3.0)\n        return clusterColors[3];\n    else if(modI(id, 8.0) == 4.0)\n        return clusterColors[4];\n    else if(modI(id, 8.0) == 5.0)\n        return clusterColors[5];\n    else if(modI(id, 8.0) == 6.0)\n        return clusterColors[6];\n    else if(modI(id, 8.0) == 7.0)\n        return clusterColors[7];\n\n    return vec3(1,0,0);\n}\n\n\n");class pa extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("BillboardShader.vertexShader",'\nprecision highp float;\n\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\ninstancedattribute float instanceIds;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards_layout;\nuniform vec4 atlasBillboards_desc;\n\nuniform sampler2D instancesTexture;\nuniform int instancesTextureSize;\n\n\nconst int cols_per_instance = 5;\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n  // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n  vec4 col0 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 0);\n  vec4 col1 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 1);\n  vec4 col2 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 2);\n  mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n  return transpose(result);\n  // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n  return getMatrix(instancesTexture, instancesTextureSize, id);\n}\nvec4 getInstanceData(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 3);\n}\nvec4 getTintColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 4);\n}\n\n\n#else\n\nuniform vec4 atlasBillboards_desc;\n\nuniform mat4 modelMatrix;\nuniform vec4 billboardData;\nuniform vec4 tintColor;\nuniform vec4 layoutData;\n\n\n#endif\n\nmat4 calcLookAtMatrix(vec3 origin, vec3 target, float roll) {\n  // vec3 rr = vec3(sin(roll), 0.0, cos(roll));\n  vec3 rr = vec3(0.0, 0.0, 1.0);\n  vec3 ww = normalize(target - origin);\n  vec3 uu = normalize(cross(rr, ww));\n  vec3 vv = normalize(cross(ww, uu));\n\n  return mat4(vec4(uu, 0.0), vec4(vv, 0.0), vec4(ww, 0.0), vec4(origin, 1.0));\n}\n\nfloat map(float value, float inMin, float inMax, float outMin, float outMax) {\n  return outMin + (outMax - outMin) * (value - inMin) / (inMax - inMin);\n}\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\nvoid main(void) {\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n  int instanceID = int(instanceIds);\n\n  mat4 modelMatrix = getModelMatrix(instanceID);\n  vec4 billboardData = getInstanceData(instanceID);\n  vec4 layoutData = fetchTexel(atlasBillboards_layout, int(atlasBillboards_desc.z), int(billboardData.z));\n  v_tint = getTintColor(instanceID);\n\n#else\n\n  v_tint = tintColor;\n\n#endif\n\n  vec2 quadVertex = getQuadVertexPositionFromID();\n\n\n  v_texCoord = vec2(quadVertex.x, -quadVertex.y) + 0.5;\n  v_alpha = billboardData.w;\n  v_texCoord *= layoutData.zw;\n  v_texCoord += layoutData.xy;\n\n  float scl = billboardData.x;\n  float width = layoutData.z * atlasBillboards_desc.x * scl;\n  float height = layoutData.w * atlasBillboards_desc.y * scl;\n  int flags = int(billboardData.y);\n  bool alignedToCamera = flags > 0;\n  if(alignedToCamera){\n    vec3 cameraPos = vec3(cameraMatrix[3][0], cameraMatrix[3][1], cameraMatrix[3][2]);\n    vec3 billboardPos = vec3(modelMatrix[3][0], modelMatrix[3][1], modelMatrix[3][2]);\n    mat4 lookAt = calcLookAtMatrix(billboardPos, cameraPos, 0.0);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * lookAt;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n  else{\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n\n  bool overlay = flags > 0;\n  if(overlay){\n    gl_Position.z -= 0.05;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("BillboardShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = texture2D(atlasBillboards, v_texCoord) * v_tint;\n  fragColor.a *= v_alpha;\n\n  // fragColor.r = 1.0;\n  // fragColor.a = 1.0;\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class ga extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("EnvProjectionShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 projectionCenter;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n \nvoid main()\n{\n  int drawItemId = getDrawItemId();\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n\n  gl_Position = modelViewProjectionMatrix * pos;\n\n  vec4 worldPos = modelMatrix * pos;\n  v_worldDir = worldPos.xyz - projectionCenter;\n}\n\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"projectionCenter",defaultValue:new g(0,0,1.7)}),e}}class _a extends ga{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("OctahedralEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}z.registerClass("OctahedralEnvProjectionShader",_a);class fa extends ga{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("LatLongEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = latLongUVsFromDir(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}z.registerClass("LatLongEnvProjectionShader",fa);class Za extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("FatLinesShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec2 segmentIndices;\nattribute float vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform sampler2D positionsTexture;\nuniform int positionsTextureSize;\n\nuniform float LineThickness;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  int vertexID = int(vertexIDs);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  int seqentialIndex_0 = int(mod(segmentIndices.x, 2.));\n  int seqentialIndex_1 = int(mod(segmentIndices.y, 2.));\n  int index_0 = int(segmentIndices.x) / 2;\n  int index_1 = int(segmentIndices.y) / 2;\n\n  vec3 viewPos;\n  vec4 data_0 = fetchTexel(positionsTexture, positionsTextureSize, index_0);\n  vec4 data_1 = fetchTexel(positionsTexture, positionsTextureSize, index_1);\n\n  vec4 pos_0 = modelViewMatrix * vec4(data_0.xyz, 1.0);\n  vec4 pos_1 = modelViewMatrix * vec4(data_1.xyz, 1.0);\n  // Note: multiply the per-vertex line thickness with the line thickness uniform value;\n  float lineThickness_0 = LineThickness * data_0.w;\n  float lineThickness_1 = LineThickness * data_1.w;\n\n  if(vertexID < 2){\n    viewPos = pos_0.xyz;\n  }\n  else{\n    viewPos = pos_1.xyz;\n  }\n  if(pos_1 != pos_0){\n    vec3 segmentDir = normalize(pos_1.xyz - pos_0.xyz);\n    vec3 viewVector = normalize(viewPos);\n\n    if(vertexID < 2){\n      vec3 segmentStartDir = segmentDir;\n      if(seqentialIndex_0 != 0){\n        //if index_0 == 0, get the last index in the line as previous\n        int index_prev = (index_0 > 0) ? (index_0-1) : (positionsTextureSize-1);\n        vec4 data_prev = fetchTexel(positionsTexture, positionsTextureSize, index_prev);\n        vec4 pos_prev = modelViewMatrix * vec4(data_prev.xyz, 1.0);\n        segmentStartDir = normalize(segmentDir + normalize(pos_0.xyz - pos_prev.xyz));\n      }\n      vec3 startBiTangent = normalize(cross(segmentStartDir, viewVector));\n      v_viewNormal = normalize(cross(segmentStartDir, startBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos -= vec3(segmentStartDir * lineThickness_0 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 0.0;\n    }\n    else{\n      vec3 segmentEndDir = segmentDir;\n      if(seqentialIndex_1 != 0){\n        //if index_1 == numPoints-1, get the first index in the line as next\n        int index_next = (index_1 < (positionsTextureSize-1)) ? (index_1+1) : 0;\n        vec4 data_next = fetchTexel(positionsTexture, positionsTextureSize, index_next);\n        vec4 pos_next = modelViewMatrix * vec4(data_next.xyz, 1.0);\n        segmentEndDir = normalize(segmentDir + normalize(pos_next.xyz - pos_1.xyz));\n      }\n      vec3 endBiTangent = normalize(cross(segmentEndDir, viewVector));\n      v_viewNormal = normalize(cross(segmentEndDir, endBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos += vec3(segmentEndDir * lineThickness_1 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 1.0;\n    }\n\n    // Move the line towards the viewer by the line thickness.\n    // this is to avoid depth issues when lines are rendered over meshes. \n    viewPos.z -= (lineThickness_0 + lineThickness_1) * 0.25;\n  }\n\n  v_viewPos       = viewPos;\n  gl_Position     = projectionMatrix * vec4(viewPos, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FatLinesShader.fragmentShader","\nprecision highp float;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nuniform color BaseColor;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int debugLevel = 0;\n  if(debugLevel == 0){\n\n    vec3 viewVector = mat3(cameraMatrix) * normalize(-v_viewPos);\n    vec3 normal = mat3(cameraMatrix) * v_viewNormal;\n    float NdotV = dot(normalize(normal), normalize(viewVector));\n\n    // Modulate the lighting using the texture coord so the line looks round.\n    NdotV *= cos((v_texCoord.x - 0.5) * 2.0);\n\n    vec4 color = BaseColor * NdotV;\n    fragColor = vec4(color.rgb, BaseColor.a);\n  }\n  else{\n    fragColor = vec4(v_texCoord.x, 0.0, 0.0, 1.0);\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}bind(e){return!!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e}}z.registerClass("FatLinesShader",Za),Vi.setShaderModule("stack-gl/gamma.glsl","\n\nconst float gamma_const = 2.2;\n\nfloat toLinear(float v) {\n  return pow(v, gamma_const);\n}\n\nvec2 toLinear(vec2 v) {\n  return pow(v, vec2(gamma_const));\n}\n\nvec3 toLinear(vec3 v) {\n  return pow(v, vec3(gamma_const));\n}\n\nvec4 toLinear(vec4 v) {\n  return vec4(toLinear(v.rgb), v.a);\n}\n\n\nfloat toGamma(float v) {\n  return pow(v, 1.0 / gamma_const);\n}\n\nvec2 toGamma(vec2 v) {\n  return pow(v, vec2(1.0 / gamma_const));\n}\n\nvec3 toGamma(vec3 v) {\n  return pow(v, vec3(1.0 / gamma_const));\n}\n\nvec4 toGamma(vec4 v) {\n  return vec4(toGamma(v.rgb), v.a);\n}\n\nfloat toGamma(float v, float gamma) {\n  return pow(v, 1.0 / gamma);\n}\n\nvec2 toGamma(vec2 v, float gamma) {\n  return pow(v, vec2(1.0 / gamma));\n}\n\nvec3 toGamma(vec3 v, float gamma) {\n  return pow(v, vec3(1.0 / gamma));\n}\n\nvec4 toGamma(vec4 v, float gamma) {\n  return vec4(toGamma(v.rgb, gamma), v.a);\n}\n\n\n");class Ga extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("FlatSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n    vec4 viewPos = (modelViewMatrix * vec4(positions, 1.0));\n    gl_Position = projectionMatrix * viewPos;\n\n    v_viewPos = viewPos.xyz;\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FlatSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}z.registerClass("FlatSurfaceShader",Ga);class ya extends Ga{static isTransparent(){return!0}bind(e,t){return"ADD"==e.pass&&super.bind(e,t)}}z.registerClass("FlatAlphaSurfaceShader",ya),Vi.setShaderModule("math/constants.glsl","\n\n#define PI 3.141592653589793\n#define TwoPI (2.0 * PI)\n#define HalfPI (0.5 * PI)\n\n"),Vi.setShaderModule("GGX_Specular.glsl",'\n\n\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n\n// uniform ImageAtlas envMap;\n// see: GLImageAtlas.js: line 460.\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\nvec3 sampleEnvMap(vec3 dir, float roughness) {\n    return sampleImagePyramid(dirToSphOctUv(dir), roughness, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb;\n}\n\n\n// Borrowed heavily from here: http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx\n\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n    return F0 + (vec3(1.0)-F0) * vec3(pow( 1.0 - cosT, 5.0));\n\n    // for now we calculate this in the suface shader\n    // float schlick = reflectance + pow((1.0-reflectance)*(1.0-dot(N,V)), 5.0);\n}\n\nfloat chiGGX(float v)\n{\n    return v > 0.0 ? 1.0 : 0.0;\n}\n\nfloat saturate(float v)\n{\n    return clamp(v, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 v)\n{\n    return clamp(v, vec3(0.0), vec3(1.0));\n}\n\nfloat saturatedDot( in vec3 a, in vec3 b )\n{\n    return max( dot( a, b ), 0.0 );   \n}\n\nfloat GGX_PartialGeometryTerm(vec3 v, vec3 n, vec3 h, float alpha)\n{\n    float VoH2 = saturate(dot(v,h));\n    float chi = chiGGX( VoH2 / saturate(dot(v,n)) );\n    VoH2 = VoH2 * VoH2;\n    float tan2 = ( 1.0 - VoH2 ) / VoH2;\n    return (chi * 2.0) / ( 1.0 + sqrt( 1.0 + alpha * alpha * tan2 ) );\n}\n\nvec3 GGX_Specular_PrefilteredEnv(vec3 normal, vec3 viewVector, float roughness, float fresnel)\n{\n    vec3 reflectionVector = reflect(-viewVector, normal);\n    vec3 radiance = vec3(0.0);\n    float NoV = saturate(dot(normal, viewVector));\n\n    vec3 sampleVector = reflectionVector;\n\n    // Calculate the half vector\n    vec3 halfVector = normalize(sampleVector + viewVector);\n    float cosT = saturatedDot(reflectionVector, normal);\n    float sinT = sqrt( 1.0 - cosT * cosT);\n\n    // Calculate fresnel\n    // vec3 fresnel = Fresnel_Schlick( saturate(dot( halfVector, viewVector ) ), F0 );\n    // Geometry term\n    float geometry = GGX_PartialGeometryTerm(viewVector, normal, halfVector, clamp(roughness, 0.01, 1.0)) * GGX_PartialGeometryTerm(reflectionVector, normal, halfVector, clamp(roughness, 0.01, 1.0));\n\n    // Calculate the Cook-Torrance denominator\n    float denominator = clamp( 4.0 * (NoV * saturate(dot(halfVector, normal)) + 0.05), 0.0, 1.0 );\n    // kS += fresnel;\n\n    // Accumulate the radiance\n    vec3 envColor = sampleEnvMap(reflectionVector, roughness);\n    radiance += envColor * geometry * fresnel * sinT / denominator;\n    //radiance += envColor * fresnel; // Removing "geometry" for now until we construct a better geometric shading term\n\n    return radiance;        \n}\n'),Vi.setShaderModule("PBRSurfaceRadiance.glsl","\n\nstruct MaterialParams {\n    vec3 baseColor;\n    float metallic;\n    float roughness;\n    float reflectance;\n};\n\nvec4 pbrSpecularReflectance(in MaterialParams materialParams, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    \n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    vec3 specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion); \n\n    return vec4(specularReflectance, schlickFresnel);\n}\n\n\nvec3 pbrSurfaceRadiance(in MaterialParams materialParams, vec3 irradiance, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    vec3 specularReflectance;\n\n    // -------------------------- Diffuse Reflectance --------------------------\n\n    vec3 diffuseReflectance = materialParams.baseColor * irradiance;\n\n    // From the Disney dielectric BRDF    \n    // Need to check if this is useful for us but the implementation works based on their paper\n    //diffuseReflectance = (diffuseReflectance / PI); // << [PT 18-08-2018] What did this line do??? (makes everything 3.1x darker.)\n    // diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 2.5, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n    diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 1.0, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n\n\n    // -------------------------- Color at normal incidence --------------------------\n    \n    // Need to use 'Reflectance' here instead of 'ior'\n    //vec3 F0 = vec3(abs((1.0 - ior) / (1.0 + ior)));    \n    //F0 = F0 * F0;\n    //F0 = mix(F0, materialParams.baseColor, materialParams.metallic);      \n\n\n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion);  \n      \n\n    // -------------------------- Metallic --------------------------\n    // We need to do few things given a higher > 0 metallic value\n    //      1. tint specular reflectance by the albedo color (not at grazing angles)\n    //      2. almost elliminate all diffuse reflectance (in reality metals have some diffuse due to layering (i.e. dust, prints, etc.))\n    //      3. set \"specular\" artistic value to metallic range (0.6 - 0.85)\n\n    specularReflectance = mix(specularReflectance, specularReflectance * materialParams.baseColor, materialParams.metallic);\n    diffuseReflectance = mix(diffuseReflectance, vec3(0.0,0.0,0.0), materialParams.metallic); // Leaveing at pure black for now but always need some %3 diffuse left for imperfection of pulished pure metal\n    // Would be best to compute reflectace internally and set here to 0.6-0.85 for metals\n    \n\n    // -------------------------- Final color --------------------------\n    // Energy conservation already taken into account in both the diffuse and specular reflectance\n    vec3 radiance = diffuseReflectance + specularReflectance;\n\n    // radiance = vec4( kd * diffuse + /*ks */ specular, 1);\n    return radiance;\n}\n");class Xa extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("LayeredCarPaintShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n    // v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     v_clusterID = clusterIDs;\n// #endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("LayeredCarPaintShader.fragmentShader",'\n#ifndef ENABLE_ES3\n    #extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nuniform sampler2D lightmap;\nuniform vec2 lightmapSize;\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n<%include file="debugColors.glsl"/>\nuniform bool debugLightmapTexelSize;\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform color MidColorTint;\nuniform float MidColorTintReflectance;\n\nuniform float MicroflakePerturbation;\nuniform sampler2D FlakesNormalTex;\nuniform float FlakesScale;\n\n#ifdef ENABLE_SPECULAR\n\nuniform float BaseRoughness;\nuniform float BaseMetallic;\nuniform float BaseReflectance;\nuniform float GlossRoughness;\nuniform float GlossMetallic;\nuniform float GlossReflectance;\n\n#endif\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#endif\n\n// Followup: Normal Mapping Without Precomputed Tangents\n// http://www.thetenthplanet.de/archives/1180\nmat3 cotangent_frame( vec3 normal, vec3 position, vec2 uv )\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( position );\n    vec3 dp2 = dFdy( position );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n \n    // solve the linear system\n    vec3 dp2perp = cross( dp2, normal );\n    vec3 dp1perp = cross( normal, dp1 );\n    vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 bitangent = dp2perp * duv1.y + dp1perp * duv2.y;\n \n    // construct a scale-invariant frame \n    float invmax = inversesqrt( max( dot(tangent,tangent), dot(bitangent,bitangent) ) );\n    return mat3( tangent * invmax, bitangent * invmax, normal );\n}\n\n#define WITH_NORMALMAP_UNSIGNED 1\n\nvec3 sampleNormalMap( sampler2D normalMap, vec2 texcoord )\n{\n    // assume normal, the interpolated vertex normal and \n    // viewVec, the view vector (vertex to eye)\n    vec3 map = texture2D( normalMap, texcoord ).xyz;\n#ifdef WITH_NORMALMAP_UNSIGNED\n    map = map * 255./127. - 128./127.;\n#endif\n#ifdef WITH_NORMALMAP_2CHANNEL\n    map.z = sqrt( 1. - dot( map.xy, map.xy ) );\n#endif\n#ifdef WITH_NORMALMAP_GREEN_UP\n    map.y = -map.y;\n#endif\n    return map;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n#else\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n#endif\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = BaseRoughness;\n    material.metallic       = BaseMetallic;\n    material.reflectance    = BaseReflectance;\n#endif\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n \n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    if(debugLightmapTexelSize)\n    {\n        vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n        //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n        float total = floor(coord_texelSpace.x) +\n                      floor(coord_texelSpace.y);\n                      \n        vec3 clustercolor = getDebugColor(v_clusterID);\n\n        if(mod(total,2.0)==0.0){\n            material.baseColor = clustercolor;\n            irradiance = vec3(1.0);\n        }\n        else{\n            material.baseColor = material.baseColor * 1.5;\n        }\n    }\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    vec3 surfacePos = -v_viewPos;\n\n    // The vector from the camera to the surface point.\n    vec3 viewVector = mat3(cameraMatrix) * normalize(v_viewPos);\n    vec3 viewDir = normalize(viewVector);\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n\n    float NdotV = dot(normal, viewDir);\n    if(NdotV < 0.0){\n        normal = -normal;\n        NdotV = dot(normal, viewDir);\n    }\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    \n    // Mix the base color to give a multi-layered paint look.\n    material.baseColor      = mix(material.baseColor, material.baseColor * MidColorTint.rgb, (1.0-NdotV));\n\n    mat3 TBN = cotangent_frame( normal, surfacePos, v_lightmapCoord );\n    vec3 flakesNormal = TBN * -sampleNormalMap( FlakesNormalTex, (v_lightmapCoord * lightmapSize) / FlakesScale );\n    flakesNormal = normalize(mix(normal, flakesNormal, MicroflakePerturbation));\n\n    vec3 baseRadiance = pbrSurfaceRadiance(material, irradiance, flakesNormal, viewVector);\n\n    material.roughness      = GlossRoughness;\n    material.reflectance    = GlossReflectance;\n    vec4 gloss = pbrSpecularReflectance(material, normal, viewVector);\n    vec3 radiance = mix(baseRadiance, gloss.rgb, gloss.a);\n    //vec3 radiance = baseRadiance;\n\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(radiance, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();e.push({name:"BaseColor",defaultValue:new Z(1,0,0)}),e.push({name:"BaseMetallic",defaultValue:0}),e.push({name:"BaseRoughness",defaultValue:.35}),e.push({name:"BaseReflectance",defaultValue:.03}),e.push({name:"MidColorTint",defaultValue:new Z(1,1,1)}),e.push({name:"MidColorTintReflectance",defaultValue:.03}),e.push({name:"GlossMetallic",defaultValue:0}),e.push({name:"GlossRoughness",defaultValue:.35}),e.push({name:"GlossReflectance",defaultValue:.03});const t=new Qe("flakes","ZeaEngine/FlakesNormalMap.png");return t.wrap="REPEAT",t.mipMapped=!0,e.push({name:"FlakesNormal",defaultValue:t}),e.push({name:"FlakesScale",defaultValue:.1}),e.push({name:"MicroflakePerturbation",defaultValue:.1}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}z.registerClass("LayeredCarPaintShader",Xa);class Va extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("FlatShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 ProjectionCenter;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\n// varying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position     = modelViewProjectionMatrix * pos;\n\n    vec4 worldPos = modelMatrix * pos;\n    v_worldDir = worldPos.xyz - ProjectionCenter;\n\n    v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n}\n')}}z.registerClass("ShadowCatcherShader",class extends Va{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("ShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\nuniform float ShadowMultiplier;\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    vec4 env = envMap;\n    if(envMapTexType != 0) {\n        vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n        env = texture2D(envMapTex, texCoord);\n    }\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb * ShadowMultiplier;\n    float irradianceLum = clamp(luminanceFromRGB(irradiance), 0.0, 1.0);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(env.rgb/env.a, 1.0);\n    fragColor.rgb = mix(fragColor.rgb * irradiance, fragColor.rgb, irradianceLum);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"ProjectionCenter",defaultValue:new g(0,0,1.7)}),e.push({name:"ShadowMultiplier",defaultValue:1}),e}static isTransparent(){return!0}bind(e,t){return"ADD"==e.pass&&super.bind(e,t)}}),z.registerClass("FloatingShadowCatcherShader",class extends Va{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FloatingShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\n\nuniform float ShadowMultiplier;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    \n    float shadow = luminanceFromRGB(texture2D(lightmap, v_lightmapCoord).rgb) * ShadowMultiplier;\n\n    // This material works by multiplying the image buffer values by the luminance in the lightmap.\n    fragColor.rgb = vec3(pow(shadow, 1.0/ShadowMultiplier));\n    fragColor.a = 1.0;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}bind(e,t){return"MULTIPLY"==e.pass&&super.bind(e,t)}static isTransparent(){return!0}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"ShadowMultiplier",defaultValue:1}),e}});class Ia extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("LinesShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("LinesShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = BaseColor;\n    fragColor.a *= Opacity;\n    \n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}static isTransparent(){return!0}bind(e,t){return"ADD"==e.pass&&super.bind(e,t)}}z.registerClass("LinesShader",Ia);class Ra extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("PointsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  gl_Position = modelViewProjectionMatrix * vec4(positions, 1.);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("PointsShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = BaseColor;\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n")}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e}}z.registerClass("PointsShader",Ra);class xa extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("FatPointsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform float PointSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  vec2 quadPointPos = getQuadVertexPositionFromID();\n  v_texCoord = quadPointPos + 0.5;\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.);\n\n  viewPos += vec4(vec3(quadPointPos, 0.0) * PointSize, 0.);\n\n  // Generate a quad which is 0.5 * PointSize closer towards\n  // us. This allows points to be visualized even if snug on \n  // a surface. (else they get fully clipped)\n  viewPos.z += 0.5 * PointSize;\n\n  v_drawItemId = float(getDrawItemId());\n  v_viewPos = -viewPos.xyz;\n  \n  gl_Position = projectionMatrix * viewPos;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FatPointsShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n\nuniform color BaseColor;\nuniform float Rounded;\nuniform float BorderWidth;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  if(dist > 0.5 - (BorderWidth * 0.5))\n    fragColor = vec4(0.,0.,0.,1.);\n  else {\n    // Modulate the lighting using the texture coord so the point looks round.\n    float NdotV = cos(dist * PI);\n\n    fragColor = BaseColor * mix(1.0, NdotV, Rounded);\n  }\n  \n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}bind(e){return!!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"PointSize",defaultValue:.05}),e.push({name:"Rounded",defaultValue:1}),e.push({name:"BorderWidth",defaultValue:.2}),e}static getGeomDataShaderName(){return"FatPointsGeomDataShader"}static getSelectedShaderName(){return"FatPointsSelectedShader"}}class Sa extends xa{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FatPointsGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n    \n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  }\n  else {\n    ///////////////////////////////////\n    // UInt8 buffer\n    fragColor.r = (mod(v_drawItemId, 256.) + 0.5) / 255.;\n    fragColor.g = (floor(v_drawItemId / 256.) + 0.5) / 255.;\n\n    // encode the dist as a 16 bit float\n    vec2 float16bits = encode16BitFloatInto2xUInt8(viewDist);\n    fragColor.b = float16bits.x;\n    fragColor.a = float16bits.y;\n  }\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Wa extends xa{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("FatPointsSelectedShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  \n  int drawItemId = int(v_drawItemId + 0.5);\n  fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}z.registerClass("FatPointsShader",xa),z.registerClass("FatPointsGeomDataShader",Sa),z.registerClass("FatPointsSelectedShader",Wa),Vi.setShaderModule("pragmatic-pbr/exposure.glsl","\n\n/*\n* Get an exposure using the Saturation-based Speed method.\n*/\nfloat getSaturationBasedExposure(float aperture,\n                                 float shutterSpeed,\n                                 float iso)\n{\n    float l_max = (7800.0 / 65.0) * sqrt(aperture) / (iso * shutterSpeed);\n    return 1.0 / l_max;\n}\n\n//White balance middle grey we are targetting for a good scene exposure\n//https://en.wikipedia.org/wiki/Middle_gray\nconst float MIDDLE_GREY = 0.18;\n\n/*\n* Get an exposure using the Standard Output Sensitivity method.\n* Accepts an additional parameter of the target middle grey.\n*/\nfloat getStandardOutputBasedExposure(float aperture,\n                                     float shutterSpeed,\n                                     float iso)\n{\n    //https://placeholderart.wordpress.com/2014/11/21/implementing-a-physically-based-camera-manual-exposure/\n    //https://en.wikipedia.org/wiki/Film_speed#Standard_output_sensitivity_.28SOS.29\n    //photometric exposure magic\n    //represents the properties of lens\n    float q = 0.65;\n\n    //float l_avg = (1000.0f / 65.0f) * sqrt(aperture) / (iso * shutterSpeed);\n    float l_avg = (1.0 / q) * sqrt(aperture) / (iso * shutterSpeed);\n    //float l_avg = sqrt(aperture) / (iso * shutterSpeed);\n    return MIDDLE_GREY / l_avg;\n}\n\n"),Vi.setShaderModule("pragmatic-pbr/tonemap-filmic.glsl","\n\n//Based on Filmic Tonemapping Operators http://filmicgames.com/archives/75\nvec3 tonemapFilmic(vec3 color) {\n    vec3 x = max(vec3(0.0), color - 0.004);\n    return (x * (6.2 * x + 0.5)) / (x * (6.2 * x + 1.7) + 0.06);\n}\n\n"),Vi.setShaderModule("mattdesl/fxaa-texcoords.glsl","\n//To save 9 dependent texture reads, you can compute\n//these in the vertex shader and use the optimized\n//frag.glsl function in your frag shader. \n\n//This is best suited for mobile devices, like iOS.\n\nvoid texcoords(vec2 fragCoord, vec2 resolution,\n            out vec2 v_rgbNW, out vec2 v_rgbNE,\n            out vec2 v_rgbSW, out vec2 v_rgbSE,\n            out vec2 v_rgbM) {\n    vec2 inverseVP = 1.0 / resolution.xy;\n    v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\n    v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\n    v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\n    v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\n    v_rgbM = vec2(fragCoord * inverseVP);\n}\n\n"),Vi.setShaderModule("mattdesl/fxaa.glsl",'\n\n/**\nBasic FXAA implementation based on the code on geeks3d.com with the\nmodification that the texture2DLod stuff was removed since it\'s\nunsupported by WebGL.\n--\nFrom:\nhttps://github.com/mitsuhiko/webgl-meincraft\nCopyright (c) 2011 by Armin Ronacher.\nSome rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are\nmet:\n    * Redistributions of source code must retain the above copyright\n      notice, this list of conditions and the following disclaimer.\n    * Redistributions in binary form must reproduce the above\n      copyright notice, this list of conditions and the following\n      disclaimer in the documentation and/or other materials provided\n      with the distribution.\n    * The names of the contributors may not be used to endorse or\n      promote products derived from this software without specific\n      prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n*/\n\n#ifndef FXAA_REDUCE_MIN\n    #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n    #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n    #define FXAA_SPAN_MAX     8.0\n#endif\n\n//optimized version for mobile, where dependent \n//texture reads can be a bottleneck\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n    vec4 color;\n    mediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n    vec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(tex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n    \n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n    \n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    \n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n              dir * rcpDirMin)) * inverseVP;\n    \n    vec3 rgbA = 0.5 * (\n        texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\n'),Vi.setShaderModule("mattdesl/fxaa-apply.glsl",'\n\n<%include file="mattdesl/fxaa.glsl"/>\n\nvec4 apply(sampler2D tex, vec2 fragCoord, vec2 resolution) {\n    mediump vec2 v_rgbNW;\n    mediump vec2 v_rgbNE;\n    mediump vec2 v_rgbSW;\n    mediump vec2 v_rgbSE;\n    mediump vec2 v_rgbM;\n\n    //compute the texture coords\n    texcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    \n    //compute FXAA\n    return fxaa(tex, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n');class La extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("SimpleSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData  = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n    // v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("SimpleSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\nuniform sampler2D OpacityTex;\nuniform int OpacityTexType;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) \n    {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor      = BaseColor;\n    float opacity       = baseColor.a * Opacity;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n    float opacity       = baseColor.a * getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, v_textureCoord);\n#endif\n\n    // Hacky simple irradiance. \n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * v_viewNormal);\n    float ndotv = dot(normal, viewVector);\n    if(ndotv < 0.0){\n        normal = -normal;\n        ndotv = dot(normal, viewVector);\n\n        // Note: these 2 lines can be used to debug inverted meshes.\n        //baseColor = vec4(1.0, 0.0, 0.0, 1.0);\n        //ndotv = 1.0;\n    }\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = vec4(ndotv * baseColor.rgb, opacity);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}z.registerClass("SimpleSurfaceShader",La),Vi.setShaderModule("cutaways.glsl","\n\n\nconst int GEOMITEM_FLAG_CUTAWAY =  1; // 1<<0;\n\n#define RAY_EPS 0.0000001\nstruct Ray {\n    vec3 start;\n    vec3 dir;\n};\n\nfloat intersectRayPlane(Ray ray, Ray plane) {\n    vec3 w = ray.start - plane.start;\n    float D = dot(plane.dir, ray.dir);\n    float N = dot(-plane.dir, w);\n\n    if (abs(D) < RAY_EPS) {\n        // segment is parallel to plane\n        if (N == 0.0)\n            return -1.0; // segment lies in plane\n        else\n            return -1.0; // no intersection\n    }\n    // they are not parallel\n    // compute intersect param\n    float sI = N / D;\n    if (sI < -RAY_EPS) {\n        return -1.0; // no intersection\n    }\n    return sI;\n}\n\n\nbool cutaway(vec3 worldPos, vec3 planeNormal, float planeDist) {\n\n    vec3 planePos = planeNormal * planeDist;\n    vec3 planeDir = worldPos + planePos;\n    float planeOffset = dot(planeDir, planeNormal);\n    if(planeOffset > 0.0){\n        return true;\n    }\n    return  false;\n}\n");class va extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("StandardSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n// attribute float clusterIDs;\n// uniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n\n    // v_lightmapCoord = (lightmapCoords + v_geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + v_geomItemData.zw), 0., 1.);\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    v_clusterID = clusterIDs;\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("StandardSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n// uniform sampler2D lightmap;\n// uniform bool lightmapConnected;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// <%include file="debugColors.glsl"/>\n// uniform vec2 lightmapSize;\n// uniform bool debugLightmapTexelSize;\n// #endif\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float EmissiveStrength;\n\n\n#ifdef ENABLE_SPECULAR\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#ifdef ENABLE_SPECULAR\nuniform sampler2D RoughnessTex;\nuniform int RoughnessTexType;\n\nuniform sampler2D MetallicTex;\nuniform int MetallicTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform int ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform int NormalTexType;\n// uniform float NormalScale;\n#endif\n\nuniform sampler2D EmissiveStrengthTex;\nuniform int EmissiveStrengthTexType;\n\n\n#endif\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.BaseColor     = BaseColor.rgb;\n    float emission         = EmissiveStrength;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = Roughness;\n    material.metallic      = Metallic;\n    material.reflectance   = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord       = v_worldPos.xz * 0.2;\n    vec2 texCoord          = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor     = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic      = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance   = getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n#endif\n    float emission         = getLuminanceParamValue(EmissiveStrength, EmissiveStrengthTex, EmissiveStrengthTexType, texCoord);\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef ENABLE_TEXTURES\n#ifdef ENABLE_SPECULAR\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec3 irradiance;\n    // if(lightmapConnected){\n    //     irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n    // }\n    // else{\n#ifndef ENABLE_SPECULAR\n        irradiance = sampleEnvMap(normal, 1.0);\n#else\n        irradiance = vec3(dot(normal, viewVector));\n#endif\n        \n    // }\n\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     if(debugLightmapTexelSize)\n//     {\n//         vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n//         //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n//         float total = floor(coord_texelSpace.x) +\n//                       floor(coord_texelSpace.y);\n                      \n//         vec3 clustercolor = getDebugColor(v_clusterID);\n\n//         material.metallic = 0.0;\n//         material.reflectance = 0.0;\n//         if(mod(total,2.0)==0.0){\n//             material.baseColor = clustercolor;\n//             irradiance = vec3(1.0);\n//         }\n//         else{\n//             material.baseColor = material.baseColor * 1.5;\n//         }\n//     }\n// #endif\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    vec3 radiance = pbrSurfaceRadiance(material, irradiance, normal, viewVector);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    // fragColor = vec4(material.baseColor, 1.0);\n    // fragColor = vec4(material.baseColor * irradiance, 1.0);\n    fragColor = vec4(radiance + (emission * material.baseColor), 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"Metallic",defaultValue:0,range:[0,1]}),e.push({name:"Roughness",defaultValue:.85,range:[0,1]}),e.push({name:"Reflectance",defaultValue:.1,range:[0,1]}),e.push({name:"EmissiveStrength",defaultValue:0,range:[0,1]}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}z.registerClass("StandardSurfaceShader",va),Vi.setShaderModule("GLSLBits.glsl",'\n    \n/////////////////////////////////////////////////////////////////\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\nfloat shift_right(float v, float amt) {\n  v = floor(v) + 0.5;\n  return floor(v / exp2(amt));\n}\nfloat shift_left(float v, float amt) {\n  return floor(v * exp2(amt) + 0.5);\n}\n\nfloat mask_last(float v, float bits) {\n  return mod(v, shift_left(1.0, bits));\n}\nfloat extract_bits(float num, float from, float to) {\n  from = floor(from + 0.5);\n  to = floor(to + 0.5);\n  return mask_last(shift_right(num, from), to - from);\n}\n\n/////////////////////////////////////////////////////////////////\n// https://stackoverflow.com/questions/18453302/how-do-you-pack-one-32bit-int-into-4-8bit-ints-in-glsl-webgl\n\nconst vec4 bitEnc = vec4(1.,255.,65025.,16581375.);\nconst vec4 bitDec = 1./bitEnc;\nvec4 EncodeFloatRGBA (float v) {\n    vec4 enc = bitEnc * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec2(1./255., 0.).xxxy;\n    return enc;\n}\nfloat DecodeFloatRGBA (vec4 v) {\n    return dot(v, bitDec);\n}\n\n\n\n/////////////////////////////////////////////////////////////////\n// https://gist.github.com/Flexi23/1713774\n// \nvec2 encode16BitFloatInto2xUInt8(float v){\n    vec2 c = vec2(0.);\n\n    int signum = (v >= 0.) ? 128 : 0;\n    v = abs(v);\n    int exponent = 15;\n    float limit = 1024.; // considering the bias from 2^-5 to 2^10 (==1024)\n    for(int exp = 15; exp > 0; exp--){\n        if( v < limit){\n            limit /= 2.;\n            exponent--;\n        }\n    }\n\n    float rest;\n    if(exponent == 0){\n        rest = v / limit / 2.;      // "subnormalize" implicite preceding 0. \n    }else{\n        rest = (v - limit)/limit;   // normalize accordingly to implicite preceding 1.\n    }\n\n    int mantissa = int(rest * 2048.);   // 2048 = 2^11 for the (split) 11 bit mantissa\n    int msb = mantissa / 256;           // the most significant 3 bits go into the lower part of the first byte\n    int lsb = mantissa - msb * 256;     // there go the other 8 bit of the lower significance\n\n    c.x = float(signum + exponent * 8 + msb) / 255.;    // color normalization for texture2D\n    c.y = float(lsb) / 255.;\n\n    if(v >= 2048.){\n        c.y = 1.;\n    }\n\n    return c;\n}\n\nfloat decode16BitFloatFrom2xUInt8(vec2 c){\n    float v = 0.;\n\n    int ix = int(c.x*255.); // 1st byte: 1 bit signum, 4 bits exponent, 3 bits mantissa (MSB)\n    int iy = int(c.y*255.); // 2nd byte: 8 bit mantissa (LSB)\n\n    int s = (c.x >= 0.5) ? 1 : -1;\n    ix = (s > 0) ? ix - 128 : ix;   // remove the signum bit from exponent\n    int iexp = ix / 8;              // cut off the last 3 bits of the mantissa to select the 4 exponent bits\n    int msb = ix - iexp * 8;        // subtract the exponent bits to select the 3 most significant bits of the mantissa\n\n    int norm = (iexp == 0) ? 0 : 2048;          // distinguish between normalized and subnormalized numbers\n    int mantissa = norm + msb * 256 + iy;       // implicite preceding 1 or 0 added here\n    norm = (iexp == 0) ? 1 : 0;                 // normalization toggle\n    float exponent = pow( 2., float(iexp + norm) - 16.); // -5 for the the exponent bias from 2^-5 to 2^10 plus another -11 for the normalized 12 bit mantissa \n    v = float( s * mantissa ) * exponent;\n\n    return v;\n}\n\n\n// TODO : Encoding Float32 to 4x UInt8\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\n// http://ultraist.hatenablog.com/entry/20110608/1307539319\n\n');class Ta extends Ri{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("StandardSurfaceGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  vec4 viewPos = modelViewMatrix * pos;\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n  \n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("StandardSurfaceGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  int drawItemId = int(v_drawItemId + 0.5);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n  int flags = int(v_geomItemData.r + 0.5);\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n      else if(!gl_FrontFacing){\n          fragColor = cutColor;\n  #ifndef ENABLE_ES3\n          gl_FragColor = fragColor;\n  #endif\n          return;\n      }\n  }\n\n    float dist = length(v_viewPos);\n\n    if(floatGeomBuffer != 0) {\n        fragColor.r = float(passId); \n        fragColor.g = float(v_drawItemID);\n        fragColor.b = 0.0;// TODO: store poly-id or something.\n        fragColor.a = dist;\n    }\n    else {\n        ///////////////////////////////////\n        // UInt8 buffer\n        fragColor.r = (mod(v_drawItemID, 256.) + 0.5) / 255.;\n        fragColor.g = (floor(v_drawItemID / 256.) + 0.5) / 255.;\n\n\n        // encode the dist as a 16 bit float\n        vec2 float16bits = encode16BitFloatInto2xUInt8(dist);\n        fragColor.b = float16bits.x;\n        fragColor.a = float16bits.y;\n    }\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}z.registerClass("StandardSurfaceGeomDataShader",Ta);class Ma extends Ri{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("StandardSurfaceSelectedGeomsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nvarying float v_drawItemId;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n    gl_Position = projectionMatrix * viewPos;\n\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("StandardSurfaceSelectedGeomsShader.fragmentShader",'\nprecision highp float;\n\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    int drawItemId = int(v_drawItemId + 0.5);\n    fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}z.registerClass("StandardSurfaceSelectedGeomsShader",Ma);class Ca extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("HandleShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = viewPos.xyz;\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("HandleShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"maintainScreenSize",defaultValue:0}),e}static isOverlay(){return!0}static getGeomDataShaderName(){return"HandleGeomDataShader"}}z.registerClass("HandleShader",Ca);class Fa extends Ta{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("HandleGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n}\n')}}z.registerClass("HandleGeomDataShader",Fa);class wa extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("TransparentSurfaceShader.vertexShader",'\nprecision highp float;\n\n\nattribute vec3 positions;\nattribute vec3 normals;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("TransparentSurfaceShader.fragmentShader",'\nprecision highp float;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="GLSLUtils.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\nuniform float planeDist;\nuniform float planeAngle;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_SPECULAR\n<%include file="math/constants.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef __ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform bool BaseColorTexType;\n\nuniform sampler2D OpacityTex;\nuniform bool OpacityTexType;\n\nuniform sampler2D RoughnessTex;\nuniform bool RoughnessTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform bool ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform bool NormalTexType;\nuniform float NormalScale;\n\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef __ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n    float opacity           = Opacity;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = Roughness;\n    material.metallic       = Metallic;\n    material.reflectance    = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord        = v_worldPos.xz * 0.2;\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n    material.roughness      = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic       = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance    = Reflectance;//getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n\n    float opacity           = getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, texCoords);\n#endif\n\n#ifndef ENABLE_SPECULAR\n    gl_FragColor = vec4(material.baseColor.rgb, opacity);\n#else\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef __ENABLE_TEXTURES\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec4 specularReflectance = pbrSpecularReflectance(material, normal, viewVector);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(specularReflectance.rgb, mix(opacity, 1.0, specularReflectance.a));\n\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e.push({name:"Roughness",defaultValue:.85}),e.push({name:"Reflectance",defaultValue:1e-4}),e}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}static isTransparent(){return!0}bind(e,t){return"ADD"==e.pass&&super.bind(e,t)}}z.registerClass("TransparentSurfaceShader",wa);class Na extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("ScreenSpaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n\n    gl_Position = (modelMatrix * vec4(positions, 1.0));\n\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("ScreenSpaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static isOverlay(){return!0}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new Z(1,1,.5)}),e}static getGeomDataShaderName(){return null}static getSelectedShaderName(){return null}}z.registerClass("ScreenSpaceShader",Na);class Ya extends Ga{constructor(e){super(e),this.invisibleToGeomBuffer=!0}}z.registerClass("ToolIconShader",Ya);class Ka{constructor(e,t,i,a,s=null){this.gl=e,this.geomItem=t,this.glGeom=i,this.id=a,this.flags=s,this.visible=this.geomItem.getVisible(),this.culled=!1,this.lightmapName=t.getLightmapName(),this.updated=new M,this.visibilityChanged=new M,this.highlightChanged=t.highlightChanged,this.updateVisibility=this.updateVisibility.bind(this),this.updateVisibility=this.updateVisibility.bind(this),this.destroy=this.destroy.bind(this),e.floatTexturesSupported?this.updateXfo=e=>{this.updated.emit(0)}:this.updateXfo=e=>{this.updateGeomMatrix()},this.geomItem.geomXfoChanged.connect(this.updateXfo),this.geomItem.visibilityChanged.connect(this.updateVisibility),this.geomItem.cutAwayChanged.connect(()=>{this.updated.emit(0)}),this.highlightChangedId=this.geomItem.highlightChanged.connect(()=>{this.updated.emit(3)}),this.glGeom.updated.connect(()=>{this.updated.emit(1)});const n=this.geomItem.getLightmapCoordsOffset();this.geomData=[n.x,n.y,0,0]}getGeomItem(){return this.geomItem}getGLGeom(){return this.glGeom}getVisible(){return this.geomItem.getVisible()}getId(){return this.id}getFlags(){return this.flags}updateVisibility(){const e=this.geomItem.getVisible()&&!this.culled;this.visible!=e&&(this.visible=e,this.visibilityChanged.emit(e),this.updated.emit())}setCullState(e){this.culled=e,this.updateVisibility()}updateGeomMatrix(){this.modelMatrixArray=this.geomItem.getGeomMat4().asArray()}getGeomMatrixArray(){return this.modelMatrixArray}bind(e){const t=this.gl,i=e.unifs;if(!t.floatTexturesSupported){const e=i.modelMatrix;e&&t.uniformMatrix4fv(e.location,!1,this.modelMatrixArray);const a=i.drawItemData;a&&t.uniform4f(a.location,this.geomData)}const a=i.transformIndex;if(a&&t.uniform1i(a.location,this.id),e.lightmaps&&i.lightmap&&e.boundLightmap!=this.lightmapName){const a=e.lightmaps[this.lightmapName];a&&a.glimage.isLoaded()?(a.glimage.bindToUniform(e,i.lightmap),t.uniform2fv(i.lightmapSize.location,a.atlasSize.asArray()),i.lightmapConnected&&t.uniform1i(i.lightmapConnected.location,!0),e.boundLightmap=this.lightmapName):i.lightmapConnected&&t.uniform1i(i.lightmapConnected.location,!1)}return!0}destroy(){this.geomItem.visibilityChanged.disconnect(this.updateVisibility),this.geomItem.geomXfoChanged.disconnect(this.updateXfo),this.geomItem.highlightChanged.disconnectId(this.highlightChangedId)}}class za extends ca{constructor(){super(),this.__drawItems=[void 0],this.__drawItemsIndexFreeList=[],this.__dirtyItemIndices=[]}init(e,t){super.init(e,t),this.__renderer.registerPass(e=>{if(e instanceof Jt){if(e.getMetadata("glgeomItem"))return!1;{const t=t=>!!this.filterGeomItem(t)&&(null==e.getGeometry()?e.geomAssigned.connect(()=>{this.addGeomItem(t)}):this.addGeomItem(t),!0);return null==e.getMaterial()?(console.warn("Scene item :"+e.getPath()+" has no material"),!1):t(e)}}return!1},e=>!!(e instanceof Jt&&e.getMetadata("glgeomItem"))&&this.removeGeomItem(e))}filterGeomItem(e){return!0}addShader(e){return this.__renderer.getOrCreateShader(e.getShaderName())}constructShaders(e){let t,i;const a=this.__renderer.getOrCreateShader(e);return a.constructor.getGeomDataShaderName()&&(t=this.__renderer.getOrCreateShader(a.constructor.getGeomDataShaderName())),a.constructor.getSelectedShaderName()&&(i=this.__renderer.getOrCreateShader(a.constructor.getSelectedShaderName())),{glshader:a,glgeomdatashader:t,glselectedshader:i}}addMaterial(e){let t=e.getMetadata("glmaterial");if(t)return t;const i=this.__renderer.getOrCreateShader(e.getShaderName());return t=new Ni(this.__gl,e,i),t.updated.connect(()=>{this.__renderer.requestRedraw()}),e.setMetadata("glmaterial",t),t}addGeom(e){let t=e.getMetadata("glgeom");if(t)return t.addRef(this),t;const i=this.__gl;if(e instanceof Zt||e instanceof Vt)t=new Zi(i,e);else if(e instanceof ft||e instanceof Xt)t=new Gi(i,e);else{if(!(e instanceof _t||e instanceof yt))throw new Error("Unsupported geom type:"+e.constructor.name);t=new yi(i,e)}return e.setMetadata("glgeom",t),t.addRef(this),t}removeGeom(e){let t=e.getMetadata("glgeom");if(t)return t.removeRef(this),t}addGeomItem(e){const t=this.addGeom(e.getGeometry());let i;this.__drawItemsIndexFreeList.length>0?i=this.__drawItemsIndexFreeList.pop():(i=this.__drawItems.length,this.__drawItems.push(null)),this.__dirtyItemIndices.push(i);const a=this.__gl,s=new Ka(a,e,t,i,1);return e.setMetadata("glgeomItem",s),s.updated.connect(e=>{switch(e){case 0:if(-1!=this.__dirtyItemIndices.indexOf(i))return;this.__dirtyItemIndices.push(i);break;case 1:case 2:break;case 3:if(-1!=this.__dirtyItemIndices.indexOf(i))return;return this.__dirtyItemIndices.push(i),void this.__renderer.requestRedraw()}this.__renderer.drawItemChanged()}),this.__drawItems[i]=s,this.__renderer.requestRedraw(),e.setMetadata("glpass",this),s}removeGeomItem(e){if(e.getMetadata("glpass")!=this)return;const t=e.getMetadata("glgeomItem"),i=t.getId();return this.__drawItems[i]=null,this.__drawItemsIndexFreeList.push(i),this.__renderer.requestRedraw(),e.getMetadata("glpass"),e.deleteMetadata("glgeomItem"),t}removeGLGeom(e,t){const i=t.geomItemMappings.indexOf(e);t.geomItemMappings.splice(i,1)}getGeomItem(e){if(!(e>=this.__drawItems.length))return this.__drawItems[e];console.warn("Invalid Draw Item id:"+e+" NumItems:"+(this.__drawItems.length-1))}__populateDrawItemDataArray(e,t,i){const a=24*t;let s=0;e.isCutawayEnabled()&&(s|=1);const n=e.getLightmapCoordsOffset();_.createFromFloat32Buffer(i.buffer,a+0).set(s,0,n.x,n.y);const r=e.getGeomMat4(),l=_.createFromFloat32Buffer(i.buffer,a+4),o=_.createFromFloat32Buffer(i.buffer,a+8),d=_.createFromFloat32Buffer(i.buffer,a+12);l.set(r.xAxis.x,r.yAxis.x,r.zAxis.x,r.translation.x),o.set(r.xAxis.y,r.yAxis.y,r.zAxis.y,r.translation.y),d.set(r.xAxis.z,r.yAxis.z,r.zAxis.z,r.translation.z);const h=_.createFromFloat32Buffer(i.buffer,a+16);if(e.isHighlighted()){const t=e.getHighlight();h.set(t.r,t.g,t.b,t.a)}const c=_.createFromFloat32Buffer(i.buffer,a+20);if(e.isCutawayEnabled()){const t=e.getCutVector(),i=e.getCutDist();c.set(t.x,t.y,t.z,i)}}newItemsReadyForLoading(){return this.__dirtyItemIndices.length>0}uploadGeomItems(){const e=this.__gl;if(!e.floatTexturesSupported){const e=this.__dirtyItemIndices.length;for(let t=0;t<e;t++){const e=this.__drawItems[this.__dirtyItemIndices[t]];e&&e.updateGeomMatrix()}return void(this.__dirtyItemIndices=[])}let t=Math.round(Math.sqrt(6*this.__drawItems.length)+.5);t=Math.nextPow2(t),t%6!=0&&(t+=6-t%6),this.__drawItemsTexture?this.__drawItemsTexture.width!=t&&(this.__drawItemsTexture.resize(t,t),this.__dirtyItemIndices=Array(t*t/6).fill().map((e,t)=>t)):(this.__drawItemsTexture=new bi(e,{format:"RGBA",type:"FLOAT",width:t,height:t,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),e.bindTexture(e.TEXTURE_2D,this.__drawItemsTexture.glTex);const i=this.__drawItemsTexture.getTypeID();for(let a=0;a<this.__dirtyItemIndices.length;a++){const s=this.__dirtyItemIndices[a],n=Math.floor(6*s/t);let r=s+1;for(let e=a+1;e<this.__dirtyItemIndices.length;e++){const i=this.__dirtyItemIndices[e];if(Math.floor(6*i/t)!=n)break;if(i!=r)break;r++}const l=r-s,o=6*s%t,d=6*l,h=1,c=new Float32Array(24*l);for(let e=s;e<r;e++){const t=this.__drawItems[e];t&&this.__populateDrawItemDataArray(t.getGeomItem(),e-s,c)}if(i==e.FLOAT)this.__drawItemsTexture.populate(c,d,h,o,n,!1);else{const e=Math.convertFloat32ArrayToUInt16Array(c);this.__drawItemsTexture.populate(e,d,h,o,n,!1)}a+=l-1}this.__dirtyItemIndices=[]}finalize(){0!=this.__dirtyItemIndices.length&&this.uploadGeomItems()}bind(e){const t=this.__gl,i=e.unifs;return this.__drawItemsTexture&&i.instancesTexture&&(this.__drawItemsTexture.bindToUniform(e,i.instancesTexture),t.uniform1i(i.instancesTextureSize.location,this.__drawItemsTexture.width)),!0}bindShader(e,t){return!!t.bind(e)&&!!this.bind(e)}bindMaterial(e,t,i){return t.bind(e,i)}}class Ua{constructor(e,t){this.gl=e,this.glgeom=t,this.glgeomItems=[],this.glgeomItems_freeIndices=[],this.glgeomItemSignalIds=[],this.drawIdsArray=null,this.drawIdsBuffer=null,this.drawIdsBufferDirty=!0,this.highlightedIdsArray=null,this.highlightedIdsBuffer=null,this.highlightedIdsBufferDirty=!0,this.lightmapName=void 0,this.drawCountChanged=new M,this.visibleItems=[],this.highlightedItems=[]}getGLGeom(){return this.glgeom}getLightmapName(){return this.lightmapName}getDrawCount(){return this.visibleItems.length}addGeomItem(e){let t;this.glgeomItems_freeIndices.length>0?t=this.glgeomItems_freeIndices.pop():(t=this.glgeomItems.length,this.glgeomItems.push(null)),e.visible&&(this.visibleItems.push(t),this.drawCountChanged.emit(1)),e.getGeomItem().isHighlighted()&&(this.highlightedItems.push(t),this.highlightedIdsBufferDirty=!0),1==this.glgeomItems.length&&(this.lightmapName=e.getGeomItem().getLightmapName());const i={};i.sel=e.highlightChanged.connect(()=>{if(e.getGeomItem().isHighlighted()){if(-1!=this.highlightedItems.indexOf(t))return;this.highlightedItems.push(t)}else this.highlightedItems.splice(this.highlightedItems.indexOf(t),1);this.highlightedIdsBufferDirty=!0}),i.vis=e.visibilityChanged.connect(e=>{e?(this.visibleItems.push(t),this.drawCountChanged.emit(1)):(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.drawCountChanged.emit(-1)),this.drawIdsBufferDirty=!0}),this.glgeomItems[t]=e,this.glgeomItemSignalIds[t]=i,this.drawIdsBufferDirty=!0}removeGeomItem(e){const t=this.glgeomItems.indexOf(e),i=this.glgeomItemSignalIds[t];e.highlightChanged.disconnectId(i.sel),e.visibilityChanged.disconnectId(i.vis),this.glgeomItems[t]=null,this.glgeomItemSignalIds[t]=null,this.glgeomItems_freeIndices.push(t),e.visible&&(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.drawCountChanged.emit(-1)),e.getGeomItem().isHighlighted()&&this.highlightedItems.splice(this.highlightedItems.indexOf(t),1),this.drawIdsBufferDirty=!0,0==this.glgeomItems.length&&this.destroy()}updateDrawIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.drawIdsBuffer&&this.glgeomItems.length!=this.drawIdsArray.length&&(this.gl.deleteBuffer(this.drawIdsBuffer),this.drawIdsBuffer=null),this.drawIdsBuffer||(this.drawIdsArray=new Float32Array(this.glgeomItems.length),this.drawIdsBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer)),this.visibleItems.forEach((e,t)=>{this.drawIdsArray[t]=this.glgeomItems[e].getId()}),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.drawIdsArray,e.STATIC_DRAW),this.drawIdsBufferDirty=!1):this.drawIdsBufferDirty=!1}updateHighlightedIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.highlightedIdsBuffer&&this.glgeomItems.length!=this.highlightedIdsArray.length&&(this.gl.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null),(!this.highlightedIdsArray||this.highlightedItems.length>this.highlightedIdsArray.length)&&(this.highlightedIdsArray=new Float32Array(this.highlightedItems.length),this.highlightedIdsBuffer&&(e.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null)),this.highlightedItems.forEach((e,t)=>{this.highlightedIdsArray[t]=this.glgeomItems[e].getId()}),this.highlightedIdsBuffer||(this.highlightedIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.highlightedIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.highlightedIdsArray,e.STATIC_DRAW),this.highlightedIdsBufferDirty=!1):this.highlightedIdsBufferDirty=!1}draw(e){if(0==this.visibleItems.length)return;this.drawIdsBufferDirty&&this.updateDrawIDsBuffer();const t=this.gl,i=e.unifs;if(e.lightmaps&&i.lightmap&&e.boundLightmap!=this.lightmapName){const a=e.lightmaps[this.lightmapName];a&&a.glimage.isLoaded()?(a.glimage.bindToUniform(e,i.lightmap),t.uniform2fv(i.lightmapSize.location,a.atlasSize.asArray()),i.lightmapConnected&&t.uniform1i(i.lightmapConnected.location,!0),e.boundLightmap=this.lightmapName):i.lightmapConnected&&t.uniform1i(i.lightmapConnected.location,!1)}this.__bindAndRender(e,this.visibleItems,this.drawIdsBuffer)}drawHighlighted(e){0!=this.highlightedItems.length&&(this.highlightedIdsBufferDirty&&this.updateHighlightedIDsBuffer(),this.__bindAndRender(e,this.highlightedItems,this.highlightedIdsBuffer))}__bindAndRender(e,t,i){const a=this.gl,s=e.unifs;if(e.glgeom!=this.glgeom&&(this.glgeom.bind(e),e.glgeom=this.glgeom),a.floatTexturesSupported&&a.drawElementsInstanced&&e.supportsInstancing){a.uniform1i(e.unifs.instancedDraw.location,1);const n=e.attrs.instancedIds.location;a.enableVertexAttribArray(n),a.bindBuffer(a.ARRAY_BUFFER,i),a.vertexAttribPointer(n,1,a.FLOAT,!1,4,0),a.vertexAttribDivisor(n,1),e.bindViewports(s,()=>{this.glgeom.drawInstanced(t.length)})}else e.unifs.instancedDraw&&a.uniform1i(e.unifs.instancedDraw.location,0),t.forEach(t=>{this.glgeomItems[t].bind(e),e.bindViewports(s,()=>{this.glgeom.draw(e)})})}destroy(){}}class Pa{constructor(e){this.glshader=e.glshader,this.glgeomdatashader=e.glgeomdatashader,this.glselectedshader=e.glselectedshader,this.glmaterialGeomItemSets=[]}findMaterialGeomItemSets(e){for(const t of this.glmaterialGeomItemSets)if(t.glmaterial==e)return t}addMaterialGeomItemSets(e){this.glmaterialGeomItemSets.push(e)}removeMaterialGeomItemSets(e){const t=this.glmaterialGeomItemSets.indexOf(e);this.glmaterialGeomItemSets.splice(t,1)}getMaterialGeomItemSets(){return this.glmaterialGeomItemSets}}class Ea{constructor(e){this.glmaterial=e,this.geomItemSets=[],this.drawCount=0,this.visibleInGeomDataBuffer=e.getMaterial().visibleInGeomDataBuffer,this.__drawCountChanged=this.__drawCountChanged.bind(this)}getGLMaterial(){return this.glmaterial}__drawCountChanged(e){this.drawCount+=e}addGeomItemSet(e){-1==this.geomItemSets.indexOf(e)?(this.geomItemSets.push(e),this.drawCount+=e.drawCount,e.drawCountChanged.connect(this.__drawCountChanged)):console.warn("geomItemSet already added to GLMaterialGeomItemSets")}removeGeomItemSet(e){const t=this.geomItemSets.indexOf(e);this.geomItemSets.splice(t,1),e.drawCountChanged.disconnect(this.__drawCountChanged),e.destroy()}findGeomItemSet(e){for(const t of this.geomItemSets)if(t.getGLGeom()==e)return t;return null}getGeomItemSets(){return this.geomItemSets}}class Ja extends za{constructor(){super(),this.__glshadermaterials={}}init(e,t){super.init(e,t)}filterGeomItem(e){const t=e.getMaterial().getShaderClass();if(t){if(t.isTransparent())return!1;if(t.isOverlay())return!1;const i=e.getMaterial().getParameter("BaseColor");return!(i&&i.getValue().a<1)}return!1}addGeomItem(e){const t=e.getMaterial(),i=t.getShaderName(),a=this.constructShaders(i);a.glshader,a.glgeomdatashader,a.glselectedshader;const s=this.addMaterial(t),n=super.addGeomItem(e);let r=this.__glshadermaterials[i];r||(r=new Pa(a),this.__glshadermaterials[i]=r);let l=r.findMaterialGeomItemSets(s);l||(l=new Ea(s),r.addMaterialGeomItemSets(l));let o=l.findGeomItemSet(n.glGeom);return o||(o=new Ua(this.__gl,n.glGeom),l.addGeomItemSet(o)),e.setMetadata("geomItemSet",o),o.addGeomItem(n),!0}removeGeomItem(e){const t=super.removeGeomItem(e);if(!t)return!1;const i=e.getMetadata("geomItemSet");return i&&(i.removeGeomItem(t),e.deleteMetadata("geomItemSet")),!0}removeMaterial(e){const t=this.__glshadermaterials[e.hash];if(!t||t!=e.getMetadata("glshaderMaterials"))return void console.warn("Material not found in pass");const i=e.getMetadata("glmaterialGeomItemSets");t.removeMaterialGeomItemSets(i)}__traverseTreeAndDraw(e){for(const t in this.__glshadermaterials){const i=this.__glshadermaterials[t],a=i.glshader;if(this.bindShader(e,a)){const t=i.getMaterialGeomItemSets();for(const i of t)if(0!=i.drawCount&&this.bindMaterial(e,i.getGLMaterial(),!0)){const t=i.getGeomItemSets();for(const i of t)i.draw(e)}}a.unbind(e)}e.glgeom&&e.glgeom.unbind(e)}draw(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),this.__traverseTreeAndDraw(e)}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE);for(const t in this.__glshadermaterials){const i=this.__glshadermaterials[t];if(!i.glselectedshader)continue;if(!this.bindShader(e,i.glselectedshader))continue;const a=i.getMaterialGeomItemSets();for(const t of a){const i=t.getGeomItemSets();for(const t of i)t.drawHighlighted(e)}}e.glgeom&&e.glgeom.unbind(e)}getGeomItemAndDist(e){let t,i;this.__gl.floatGeomBuffer?(t=Math.round(e[1]),i=e[3]):(t=e[0]+(e[1]<<8),i=Math.decode16BitFloatFrom2xUInt8([e[2],e[3]]));const a=this.__drawItems[t];if(a)return{geomItem:a.getGeomItem(),dist:i}}drawGeomData(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0);for(const i in this.__glshadermaterials){const a=this.__glshadermaterials[i];if(!a.glgeomdatashader)continue;if(!this.bindShader(e,a.glgeomdatashader))continue;{const i=e.unifs.floatGeomBuffer;i&&t.uniform1i(i.location,t.floatGeomBuffer?1:0)}{const i=e.unifs.passId;i&&t.uniform1i(i.location,this.__passIndex)}const s=a.getMaterialGeomItemSets();for(const t of s)if(0!=t.drawCount&&t.visibleInGeomDataBuffer&&this.bindMaterial(e,t.getGLMaterial(),!1)){const i=t.getGeomItemSets();for(const t of i)t.draw(e)}}e.glgeom&&e.glgeom.unbind(e)}}ba.registerPass(Ja,ha.OPAQUE);class Ha extends za{constructor(){super()}init(e,t){super.init(e,t),this.transparentItems=[],this.freeList=[],this.visibleItems=[],this.prevSortCameraPos=new g(999,999,999),this.resort=!1}filterGeomItem(e){const t=e.getMaterial().getShaderClass();if(t){if(t.isTransparent())return!0;if(t.isOverlay())return!1;const i=e.getMaterial().getParameter("BaseColor");if(i&&i.getValue().a<.999)return!0}return!1}addGeomItem(e){const t=e.getMaterial(),i=t.getShaderName(),a=this.constructShaders(i),s=this.addMaterial(t),n=super.addGeomItem(e),r=e.visibilityChanged.connect(e=>{if(e)this.visibleItems.push(o);else{const e=this.visibleItems.indexOf(o);this.visibleItems.splice(e,1)}}),l=e.geomXfoChanged.connect(()=>{this.resort=!0}),o={geomItem:e,shaders:a,glmaterial:s,glgeomitem:n,visibilityChangedId:r,geomXfoChangedId:l};let d;d=this.freeList.length>0?this.freeList.pop():this.transparentItems.length,this.transparentItems[d]=o,e.setMetadata("itemIndex",d),e.getVisible()&&this.visibleItems.push(o),this.resort=!0}removeGeomItem(e){if(!super.removeGeomItem(e))return;const t=e.getMetadata("itemIndex"),i=this.transparentItems[t];this.transparentItems[t]=null,this.freeList.push(t);const a=this.visibleItems.indexOf(i);-1!=a&&this.visibleItems.splice(a,1)}sortItems(e){for(const t of this.visibleItems){const i=t.glgeomitem.geomItem.getGeomMat4();t.dist=i.translation.distanceTo(e)}this.visibleItems.sort((e,t)=>e.dist>t.dist?-1:e.dist<t.dist?1:0),this.prevSortCameraPos=e,this.resort=!1}_drawItem(e,t,i){if(i.currentglMaterial!=t.glmaterial&&(i.currentglMaterial=t.glmaterial,!i.currentglMaterial.bind(e)))return;const a=t.glgeomitem;if((i.currentglGeom==a.glGeom||(i.currentglGeom=a.glGeom,i.currentglGeom.bind(e)))&&a.bind(e)){if(e.unifs.instancedDraw){const t=this.__gl;t.uniform1i(e.unifs.instancedDraw.location,0),t.disableVertexAttribArray(e.attrs.instancedIds.location)}e.bindViewports(e.unifs,()=>{i.currentglGeom.draw(e)})}}_drawItems(e){const t={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const i of this.visibleItems){if(t.currentglShader!=i.shaders.glshader){if(!this.bindShader(e,i.shaders.glshader))continue;t.currentglShader=i.shaders.glshader}this._drawItem(e,i,t)}t.currentglGeom&&t.currentglGeom.unbind(e)}draw(e){if(0==this.visibleItems.length)return;this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl,i=e.viewXfo.tr;(this.resort||i.distanceTo(this.prevSortCameraPos)>.3)&&this.sortItems(i),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="MULTIPLY",t.blendFunc(t.DST_COLOR,t.ZERO),this._drawItems(e),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this._drawItems(e),t.disable(t.BLEND)}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE);const i={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const t of this.visibleItems){if(!t.geomItem.isHighlighted())continue;if(!t.shaders.glselectedshader)continue;const a=t.shaders;if(i.currentglShader!=a.glselectedshader){if(!this.bindShader(e,a.glselectedshader))continue;i.currentglShader=a.glselectedshader}this._drawItem(e,t,i)}i.currentglGeom&&i.currentglGeom.unbind(e)}getGeomItemAndDist(e){let t,i;this.__gl.floatGeomBuffer?(t=Math.round(e[1]),i=e[3]):(t=e[0]+(e[1]<<8),i=Math.decode16BitFloatFrom2xUInt8([e[2],e[3]]));const a=this.__drawItems[t];if(a)return{geomItem:a.getGeomItem(),dist:i}}drawGeomData(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0);const i={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const a of this.visibleItems){const s=a.shaders;if(i.currentglShader!=s.glgeomdatashader){if(!this.bindShader(e,s.glgeomdatashader))continue;i.currentglShader=s.glgeomdatashader}{const i=e.unifs.floatGeomBuffer;i&&t.uniform1i(i.location,t.floatGeomBuffer?1:0)}{const i=e.unifs.passId;i&&t.uniform1i(i.location,this.__passIndex)}this._drawItem(e,a,i)}i.currentglGeom&&i.currentglGeom.unbind(e)}}ba.registerPass(Ha,ha.TRANSPARENT);class ka extends ca{constructor(){super()}init(e,t){super.init(e,t),this.__billboards=[],this.__freeIndices=[],this.__drawCount=0,this.__threshold=0,this.__updateRequested=!1,this.__prevSortCameraPos=new g,this.__atlas=new Ei(this.__renderer.gl,"Billboards","RGBA","UNSIGNED_BYTE",[1,1,1,0]),this.__atlas.loaded.connect(this.updated.emit),this.__atlas.updated.connect(this.updated.emit),this.__renderer.registerPass(e=>e instanceof At&&(this.addBillboard(e),!0),e=>e instanceof At&&(this.removeBillboard(e),!0))}filterRenderTree(){}addBillboard(e){const t=e.getParameter("Image"),i=t.getValue();if(!i)return void t.valueChanged.connect(()=>this.addBillboard(e));let a;a=this.__freeIndices.length>0?this.__freeIndices.pop():this.__billboards.length;const s=this.__atlas.addSubImage(i);e.setMetadata("GLBillboardsPass_Index",a);const n=e.visibilityChanged.connect(()=>{e.getVisible()?(this.__drawCount++,this.__updateBillboard(a)):this.__drawCount--,this.__reqUpdateIndexArray()}),r=e.getParameter("GlobalXfo").valueChanged.connect(()=>{e.getVisible()&&(this.__updateBillboard(a),this.updated.emit())}),l=e.getParameter("Alpha").valueChanged.connect(()=>{e.getVisible()&&(this.__updateBillboard(a),this.updated.emit())});e.getVisible()&&this.__drawCount++,this.__billboards[a]={billboard:e,imageIndex:s,visibilityChangedId:n,xfoChangedId:r,alphaChangedId:l},this.indexArrayUpdateNeeded=!0,this.__requestUpdate()}removeBillboard(e){const t=e.getMetadata("GLBillboardsPass_Index");if(-1==t)return void console.warn("Billboard already removed.");const i=this.__billboards[t],a=i.billboard.getParameter("Image").getValue();this.__atlas.removeSubImage(a),e.visibilityChanged.disconnectId(i.visibilityChangedId),e.getParameter("GlobalXfo").valueChanged.disconnectId(i.xfoChangedId),e.getParameter("Alpha").valueChanged.disconnectId(i.alphaChangedId),this.__billboards[t]=null,this.__freeIndices.push(t),e.getVisible()&&this.__drawCount--,this.indexArrayUpdateNeeded=!0,this.__requestUpdate()}__populateBillboardDataArray(e,t,i){const a=e.billboard,s=a.getGlobalXfo().toMat4(),n=1/a.getParameter("PixelsPerMeter").getValue();let r=0;a.getParameter("AlignedToCamera").getValue()&&(r|=4);const l=a.getParameter("Alpha").getValue(),o=a.getParameter("Color").getValue(),d=5*t*4,h=_.createFromFloat32Buffer(i.buffer,d),c=_.createFromFloat32Buffer(i.buffer,d+4),m=_.createFromFloat32Buffer(i.buffer,d+8),u=_.createFromFloat32Buffer(i.buffer,d+12);h.set(s.xAxis.x,s.yAxis.x,s.zAxis.x,s.translation.x),c.set(s.xAxis.y,s.yAxis.y,s.zAxis.y,s.translation.y),m.set(s.xAxis.z,s.yAxis.z,s.zAxis.z,s.translation.z),u.set(n,r,e.imageIndex,l),_.createFromFloat32Buffer(i.buffer,d+16).set(o.r,o.g,o.b,o.a)}__requestUpdate(){this.__updateRequested||(this.__updateRequested=!0,setTimeout(()=>{this.__updateBillboards()},100))}__reqUpdateIndexArray(){this.indexArrayUpdateNeeded||(this.indexArrayUpdateNeeded=!0,this.updateIndexArrayId=setTimeout(()=>{this.indexArrayUpdateNeeded&&(this.__updateIndexArray(),this.updated.emit())},1))}__updateIndexArray(){const e=this.__gl;this.__indexArray&&this.__indexArray.length!=this.__drawCount&&(e.deleteBuffer(this.__instanceIdsBuffer),this.__instanceIdsBuffer=null),this.__indexArray=new Float32Array(this.__drawCount);let t=0;for(let e=0;e<this.__billboards.length;e++)this.__billboards[e]&&this.__billboards[e].billboard.getVisible()&&(this.__indexArray[t]=e,t++);this.__instanceIdsBuffer||(this.__instanceIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.__instanceIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.__indexArray,e.STATIC_DRAW),this.indexArrayUpdateNeeded=!1}__updateBillboards(){const e=()=>{this.indexArrayUpdateNeeded&&this.__updateIndexArray();const e=this.__gl;if(!this.__glshader){e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__glshader=new pa(e);const t=this.__glshader.compileForTarget("GLBillboardsPass",this.__renderer.getShaderPreproc());this.__shaderBinding=_i(e,t.attrs,e.__quadattrbuffers,e.__quadIndexBuffer)}if(this.__atlas.renderAtlas(),!e.floatTexturesSupported||!e.drawElementsInstanced)return this.__modelMatrixArray=[],this.__billboardDataArray=[],this.__tintColorArray=[],this.__indexArray.forEach(e=>{const t=this.__billboards[e],i=t.billboard,a=i.getGlobalXfo().toMat4(),s=1/i.getParameter("PixelsPerMeter").getValue();let n=0;i.getParameter("AlignedToCamera").getValue()&&(n|=4);const r=i.getParameter("Alpha").getValue(),l=i.getParameter("Color").getValue();this.__modelMatrixArray[e]=a.asArray(),this.__billboardDataArray[e]=[s,n,t.imageIndex,r],this.__tintColorArray[e]=[l.r,l.g,l.b,l.a]}),void(this.__updateRequested=!1);let t=Math.round(Math.sqrt(5*(this.__billboards.length-this.__freeIndices.length))+.5);t%5!=0&&(t+=5-t%5),this.__width=t,this.__drawItemsTexture?this.__drawItemsTexture.resize(t,t):(this.__drawItemsTexture=new bi(e,{format:"RGBA",type:"FLOAT",width:t,height:t,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),this.__indexArray.forEach(e=>{-1!=e&&this.__updateBillboard(e)}),this.__updateRequested=!1};this.__atlas.isLoaded()?e():this.__atlas.loaded.connect(e)}__updateBillboard(e){if(0==this.__drawCount||!this.__drawItemsTexture)return;const t=this.__billboards[e];if(!t.billboard.getVisible())return;const i=this.__gl,a=new Float32Array(20);this.__populateBillboardDataArray(t,0,a),i.bindTexture(i.TEXTURE_2D,this.__drawItemsTexture.glTex);const s=5*e%this.__width,n=Math.floor(5*e/this.__width),r=this.__drawItemsTexture.getType(),l=this.__drawItemsTexture.getFormat();if("FLOAT"==r)i.texSubImage2D(i.TEXTURE_2D,0,s,n,5,1,i[l],i[r],a);else{const e=Math.convertFloat32ArrayToUInt16Array(a);i.texSubImage2D(i.TEXTURE_2D,0,s,n,5,1,i[l],i[r],e)}}sort(e){for(const t of this.__billboards)t&&t.billboard.getVisible()&&(t.dist=t.billboard.getGlobalXfo().tr.distanceTo(e));this.__indexArray.sort((e,t)=>-1==e?1:-1==t||this.__billboards[e].dist>this.__billboards[t].dist?-1:this.__billboards[e].dist<this.__billboards[t].dist?1:0);const t=this.__gl;t.floatTexturesSupported&&this.__instanceIdsBuffer&&(t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.__indexArray,t.STATIC_DRAW))}draw(e){if(0==this.__drawCount||!this.__atlas.isReady()||this.__updateRequested)return;this.indexArrayUpdateNeeded&&this.__updateIndexArray();const t=this.__gl;t.disable(t.CULL_FACE),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const i=e.viewXfo.tr;if(i.distanceTo(this.__prevSortCameraPos)>this.__threshold)if(this.sort(i),this.__prevSortCameraPos=i.clone(),this.__drawCount>1){const e=this.__billboards[this.__indexArray[0]].billboard.getGlobalXfo().tr,t=this.__billboards[this.__indexArray[1]].billboard.getGlobalXfo().tr;this.__threshold=e.distanceTo(t)}else this.__threshold=9999;this.__glshader.bind(e),this.__shaderBinding.bind(e);const a=e.unifs;if(this.__atlas.bindToUniform(e,a.atlasBillboards),t.floatTexturesSupported&&t.drawElementsInstanced){this.__drawItemsTexture.bindToUniform(e,a.instancesTexture),t.uniform1i(a.instancesTextureSize.location,this.__width);{const i=e.attrs.instanceIds.location;t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.vertexAttribPointer(i,1,t.FLOAT,!1,4,0),t.vertexAttribDivisor(i,1)}e.bindViewports(a,()=>{t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__drawCount)})}else{const i=this.__indexArray.length;for(let s=0;s<i;s++)t.uniformMatrix4fv(a.modelMatrix.location,!1,this.__modelMatrixArray[s]),t.uniform4fv(a.billboardData.location,this.__billboardDataArray[s]),t.uniform4fv(a.tintColor.location,this.__tintColorArray[s]),t.uniform4fv(a.layoutData.location,this.__atlas.getLayoutData(this.__billboards[s].imageIndex)),e.bindViewports(a,()=>{t.drawQuad()})}t.disable(t.BLEND)}}ba.registerPass(ka,ha.TRANSPARENT);class Ba extends Ja{constructor(){super()}init(e,t){super.init(e,t)}filterGeomItem(e){if(e.isOverlay())return!0;const t=e.getMaterial().getShaderClass();return!(!t||!t.isOverlay())}draw(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.__traverseTreeAndDraw(e),t.disable(t.BLEND)}drawGeomData(e){const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),super.drawGeomData(e),t.disable(t.BLEND),t.enable(t.DEPTH_TEST)}}ba.registerPass(Ba,ha.OVERLAY);const Da=window.AudioContext||window.webkitAudioContext||!1;let Oa;Da?Oa=new Da:alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox");class Aa extends ca{constructor(){super(),this.__audioItems=[]}init(e,t){super.init(e,t),Oa&&this.__renderer.registerPass(e=>{if(e instanceof Pt)return e.audioSourceCreated.connect(t=>{this.addAudioSource(e,t,e)}),!0;if(e instanceof Jt){const t=e.getMaterial();if(t){const i=t.getParameter("BaseColor");if(i&&i.getImage&&i.getImage()){const t=i.getImage();t.loaded.connect(()=>{if(t.getAudioSource){const i=t.getAudioSource();(i instanceof HTMLMediaElement||i instanceof AudioBufferSourceNode)&&this.addAudioSource(e,i,t)}})}}return!1}},e=>{})}addAudioSource(e,t,i){if(t.addedToCollector)return;let a;a=t instanceof HTMLMediaElement?Oa.createMediaElementSource(t):t instanceof AudioBufferSourceNode?t:Oa.createMediaStreamSource(t);const s=Oa.createGain(),n=i.getParameter("Gain");var r,l;n&&(r=n,l=s.gain,r&&(l.setValueAtTime(r.getValue(),0),l.setValueAtTime(r.getValue(),5),r.valueChanged.connect(()=>{l.value=r.getValue()}))),a.connect(s);const o=i.getParameter("SpatializeAudio");if(o&&0==o.getValue())a.connect(Oa.destination);else{const t=Oa.createPanner();t.panningModel="HRTF",t.distanceModel="inverse",a.connect(t),t.connect(Oa.destination);const s=e=>{const a=i.getParameter(e);a&&(t[e]=a.getValue(),a.valueChanged.connect(()=>{t[e]=a.getValue()}))};s("coneInnerAngle"),s("coneOuterAngle"),s("coneOuterGain");const n=()=>{let i;i=e instanceof Jt?e.getGeomMat4():e.getGlobalXfo().toMat4();const a=i.translation;t.setPosition(a.x,a.y,a.z);const s=i.zAxis;t.setOrientation(s.x,s.y,s.z)};n(),e.globalXfoChanged.connect(e=>{n()})}t.addedToCollector=!0,this.__audioItems.push({treeItem:e,audioSource:t,parameterOwner:i}),this.updated.emit()}__updateListenerPosition(e){if(!Oa)return;const t=Oa.listener;t.setPosition(e.tr.x,e.tr.y,e.tr.z);const i=e.ori.getYaxis(),a=e.ori.getZaxis().negate();t.setOrientation(a.x,a.y,a.z,i.x,i.y,i.z)}draw(e){0!=this.__audioItems.length&&this.__updateListenerPosition(e.viewXfo)}}ba.registerPass(Aa,ha.OVERLAY),window&&(window.ZeaAudioaudioCtx=Oa);var Qa=Object.freeze({__proto__:null,create3DContext:ui,GLTexture2D:bi,GLMesh:Zi,GLLines:Gi,GLPoints:yi,GLMaterial:Ni,GLShader:Ri,GLFbo:Si,GLRenderTarget:Yi,GLRenderer:ba,GLBaseViewport:ta,GLViewport:ia,shaderLibrary:Vi,generateShaderGeomBinding:_i,BillboardShader:pa,ConvolverShader:Ji,DepthMapShader:class extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("DepthMapShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 lightViewMatrix;\nuniform mat4 lightProjectionMatrix;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n\nvoid main(void) {\n  mat4 modelViewMatrix = lightViewMatrix * modelMatrix;\n  v_viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = lightProjectionMatrix * v_viewPos;\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("DepthMapShader.fragmentShader","\n#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform float near;\nuniform float far;\n\nvarying vec3 v_viewPos;\n\nfloat linstep(float edge0, float edge1, float value){\n  return clamp((value-edge0)/(edge1-edge0), 0.0, 1.0);\n}\n\nvoid main(void) {\n  float depth = linstep(near, far, -v_viewPos.z);\n  //gl_FragColor = vec4(depth, depth, depth,  1.0);\n\n  float dx = dFdx(depth);\n  float dy = dFdy(depth);\n  gl_FragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n")}},EnvMapShader:Bi,BackgroundImageShader:Di,OctahedralEnvMapShader:Oi,LatLongEnvMapShader:Ai,SterioLatLongEnvMapShader:Qi,DualFishEyeEnvMapShader:class extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}},DualFishEyeToLatLongBackgroundShader:ji,EnvProjectionShader:ga,OctahedralEnvProjectionShader:_a,LatLongEnvProjectionShader:fa,FatLinesShader:Za,FlatSurfaceShader:Ga,FlatAlphaSurfaceShader:ya,LayeredCarPaintShader:Xa,LinesShader:Ia,NormalsShader:class extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("NormalsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\ninstancedattribute vec3 normals;\nattribute vec2 vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float normalLength;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\n/* VS Outputs */\nvarying float v_weight;\n\nvoid main(void) {\n  mat4 modelMatrix = getModelMatrix(transformIndex);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  if(vertexIDs.x == 0.0){\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n    v_weight = 1.0;\n  }\n  else{\n    gl_Position = modelViewProjectionMatrix * vec4(positions+(normals*normalLength), 1.0);\n    v_weight = 0.0;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("NormalsShader.fragmentShader","\nprecision highp float;\n\nuniform color normalColor;\n\n/* VS Outputs */\nvarying float v_weight;\n\n\nvoid main(void) {\n  gl_FragColor = normalColor;\n  gl_FragColor.a = v_weight;\n}\n")}},PointsShader:Ra,FatPointsShader:xa,FatPointsGeomDataShader:Sa,FatPointsSelectedShader:Wa,PostProcessing:class extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("PostProcessing.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n<%include file="mattdesl/fxaa-texcoords.glsl"/>\n\nuniform vec2 textureSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n\n    vec2 fragCoord = v_texCoord * textureSize;\n    texcoords(fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("PostProcessing.fragmentShader",'\nprecision highp float;\n\n<%include file="pragmatic-pbr/exposure.glsl"/>\n<%include file="pragmatic-pbr/tonemap-filmic.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\n<%include file="mattdesl/fxaa.glsl"/>\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\n\nuniform bool antialiase;\nuniform bool tonemap;\nuniform float exposure;\nuniform float gamma;\n\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * textureSize; \n\n    if (antialiase) {\n        fragColor = fxaa(texture, fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    } else {\n        fragColor = texture2D(texture, v_texCoord);\n    }\n    \n    //fragColor.rgb *= getStandardOutputBasedExposure(aperture, shutterSpeed, iso);\n    fragColor.rgb *= exposure;\n    \n    if (tonemap) \n        fragColor.rgb = tonemapFilmic(fragColor.rgb);\n    else\n        fragColor.rgb = toGamma(fragColor.rgb, gamma);\n\n    \n    //fragColor.rgb = toGamma(fragColor.rgb, gamma);\n    \n    fragColor.a = 1.0;\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}'),this.finalize()}},ScreenQuadShader:$i,SimpleSurfaceShader:La,StandardSurfaceShader:va,StandardSurfaceGeomDataShader:Ta,StandardSurfaceSelectedGeomsShader:Ma,HandleShader:Ca,HandleGeomDataShader:Fa,TransparentSurfaceShader:wa,ScreenSpaceShader:Na,ToolIconShader:Ya,UnpackHDRShader:xi,UnpackLDRAlphaImageShader:class extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("UnpackLDRAlphaImageShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("UnpackLDRAlphaImageShader.fragmentShader","\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D alphaSampler;\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(texture2D(ldrSampler, v_texCoord).rgb, luminanceFromRGB(texture2D(alphaSampler, v_texCoord).rgb));\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n")}},WireShader:class extends Ri{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Vi.parseShader("WireShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n/* VS Outputs */\n\nvoid main(void) {\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n\n    // Apply the perspective transform, and then move the vertices\n    //  towards the camera by a tiny little bit...\n    gl_Position.z -= 0.001 / gl_Position.w;\n    //gl_Position.z *= 0.999;\n}\n"),this.__shaderStages.FRAGMENT_SHADER=Vi.parseShader("WireShader.fragmentShader","\nprecision highp float;\n\nuniform color wireColor;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifdef ENABLE_ES3\n    gl_FragColor = color;\n#else\n    fragColor = color;\n#endif  \n}\n")}},GLPass:ca,PassType:ha,GLStandardGeomsPass:za,GLOpaqueGeomsPass:Ja,GLTransparentGeomsPass:Ha,GLBillboardsPass:ka,GLOverlayPass:Ba,GLAudioItemsPass:Aa,get audioCtx(){return Oa},VRViewport:na});class ja{constructor(e){this.__name=e||z.getClassName(this),this.__stateEvents=[],this.__activationActions=[],this.__deactivationActions=[]}getName(){return this.__name}setName(e){this.__name=e}setStateMachine(e){this.__stateMachine=e}getStateMachine(){return this.__stateMachine}activate(){this.__stateEvents.forEach(e=>{e.activate()}),this.__activationActions.forEach(e=>{e.activate()})}deactivate(){this.__stateEvents.forEach(e=>{e.deactivate()}),this.__deactivationActions.forEach(e=>{e.activate()})}addStateEvent(e){e.setState(this),this.__stateEvents.push(e)}getStateEvent(e){return this.__stateEvents[e]}addActivationAction(e){e.setState(this),this.__activationActions.push(e)}getActivationAction(e){return this.__activationActions[e]}addDeactivationAction(e){e.setState(this),this.__deactivationActions.push(e)}toJSON(e,t){const i={name:this.__name,type:z.getClassName(this)},a=[];for(const i of this.__stateEvents)a.push(i.toJSON(e,t));i.stateEvents=a;const s=[];for(const i of this.__activationActions)s.push(i.toJSON(e,t));i.activationActions=s;const n=[];for(const i of this.__deactivationActions)n.push(i.toJSON(e,t));return i.deactivationActions=n,i}fromJSON(e,t,i){this.__name=e.name;for(const i of e.stateEvents){const e=z.constructClass(i.type);e.fromJSON(i,t),this.addStateEvent(e)}for(const i of e.activationActions){const e=z.constructClass(i.type);e.fromJSON(i,t),this.addActivationAction(e)}for(const i of e.deactivationActions){const e=z.constructClass(i.type);e.fromJSON(i,t),this.addDeactivationAction(e)}}}z.registerClass("State",ja);class qa extends B{constructor(e){super(),this.__name=e,this.__childActions=[],this.__outputs={}}addOutput(e){return this.__outputs[e.getName()]=e,e}getOutput(e){return this.__outputs[e]}setState(e){this.__state=e,this.__childActions.forEach(t=>{t.setState(e)})}addChild(e){this.__childActions.push(e),e.setState(this.__state)}getChild(e){return this.__childActions[e]}activate(){console.warn("activate must be implmented by each action. this:"+z.getClassName(this))}addChild(e){this.__childActions.push(e),e.setState(this.__state)}deactivate(){}__onDone(){this.__childActions.forEach(e=>{e.activate()})}toJSON(e,t){let i=super.toJSON(e,t);i||(i={}),i.type=z.getClassName(this);const a=[];for(const i of this.__childActions)a.push(i.toJSON(e,t));i.childActions=a;const s={};for(const i in this.__outputs)s[i]=this.__outputs[i].toJSON(e,t);return i.outputs=s,i}fromJSON(e,t,i){super.fromJSON(e,t,i);for(const i of e.childActions){const e=z.constructClass(i.type);if(!e)throw new Error("Invalid type:"+i.type);e.fromJSON(i,t),this.addChild(e)}for(const i in e.outputs)this.__outputs[i].fromJSON(e.outputs[i],t)}destroy(){super.destroy(),this.__outputs=[]}}class $a extends qa{constructor(e){super(),this.__name=e,this.__onEvent=this.__onEvent.bind(this)}__onEvent(){this.__childActions.forEach(e=>{e.activate()})}}class es extends A{constructor(e){super(e),this.__states={},this.__currentState,this.__initialStateName,this.stateChanged=new M,this.setFlag(D.USER_EDITED),z.isConstructing()||z.invokeCallbacks(this)}addState(e){e.setStateMachine(this),this.__states[e.getName()]=e,1==Object.keys(this.__states).length&&null==this.__initialStateName&&(this.__initialStateName=e.getName())}getState(e){return this.__states[e]}activateState(e){if(!this.__states[e])throw new Error("Invalid state transtion:"+e);this.__currentState!=this.__states[e]&&(this.__currentState&&this.__currentState.deactivate(),this.__currentState=this.__states[e],this.__currentState.activate(),this.stateChanged.emit(e))}getActiveState(){return this.__currentState}getActiveStateName(){return z.getClassName(this.__currentState)}getInitialState(){return this.__initialStateName}setInitialState(e){this.__initialStateName=e}toJSON(e,t){const i=super.toJSON(e,t);i.initialStateName=this.__initialStateName;const a={};for(const i in this.__states)a[i]=this.__states[i].toJSON(e,t);return i.states=a,i}fromJSON(e,t,i){super.fromJSON(e,t,i),this.__initialStateName=e.initialStateName,t.stateMachine=this;for(const i in e.states){const a=e.states[i],s=z.constructClass(a.type);if(!s)throw new Error("Invalid type:"+a.type);s.fromJSON(a,t),this.addState(s)}t.addPLCB(()=>{})}}z.registerClass("StateMachine",es);class ts extends qa{constructor(){super(),this.__targetStateParam=this.addParameter(new Ze("TargetState",""))}activate(){this.__state.getStateMachine().activateState(this.__targetStateParam.getValue())}}z.registerClass("SwitchState",ts);class is extends qa{constructor(){super(),this.addParameter(new Ie("Camera",e=>e instanceof Qt)),this.addParameter(new me("cameraPos")),this.addParameter(new me("cameraTarget")),this.addParameter(new oe("interpTime",1)),this.addParameter(new oe("updateFrequency",30))}SetCameraPositionAndTarget(e,t){this.getParameter("cameraPos").setValue(e),this.getParameter("cameraTarget").setValue(t)}activate(){const e=this.getParameter("Camera").getValue();if(!e)return void console.warn("Camera not assigned to SetCameraPositionAndTarget state action");const t=this.getParameter("cameraPos").getValue(),i=this.getParameter("cameraTarget").getValue(),a=this.getParameter("interpTime").getValue();if(a>0){const s=e.getGlobalXfo().tr,n=e.getTargetPostion(),r=(s.subtract(n).length(),this.getParameter("updateFrequency").getValue()),l=t.subtract(i).length();let o=!0,d=0,h=0;const c=Math.round(a*r);let m=!1;const u=()=>{m||(o=!1)};e.globalXfoChanged.connect(u);const b=()=>{if(h++,h<c){const a=h/c,s=Math.smoothStep(0,1,a),n=(s-d)/(1-a);d=s;const u=e.getGlobalXfo().tr,p=e.getTargetPostion(),g=u.subtract(p).length();let _=u;const f=p.lerp(i,n);o&&(_=u.lerp(t,n));const Z=_.subtract(f),G=(Z.length(),Math.lerp(g,l,n));Z.scaleInPlace(G/Z.length()),m=!0,e.setPositionAndTarget(f.add(Z),f),m=!1,this.__timeoutId=window.setTimeout(b,1e3/r)}else e.globalXfoChanged.disconnect(u),e.movementFinished.emit(),this.__timeoutId=void 0,this.__onDone()};b()}else e.setPositionAndTarget(t,i)}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0)}}z.registerClass("SetCameraPositionAndTarget",is);class as extends qa{constructor(){super(),this.__interpTimeParam=this.addParameter(new oe("InterpTime",1)),this.__updateFrequencyParam=this.addParameter(new oe("UpdateFrequency",30)),this.__outParam=this.addOutput(new ti("Param")),this.__outParam.paramSet.connect(()=>{if(!this.__valueParam||this.__outParam.getParam().getDataType()!=this.__valueParam.getDataType()){const e=this.__outParam.getParam().clone();e.setName("Value"),this.__outParam.getInitialValue?e.setValue(this.__outParam.getInitialValue()):e.setValue(this.__outParam.getParam().getValue()),this.__valueParam=this.addParameter(e)}})}activate(){if(this.__outParam.isConnected()){const e=this.__interpTimeParam.getValue();if(e>0){const t=this.__updateFrequencyParam.getValue(),i=this.__outParam.getValue(),a=this.__valueParam.getValue();let s=0;const n=Math.round(e/(1/t)),r=()=>{if(s++,s<n){const e=s/n,l=Math.smoothStep(0,1,e),o=Math.lerp(i,a,l);this.__outParam.setValue(o,P.GENERATED_VALUE),this.__timeoutId=window.setTimeout(r,1e3/t)}else this.__outParam.setValue(this.__valueParam.getValue(),P.GENERATED_VALUE),this.__timeoutId=void 0,this.__onDone()};r()}else this.__outParam.setValue(this.__valueParam.getValue(),P.GENERATED_VALUE),this.__onDone()}}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0)}toJSON(e,t){const i=super.toJSON(e,t);return this.__valueParam&&(i.valueParamType=z.getClassName(this.__valueParam)),i}fromJSON(e,t,i){if(e.valueParamType){const t=z.constructClass(e.valueParamType,"Value");t&&(this.__valueParam=this.addParameter(t))}super.fromJSON(e,t,i)}}z.registerClass("SetParameterValue",as);class ss extends $a{constructor(e){super(e),this.__geomParam=this.addParameter(new Ie("TreeItem")),this.__geomParam.valueChanged.connect(()=>{this.__geom=this.__geomParam.getValue()})}__geomClicked(e){e.stopPropagation(),this.__onEvent()}activate(){this.__geom&&this.__geom.mouseDown.connect(this.__geomClicked.bind(this))}deactivate(){this.__geom&&this.__geom.mouseDown.disconnect(this.__geomClicked.bind(this))}}z.registerClass("GeomClicked",ss);class ns extends $a{constructor(e){super(e),this.onKeyPressed=this.onKeyPressed.bind(this),this.__keyParam=this.addParameter(new Ze("Key",""))}onKeyPressed(e){console.log(e.key),e.key==this.__keyParam.getValue()&&this.__onEvent()}activate(){document.addEventListener("keydown",this.onKeyPressed)}deactivate(){document.removeEventListener("keydown",this.onKeyPressed)}}z.registerClass("KeyPressedEvent",ns);class rs extends $a{constructor(e){super(e),this.__waitTimeParam=this.addParameter(new oe("WaitTime",1))}activate(){this.__timeoutId=window.setTimeout(()=>{delete this.__timeoutId,this.__onEvent()},1e3*this.__waitTimeParam.getValue())}deactivate(){this.__timeoutId&&window.clearTimeout(this.__timeoutId)}}z.registerClass("TimedWait",rs);Object.freeze({__proto__:null,State:ja,StateAction:qa,StateEvent:$a,StateMachine:es,SwitchState:ts,SetCameraPositionAndTarget:is,SetParameterValue:as,GeomClicked:ss,KeyPressedEvent:ns,TimedWait:rs})}).call(this,i(35),i(36)(e),i(37).Buffer)},function(e,t,i){(function(t){var i=function(e){return e&&e.Math==Math&&e};e.exports=i("object"==typeof globalThis&&globalThis)||i("object"==typeof window&&window)||i("object"==typeof self&&self)||i("object"==typeof t&&t)||Function("return this")()}).call(this,i(10))},function(e,t,i){var a=i(3);e.exports=!a((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}))},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){var a={};a[i(9)("toStringTag")]="z",e.exports="[object z]"===String(a)},function(e,t,i){var a=i(2),s=i(14),n=i(24);e.exports=a?function(e,t,i){return s.f(e,t,n(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var a=i(4);e.exports=function(e){if(!a(e))throw TypeError(String(e)+" is not an object");return e}},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){var a=i(1),s=i(11),n=i(8),r=i(15),l=i(16),o=i(25),d=s("wks"),h=a.Symbol,c=o?h:h&&h.withoutSetter||r;e.exports=function(e){return n(d,e)||(l&&n(h,e)?d[e]=h[e]:d[e]=c("Symbol."+e)),d[e]}},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){var a=i(20),s=i(12);(e.exports=function(e,t){return s[e]||(s[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.6.5",mode:a?"pure":"global",copyright:" 2020 Denis Pushkarev (zloirock.ru)"})},function(e,t,i){var a=i(1),s=i(13),n=a["__core-js_shared__"]||s("__core-js_shared__",{});e.exports=n},function(e,t,i){var a=i(1),s=i(6);e.exports=function(e,t){try{s(a,e,t)}catch(i){a[e]=t}return t}},function(e,t,i){var a=i(2),s=i(21),n=i(7),r=i(23),l=Object.defineProperty;t.f=a?l:function(e,t,i){if(n(e),t=r(t,!0),n(i),s)try{return l(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported");return"value"in i&&(e[t]=i.value),e}},function(e,t){var i=0,a=Math.random();e.exports=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++i+a).toString(36)}},function(e,t,i){var a=i(3);e.exports=!!Object.getOwnPropertySymbols&&!a((function(){return!String(Symbol())}))},function(e,t,i){var a=i(1),s=i(6),n=i(8),r=i(13),l=i(18),o=i(26),d=o.get,h=o.enforce,c=String(String).split("String");(e.exports=function(e,t,i,l){var o=!!l&&!!l.unsafe,d=!!l&&!!l.enumerable,m=!!l&&!!l.noTargetGet;"function"==typeof i&&("string"!=typeof t||n(i,"name")||s(i,"name",t),h(i).source=c.join("string"==typeof t?t:"")),e!==a?(o?!m&&e[t]&&(d=!0):delete e[t],d?e[t]=i:s(e,t,i)):d?e[t]=i:r(t,i)})(Function.prototype,"toString",(function(){return"function"==typeof this&&d(this).source||l(this)}))},function(e,t,i){var a=i(12),s=Function.toString;"function"!=typeof a.inspectSource&&(a.inspectSource=function(e){return s.call(e)}),e.exports=a.inspectSource},function(e,t,i){var a=i(5),s=i(17),n=i(30);a||s(Object.prototype,"toString",n,{unsafe:!0})},function(e,t){e.exports=!1},function(e,t,i){var a=i(2),s=i(3),n=i(22);e.exports=!a&&!s((function(){return 7!=Object.defineProperty(n("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){var a=i(1),s=i(4),n=a.document,r=s(n)&&s(n.createElement);e.exports=function(e){return r?n.createElement(e):{}}},function(e,t,i){var a=i(4);e.exports=function(e,t){if(!a(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!a(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!a(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!a(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,i){var a=i(16);e.exports=a&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},function(e,t,i){var a,s,n,r=i(27),l=i(1),o=i(4),d=i(6),h=i(8),c=i(28),m=i(29),u=l.WeakMap;if(r){var b=new u,p=b.get,g=b.has,_=b.set;a=function(e,t){return _.call(b,e,t),t},s=function(e){return p.call(b,e)||{}},n=function(e){return g.call(b,e)}}else{var f=c("state");m[f]=!0,a=function(e,t){return d(e,f,t),t},s=function(e){return h(e,f)?e[f]:{}},n=function(e){return h(e,f)}}e.exports={set:a,get:s,has:n,enforce:function(e){return n(e)?s(e):a(e,{})},getterFor:function(e){return function(t){var i;if(!o(t)||(i=s(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return i}}}},function(e,t,i){var a=i(1),s=i(18),n=a.WeakMap;e.exports="function"==typeof n&&/native code/.test(s(n))},function(e,t,i){var a=i(11),s=i(15),n=a("keys");e.exports=function(e){return n[e]||(n[e]=s(e))}},function(e,t){e.exports={}},function(e,t,i){"use strict";var a=i(5),s=i(31);e.exports=a?{}.toString:function(){return"[object "+s(this)+"]"}},function(e,t,i){var a=i(5),s=i(32),n=i(9)("toStringTag"),r="Arguments"==s(function(){return arguments}());e.exports=a?s:function(e){var t,i,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),n))?i:r?s(t):"Object"==(a=s(t))&&"function"==typeof t.callee?"Arguments":a}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t,i){"use strict";var a=i(17),s=i(7),n=i(3),r=i(34),l=RegExp.prototype,o=l.toString,d=n((function(){return"/a/b"!=o.call({source:"a",flags:"b"})})),h="toString"!=o.name;(d||h)&&a(RegExp.prototype,"toString",(function(){var e=s(this),t=String(e.source),i=e.flags;return"/"+t+"/"+String(void 0===i&&e instanceof RegExp&&!("flags"in l)?r.call(e):i)}),{unsafe:!0})},function(e,t,i){"use strict";var a=i(7);e.exports=function(){var e=a(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t){var i,a,s=e.exports={};function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function l(e){if(i===setTimeout)return setTimeout(e,0);if((i===n||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:n}catch(e){i=n}try{a="function"==typeof clearTimeout?clearTimeout:r}catch(e){a=r}}();var o,d=[],h=!1,c=-1;function m(){h&&o&&(h=!1,o.length?d=o.concat(d):c=-1,d.length&&u())}function u(){if(!h){var e=l(m);h=!0;for(var t=d.length;t;){for(o=d,d=[];++c<t;)o&&o[c].run();c=-1,t=d.length}o=null,h=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===r||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function b(e,t){this.fun=e,this.array=t}function p(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];d.push(new b(e,t)),1!==d.length||h||l(u)},b.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=p,s.addListener=p,s.once=p,s.off=p,s.removeListener=p,s.removeAllListeners=p,s.emit=p,s.prependListener=p,s.prependOnceListener=p,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t){e.exports=function(e){if(!e.webpackPolyfill){var t=Object.create(e);t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1}return t}},function(e,t,i){"use strict";(function(e){var a=i(38),s=i(39),n=i(40);function r(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(e,t){if(r()<t)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=o.prototype:(null===e&&(e=new o(t)),e.length=t),e}function o(e,t,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return c(this,e)}return d(this,e,t,i)}function d(e,t,i,a){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,a){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(a||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===a?new Uint8Array(t):void 0===a?new Uint8Array(t,i):new Uint8Array(t,i,a);o.TYPED_ARRAY_SUPPORT?(e=t).__proto__=o.prototype:e=m(e,t);return e}(e,t,i,a):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var a=0|b(t,i),s=(e=l(e,a)).write(t,i);s!==a&&(e=e.slice(0,s));return e}(e,t,i):function(e,t){if(o.isBuffer(t)){var i=0|u(t.length);return 0===(e=l(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(a=t.length)!=a?l(e,0):m(e,t);if("Buffer"===t.type&&n(t.data))return m(e,t.data)}var a;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function h(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function c(e,t){if(h(t),e=l(e,t<0?0:0|u(t)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function m(e,t){var i=t.length<0?0:0|u(t.length);e=l(e,i);for(var a=0;a<i;a+=1)e[a]=255&t[a];return e}function u(e){if(e>=r())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r().toString(16)+" bytes");return 0|e}function b(e,t){if(o.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var a=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return U(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return P(e).length;default:if(a)return U(e).length;t=(""+t).toLowerCase(),a=!0}}function p(e,t,i){var a=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return L(this,t,i);case"utf8":case"utf-8":return x(this,t,i);case"ascii":return S(this,t,i);case"latin1":case"binary":return W(this,t,i);case"base64":return R(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v(this,t,i);default:if(a)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),a=!0}}function g(e,t,i){var a=e[t];e[t]=e[i],e[i]=a}function _(e,t,i,a,s){if(0===e.length)return-1;if("string"==typeof i?(a=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=o.from(t,a)),o.isBuffer(t))return 0===t.length?-1:f(e,t,i,a,s);if("number"==typeof t)return t&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):f(e,[t],i,a,s);throw new TypeError("val must be string, number or Buffer")}function f(e,t,i,a,s){var n,r=1,l=e.length,o=t.length;if(void 0!==a&&("ucs2"===(a=String(a).toLowerCase())||"ucs-2"===a||"utf16le"===a||"utf-16le"===a)){if(e.length<2||t.length<2)return-1;r=2,l/=2,o/=2,i/=2}function d(e,t){return 1===r?e[t]:e.readUInt16BE(t*r)}if(s){var h=-1;for(n=i;n<l;n++)if(d(e,n)===d(t,-1===h?0:n-h)){if(-1===h&&(h=n),n-h+1===o)return h*r}else-1!==h&&(n-=n-h),h=-1}else for(i+o>l&&(i=l-o),n=i;n>=0;n--){for(var c=!0,m=0;m<o;m++)if(d(e,n+m)!==d(t,m)){c=!1;break}if(c)return n}return-1}function Z(e,t,i,a){i=Number(i)||0;var s=e.length-i;a?(a=Number(a))>s&&(a=s):a=s;var n=t.length;if(n%2!=0)throw new TypeError("Invalid hex string");a>n/2&&(a=n/2);for(var r=0;r<a;++r){var l=parseInt(t.substr(2*r,2),16);if(isNaN(l))return r;e[i+r]=l}return r}function G(e,t,i,a){return E(U(t,e.length-i),e,i,a)}function y(e,t,i,a){return E(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,a)}function X(e,t,i,a){return y(e,t,i,a)}function V(e,t,i,a){return E(P(t),e,i,a)}function I(e,t,i,a){return E(function(e,t){for(var i,a,s,n=[],r=0;r<e.length&&!((t-=2)<0);++r)i=e.charCodeAt(r),a=i>>8,s=i%256,n.push(s),n.push(a);return n}(t,e.length-i),e,i,a)}function R(e,t,i){return 0===t&&i===e.length?a.fromByteArray(e):a.fromByteArray(e.slice(t,i))}function x(e,t,i){i=Math.min(e.length,i);for(var a=[],s=t;s<i;){var n,r,l,o,d=e[s],h=null,c=d>239?4:d>223?3:d>191?2:1;if(s+c<=i)switch(c){case 1:d<128&&(h=d);break;case 2:128==(192&(n=e[s+1]))&&(o=(31&d)<<6|63&n)>127&&(h=o);break;case 3:n=e[s+1],r=e[s+2],128==(192&n)&&128==(192&r)&&(o=(15&d)<<12|(63&n)<<6|63&r)>2047&&(o<55296||o>57343)&&(h=o);break;case 4:n=e[s+1],r=e[s+2],l=e[s+3],128==(192&n)&&128==(192&r)&&128==(192&l)&&(o=(15&d)<<18|(63&n)<<12|(63&r)<<6|63&l)>65535&&o<1114112&&(h=o)}null===h?(h=65533,c=1):h>65535&&(h-=65536,a.push(h>>>10&1023|55296),h=56320|1023&h),a.push(h),s+=c}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",a=0;for(;a<t;)i+=String.fromCharCode.apply(String,e.slice(a,a+=4096));return i}(a)}t.Buffer=o,t.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},t.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=r(),o.poolSize=8192,o._augment=function(e){return e.__proto__=o.prototype,e},o.from=function(e,t,i){return d(null,e,t,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(e,t,i){return function(e,t,i,a){return h(t),t<=0?l(e,t):void 0!==i?"string"==typeof a?l(e,t).fill(i,a):l(e,t).fill(i):l(e,t)}(null,e,t,i)},o.allocUnsafe=function(e){return c(null,e)},o.allocUnsafeSlow=function(e){return c(null,e)},o.isBuffer=function(e){return!(null==e||!e._isBuffer)},o.compare=function(e,t){if(!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,a=t.length,s=0,n=Math.min(i,a);s<n;++s)if(e[s]!==t[s]){i=e[s],a=t[s];break}return i<a?-1:a<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!n(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var a=o.allocUnsafe(t),s=0;for(i=0;i<e.length;++i){var r=e[i];if(!o.isBuffer(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(a,s),s+=r.length}return a},o.byteLength=b,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},o.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?x(this,0,e):p.apply(this,arguments)},o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,a,s){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===a&&(a=0),void 0===s&&(s=this.length),t<0||i>e.length||a<0||s>this.length)throw new RangeError("out of range index");if(a>=s&&t>=i)return 0;if(a>=s)return-1;if(t>=i)return 1;if(this===e)return 0;for(var n=(s>>>=0)-(a>>>=0),r=(i>>>=0)-(t>>>=0),l=Math.min(n,r),d=this.slice(a,s),h=e.slice(t,i),c=0;c<l;++c)if(d[c]!==h[c]){n=d[c],r=h[c];break}return n<r?-1:r<n?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return _(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return _(this,e,t,i,!1)},o.prototype.write=function(e,t,i,a){if(void 0===t)a="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)a=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===a&&(a="utf8")):(a=i,i=void 0)}var s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");a||(a="utf8");for(var n=!1;;)switch(a){case"hex":return Z(this,e,t,i);case"utf8":case"utf-8":return G(this,e,t,i);case"ascii":return y(this,e,t,i);case"latin1":case"binary":return X(this,e,t,i);case"base64":return V(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+a);a=(""+a).toLowerCase(),n=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function S(e,t,i){var a="";i=Math.min(e.length,i);for(var s=t;s<i;++s)a+=String.fromCharCode(127&e[s]);return a}function W(e,t,i){var a="";i=Math.min(e.length,i);for(var s=t;s<i;++s)a+=String.fromCharCode(e[s]);return a}function L(e,t,i){var a=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>a)&&(i=a);for(var s="",n=t;n<i;++n)s+=z(e[n]);return s}function v(e,t,i){for(var a=e.slice(t,i),s="",n=0;n<a.length;n+=2)s+=String.fromCharCode(a[n]+256*a[n+1]);return s}function T(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,i,a,s,n){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(i+a>e.length)throw new RangeError("Index out of range")}function C(e,t,i,a){t<0&&(t=65535+t+1);for(var s=0,n=Math.min(e.length-i,2);s<n;++s)e[i+s]=(t&255<<8*(a?s:1-s))>>>8*(a?s:1-s)}function F(e,t,i,a){t<0&&(t=4294967295+t+1);for(var s=0,n=Math.min(e.length-i,4);s<n;++s)e[i+s]=t>>>8*(a?s:3-s)&255}function w(e,t,i,a,s,n){if(i+a>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function N(e,t,i,a,n){return n||w(e,0,i,4),s.write(e,t,i,a,23,4),i+4}function Y(e,t,i,a,n){return n||w(e,0,i,8),s.write(e,t,i,a,52,8),i+8}o.prototype.slice=function(e,t){var i,a=this.length;if((e=~~e)<0?(e+=a)<0&&(e=0):e>a&&(e=a),(t=void 0===t?a:~~t)<0?(t+=a)<0&&(t=0):t>a&&(t=a),t<e&&(t=e),o.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=o.prototype;else{var s=t-e;i=new o(s,void 0);for(var n=0;n<s;++n)i[n]=this[n+e]}return i},o.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var a=this[e],s=1,n=0;++n<t&&(s*=256);)a+=this[e+n]*s;return a},o.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var a=this[e+--t],s=1;t>0&&(s*=256);)a+=this[e+--t]*s;return a},o.prototype.readUInt8=function(e,t){return t||T(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return t||T(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return t||T(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var a=this[e],s=1,n=0;++n<t&&(s*=256);)a+=this[e+n]*s;return a>=(s*=128)&&(a-=Math.pow(2,8*t)),a},o.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var a=t,s=1,n=this[e+--a];a>0&&(s*=256);)n+=this[e+--a]*s;return n>=(s*=128)&&(n-=Math.pow(2,8*t)),n},o.prototype.readInt8=function(e,t){return t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){t||T(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){t||T(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return t||T(e,4,this.length),s.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return t||T(e,4,this.length),s.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return t||T(e,8,this.length),s.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return t||T(e,8,this.length),s.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,a){(e=+e,t|=0,i|=0,a)||M(this,e,t,i,Math.pow(2,8*i)-1,0);var s=1,n=0;for(this[t]=255&e;++n<i&&(s*=256);)this[t+n]=e/s&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,a){(e=+e,t|=0,i|=0,a)||M(this,e,t,i,Math.pow(2,8*i)-1,0);var s=i-1,n=1;for(this[t+s]=255&e;--s>=0&&(n*=256);)this[t+s]=e/n&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,1,255,0),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):F(this,e,t,!0),t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):F(this,e,t,!1),t+4},o.prototype.writeIntLE=function(e,t,i,a){if(e=+e,t|=0,!a){var s=Math.pow(2,8*i-1);M(this,e,t,i,s-1,-s)}var n=0,r=1,l=0;for(this[t]=255&e;++n<i&&(r*=256);)e<0&&0===l&&0!==this[t+n-1]&&(l=1),this[t+n]=(e/r>>0)-l&255;return t+i},o.prototype.writeIntBE=function(e,t,i,a){if(e=+e,t|=0,!a){var s=Math.pow(2,8*i-1);M(this,e,t,i,s-1,-s)}var n=i-1,r=1,l=0;for(this[t+n]=255&e;--n>=0&&(r*=256);)e<0&&0===l&&0!==this[t+n+1]&&(l=1),this[t+n]=(e/r>>0)-l&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,1,127,-128),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):F(this,e,t,!0),t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||M(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):F(this,e,t,!1),t+4},o.prototype.writeFloatLE=function(e,t,i){return N(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return N(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return Y(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return Y(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,a){if(i||(i=0),a||0===a||(a=this.length),t>=e.length&&(t=e.length),t||(t=0),a>0&&a<i&&(a=i),a===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(a<0)throw new RangeError("sourceEnd out of bounds");a>this.length&&(a=this.length),e.length-t<a-i&&(a=e.length-t+i);var s,n=a-i;if(this===e&&i<t&&t<a)for(s=n-1;s>=0;--s)e[s+t]=this[s+i];else if(n<1e3||!o.TYPED_ARRAY_SUPPORT)for(s=0;s<n;++s)e[s+t]=this[s+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+n),t);return n},o.prototype.fill=function(e,t,i,a){if("string"==typeof e){if("string"==typeof t?(a=t,t=0,i=this.length):"string"==typeof i&&(a=i,i=this.length),1===e.length){var s=e.charCodeAt(0);s<256&&(e=s)}if(void 0!==a&&"string"!=typeof a)throw new TypeError("encoding must be a string");if("string"==typeof a&&!o.isEncoding(a))throw new TypeError("Unknown encoding: "+a)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var n;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(n=t;n<i;++n)this[n]=e;else{var r=o.isBuffer(e)?e:U(new o(e,a).toString()),l=r.length;for(n=0;n<i-t;++n)this[n+t]=r[n%l]}return this};var K=/[^+\/0-9A-Za-z-_]/g;function z(e){return e<16?"0"+e.toString(16):e.toString(16)}function U(e,t){var i;t=t||1/0;for(var a=e.length,s=null,n=[],r=0;r<a;++r){if((i=e.charCodeAt(r))>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(r+1===a){(t-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;n.push(i)}else if(i<2048){if((t-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function P(e){return a.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(K,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function E(e,t,i,a){for(var s=0;s<a&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}}).call(this,i(10))},function(e,t,i){"use strict";t.byteLength=function(e){var t=d(e),i=t[0],a=t[1];return 3*(i+a)/4-a},t.toByteArray=function(e){var t,i,a=d(e),r=a[0],l=a[1],o=new n(function(e,t,i){return 3*(t+i)/4-i}(0,r,l)),h=0,c=l>0?r-4:r;for(i=0;i<c;i+=4)t=s[e.charCodeAt(i)]<<18|s[e.charCodeAt(i+1)]<<12|s[e.charCodeAt(i+2)]<<6|s[e.charCodeAt(i+3)],o[h++]=t>>16&255,o[h++]=t>>8&255,o[h++]=255&t;2===l&&(t=s[e.charCodeAt(i)]<<2|s[e.charCodeAt(i+1)]>>4,o[h++]=255&t);1===l&&(t=s[e.charCodeAt(i)]<<10|s[e.charCodeAt(i+1)]<<4|s[e.charCodeAt(i+2)]>>2,o[h++]=t>>8&255,o[h++]=255&t);return o},t.fromByteArray=function(e){for(var t,i=e.length,s=i%3,n=[],r=0,l=i-s;r<l;r+=16383)n.push(h(e,r,r+16383>l?l:r+16383));1===s?(t=e[i-1],n.push(a[t>>2]+a[t<<4&63]+"==")):2===s&&(t=(e[i-2]<<8)+e[i-1],n.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"="));return n.join("")};for(var a=[],s=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,o=r.length;l<o;++l)a[l]=r[l],s[r.charCodeAt(l)]=l;function d(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function h(e,t,i){for(var s,n,r=[],l=t;l<i;l+=3)s=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),r.push(a[(n=s)>>18&63]+a[n>>12&63]+a[n>>6&63]+a[63&n]);return r.join("")}s["-".charCodeAt(0)]=62,s["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,i,a,s){var n,r,l=8*s-a-1,o=(1<<l)-1,d=o>>1,h=-7,c=i?s-1:0,m=i?-1:1,u=e[t+c];for(c+=m,n=u&(1<<-h)-1,u>>=-h,h+=l;h>0;n=256*n+e[t+c],c+=m,h-=8);for(r=n&(1<<-h)-1,n>>=-h,h+=a;h>0;r=256*r+e[t+c],c+=m,h-=8);if(0===n)n=1-d;else{if(n===o)return r?NaN:1/0*(u?-1:1);r+=Math.pow(2,a),n-=d}return(u?-1:1)*r*Math.pow(2,n-a)},t.write=function(e,t,i,a,s,n){var r,l,o,d=8*n-s-1,h=(1<<d)-1,c=h>>1,m=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,u=a?0:n-1,b=a?1:-1,p=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,r=h):(r=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-r))<1&&(r--,o*=2),(t+=r+c>=1?m/o:m*Math.pow(2,1-c))*o>=2&&(r++,o/=2),r+c>=h?(l=0,r=h):r+c>=1?(l=(t*o-1)*Math.pow(2,s),r+=c):(l=t*Math.pow(2,c-1)*Math.pow(2,s),r=0));s>=8;e[i+u]=255&l,u+=b,l/=256,s-=8);for(r=r<<s|l,d+=s;d>0;e[i+u]=255&r,u+=b,r/=256,d-=8);e[i+u-b]|=128*p}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}},function(e,t,i){var a=i(2),s=i(14).f,n=Function.prototype,r=n.toString,l=/^\s*function ([^ (]*)/;a&&!("name"in n)&&s(n,"name",{configurable:!0,get:function(){try{return r.call(this).match(l)[1]}catch(e){return""}}})},function(e,t,i){},function(e,t,i){"use strict";i.r(t);i(19),i(33);var a=i(0);const s={},n={},r=[];class l{constructor(){this.__undoStack=[],this.__redoStack=[],this.changeAdded=new a.w,this.changeUpdated=new a.w,this.changeUndone=new a.w,this.changeRedone=new a.w,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[]}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.changeAdded.emit(e)}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.changeUpdated.emit(e)}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.changeUndone.emit())}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.changeRedone.emit()}}constructChange(e){return new s[e]}static getChangeClassName(e){const t=r.indexOf(e.constructor);return n[t]?n[t]:(console.warn("Change not registered:",e.constructor.name),e.constructor.name)}static registerChange(e,t){-1!=r.indexOf(t)&&console.warn("Class already registered:",e);const i=r.length;r.push(t),s[e]=t,n[i]=e}}class o{constructor(e){this.name=e||l.getChangeClassName(this),this.updated=new a.w}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}changeFromJSON(e){this.update(e)}destroy(){}}class d extends a.A{constructor(e){super(e),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const e=this.getGlobalXfo();return new a.u(e.tr,e.ori.getZaxis())}onMouseEnter(e){this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e))}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),i=this.getManipulationPlane(),a=t.tr.subtract(i.start),s=t.tr.subtract(i.dir.scale(a.dot(i.dir)));return e.grabPos=s,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),i=this.getManipulationPlane(),a=t.tr.subtract(i.start),s=t.tr.subtract(i.dir.scale(a.dot(i.dir)));return e.holdPos=s,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e)}onDrag(e){console.log("onDrag",e)}onDragEnd(e){console.log("onDragEnd",e)}}class h extends d{constructor(e){super(e)}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],i=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=i,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],i=this.gizmoRay.pointAtDist(t);return e.releasePos=i,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const i=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=i,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),i=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=i,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class c extends o{constructor(e,t,i=a.B.USER_SETVALUE){e?(super(e?e.getName()+" Changed":"ParameterValueChange"),this.__prevValue=e.getValue(),this.__param=e,this.__mode=i,null!=t&&(this.__nextValue=t,this.__param.setValue(this.__nextValue,i))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e)}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(e,t){const i=t.appData.scene.getRoot().resolvePath(e.paramPath,1);i&&i instanceof a.q?(this.__param=i,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=e.name,null!=e.value&&this.changeFromJSON(e)):console.warn("resolvePath is unable to resolve",e.paramPath)}changeFromJSON(e){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(e.value):this.__nextValue=e.value,this.__param.setValue(this.__nextValue,a.B.REMOTEUSER_SETVALUE))}}l.registerChange("ParameterValueChange",c);class m extends d{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue())};t(),e.valueChanged.connect(t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new a.E;const t=this.getTargetParam(),i=t.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(i),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new c(t),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr),i=t.length();t.normalizeInPlace();const s=i/this.grabCircleRadius;let n=this.vec0.angleTo(t)*s;if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(n=-n),this.range&&(n=Math.clamp(n,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);n=Math.floor(n/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new a.D(0,0,1),n);const r=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);this.change?this.change.update({value:r}):this.getTargetParam().setValue(r)}onDragEnd(e){this.change=null}}a.A;a.l;class u extends o{constructor(e,t,i){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=i}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),i=[];for(const e of this.__newSelection)i.push(e.getPath());return t.itemPaths=i,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const i=t.appData.scene.getRoot(),a=new Set;for(const t of e.itemPaths)a.add(i.resolvePath(t,1));this.__newSelection=a,this.__selectionManager.setSelection(this.__newSelection,!1)}}l.registerChange("SelectionChange",u);class b extends o{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}l.registerChange("ToggleSelectionVisibility",b);l.registerChange("TreeItemAddChange",class extends o{constructor(e,t,i){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=i,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){this.treeItem instanceof a.p?this.treeItem.detach():this.treeItem instanceof a.A&&this.treeItem.traverse(e=>{e instanceof a.p&&e.detach()},!1),this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.treeItem instanceof a.p?this.treeItem.reattach():subTreeItem instanceof a.A&&this.treeItem.traverse(e=>{e instanceof a.p&&e.reattach()},!1),this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(e,t){const i=a.F.constructClass(e.treeItem.type);i?(this.name=e.name,this.treeItem=i,this.treeItem.addRef(this),this.treeItem.fromJSON(e.treeItem,t),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",e.treeItem)}destroy(){this.treeItem.removeRef(this)}});l.registerChange("TreeItemsRemoveChange",class extends o{constructor(e,t){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],e){this.selectionManager=t.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=e,this.newSelection=new Set(this.prevSelection);const i=[];this.items.forEach(e=>{const t=e.getOwner(),s=t.getChildIndex(e);i.push(e.getName()),e.addRef(this),this.itemOwners.push(t),this.itemPaths.push(e.getPath()),this.itemIndices.push(s),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e),e instanceof a.p?e.detach():e instanceof a.A&&e.traverse(e=>{e instanceof a.p&&e.detach(),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e)},!1),t.removeChild(s)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=i+" Deleted"}}undo(){this.items.forEach((e,t)=>{this.itemOwners[t].insertChild(e,this.itemIndices[t],!1,!1),e instanceof a.p?e.reattach():subTreeItem instanceof a.A&&e.traverse(e=>{e instanceof a.p&&e.reattach()},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((e,t)=>{this.itemOwners[t].removeChild(this.itemIndices[t]),e instanceof a.p?e.detach():subTreeItem instanceof a.A&&e.traverse(e=>{e instanceof a.p&&e.detach()},!1)})}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON())}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const i=t.scene.getRoot().resolvePath(e,1);if(!i)return void console.warn("resolvePath is unable to resolve",e);const a=i.getOwner();this.itemOwners.push(a),this.itemPaths.push(i.getPath()),this.itemIndices.push(a.getChildIndex(i))})}destroy(){this.items.forEach(e=>e.removeRef(this))}});l.registerChange("TreeItemMoveChange",class extends o{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const i=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!i)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const a=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);a?(this.name=e.name,this.treeItem=i,this.newOwner=a,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}});class p extends a.r{constructor(e){super(),e||console.error("App data not provided to tool"),this.appData=e,this.installChanged=new a.w,this.activatedChanged=new a.w,this.actionFinished=new a.w,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.installChanged.emit(!0)}uninstall(){this.__installed=!1,this.installChanged.emit(!1)}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.activatedChanged.emit(!0)}deactivateTool(){this.__activated=!1,this.activatedChanged.emit(!1)}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}l.registerChange("SelectionTool",class extends p{constructor(e){super(e),this.dragging=!1,this.selectionRect=new a.v(1,1),this.selectionRectMat=new a.n("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new a.d("#03E3AC")),this.selectionRectXfo=new a.E,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new a.k("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(e,t){const i=new a.C(1/e.getWidth()*2,1/e.getHeight()*2),s=t.multiply(i);this.selectionRectXfo.sc.set(Math.abs(s.x),Math.abs(s.y),1);const n=this.mouseDownPos.subtract(t.scale(.5)).multiply(i).subtract(new a.C(1,1));this.selectionRectXfo.tr.x=n.x,this.selectionRectXfo.tr.y=-n.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t))}return!0}onMouseUp(e){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const t=e.mousePos,i=new a.C(Math.min(this.mouseDownPos.x,t.x),Math.min(this.mouseDownPos.y,t.y)),s=new a.C(Math.max(this.mouseDownPos.x,t.x),Math.max(this.mouseDownPos.y,t.y)),n=e.viewport.getGeomItemsInRect(i,s);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(n);else{const t=new Set([...n].filter(e=>!(e.getOwner()instanceof d)));e.shiftKey?this.appData.selectionManager.deselectItems(t):this.appData.selectionManager.selectItems(t,!e.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t||t.geomItem.getOwner()instanceof d)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(t.geomItem);else if(e.shiftKey){const e=new Set;e.add(t.geomItem),this.appData.selectionManager.deselectItems(e)}else this.appData.selectionManager.toggleItemSelection(t.geomItem,!e.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof d))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}});const g=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const i=e(t).toLowerCase();return function(){const e="application/font-woff";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[i]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const i=window.atob(e.toDataURL().split(",")[1]),a=i.length,s=new Uint8Array(a);for(let e=0;e<a;e++)s[e]=i.charCodeAt(e);t(new Blob([s],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const i=document.implementation.createHTMLDocument(),a=i.createElement("base");i.head.appendChild(a);const s=i.createElement("a");return i.body.appendChild(s),a.href=t,s.href=e,s.href},getAndEncode:function(e){return X.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime()),new Promise((function(t){const i=new XMLHttpRequest;let a;if(i.onreadystatechange=function(){if(4!==i.readyState)return;if(200!==i.status)return void(a?t(a):s("cannot fetch resource: "+e+", status: "+i.status));const n=new FileReader;n.onloadend=function(){const e=n.result.split(/,/)[1];t(e)},n.readAsDataURL(i.response)},i.ontimeout=function(){a?t(a):s("timeout of 30000ms occured while fetching resource: "+e)},i.responseType="blob",i.timeout=3e4,i.open("GET",e,!0),i.send(),X.impl.options.imagePlaceholder){const e=X.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(a=e[1])}function s(e){console.error(e),t("")}}))},uid:function(){let e=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(i){setTimeout((function(){i(t)}),e)}))}},asArray:function(e){const t=[],i=e.length;for(let a=0;a<i;a++)t.push(e[a]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,i){const a=new Image;a.onload=function(){t(a)},a.onerror=i,a.src=e}))},width:function(e){const i=t(e,"border-left-width"),a=t(e,"border-right-width");return e.scrollWidth+i+a},height:function(e){const i=t(e,"border-top-width"),a=t(e,"border-bottom-width");return e.scrollHeight+i+a}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const i=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(i.replace("px",""))}}(),_=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,s,n){return t(e)?Promise.resolve(e).then(i).then((function(t){let i=Promise.resolve(e);return t.forEach((function(e){i=i.then((function(t){return a(t,e,s,n)}))})),i})):Promise.resolve(e)},shouldProcess:t,impl:{readUrls:i,inline:a}};function t(t){return-1!==t.search(e)}function i(t){const i=[];let a;for(;null!==(a=e.exec(t));)i.push(a[1]);return i.filter((function(e){return!g.isDataUrl(e)}))}function a(e,t,i,a){return Promise.resolve(t).then((function(e){return i?g.resolveUrl(e,i):e})).then(a||g.getAndEncode).then((function(e){return g.dataAsUrl(e,g.mimeType(t))})).then((function(i){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+g.escape(e)+")(['\"]?\\))","g")}(t),"$1"+i+"$3")}))}}(),f=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(g.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{g.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return _.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return _.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),Z=function(){return{inlineAll:function t(i){return i instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?_.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}(i).then((function(){return i instanceof HTMLImageElement?e(i).inline():Promise.all(g.asArray(i.childNodes).map((function(e){return t(e)})))})):Promise.resolve(i)},impl:{newImage:e}};function e(e){return{inline:function(t){return g.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||g.getAndEncode).then((function(t){return g.dataAsUrl(t,g.mimeType(e.src))})).then((function(t){return new Promise((function(i,a){e.onload=i,e.onerror=a,e.src=t}))}))}}}}(),G=void 0,y=!1,X={toSvg:V,toPng:function(e,t){return I(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return I(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return I(e,t||{}).then(g.canvasToBlob)},toPixelData:function(e,t){return I(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,g.width(e),g.height(e)).data}))},toCanvas:function(e,t){return I(e,t||{}).then((function(e){return e}))},impl:{fontFaces:f,images:Z,util:g,inliner:_,options:{}}};function V(e,t){return function(e){void 0===e.imagePlaceholder?X.impl.options.imagePlaceholder=G:X.impl.options.imagePlaceholder=e.imagePlaceholder,void 0===e.cacheBust?X.impl.options.cacheBust=y:X.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,i,a){return a||!i||i(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?g.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return s(t,e,i)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then((function(){var i,a;i=window.getComputedStyle(e),a=t.style,i.cssText?a.cssText=i.cssText:function(e,t){g.asArray(e).forEach((function(i){t.setProperty(i,e.getPropertyValue(i),e.getPropertyPriority(i))}))}(i,a)})).then((function(){[":before",":after"].forEach((function(i){!function(i){const a=window.getComputedStyle(e,i),s=a.getPropertyValue("content");if(""===s||"none"===s)return;const n=g.uid();t.className=t.className+" "+n;const r=document.createElement("style");r.appendChild(function(e,t,i){const a="."+e+":"+t,s=i.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(i):function(e){return g.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(i);return document.createTextNode(a+"{"+s+"}")}(n,i,a)),t.appendChild(r)}(i)}))})).then((function(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)})).then((function(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const i=t.getAttribute(e);i&&t.style.setProperty(e,i)})))})).then((function(){return t})):t}(t,e)})):Promise.resolve();function s(t,i,a){const s=t.childNodes;return 0===s.length?Promise.resolve(i):function(t,i,a){let s=Promise.resolve();return i.forEach((function(i){s=s.then((function(){return e(i,a)})).then((function(e){e&&t.appendChild(e)}))})),s}(i,g.asArray(s),a).then((function(){return i}))}}(e,t.filter,!0)})).then(R).then(x).then((function(e){return t.bgcolor&&(e.style.backgroundColor=t.bgcolor),t.width&&(e.style.width=t.width+"px"),t.height&&(e.style.height=t.height+"px"),t.style&&Object.keys(t.style).forEach((function(i){e.style[i]=t.style[i]})),e})).then((function(i){return function(e,t,i){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(g.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+i+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(i,t.width||g.width(e),t.height||g.height(e))}))}function I(e,t){return V(e,t).then(g.makeImage).then(g.delay(100)).then((function(i){const a=function(e){const i=document.createElement("canvas");if(i.width=t.width||g.width(e),i.height=t.height||g.height(e),t.bgcolor){const e=i.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,i.width,i.height)}return i}(e);return a.getContext("2d").drawImage(i,0,0),a}))}function R(e){return f.resolveAll().then((function(t){const i=document.createElement("style");return e.appendChild(i),i.appendChild(document.createTextNode(t)),e}))}function x(e){return Z.inlineAll(e).then((function(){return e}))}a.k;class S extends o{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const i=e.changeXfoIds[t];this.__selection[i]&&(this.__selection[i].setGlobalXfo(e.changeXfos[t]),this.__newXfos[i]=e.changeXfos[t])}this.updated.emit(e)}toJSON(e){const t=super.toJSON(e),i=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?i[e]=this.__selection[e].getPath():i.push(null);return t.itemPaths=i,t}fromJSON(e,t){super.fromJSON(e,t);const i=t.appData.scene.getRoot(),a=[];for(let t=0;t<e.itemPaths.length;t++){const s=e.itemPaths[t];s&&(a[t]=i.resolvePath(s,1))}this.__selection=a}}l.registerChange("HoldObjectsChange",S);class W extends o{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const i=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(i),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(e,t){const i=t.appData.scene.getRoot();this.parentItem=i.resolvePath(e.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(e.geomItemName));const s=new a.E;s.fromJSON(e.geomItemXfo),this.geomItem.setLocalXfo(s),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class L extends W{constructor(e,t,i,s){super("Create Line"),this.line=new a.m(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const n=new a.n("Line","LinesShader");n.getParameter("Color").setValue(new a.d(.7,.2,.2)),this.geomItem=new a.k("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(n),i&&n.getParameter("Color").setValue(i),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e)}fromJSON(e,t){if(super.fromJSON(e,t),e.color){const t=new a.d;t.fromJSON(e.color),material.getParameter("Color").setValue(t)}e.thickness&&(this.line.lineThickness=e.thickness)}}l.registerChange("CreateLineChange",L);class v extends W{constructor(e,t){super("Create Circle",e),this.circle=new a.c(0,64),this.circle.lineThickness=.05;const i=new a.n("circle","FatLinesShader");i.getParameter("Color").setValue(new a.d(.7,.2,.2)),this.geomItem=new a.k("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(i),e&&t&&this.setParentAndXfo(e,t)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}l.registerChange("CreateCircleChange",v);class T extends W{constructor(e,t){super("Create Rect"),this.rect=new a.v(0,0),this.rect.lineThickness=.05;const i=new a.n("circle","FatLinesShader");i.getParameter("Color").setValue(new a.d(.7,.2,.2)),this.geomItem=new a.k("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(i),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.updated.emit(e)}}l.registerChange("CreateRectChange",T);class M extends W{constructor(e,t,i,s){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new a.m,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new a.D);const n=new a.n("freeHandLine","FatLinesShader");this.geomItem=new a.k("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(n),i&&n.getParameter("Color").setValue(i),s&&(this.line.lineThickness=s),e&&t&&this.setParentAndXfo(e,t)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e)}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(e,t){e.lineThickness&&(this.line.lineThickness=e.lineThickness);const i=new a.d(.7,.2,.2);e.color&&i.fromJSON(e.color),this.geomItem.getMaterial().getParameter("Color").setValue(i),super.fromJSON(e,t)}}l.registerChange("CreateFreehandLineChange",M);class C extends W{constructor(e,t){super("Create Sphere",e),this.sphere=new a.x(0,64,32);const i=new a.n("Sphere","SimpleSurfaceShader");this.geomItem=new a.k("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(i),e&&t&&this.setParentAndXfo(e,t)}update(e){this.sphere.radius=e.radius,this.updated.emit(e)}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius)}}l.registerChange("CreateSphereChange",C);class F extends W{constructor(e,t){super("Create Cuboid"),this.cuboid=new a.h(0,0,0,!0);const i=new a.n("Cuboid","SimpleSurfaceShader");this.geomItem=new a.k("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(i),e&&t&&this.setParentAndXfo(e,t)}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&(this.cuboid.z=e.height),this.updated.emit(e)}}l.registerChange("CreateCuboidChange",F);a.F.registerClass("SliderHandle",class extends h{constructor(e,t=.5,i=.02,s=new a.d(1,1,0)){super(e),this.lengthParam=this.addParameter(new a.o("Length",t)),this.handleRadiusParam=this.addParameter(new a.o("Handle Radius",i)),this.barRadiusParam=this.addParameter(new a.o("Bar Radius",.25*i)),this.colorParam=this.addParameter(new a.e("Color",s)),this.hilghlightColorParam=this.addParameter(new a.e("Highlight Color",new a.d(1,1,1))),this.handleMat=new a.n("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const n=new a.n("topBar","FlatSurfaceShader");n.getParameter("BaseColor").setValue(new a.d(.5,.5,.5));const r=new a.i(.25*i,1,64,2,!0,!0),l=new a.x(i,64);this.handle=new a.k("handle",l,this.handleMat),this.baseBar=new a.k("baseBar",r,this.handleMat),this.topBar=new a.k("topBar",r,n),this.handleXfo=new a.E,this.baseBarXfo=new a.E,this.topBarXfo=new a.E,this.barRadiusParam.valueChanged.connect(()=>{r.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.valueChanged.connect(()=>{l.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.valueChanged.connect(()=>{this.__updateSlider(this.value)}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.valueChanged.connect(t)}__updateSlider(e){this.value=e;const t=this.param&&this.param.getRange()?this.param.getRange():[0,1],i=Math.remap(e,t[0],t[1],0,1),s=this.lengthParam.getValue();this.baseBarXfo.sc.z=i*s,this.handleXfo.tr.z=i*s,this.topBarXfo.tr.z=i*s,this.topBarXfo.sc.z=(1-i)*s,this.handle.setLocalXfo(this.handleXfo,a.B.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,a.B.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,a.B.GENERATED_VALUE)}onDragStart(e){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,a.B.GENERATED_VALUE),this.param&&e.undoRedoManager&&(this.change=new c(this.param),e.undoRedoManager.addChange(this.change))}onDrag(e){const t=this.lengthParam.getValue(),i=this.param&&this.param.getRange()?this.param.getRange():[0,1],a=Math.clamp(Math.remap(e.value,0,t,i[0],i[1]),i[0],i[1]);if(!this.param)return this.__updateSlider(a),void(this.value=a);this.change?this.change.update({value:a}):this.param.setValue(a)}onDragEnd(e){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,a.B.GENERATED_VALUE)}toJSON(e,t=0){const i=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(i.targetParam=this.param.getPath()),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}});a.F.registerClass("ArcSlider",class extends m{constructor(e,t=1,i=1,s=.02,n=new a.d(1,1,0)){super(e),this.arcRadiusParam=this.addParameter(new a.o("Arc Radius",t)),this.arcAngleParam=this.addParameter(new a.o("Arc Angle",i)),this.handleRadiusParam=this.addParameter(new a.o("Handle Radius",s)),this.colorParam=this.addParameter(new a.e("Color",n)),this.hilghlightColorParam=this.addParameter(new a.e("Highlight Color",new a.d(1,1,1))),this.handleMat=new a.n("handleMat","HandleShader");const r=new a.c(t,i,64),l=new a.x(s,64);this.handle=new a.k("handle",l,this.handleMat),this.arc=new a.k("arc",r,this.handleMat),this.handleXfo=new a.E,this.handleGeomOffsetXfo=new a.E,this.handleGeomOffsetXfo.tr.x=t,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,i],this.arcAngleParam.valueChanged.connect(()=>{const e=this.arcAngleParam.getValue();r.getParameter("Angle").setValue(e),this.range=[0,e]}),this.arcRadiusParam.valueChanged.connect(()=>{const e=this.arcRadiusParam.getValue();r.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.valueChanged.connect(()=>{l.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1),this.dragStart=new a.w,this.dragEnd=new a.w}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(e){this.unhighlight()}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(e){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new a.E,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),e.undoRedoManager&&(this.change=new c(this.param),e.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragStart.emit()}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let i=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(i=-i),this.range&&(i=Math.clamp(i,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);i=Math.floor(i/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),i);const a=this.baseXfo.multiply(this.deltaXfo);this.change?this.change.update({value:a}):(this.param?this.param:this.getParameter("GlobalXfo")).setValue(a)}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragEnd.emit()}toJSON(e,t=0){const i=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(i.targetParam=this.param.getPath()),i}fromJSON(e,t,i){super.fromJSON(e,t,i),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e)})}});class w extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("style");t.appendChild(document.createTextNode(w.css)),e.appendChild(t),this.itemContainer=document.createElement("div"),this.itemHeader=document.createElement("div"),this.itemHeader.className="TreeNodeHeader",this.itemContainer.appendChild(this.itemHeader),this.itemChildren=document.createElement("div"),this.itemChildren.className="TreeNodesList",this.itemContainer.appendChild(this.itemChildren),this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.itemHeader.appendChild(this.expandBtn),this.expanded=!1,this.childrenAlreadyCreated=!1,this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand())}),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.addEventListener("click",e=>{this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!e.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected())}),this.itemHeader.appendChild(this.titleElement),e.appendChild(this.itemContainer)}setTreeItem(e,t){this.treeItem=e,this.appData=t,this.titleElement.textContent=e.getName(),this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=e.getName()}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),e instanceof a.A&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.itemHeader.insertBefore(this.toggleVisibilityBtn,this.titleElement),this.toggleVisibilityBtn.innerHTML='<i class="material-icons-outlined md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const e=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const t=new ParameterValueChange(e,!e.getValue());this.appData.undoRedoManager.addChange(t)}else e.setValue(!e.getValue())}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility(),this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight(),this.treeItem.getChildren().length&&this.collapse(),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)))}updateVisibility(){const e=this.treeItem.getVisible();e?this.itemContainer.classList.remove("TreeNodesListItem--isHidden"):this.itemContainer.classList.add("TreeNodesListItem--isHidden"),this.toggleVisibilityBtn.innerHTML=e?'<i class="material-icons-outlined md-15">visibility</i>':'<i class="material-icons-outlined md-15">visibility_off</i>'}updateSelected(){this.treeItem.getSelected()?this.itemContainer.classList.add("TreeNodesListItem--isSelected"):this.itemContainer.classList.remove("TreeNodesListItem--isSelected")}updateHighlight(){const e=this.treeItem.isHighlighted();if(e?this.itemContainer.classList.add("TreeNodesListItem--isHighlighted"):this.itemContainer.classList.remove("TreeNodesListItem--isHighlighted"),e){const e=this.treeItem.getHighlight(),t=e.lerp(new a.d(.75,.75,.75,0),.5);this.titleElement.style.setProperty("border-color",e.toHex()),this.titleElement.style.setProperty("background-color",t.toHex())}else this.titleElement.style.removeProperty("border-color"),this.titleElement.style.removeProperty("background-color")}expand(){this.expanded=!0,this.itemChildren.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',this.childrenAlreadyCreated||(this.treeItem.getChildren().forEach((e,t)=>{this.addChild(e,t)}),this.childrenAlreadyCreated=!0)}collapse(){this.itemChildren.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1}addChild(e,t){if(this.expanded){const i=document.createElement("tree-item-view");i.setTreeItem(e,this.appData),t==this.itemChildren.childElementCount?this.itemChildren.appendChild(i):this.itemChildren.insertBefore(i,this.itemChildren.children[t])}else this.collapse()}childAdded(e,t){this.addChild(e,t)}childRemoved(e,t){this.expanded&&(this.itemChildren.children[t].destroy(),this.itemChildren.removeChild(this.itemChildren.children[t]))}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof a.A&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId))}}w.css="\n  /* tree-view.css */\n\n  ////\n  /// From https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined\n\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');\n  }\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons Outlined';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2) format('woff2');\n  }\n\n  .material-icons {\n    font-family: 'Material Icons';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n\n  .material-icons-outlined {\n    font-family: 'Material Icons Outlined';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n  .TreeNodesList {\n    border-left: 1px dotted;\n    list-style-type: none;\n    padding: 0 0 0 15px;\n    margin: 0 0 0 10px;\n  }\n\n  .TreeNodesList--collapsed {\n    display: none;\n  }\n\n  .TreeNodesList--root {\n    border: none;\n    margin: 0;\n    padding: 0;\n    width: max-content;\n  }\n\n  .TreeNodesListItem{\n    display: flex;\n  }\n\n  .TreeNodesListItem__ToggleVisibility {\n    border: none;\n    color: #333;\n    height: 24px;\n    padding: 0;\n    width: 25px;\n  }\n\n  .TreeNodesListItem__ToggleVisibility:focus {\n    outline: none;\n  }\n\n  .TreeNodesListItem__ToggleExpanded {\n    border: none;\n    height: 24px;\n    width: 24px;\n    padding: 0;\n    background-color: #0000;\n    outline: none;\n  }\n\n  .TreeNodesListItem::before {\n    border-bottom: 1px dotted;\n    content: '';\n    display: inline-block;\n    left: -15px;\n    position: relative;\n    top: -5px;\n    width: 10px;\n  }\n\n  .TreeNodesListItem__Toggle:focus {\n    outline: none;\n  }\n\n  .TreeNodeHeader{\n    display: flex;\n    margin: 0.4em auto;\n  }\n\n  .TreeNodesListItem__Title {\n    cursor: default;\n    padding: 2px 4px;\n    border-radius: 5px;\n  }\n\n  .TreeNodesListItem__Title:hover {\n    background-color: #e1f5fe;\n  }\n  .TreeNodesListItem__Hover {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem__Dragging {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem--isSelected > .TreeNodeHeader > .TreeNodesListItem__Title {\n    background-color: #76d2bb;\n    color: #3B3B3B;\n  }\n\n  .TreeNodesListItem--isHidden > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    color: #9e9e9e;\n  }\n\n  .TreeNodesListItem--isHighlighted > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    border-style: solid;\n    border-width: thin;\n  }\n\n  /* Rules for sizing the icon. */\n  .material-icons-outlined.md-15,\n  .material-icons.md-15 {\n    font-size: 15px;\n  }\n  .material-icons.md-18 {\n    font-size: 18px;\n  }\n  .material-icons.md-24 {\n    font-size: 24px;\n  }\n  .material-icons.md-36 {\n    font-size: 36px;\n  }\n  .material-icons.md-48 {\n    font-size: 48px;\n  }\n\n  /* Rules for using icons as black on a light background. */\n  .material-icons.md-dark {\n    color: rgba(0, 0, 0, 0.54);\n  }\n  .material-icons.md-dark.md-inactive {\n    color: rgba(0, 0, 0, 0.26);\n  }\n\n  /* Rules for using icons as white on a dark background. */\n  .material-icons.md-light {\n    color: rgba(255, 255, 255, 1);\n  }\n  .material-icons.md-light.md-inactive {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  ",customElements.get("tree-item-view")||customElements.define("tree-item-view",w);class N extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"});this.treeContainer=document.createElement("div"),e.appendChild(this.treeContainer),this.treeItemView=document.createElement("tree-item-view");const t=new CSSStyleSheet;t.replaceSync("@font-face {\n      font-family: \"Material Icons\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2') format('woff');\n    }");const i=new CSSStyleSheet;i.replaceSync("@font-face {\n      font-family: \"Material Icons Outlined\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2') format('woff');\n    }"),document.adoptedStyleSheets=[...document.adoptedStyleSheets,t,i]}setTreeItem(e,t){this.treeItemView.setTreeItem(e,t),this.treeContainer.appendChild(this.treeItemView)}}customElements.get("scene-tree-view")||customElements.define("scene-tree-view",N);i(41);function Y(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var K=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name="FooChange",this.updated=new a.w}var t,i,s;return t=e,(i=[{key:"setColor",value:function(e){this.colorList=document.getElementById("color-list"),this.li=document.createElement("li"),this.li.appendChild(document.createTextNode(e)),this.li.setAttribute("style","background-color: ".concat(e,";")),this.colorList.appendChild(this.li)}},{key:"undo",value:function(){this.li.remove()}},{key:"redo",value:function(){this.colorList.appendChild(this.li)}},{key:"destroy",value:function(){console.log("destroyed change")}}])&&Y(t.prototype,i),s&&Y(t,s),e}();l.registerChange("FooChange",K);i(42);window.onload=function(){var e=document.getElementById("addColorBtn"),t=document.getElementById("undoBtn"),i=document.getElementById("redoBtn"),a=new l;a.changeAdded.connect((function(){i.disabled=!0})),a.changeUndone.connect((function(){i.disabled=!1})),e.addEventListener("click",(function(e){var t="#"+(16777216+16777215*Math.random()).toString(16).substr(1,6),i=new K;i.setColor(t),a.addChange(i)})),t.addEventListener("click",(function(e){a.undo()})),i.addEventListener("click",(function(e){a.redo()}))}}]);